<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>fankangbest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="fankangbest">
<meta property="og:url" content="http://fankangbest.coding.me/index.html">
<meta property="og:site_name" content="fankangbest">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="fankangbest">
  
    <link rel="alternate" href="/atom.xml" title="fankangbest" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">fankangbest</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://fankangbest.coding.me"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/02/hello-world/" class="article-date">
  <time datetime="2017-08-02T05:28:53.260Z" itemprop="datePublished">2017-08-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/02/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/08/02/hello-world/" data-id="cj5ule86o001gecqs0cifzw7w" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-apimachinery机制解读(二)-GroupMetaFactory-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/01/apimachinery机制解读(二)-GroupMetaFactory-v1-5-2/" class="article-date">
  <time datetime="2017-08-01T03:12:42.000Z" itemprop="datePublished">2017-08-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/01/apimachinery机制解读(二)-GroupMetaFactory-v1-5-2/">apimachinery机制解读(二)-GroupMetaFactory-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是GroupMetaFactory"><a href="#什么是GroupMetaFactory" class="headerlink" title="什么是GroupMetaFactory"></a>什么是GroupMetaFactory</h2><p>GroupMetaFactory表示一个Group，主要包含两部信息，GroupMetaFactoryArgs表示Group的信息；GroupversionFactoryArgs表示Version的信息。GroupMetaFactory还提供了向APIRegistrationManager注册的功能。</p>
<p>接下来看下GroupMetaFactory的定义，定义在/pkg/apimachinery/announced/group_factory.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> GroupMetaFactory <span class="keyword">struct</span> &#123;</div><div class="line">	GroupArgs *GroupMetaFactoryArgs</div><div class="line">	<span class="comment">// map of version name to version factory</span></div><div class="line">	VersionArgs <span class="keyword">map</span>[<span class="keyword">string</span>]*GroupVersionFactoryArgs</div><div class="line"></div><div class="line">	<span class="comment">// assembled by Register()</span></div><div class="line">	prioritizedVersionList []unversioned.GroupVersion</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中：</p>
<ul>
<li>GroupArgs: 类型为GroupMetaFactoryArgs，表示Group的信息；</li>
<li>VersionArgs: 类型为<string, groupversionfactoryargs="">的map，表示VersionArgs的信息；</string,></li>
<li>prioritizedVersionList: 表示GV的优化级。</li>
</ul>
<p>再来看下GroupMetaFactoryArgs的定义(/pkg/apimachinery/announced/group_factory.go)：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GroupMetaFactoryArgs contains the group-level args of a GroupMetaFactory.</span></div><div class="line"><span class="keyword">type</span> GroupMetaFactoryArgs <span class="keyword">struct</span> &#123;</div><div class="line">	GroupName              <span class="keyword">string</span></div><div class="line">	VersionPreferenceOrder []<span class="keyword">string</span></div><div class="line">	ImportPrefix           <span class="keyword">string</span></div><div class="line"></div><div class="line">	RootScopedKinds sets.String <span class="comment">// nil is allowed</span></div><div class="line">	IgnoredKinds    sets.String <span class="comment">// nil is allowed</span></div><div class="line"></div><div class="line">	<span class="comment">// May be nil if there are no internal objects.</span></div><div class="line">	<span class="comment">//***AddInternalObjectsToScheme func***//</span></div><div class="line">	AddInternalObjectsToScheme SchemeFunc</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中：</p>
<ul>
<li>GroupName: Group的名字；</li>
<li>VersionPreferenceOrder: GV优先级；</li>
<li>ImportPrefix：如”k8s.io/kubernetes/pkg/apis/apps”；</li>
<li>RootScopedKinds: RootScoped的类型；</li>
<li>IgnoredKinds: 非资源的类型；</li>
<li>AddInternalObjectsToScheme：内部类型添加函数，里面定义有哪些内部结构体要添加到Scheme中，因为内部结构体与版本无关，所以放在Group下。</li>
</ul>
<p>接着看下GroupVersionFactoryArgs的定义(/pkg/apimachinery/announced/group_factory.go)：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GroupVersionFactoryArgs contains all the per-version parts of a GroupMetaFactory.</span></div><div class="line"><span class="keyword">type</span> GroupVersionFactoryArgs <span class="keyword">struct</span> &#123;</div><div class="line">	GroupName   <span class="keyword">string</span></div><div class="line">	VersionName <span class="keyword">string</span></div><div class="line"></div><div class="line">	<span class="comment">//***AddToScheme func***//</span></div><div class="line">	AddToScheme SchemeFunc</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中：</p>
<ul>
<li>GroupName: 表示Group的名字；</li>
<li>VersionName: 表示Version的名字，如”v1beta1”；</li>
<li>AddToScheme: 表示添加到Scheme的函数，里面定义有哪些结构体需要添加到Scheme中。</li>
</ul>
<h2 id="Announce"><a href="#Announce" class="headerlink" title="Announce()"></a>Announce()</h2><p>Announce()可以理解为向DefaultGroupFactoryRegistry中注册，当然DefaultGroupFactoryRegistry还在开发中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(gmf *GroupMetaFactory)</span> <span class="title">Announce</span><span class="params">()</span> *<span class="title">GroupMetaFactory</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err := DefaultGroupFactoryRegistry.AnnouncePreconstructedFactory(gmf); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> gmf</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Register"><a href="#Register" class="headerlink" title="Register()"></a>Register()</h2><p>Register()<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Register constructs the finalized prioritized version list and sanity checks</span></div><div class="line"><span class="comment">// the announced group &amp; versions. Then it calls register.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(gmf *GroupMetaFactory)</span> <span class="title">Register</span><span class="params">(m *registered.APIRegistrationManager)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> gmf.GroupArgs == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"partially announced groups are not allowed, only got versions: %#v"</span>, gmf.VersionArgs)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(gmf.VersionArgs) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"group %v announced but no versions announced"</span>, gmf.GroupArgs.GroupName)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	pvSet := sets.NewString(gmf.GroupArgs.VersionPreferenceOrder...)</div><div class="line">	<span class="keyword">if</span> pvSet.Len() != <span class="built_in">len</span>(gmf.GroupArgs.VersionPreferenceOrder) &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"preference order for group %v has duplicates: %v"</span>, gmf.GroupArgs.GroupName, gmf.GroupArgs.VersionPreferenceOrder)</div><div class="line">	&#125;</div><div class="line">	prioritizedVersions := []unversioned.GroupVersion&#123;&#125;</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> gmf.GroupArgs.VersionPreferenceOrder &#123;</div><div class="line">		prioritizedVersions = <span class="built_in">append</span>(</div><div class="line">			prioritizedVersions,</div><div class="line">			unversioned.GroupVersion&#123;</div><div class="line">				Group:   gmf.GroupArgs.GroupName,</div><div class="line">				Version: v,</div><div class="line">			&#125;,</div><div class="line">		)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Go through versions that weren't explicitly prioritized.</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***收集不在VersionPreferenceOrder中的version***//</span></div><div class="line">	unprioritizedVersions := []unversioned.GroupVersion&#123;&#125;</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> gmf.VersionArgs &#123;</div><div class="line">		<span class="keyword">if</span> v.GroupName != gmf.GroupArgs.GroupName &#123;</div><div class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"found %v/%v in group %v?"</span>, v.GroupName, v.VersionName, gmf.GroupArgs.GroupName)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> pvSet.Has(v.VersionName) &#123;</div><div class="line">			pvSet.Delete(v.VersionName)</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		unprioritizedVersions = <span class="built_in">append</span>(unprioritizedVersions, unversioned.GroupVersion&#123;Group: v.GroupName, Version: v.VersionName&#125;)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***不能有多于1个的unprioritized version***//</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(unprioritizedVersions) &gt; <span class="number">1</span> &#123;</div><div class="line">		glog.Warningf(<span class="string">"group %v has multiple unprioritized versions: %#v. They will have an arbitrary preference order!"</span>, gmf.GroupArgs.GroupName, unprioritizedVersions)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> pvSet.Len() != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"group %v has versions in the priority list that were never announced: %s"</span>, gmf.GroupArgs.GroupName, pvSet)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***把unprioritizedVersions纳入到prioritizedVersions***//</span></div><div class="line">	prioritizedVersions = <span class="built_in">append</span>(prioritizedVersions, unprioritizedVersions...)</div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***向APIRegistrationManager中注册versions***//</span></div><div class="line">	m.RegisterVersions(prioritizedVersions)</div><div class="line">	gmf.prioritizedVersionList = prioritizedVersions</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Enable"><a href="#Enable" class="headerlink" title="Enable()"></a>Enable()</h2><p>Enable()方法先调用每个GroupVersion对应的GroupVersionFactoryArg中的AddToScheme，把版本中的types注册到Scheme中；然后调用GroupArgs中的AddInternalObjectsToScheme注册内部版本的types；最后构造GroupMeta，并向DefaultAPIRegistrationManager中注册。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Enable enables group versions that are allowed, adds methods to the scheme, etc.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(gmf *GroupMetaFactory)</span> <span class="title">Enable</span><span class="params">(m *registered.APIRegistrationManager, scheme *runtime.Scheme)</span> <span class="title">error</span></span> &#123;</div><div class="line">	externalVersions := []unversioned.GroupVersion&#123;&#125;</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> gmf.prioritizedVersionList &#123;</div><div class="line">		<span class="keyword">if</span> !m.IsAllowedVersion(v) &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		externalVersions = <span class="built_in">append</span>(externalVersions, v)</div><div class="line">		<span class="keyword">if</span> err := m.EnableVersions(v); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***注册具体版本的类型，如：v1beta1.AddToScheme***//</span></div><div class="line">		gmf.VersionArgs[v.Version].AddToScheme(scheme)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(externalVersions) == <span class="number">0</span> &#123;</div><div class="line">		glog.V(<span class="number">4</span>).Infof(<span class="string">"No version is registered for group %v"</span>, gmf.GroupArgs.GroupName)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***注册内部版本的类型，如：apps.AddToScheme***//</span></div><div class="line">	<span class="keyword">if</span> gmf.GroupArgs.AddInternalObjectsToScheme != <span class="literal">nil</span> &#123;</div><div class="line">		gmf.GroupArgs.AddInternalObjectsToScheme(scheme)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	preferredExternalVersion := externalVersions[<span class="number">0</span>]</div><div class="line">	accessor := meta.NewAccessor()</div><div class="line"></div><div class="line">	groupMeta := &amp;apimachinery.GroupMeta&#123;</div><div class="line">		GroupVersion:  preferredExternalVersion,</div><div class="line">		GroupVersions: externalVersions,</div><div class="line">		SelfLinker:    runtime.SelfLinker(accessor),</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> externalVersions &#123;</div><div class="line">		gvf := gmf.VersionArgs[v.Version]</div><div class="line">		<span class="keyword">if</span> err := groupMeta.AddVersionInterfaces(</div><div class="line">			unversioned.GroupVersion&#123;Group: gvf.GroupName, Version: gvf.VersionName&#125;,</div><div class="line">			&amp;meta.VersionInterfaces&#123;</div><div class="line">				ObjectConvertor:  scheme,</div><div class="line">				MetadataAccessor: accessor,</div><div class="line">			&#125;,</div><div class="line">		); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	groupMeta.InterfacesFor = groupMeta.DefaultInterfacesFor</div><div class="line">	<span class="comment">//***生成RESTMapper***//</span></div><div class="line">	groupMeta.RESTMapper = gmf.newRESTMapper(scheme, externalVersions, groupMeta)</div><div class="line"></div><div class="line">	<span class="comment">//***向APIRegistrationManager注册groupMeta***//</span></div><div class="line">	<span class="keyword">if</span> err := m.RegisterGroup(*groupMeta); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="RegisterAndEnable"><a href="#RegisterAndEnable" class="headerlink" title="RegisterAndEnable()"></a>RegisterAndEnable()</h2><p>RegisterAndEnable()是对Register()方法和Enable()方法的封装，从这里可以看出，默认使用是的DefaultAPIregistrationManager和api.Scheme。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RegisterAndEnable is provided only to allow this code to get added in multiple steps.</span></div><div class="line"><span class="comment">// It's really bad that this is called in init() methods, but supporting this</span></div><div class="line"><span class="comment">// temporarily lets us do the change incrementally.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(gmf *GroupMetaFactory)</span> <span class="title">RegisterAndEnable</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err := gmf.Register(registered.DefaultAPIRegistrationManager); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***向api.Scheme注册***//</span></div><div class="line">	<span class="keyword">if</span> err := gmf.Enable(registered.DefaultAPIRegistrationManager, api.Scheme); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="调用例子"><a href="#调用例子" class="headerlink" title="调用例子"></a>调用例子</h2><p>在/pkg/apis/apps/install/install.go中，有如下代码：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err := announced.NewGroupMetaFactory(</div><div class="line">		&amp;announced.GroupMetaFactoryArgs&#123;</div><div class="line">			GroupName:                  apps.GroupName,</div><div class="line">			VersionPreferenceOrder:     []<span class="keyword">string</span>&#123;v1beta1.SchemeGroupVersion.Version&#125;,</div><div class="line">			ImportPrefix:               <span class="string">"k8s.io/kubernetes/pkg/apis/apps"</span>,</div><div class="line">			AddInternalObjectsToScheme: apps.AddToScheme,</div><div class="line">		&#125;,</div><div class="line">		announced.VersionToSchemeFunc&#123;</div><div class="line">			v1beta1.SchemeGroupVersion.Version: v1beta1.AddToScheme,</div><div class="line">		&#125;,</div><div class="line">	).Announce().RegisterAndEnable(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可知，代码最后调用了RegisterAndEnable()完成向registered.DefaultGroupFactoryRegistry和api.Scheme的注册。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/08/01/apimachinery机制解读(二)-GroupMetaFactory-v1-5-2/" data-id="cj5ule86i001cecqs6o5gjyac" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-apimachinery机制解读(一)-APIRegistrationManager-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/31/apimachinery机制解读(一)-APIRegistrationManager-v1-5-2/" class="article-date">
  <time datetime="2017-07-31T04:38:14.000Z" itemprop="datePublished">2017-07-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/31/apimachinery机制解读(一)-APIRegistrationManager-v1-5-2/">apimachinery机制解读(一)-APIRegistrationManager-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是apimachinery"><a href="#什么是apimachinery" class="headerlink" title="什么是apimachinery"></a>什么是apimachinery</h2><p>“Package apimachinery contains the generic API machinery code that is common to both server and clients.” apimachinery是对API包及版本管理的一个抽象，主要包含registered和announced两个package：</p>
<ul>
<li>registered: 定义有DefaultAPIRegistrationManager，管理API包及版本；</li>
<li>announced：包含group_factory和announced两部分，其中group_factory提供了向DefaultAPIRegistrationManager注册的途径；announced部分是还在开发中的接口，用来接管registered包的部分功能。</li>
</ul>
<p>关于apimachinery的分析，先介绍apimachinery/registered.go中的APIRegistrationManager，再介绍apimachinery/announced/group_factory.go中的groupMetaFactory。</p>
<p>本次将分析APIRegistrationManager。在介绍之前，先来认识下GroupMeta。</p>
<h2 id="GroupMeta"><a href="#GroupMeta" class="headerlink" title="GroupMeta"></a>GroupMeta</h2><p>GroupMetal结构体定义了Group的基本信息，如Group对应的RESTMapper, Codec, GroupVersions等，定义在/pkg/apimachinery/types.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GroupMeta stores the metadata of a group.</span></div><div class="line"><span class="keyword">type</span> GroupMeta <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// GroupVersion represents the preferred version of the group.</span></div><div class="line">	GroupVersion unversioned.GroupVersion</div><div class="line"></div><div class="line">	<span class="comment">// GroupVersions is Group + all versions in that group.</span></div><div class="line">	GroupVersions []unversioned.GroupVersion</div><div class="line"></div><div class="line">	<span class="comment">// Codec is the default codec for serializing output that should use</span></div><div class="line">	<span class="comment">// the preferred version.  Use this Codec when writing to</span></div><div class="line">	<span class="comment">// disk, a data store that is not dynamically versioned, or in tests.</span></div><div class="line">	<span class="comment">// This codec can decode any object that the schema is aware of.</span></div><div class="line">	Codec runtime.Codec</div><div class="line"></div><div class="line">	<span class="comment">// SelfLinker can set or get the SelfLink field of all API types.</span></div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> when versioning changes, make this part of each API definition.</span></div><div class="line">	<span class="comment">// TODO(lavalamp): Combine SelfLinker &amp; ResourceVersioner interfaces, force all uses</span></div><div class="line">	<span class="comment">// to go through the InterfacesFor method below.</span></div><div class="line">	SelfLinker runtime.SelfLinker</div><div class="line"></div><div class="line">	<span class="comment">// RESTMapper provides the default mapping between REST paths and the objects declared in api.Scheme and all known</span></div><div class="line">	<span class="comment">// versions.</span></div><div class="line">	RESTMapper meta.RESTMapper</div><div class="line"></div><div class="line">	<span class="comment">// InterfacesFor returns the default Codec and ResourceVersioner for a given version</span></div><div class="line">	<span class="comment">// string, or an error if the version is not known.</span></div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> make this stop being a func pointer and always use the default</span></div><div class="line">	<span class="comment">// function provided below once every place that populates this field has been changed.</span></div><div class="line">	InterfacesFor <span class="function"><span class="keyword">func</span><span class="params">(version unversioned.GroupVersion)</span> <span class="params">(*meta.VersionInterfaces, error)</span></span></div><div class="line"></div><div class="line">	// <span class="title">InterfacesByVersion</span> <span class="title">stores</span> <span class="title">the</span> <span class="title">per</span>-<span class="title">version</span> <span class="title">interfaces</span>.</div><div class="line">	<span class="title">InterfacesByVersion</span> <span class="title">map</span>[<span class="title">unversioned</span>.<span class="title">GroupVersion</span>]*<span class="title">meta</span>.<span class="title">VersionInterfaces</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="APIRegistrationManager"><a href="#APIRegistrationManager" class="headerlink" title="APIRegistrationManager"></a>APIRegistrationManager</h2><p>APIRegistrationManager主要用来管理GroupMeta，定义在/pgk/apimachinery/registered/registered.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> APIRegistrationManager <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// registeredGroupVersions stores all API group versions for which RegisterGroup is called.</span></div><div class="line">	<span class="comment">//***所有的group version***//</span></div><div class="line">	registeredVersions <span class="keyword">map</span>[unversioned.GroupVersion]<span class="keyword">struct</span>&#123;&#125;</div><div class="line"></div><div class="line">	<span class="comment">// thirdPartyGroupVersions are API versions which are dynamically</span></div><div class="line">	<span class="comment">// registered (and unregistered) via API calls to the apiserver</span></div><div class="line">	<span class="comment">//***第三方的group version***//</span></div><div class="line">	thirdPartyGroupVersions []unversioned.GroupVersion</div><div class="line"></div><div class="line">	<span class="comment">// enabledVersions represents all enabled API versions. It should be a</span></div><div class="line">	<span class="comment">// subset of registeredVersions. Please call EnableVersions() to add</span></div><div class="line">	<span class="comment">// enabled versions.</span></div><div class="line">	enabledVersions <span class="keyword">map</span>[unversioned.GroupVersion]<span class="keyword">struct</span>&#123;&#125;</div><div class="line"></div><div class="line">	<span class="comment">// map of group meta for all groups.</span></div><div class="line">	<span class="comment">//***groupmeta***//</span></div><div class="line">	groupMetaMap <span class="keyword">map</span>[<span class="keyword">string</span>]*apimachinery.GroupMeta</div><div class="line"></div><div class="line">	<span class="comment">// envRequestedVersions represents the versions requested via the</span></div><div class="line">	<span class="comment">// KUBE_API_VERSIONS environment variable. The install package of each group</span></div><div class="line">	<span class="comment">// checks this list before add their versions to the latest package and</span></div><div class="line">	<span class="comment">// Scheme.  This list is small and order matters, so represent as a slice</span></div><div class="line">	envRequestedVersions []unversioned.GroupVersion</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中：</p>
<ul>
<li>registeredGroupVersions存储已经注册的GV，可以使用RegisterVersions()进行注册；</li>
<li>thirdPartyGroupVersions存储第三方的API，可以使用AddThirdPartyAPIGroupVersions()进行注册；</li>
<li>enabledVersions存储处理enabled的GV，可以通过EnableVersions()添加；</li>
<li>groupMetaMap存储Group的GroupMeta信息；</li>
<li>envRequestedVersions存储KUBE_API_VERSIONS环境变量包含的版本，如果未指定，则KUBE_API_VERSIONS为空。</li>
</ul>
<p>关于APIRegistrationManager和announced包中的APIGroupFactoryRegistry的关系，在announced.go中有注释”(Right now APIRegistrationManager has separate ‘registration’ and ‘enabled’ concepts– APIGroupFactory is going to take over the former function; they will overlap untill the refactoring is finished.)”。所以APIGroupFactoryRegistry还在开发中，估计在以后的版本会完善，并接管APIRegistrationManager对GroupMeta的管理功能。</p>
<p>下面来分析APIRegistrationManager结构体提供的方法。</p>
<h3 id="NewOrDie"><a href="#NewOrDie" class="headerlink" title="NewOrDie()"></a>NewOrDie()</h3><p>NewOrDie()方法可以创建APIRegistrationManager，在registered.go中有<code>DefaultAPIRegistrationManager = NewOrDie(os.Getenv(&quot;KUBE_API_VERSIONS&quot;))</code>。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***新建APIRegistrationManager***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewOrDie</span><span class="params">(kubeAPIVersions <span class="keyword">string</span>)</span> *<span class="title">APIRegistrationManager</span></span> &#123;</div><div class="line">	m, err := NewAPIRegistrationManager(kubeAPIVersions)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.Fatalf(<span class="string">"Could not construct version manager: %v (KUBE_API_VERSIONS=%q)"</span>, err, kubeAPIVersions)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> m</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NewAPIRegistrationManager constructs a new manager. The argument ought to be</span></div><div class="line"><span class="comment">// the value of the KUBE_API_VERSIONS env var, or a value of this which you</span></div><div class="line"><span class="comment">// wish to test.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAPIRegistrationManager</span><span class="params">(kubeAPIVersions <span class="keyword">string</span>)</span> <span class="params">(*APIRegistrationManager, error)</span></span> &#123;</div><div class="line">	m := &amp;APIRegistrationManager&#123;</div><div class="line">		registeredVersions:      <span class="keyword">map</span>[unversioned.GroupVersion]<span class="keyword">struct</span>&#123;&#125;&#123;&#125;,</div><div class="line">		thirdPartyGroupVersions: []unversioned.GroupVersion&#123;&#125;,</div><div class="line">		enabledVersions:         <span class="keyword">map</span>[unversioned.GroupVersion]<span class="keyword">struct</span>&#123;&#125;&#123;&#125;,</div><div class="line">		groupMetaMap:            <span class="keyword">map</span>[<span class="keyword">string</span>]*apimachinery.GroupMeta&#123;&#125;,</div><div class="line">		envRequestedVersions:    []unversioned.GroupVersion&#123;&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(kubeAPIVersions) != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">for</span> _, version := <span class="keyword">range</span> strings.Split(kubeAPIVersions, <span class="string">","</span>) &#123;</div><div class="line">			gv, err := unversioned.ParseGroupVersion(version)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"invalid api version: %s in KUBE_API_VERSIONS: %s."</span>,</div><div class="line">					version, kubeAPIVersions)</div><div class="line">			&#125;</div><div class="line">			m.envRequestedVersions = <span class="built_in">append</span>(m.envRequestedVersions, gv)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> m, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RegisterVersions"><a href="#RegisterVersions" class="headerlink" title="RegisterVersions()"></a>RegisterVersions()</h3><p>RegisterVersions()可以向APIRegistrationManager注册GroupVersion，即把GroupVerson作为key加入到registeredVersions map中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***注册groupversion***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *APIRegistrationManager)</span> <span class="title">RegisterVersions</span><span class="params">(availableVersions []unversioned.GroupVersion)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> availableVersions &#123;</div><div class="line">		m.registeredVersions[v] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RegisterGroup"><a href="#RegisterGroup" class="headerlink" title="RegisterGroup()"></a>RegisterGroup()</h3><p>RegisterGroup()可以向APIRegistrationManager注册groupMeta，即把<groupname, groupmeta="">存入groupMetaMap中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***注册group，即把groupMeta注册到groupMetaMap字段***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *APIRegistrationManager)</span> <span class="title">RegisterGroup</span><span class="params">(groupMeta apimachinery.GroupMeta)</span> <span class="title">error</span></span> &#123;</div><div class="line">	groupName := groupMeta.GroupVersion.Group</div><div class="line">	<span class="keyword">if</span> _, found := m.groupMetaMap[groupName]; found &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"group %v is already registered"</span>, m.groupMetaMap)</div><div class="line">	&#125;</div><div class="line">	m.groupMetaMap[groupName] = &amp;groupMeta</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></groupname,></p>
<h3 id="EnableVersions"><a href="#EnableVersions" class="headerlink" title="EnableVersions()"></a>EnableVersions()</h3><p>EnableVersions()可以把已经注册的GroupVersion置为enabled。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***若该groupversion在registeredVersions中存在，则放入enabledVersions map***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *APIRegistrationManager)</span> <span class="title">EnableVersions</span><span class="params">(versions ...unversioned.GroupVersion)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> unregisteredVersions []unversioned.GroupVersion</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> versions &#123;</div><div class="line">		<span class="keyword">if</span> _, found := m.registeredVersions[v]; !found &#123;</div><div class="line">			unregisteredVersions = <span class="built_in">append</span>(unregisteredVersions, v)</div><div class="line">		&#125;</div><div class="line">		m.enabledVersions[v] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(unregisteredVersions) != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"Please register versions before enabling them: %v"</span>, unregisteredVersions)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="IsAllowedVersion"><a href="#IsAllowedVersion" class="headerlink" title="IsAllowedVersion()"></a>IsAllowedVersion()</h3><p>IsAllowedVersion()用来判断GroupVersion是否在KUBE_API_VERSIONS环境变量的定义中，如果KUBE_API_VERSIONS为空，则允许所有的GroupVersion。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***是否是envRequestedVesions要求***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *APIRegistrationManager)</span> <span class="title">IsAllowedVersion</span><span class="params">(v unversioned.GroupVersion)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(m.envRequestedVersions) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> _, envGV := <span class="keyword">range</span> m.envRequestedVersions &#123;</div><div class="line">		<span class="keyword">if</span> v == envGV &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="IsEnabledVersion"><a href="#IsEnabledVersion" class="headerlink" title="IsEnabledVersion()"></a>IsEnabledVersion()</h3><p>IsEnabledVersion()用来判断GroupVersion是否为被标记为enabled。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***判断该groupversion是否在enabledVersions变量中***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *APIRegistrationManager)</span> <span class="title">IsEnabledVersion</span><span class="params">(v unversioned.GroupVersion)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	_, found := m.enabledVersions[v]</div><div class="line">	<span class="keyword">return</span> found</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="EnabledVersions"><a href="#EnabledVersions" class="headerlink" title="EnabledVersions()"></a>EnabledVersions()</h3><p>返回所有enabled的GroupVersion。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *APIRegistrationManager)</span> <span class="title">EnabledVersions</span><span class="params">()</span> []<span class="title">unversioned</span>.<span class="title">GroupVersion</span></span> &#123;</div><div class="line">	ret := []unversioned.GroupVersion&#123;&#125;</div><div class="line">	<span class="keyword">for</span> _, groupMeta := <span class="keyword">range</span> m.groupMetaMap &#123;</div><div class="line">		<span class="keyword">for</span> _, version := <span class="keyword">range</span> groupMeta.GroupVersions &#123;</div><div class="line">			<span class="keyword">if</span> m.IsEnabledVersion(version) &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, version)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ret</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="EnabledVersionsForGroup"><a href="#EnabledVersionsForGroup" class="headerlink" title="EnabledVersionsForGroup()"></a>EnabledVersionsForGroup()</h3><p>返回某一个group下的enabled的GroupVersion。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *APIRegistrationManager)</span> <span class="title">EnabledVersionsForGroup</span><span class="params">(group <span class="keyword">string</span>)</span> []<span class="title">unversioned</span>.<span class="title">GroupVersion</span></span> &#123;</div><div class="line">	groupMeta, ok := m.groupMetaMap[group]</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> []unversioned.GroupVersion&#123;&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ret := []unversioned.GroupVersion&#123;&#125;</div><div class="line">	<span class="keyword">for</span> _, version := <span class="keyword">range</span> groupMeta.GroupVersions &#123;</div><div class="line">		<span class="keyword">if</span> m.IsEnabledVersion(version) &#123;</div><div class="line">			ret = <span class="built_in">append</span>(ret, version)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ret</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Group"><a href="#Group" class="headerlink" title="Group()"></a>Group()</h3><p>获取某一group的groupMeta。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *APIRegistrationManager)</span> <span class="title">Group</span><span class="params">(group <span class="keyword">string</span>)</span> <span class="params">(*apimachinery.GroupMeta, error)</span></span> &#123;</div><div class="line">	groupMeta, found := m.groupMetaMap[group]</div><div class="line">	<span class="keyword">if</span> !found &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"group %v has not been registered"</span>, group)</div><div class="line">	&#125;</div><div class="line">	groupMetaCopy := *groupMeta</div><div class="line">	<span class="keyword">return</span> &amp;groupMetaCopy, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="IsRegistered"><a href="#IsRegistered" class="headerlink" title="IsRegistered()"></a>IsRegistered()</h3><p>IsRegistered()可以查看某一group是否已经注册。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *APIRegistrationManager)</span> <span class="title">IsRegistered</span><span class="params">(group <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	_, found := m.groupMetaMap[group]</div><div class="line">	<span class="keyword">return</span> found</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="IsRegisteredVersion"><a href="#IsRegisteredVersion" class="headerlink" title="IsRegisteredVersion()"></a>IsRegisteredVersion()</h3><p>IsRegisteredVersion()可以查看某一GroupVersion是否已经注册。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *APIRegistrationManager)</span> <span class="title">IsRegisteredVersion</span><span class="params">(v unversioned.GroupVersion)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	_, found := m.registeredVersions[v]</div><div class="line">	<span class="keyword">return</span> found</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RegisteredGroupVersions"><a href="#RegisteredGroupVersions" class="headerlink" title="RegisteredGroupVersions()"></a>RegisteredGroupVersions()</h3><p>返回所有GroupVersions。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *APIRegistrationManager)</span> <span class="title">RegisteredGroupVersions</span><span class="params">()</span> []<span class="title">unversioned</span>.<span class="title">GroupVersion</span></span> &#123;</div><div class="line">	ret := []unversioned.GroupVersion&#123;&#125;</div><div class="line">	<span class="keyword">for</span> groupVersion := <span class="keyword">range</span> m.registeredVersions &#123;</div><div class="line">		ret = <span class="built_in">append</span>(ret, groupVersion)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ret</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="IsThirdPartyAPIGroupVersion"><a href="#IsThirdPartyAPIGroupVersion" class="headerlink" title="IsThirdPartyAPIGroupVersion()"></a>IsThirdPartyAPIGroupVersion()</h3><p>判断是否是第三方的GroupVersion。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *APIRegistrationManager)</span> <span class="title">IsThirdPartyAPIGroupVersion</span><span class="params">(gv unversioned.GroupVersion)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> ix := <span class="keyword">range</span> m.thirdPartyGroupVersions &#123;</div><div class="line">		<span class="keyword">if</span> m.thirdPartyGroupVersions[ix] == gv &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="AddThirdPartyAPIGroupVersions"><a href="#AddThirdPartyAPIGroupVersions" class="headerlink" title="AddThirdPartyAPIGroupVersions()"></a>AddThirdPartyAPIGroupVersions()</h3><p>AddThirdPartyAPIGroupVersions()可以向APIRegistrationManager注册第三方的GroupVersion：先调用RegistrerVersions()，再调用EnableVersions，加入到thirdPartyGroupVersions字段中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***注册第三方groupversion***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *APIRegistrationManager)</span> <span class="title">AddThirdPartyAPIGroupVersions</span><span class="params">(gvs ...unversioned.GroupVersion)</span> []<span class="title">unversioned</span>.<span class="title">GroupVersion</span></span> &#123;</div><div class="line">	filteredGVs := []unversioned.GroupVersion&#123;&#125;</div><div class="line">	skippedGVs := []unversioned.GroupVersion&#123;&#125;</div><div class="line">	<span class="keyword">for</span> ix := <span class="keyword">range</span> gvs &#123;</div><div class="line">		<span class="keyword">if</span> !m.IsRegisteredVersion(gvs[ix]) &#123;</div><div class="line">			filteredGVs = <span class="built_in">append</span>(filteredGVs, gvs[ix])</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			glog.V(<span class="number">3</span>).Infof(<span class="string">"Skipping %s, because its already registered"</span>, gvs[ix].String())</div><div class="line">			skippedGVs = <span class="built_in">append</span>(skippedGVs, gvs[ix])</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(filteredGVs) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> skippedGVs</div><div class="line">	&#125;</div><div class="line">	m.RegisterVersions(filteredGVs)</div><div class="line">	m.EnableVersions(filteredGVs...)</div><div class="line">	m.thirdPartyGroupVersions = <span class="built_in">append</span>(m.thirdPartyGroupVersions, filteredGVs...)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> skippedGVs</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="InterfacesFor"><a href="#InterfacesFor" class="headerlink" title="InterfacesFor()"></a>InterfacesFor()</h3><p>InterfacesFor()方法先获取GV对应的groupMeta，然后通过groupMeta获取<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// InterfacesFor is a union meta.VersionInterfacesFunc func for all registered types</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *APIRegistrationManager)</span> <span class="title">InterfacesFor</span><span class="params">(version unversioned.GroupVersion)</span> <span class="params">(*meta.VersionInterfaces, error)</span></span> &#123;</div><div class="line">	groupMeta, err := m.Group(version.Group)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> groupMeta.InterfacesFor(version)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="GroupOrDie"><a href="#GroupOrDie" class="headerlink" title="GroupOrDie()"></a>GroupOrDie()</h3><p>获取group对应的GroupMeta。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *APIRegistrationManager)</span> <span class="title">GroupOrDie</span><span class="params">(group <span class="keyword">string</span>)</span> *<span class="title">apimachinery</span>.<span class="title">GroupMeta</span></span> &#123;</div><div class="line">	groupMeta, found := m.groupMetaMap[group]</div><div class="line">	<span class="keyword">if</span> !found &#123;</div><div class="line">		<span class="keyword">if</span> group == <span class="string">""</span> &#123;</div><div class="line">			<span class="built_in">panic</span>(<span class="string">"The legacy v1 API is not registered."</span>)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"Group %s is not registered."</span>, group))</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	groupMetaCopy := *groupMeta</div><div class="line">	<span class="keyword">return</span> &amp;groupMetaCopy</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RESTMapper"><a href="#RESTMapper" class="headerlink" title="RESTMapper()"></a>RESTMapper()</h3><p>收集GroupMeta中的RESTMapper，组成MultiRESTMapper，然后再封装成PriorityRESTMapper返回。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RESTMapper returns a union RESTMapper of all known types with priorities chosen in the following order:</span></div><div class="line"><span class="comment">//  1. if KUBE_API_VERSIONS is specified, then KUBE_API_VERSIONS in order, OR</span></div><div class="line"><span class="comment">//  1. legacy kube group preferred version, extensions preferred version, metrics perferred version, legacy</span></div><div class="line"><span class="comment">//     kube any version, extensions any version, metrics any version, all other groups alphabetical preferred version,</span></div><div class="line"><span class="comment">//     all other groups alphabetical.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *APIRegistrationManager)</span> <span class="title">RESTMapper</span><span class="params">(versionPatterns ...unversioned.GroupVersion)</span> <span class="title">meta</span>.<span class="title">RESTMapper</span></span> &#123;</div><div class="line">	unionMapper := meta.MultiRESTMapper&#123;&#125;</div><div class="line">	unionedGroups := sets.NewString()</div><div class="line">	<span class="keyword">for</span> enabledVersion := <span class="keyword">range</span> m.enabledVersions &#123;</div><div class="line">		<span class="keyword">if</span> !unionedGroups.Has(enabledVersion.Group) &#123;</div><div class="line">			unionedGroups.Insert(enabledVersion.Group)</div><div class="line">			groupMeta := m.groupMetaMap[enabledVersion.Group]</div><div class="line">			unionMapper = <span class="built_in">append</span>(unionMapper, groupMeta.RESTMapper)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***如果versionPatterns不为空，则使用versionPatterns作为优先级依据***//</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(versionPatterns) != <span class="number">0</span> &#123;</div><div class="line">		resourcePriority := []unversioned.GroupVersionResource&#123;&#125;</div><div class="line">		kindPriority := []unversioned.GroupVersionKind&#123;&#125;</div><div class="line">		<span class="keyword">for</span> _, versionPriority := <span class="keyword">range</span> versionPatterns &#123;</div><div class="line">			resourcePriority = <span class="built_in">append</span>(resourcePriority, versionPriority.WithResource(meta.AnyResource))</div><div class="line">			kindPriority = <span class="built_in">append</span>(kindPriority, versionPriority.WithKind(meta.AnyKind))</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> meta.PriorityRESTMapper&#123;Delegate: unionMapper, ResourcePriority: resourcePriority, KindPriority: kindPriority&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***如果envRequestedVersions不为空，则使用envRequestedVersions作为优先级依据***//</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(m.envRequestedVersions) != <span class="number">0</span> &#123;</div><div class="line">		resourcePriority := []unversioned.GroupVersionResource&#123;&#125;</div><div class="line">		kindPriority := []unversioned.GroupVersionKind&#123;&#125;</div><div class="line"></div><div class="line">		<span class="keyword">for</span> _, versionPriority := <span class="keyword">range</span> m.envRequestedVersions &#123;</div><div class="line">			resourcePriority = <span class="built_in">append</span>(resourcePriority, versionPriority.WithResource(meta.AnyResource))</div><div class="line">			kindPriority = <span class="built_in">append</span>(kindPriority, versionPriority.WithKind(meta.AnyKind))</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> meta.PriorityRESTMapper&#123;Delegate: unionMapper, ResourcePriority: resourcePriority, KindPriority: kindPriority&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***使用默认的优先级***//</span></div><div class="line">	prioritizedGroups := []<span class="keyword">string</span>&#123;<span class="string">""</span>, <span class="string">"extensions"</span>, <span class="string">"metrics"</span>&#125;</div><div class="line">	resourcePriority, kindPriority := m.prioritiesForGroups(prioritizedGroups...)</div><div class="line"></div><div class="line">	prioritizedGroupsSet := sets.NewString(prioritizedGroups...)</div><div class="line">	remainingGroups := sets.String&#123;&#125;</div><div class="line">	<span class="keyword">for</span> enabledVersion := <span class="keyword">range</span> m.enabledVersions &#123;</div><div class="line">		<span class="keyword">if</span> !prioritizedGroupsSet.Has(enabledVersion.Group) &#123;</div><div class="line">			remainingGroups.Insert(enabledVersion.Group)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	remainingResourcePriority, remainingKindPriority := m.prioritiesForGroups(remainingGroups.List()...)</div><div class="line">	resourcePriority = <span class="built_in">append</span>(resourcePriority, remainingResourcePriority...)</div><div class="line">	kindPriority = <span class="built_in">append</span>(kindPriority, remainingKindPriority...)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> meta.PriorityRESTMapper&#123;Delegate: unionMapper, ResourcePriority: resourcePriority, KindPriority: kindPriority&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/31/apimachinery机制解读(一)-APIRegistrationManager-v1-5-2/" data-id="cj5ule8680019ecqsrhg547si" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Scheme机制解读(三)-Cloner-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/30/Scheme机制解读(三)-Cloner-v1-5-2/" class="article-date">
  <time datetime="2017-07-30T01:16:29.000Z" itemprop="datePublished">2017-07-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/30/Scheme机制解读(三)-Cloner-v1-5-2/">Scheme机制解读(三)-Cloner-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是Cloner"><a href="#什么是Cloner" class="headerlink" title="什么是Cloner"></a>什么是Cloner</h2><p>Cloner是Kubernetes用来管理type对应的拷贝函数，自定义拷贝函数需要注册到Cloner中。Cloner定义在/pkg/conversion/cloner.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Cloner knows how to copy one type to another.</span></div><div class="line"><span class="keyword">type</span> Cloner <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// Map from the type to a function which can do the deep copy.</span></div><div class="line">	deepCopyFuncs          <span class="keyword">map</span>[reflect.Type]reflect.Value</div><div class="line">	generatedDeepCopyFuncs <span class="keyword">map</span>[reflect.Type]<span class="function"><span class="keyword">func</span><span class="params">(in <span class="keyword">interface</span>&#123;&#125;, out <span class="keyword">interface</span>&#123;&#125;, c *Cloner)</span> <span class="title">error</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Cloner结构体只有deepCopyFuncs和generatedDeepCopyFuncs两个字段：</p>
<ul>
<li>deepCopyFuncs: 管理普通拷贝函数，通过RegisterDeepCopyFunc()方法注册；</li>
<li>generatedDeepCopyFuncs: 管理自动生成的拷贝函数，通过RegisterGeneratedDeepCopyFunc()方法注册。</li>
</ul>
<p>Cloner通过NewCloner()函数生成：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewCloner creates a new Cloner object.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCloner</span><span class="params">()</span> *<span class="title">Cloner</span></span> &#123;</div><div class="line">	c := &amp;Cloner&#123;</div><div class="line">		deepCopyFuncs:          <span class="keyword">map</span>[reflect.Type]reflect.Value&#123;&#125;,</div><div class="line">		generatedDeepCopyFuncs: <span class="keyword">map</span>[reflect.Type]<span class="function"><span class="keyword">func</span><span class="params">(in <span class="keyword">interface</span>&#123;&#125;, out <span class="keyword">interface</span>&#123;&#125;, c *Cloner)</span> <span class="title">error</span></span>&#123;&#125;,</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***注册byte类型拷贝函数***//</span></div><div class="line">	<span class="keyword">if</span> err := c.RegisterDeepCopyFunc(byteSliceDeepCopy); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// If one of the deep-copy functions is malformed, detect it immediately.</span></div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> c</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>和Converter一样，我们分为注册方法和拷贝方法两个类别对Cloner的方法进行介绍。</p>
<h2 id="注册方法"><a href="#注册方法" class="headerlink" title="注册方法"></a>注册方法</h2><h3 id="RegisterDeepCopyFunc"><a href="#RegisterDeepCopyFunc" class="headerlink" title="RegisterDeepCopyFunc()"></a>RegisterDeepCopyFunc()</h3><p>RegisterDeepCopyFunc()可以把deepCopyFunc注册到Cloner的deepCopyFuncs中。deepCpyFuncs维持有类型和拷贝函数的map关系。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cloner)</span> <span class="title">RegisterDeepCopyFunc</span><span class="params">(deepCopyFunc <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	fv := reflect.ValueOf(deepCopyFunc)</div><div class="line">	<span class="comment">//***类型 reflect.Value 有一个方法 Type()，它会返回一个 reflect.Type 类型的对象***//</span></div><div class="line">	ft := fv.Type()</div><div class="line">	<span class="keyword">if</span> err := verifyDeepCopyFunctionSignature(ft); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***deepCopyFuncs的key为函数的第一个参数的类型***//</span></div><div class="line">	c.deepCopyFuncs[ft.In(<span class="number">0</span>)] = fv</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RegisterGeneratedDeepCopyFunc"><a href="#RegisterGeneratedDeepCopyFunc" class="headerlink" title="RegisterGeneratedDeepCopyFunc()"></a>RegisterGeneratedDeepCopyFunc()</h3><p>RegisterGeneratedDeepCopyFunc()可以把GeneratedDeepCopyFunc注册到generatedDeepCopyFuncs中。generatedDeepCopyFuncs维持有类型和拷贝函数的关系。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GeneratedDeepCopyFunc bundles an untyped generated deep-copy function of a type</span></div><div class="line"><span class="comment">// with a reflection type object used as a key to lookup the deep-copy function.</span></div><div class="line"><span class="keyword">type</span> GeneratedDeepCopyFunc <span class="keyword">struct</span> &#123;</div><div class="line">	Fn     <span class="function"><span class="keyword">func</span><span class="params">(in <span class="keyword">interface</span>&#123;&#125;, out <span class="keyword">interface</span>&#123;&#125;, c *Cloner)</span> <span class="title">error</span></span></div><div class="line">	<span class="title">InType</span> <span class="title">reflect</span>.<span class="title">Type</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">// <span class="title">Similar</span> <span class="title">to</span> <span class="title">RegisterDeepCopyFunc</span>, <span class="title">but</span> <span class="title">registers</span> <span class="title">deep</span> <span class="title">copy</span> <span class="title">function</span> <span class="title">that</span> <span class="title">were</span></div><div class="line">// <span class="title">automatically</span> <span class="title">generated</span>.</div><div class="line"><span class="title">func</span> <span class="params">(c *Cloner)</span> <span class="title">RegisterGeneratedDeepCopyFunc</span><span class="params">(fn GeneratedDeepCopyFunc)</span> <span class="title">error</span> &#123;</div><div class="line">	c.generatedDeepCopyFuncs[fn.InType] = fn.Fn</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="拷贝方法"><a href="#拷贝方法" class="headerlink" title="拷贝方法"></a>拷贝方法</h2><h3 id="DeepCopy"><a href="#DeepCopy" class="headerlink" title="DeepCopy()"></a>DeepCopy()</h3><p>DeepCopy()为Cloner执行拷贝操作的入口，主要调用了deepCopy()方法。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DeepCopy will perform a deep copy of a given object.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cloner)</span> <span class="title">DeepCopy</span><span class="params">(in <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</div><div class="line">	<span class="comment">// Can be invalid if we run DeepCopy(X) where X is a nil interface type.</span></div><div class="line">	<span class="comment">// For example, we get an invalid value when someone tries to deep-copy</span></div><div class="line">	<span class="comment">// a nil labels.Selector.</span></div><div class="line">	<span class="comment">// This does not occur if X is nil and is a pointer to a concrete type.</span></div><div class="line">	<span class="keyword">if</span> in == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***获取第一个参数的类型，如&lt;float64 Value&gt;***//</span></div><div class="line">	inValue := reflect.ValueOf(in)</div><div class="line">	<span class="comment">//***进行克隆***//</span></div><div class="line">	outValue, err := c.deepCopy(inValue)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> outValue.Interface(), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="deepCopy"><a href="#deepCopy" class="headerlink" title="deepCopy()"></a>deepCopy()</h3><p>deepCopy()的流程如下：</p>
<ol>
<li>获取待拷贝结构体值的类型；</li>
<li>尝试使用deepCopyFuncs中的拷贝函数进行拷贝；</li>
<li>尝试使用generatedDeepCopyFuncs中的拷贝函数进行拷贝；</li>
<li>使用defaultDeepCopy()方法。<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cloner)</span> <span class="title">deepCopy</span><span class="params">(src reflect.Value)</span> <span class="params">(reflect.Value, error)</span></span> &#123;</div><div class="line">	inType := src.Type()</div><div class="line"></div><div class="line">	<span class="keyword">switch</span> src.Kind() &#123;</div><div class="line">	<span class="keyword">case</span> reflect.Interface, reflect.Ptr, reflect.Map, reflect.Slice:</div><div class="line">		<span class="keyword">if</span> src.IsNil() &#123;</div><div class="line">			<span class="keyword">return</span> src, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***从deepCopyFuncs中获取拷贝函数***//</span></div><div class="line">	<span class="keyword">if</span> fv, ok := c.deepCopyFuncs[inType]; ok &#123;</div><div class="line">		<span class="keyword">return</span> c.customDeepCopy(src, fv)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***从generatedDeepCopyFuncs中获取拷贝函数***//</span></div><div class="line">	<span class="keyword">if</span> fv, ok := c.generatedDeepCopyFuncs[inType]; ok &#123;</div><div class="line">		<span class="keyword">var</span> outValue reflect.Value</div><div class="line">		outValue = reflect.New(inType.Elem())</div><div class="line">		err := fv(src.Interface(), outValue.Interface(), c)</div><div class="line">		<span class="keyword">return</span> outValue, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***使用defaultDeepCopy()***//</span></div><div class="line">	<span class="keyword">return</span> c.defaultDeepCopy(src)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cloner)</span> <span class="title">customDeepCopy</span><span class="params">(src, fv reflect.Value)</span> <span class="params">(reflect.Value, error)</span></span> &#123;</div><div class="line">	outValue := reflect.New(src.Type().Elem())</div><div class="line">	args := []reflect.Value&#123;src, outValue, reflect.ValueOf(c)&#125;</div><div class="line">	<span class="comment">//***执行函数***//</span></div><div class="line">	result := fv.Call(args)[<span class="number">0</span>].Interface()</div><div class="line">	<span class="comment">// This convolution is necessary because nil interfaces won't convert</span></div><div class="line">	<span class="comment">// to error.</span></div><div class="line">	<span class="keyword">if</span> result == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> outValue, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> outValue, result.(error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="defaultDeepCopy"><a href="#defaultDeepCopy" class="headerlink" title="defaultDeepCopy()"></a>defaultDeepCopy()</h3><p>defaultDeepCopy()会根据待拷贝类型的不同采取不同的拷贝方法，这过程中可能是递归拷贝。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***根据src的类型进行拷贝，src的类型一般为复杂类型***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cloner)</span> <span class="title">defaultDeepCopy</span><span class="params">(src reflect.Value)</span> <span class="params">(reflect.Value, error)</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> src.Kind() &#123;</div><div class="line">	<span class="keyword">case</span> reflect.Chan, reflect.Func, reflect.UnsafePointer, reflect.Uintptr:</div><div class="line">		<span class="keyword">return</span> src, fmt.Errorf(<span class="string">"cannot deep copy kind: %s"</span>, src.Kind())</div><div class="line">	<span class="keyword">case</span> reflect.Array:</div><div class="line">		dst := reflect.New(src.Type())</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; src.Len(); i++ &#123;</div><div class="line">			copyVal, err := c.deepCopy(src.Index(i))</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> src, errs</div><div class="line">			&#125;</div><div class="line">			dst.Elem().Index(i).Set(copyVal)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> dst.Elem(), <span class="literal">nil</span></div><div class="line">	<span class="keyword">case</span> reflect.Interface:</div><div class="line">		<span class="keyword">if</span> src.IsNil() &#123;</div><div class="line">			<span class="keyword">return</span> src, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> c.deepCopy(src.Elem())</div><div class="line">	<span class="keyword">case</span> reflect.Map:</div><div class="line">		<span class="keyword">if</span> src.IsNil() &#123;</div><div class="line">			<span class="keyword">return</span> src, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		dst := reflect.MakeMap(src.Type())</div><div class="line">		<span class="keyword">for</span> _, k := <span class="keyword">range</span> src.MapKeys() &#123;</div><div class="line">			copyVal, err := c.deepCopy(src.MapIndex(k))</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> src, err</div><div class="line">			&#125;</div><div class="line">			dst.SetMapIndex(k, copyVal)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> dst, <span class="literal">nil</span></div><div class="line">	<span class="keyword">case</span> reflect.Ptr:</div><div class="line">		<span class="keyword">if</span> src.IsNil() &#123;</div><div class="line">			<span class="keyword">return</span> src, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***reflect.New()返回的是指针***//</span></div><div class="line">		dst := reflect.New(src.Type().Elem())</div><div class="line">		copyVal, err := c.deepCopy(src.Elem())</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> src, err</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***设置dst的值***//</span></div><div class="line">		dst.Elem().Set(copyVal)</div><div class="line">		<span class="keyword">return</span> dst, <span class="literal">nil</span></div><div class="line">	<span class="keyword">case</span> reflect.Slice:</div><div class="line">		<span class="keyword">if</span> src.IsNil() &#123;</div><div class="line">			<span class="keyword">return</span> src, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		dst := reflect.MakeSlice(src.Type(), <span class="number">0</span>, src.Len())</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; src.Len(); i++ &#123;</div><div class="line">			copyVal, err := c.deepCopy(src.Index(i))</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> src, err</div><div class="line">			&#125;</div><div class="line">			dst = reflect.Append(dst, copyVal)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> dst, <span class="literal">nil</span></div><div class="line">	<span class="keyword">case</span> reflect.Struct:</div><div class="line">		dst := reflect.New(src.Type())</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; src.NumField(); i++ &#123;</div><div class="line">			<span class="keyword">if</span> !dst.Elem().Field(i).CanSet() &#123;</div><div class="line">				<span class="comment">// Can't set private fields. At this point, the</span></div><div class="line">				<span class="comment">// best we can do is a shallow copy. For</span></div><div class="line">				<span class="comment">// example, time.Time is a value type with</span></div><div class="line">				<span class="comment">// private members that can be shallow copied.</span></div><div class="line">				<span class="keyword">return</span> src, <span class="literal">nil</span></div><div class="line">			&#125;</div><div class="line">			copyVal, err := c.deepCopy(src.Field(i))</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> src, err</div><div class="line">			&#125;</div><div class="line">			dst.Elem().Field(i).Set(copyVal)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> dst.Elem(), <span class="literal">nil</span></div><div class="line"></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="comment">// Value types like numbers, booleans, and strings.</span></div><div class="line">		<span class="keyword">return</span> src, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>该Demo很简单，把结构体A的值aVal拷贝成copyVal。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line"></div><div class="line">	<span class="string">"k8s.io/kubernetes/pkg/conversion"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">type</span> NameMeta <span class="keyword">struct</span> &#123;</div><div class="line">		Name <span class="keyword">string</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">type</span> TypeMeta <span class="keyword">struct</span> &#123;</div><div class="line">		Type <span class="keyword">string</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">type</span> A <span class="keyword">struct</span> &#123;</div><div class="line">		TypeMeta</div><div class="line">		NameMeta</div><div class="line">	&#125;</div><div class="line">	cloner := conversion.NewCloner()</div><div class="line">	err := cloner.RegisterDeepCopyFunc(</div><div class="line">		<span class="function"><span class="keyword">func</span><span class="params">(in *A, out *A, c *conversion.Cloner)</span> <span class="title">error</span></span> &#123;</div><div class="line">			copyTypeMeta, _ := c.DeepCopy(in.TypeMeta)</div><div class="line">			copyNameMeta, _ := c.DeepCopy(in.NameMeta)</div><div class="line">			out.TypeMeta = copyTypeMeta.(TypeMeta)</div><div class="line">			out.NameMeta = copyNameMeta.(NameMeta)</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(<span class="string">"error occurs for cloner.RegisterDeepCopyFunc:"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	aVal := &amp;A&#123;</div><div class="line">		TypeMeta: TypeMeta&#123;<span class="string">"animal"</span>&#125;,</div><div class="line">		NameMeta: NameMeta&#123;<span class="string">"Cat"</span>&#125;&#125;</div><div class="line">	copyVal, _ := cloner.DeepCopy(aVal)</div><div class="line">	fmt.Println(copyVal)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Clone *main.A            <span class="comment">//执行copyVal, _ := cloner.DeepCopy(aVal)，开始拷贝</span></div><div class="line">use deepCopyFuncs *main.A   <span class="comment">//*main.A的拷贝函数有注册，所以使用deepCopyFuncs中的拷贝函数进行拷贝</span></div><div class="line">Clone main.TypeMeta     <span class="comment">//拷贝函数中执行copyTypeMeta, _ := c.DeepCopy(in.TypeMeta)，开始拷贝in.TypeMeta</span></div><div class="line">in defaultDeepCopy <span class="keyword">struct</span>  <span class="comment">//未注册*main.TypeMeta的拷贝函数，所以执行defaultDeepCopy()，需要拷贝的是struct，则递归拷贝字段</span></div><div class="line">in defaultDeepCopy <span class="keyword">string</span>  <span class="comment">//未注册*string的拷贝函数，所以执行defaultDeepCopy()，完成string的拷贝</span></div><div class="line">Clone main.NameMeta  <span class="comment">//拷贝函数中执行copyNameMeta, _ := c.DeepCopy(in.NameMeta)，开始拷贝in.NameMeta</span></div><div class="line">in defaultDeepCopy <span class="keyword">struct</span>  <span class="comment">//未注册*main.NameMeta的拷贝函数，所以执行defaultDeepCopy()，需要拷贝的是struct，则递归拷贝字段</span></div><div class="line">in defaultDeepCopy <span class="keyword">string</span>  <span class="comment">//未注册*string的拷贝函数，所以执行defaultDeepCopy()，完成string的拷贝</span></div><div class="line">&amp;&#123;&#123;animal&#125; &#123;Cat&#125;&#125;  <span class="comment">//打印copyVal</span></div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/30/Scheme机制解读(三)-Cloner-v1-5-2/" data-id="cj5ule85q000yecqsafiiimpi" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Scheme机制解读(二)-Converter-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/29/Scheme机制解读(二)-Converter-v1-5-2/" class="article-date">
  <time datetime="2017-07-29T06:31:21.000Z" itemprop="datePublished">2017-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/29/Scheme机制解读(二)-Converter-v1-5-2/">Scheme机制解读(二)-Converter-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是Converter"><a href="#什么是Converter" class="headerlink" title="什么是Converter"></a>什么是Converter</h2><p>Converter可以完成不同结构体之间的转换。在Kubernetes中，Converter用来把一个版本的object转换成其他版本的object，转换函数需要通过注册的方式添加到Converter中。</p>
<p>先来看下Converter的定义，Converter定义在/pkg/conversion/converter.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Converter knows how to convert one type to another.</span></div><div class="line"><span class="keyword">type</span> Converter <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// Map from the conversion pair to a function which can</span></div><div class="line">	<span class="comment">// do the conversion.</span></div><div class="line">	<span class="comment">//***普通转换函数***//</span></div><div class="line">	conversionFuncs ConversionFuncs</div><div class="line">	<span class="comment">//***自动生成的转换函数***//</span></div><div class="line">	generatedConversionFuncs ConversionFuncs</div><div class="line"></div><div class="line">	<span class="comment">// genericConversions are called during normal conversion to offer a "fast-path"</span></div><div class="line">	<span class="comment">// that avoids all reflection. These methods are not called outside of the .Convert()</span></div><div class="line">	<span class="comment">// method.</span></div><div class="line">	<span class="comment">//***优先级最高***//</span></div><div class="line">	genericConversions []GenericConversionFunc</div><div class="line"></div><div class="line">	<span class="comment">// Set of conversions that should be treated as a no-op</span></div><div class="line">	<span class="comment">//***需要忽略的转换***//</span></div><div class="line">	ignoredConversions <span class="keyword">map</span>[typePair]<span class="keyword">struct</span>&#123;&#125;</div><div class="line"></div><div class="line">	<span class="comment">// This is a map from a source field type and name, to a list of destination</span></div><div class="line">	<span class="comment">// field type and name.</span></div><div class="line">	structFieldDests <span class="keyword">map</span>[typeNamePair][]typeNamePair</div><div class="line"></div><div class="line">	<span class="comment">// Allows for the opposite lookup of structFieldDests. So that SourceFromDest</span></div><div class="line">	<span class="comment">// copy flag also works. So this is a map of destination field name, to potential</span></div><div class="line">	<span class="comment">// source field name and type to look for.</span></div><div class="line">	structFieldSources <span class="keyword">map</span>[typeNamePair][]typeNamePair</div><div class="line"></div><div class="line">	<span class="comment">// Map from a type to a function which applies defaults.</span></div><div class="line">	<span class="comment">//***设置默认值函数***//</span></div><div class="line">	defaultingFuncs <span class="keyword">map</span>[reflect.Type]reflect.Value</div><div class="line"></div><div class="line">	<span class="comment">// Similar to above, but function is stored as interface&#123;&#125;.</span></div><div class="line">	defaultingInterfaces <span class="keyword">map</span>[reflect.Type]<span class="keyword">interface</span>&#123;&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Map from an input type to a function which can apply a key name mapping</span></div><div class="line">	inputFieldMappingFuncs <span class="keyword">map</span>[reflect.Type]FieldMappingFunc</div><div class="line"></div><div class="line">	<span class="comment">// Map from an input type to a set of default conversion flags.</span></div><div class="line">	inputDefaultFlags <span class="keyword">map</span>[reflect.Type]FieldMatchingFlags</div><div class="line"></div><div class="line">	<span class="comment">// If non-nil, will be called to print helpful debugging info. Quite verbose.</span></div><div class="line">	Debug DebugLogger</div><div class="line"></div><div class="line">	<span class="comment">// nameFunc is called to retrieve the name of a type; this name is used for the</span></div><div class="line">	<span class="comment">// purpose of deciding whether two types match or not (i.e., will we attempt to</span></div><div class="line">	<span class="comment">// do a conversion). The default returns the go type name.</span></div><div class="line">	nameFunc <span class="function"><span class="keyword">func</span><span class="params">(t reflect.Type)</span> <span class="title">string</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Converter结构体的字段涵义如下：</p>
<ul>
<li>conversionFuncs: 普通转换函数，通过RegisterConversionFunc()方法进行注册；</li>
<li>generatedConversionFuncs: 自动生成的转换函数，通过RegisterGeneratedConversionFunc()方法进行注册；</li>
<li>genericConversions：通用转换函数，优化级最高的转换函数，可以理解为转换的快速通道，通过AddGenericConversionFunc()方法进行注册；</li>
<li>ignoredConversions：需要忽略的转换，如果两个结构体之间不允许转换，则通过RegisterIgnoredConversion()方法进行注册；</li>
<li>structFieldDests：源结构体中字段到目标结构体中的字段的映射关系，通过SetStructFieldCopy()方法进行注册；</li>
<li>structFieldSources：与structFieldDests相反，是目的结构体中字段到源结构体中的字段的映射关系，通过SetStructFieldCopy()方法进行注册；</li>
<li>defaultingFuncs：设置结构体值的默认值，通过RegisterDefaultingFunc()方法进行注册；</li>
<li>inputFieldMappingFuncs：暂不知道用途；</li>
<li>inputDefaultFlags：暂不知道用途；</li>
<li>nameFunc：获取结构体名称的函数。</li>
</ul>
<p>Converter的生成方法如下，只要传入NameFunc即可：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewConverter creates a new Converter object.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewConverter</span><span class="params">(nameFn NameFunc)</span> *<span class="title">Converter</span></span> &#123;</div><div class="line">	c := &amp;Converter&#123;</div><div class="line">		conversionFuncs:          NewConversionFuncs(),</div><div class="line">		generatedConversionFuncs: NewConversionFuncs(),</div><div class="line">		ignoredConversions:       <span class="built_in">make</span>(<span class="keyword">map</span>[typePair]<span class="keyword">struct</span>&#123;&#125;),</div><div class="line">		defaultingFuncs:          <span class="built_in">make</span>(<span class="keyword">map</span>[reflect.Type]reflect.Value),</div><div class="line">		defaultingInterfaces:     <span class="built_in">make</span>(<span class="keyword">map</span>[reflect.Type]<span class="keyword">interface</span>&#123;&#125;),</div><div class="line">		nameFunc:                 nameFn,</div><div class="line">		structFieldDests:         <span class="built_in">make</span>(<span class="keyword">map</span>[typeNamePair][]typeNamePair),</div><div class="line">		structFieldSources:       <span class="built_in">make</span>(<span class="keyword">map</span>[typeNamePair][]typeNamePair),</div><div class="line"></div><div class="line">		inputFieldMappingFuncs: <span class="built_in">make</span>(<span class="keyword">map</span>[reflect.Type]FieldMappingFunc),</div><div class="line">		inputDefaultFlags:      <span class="built_in">make</span>(<span class="keyword">map</span>[reflect.Type]FieldMatchingFlags),</div><div class="line">	&#125;</div><div class="line">	c.RegisterConversionFunc(Convert_Slice_byte_To_Slice_byte)</div><div class="line">	<span class="keyword">return</span> c</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>关于NameFunc，只要实现返回一个结构体的“名字”就行，如：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> DefaultNameFunc = <span class="function"><span class="keyword">func</span><span class="params">(t reflect.Type)</span> <span class="title">string</span></span> &#123; <span class="keyword">return</span> t.Name() &#125;</div></pre></td></tr></table></figure></p>
<p>在介绍Converter的方法之前，先介绍ConversionFuncs和scope两个概念。</p>
<h2 id="ConversionFuncs"><a href="#ConversionFuncs" class="headerlink" title="ConversionFuncs"></a>ConversionFuncs</h2><p>在Converter的字段中，不管是conversionFuncs，还是generatedConversionFuncs，都是结构体ConversionFuncs。结构体ConversionFuncs用来管理转换函数，定义在/pkg/conversin/converter.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> typePair <span class="keyword">struct</span> &#123;</div><div class="line">	source reflect.Type</div><div class="line">	dest   reflect.Type</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> ConversionFuncs <span class="keyword">struct</span> &#123;</div><div class="line">	fns <span class="keyword">map</span>[typePair]reflect.Value</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在ConversionFuncs结构体中，只有一个字段<code>fns map[typePair]reflect.Value</code>，即{source, dest}到转换函数的映射表。</p>
<p>再来看ConversionFuncs支持的方法。</p>
<h3 id="Add"><a href="#Add" class="headerlink" title="Add()"></a>Add()</h3><p>ConversionFuncs的Add()方法的参数是转换函数(<code>func(type1, type2, Scope) error</code>)，然后提取转换函数第一个参数的类型作为source，提取第二个参数的类型作为dest，然后把{source, dest}作为key，转换函数作为value，一起存储到fns字段中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c ConversionFuncs)</span> <span class="title">Add</span><span class="params">(fns ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, fn := <span class="keyword">range</span> fns &#123;</div><div class="line">		fv := reflect.ValueOf(fn)</div><div class="line">		ft := fv.Type()</div><div class="line">		<span class="keyword">if</span> err := verifyConversionFunctionSignature(ft); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		c.fns[typePair&#123;ft.In(<span class="number">0</span>).Elem(), ft.In(<span class="number">1</span>).Elem()&#125;] = fv</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Merge"><a href="#Merge" class="headerlink" title="Merge()"></a>Merge()</h3><p>ConversionFuncs的Merge()方法可以把两个ConversionFuncs中的转换函数融合成一个ConversionFuncs。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c ConversionFuncs)</span> <span class="title">Merge</span><span class="params">(other ConversionFuncs)</span> <span class="title">ConversionFuncs</span></span> &#123;</div><div class="line">	merged := NewConversionFuncs()</div><div class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> c.fns &#123;</div><div class="line">		merged.fns[k] = v</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> other.fns &#123;</div><div class="line">		merged.fns[k] = v</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> merged</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Scope"><a href="#Scope" class="headerlink" title="Scope"></a>Scope</h2><p>Scope是一个interface，所以我们来分析其实现者scope。</p>
<p>scope包含了递归转换中需要的一些内容。先来看下scope的定义，同样在/pkg/conversion/converter.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// scope contains information about an ongoing conversion.</span></div><div class="line"><span class="keyword">type</span> scope <span class="keyword">struct</span> &#123;</div><div class="line">	converter *Converter</div><div class="line">	meta      *Meta</div><div class="line">	flags     FieldMatchingFlags</div><div class="line"></div><div class="line">	<span class="comment">// srcStack &amp; destStack are separate because they may not have a 1:1</span></div><div class="line">	<span class="comment">// relationship.</span></div><div class="line">	srcStack  scopeStack</div><div class="line">	destStack scopeStack</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>来看scope的字段：</p>
<ul>
<li>converter：scope包含一个converter，以方便递归转换；</li>
<li>meta：暂不知道用途；</li>
<li><p>flags：转换时字段的策略，定义如下，可以使用IsSet()方法判断对应的flag是否被设置。<br>其中：<br>DestFromSource表示循环目标结构体字段，寻找合适的源结构体字段；<br>SourceToDest表示循环源结构体字段，寻找合适的目标结构体字段；<br>IgnoreMissingFields表示如果未找到合适的目标不报错；<br>AllowDifferentFieldTypeNames表示允许源结构体和目标结构体不同的类型相匹配。<br>具体定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> FieldMatchingFlags <span class="keyword">int</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	<span class="comment">// Loop through destination fields, search for matching source</span></div><div class="line">	<span class="comment">// field to copy it from. Source fields with no corresponding</span></div><div class="line">	<span class="comment">// destination field will be ignored. If SourceToDest is</span></div><div class="line">	<span class="comment">// specified, this flag is ignored. If neither is specified,</span></div><div class="line">	<span class="comment">// or no flags are passed, this flag is the default.</span></div><div class="line">	DestFromSource FieldMatchingFlags = <span class="number">0</span></div><div class="line">	<span class="comment">// Loop through source fields, search for matching dest field</span></div><div class="line">	<span class="comment">// to copy it into. Destination fields with no corresponding</span></div><div class="line">	<span class="comment">// source field will be ignored.</span></div><div class="line">	SourceToDest FieldMatchingFlags = <span class="number">1</span> &lt;&lt; <span class="literal">iota</span></div><div class="line">	<span class="comment">// Don't treat it as an error if the corresponding source or</span></div><div class="line">	<span class="comment">// dest field can't be found.</span></div><div class="line">	IgnoreMissingFields</div><div class="line">	<span class="comment">// Don't require type names to match.</span></div><div class="line">	AllowDifferentFieldTypeNames</div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">//***此处的DestFromSource 0作特殊处理，其他的用&amp;操作来判断是否设置***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f FieldMatchingFlags)</span> <span class="title">IsSet</span><span class="params">(flag FieldMatchingFlags)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> flag == DestFromSource &#123;</div><div class="line">		<span class="comment">// The bit logic doesn't work on the default value.</span></div><div class="line">		<span class="keyword">return</span> f&amp;SourceToDest != SourceToDest</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> f&amp;flag == flag</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>srcStack, destStack：字段信息栈。scopeStack定义如下，其中scopeStackElem表示字段，包含了key, value, tag三部分信息；scopeStack实现了scopeStackElem栈，以配合递归转换:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> scopeStackElem <span class="keyword">struct</span> &#123;</div><div class="line">	tag   reflect.StructTag</div><div class="line">	value reflect.Value</div><div class="line">	key   <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> scopeStack []scopeStackElem</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *scopeStack)</span> <span class="title">pop</span><span class="params">()</span></span> &#123;</div><div class="line">	n := <span class="built_in">len</span>(*s)</div><div class="line">	*s = (*s)[:n<span class="number">-1</span>]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *scopeStack)</span> <span class="title">push</span><span class="params">(e scopeStackElem)</span></span> &#123;</div><div class="line">	*s = <span class="built_in">append</span>(*s, e)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *scopeStack)</span> <span class="title">top</span><span class="params">()</span> *<span class="title">scopeStackElem</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;(*s)[<span class="built_in">len</span>(*s)<span class="number">-1</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>可以看出，scope包含了converter。之前说过，转换函数一般为<code>func(type1, type2, Scope) error</code>，如果转换函数中有转换的需要，则可以使用scope的converter进行进一步转换。</p>
<h3 id="Convert"><a href="#Convert" class="headerlink" title="Convert()"></a>Convert()</h3><p>scope封装了converter.Convert()方法。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Convert continues a conversion.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *scope)</span> <span class="title">Convert</span><span class="params">(src, dest <span class="keyword">interface</span>&#123;&#125;, flags FieldMatchingFlags)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> s.converter.Convert(src, dest, flags, s.meta)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="注册方法"><a href="#注册方法" class="headerlink" title="注册方法"></a>注册方法</h2><p>Converter注册类有方法是供注册时调用的方法。主要有：</p>
<h3 id="RegisterConversionFunc"><a href="#RegisterConversionFunc" class="headerlink" title="RegisterConversionFunc()"></a>RegisterConversionFunc()</h3><p>RegisterConversionFunc()可以把conversionFunc注册到Converter的conversionFuncs中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">RegisterConversionFunc</span><span class="params">(conversionFunc <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> c.conversionFuncs.Add(conversionFunc)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RegisterGeneratedConversionFunc"><a href="#RegisterGeneratedConversionFunc" class="headerlink" title="RegisterGeneratedConversionFunc()"></a>RegisterGeneratedConversionFunc()</h3><p>RegisterGeneratedConversionFunc()可以把conversionFunc注册到Converter的generatedConversionFuncs中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从字面上可以理解，这些转换函数是某些机制自动生成的***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">RegisterGeneratedConversionFunc</span><span class="params">(conversionFunc <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> c.generatedConversionFuncs.Add(conversionFunc)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RegisterIgnoredConversion"><a href="#RegisterIgnoredConversion" class="headerlink" title="RegisterIgnoredConversion()"></a>RegisterIgnoredConversion()</h3><p>RegisterIgnoredConversion()可以把需要忽略的{from, to}注册到Converter的ignoredConversions中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">RegisterIgnoredConversion</span><span class="params">(from, to <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	typeFrom := reflect.TypeOf(from)</div><div class="line">	typeTo := reflect.TypeOf(to)</div><div class="line">	<span class="keyword">if</span> reflect.TypeOf(from).Kind() != reflect.Ptr &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"expected pointer arg for 'from' param 0, got: %v"</span>, typeFrom)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> typeTo.Kind() != reflect.Ptr &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"expected pointer arg for 'to' param 1, got: %v"</span>, typeTo)</div><div class="line">	&#125;</div><div class="line">	c.ignoredConversions[typePair&#123;typeFrom.Elem(), typeTo.Elem()&#125;] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RegisterDefaultingFunc"><a href="#RegisterDefaultingFunc" class="headerlink" title="RegisterDefaultingFunc()"></a>RegisterDefaultingFunc()</h3><p>RegisterDefaultingFunc()可以把defaultingFunc注册到Converter的defaultingFuncs和defaultingInterfaces中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***注册DefaultingFunc入口***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">RegisterDefaultingFunc</span><span class="params">(defaultingFunc <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	fv := reflect.ValueOf(defaultingFunc)</div><div class="line">	ft := fv.Type()</div><div class="line">	<span class="keyword">if</span> ft.Kind() != reflect.Func &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"expected func, got: %v"</span>, ft)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> ft.NumIn() != <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"expected one 'in' param, got: %v"</span>, ft)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> ft.NumOut() != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"expected zero 'out' params, got: %v"</span>, ft)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> ft.In(<span class="number">0</span>).Kind() != reflect.Ptr &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"expected pointer arg for 'in' param 0, got: %v"</span>, ft)</div><div class="line">	&#125;</div><div class="line">	inType := ft.In(<span class="number">0</span>).Elem()</div><div class="line">	c.defaultingFuncs[inType] = fv</div><div class="line">	c.defaultingInterfaces[inType] = defaultingFunc</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RegisterInputDefaults"><a href="#RegisterInputDefaults" class="headerlink" title="RegisterInputDefaults()"></a>RegisterInputDefaults()</h3><p>RegisterInputDefaults()可以把相关内容注册到Converter的inputFieldMappingFuncs和inputDefaultFlags中。但inputFieldMappingFuncs和inputDefaultFlags的具体用途目前还不清楚。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">RegisterInputDefaults</span><span class="params">(in <span class="keyword">interface</span>&#123;&#125;, fn FieldMappingFunc, defaultFlags FieldMatchingFlags)</span> <span class="title">error</span></span> &#123;</div><div class="line">	fv := reflect.ValueOf(in)</div><div class="line">	ft := fv.Type()</div><div class="line">	<span class="keyword">if</span> ft.Kind() != reflect.Ptr &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"expected pointer 'in' argument, got: %v"</span>, ft)</div><div class="line">	&#125;</div><div class="line">	c.inputFieldMappingFuncs[ft] = fn</div><div class="line">	c.inputDefaultFlags[ft] = defaultFlags</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="SetStructFieldCopy"><a href="#SetStructFieldCopy" class="headerlink" title="SetStructFieldCopy()"></a>SetStructFieldCopy()</h3><p>SetStructFieldCopy()把结构体间字段关系注册到Converter的structFieldDests和structFieldSources中。结构体间字段关系转换优先级高于同名字段转换。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">SetStructFieldCopy</span><span class="params">(srcFieldType <span class="keyword">interface</span>&#123;&#125;, srcFieldName <span class="keyword">string</span>, destFieldType <span class="keyword">interface</span>&#123;&#125;, destFieldName <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	st := reflect.TypeOf(srcFieldType)</div><div class="line">	dt := reflect.TypeOf(destFieldType)</div><div class="line">	srcKey := typeNamePair&#123;st, srcFieldName&#125;</div><div class="line">	destKey := typeNamePair&#123;dt, destFieldName&#125;</div><div class="line">	c.structFieldDests[srcKey] = <span class="built_in">append</span>(c.structFieldDests[srcKey], destKey)</div><div class="line">	c.structFieldSources[destKey] = <span class="built_in">append</span>(c.structFieldSources[destKey], srcKey)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="转换方法"><a href="#转换方法" class="headerlink" title="转换方法"></a>转换方法</h2><p>Converter的转换函数优先级为：</p>
<ol>
<li>使用genericConversions中的转换函数；</li>
<li>检查是否在ignoredConversions中，如果是则直接返回；</li>
<li>使用conversionFuncs中的转换函数；</li>
<li>使用generatedConversionFuncs中的转换函数；</li>
<li>使用defaultConvert()方法转换，defaultConvert()方法会递归式地对字段进行转换。</li>
</ol>
<h3 id="Convert-1"><a href="#Convert-1" class="headerlink" title="Convert()"></a>Convert()</h3><p>Convert()是Converter的转换的入口。Convert()先尝试使用genericcConversions中的转换函数去完成转换，如果成功，则返回；否则，调用doConversion()，传入的conversionFunc为convert()方法。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***转换函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">Convert</span><span class="params">(src, dest <span class="keyword">interface</span>&#123;&#125;, flags FieldMatchingFlags, meta *Meta)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(c.genericConversions) &gt; <span class="number">0</span> &#123;</div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> avoid scope allocation</span></div><div class="line">		s := &amp;scope&#123;converter: c, flags: flags, meta: meta&#125;</div><div class="line">		<span class="comment">//***逐个尝试genericConversions中的转换函数***//</span></div><div class="line">		<span class="keyword">for</span> _, fn := <span class="keyword">range</span> c.genericConversions &#123;</div><div class="line">			<span class="keyword">if</span> ok, err := fn(src, dest, s); ok &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***调用doConversion()***//</span></div><div class="line">	<span class="keyword">return</span> c.doConversion(src, dest, flags, meta, c.convert)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="DefaultConvert"><a href="#DefaultConvert" class="headerlink" title="DefaultConvert()"></a>DefaultConvert()</h3><p>DefaultConvert()直接调用doConversion()方法进行转换。传入的conversionFunc为defaultConvert()方法。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">DefaultConvert</span><span class="params">(src, dest <span class="keyword">interface</span>&#123;&#125;, flags FieldMatchingFlags, meta *Meta)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> c.doConversion(src, dest, flags, meta, c.defaultConvert)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="doConversion"><a href="#doConversion" class="headerlink" title="doConversion()"></a>doConversion()</h3><p>doConversion()在进行一系列的检查后，调用参数f，即convert()或defaultConvert()方法。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***转换函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">doConversion</span><span class="params">(src, dest <span class="keyword">interface</span>&#123;&#125;, flags FieldMatchingFlags, meta *Meta, f conversionFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	dv, err := EnforcePtr(dest)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***dest必须是可写的***//</span></div><div class="line">	<span class="keyword">if</span> !dv.CanAddr() &amp;&amp; !dv.CanSet() &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"can't write to dest"</span>)</div><div class="line">	&#125;</div><div class="line">	sv, err := EnforcePtr(src)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	s := &amp;scope&#123;</div><div class="line">		converter: c,</div><div class="line">		flags:     flags,</div><div class="line">		meta:      meta,</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Leave something on the stack, so that calls to struct tag getters never fail.</span></div><div class="line">	s.srcStack.push(scopeStackElem&#123;&#125;)</div><div class="line">	s.destStack.push(scopeStackElem&#123;&#125;)</div><div class="line">	<span class="keyword">return</span> f(sv, dv, s)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="convert"><a href="#convert" class="headerlink" title="convert()"></a>convert()</h3><p>convert()的流程如下：</p>
<ol>
<li>获取源和目标的类型；</li>
<li>设置源的默认值；</li>
<li>判断是否在ignoredConversions中；</li>
<li>尝试从conversionFuncs中获取转换函数进行转换；</li>
<li>尝试从generatedConversionFuncs中获取转换函数进行转换；</li>
<li>尝试默认的转换函数，即defaultConvert()。<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">convert</span><span class="params">(sv, dv reflect.Value, scope *scope)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***获取源和目标的类型***//</span></div><div class="line">	dt, st := dv.Type(), sv.Type()</div><div class="line">	<span class="comment">// Apply default values.</span></div><div class="line">	<span class="comment">//***设置默认值***//</span></div><div class="line">	<span class="keyword">if</span> fv, ok := c.defaultingFuncs[st]; ok &#123;</div><div class="line">		<span class="keyword">if</span> c.Debug != <span class="literal">nil</span> &#123;</div><div class="line">			c.Debug.Logf(<span class="string">"Applying defaults for '%v'"</span>, st)</div><div class="line">		&#125;</div><div class="line">		args := []reflect.Value&#123;sv.Addr()&#125;</div><div class="line">		fv.Call(args)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	pair := typePair&#123;st, dt&#125;</div><div class="line"></div><div class="line">	<span class="comment">// ignore conversions of this type</span></div><div class="line">	<span class="comment">//***判断是否在ignoredConversions中***//</span></div><div class="line">	<span class="keyword">if</span> _, ok := c.ignoredConversions[pair]; ok &#123;</div><div class="line">		<span class="keyword">if</span> c.Debug != <span class="literal">nil</span> &#123;</div><div class="line">			c.Debug.Logf(<span class="string">"Ignoring conversion of '%v' to '%v'"</span>, st, dt)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Convert sv to dv.</span></div><div class="line">	<span class="comment">//***获取转换函数，并执行***//</span></div><div class="line">	<span class="keyword">if</span> fv, ok := c.conversionFuncs.fns[pair]; ok &#123;</div><div class="line">		<span class="keyword">if</span> c.Debug != <span class="literal">nil</span> &#123;</div><div class="line">			c.Debug.Logf(<span class="string">"Calling custom conversion of '%v' to '%v'"</span>, st, dt)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> c.callCustom(sv, dv, fv, scope)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***尝试generatedConversionFuncs***//</span></div><div class="line">	<span class="keyword">if</span> fv, ok := c.generatedConversionFuncs.fns[pair]; ok &#123;</div><div class="line">		<span class="keyword">if</span> c.Debug != <span class="literal">nil</span> &#123;</div><div class="line">			c.Debug.Logf(<span class="string">"Calling generated conversion of '%v' to '%v'"</span>, st, dt)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> c.callCustom(sv, dv, fv, scope)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***尝试默认的转换函数***//</span></div><div class="line">	<span class="keyword">return</span> c.defaultConvert(sv, dv, scope)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="defaultConvert"><a href="#defaultConvert" class="headerlink" title="defaultConvert()"></a>defaultConvert()</h3><p>defaultConvert()在转换时，如果源字段是基础类型，则调用reflect.Value的Set()方法直接对目标字段设置；否则按照目标字段的类型(此处按目标字段类型是可以先对源类型进行处理，然后再转换)进行不同处理，这里可能使用的就是递归转换。</p>
<p>因为defaultConvert()中定义有对基础类型的转换函数，所以递归迟早会结束。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">defaultConvert</span><span class="params">(sv, dv reflect.Value, scope *scope)</span> <span class="title">error</span></span> &#123;</div><div class="line">	dt, st := dv.Type(), sv.Type()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> !dv.CanSet() &#123;</div><div class="line">		<span class="keyword">return</span> scope.errorf(<span class="string">"Cannot set dest. (Tried to deep copy something with unexported fields?)"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> !scope.flags.IsSet(AllowDifferentFieldTypeNames) &amp;&amp; c.nameFunc(dt) != c.nameFunc(st) &#123;</div><div class="line">		<span class="keyword">return</span> scope.errorf(</div><div class="line">			<span class="string">"type names don't match (%v, %v), and no conversion 'func (%v, %v) error' registered."</span>,</div><div class="line">			c.nameFunc(st), c.nameFunc(dt), st, dt)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">switch</span> st.Kind() &#123;</div><div class="line">	<span class="keyword">case</span> reflect.Map, reflect.Ptr, reflect.Slice, reflect.Interface, reflect.Struct:</div><div class="line">		<span class="comment">// Don't copy these via assignment/conversion!</span></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="comment">// This should handle all simple types.</span></div><div class="line">		<span class="keyword">if</span> st.AssignableTo(dt) &#123;</div><div class="line">			dv.Set(sv)</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> st.ConvertibleTo(dt) &#123;</div><div class="line">			dv.Set(sv.Convert(dt))</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> c.Debug != <span class="literal">nil</span> &#123;</div><div class="line">		c.Debug.Logf(<span class="string">"Trying to convert '%v' to '%v'"</span>, st, dt)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***把“字段”压入栈***//</span></div><div class="line">	scope.srcStack.push(scopeStackElem&#123;value: sv&#125;)</div><div class="line">	scope.destStack.push(scopeStackElem&#123;value: dv&#125;)</div><div class="line">	<span class="keyword">defer</span> scope.srcStack.pop()</div><div class="line">	<span class="keyword">defer</span> scope.destStack.pop()</div><div class="line"></div><div class="line">	<span class="keyword">switch</span> dv.Kind() &#123;</div><div class="line">	<span class="keyword">case</span> reflect.Struct:</div><div class="line">		<span class="comment">//***如果是struct，则调用convertKV()***//</span></div><div class="line">		<span class="keyword">return</span> c.convertKV(toKVValue(sv), toKVValue(dv), scope)</div><div class="line">	<span class="keyword">case</span> reflect.Slice:</div><div class="line">		<span class="keyword">if</span> sv.IsNil() &#123;</div><div class="line">			<span class="comment">// Don't make a zero-length slice.</span></div><div class="line">			dv.Set(reflect.Zero(dt))</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		dv.Set(reflect.MakeSlice(dt, sv.Len(), sv.Cap()))</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; sv.Len(); i++ &#123;</div><div class="line">			scope.setIndices(i, i)</div><div class="line">			<span class="keyword">if</span> err := c.convert(sv.Index(i), dv.Index(i), scope); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">case</span> reflect.Ptr:</div><div class="line">		<span class="keyword">if</span> sv.IsNil() &#123;</div><div class="line">			<span class="comment">// Don't copy a nil ptr!</span></div><div class="line">			dv.Set(reflect.Zero(dt))</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		dv.Set(reflect.New(dt.Elem()))</div><div class="line">		<span class="keyword">switch</span> st.Kind() &#123;</div><div class="line">		<span class="keyword">case</span> reflect.Ptr, reflect.Interface:</div><div class="line">			<span class="keyword">return</span> c.convert(sv.Elem(), dv.Elem(), scope)</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			<span class="keyword">return</span> c.convert(sv, dv.Elem(), scope)</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">case</span> reflect.Map:</div><div class="line">		<span class="keyword">if</span> sv.IsNil() &#123;</div><div class="line">			<span class="comment">// Don't copy a nil ptr!</span></div><div class="line">			dv.Set(reflect.Zero(dt))</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		dv.Set(reflect.MakeMap(dt))</div><div class="line">		<span class="keyword">for</span> _, sk := <span class="keyword">range</span> sv.MapKeys() &#123;</div><div class="line">			dk := reflect.New(dt.Key()).Elem()</div><div class="line">			<span class="keyword">if</span> err := c.convert(sk, dk, scope); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">			dkv := reflect.New(dt.Elem()).Elem()</div><div class="line">			scope.setKeys(sk.Interface(), dk.Interface())</div><div class="line">			<span class="comment">// <span class="doctag">TODO:</span>  sv.MapIndex(sk) may return a value with CanAddr() == false,</span></div><div class="line">			<span class="comment">// because a map[string]struct&#123;&#125; does not allow a pointer reference.</span></div><div class="line">			<span class="comment">// Calling a custom conversion function defined for the map value</span></div><div class="line">			<span class="comment">// will panic. Example is PodInfo map[string]ContainerStatus.</span></div><div class="line">			<span class="keyword">if</span> err := c.convert(sv.MapIndex(sk), dkv, scope); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">			dv.SetMapIndex(dk, dkv)</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">case</span> reflect.Interface:</div><div class="line">		<span class="keyword">if</span> sv.IsNil() &#123;</div><div class="line">			<span class="comment">// Don't copy a nil interface!</span></div><div class="line">			dv.Set(reflect.Zero(dt))</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		tmpdv := reflect.New(sv.Elem().Type()).Elem()</div><div class="line">		<span class="keyword">if</span> err := c.convert(sv.Elem(), tmpdv, scope); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		dv.Set(reflect.ValueOf(tmpdv.Interface()))</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> scope.errorf(<span class="string">"couldn't copy '%v' into '%v'; didn't understand types"</span>, st, dt)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="convertKV"><a href="#convertKV" class="headerlink" title="convertKV()"></a>convertKV()</h3><p>convertKV()可以完成struct之间的转换。当然，struct之间的转换函数是未被定义的，不然流程不会走到defaultConvert()。</p>
<p>convertKV()的流程如下：</p>
<ol>
<li>先根据scope中的flag来确定使用源，还是目标结构体的字段作为标准；</li>
<li>对字段进行checkField()检查，即使用Converter的structFieldDests和structFieldSources来获取对应关系，然后完成转换，具体见checkField()方法分析。</li>
<li>接着使用同名字段转换策略，调用convert()转换字段。<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">convertKV</span><span class="params">(skv, dkv kvValue, scope *scope)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> skv == <span class="literal">nil</span> || dkv == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> add keys to stack to support really understandable error messages.</span></div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"Unable to convert %#v to %#v"</span>, skv, dkv)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	lister := dkv</div><div class="line">	<span class="keyword">if</span> scope.flags.IsSet(SourceToDest) &#123;</div><div class="line">		lister = skv</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> mapping FieldMappingFunc</div><div class="line">	<span class="keyword">if</span> scope.meta != <span class="literal">nil</span> &amp;&amp; scope.meta.KeyNameMapping != <span class="literal">nil</span> &#123;</div><div class="line">		mapping = scope.meta.KeyNameMapping</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, key := <span class="keyword">range</span> lister.keys() &#123;</div><div class="line">		<span class="comment">//***key: A***//</span></div><div class="line">		<span class="keyword">if</span> found, err := c.checkField(key, skv, dkv, scope); found &#123;</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		stag := skv.tagOf(key)</div><div class="line">		dtag := dkv.tagOf(key)</div><div class="line">		skey := key</div><div class="line">		dkey := key</div><div class="line">		<span class="keyword">if</span> mapping != <span class="literal">nil</span> &#123;</div><div class="line">			skey, dkey = scope.meta.KeyNameMapping(key, stag, dtag)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		df := dkv.value(dkey)</div><div class="line">		sf := skv.value(skey)</div><div class="line">		<span class="keyword">if</span> !df.IsValid() || !sf.IsValid() &#123;</div><div class="line">			<span class="keyword">switch</span> &#123;</div><div class="line">			<span class="keyword">case</span> scope.flags.IsSet(IgnoreMissingFields):</div><div class="line">				<span class="comment">// No error.</span></div><div class="line">			<span class="keyword">case</span> scope.flags.IsSet(SourceToDest):</div><div class="line">				<span class="keyword">return</span> scope.errorf(<span class="string">"%v not present in dest"</span>, dkey)</div><div class="line">			<span class="keyword">default</span>:</div><div class="line">				<span class="keyword">return</span> scope.errorf(<span class="string">"%v not present in src"</span>, skey)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">//		type Foo struct &#123;</span></div><div class="line">		<span class="comment">//			A string `test:"foo"`</span></div><div class="line">		<span class="comment">//		&#125;</span></div><div class="line">		<span class="comment">//		type Bar struct &#123;</span></div><div class="line">		<span class="comment">//			A string `test:"bar"`</span></div><div class="line">		<span class="comment">//		&#125;</span></div><div class="line">		<span class="comment">//***skey: A  stag: test:"foo"  dkey: A  dtag: test:"bar"***//</span></div><div class="line">		<span class="comment">//***sf.Type(): string  df.Type(): string***//</span></div><div class="line">		scope.srcStack.top().key = skey</div><div class="line">		scope.srcStack.top().tag = stag</div><div class="line">		scope.destStack.top().key = dkey</div><div class="line">		scope.destStack.top().tag = dtag</div><div class="line">		<span class="keyword">if</span> err := c.convert(sf, df, scope); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="checkField"><a href="#checkField" class="headerlink" title="checkField()"></a>checkField()</h3><p>checkField()如果设置了DestFromSource flag，则使用先根据目标字段找到源字段的策略找到源字段，然后调用convert()进行转换。如果未设置DestFromSource flag，则使用根据源字段找到目标字段的策略进行转换。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">checkField</span><span class="params">(fieldName <span class="keyword">string</span>, skv, dkv kvValue, scope *scope)</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</div><div class="line">	replacementMade := <span class="literal">false</span></div><div class="line">	<span class="keyword">if</span> scope.flags.IsSet(DestFromSource) &#123;</div><div class="line">		df := dkv.value(fieldName)</div><div class="line">		<span class="keyword">if</span> !df.IsValid() &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		destKey := typeNamePair&#123;df.Type(), fieldName&#125;</div><div class="line">		<span class="comment">// Check each of the potential source (type, name) pairs to see if they're</span></div><div class="line">		<span class="comment">// present in sv.</span></div><div class="line">		<span class="keyword">for</span> _, potentialSourceKey := <span class="keyword">range</span> c.structFieldSources[destKey] &#123;</div><div class="line">			sf := skv.value(potentialSourceKey.fieldName)</div><div class="line">			<span class="keyword">if</span> !sf.IsValid() &#123;</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">//***找到df对应的sf***//</span></div><div class="line">			<span class="keyword">if</span> sf.Type() == potentialSourceKey.fieldType &#123;</div><div class="line">				<span class="comment">// Both the source's name and type matched, so copy.</span></div><div class="line">				scope.srcStack.top().key = potentialSourceKey.fieldName</div><div class="line">				scope.destStack.top().key = fieldName</div><div class="line">				<span class="comment">//***此处调用convert()***//</span></div><div class="line">				<span class="keyword">if</span> err := c.convert(sf, df, scope); err != <span class="literal">nil</span> &#123;</div><div class="line">					<span class="keyword">return</span> <span class="literal">true</span>, err</div><div class="line">				&#125;</div><div class="line">				dkv.confirmSet(fieldName, df)</div><div class="line">				replacementMade = <span class="literal">true</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> replacementMade, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sf := skv.value(fieldName)</div><div class="line">	<span class="keyword">if</span> !sf.IsValid() &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	srcKey := typeNamePair&#123;sf.Type(), fieldName&#125;</div><div class="line">	<span class="comment">// Check each of the potential dest (type, name) pairs to see if they're</span></div><div class="line">	<span class="comment">// present in dv.</span></div><div class="line">	<span class="keyword">for</span> _, potentialDestKey := <span class="keyword">range</span> c.structFieldDests[srcKey] &#123;</div><div class="line">		df := dkv.value(potentialDestKey.fieldName)</div><div class="line">		<span class="keyword">if</span> !df.IsValid() &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> df.Type() == potentialDestKey.fieldType &#123;</div><div class="line">			<span class="comment">// Both the dest's name and type matched, so copy.</span></div><div class="line">			scope.srcStack.top().key = fieldName</div><div class="line">			scope.destStack.top().key = potentialDestKey.fieldName</div><div class="line">			<span class="keyword">if</span> err := c.convert(sf, df, scope); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">true</span>, err</div><div class="line">			&#125;</div><div class="line">			dkv.confirmSet(potentialDestKey.fieldName, df)</div><div class="line">			replacementMade = <span class="literal">true</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> replacementMade, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>最后介绍两个Demo来说明Converter的用法。这两个Demo都取自源码的test文件。调用之前，请确保kubernetes及其依赖都在go的指定目录下。为了更清楚地描述转换过程，在源代码里添加了些打印信息。</p>
<h3 id="Demo1"><a href="#Demo1" class="headerlink" title="Demo1"></a>Demo1</h3><p>Demo1完成了两个复杂类之间的转换，还包含了struct tag的使用(字段信息存储在scope的srcStack和destStack中)。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"reflect"</span></div><div class="line"></div><div class="line">	<span class="string">"k8s.io/kubernetes/pkg/conversion"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> DefaultNameFunc = <span class="function"><span class="keyword">func</span><span class="params">(t reflect.Type)</span> <span class="title">string</span></span> &#123; <span class="keyword">return</span> t.Name() &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">type</span> T1 <span class="keyword">struct</span> &#123;</div><div class="line">		A <span class="keyword">string</span> <span class="string">`test:"foo"`</span></div><div class="line">		B <span class="keyword">string</span> <span class="string">`test1:"foo1"`</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">type</span> T2 <span class="keyword">struct</span> &#123;</div><div class="line">		A <span class="keyword">string</span> <span class="string">`test:"bar"`</span></div><div class="line">		B <span class="keyword">string</span> <span class="string">`test1:"bar1"`</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">type</span> A <span class="keyword">struct</span> &#123;</div><div class="line">		Foo <span class="keyword">string</span></div><div class="line">		Baz <span class="keyword">int</span></div><div class="line">		A   T1</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">type</span> B <span class="keyword">struct</span> &#123;</div><div class="line">		Bar <span class="keyword">string</span></div><div class="line">		Baz <span class="keyword">int</span></div><div class="line">		A   T2</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	c := conversion.NewConverter(DefaultNameFunc)</div><div class="line">	err := c.RegisterConversionFunc(</div><div class="line">		<span class="function"><span class="keyword">func</span><span class="params">(in *A, out *B, s conversion.Scope)</span> <span class="title">error</span></span> &#123;</div><div class="line">			out.Bar = in.Foo</div><div class="line">			s.Convert(&amp;in.Baz, &amp;out.Baz, <span class="number">0</span>)</div><div class="line">			s.Convert(&amp;in.A, &amp;out.A, conversion.AllowDifferentFieldTypeNames)</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Printf(<span class="string">"unexpected error %v"</span>, err)</div><div class="line">	&#125;</div><div class="line">	err = c.RegisterConversionFunc(</div><div class="line">		<span class="function"><span class="keyword">func</span><span class="params">(in *<span class="keyword">string</span>, out *<span class="keyword">string</span>, s conversion.Scope)</span> <span class="title">error</span></span> &#123;</div><div class="line">			<span class="comment">//***此处能获取struct tag***//</span></div><div class="line">			fmt.Println(<span class="string">"Get tag"</span>, s.SrcTag())</div><div class="line">			*out = *in</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;,</div><div class="line">	)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Printf(<span class="string">"Unexpected error: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	x := A&#123;<span class="string">"I am "</span>, <span class="number">3</span>, T1&#123;<span class="string">"years"</span>, <span class="string">"old"</span>&#125;&#125;</div><div class="line">	y := B&#123;&#125;</div><div class="line">	fmt.Println(x)</div><div class="line">	err = c.Convert(&amp;x, &amp;y, <span class="number">0</span>, <span class="literal">nil</span>)</div><div class="line">	fmt.Println(y)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;I am  <span class="number">3</span> &#123;years old&#125;&#125;    <span class="comment">//打印出x，类型为A</span></div><div class="line">Convert from *main.A to *main.B  <span class="comment">//打算从*main.A转换到*main.B</span></div><div class="line">use conversionFuncs main.A main.B    <span class="comment">//因为注册有func(in *A, out *B, s conversion.Scope) error，所以使用conversionFuncs进行转换</span></div><div class="line">Convert from *<span class="keyword">int</span> to *<span class="keyword">int</span>    <span class="comment">//执行s.Convert(&amp;in.Baz, &amp;out.Baz, 0)，准备从*int转换到*int</span></div><div class="line">In defaultConvert() <span class="keyword">int</span> <span class="keyword">int</span>   <span class="comment">//&#123;*int, *int&#125;转换使用defaultConvert()完成转换。</span></div><div class="line">Convert from *main.T1 to *main.T2  <span class="comment">//执行s.Convert(&amp;in.A, &amp;out.A, conversion.AllowDifferentFieldTypeNames)， 准备*main.T1转换到*main.T2</span></div><div class="line">In defaultConvert() main.T1 main.T2  <span class="comment">//在进行&#123;*main.T1, main.T2&#125;转换，未定义转换函数，所以使用defaultConvert()，因为是struct，所以defaultConvert()中使用convertKV()进行转换</span></div><div class="line">In convertKV() <span class="keyword">string</span> <span class="keyword">string</span>   <span class="comment">//转换T1和T2的第一个字段</span></div><div class="line">use conversionFuncs <span class="keyword">string</span> <span class="keyword">string</span>    <span class="comment">//&#123;string, string&#125;的转换函数已经注册，所以使用conversionFuncs进行转换</span></div><div class="line">Get tag test:<span class="string">"foo"</span></div><div class="line">In convertKV() <span class="keyword">string</span> <span class="keyword">string</span> <span class="comment">//转换T1和T2的第二个字段，&#123;string, string&#125;的转换函数已经注册，所以使用conversionFuncs进行转换</span></div><div class="line">use conversionFuncs <span class="keyword">string</span> <span class="keyword">string</span>    <span class="comment">//&#123;string, string&#125;的转换函数已经注册，所以使用conversionFuncs进行转换 </span></div><div class="line">Get tag test1:<span class="string">"foo1"</span></div><div class="line">&#123;I am  <span class="number">3</span> &#123;years old&#125;&#125; <span class="comment">//转换完成，打印y</span></div></pre></td></tr></table></figure></p>
<h3 id="Demo2"><a href="#Demo2" class="headerlink" title="Demo2"></a>Demo2</h3><p>Demo2说明了预定义字段映射关系的用法。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"reflect"</span></div><div class="line"></div><div class="line">	<span class="string">"k8s.io/kubernetes/pkg/conversion"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> DefaultNameFunc = <span class="function"><span class="keyword">func</span><span class="params">(t reflect.Type)</span> <span class="title">string</span></span> &#123; <span class="keyword">return</span> t.Name() &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">type</span> WeirdMeta <span class="keyword">struct</span> &#123;</div><div class="line">		Name <span class="keyword">string</span></div><div class="line">		Type <span class="keyword">string</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">type</span> NameMeta <span class="keyword">struct</span> &#123;</div><div class="line">		Name <span class="keyword">string</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">type</span> TypeMeta <span class="keyword">struct</span> &#123;</div><div class="line">		Type <span class="keyword">string</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">type</span> A <span class="keyword">struct</span> &#123;</div><div class="line">		WeirdMeta</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">type</span> B <span class="keyword">struct</span> &#123;</div><div class="line">		TypeMeta</div><div class="line">		NameMeta</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	c := conversion.NewConverter(DefaultNameFunc)</div><div class="line">	err := c.SetStructFieldCopy(WeirdMeta&#123;&#125;, <span class="string">"WeirdMeta"</span>, TypeMeta&#123;&#125;, <span class="string">"TypeMeta"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Printf(<span class="string">"unexpected error %v"</span>, err)</div><div class="line">	&#125;</div><div class="line">	err = c.SetStructFieldCopy(WeirdMeta&#123;&#125;, <span class="string">"WeirdMeta"</span>, NameMeta&#123;&#125;, <span class="string">"NameMeta"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Printf(<span class="string">"unexpected error %v"</span>, err)</div><div class="line">	&#125;</div><div class="line">	err = c.SetStructFieldCopy(TypeMeta&#123;&#125;, <span class="string">"TypeMeta"</span>, WeirdMeta&#123;&#125;, <span class="string">"WeirdMeta"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Printf(<span class="string">"unexpected error %v"</span>, err)</div><div class="line">	&#125;</div><div class="line">	err = c.SetStructFieldCopy(NameMeta&#123;&#125;, <span class="string">"NameMeta"</span>, WeirdMeta&#123;&#125;, <span class="string">"WeirdMeta"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Printf(<span class="string">"unexpected error %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	aVal := &amp;A&#123;</div><div class="line">		WeirdMeta: WeirdMeta&#123;</div><div class="line">			Name: <span class="string">"Foo"</span>,</div><div class="line">			Type: <span class="string">"Bar"</span>,</div><div class="line">		&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	bVal := &amp;B&#123;</div><div class="line">		TypeMeta: TypeMeta&#123;<span class="string">"Bar"</span>&#125;,</div><div class="line">		NameMeta: NameMeta&#123;<span class="string">"Foo"</span>&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	fmt.Println(aVal)</div><div class="line">	err = c.Convert(aVal, bVal, conversion.AllowDifferentFieldTypeNames, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(err)</div><div class="line">	&#125;</div><div class="line">	fmt.Println(bVal)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&amp;&#123;&#123;Foo Bar&#125;&#125;             //打印aVal     </div><div class="line">Convert from *main.A to *main.B   //准备从*main.A转换到*main.B</div><div class="line">In defaultConvert() main.A main.B    //因为没有注册&#123;*main.A, *main.B&#125;的转换函数，所以默认使用defaultConvert()</div><div class="line">In checkField() convert from main.WeirdMeta to main.TypeMeta   //因为注册有字段对应关系，所以使用checkField()，默认使用是的从目标字段查找源字段。准备从*main.WeirdMeta转换到*main.TypeMeta。</div><div class="line">In defaultConvert() main.WeirdMeta main.TypeMeta  //因为没有注册&#123;*main.WeirdMeta, *main.TypeMeta&#125;的转换函数，所以使用defaultConvert()</div><div class="line">In convertKV() string string //因为是结构体，所以将调用convertKV()，找到同名的字段，开始转换</div><div class="line">In defaultConvert() string string  //因为没有注册&#123;*string, *string&#125;的转换函数，所以使用defaultConvert()完成转换</div><div class="line">In checkField() convert from main.WeirdMeta to main.NameMeta //目标结构体的第二个字段，准备从*main.WeirdMeta转换到*main.NameMeta</div><div class="line">In defaultConvert() main.WeirdMeta main.NameMeta //因为没有注册&#123;*main.WeirdMeta, *main.NameMeta&#125;的转换函数，所以使用defaultConvert()</div><div class="line">In convertKV() string string    //因为是结构体，所以将调用convertKV()，找到同名的字段，开始转换</div><div class="line">In defaultConvert() string string  //因为没有注册&#123;*string, *string&#125;的转换函数，所以使用defaultConvert()完成转换</div><div class="line">&amp;&#123;&#123;Bar&#125; &#123;Foo&#125;&#125; //转换完成，打印bVal</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Converter先使用genericConversionFunc进行转换，如果不成功，再使用conversionFunc进行转换，如果不成功，再按generatedConversionFunc进行转换，如果不成功，最后交由DefaultConvert()转换。</p>
<p>DefaultConvert()中如果转换类型是简单类型，则直接转换；如果是结构体，则先看是否有字段关系定义，如果有，则按map定义的来，否则按同名转换原则进行转换；其他的类型也有相应的方法进行转换。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/29/Scheme机制解读(二)-Converter-v1-5-2/" data-id="cj5ule85x0012ecqstlrz2yss" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Scheme机制解读(一)-Scheme-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/27/Scheme机制解读(一)-Scheme-v1-5-2/" class="article-date">
  <time datetime="2017-07-27T04:43:39.000Z" itemprop="datePublished">2017-07-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/27/Scheme机制解读(一)-Scheme-v1-5-2/">Scheme机制解读(一)-Scheme-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是Scheme"><a href="#什么是Scheme" class="headerlink" title="什么是Scheme"></a>什么是Scheme</h2><p>如果说RESTMapper管理的是GVR和GVK的关系，那么Scheme管理的就是GVK和Type的关系。系统中所有的Type都要注册到Scheme中，当然目前系统只有一个Scheme，即api.Scheme，定义在/pkg/api/register.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***定义Scheme***//</span></div><div class="line"><span class="keyword">var</span> Scheme = runtime.NewScheme()</div></pre></td></tr></table></figure></p>
<p>我们先来看下Scheme结构体的定义，Scheme结构体定义在/pkg/runtime/scheme.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Scheme <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// versionMap allows one to figure out the go type of an object with</span></div><div class="line">	<span class="comment">// the given version and name.</span></div><div class="line">	gvkToType <span class="keyword">map</span>[unversioned.GroupVersionKind]reflect.Type</div><div class="line"></div><div class="line">	<span class="comment">// typeToGroupVersion allows one to find metadata for a given go object.</span></div><div class="line">	<span class="comment">// The reflect.Type we index by should *not* be a pointer.</span></div><div class="line">	<span class="comment">//***kind, gvk:  v1.ListOptions authorization.k8s.io/v1beta1, Kind=ListOptions***//</span></div><div class="line">	<span class="comment">//***kind, gvk:  v1.ListOptions apps/v1beta1, Kind=ListOptions***//</span></div><div class="line">	typeToGVK <span class="keyword">map</span>[reflect.Type][]unversioned.GroupVersionKind</div><div class="line"></div><div class="line">	<span class="comment">// unversionedTypes are transformed without conversion in ConvertToVersion.</span></div><div class="line">	unversionedTypes <span class="keyword">map</span>[reflect.Type]unversioned.GroupVersionKind</div><div class="line"></div><div class="line">	<span class="comment">// unversionedKinds are the names of kinds that can be created in the context of any group</span></div><div class="line">	<span class="comment">// or version</span></div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> resolve the status of unversioned types.</span></div><div class="line">	unversionedKinds <span class="keyword">map</span>[<span class="keyword">string</span>]reflect.Type</div><div class="line"></div><div class="line">	<span class="comment">// Map from version and resource to the corresponding func to convert</span></div><div class="line">	<span class="comment">// resource field labels in that version to internal version.</span></div><div class="line">	<span class="comment">//***field selector转换函数***//</span></div><div class="line">	fieldLabelConversionFuncs <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">string</span>]FieldLabelConversionFunc</div><div class="line"></div><div class="line">	<span class="comment">// defaulterFuncs is an array of interfaces to be called with an object to provide defaulting</span></div><div class="line">	<span class="comment">// the provided object must be a pointer.</span></div><div class="line">	<span class="comment">//***默认值设置函数***//</span></div><div class="line">	defaulterFuncs <span class="keyword">map</span>[reflect.Type]<span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span></span></div><div class="line"></div><div class="line">	// <span class="title">converter</span> <span class="title">stores</span> <span class="title">all</span> <span class="title">registered</span> <span class="title">conversion</span> <span class="title">functions</span>. <span class="title">It</span> <span class="title">also</span> <span class="title">has</span></div><div class="line">	// <span class="title">default</span> <span class="title">coverting</span> <span class="title">behavior</span>.</div><div class="line">	//***聚合<span class="title">converter</span>结构体***//</div><div class="line">	<span class="title">converter</span> *<span class="title">conversion</span>.<span class="title">Converter</span></div><div class="line"></div><div class="line">	// <span class="title">cloner</span> <span class="title">stores</span> <span class="title">all</span> <span class="title">registered</span> <span class="title">copy</span> <span class="title">functions</span>. <span class="title">It</span> <span class="title">also</span> <span class="title">has</span> <span class="title">default</span></div><div class="line">	// <span class="title">deep</span> <span class="title">copy</span> <span class="title">behavior</span>.</div><div class="line">	//***<span class="title">Fankang</span>***//</div><div class="line">	//***聚合<span class="title">cloner</span>结构体***//</div><div class="line">	<span class="title">cloner</span> *<span class="title">conversion</span>.<span class="title">Cloner</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，Scheme除了管理GVK和Type的关系，还管理有默认设置函数，并聚合了converter及cloner。我们来详细看下每个字段的含义：</p>
<ul>
<li>gvkToType: 存储gvk和Type的关系，一个gvk只能对应一个Type；</li>
<li>typeToGVK：存储Type和gvk的关系，一个type可能对应多个GVK；</li>
<li>unversionedTypes：记录unversioned的Type和GVK的关系，unversioned无需版本转换；</li>
<li>unversionedKinds：记录unversioned的GVK和Type的关系；</li>
<li>fieldLabelConversionFuncs：管理field selector的转换，如旧版本v1的spec.host需要转换成spec.nodeName(详见在/pkg/api/v1/conversion.go中的addConversionFuncs()函数)；</li>
<li>defaulterFuncs：存储Type及其对应的默认值设置函数；</li>
<li>converter：用来转换不同版本的结构体值；</li>
<li>cloner：用来获取结构体值的拷贝。</li>
</ul>
<p>Kubernetes内部组件的流通的结构体值使用的是内部版本，所有的外部版本都要向内部版本进行转换；内部版本必须转换成外部版本才能进行输出。外部版本之间不能直接转换。</p>
<p>从Scheme的定义可以看出，Scheme是个converter，也是个cloner，关于converter和cloner，后续分析。</p>
<h2 id="NewScheme"><a href="#NewScheme" class="headerlink" title="NewScheme()"></a>NewScheme()</h2><p>NewScheme()可以生成一个新的Scheme，其中cloner调用conversion.NewCloner()初始化，conversion.NewConverter()初始化。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewScheme creates a new Scheme. This scheme is pluggable by default.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewScheme</span><span class="params">()</span> *<span class="title">Scheme</span></span> &#123;</div><div class="line">	s := &amp;Scheme&#123;</div><div class="line">		gvkToType:        <span class="keyword">map</span>[unversioned.GroupVersionKind]reflect.Type&#123;&#125;,</div><div class="line">		typeToGVK:        <span class="keyword">map</span>[reflect.Type][]unversioned.GroupVersionKind&#123;&#125;,</div><div class="line">		unversionedTypes: <span class="keyword">map</span>[reflect.Type]unversioned.GroupVersionKind&#123;&#125;,</div><div class="line">		unversionedKinds: <span class="keyword">map</span>[<span class="keyword">string</span>]reflect.Type&#123;&#125;,</div><div class="line">		cloner:           conversion.NewCloner(),</div><div class="line">		fieldLabelConversionFuncs: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">string</span>]FieldLabelConversionFunc&#123;&#125;,</div><div class="line">		defaulterFuncs:            <span class="keyword">map</span>[reflect.Type]<span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span></span>&#123;&#125;,</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***converter使用的是nameFunc***//</span></div><div class="line">	s.converter = conversion.NewConverter(s.nameFunc)</div><div class="line"></div><div class="line">	s.AddConversionFuncs(DefaultEmbeddedConversions()...)</div><div class="line"></div><div class="line">	<span class="comment">// Enable map[string][]string conversions by default</span></div><div class="line">	<span class="keyword">if</span> err := s.AddConversionFuncs(DefaultStringConversions...); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := s.RegisterInputDefaults(&amp;<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>&#123;&#125;, JSONKeyMapper, conversion.AllowDifferentFieldTypeNames|conversion.IgnoreMissingFields); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := s.RegisterInputDefaults(&amp;url.Values&#123;&#125;, JSONKeyMapper, conversion.AllowDifferentFieldTypeNames|conversion.IgnoreMissingFields); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> s</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddUnversionedTypes"><a href="#AddUnversionedTypes" class="headerlink" title="AddUnversionedTypes()"></a>AddUnversionedTypes()</h2><p>AddUnversionedTypes()方法可以向Scheme注册unvertioned type，方法先调用AddKnownTypes()，然后填充unversionedTypes和unversionedKinds两个map，在/api/register.go中有调用。Unversioned type不需要进行转换。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddUnversionedTypes</span><span class="params">(version unversioned.GroupVersion, types ...Object)</span></span> &#123;</div><div class="line">	s.AddKnownTypes(version, types...)</div><div class="line">	<span class="keyword">for</span> _, obj := <span class="keyword">range</span> types &#123;</div><div class="line">		t := reflect.TypeOf(obj).Elem()</div><div class="line">		gvk := version.WithKind(t.Name())</div><div class="line">		s.unversionedTypes[t] = gvk</div><div class="line">		<span class="keyword">if</span> _, ok := s.unversionedKinds[gvk.Kind]; ok &#123;</div><div class="line">			<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"%v has already been registered as unversioned kind %q - kind name must be unique"</span>, reflect.TypeOf(t), gvk.Kind))</div><div class="line">		&#125;</div><div class="line">		s.unversionedKinds[gvk.Kind] = t</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddKnownTypes"><a href="#AddKnownTypes" class="headerlink" title="AddKnownTypes()"></a>AddKnownTypes()</h2><p>AddKnownTypes()为Scheme的type注册函数，参数为GV及types，其中types和GV先组成GVK，然后向gvkToType和typeToGVK填充Type和GVK的关系。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***把types在Scheme中注册***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddKnownTypes</span><span class="params">(gv unversioned.GroupVersion, types ...Object)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(gv.Version) == <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"version is required on all types: %s %v"</span>, gv, types[<span class="number">0</span>]))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> _, obj := <span class="keyword">range</span> types &#123;</div><div class="line">		t := reflect.TypeOf(obj)</div><div class="line">		<span class="keyword">if</span> t.Kind() != reflect.Ptr &#123;</div><div class="line">			<span class="built_in">panic</span>(<span class="string">"All types must be pointers to structs."</span>)</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***Elem()能对指针进行解引用***//</span></div><div class="line">		t = t.Elem()</div><div class="line">		<span class="keyword">if</span> t.Kind() != reflect.Struct &#123;</div><div class="line">			<span class="built_in">panic</span>(<span class="string">"All types must be pointers to structs."</span>)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		gvk := gv.WithKind(t.Name())</div><div class="line">		<span class="comment">//***一个GVK只能对应一个type***//</span></div><div class="line">		s.gvkToType[gvk] = t</div><div class="line">		<span class="comment">//***t, gvk:  v1.Event /v1, Kind=Event***//</span></div><div class="line">		<span class="comment">//***同一个type，可能对应多个gvk***//</span></div><div class="line">		s.typeToGVK[t] = <span class="built_in">append</span>(s.typeToGVK[t], gvk)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddKnownTypeWithName"><a href="#AddKnownTypeWithName" class="headerlink" title="AddKnownTypeWithName()"></a>AddKnownTypeWithName()</h2><p>AddKnownTypeWithName()可以指定object对应的gvk。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***可以指定obj的kind，而不用像AddKnownTypes()去反射获取type的name作为kind***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddKnownTypeWithName</span><span class="params">(gvk unversioned.GroupVersionKind, obj Object)</span></span> &#123;</div><div class="line">	t := reflect.TypeOf(obj)</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(gvk.Version) == <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"version is required on all types: %s %v"</span>, gvk, t))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> t.Kind() != reflect.Ptr &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"All types must be pointers to structs."</span>)</div><div class="line">	&#125;</div><div class="line">	t = t.Elem()</div><div class="line">	<span class="keyword">if</span> t.Kind() != reflect.Struct &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"All types must be pointers to structs."</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	s.gvkToType[gvk] = t</div><div class="line">	s.typeToGVK[t] = <span class="built_in">append</span>(s.typeToGVK[t], gvk)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="KnownTypes"><a href="#KnownTypes" class="headerlink" title="KnownTypes()"></a>KnownTypes()</h2><p>KnownTypes()返回Scheme中具体版本下的gvk和type的map关系。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***通过gv在scheme中找到所有合适的types***//</span></div><div class="line"><span class="comment">//***具体gv下的kind唯一***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">KnownTypes</span><span class="params">(gv unversioned.GroupVersion)</span> <span class="title">map</span>[<span class="title">string</span>]<span class="title">reflect</span>.<span class="title">Type</span></span> &#123;</div><div class="line">	types := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]reflect.Type)</div><div class="line">	<span class="keyword">for</span> gvk, t := <span class="keyword">range</span> s.gvkToType &#123;</div><div class="line">		<span class="keyword">if</span> gv != gvk.GroupVersion() &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		types[gvk.Kind] = t</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> types</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AllKnownTypes"><a href="#AllKnownTypes" class="headerlink" title="AllKnownTypes()"></a>AllKnownTypes()</h2><p>AllKnownTypes()返回Scheme中所有版本的gvk和type的map关系。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***返回gvkToType***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AllKnownTypes</span><span class="params">()</span> <span class="title">map</span>[<span class="title">unversioned</span>.<span class="title">GroupVersionKind</span>]<span class="title">reflect</span>.<span class="title">Type</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> s.gvkToType</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ObjectKind-ObjectKinds"><a href="#ObjectKind-ObjectKinds" class="headerlink" title="ObjectKind() ObjectKinds()"></a>ObjectKind() ObjectKinds()</h2><p>ObjectKinds()通过obj的type获取对应的GVK(可能存在多个GVK)；ObjectKind()则在ObjectKinds()的基础上返回第一个GVk。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取obj的gvk***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">ObjectKind</span><span class="params">(obj Object)</span> <span class="params">(unversioned.GroupVersionKind, <span class="keyword">bool</span>, error)</span></span> &#123;</div><div class="line">	gvks, unversionedType, err := s.ObjectKinds(obj)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> unversioned.GroupVersionKind&#123;&#125;, <span class="literal">false</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> gvks[<span class="number">0</span>], unversionedType, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***通过obj的类型获取所有的gvk***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">ObjectKinds</span><span class="params">(obj Object)</span> <span class="params">([]unversioned.GroupVersionKind, <span class="keyword">bool</span>, error)</span></span> &#123;</div><div class="line">	v, err := conversion.EnforcePtr(obj)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, err</div><div class="line">	&#125;</div><div class="line">	t := v.Type()</div><div class="line"></div><div class="line">	<span class="comment">//***从typeToGVK中获取gvks***//</span></div><div class="line">	gvks, ok := s.typeToGVK[t]</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, NewNotRegisteredErr(unversioned.GroupVersionKind&#123;&#125;, t)</div><div class="line">	&#125;</div><div class="line">	_, unversionedType := s.unversionedTypes[t]</div><div class="line"></div><div class="line">	<span class="keyword">return</span> gvks, unversionedType, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Recognizes"><a href="#Recognizes" class="headerlink" title="Recognizes()"></a>Recognizes()</h2><p>Recognizes()判断GVK在Scheme中是否有注册。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">Recognizes</span><span class="params">(gvk unversioned.GroupVersionKind)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	_, exists := s.gvkToType[gvk]</div><div class="line">	<span class="keyword">return</span> exists</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="IsUnversioned"><a href="#IsUnversioned" class="headerlink" title="IsUnversioned()"></a>IsUnversioned()</h2><p>IsUnversioned()判断obj是否属于unversioned。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***判断obj是否是属于unversioned***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">IsUnversioned</span><span class="params">(obj Object)</span> <span class="params">(<span class="keyword">bool</span>, <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	v, err := conversion.EnforcePtr(obj)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line">	t := v.Type()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> _, ok := s.typeToGVK[t]; !ok &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line">	_, ok := s.unversionedTypes[t]</div><div class="line">	<span class="keyword">return</span> ok, <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="New"><a href="#New" class="headerlink" title="New()"></a>New()</h2><p>New()可以创建一个gvk类型的结构体值。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***新建一个符合gvk的具体object***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">New</span><span class="params">(kind unversioned.GroupVersionKind)</span> <span class="params">(Object, error)</span></span> &#123;</div><div class="line">	<span class="comment">//***versioned的情况***//</span></div><div class="line">	<span class="keyword">if</span> t, exists := s.gvkToType[kind]; exists &#123;</div><div class="line">		<span class="comment">//***通过reflect.New(t).Interface().(Object)来生成新的object***//</span></div><div class="line">		<span class="keyword">return</span> reflect.New(t).Interface().(Object), <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***unversioned的情况***//</span></div><div class="line">	<span class="keyword">if</span> t, exists := s.unversionedKinds[kind.Kind]; exists &#123;</div><div class="line">		<span class="keyword">return</span> reflect.New(t).Interface().(Object), <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, NewNotRegisteredErr(kind, <span class="literal">nil</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddGenericConversionFunc"><a href="#AddGenericConversionFunc" class="headerlink" title="AddGenericConversionFunc()"></a>AddGenericConversionFunc()</h2><p>AddGenericConversionFunc()是对converter的AddGenericConversionFunc()方法的封装，关于converter将在以后分析。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***GenericConversionFunc可以理解为转换的快速通道***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddGenericConversionFunc</span><span class="params">(fn conversion.GenericConversionFunc)</span></span> &#123;</div><div class="line">	<span class="comment">//***调用converter的addGenericConversionFunc()***//</span></div><div class="line">	s.converter.AddGenericConversionFunc(fn)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddIgnoredConversionType"><a href="#AddIgnoredConversionType" class="headerlink" title="AddIgnoredConversionType()"></a>AddIgnoredConversionType()</h2><p>AddIgnoredConversionType()是对converter的RegisterIgnoredConversion()方法的封闭，关于converter将在以后分析。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddIgnoredConversionType</span><span class="params">(from, to <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***需要忽略的类型转换***//</span></div><div class="line">	<span class="keyword">return</span> s.converter.RegisterIgnoredConversion(from, to)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddConversionFuncs"><a href="#AddConversionFuncs" class="headerlink" title="AddConversionFuncs()"></a>AddConversionFuncs()</h2><p>AddConversionFuncs()可以向converter注册转换函数，关于converter将在以后分析。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***向converter注册conversion函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddConversionFuncs</span><span class="params">(conversionFuncs ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, f := <span class="keyword">range</span> conversionFuncs &#123;</div><div class="line">		<span class="comment">//***调用converter的RegisterConversionFunc()函数***//</span></div><div class="line">		<span class="keyword">if</span> err := s.converter.RegisterConversionFunc(f); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddGeneratedConversionFuncs"><a href="#AddGeneratedConversionFuncs" class="headerlink" title="AddGeneratedConversionFuncs()"></a>AddGeneratedConversionFuncs()</h2><p>AddGeneratedConversionFuncs()可以向converter注册GeneratedConversionFuncs，其中GeneratedConversionFuncs为自动生成的转换函数，关于converter将在以后分析。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***向converter注册generatedConversion函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddGeneratedConversionFuncs</span><span class="params">(conversionFuncs ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, f := <span class="keyword">range</span> conversionFuncs &#123;</div><div class="line">		<span class="keyword">if</span> err := s.converter.RegisterGeneratedConversionFunc(f); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddDeepCopyFuncs"><a href="#AddDeepCopyFuncs" class="headerlink" title="AddDeepCopyFuncs()"></a>AddDeepCopyFuncs()</h2><p>AddDeepCopyFuncs()可以向cloner注册克隆函数，关于cloner将在以后分析。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***向cloner注册deepCopy函数***//</span></div><div class="line"><span class="comment">//***系统中未找到调用***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddDeepCopyFuncs</span><span class="params">(deepCopyFuncs ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, f := <span class="keyword">range</span> deepCopyFuncs &#123;</div><div class="line">		<span class="keyword">if</span> err := s.cloner.RegisterDeepCopyFunc(f); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddGeneratedDeepCopyFuncs"><a href="#AddGeneratedDeepCopyFuncs" class="headerlink" title="AddGeneratedDeepCopyFuncs()"></a>AddGeneratedDeepCopyFuncs()</h2><p>AddGeneratedDeepCopyFuncs()可以向cloner注册GeneratedDeepCopyFuncs，其中GeneratedDeepCopyFuncs为自动生成的克隆函数，关于cloner将在以后分析。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***向cloner注册generatedDeepCopy函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddGeneratedDeepCopyFuncs</span><span class="params">(deepCopyFuncs ...conversion.GeneratedDeepCopyFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, fn := <span class="keyword">range</span> deepCopyFuncs &#123;</div><div class="line">		<span class="keyword">if</span> err := s.cloner.RegisterGeneratedDeepCopyFunc(fn); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddFieldLabelConversionFunc"><a href="#AddFieldLabelConversionFunc" class="headerlink" title="AddFieldLabelConversionFunc()"></a>AddFieldLabelConversionFunc()</h2><p>AddFieldLabelConversionFunc()可以向Scheme注册field selector转换函数。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***字段转换函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddFieldLabelConversionFunc</span><span class="params">(version, kind <span class="keyword">string</span>, conversionFunc FieldLabelConversionFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> s.fieldLabelConversionFuncs[version] == <span class="literal">nil</span> &#123;</div><div class="line">		s.fieldLabelConversionFuncs[version] = <span class="keyword">map</span>[<span class="keyword">string</span>]FieldLabelConversionFunc&#123;&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	s.fieldLabelConversionFuncs[version][kind] = conversionFunc</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddStructFieldConversion"><a href="#AddStructFieldConversion" class="headerlink" title="AddStructFieldConversion()"></a>AddStructFieldConversion()</h2><p>AddStructFieldConversion()可以向converter注册struct字段转换函数，关于cloner将在以后分析。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***struct成员转换函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddStructFieldConversion</span><span class="params">(srcFieldType <span class="keyword">interface</span>&#123;&#125;, srcFieldName <span class="keyword">string</span>, destFieldType <span class="keyword">interface</span>&#123;&#125;, destFieldName <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> s.converter.SetStructFieldCopy(srcFieldType, srcFieldName, destFieldType, destFieldName)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="RegisterInputDefaults"><a href="#RegisterInputDefaults" class="headerlink" title="RegisterInputDefaults()"></a>RegisterInputDefaults()</h2><p>RegisterInputDefaults()可以向convertor注册转换发生缺省时默认的处理方式函数。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">RegisterInputDefaults</span><span class="params">(in <span class="keyword">interface</span>&#123;&#125;, fn conversion.FieldMappingFunc, defaultFlags conversion.FieldMatchingFlags)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> s.converter.RegisterInputDefaults(in, fn, defaultFlags)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddDefaultingFuncs"><a href="#AddDefaultingFuncs" class="headerlink" title="AddDefaultingFuncs()"></a>AddDefaultingFuncs()</h2><p>AddDefaultingFuncs()可以向converter注册DefaultingFunc函数，DefaultingFunc函数可以设置相关结构体值的默认值。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***添加设置默认值函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddDefaultingFuncs</span><span class="params">(defaultingFuncs ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, f := <span class="keyword">range</span> defaultingFuncs &#123;</div><div class="line">		err := s.converter.RegisterDefaultingFunc(f)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Default"><a href="#Default" class="headerlink" title="Default()"></a>Default()</h2><p>Default()可以对object设置默认值。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置src默认值***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">Default</span><span class="params">(src Object)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> fn, ok := s.defaulterFuncs[reflect.TypeOf(src)]; ok &#123;</div><div class="line">		fn(src)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Copy"><a href="#Copy" class="headerlink" title="Copy()"></a>Copy()</h2><p>Copy()是对cloner.DeepCopy()的封装，可以拷贝一个object。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***深度拷贝src***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">Copy</span><span class="params">(src Object)</span> <span class="params">(Object, error)</span></span> &#123;</div><div class="line">	dst, err := s.DeepCopy(src)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> dst.(Object), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Performs a deep copy of the given object.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">DeepCopy</span><span class="params">(src <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> s.cloner.DeepCopy(src)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Convert"><a href="#Convert" class="headerlink" title="Convert()"></a>Convert()</h2><p>Convert()是对converter.Convert()的封装。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***转换函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">Convert</span><span class="params">(in, out <span class="keyword">interface</span>&#123;&#125;, context <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	flags, meta := s.generateConvertMeta(in)</div><div class="line">	meta.Context = context</div><div class="line">	<span class="keyword">if</span> flags == <span class="number">0</span> &#123;</div><div class="line">		flags = conversion.AllowDifferentFieldTypeNames</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> s.converter.Convert(in, out, flags, meta)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ConvertFieldLabel"><a href="#ConvertFieldLabel" class="headerlink" title="ConvertFieldLabel()"></a>ConvertFieldLabel()</h2><p>ConvertFieldLabel()可以对field selector进行转换。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***转换field selector标签***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">ConvertFieldLabel</span><span class="params">(version, kind, label, value <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, <span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> s.fieldLabelConversionFuncs[version] == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, <span class="string">""</span>, fmt.Errorf(<span class="string">"No field label conversion function found for version: %s"</span>, version)</div><div class="line">	&#125;</div><div class="line">	conversionFunc, ok := s.fieldLabelConversionFuncs[version][kind]</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, <span class="string">""</span>, fmt.Errorf(<span class="string">"No field label conversion function found for version %s and kind %s"</span>, version, kind)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> conversionFunc(label, value)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ConvertToVersion"><a href="#ConvertToVersion" class="headerlink" title="ConvertToVersion()"></a>ConvertToVersion()</h2><p>ConvertToVersion()可以把in转换成合适的版本。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">ConvertToVersion</span><span class="params">(in Object, target GroupVersioner)</span> <span class="params">(Object, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> s.convertToVersion(<span class="literal">true</span>, in, target)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">convertToVersion</span><span class="params">(<span class="built_in">copy</span> <span class="keyword">bool</span>, in Object, target GroupVersioner)</span> <span class="params">(Object, error)</span></span> &#123;</div><div class="line">	<span class="comment">// determine the incoming kinds with as few allocations as possible.</span></div><div class="line">	t := reflect.TypeOf(in)</div><div class="line">	<span class="keyword">if</span> t.Kind() != reflect.Ptr &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"only pointer types may be converted: %v"</span>, t)</div><div class="line">	&#125;</div><div class="line">	t = t.Elem()</div><div class="line">	<span class="keyword">if</span> t.Kind() != reflect.Struct &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"only pointers to struct types may be converted: %v"</span>, t)</div><div class="line">	&#125;</div><div class="line">	kinds, ok := s.typeToGVK[t]</div><div class="line">	<span class="keyword">if</span> !ok || <span class="built_in">len</span>(kinds) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, NewNotRegisteredErr(unversioned.GroupVersionKind&#123;&#125;, t)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***从多个gvk中选择出符合target的要求的gvk***//</span></div><div class="line">	gvk, ok := target.KindForGroupVersionKinds(kinds)</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="comment">// try to see if this type is listed as unversioned (for legacy support)</span></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> when we move to server API versions, we should completely remove the unversioned concept</span></div><div class="line">		<span class="keyword">if</span> unversionedKind, ok := s.unversionedTypes[t]; ok &#123;</div><div class="line">			<span class="keyword">if</span> gvk, ok := target.KindForGroupVersionKinds([]unversioned.GroupVersionKind&#123;unversionedKind&#125;); ok &#123;</div><div class="line">				<span class="keyword">return</span> copyAndSetTargetKind(<span class="built_in">copy</span>, s, in, gvk)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> copyAndSetTargetKind(<span class="built_in">copy</span>, s, in, unversionedKind)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> should this be a typed error?</span></div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"%v is not suitable for converting to %q"</span>, t, target)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// target wants to use the existing type, set kind and return (no conversion necessary)</span></div><div class="line">	<span class="keyword">for</span> _, kind := <span class="keyword">range</span> kinds &#123;</div><div class="line">		<span class="keyword">if</span> gvk == kind &#123;</div><div class="line">			<span class="keyword">return</span> copyAndSetTargetKind(<span class="built_in">copy</span>, s, in, gvk)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// type is unversioned, no conversion necessary</span></div><div class="line">	<span class="keyword">if</span> unversionedKind, ok := s.unversionedTypes[t]; ok &#123;</div><div class="line">		<span class="keyword">if</span> gvk, ok := target.KindForGroupVersionKinds([]unversioned.GroupVersionKind&#123;unversionedKind&#125;); ok &#123;</div><div class="line">			<span class="keyword">return</span> copyAndSetTargetKind(<span class="built_in">copy</span>, s, in, gvk)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> copyAndSetTargetKind(<span class="built_in">copy</span>, s, in, unversionedKind)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	out, err := s.New(gvk)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">copy</span> &#123;</div><div class="line">		copied, err := s.Copy(in)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">		in = copied</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	flags, meta := s.generateConvertMeta(in)</div><div class="line">	meta.Context = target</div><div class="line">	<span class="keyword">if</span> err := s.converter.Convert(in, out, flags, meta); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	setTargetKind(out, gvk)</div><div class="line">	<span class="keyword">return</span> out, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/27/Scheme机制解读(一)-Scheme-v1-5-2/" data-id="cj5ule85k000vecqs9hf4qnd4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-RESTMapper解读(三)-其他RESTMapper-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/24/RESTMapper解读(三)-其他RESTMapper-v1-5-2/" class="article-date">
  <time datetime="2017-07-24T04:52:55.000Z" itemprop="datePublished">2017-07-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/24/RESTMapper解读(三)-其他RESTMapper-v1-5-2/">RESTMapper解读(三)-其他RESTMapper-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="其他RESTMapper"><a href="#其他RESTMapper" class="headerlink" title="其他RESTMapper"></a>其他RESTMapper</h2><p>之前的两次关于RESTMapper的分析都是和DefaultRESTMapper相关的。除了DefaultRESTMapper以外，Kubernetes还实现了PriorityRESTMapper，MuiltiRESTMaper和FirstHitRESTMapper。本次分析就来看下这些RESTMapper的实现。</p>
<h2 id="PriorityRESTMapper"><a href="#PriorityRESTMapper" class="headerlink" title="PriorityRESTMapper"></a>PriorityRESTMapper</h2><p>PriorityRESTMapper定义在/pkg/api/meta/priority.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// PriorityRESTMapper is a wrapper for automatically choosing a particular Resource or Kind</span></div><div class="line"><span class="comment">// when multiple matches are possible</span></div><div class="line"><span class="keyword">type</span> PriorityRESTMapper <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// Delegate is the RESTMapper to use to locate all the Kind and Resource matches</span></div><div class="line">	Delegate RESTMapper</div><div class="line"></div><div class="line">	<span class="comment">// ResourcePriority is a list of priority patterns to apply to matching resources.</span></div><div class="line">	<span class="comment">// The list of all matching resources is narrowed based on the patterns until only one remains.</span></div><div class="line">	<span class="comment">// A pattern with no matches is skipped.  A pattern with more than one match uses its</span></div><div class="line">	<span class="comment">// matches as the list to continue matching against.</span></div><div class="line">	ResourcePriority []unversioned.GroupVersionResource</div><div class="line"></div><div class="line">	<span class="comment">// KindPriority is a list of priority patterns to apply to matching kinds.</span></div><div class="line">	<span class="comment">// The list of all matching kinds is narrowed based on the patterns until only one remains.</span></div><div class="line">	<span class="comment">// A pattern with no matches is skipped.  A pattern with more than one match uses its</span></div><div class="line">	<span class="comment">// matches as the list to continue matching against.</span></div><div class="line">	KindPriority []unversioned.GroupVersionKind</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>PriorityRESTMapper封装了一个RESTMapper，及ResourcePriority和KindPriority。与DefaultRESTMapper多值处理方式(出错处理)不同的是，PriorityRESTMapper会依据ResourcePriority和KindPriority对多值进行过滤，直到只有一个结果为止。<br>具体PriorityRESTMapper方法这里就不再详细分析。</p>
<h2 id="MultiRESTMapper"><a href="#MultiRESTMapper" class="headerlink" title="MultiRESTMapper"></a>MultiRESTMapper</h2><p>MultiRESTMapper定义在/pkg/api/meta/multirestmapper.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> MultiRESTMapper []RESTMapper</div></pre></td></tr></table></figure></p>
<p>MultiRESTMapper中封装了多个RESTMapper，对于KindsFor()，ResourcesFor()，RESTMappings()，MultiRESTMapper会收集所有RESTMapper的结果；对于KindFor()，ResourceFor()，RESTMapping()的多值处理方式和DefaultRESTMapper相同，直接出错处理。<br>具体MultiRESTMapper方法这里就不再详细分析。</p>
<h2 id="FirstHitRESTMapper"><a href="#FirstHitRESTMapper" class="headerlink" title="FirstHitRESTMapper"></a>FirstHitRESTMapper</h2><p>FirstHitRESTMapper定义在/pkg/api/meta/firsthit_restmapper.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> FirstHitRESTMapper <span class="keyword">struct</span> &#123;</div><div class="line">	MultiRESTMapper</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>FirstHitRESTMapper本质也封装了多个RESTMapper。与其他RESTMapper不同的是，FirstHitRESTMapper并没有实现KindsFor()，ResourcesFor()，RESTMappings()。从”FirstHitRESTMapper”这名字来看，也可以理解FirstHitRESTMapper的处理方式：当有一个RESTMapper成功，则直接返回。如KindFor()方法：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m FirstHitRESTMapper)</span> <span class="title">KindFor</span><span class="params">(resource unversioned.GroupVersionResource)</span> <span class="params">(unversioned.GroupVersionKind, error)</span></span> &#123;</div><div class="line">	errors := []error&#123;&#125;</div><div class="line">	<span class="comment">//***如果有一个RESTMapper符合，则立即返回***//</span></div><div class="line">	<span class="keyword">for</span> _, t := <span class="keyword">range</span> m.MultiRESTMapper &#123;</div><div class="line">		ret, err := t.KindFor(resource)</div><div class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> ret, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		errors = <span class="built_in">append</span>(errors, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> unversioned.GroupVersionKind&#123;&#125;, collapseAggregateErrors(errors)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>具体FirstHitRESTMapper其他方法这里就不再详细分析。</p>
<p>至此，RESTMapper分析完毕。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/24/RESTMapper解读(三)-其他RESTMapper-v1-5-2/" data-id="cj5ule850000oecqstc07hc6c" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-RESTMapper解读(二)-管理DefaultRESTMapper-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/23/RESTMapper解读(二)-管理DefaultRESTMapper-v1-5-2/" class="article-date">
  <time datetime="2017-07-23T12:38:26.000Z" itemprop="datePublished">2017-07-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/23/RESTMapper解读(二)-管理DefaultRESTMapper-v1-5-2/">RESTMapper解读(二)-管理DefaultRESTMapper-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="生成DefaultRESTMapper入口"><a href="#生成DefaultRESTMapper入口" class="headerlink" title="生成DefaultRESTMapper入口"></a>生成DefaultRESTMapper入口</h2><p>上次介绍了DefaultRESTMapper的具体实现，本次将简要分析代码何处生成了DefaultRESTMapper。生成DefaultRESTMapper的入口定义在/pkg/api/mapper.go：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDefaultRESTMapperFromScheme</span><span class="params">(defaultGroupVersions []unversioned.GroupVersion, interfacesFunc meta.VersionInterfacesFunc,</span></span></div><div class="line">	importPathPrefix <span class="keyword">string</span>, ignoredKinds, rootScoped sets.String, scheme *runtime.Scheme) *<span class="title">meta</span>.<span class="title">DefaultRESTMapper</span> &#123;</div><div class="line"></div><div class="line">	mapper := meta.NewDefaultRESTMapper(defaultGroupVersions, interfacesFunc)</div><div class="line">	<span class="comment">// enumerate all supported versions, get the kinds, and register with the mapper how to address</span></div><div class="line">	<span class="comment">// our resources.</span></div><div class="line">	<span class="keyword">for</span> _, gv := <span class="keyword">range</span> defaultGroupVersions &#123;</div><div class="line">		<span class="keyword">for</span> kind, oType := <span class="keyword">range</span> scheme.KnownTypes(gv) &#123;</div><div class="line">			gvk := gv.WithKind(kind)</div><div class="line">			<span class="comment">// <span class="doctag">TODO:</span> Remove import path check.</span></div><div class="line">			<span class="comment">// We check the import path because we currently stuff both "api" and "extensions" objects</span></div><div class="line">			<span class="comment">// into the same group within Scheme since Scheme has no notion of groups yet.</span></div><div class="line">			<span class="keyword">if</span> !strings.Contains(oType.PkgPath(), importPathPrefix) || ignoredKinds.Has(kind) &#123;</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">			scope := meta.RESTScopeNamespace</div><div class="line">			<span class="comment">//***/pkg/api/install/install.go中定义***//</span></div><div class="line">			<span class="keyword">if</span> rootScoped.Has(kind) &#123;</div><div class="line">				scope = meta.RESTScopeRoot</div><div class="line">			&#125;</div><div class="line">			mapper.Add(gvk, scope)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> mapper</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>NewDefaultRESTMapperFromScheme()函数依据传入的defaultGroupVersions和interfacesFunc参数生成mapper，然后把在Scheme中defaultGroupVersions下的资源注册到mapper中。这里的Scheme即api.Scheme，全部的类都会注册到api.Scheme中。所以可以依据defaultGroupVersions来区别DefaultRESTMapper。</p>
<h2 id="v1的DefaultRESTMapper"><a href="#v1的DefaultRESTMapper" class="headerlink" title="v1的DefaultRESTMapper"></a>v1的DefaultRESTMapper</h2><p>现在来看下v1的DefaultRESTMapper。在所有的/install/install.go文件中，都会生成groupMeta，并向registered.DefaultAPIRegistrationManager注册。这个groupMeta中包含一个DefaultRESTMapper。</p>
<p>来看/pkg/api/install/install.go中enableVersions()函数。其中传入的参数externalVersions就是<code>var availableVersions = []unversioned.GroupVersion{v1.SchemeGroupVersion}</code>，即v1。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">enableVersions</span><span class="params">(externalVersions []unversioned.GroupVersion)</span> <span class="title">error</span></span> &#123;</div><div class="line">	addVersionsToScheme(externalVersions...)</div><div class="line">	preferredExternalVersion := externalVersions[<span class="number">0</span>]</div><div class="line"></div><div class="line">	groupMeta := apimachinery.GroupMeta&#123;</div><div class="line">		GroupVersion:  preferredExternalVersion,</div><div class="line">		GroupVersions: externalVersions,</div><div class="line">		RESTMapper:    newRESTMapper(externalVersions),</div><div class="line">		SelfLinker:    runtime.SelfLinker(accessor),</div><div class="line">		InterfacesFor: interfacesFor,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***向registered.DefaultAPIRegistrationManager注册groupMeta***//</span></div><div class="line">	<span class="keyword">if</span> err := registered.RegisterGroup(groupMeta); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以，groupMeta中的RESTMapper是通过newRESTMapper()生成的。newRESTMapper()定义在/pkg/api/install/install.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newRESTMapper</span><span class="params">(externalVersions []unversioned.GroupVersion)</span> <span class="title">meta</span>.<span class="title">RESTMapper</span></span> &#123;</div><div class="line">	<span class="comment">// the list of kinds that are scoped at the root of the api hierarchy</span></div><div class="line">	<span class="comment">// if a kind is not enumerated here, it is assumed to have a namespace scope</span></div><div class="line">	<span class="comment">//***全局资源***//</span></div><div class="line">	rootScoped := sets.NewString(</div><div class="line">		<span class="string">"Node"</span>,</div><div class="line">		<span class="string">"Namespace"</span>,</div><div class="line">		<span class="string">"PersistentVolume"</span>,</div><div class="line">		<span class="string">"ComponentStatus"</span>,</div><div class="line">	)</div><div class="line"></div><div class="line">	<span class="comment">// these kinds should be excluded from the list of resources</span></div><div class="line">	ignoredKinds := sets.NewString(</div><div class="line">		<span class="string">"ListOptions"</span>,</div><div class="line">		<span class="string">"DeleteOptions"</span>,</div><div class="line">		<span class="string">"Status"</span>,</div><div class="line">		<span class="string">"PodLogOptions"</span>,</div><div class="line">		<span class="string">"PodExecOptions"</span>,</div><div class="line">		<span class="string">"PodAttachOptions"</span>,</div><div class="line">		<span class="string">"PodProxyOptions"</span>,</div><div class="line">		<span class="string">"NodeProxyOptions"</span>,</div><div class="line">		<span class="string">"ServiceProxyOptions"</span>,</div><div class="line">		<span class="string">"ThirdPartyResource"</span>,</div><div class="line">		<span class="string">"ThirdPartyResourceData"</span>,</div><div class="line">		<span class="string">"ThirdPartyResourceList"</span>)</div><div class="line"></div><div class="line">	<span class="comment">//***调用的是/api/mapper.go中的NewDefaultRESTMapper()***//</span></div><div class="line">	<span class="comment">//***externalVersions: [v1]***//</span></div><div class="line">	mapper := api.NewDefaultRESTMapper(externalVersions, interfacesFor, importPrefix, ignoredKinds, rootScoped)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> mapper</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***返回v1对应的VersionInterfaces，包含api.Scheme和accessor***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">interfacesFor</span><span class="params">(version unversioned.GroupVersion)</span> <span class="params">(*meta.VersionInterfaces, error)</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> version &#123;</div><div class="line">	<span class="keyword">case</span> v1.SchemeGroupVersion:</div><div class="line">		<span class="keyword">return</span> &amp;meta.VersionInterfaces&#123;</div><div class="line">			ObjectConvertor:  api.Scheme,</div><div class="line">			MetadataAccessor: accessor,</div><div class="line">		&#125;, <span class="literal">nil</span></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		g, _ := registered.Group(api.GroupName)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unsupported storage version: %s (valid: %v)"</span>, version, g.GroupVersions)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到newRESTMapper()调用了api.NewDefaultRESTMapper()来生成mapper。api.NewDefaultRESTMapper()定义在/pkg/api/mapper.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Instantiates a DefaultRESTMapper based on types registered in api.Scheme</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDefaultRESTMapper</span><span class="params">(defaultGroupVersions []unversioned.GroupVersion, interfacesFunc meta.VersionInterfacesFunc,</span></span></div><div class="line">	importPathPrefix <span class="keyword">string</span>, ignoredKinds, rootScoped sets.String) *<span class="title">meta</span>.<span class="title">DefaultRESTMapper</span> &#123;</div><div class="line">	<span class="keyword">return</span> NewDefaultRESTMapperFromScheme(defaultGroupVersions, interfacesFunc, importPathPrefix, ignoredKinds, rootScoped, Scheme)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这下明了了，NewDefaultRESTMapper()调用了入口函数NewDefaultRESTMapperFromScheme()。</p>
<h2 id="apis下的DefaultRESTMapper"><a href="#apis下的DefaultRESTMapper" class="headerlink" title="/apis下的DefaultRESTMapper"></a>/apis下的DefaultRESTMapper</h2><p>这里是指放在/pkg/apis下面的GroupVersion。在apis下面的GroupVersion，采用了apimachinery机制来管理包和版本的信息。感觉v1也可以用apimachinery机制来管理，毕竟都要注册到registered.DefaultAPIRegistrationManager中。</p>
<p>先来看/pkg/apis/apps/install/install.go中的init()函数：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err := announced.NewGroupMetaFactory(</div><div class="line">		&amp;announced.GroupMetaFactoryArgs&#123;</div><div class="line">			GroupName:                  apps.GroupName,</div><div class="line">			VersionPreferenceOrder:     []<span class="keyword">string</span>&#123;v1beta1.SchemeGroupVersion.Version&#125;,</div><div class="line">			ImportPrefix:               <span class="string">"k8s.io/kubernetes/pkg/apis/apps"</span>,</div><div class="line">			AddInternalObjectsToScheme: apps.AddToScheme,</div><div class="line">		&#125;,</div><div class="line">		announced.VersionToSchemeFunc&#123;</div><div class="line">			v1beta1.SchemeGroupVersion.Version: v1beta1.AddToScheme,</div><div class="line">		&#125;,</div><div class="line">	).Announce().RegisterAndEnable(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再来看/pkg/apimachinery/announced/group_factory.go中的RegisterAndEnable()函数：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(gmf *GroupMetaFactory)</span> <span class="title">RegisterAndEnable</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err := gmf.Register(registered.DefaultAPIRegistrationManager); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***向api.Scheme注册***//</span></div><div class="line">	<span class="keyword">if</span> err := gmf.Enable(registered.DefaultAPIRegistrationManager, api.Scheme); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着看Enable()函数：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***调用相应的Scheme添加函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(gmf *GroupMetaFactory)</span> <span class="title">Enable</span><span class="params">(m *registered.APIRegistrationManager, scheme *runtime.Scheme)</span> <span class="title">error</span></span> &#123;</div><div class="line">	externalVersions := []unversioned.GroupVersion&#123;&#125;</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> gmf.prioritizedVersionList &#123;</div><div class="line">		<span class="keyword">if</span> !m.IsAllowedVersion(v) &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		externalVersions = <span class="built_in">append</span>(externalVersions, v)</div><div class="line">		<span class="keyword">if</span> err := m.EnableVersions(v); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***注册具体版本的类型，如：v1beta1.AddToScheme***//</span></div><div class="line">		gmf.VersionArgs[v.Version].AddToScheme(scheme)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(externalVersions) == <span class="number">0</span> &#123;</div><div class="line">		glog.V(<span class="number">4</span>).Infof(<span class="string">"No version is registered for group %v"</span>, gmf.GroupArgs.GroupName)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***注册内部版本的类型，如：apps.AddToScheme***//</span></div><div class="line">	<span class="keyword">if</span> gmf.GroupArgs.AddInternalObjectsToScheme != <span class="literal">nil</span> &#123;</div><div class="line">		gmf.GroupArgs.AddInternalObjectsToScheme(scheme)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	preferredExternalVersion := externalVersions[<span class="number">0</span>]</div><div class="line">	accessor := meta.NewAccessor()</div><div class="line"></div><div class="line">	groupMeta := &amp;apimachinery.GroupMeta&#123;</div><div class="line">		GroupVersion:  preferredExternalVersion,</div><div class="line">		GroupVersions: externalVersions,</div><div class="line">		SelfLinker:    runtime.SelfLinker(accessor),</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> externalVersions &#123;</div><div class="line">		gvf := gmf.VersionArgs[v.Version]</div><div class="line">		<span class="comment">//***向groupMeta添加interfacesFor()函数***//</span></div><div class="line">		<span class="keyword">if</span> err := groupMeta.AddVersionInterfaces(</div><div class="line">			unversioned.GroupVersion&#123;Group: gvf.GroupName, Version: gvf.VersionName&#125;,</div><div class="line">			&amp;meta.VersionInterfaces&#123;</div><div class="line">				ObjectConvertor:  scheme,</div><div class="line">				MetadataAccessor: accessor,</div><div class="line">			&#125;,</div><div class="line">		); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***定义InterfacesFor***//</span></div><div class="line">	groupMeta.InterfacesFor = groupMeta.DefaultInterfacesFor</div><div class="line">	<span class="comment">//***生成RESTMapper***//</span></div><div class="line">	groupMeta.RESTMapper = gmf.newRESTMapper(scheme, externalVersions, groupMeta)</div><div class="line"></div><div class="line">	<span class="comment">//***向APIRegistrationManager注册groupMeta***//</span></div><div class="line">	<span class="keyword">if</span> err := m.RegisterGroup(*groupMeta); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>生成Mapper的语句为：<code>groupMeta.RESTMapper = gmf.newRESTMapper(scheme, externalVersions, groupMeta)</code>，所以来看gmf的newRESTMapper()方法：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(gmf *GroupMetaFactory)</span> <span class="title">newRESTMapper</span><span class="params">(scheme *runtime.Scheme, externalVersions []unversioned.GroupVersion, groupMeta *apimachinery.GroupMeta)</span> <span class="title">meta</span>.<span class="title">RESTMapper</span></span> &#123;</div><div class="line">	<span class="comment">// the list of kinds that are scoped at the root of the api hierarchy</span></div><div class="line">	<span class="comment">// if a kind is not enumerated here, it is assumed to have a namespace scope</span></div><div class="line">	rootScoped := sets.NewString()</div><div class="line">	<span class="keyword">if</span> gmf.GroupArgs.RootScopedKinds != <span class="literal">nil</span> &#123;</div><div class="line">		rootScoped = gmf.GroupArgs.RootScopedKinds</div><div class="line">	&#125;</div><div class="line">	ignoredKinds := sets.NewString()</div><div class="line">	<span class="keyword">if</span> gmf.GroupArgs.IgnoredKinds != <span class="literal">nil</span> &#123;</div><div class="line">		ignoredKinds = gmf.GroupArgs.IgnoredKinds</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> api.NewDefaultRESTMapperFromScheme(</div><div class="line">		externalVersions,</div><div class="line">		groupMeta.InterfacesFor,</div><div class="line">		gmf.GroupArgs.ImportPrefix,</div><div class="line">		ignoredKinds,</div><div class="line">		rootScoped,</div><div class="line">		scheme,</div><div class="line">	)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以发现，DefaultRESTMapper的生成入口函数出现了。当然，这里仅以RESTMapper作为主线进行分析，详细的apimachinery机制以后会介绍。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在总结中，梳理下DefaultRESTMapper在系统中的位置。在系统中，有一个DefaultAPIRegistrationManager管理着系统中所有GroupVersion的信息，这些信息由groupMeta承载，而groupMeta中就有DefaultRESTMapper。所以v1和/apis中的GroupVersion都会生成自己DefaultRESTMapper，不同的是/apis中的GroupVersion把一切交由apimachinery机制来。</p>
<p>当然，现在只需知道有这些概念即可。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/23/RESTMapper解读(二)-管理DefaultRESTMapper-v1-5-2/" data-id="cj5ule85c000recqsl0vgaunr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-RESTMapper解读(一)-DefaultRESTMapper-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/22/RESTMapper解读(一)-DefaultRESTMapper-v1-5-2/" class="article-date">
  <time datetime="2017-07-22T12:31:48.000Z" itemprop="datePublished">2017-07-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/22/RESTMapper解读(一)-DefaultRESTMapper-v1-5-2/">RESTMapper解读(一)-DefaultRESTMapper-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是RESTMapper"><a href="#什么是RESTMapper" class="headerlink" title="什么是RESTMapper"></a>什么是RESTMapper</h2><p>先来看来什么是RESTMapper。RESTMapper是一个interface，定义在/pkg/meta/interfaces.go中:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RESTMapper allows clients to map resources to kind, and map kind and version</span></div><div class="line"><span class="comment">// to interfaces for manipulating those objects. It is primarily intended for</span></div><div class="line"><span class="comment">// consumers of Kubernetes compatible REST APIs as defined in docs/devel/api-conventions.md.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// The Kubernetes API provides versioned resources and object kinds which are scoped</span></div><div class="line"><span class="comment">// to API groups. In other words, kinds and resources should not be assumed to be</span></div><div class="line"><span class="comment">// unique across groups.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// <span class="doctag">TODO:</span> split into sub-interfaces</span></div><div class="line"><span class="keyword">type</span> RESTMapper <span class="keyword">interface</span> &#123;</div><div class="line">	<span class="comment">// KindFor takes a partial resource and returns the single match.  Returns an error if there are multiple matches</span></div><div class="line">	KindFor(resource unversioned.GroupVersionResource) (unversioned.GroupVersionKind, error)</div><div class="line"></div><div class="line">	<span class="comment">// KindsFor takes a partial resource and returns the list of potential kinds in priority order</span></div><div class="line">	KindsFor(resource unversioned.GroupVersionResource) ([]unversioned.GroupVersionKind, error)</div><div class="line"></div><div class="line">	<span class="comment">// ResourceFor takes a partial resource and returns the single match.  Returns an error if there are multiple matches</span></div><div class="line">	ResourceFor(input unversioned.GroupVersionResource) (unversioned.GroupVersionResource, error)</div><div class="line"></div><div class="line">	<span class="comment">// ResourcesFor takes a partial resource and returns the list of potential resource in priority order</span></div><div class="line">	ResourcesFor(input unversioned.GroupVersionResource) ([]unversioned.GroupVersionResource, error)</div><div class="line"></div><div class="line">	<span class="comment">// RESTMapping identifies a preferred resource mapping for the provided group kind.</span></div><div class="line">	RESTMapping(gk unversioned.GroupKind, versions ...<span class="keyword">string</span>) (*RESTMapping, error)</div><div class="line">	<span class="comment">// RESTMappings returns all resource mappings for the provided group kind.</span></div><div class="line">	RESTMappings(gk unversioned.GroupKind) ([]*RESTMapping, error)</div><div class="line"></div><div class="line">	AliasesForResource(resource <span class="keyword">string</span>) ([]<span class="keyword">string</span>, <span class="keyword">bool</span>)</div><div class="line">	ResourceSingularizer(resource <span class="keyword">string</span>) (singular <span class="keyword">string</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>关于RESTMapper的注释非常重要，“RESTMapper allows clients to map resources to kind, and map kind and version to interfaces for manipulating those objects”。也就是说，RESTMapper映射是指GVR(GroupVersionResource)和GVK(GroupVersionKind)的关系，可以通过GVR找到合适的GVK，并可以通过GVK生成一个RESTMapping。</p>
<h2 id="什么是RESTMapping"><a href="#什么是RESTMapping" class="headerlink" title="什么是RESTMapping"></a>什么是RESTMapping</h2><p>再来看来RESTMapping，同样定义在/pkg/api/meta/interfaces.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RESTMapping contains the information needed to deal with objects of a specific</span></div><div class="line"><span class="comment">// resource and kind in a RESTful manner.</span></div><div class="line"><span class="keyword">type</span> RESTMapping <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// Resource is a string representing the name of this resource as a REST client would see it</span></div><div class="line">	<span class="comment">//***此处为string，而非GVR***//</span></div><div class="line">	Resource <span class="keyword">string</span></div><div class="line"></div><div class="line">	GroupVersionKind unversioned.GroupVersionKind</div><div class="line"></div><div class="line">	<span class="comment">// Scope contains the information needed to deal with REST Resources that are in a resource hierarchy</span></div><div class="line">	Scope RESTScope</div><div class="line"></div><div class="line">	runtime.ObjectConvertor</div><div class="line">	MetadataAccessor</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>RESTMapping包含Resource名称，及其对应的GVK，还有一个Scope(标明资源是否为root或者namespaced)，还有一个Convertor用来转换该GVK对应的Object和一个MetadataAccessor用来提取Object的meta信息。</p>
<p>那么RESTMapping怎么用呢？</p>
<p>比如/pkg/apiserver/api_installer.go中就有使用到RESTMapping中的Scope用来生成合适的URL(RESTScopeNameRoot和RESTScopeNameNamespace处理不同，详见以后对Apiserver的分析)。</p>
<p>再比如/pkg/kubectl/resource_printer.go中的VersionedPrinter中的converter也是来自RESTMapping中的Convertor(以后和Scheme一起分析)。</p>
<h2 id="什么是RESTScope"><a href="#什么是RESTScope" class="headerlink" title="什么是RESTScope"></a>什么是RESTScope</h2><p>这里一并把RESTScope介绍掉，因为RESTScope接口也定义在/pkg/api/meta/interfaces.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RESTScope contains the information needed to deal with REST resources that are in a resource hierarchy</span></div><div class="line"><span class="keyword">type</span> RESTScope <span class="keyword">interface</span> &#123;</div><div class="line">	<span class="comment">// Name of the scope</span></div><div class="line">	Name() RESTScopeName</div><div class="line">	<span class="comment">// ParamName is the optional name of the parameter that should be inserted in the resource url</span></div><div class="line">	<span class="comment">// If empty, no param will be inserted</span></div><div class="line">	ParamName() <span class="keyword">string</span></div><div class="line">	<span class="comment">// ArgumentName is the optional name that should be used for the variable holding the value.</span></div><div class="line">	ArgumentName() <span class="keyword">string</span></div><div class="line">	<span class="comment">// ParamDescription is the optional description to use to document the parameter in api documentation</span></div><div class="line">	ParamDescription() <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>RESTScope具体由restScope之实现。restScope定义在/pkg/api/meta/restmapper.go中，比较简单，这里就不在详细分析。目前有两种RESTScope：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> RESTScopeNamespace = &amp;restScope&#123;</div><div class="line">	name:             RESTScopeNameNamespace,</div><div class="line">	paramName:        <span class="string">"namespaces"</span>,</div><div class="line">	argumentName:     <span class="string">"namespace"</span>,</div><div class="line">	paramDescription: <span class="string">"object name and auth scope, such as for teams and projects"</span>,</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> RESTScopeRoot = &amp;restScope&#123;</div><div class="line">	name: RESTScopeNameRoot,</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里的RESTScopeNameNamespace和RESTScopeNameRoot定义在/pkg/api/meta/interfaces.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> (</div><div class="line">	RESTScopeNameNamespace RESTScopeName = <span class="string">"namespace"</span></div><div class="line">	RESTScopeNameRoot      RESTScopeName = <span class="string">"root"</span></div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>这里只要记住，RESTScopeNamespace表明该资源是在Namespace下的，如pods，rc等；RESTScopeRoot标明资源是全局的，如nodes, pv等。</p>
<h2 id="DefaultRESTMapper"><a href="#DefaultRESTMapper" class="headerlink" title="DefaultRESTMapper"></a>DefaultRESTMapper</h2><p>DefaultRESTMapper实现了RESTMapper interface。为什么称为DefaultRESTMapper呢，因为DefaultRESTMapper定义了defaultGroupVersions。DefaultRESTMapper定义在/pkg/api/metamapper.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***DefaultRESTMapper中的resource是指GVR，kind是指GVK***//</span></div><div class="line"><span class="comment">//***singular和Plural都是GVR***//</span></div><div class="line"><span class="keyword">type</span> DefaultRESTMapper <span class="keyword">struct</span> &#123;</div><div class="line">	defaultGroupVersions []unversioned.GroupVersion</div><div class="line"></div><div class="line">	resourceToKind       <span class="keyword">map</span>[unversioned.GroupVersionResource]unversioned.GroupVersionKind</div><div class="line">	kindToPluralResource <span class="keyword">map</span>[unversioned.GroupVersionKind]unversioned.GroupVersionResource</div><div class="line">	kindToScope          <span class="keyword">map</span>[unversioned.GroupVersionKind]RESTScope</div><div class="line">	singularToPlural     <span class="keyword">map</span>[unversioned.GroupVersionResource]unversioned.GroupVersionResource</div><div class="line">	pluralToSingular     <span class="keyword">map</span>[unversioned.GroupVersionResource]unversioned.GroupVersionResource</div><div class="line"></div><div class="line">	interfacesFunc VersionInterfacesFunc</div><div class="line"></div><div class="line">	<span class="comment">// aliasToResource is used for mapping aliases to resources</span></div><div class="line">	aliasToResource <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在来详细分析DefaultRESTMapper的字段的涵义。</p>
<ul>
<li>defaultGroupVersions: 默认的GroupVersion，如v1，apps/v1beta1等，一般一个DefaultRESTMapper只设一个默认的GroupVersion；</li>
<li>resourceToKind：GVR(单数,复数)到GVK的map；</li>
<li>kindToPluralResource：GVK到GVR(复数)的map；</li>
<li>kindToScope：GVK到Scope的map；</li>
<li>singularToPlural：GVR(单数)到GVR(复数)的map；</li>
<li>interfacesFunc：用来产生Convertor和MetadataAccessor，具体实现为/pkg/api/install/install.go中的interfacesFor()函数。</li>
<li>aliasToResource：管理别名，但貌似系统中没怎么用这功能。<br>这里要说明白的是，DefaultRESTMapper中的Resource有单数和复数的区别。但为什么要有单复数的区别，现在还不知道。</li>
</ul>
<p>下面来分析DefaultRESTMapper的重要方法的实现。</p>
<h3 id="NewDefaultRESTMapper"><a href="#NewDefaultRESTMapper" class="headerlink" title="NewDefaultRESTMapper()"></a>NewDefaultRESTMapper()</h3><p>NewDefaultRESTMapper()生成一个新的DefaultRESTMapper。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDefaultRESTMapper</span><span class="params">(defaultGroupVersions []unversioned.GroupVersion, f VersionInterfacesFunc)</span> *<span class="title">DefaultRESTMapper</span></span> &#123;</div><div class="line">	resourceToKind := <span class="built_in">make</span>(<span class="keyword">map</span>[unversioned.GroupVersionResource]unversioned.GroupVersionKind)</div><div class="line">	kindToPluralResource := <span class="built_in">make</span>(<span class="keyword">map</span>[unversioned.GroupVersionKind]unversioned.GroupVersionResource)</div><div class="line">	kindToScope := <span class="built_in">make</span>(<span class="keyword">map</span>[unversioned.GroupVersionKind]RESTScope)</div><div class="line">	singularToPlural := <span class="built_in">make</span>(<span class="keyword">map</span>[unversioned.GroupVersionResource]unversioned.GroupVersionResource)</div><div class="line">	pluralToSingular := <span class="built_in">make</span>(<span class="keyword">map</span>[unversioned.GroupVersionResource]unversioned.GroupVersionResource)</div><div class="line">	aliasToResource := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>)</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> verify name mappings work correctly when versions differ</span></div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;DefaultRESTMapper&#123;</div><div class="line">		resourceToKind:       resourceToKind,</div><div class="line">		kindToPluralResource: kindToPluralResource,</div><div class="line">		kindToScope:          kindToScope,</div><div class="line">		defaultGroupVersions: defaultGroupVersions,</div><div class="line">		singularToPlural:     singularToPlural,</div><div class="line">		pluralToSingular:     pluralToSingular,</div><div class="line">		aliasToResource:      aliasToResource,</div><div class="line">		interfacesFunc:       f,</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>NewDefaultRESTMapper()会被/pkg/api/mapper.go的NewDefaultRESTMapperFromScheme()函数调用。NewDefaultRESTMapperFromScheme()是生成DefaultRESTMapper的入口。这就很方便我们看系统中有多少个DefaultRESTMapper了：<br>[v1], [apps/v1beta1], [authentication.k8s.io/v1beta1], [authorization.k8s.io/v1beta1], [autoscaling/v1], [batch/v1 batch/v2alpha1], [certificates.k8s.io/v1alpha1], [componentconfig/v1alpha1], [extensions/v1beta1], [policy/v1beta1], [rbac.authorization.k8s.io/v1alpha1], [storage.k8s.io/v1beta1], [imagepolicy.k8s.io/v1alpha1]</p>
<h3 id="Add"><a href="#Add" class="headerlink" title="Add()"></a>Add()</h3><p>Add()方法主要是把GVK和GVK对应的scope加入到DefaultRESTMapper对应的字段中。其中KindToResource()返回GVK对应的GVR(复数)和GVR(单数)。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***添加GVK***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *DefaultRESTMapper)</span> <span class="title">Add</span><span class="params">(kind unversioned.GroupVersionKind, scope RESTScope)</span></span> &#123;</div><div class="line">	plural, singular := KindToResource(kind)</div><div class="line"></div><div class="line">	m.singularToPlural[singular] = plural</div><div class="line">	m.pluralToSingular[plural] = singular</div><div class="line"></div><div class="line">	m.resourceToKind[singular] = kind</div><div class="line">	m.resourceToKind[plural] = kind</div><div class="line"></div><div class="line">	m.kindToPluralResource[kind] = plural</div><div class="line">	m.kindToScope[kind] = scope</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="ResourceFor"><a href="#ResourceFor" class="headerlink" title="ResourceFor()"></a>ResourceFor()</h3><p>ResourceFor()通过GVR(信息不一定要全)找到一个最合适的注册的GVR。规则如下：</p>
<ul>
<li>如果参数GVR没有有Resource，则返回错误。</li>
<li>如果参数GVR限定Group，Version和Resource，则匹配Group，Version和Resource；</li>
<li>如果参数GVR限定Group和Resource，则匹配Group和Resource；</li>
<li>如果参数GVR限定Version和Resource，则匹配Version和Resource；</li>
<li>如果参数GVR只有Resource，则匹配Resource。</li>
<li>如果系统中存在多个匹配，则返回错误(系统现在还不支持在不同的Group中定义相同的type)。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***找到最匹配的注册GVR***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *DefaultRESTMapper)</span> <span class="title">ResourceFor</span><span class="params">(resource unversioned.GroupVersionResource)</span> <span class="params">(unversioned.GroupVersionResource, error)</span></span> &#123;</div><div class="line">	resources, err := m.ResourcesFor(resource)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> unversioned.GroupVersionResource&#123;&#125;, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(resources) == <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">return</span> resources[<span class="number">0</span>], <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> unversioned.GroupVersionResource&#123;&#125;, &amp;AmbiguousResourceError&#123;PartialResource: resource, MatchingResources: resources&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***寻找匹配input GVR的注册GVR***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *DefaultRESTMapper)</span> <span class="title">ResourcesFor</span><span class="params">(input unversioned.GroupVersionResource)</span> <span class="params">([]unversioned.GroupVersionResource, error)</span></span> &#123;</div><div class="line">	<span class="comment">//***获取GVR***//</span></div><div class="line">	resource := coerceResourceForMatching(input)</div><div class="line"></div><div class="line">	hasResource := <span class="built_in">len</span>(resource.Resource) &gt; <span class="number">0</span></div><div class="line">	hasGroup := <span class="built_in">len</span>(resource.Group) &gt; <span class="number">0</span></div><div class="line">	hasVersion := <span class="built_in">len</span>(resource.Version) &gt; <span class="number">0</span></div><div class="line"></div><div class="line">	<span class="keyword">if</span> !hasResource &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"a resource must be present, got: %v"</span>, resource)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ret := []unversioned.GroupVersionResource&#123;&#125;</div><div class="line">	<span class="keyword">switch</span> &#123;</div><div class="line">	<span class="comment">//***限定group和version，则比较GVR***//</span></div><div class="line">	<span class="keyword">case</span> hasGroup &amp;&amp; hasVersion:</div><div class="line">		<span class="comment">// fully qualified.  Find the exact match</span></div><div class="line">		<span class="keyword">for</span> plural, singular := <span class="keyword">range</span> m.pluralToSingular &#123;</div><div class="line">			<span class="keyword">if</span> singular == resource &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> plural == resource &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***只限定group，则比较GR***//</span></div><div class="line">	<span class="keyword">case</span> hasGroup:</div><div class="line">		<span class="comment">// given a group, prefer an exact match.  If you don't find one, resort to a prefix match on group</span></div><div class="line">		foundExactMatch := <span class="literal">false</span></div><div class="line">		requestedGroupResource := resource.GroupResource()</div><div class="line">		<span class="keyword">for</span> plural, singular := <span class="keyword">range</span> m.pluralToSingular &#123;</div><div class="line">			<span class="keyword">if</span> singular.GroupResource() == requestedGroupResource &#123;</div><div class="line">				foundExactMatch = <span class="literal">true</span></div><div class="line">				ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> plural.GroupResource() == requestedGroupResource &#123;</div><div class="line">				foundExactMatch = <span class="literal">true</span></div><div class="line">				ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// if you didn't find an exact match, match on group prefixing. This allows storageclass.storage to match</span></div><div class="line">		<span class="comment">// storageclass.storage.k8s.io</span></div><div class="line">		<span class="keyword">if</span> !foundExactMatch &#123;</div><div class="line">			<span class="keyword">for</span> plural, singular := <span class="keyword">range</span> m.pluralToSingular &#123;</div><div class="line">				<span class="keyword">if</span> !strings.HasPrefix(plural.Group, requestedGroupResource.Group) &#123;</div><div class="line">					<span class="keyword">continue</span></div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> singular.Resource == requestedGroupResource.Resource &#123;</div><div class="line">					ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> plural.Resource == requestedGroupResource.Resource &#123;</div><div class="line">					ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***限定version，则比较version和resource***//</span></div><div class="line">	<span class="keyword">case</span> hasVersion:</div><div class="line">		<span class="keyword">for</span> plural, singular := <span class="keyword">range</span> m.pluralToSingular &#123;</div><div class="line">			<span class="keyword">if</span> singular.Version == resource.Version &amp;&amp; singular.Resource == resource.Resource &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> plural.Version == resource.Version &amp;&amp; plural.Resource == resource.Resource &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***只比较Resource***//</span></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">for</span> plural, singular := <span class="keyword">range</span> m.pluralToSingular &#123;</div><div class="line">			<span class="keyword">if</span> singular.Resource == resource.Resource &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> plural.Resource == resource.Resource &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ret) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, &amp;NoResourceMatchError&#123;PartialResource: resource&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sort.Sort(resourceByPreferredGroupVersion&#123;ret, m.defaultGroupVersions&#125;)</div><div class="line">	<span class="keyword">return</span> ret, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="KindFor"><a href="#KindFor" class="headerlink" title="KindFor()"></a>KindFor()</h3><p>KindFor()通过GVR(信息不一定要全)找到一个最合适的注册的GVK。规则和ResourceFor()一样：</p>
<ul>
<li>如果参数GVR没有有Resource，则返回错误。</li>
<li>如果参数GVR限定Group，Version和Resource，则匹配Group，Version和Resource；</li>
<li>如果参数GVR限定Group和Resource，则匹配Group和Resource；</li>
<li>如果参数GVR限定Version和Resource，则匹配Version和Resource；</li>
<li>如果参数GVR只有Resource，则匹配Resource。</li>
<li>如果系统中存在多个匹配，则返回错误(系统现在还不支持在不同的Group中定义相同的type)。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取与GVR最匹配的GVK***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *DefaultRESTMapper)</span> <span class="title">KindFor</span><span class="params">(resource unversioned.GroupVersionResource)</span> <span class="params">(unversioned.GroupVersionKind, error)</span></span> &#123;</div><div class="line">	kinds, err := m.KindsFor(resource)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> unversioned.GroupVersionKind&#123;&#125;, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(kinds) == <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">return</span> kinds[<span class="number">0</span>], <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> unversioned.GroupVersionKind&#123;&#125;, &amp;AmbiguousResourceError&#123;PartialResource: resource, MatchingKinds: kinds&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***通过GVR获取GVK***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *DefaultRESTMapper)</span> <span class="title">KindsFor</span><span class="params">(input unversioned.GroupVersionResource)</span> <span class="params">([]unversioned.GroupVersionKind, error)</span></span> &#123;</div><div class="line">	resource := coerceResourceForMatching(input)</div><div class="line"></div><div class="line">	hasResource := <span class="built_in">len</span>(resource.Resource) &gt; <span class="number">0</span></div><div class="line">	hasGroup := <span class="built_in">len</span>(resource.Group) &gt; <span class="number">0</span></div><div class="line">	hasVersion := <span class="built_in">len</span>(resource.Version) &gt; <span class="number">0</span></div><div class="line"></div><div class="line">	<span class="keyword">if</span> !hasResource &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"a resource must be present, got: %v"</span>, resource)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ret := []unversioned.GroupVersionKind&#123;&#125;</div><div class="line">	<span class="keyword">switch</span> &#123;</div><div class="line">	<span class="comment">// fully qualified.  Find the exact match</span></div><div class="line">	<span class="keyword">case</span> hasGroup &amp;&amp; hasVersion:</div><div class="line">		kind, exists := m.resourceToKind[resource]</div><div class="line">		<span class="keyword">if</span> exists &#123;</div><div class="line">			ret = <span class="built_in">append</span>(ret, kind)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	<span class="keyword">case</span> hasGroup:</div><div class="line">		foundExactMatch := <span class="literal">false</span></div><div class="line">		requestedGroupResource := resource.GroupResource()</div><div class="line">		<span class="keyword">for</span> currResource, currKind := <span class="keyword">range</span> m.resourceToKind &#123;</div><div class="line">			<span class="keyword">if</span> currResource.GroupResource() == requestedGroupResource &#123;</div><div class="line">				foundExactMatch = <span class="literal">true</span></div><div class="line">				ret = <span class="built_in">append</span>(ret, currKind)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// if you didn't find an exact match, match on group prefixing. This allows storageclass.storage to match</span></div><div class="line">		<span class="comment">// storageclass.storage.k8s.io</span></div><div class="line">		<span class="keyword">if</span> !foundExactMatch &#123;</div><div class="line">			<span class="keyword">for</span> currResource, currKind := <span class="keyword">range</span> m.resourceToKind &#123;</div><div class="line">				<span class="keyword">if</span> !strings.HasPrefix(currResource.Group, requestedGroupResource.Group) &#123;</div><div class="line">					<span class="keyword">continue</span></div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> currResource.Resource == requestedGroupResource.Resource &#123;</div><div class="line">					ret = <span class="built_in">append</span>(ret, currKind)</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125;</div><div class="line"></div><div class="line">	<span class="keyword">case</span> hasVersion:</div><div class="line">		<span class="keyword">for</span> currResource, currKind := <span class="keyword">range</span> m.resourceToKind &#123;</div><div class="line">			<span class="keyword">if</span> currResource.Version == resource.Version &amp;&amp; currResource.Resource == resource.Resource &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, currKind)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">for</span> currResource, currKind := <span class="keyword">range</span> m.resourceToKind &#123;</div><div class="line">			<span class="keyword">if</span> currResource.Resource == resource.Resource &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, currKind)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ret) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, &amp;NoResourceMatchError&#123;PartialResource: input&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sort.Sort(kindByPreferredGroupVersion&#123;ret, m.defaultGroupVersions&#125;)</div><div class="line">	<span class="keyword">return</span> ret, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="RESTMapping"><a href="#RESTMapping" class="headerlink" title="RESTMapping()"></a>RESTMapping()</h3><p>RESTMapping()的参数是GK和versions，通常的做法是把一个GVK直接拆成GK和Version，然后获取mapping。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RESTMapping returns a struct representing the resource path and conversion interfaces a</span></div><div class="line"><span class="comment">// RESTClient should use to operate on the provided group/kind in order of versions. If a version search</span></div><div class="line"><span class="comment">// order is not provided, the search order provided to DefaultRESTMapper will be used to resolve which</span></div><div class="line"><span class="comment">// version should be used to access the named group/kind.</span></div><div class="line"><span class="comment">// <span class="doctag">TODO:</span> consider refactoring to use RESTMappings in a way that preserves version ordering and preference</span></div><div class="line"><span class="comment">//***返回RESTMapping***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *DefaultRESTMapper)</span> <span class="title">RESTMapping</span><span class="params">(gk unversioned.GroupKind, versions ...<span class="keyword">string</span>)</span> <span class="params">(*RESTMapping, error)</span></span> &#123;</div><div class="line">	<span class="comment">// Pick an appropriate version</span></div><div class="line">	<span class="keyword">var</span> gvk *unversioned.GroupVersionKind</div><div class="line">	hadVersion := <span class="literal">false</span></div><div class="line">	<span class="comment">//***构造GVK***//</span></div><div class="line">	<span class="keyword">for</span> _, version := <span class="keyword">range</span> versions &#123;</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(version) == <span class="number">0</span> || version == runtime.APIVersionInternal &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		currGVK := gk.WithVersion(version)</div><div class="line">		hadVersion = <span class="literal">true</span></div><div class="line">		<span class="comment">//***一旦找到合适的version，则break***//</span></div><div class="line">		<span class="keyword">if</span> _, ok := m.kindToPluralResource[currGVK]; ok &#123;</div><div class="line">			gvk = &amp;currGVK</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Use the default preferred versions</span></div><div class="line">	<span class="keyword">if</span> !hadVersion &amp;&amp; (gvk == <span class="literal">nil</span>) &#123;</div><div class="line">		<span class="keyword">for</span> _, gv := <span class="keyword">range</span> m.defaultGroupVersions &#123;</div><div class="line">			<span class="keyword">if</span> gv.Group != gk.Group &#123;</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line"></div><div class="line">			currGVK := gk.WithVersion(gv.Version)</div><div class="line">			<span class="keyword">if</span> _, ok := m.kindToPluralResource[currGVK]; ok &#123;</div><div class="line">				gvk = &amp;currGVK</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> gvk == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, &amp;NoKindMatchError&#123;PartialKind: gk.WithVersion(<span class="string">""</span>)&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Ensure we have a REST mapping</span></div><div class="line">	<span class="comment">//***按照GVK获取resource***//</span></div><div class="line">	<span class="comment">//***从原注释看，GVK和GVR的关系叫做REST mapping***//</span></div><div class="line">	resource, ok := m.kindToPluralResource[*gvk]</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		found := []unversioned.GroupVersion&#123;&#125;</div><div class="line">		<span class="keyword">for</span> _, gv := <span class="keyword">range</span> m.defaultGroupVersions &#123;</div><div class="line">			<span class="keyword">if</span> _, ok := m.kindToPluralResource[*gvk]; ok &#123;</div><div class="line">				found = <span class="built_in">append</span>(found, gv)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(found) &gt; <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"object with kind %q exists in versions %v, not %v"</span>, gvk.Kind, found, gvk.GroupVersion().String())</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"the provided version %q and kind %q cannot be mapped to a supported object"</span>, gvk.GroupVersion().String(), gvk.Kind)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Ensure we have a REST scope</span></div><div class="line">	<span class="comment">//***获取scope***//</span></div><div class="line">	scope, ok := m.kindToScope[*gvk]</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"the provided version %q and kind %q cannot be mapped to a supported scope"</span>, gvk.GroupVersion().String(), gvk.Kind)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	interfaces, err := m.interfacesFunc(gvk.GroupVersion())</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"the provided version %q has no relevant versions: %v"</span>, gvk.GroupVersion().String(), err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***构造RESTMapping***//</span></div><div class="line">	<span class="comment">//***RESTMapping中有resource(名称), GVK, scope, convertor, accessor***//</span></div><div class="line">	retVal := &amp;RESTMapping&#123;</div><div class="line">		Resource:         resource.Resource,</div><div class="line">		GroupVersionKind: *gvk,</div><div class="line">		Scope:            scope,</div><div class="line"></div><div class="line">		ObjectConvertor:  interfaces.ObjectConvertor,</div><div class="line">		MetadataAccessor: interfaces.MetadataAccessor,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> retVal, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>RESTMapping()的流程如下：</p>
<ul>
<li>构造GVK：使用GK和Versions，或GK和DefaultGroupVersions，构造GVK；</li>
<li>获取GVR：从kindToPluralResource中获取GVR；</li>
<li>获取scope：从kindToScope中获取scope；</li>
<li>使用interfacesFunc()获取Convertor和MetadataAccessor；</li>
<li>组装成RESTMapping并返回。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>RESTMapper可以从GVR获取GVK，并生成一个RESTMapping来处理该GVR。RESTMapping中有Resource名称，GVK，Scope，Convertor，Accessor等和GVR有关的信息。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/22/RESTMapper解读(一)-DefaultRESTMapper-v1-5-2/" data-id="cj5ule84u000kecqs35o6v5n1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Kubectl概念解读(六)-Describer-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/20/Kubectl概念解读(六)-Describer-v1-5-2/" class="article-date">
  <time datetime="2017-07-20T07:37:40.000Z" itemprop="datePublished">2017-07-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/20/Kubectl概念解读(六)-Describer-v1-5-2/">Kubectl概念解读(六)-Describer-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是Describer"><a href="#什么是Describer" class="headerlink" title="什么是Describer"></a>什么是Describer</h2><p>Describer是Kubectl上用来描述对象具体信息的，和<code>kubectl describe</code>配合使用。</p>
<p>在/pkg/kubectl/cmd/util/factory.go中，有Describer()函数，可以依据mapping生成合适的Describer。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *factory)</span> <span class="title">Describer</span><span class="params">(mapping *meta.RESTMapping)</span> <span class="params">(kubectl.Describer, error)</span></span> &#123;</div><div class="line">	mappingVersion := mapping.GroupVersionKind.GroupVersion()</div><div class="line">	<span class="keyword">if</span> mapping.GroupVersionKind.Group == federation.GroupName &#123;</div><div class="line">		fedClientSet, err := f.clients.FederationClientSetForVersion(&amp;mappingVersion)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> mapping.GroupVersionKind.Kind == <span class="string">"Cluster"</span> &#123;</div><div class="line">			<span class="keyword">return</span> &amp;kubectl.ClusterDescriber&#123;Interface: fedClientSet&#125;, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	clientset, err := f.clients.ClientSetForVersion(&amp;mappingVersion)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***找到合适的describer***//</span></div><div class="line">	<span class="keyword">if</span> describer, ok := kubectl.DescriberFor(mapping.GroupVersionKind.GroupKind(), clientset); ok &#123;</div><div class="line">		<span class="keyword">return</span> describer, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"no description has been implemented for %q"</span>, mapping.GroupVersionKind.Kind)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Describer"><a href="#Describer" class="headerlink" title="Describer"></a>Describer</h2><p>Describer定义在/pkg/kubectl/describe.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Describer generates output for the named resource or an error</span></div><div class="line"><span class="comment">// if the output could not be generated. Implementers typically</span></div><div class="line"><span class="comment">// abstract the retrieval of the named object from a remote server.</span></div><div class="line"><span class="keyword">type</span> Describer <span class="keyword">interface</span> &#123;</div><div class="line">	Describe(namespace, name <span class="keyword">string</span>, describerSettings DescriberSettings) (output <span class="keyword">string</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，只要实现了Describe()的结构体都可以称为Describer。</p>
<p>所以，在/pkg/kubectl/describer.go中，实现了PodDescriber, ReplicationControllerDescriber, SecretDescriber, ServiceDescriber, ServiceAccountDescriber, NodeDescriber, LimitRangeDescriber, ResourceQuotaDescriber, PersistentVolumeDescriber, PersistentVolumeClaimDescriber, NamespaceDescriber, EndpointsDescriber, ConfigMapDescriber, ReplicaSetDescriber, HorizontalPodAutoscalerDescriber, NetworkPolicyDescriber, HorizontalPodAutoscalerDescriber, DaemonSetDescriber, DeploymentDescriber, JobDescriber, IngressDescriber, JobDescriber, CronJobDescriber, StatefulSetDescriber, CertificateSigningRequestDescriber, StorageClassDescriber, PodDisruptionBudgetDescriber。</p>
<p>在实现Describer的结构体中，通常会嵌入一个clientset，用来在Describe()中获取具体的Object。比如说下面的ReplicationControllerDescriber。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ReplicationControllerDescriber generates information about a replication controller</span></div><div class="line"><span class="comment">// and the pods it has created.</span></div><div class="line"><span class="keyword">type</span> ReplicationControllerDescriber <span class="keyword">struct</span> &#123;</div><div class="line">	clientset.Interface</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *ReplicationControllerDescriber)</span> <span class="title">Describe</span><span class="params">(namespace, name <span class="keyword">string</span>, describerSettings DescriberSettings)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	rc := d.Core().ReplicationControllers(namespace)</div><div class="line">	pc := d.Core().Pods(namespace)</div><div class="line"></div><div class="line">	controller, err := rc.Get(name)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	running, waiting, succeeded, failed, err := getPodStatusForController(pc, labels.SelectorFromSet(controller.Spec.Selector))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> events *api.EventList</div><div class="line">	<span class="keyword">if</span> describerSettings.ShowEvents &#123;</div><div class="line">		events, _ = d.Core().Events(namespace).Search(controller)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> describeReplicationController(controller, events, running, waiting, succeeded, failed)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="DescriberMap"><a href="#DescriberMap" class="headerlink" title="DescriberMap"></a>DescriberMap</h2><p>DescriberMap中记录了GK和Describer的关系。这里使用GK作为Key，因为GK足以标记一个类型。目前还不支持同名Kind出现在不同的Group(internal除外)中(否则resource无法找到合适的GVK)，所以感觉完全可以仅使用Kind作为Key。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***构建Describer map，其中key为GK，value为Describer***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">describerMap</span><span class="params">(c clientset.Interface)</span> <span class="title">map</span>[<span class="title">unversioned</span>.<span class="title">GroupKind</span>]<span class="title">Describer</span></span> &#123;</div><div class="line">	m := <span class="keyword">map</span>[unversioned.GroupKind]Describer&#123;</div><div class="line">		api.Kind(<span class="string">"Pod"</span>):                   &amp;PodDescriber&#123;c&#125;,</div><div class="line">		api.Kind(<span class="string">"ReplicationController"</span>): &amp;ReplicationControllerDescriber&#123;c&#125;,</div><div class="line">		api.Kind(<span class="string">"Secret"</span>):                &amp;SecretDescriber&#123;c&#125;,</div><div class="line">		api.Kind(<span class="string">"Service"</span>):               &amp;ServiceDescriber&#123;c&#125;,</div><div class="line">		api.Kind(<span class="string">"ServiceAccount"</span>):        &amp;ServiceAccountDescriber&#123;c&#125;,</div><div class="line">		api.Kind(<span class="string">"Node"</span>):                  &amp;NodeDescriber&#123;c&#125;,</div><div class="line">		api.Kind(<span class="string">"LimitRange"</span>):            &amp;LimitRangeDescriber&#123;c&#125;,</div><div class="line">		api.Kind(<span class="string">"ResourceQuota"</span>):         &amp;ResourceQuotaDescriber&#123;c&#125;,</div><div class="line">		api.Kind(<span class="string">"PersistentVolume"</span>):      &amp;PersistentVolumeDescriber&#123;c&#125;,</div><div class="line">		api.Kind(<span class="string">"PersistentVolumeClaim"</span>): &amp;PersistentVolumeClaimDescriber&#123;c&#125;,</div><div class="line">		api.Kind(<span class="string">"Namespace"</span>):             &amp;NamespaceDescriber&#123;c&#125;,</div><div class="line">		api.Kind(<span class="string">"Endpoints"</span>):             &amp;EndpointsDescriber&#123;c&#125;,</div><div class="line">		api.Kind(<span class="string">"ConfigMap"</span>):             &amp;ConfigMapDescriber&#123;c&#125;,</div><div class="line"></div><div class="line">		extensions.Kind(<span class="string">"ReplicaSet"</span>):                  &amp;ReplicaSetDescriber&#123;c&#125;,</div><div class="line">		extensions.Kind(<span class="string">"HorizontalPodAutoscaler"</span>):     &amp;HorizontalPodAutoscalerDescriber&#123;c&#125;,</div><div class="line">		extensions.Kind(<span class="string">"NetworkPolicy"</span>):               &amp;NetworkPolicyDescriber&#123;c&#125;,</div><div class="line">		autoscaling.Kind(<span class="string">"HorizontalPodAutoscaler"</span>):    &amp;HorizontalPodAutoscalerDescriber&#123;c&#125;,</div><div class="line">		extensions.Kind(<span class="string">"DaemonSet"</span>):                   &amp;DaemonSetDescriber&#123;c&#125;,</div><div class="line">		extensions.Kind(<span class="string">"Deployment"</span>):                  &amp;DeploymentDescriber&#123;c&#125;,</div><div class="line">		extensions.Kind(<span class="string">"Job"</span>):                         &amp;JobDescriber&#123;c&#125;,</div><div class="line">		extensions.Kind(<span class="string">"Ingress"</span>):                     &amp;IngressDescriber&#123;c&#125;,</div><div class="line">		batch.Kind(<span class="string">"Job"</span>):                              &amp;JobDescriber&#123;c&#125;,</div><div class="line">		batch.Kind(<span class="string">"CronJob"</span>):                          &amp;CronJobDescriber&#123;c&#125;,</div><div class="line">		apps.Kind(<span class="string">"StatefulSet"</span>):                       &amp;StatefulSetDescriber&#123;c&#125;,</div><div class="line">		certificates.Kind(<span class="string">"CertificateSigningRequest"</span>): &amp;CertificateSigningRequestDescriber&#123;c&#125;,</div><div class="line">		storage.Kind(<span class="string">"StorageClass"</span>):                   &amp;StorageClassDescriber&#123;c&#125;,</div><div class="line">		policy.Kind(<span class="string">"PodDisruptionBudget"</span>):             &amp;PodDisruptionBudgetDescriber&#123;c&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> m</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Describer的入口"><a href="#Describer的入口" class="headerlink" title="Describer的入口"></a>Describer的入口</h2><p>最后来看下Describer的入口。</p>
<p>之前我们看到，可以使用下面的代码获取Describer<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***找到合适的describer***//</span></div><div class="line"><span class="keyword">if</span> describer, ok := kubectl.DescriberFor(mapping.GroupVersionKind.GroupKind(), clientset); ok &#123;</div><div class="line">	<span class="keyword">return</span> describer, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以来看来/pkg/kubectl/describe.go中的DescriberFor()函数：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***返回合适的describer***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DescriberFor</span><span class="params">(kind unversioned.GroupKind, c clientset.Interface)</span> <span class="params">(Describer, <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	f, ok := describerMap(c)[kind]</div><div class="line">	<span class="keyword">return</span> f, ok</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>函数的实现很简单，先调用describerMap()生成DescriberMap，然后找到对应kind的Describer。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/20/Kubectl概念解读(六)-Describer-v1-5-2/" data-id="cj5ule86t001jecqs455ouq7z" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/kubernetes/" style="font-size: 10px;">kubernetes</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 10px;">kubernetes-v1.5.2</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/08/02/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2017/08/01/apimachinery机制解读(二)-GroupMetaFactory-v1-5-2/">apimachinery机制解读(二)-GroupMetaFactory-v1.5.2</a>
          </li>
        
          <li>
            <a href="/2017/07/31/apimachinery机制解读(一)-APIRegistrationManager-v1-5-2/">apimachinery机制解读(一)-APIRegistrationManager-v1.5.2</a>
          </li>
        
          <li>
            <a href="/2017/07/30/Scheme机制解读(三)-Cloner-v1-5-2/">Scheme机制解读(三)-Cloner-v1.5.2</a>
          </li>
        
          <li>
            <a href="/2017/07/29/Scheme机制解读(二)-Converter-v1-5-2/">Scheme机制解读(二)-Converter-v1.5.2</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 KangFAN<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>