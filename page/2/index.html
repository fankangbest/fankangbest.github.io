<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>fankangbest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="fankangbest">
<meta property="og:url" content="http://fankangbest.coding.me/page/2/index.html">
<meta property="og:site_name" content="fankangbest">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="fankangbest">
  
    <link rel="alternate" href="/atom.xml" title="fankangbest" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">fankangbest</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://fankangbest.coding.me"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Kubectl概念解读(五)-Printer-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/19/Kubectl概念解读(五)-Printer-v1-5-2/" class="article-date">
  <time datetime="2017-07-19T07:20:28.000Z" itemprop="datePublished">2017-07-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/19/Kubectl概念解读(五)-Printer-v1-5-2/">Kubectl概念解读(五)-Printer-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是Printer"><a href="#什么是Printer" class="headerlink" title="什么是Printer"></a>什么是Printer</h2><p>Printer可以对Kubernetes中的资源按一定格式进行打印输出，Printer主要供Kubectl get命令使用。目前Kubectl主要实现了JsonPrinter, YAMLPrinter, NamePrinter, TemplatePrinter, JSONPathPrinter, CustomColumnsPrinter, VersionedPrinter, HumanReadablePrinter。</p>
<p>在对这些Printer进行分析之前，先来看下/pkg/kubectl/resource_printer.go的GetPrinter()函数：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetPrinter</span><span class="params">(format, formatArgument <span class="keyword">string</span>, noHeaders <span class="keyword">bool</span>)</span> <span class="params">(ResourcePrinter, <span class="keyword">bool</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> printer ResourcePrinter</div><div class="line">	<span class="keyword">switch</span> format &#123;</div><div class="line">	<span class="keyword">case</span> <span class="string">"json"</span>:</div><div class="line">		printer = &amp;JSONPrinter&#123;&#125;</div><div class="line">	<span class="keyword">case</span> <span class="string">"yaml"</span>:</div><div class="line">		printer = &amp;YAMLPrinter&#123;&#125;</div><div class="line">	<span class="keyword">case</span> <span class="string">"name"</span>:</div><div class="line">		printer = &amp;NamePrinter&#123;</div><div class="line">			<span class="comment">// <span class="doctag">TODO:</span> this is wrong, these should be provided as an argument to GetPrinter</span></div><div class="line">			Typer:   api.Scheme,</div><div class="line">			Decoder: api.Codecs.UniversalDecoder(),</div><div class="line">		&#125;</div><div class="line">	<span class="comment">//***kubectl get pods nginx-1487191267-0t8x3 -o go-template="&#123;&#123;.metadata.name&#125;&#125;"***//</span></div><div class="line">	<span class="keyword">case</span> <span class="string">"template"</span>, <span class="string">"go-template"</span>:</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(formatArgument) == <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, fmt.Errorf(<span class="string">"template format specified but no template given"</span>)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">var</span> err error</div><div class="line">		printer, err = NewTemplatePrinter([]<span class="keyword">byte</span>(formatArgument))</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, fmt.Errorf(<span class="string">"error parsing template %s, %v\n"</span>, formatArgument, err)</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">case</span> <span class="string">"templatefile"</span>, <span class="string">"go-template-file"</span>:</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(formatArgument) == <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, fmt.Errorf(<span class="string">"templatefile format specified but no template file given"</span>)</div><div class="line">		&#125;</div><div class="line">		data, err := ioutil.ReadFile(formatArgument)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, fmt.Errorf(<span class="string">"error reading template %s, %v\n"</span>, formatArgument, err)</div><div class="line">		&#125;</div><div class="line">		printer, err = NewTemplatePrinter(data)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, fmt.Errorf(<span class="string">"error parsing template %s, %v\n"</span>, <span class="keyword">string</span>(data), err)</div><div class="line">		&#125;</div><div class="line">	<span class="comment">//***kubectl get pods -o jsonpath=&#123;.items[*].metadata.name&#125;***//</span></div><div class="line">	<span class="keyword">case</span> <span class="string">"jsonpath"</span>:</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(formatArgument) == <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, fmt.Errorf(<span class="string">"jsonpath template format specified but no template given"</span>)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">var</span> err error</div><div class="line">		printer, err = NewJSONPathPrinter(formatArgument)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, fmt.Errorf(<span class="string">"error parsing jsonpath %s, %v\n"</span>, formatArgument, err)</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">case</span> <span class="string">"jsonpath-file"</span>:</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(formatArgument) == <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, fmt.Errorf(<span class="string">"jsonpath file format specified but no template file file given"</span>)</div><div class="line">		&#125;</div><div class="line">		data, err := ioutil.ReadFile(formatArgument)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, fmt.Errorf(<span class="string">"error reading template %s, %v\n"</span>, formatArgument, err)</div><div class="line">		&#125;</div><div class="line">		printer, err = NewJSONPathPrinter(<span class="keyword">string</span>(data))</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, fmt.Errorf(<span class="string">"error parsing template %s, %v\n"</span>, <span class="keyword">string</span>(data), err)</div><div class="line">		&#125;</div><div class="line">	<span class="comment">//***kubectl get pods -o custom-columns=Name:&#123;.metadata.name&#125;***//</span></div><div class="line">	<span class="keyword">case</span> <span class="string">"custom-columns"</span>:</div><div class="line">		<span class="keyword">var</span> err error</div><div class="line">		<span class="keyword">if</span> printer, err = NewCustomColumnsPrinterFromSpec(formatArgument, api.Codecs.UniversalDecoder(), noHeaders); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, err</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">case</span> <span class="string">"custom-columns-file"</span>:</div><div class="line">		file, err := os.Open(formatArgument)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, fmt.Errorf(<span class="string">"error reading template %s, %v\n"</span>, formatArgument, err)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">defer</span> file.Close()</div><div class="line">		<span class="keyword">if</span> printer, err = NewCustomColumnsPrinterFromTemplate(file, api.Codecs.UniversalDecoder()); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, err</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">case</span> <span class="string">"wide"</span>:</div><div class="line">		<span class="comment">//***之后的case会被执行，但default不会被执行***//</span></div><div class="line">		<span class="keyword">fallthrough</span></div><div class="line">	<span class="keyword">case</span> <span class="string">""</span>:</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, <span class="literal">nil</span></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, fmt.Errorf(<span class="string">"output format %q not recognized"</span>, format)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> printer, <span class="literal">true</span>, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在GetPrinter()函数中，根据传入的参数format，会生成不同类型的Printer。需要注意的是，除了”wide”, “”以外，其他的format类型都视为标准类型(generic)。非标准类型通常是和”人”相关，如”wide”和””最后都是由HumanReadablePrinter实现。</p>
<h2 id="JSONPrinter"><a href="#JSONPrinter" class="headerlink" title="JSONPrinter"></a>JSONPrinter</h2><p>JSONPrinter可以以JSON的格式打印Object。JSONPrinter调用了json.MarshalIndent()来对Obj进行JSON格式化打印。json.MarshalIndent()函数的功能和Marshal一致，只是把Object格式化成人性化阅读的JSON，有点类似”| python -mjson.tool”的功能。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// JSONPrinter is an implementation of ResourcePrinter which outputs an object as JSON.</span></div><div class="line"><span class="keyword">type</span> JSONPrinter <span class="keyword">struct</span> &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *JSONPrinter)</span> <span class="title">AfterPrint</span><span class="params">(w io.Writer, res <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// PrintObj is an implementation of ResourcePrinter.PrintObj which simply writes the object to the Writer.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *JSONPrinter)</span> <span class="title">PrintObj</span><span class="params">(obj runtime.Object, w io.Writer)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> obj := obj.(<span class="keyword">type</span>) &#123;</div><div class="line">	<span class="keyword">case</span> *runtime.Unknown:</div><div class="line">		<span class="keyword">var</span> buf bytes.Buffer</div><div class="line">		err := json.Indent(&amp;buf, obj.Raw, <span class="string">""</span>, <span class="string">"    "</span>)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		buf.WriteRune(<span class="string">'\n'</span>)</div><div class="line">		_, err = buf.WriteTo(w)</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	data, err := json.MarshalIndent(obj, <span class="string">""</span>, <span class="string">"    "</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	data = <span class="built_in">append</span>(data, <span class="string">'\n'</span>)</div><div class="line">	_, err = w.Write(data)</div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// <span class="doctag">TODO:</span> implement HandledResources()</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *JSONPrinter)</span> <span class="title">HandledResources</span><span class="params">()</span> []<span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> []<span class="keyword">string</span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用例子：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl get pods -o json</div></pre></td></tr></table></figure></p>
<h2 id="YAMLPrinter"><a href="#YAMLPrinter" class="headerlink" title="YAMLPrinter"></a>YAMLPrinter</h2><p>YAMLPrinter可以以YAML的格式打印Object。YAMLPrinter通过调用yaml.Marshal()把Object转换成YAML格式并进行打印。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// YAMLPrinter is an implementation of ResourcePrinter which outputs an object as YAML.</span></div><div class="line"><span class="comment">// The input object is assumed to be in the internal version of an API and is converted</span></div><div class="line"><span class="comment">// to the given version first.</span></div><div class="line"><span class="keyword">type</span> YAMLPrinter <span class="keyword">struct</span> &#123;</div><div class="line">	version   <span class="keyword">string</span></div><div class="line">	converter runtime.ObjectConvertor</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *YAMLPrinter)</span> <span class="title">AfterPrint</span><span class="params">(w io.Writer, res <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// PrintObj prints the data as YAML.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *YAMLPrinter)</span> <span class="title">PrintObj</span><span class="params">(obj runtime.Object, w io.Writer)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> obj := obj.(<span class="keyword">type</span>) &#123;</div><div class="line">	<span class="keyword">case</span> *runtime.Unknown:</div><div class="line">		data, err := yaml.JSONToYAML(obj.Raw)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		_, err = w.Write(data)</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***把obj转成yaml格式***//</span></div><div class="line">	output, err := yaml.Marshal(obj)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	_, err = fmt.Fprint(w, <span class="keyword">string</span>(output))</div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用例子：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl get pods -o yaml</div></pre></td></tr></table></figure></p>
<h2 id="NamePrinter"><a href="#NamePrinter" class="headerlink" title="NamePrinter"></a>NamePrinter</h2><p>NamePrinter可以打印资源类型和名称：如pod/ubuntu-ssh-589933015-2lhgb。NamePrinter先获判断Object是否为列表，如果是列表，则递归调用PrintObj；否则先获取Object的name，然后获取Object的Kind，并转换成单数形式的GVR，然后返回。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NamePrinter is an implementation of ResourcePrinter which outputs "resource/name" pair of an object.</span></div><div class="line"><span class="keyword">type</span> NamePrinter <span class="keyword">struct</span> &#123;</div><div class="line">	Decoder runtime.Decoder</div><div class="line">	Typer   runtime.ObjectTyper</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *NamePrinter)</span> <span class="title">AfterPrint</span><span class="params">(w io.Writer, res <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// PrintObj is an implementation of ResourcePrinter.PrintObj which decodes the object</span></div><div class="line"><span class="comment">// and print "resource/name" pair. If the object is a List, print all items in it.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *NamePrinter)</span> <span class="title">PrintObj</span><span class="params">(obj runtime.Object, w io.Writer)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> meta.IsListType(obj) &#123;</div><div class="line">		items, err := meta.ExtractList(obj)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> errs := runtime.DecodeList(items, p.Decoder, runtime.UnstructuredJSONScheme); <span class="built_in">len</span>(errs) &gt; <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> utilerrors.NewAggregate(errs)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> _, obj := <span class="keyword">range</span> items &#123;</div><div class="line">			<span class="keyword">if</span> err := p.PrintObj(obj, w); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	name := <span class="string">"&lt;unknown&gt;"</span></div><div class="line">	<span class="comment">//***获取name***//</span></div><div class="line">	<span class="keyword">if</span> acc, err := meta.Accessor(obj); err == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> n := acc.GetName(); <span class="built_in">len</span>(n) &gt; <span class="number">0</span> &#123;</div><div class="line">			name = n</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> kind := obj.GetObjectKind().GroupVersionKind(); <span class="built_in">len</span>(kind.Kind) == <span class="number">0</span> &#123;</div><div class="line">		<span class="comment">// this is the old code.  It's unnecessary on decoded external objects, but on internal objects</span></div><div class="line">		<span class="comment">// you may have to do it.  Tests are definitely calling it with internals and I'm not sure who else</span></div><div class="line">		<span class="comment">// is</span></div><div class="line">		<span class="keyword">if</span> gvks, _, err := p.Typer.ObjectKinds(obj); err == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="comment">// <span class="doctag">TODO:</span> this is wrong, it assumes that meta knows about all Kinds - should take a RESTMapper</span></div><div class="line">			_, resource := meta.KindToResource(gvks[<span class="number">0</span>])</div><div class="line">			fmt.Fprintf(w, <span class="string">"%s/%s\n"</span>, resource.Resource, name)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			fmt.Fprintf(w, <span class="string">"&lt;unknown&gt;/%s\n"</span>, name)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> this is wrong, it assumes that meta knows about all Kinds - should take a RESTMapper</span></div><div class="line">		<span class="comment">//***直接调用KindToResource()把GVK转换成GVR，并选用单数形式***//</span></div><div class="line">		_, resource := meta.KindToResource(kind)</div><div class="line">		fmt.Fprintf(w, <span class="string">"%s/%s\n"</span>, resource.Resource, name)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用例子：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> kubectl get pods -o name</div><div class="line">pod/nginx-1487191267-0t8x3</div><div class="line">pod/ubuntu-ssh-589933015-2lhgb</div></pre></td></tr></table></figure></p>
<h2 id="TemplatePrinter"><a href="#TemplatePrinter" class="headerlink" title="TemplatePrinter"></a>TemplatePrinter</h2><p>TemplatePrinter基于txt/template包实现。txt/template一般的用法为：<br>定义模板：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tmpl, err := template.New(<span class="string">"test"</span>).Parse(<span class="string">"hello, &#123;&#123;.&#125;&#125;"</span>)</div></pre></td></tr></table></figure></p>
<p>执行：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">err = tmpl.Execute(os.Stdout, name)</div></pre></td></tr></table></figure></p>
<p>TemplatePrinter定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// TemplatePrinter is an implementation of ResourcePrinter which formats data with a Go Template.</span></div><div class="line"><span class="comment">//***调用text/template包***//</span></div><div class="line"><span class="keyword">type</span> TemplatePrinter <span class="keyword">struct</span> &#123;</div><div class="line">	rawTemplate <span class="keyword">string</span></div><div class="line">	template    *template.Template</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTemplatePrinter</span><span class="params">(tmpl []<span class="keyword">byte</span>)</span> <span class="params">(*TemplatePrinter, error)</span></span> &#123;</div><div class="line">	t, err := template.New(<span class="string">"output"</span>).</div><div class="line">		Funcs(template.FuncMap&#123;<span class="string">"exists"</span>: exists&#125;).</div><div class="line">		Parse(<span class="keyword">string</span>(tmpl))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;TemplatePrinter&#123;</div><div class="line">		rawTemplate: <span class="keyword">string</span>(tmpl),</div><div class="line">		template:    t,</div><div class="line">	&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *TemplatePrinter)</span> <span class="title">AfterPrint</span><span class="params">(w io.Writer, res <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// PrintObj formats the obj with the Go Template.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *TemplatePrinter)</span> <span class="title">PrintObj</span><span class="params">(obj runtime.Object, w io.Writer)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> data []<span class="keyword">byte</span></div><div class="line">	<span class="keyword">var</span> err error</div><div class="line">	<span class="keyword">if</span> unstructured, ok := obj.(*runtime.Unstructured); ok &#123;</div><div class="line">		data, err = json.Marshal(unstructured.Object)</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		data, err = json.Marshal(obj)</div><div class="line"></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	out := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;&#125;</div><div class="line">	<span class="keyword">if</span> err := json.Unmarshal(data, &amp;out); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err = p.safeExecute(w, out); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// It is way easier to debug this stuff when it shows up in</span></div><div class="line">		<span class="comment">// stdout instead of just stdin. So in addition to returning</span></div><div class="line">		<span class="comment">// a nice error, also print useful stuff with the writer.</span></div><div class="line">		fmt.Fprintf(w, <span class="string">"Error executing template: %v. Printing more information for debugging the template:\n"</span>, err)</div><div class="line">		fmt.Fprintf(w, <span class="string">"\ttemplate was:\n\t\t%v\n"</span>, p.rawTemplate)</div><div class="line">		fmt.Fprintf(w, <span class="string">"\traw data was:\n\t\t%v\n"</span>, <span class="keyword">string</span>(data))</div><div class="line">		fmt.Fprintf(w, <span class="string">"\tobject given to template engine was:\n\t\t%+v\n\n"</span>, out)</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"error executing template %q: %v"</span>, p.rawTemplate, err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// <span class="doctag">TODO:</span> implement HandledResources()</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *TemplatePrinter)</span> <span class="title">HandledResources</span><span class="params">()</span> []<span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> []<span class="keyword">string</span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用例子：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> kubectl get pods nginx-1487191267-0t8x3 -o go-template="The name is &#123;&#123;.metadata.name&#125;&#125;"</div><div class="line">The name is nginx-1487191267-0t8x3</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> kubectl get pods nginx-1487191267-0t8x3 -o go-template-file=template </div><div class="line">The name is nginx-1487191267-0t8x3</div></pre></td></tr></table></figure></p>
<p>其中<code>go-template-file=template</code>的template为文件，内容为:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">The name is &#123;&#123;.metadata.name&#125;&#125;</div></pre></td></tr></table></figure></p>
<h2 id="JSONPathPrinter"><a href="#JSONPathPrinter" class="headerlink" title="JSONPathPrinter"></a>JSONPathPrinter</h2><p>JSONPathPrinter实现了一套匹配规则，详见<a href="https://kubernetes.io/docs/user-guide/jsonpath/。" target="_blank" rel="external">https://kubernetes.io/docs/user-guide/jsonpath/。</a><br>jsonpath具体在/pkg/util/jsonpath/jsonpath.go中实现，具体分析此处略。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// JSONPathPrinter is an implementation of ResourcePrinter which formats data with jsonpath expression.</span></div><div class="line"><span class="keyword">type</span> JSONPathPrinter <span class="keyword">struct</span> &#123;</div><div class="line">	rawTemplate <span class="keyword">string</span></div><div class="line">	*jsonpath.JSONPath</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewJSONPathPrinter</span><span class="params">(tmpl <span class="keyword">string</span>)</span> <span class="params">(*JSONPathPrinter, error)</span></span> &#123;</div><div class="line">	j := jsonpath.New(<span class="string">"out"</span>)</div><div class="line">	<span class="keyword">if</span> err := j.Parse(tmpl); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;JSONPathPrinter&#123;tmpl, j&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(j *JSONPathPrinter)</span> <span class="title">AfterPrint</span><span class="params">(w io.Writer, res <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// PrintObj formats the obj with the JSONPath Template.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(j *JSONPathPrinter)</span> <span class="title">PrintObj</span><span class="params">(obj runtime.Object, w io.Writer)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> queryObj <span class="keyword">interface</span>&#123;&#125; = obj</div><div class="line">	<span class="keyword">if</span> meta.IsListType(obj) &#123;</div><div class="line">		data, err := json.Marshal(obj)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		queryObj = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;&#125;</div><div class="line">		<span class="keyword">if</span> err := json.Unmarshal(data, &amp;queryObj); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> unknown, ok := obj.(*runtime.Unknown); ok &#123;</div><div class="line">		data, err := json.Marshal(unknown)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		queryObj = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;&#125;</div><div class="line">		<span class="keyword">if</span> err := json.Unmarshal(data, &amp;queryObj); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> unstructured, ok := obj.(*runtime.Unstructured); ok &#123;</div><div class="line">		queryObj = unstructured.Object</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := j.JSONPath.Execute(w, queryObj); err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Fprintf(w, <span class="string">"Error executing template: %v. Printing more information for debugging the template:\n"</span>, err)</div><div class="line">		fmt.Fprintf(w, <span class="string">"\ttemplate was:\n\t\t%v\n"</span>, j.rawTemplate)</div><div class="line">		fmt.Fprintf(w, <span class="string">"\tobject given to jsonpath engine was:\n\t\t%#v\n\n"</span>, queryObj)</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"error executing jsonpath %q: %v\n"</span>, j.rawTemplate, err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// <span class="doctag">TODO:</span> implement HandledResources()</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *JSONPathPrinter)</span> <span class="title">HandledResources</span><span class="params">()</span> []<span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> []<span class="keyword">string</span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用例子：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> kubectl get pods -o jsonpath=&#123;.items[*].metadata.name&#125;</div><div class="line">nginx-1487191267-0t8x3 ubuntu-ssh-589933015-2lhgb</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> kubectl get pods -o jsonpath-file=template</div><div class="line">nginx-1487191267-0t8x3 ubuntu-ssh-589933015-2lhgb</div></pre></td></tr></table></figure></p>
<p>其中<code>jsonpath-file=template</code>的template为文件，内容为:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;.items[*].metadata.name&#125;</div></pre></td></tr></table></figure></p>
<h2 id="CustomColumnsPrinter"><a href="#CustomColumnsPrinter" class="headerlink" title="CustomColumnsPrinter"></a>CustomColumnsPrinter</h2><p>CustomColumnsPrinter允许用户定义列名，是JSONPath的加强版。支持从命令行直接输入模板和从文件读取模板两种方式。</p>
<p>读取命令行模板的CustomColumnsPrinter生成函数如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***kubectl get pods -o custom-columns=Type:&#123;.kind&#125;,Name:&#123;.metadata.name&#125;***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCustomColumnsPrinterFromSpec</span><span class="params">(spec <span class="keyword">string</span>, decoder runtime.Decoder, noHeaders <span class="keyword">bool</span>)</span> <span class="params">(*CustomColumnsPrinter, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(spec) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"custom-columns format specified but no custom columns given"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***parts: [Type:&#123;.kind&#125; Name:&#123;.metadata.name&#125;]***//</span></div><div class="line">	parts := strings.Split(spec, <span class="string">","</span>)</div><div class="line">	columns := <span class="built_in">make</span>([]Column, <span class="built_in">len</span>(parts))</div><div class="line">	<span class="keyword">for</span> ix := <span class="keyword">range</span> parts &#123;</div><div class="line">		colSpec := strings.Split(parts[ix], <span class="string">":"</span>)</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(colSpec) != <span class="number">2</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unexpected custom-columns spec: %s, expected &lt;header&gt;:&lt;json-path-expr&gt;"</span>, parts[ix])</div><div class="line">		&#125;</div><div class="line">		spec, err := massageJSONPath(colSpec[<span class="number">1</span>])</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">		columns[ix] = Column&#123;Header: colSpec[<span class="number">0</span>], FieldSpec: spec&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;CustomColumnsPrinter&#123;Columns: columns, Decoder: decoder, NoHeaders: noHeaders&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>读取文件模板的CustomColumnsPrinter生成函数如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">//***kubectl get pods -o custom-columns-file=/home/fankang/template***//</div><div class="line">func NewCustomColumnsPrinterFromTemplate(templateReader io.Reader, decoder runtime.Decoder) (*CustomColumnsPrinter, error) &#123;</div><div class="line">	scanner := bufio.NewScanner(templateReader)</div><div class="line">	if !scanner.Scan() &#123;</div><div class="line">		return nil, fmt.Errorf(&quot;invalid template, missing header line. Expected format is one line of space separated headers, one line of space separated column specs.&quot;)</div><div class="line">	&#125;</div><div class="line">	//***headers: [Type Name]***//</div><div class="line">	headers := splitOnWhitespace(scanner.Text())</div><div class="line"></div><div class="line">	if !scanner.Scan() &#123;</div><div class="line">		return nil, fmt.Errorf(&quot;invalid template, missing spec line. Expected format is one line of space separated headers, one line of space separated column specs.&quot;)</div><div class="line">	&#125;</div><div class="line">	//***specs: [&#123;.kind&#125; &#123;.metadata.name&#125;]***//</div><div class="line">	specs := splitOnWhitespace(scanner.Text())</div><div class="line"></div><div class="line">	//***如果headers和specs长度不一致，则直接返回***//</div><div class="line">	if len(headers) != len(specs) &#123;</div><div class="line">		return nil, fmt.Errorf(&quot;number of headers (%d) and field specifications (%d) don&apos;t match&quot;, len(headers), len(specs))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	columns := make([]Column, len(headers))</div><div class="line">	for ix := range headers &#123;</div><div class="line">		spec, err := massageJSONPath(specs[ix])</div><div class="line">		if err != nil &#123;</div><div class="line">			return nil, err</div><div class="line">		&#125;</div><div class="line">		//***组装成Column***//</div><div class="line">		columns[ix] = Column&#123;</div><div class="line">			Header:    headers[ix],</div><div class="line">			FieldSpec: spec,</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	//***返回CustomColumnsPrinter***//</div><div class="line">	return &amp;CustomColumnsPrinter&#123;Columns: columns, Decoder: decoder, NoHeaders: false&#125;, nil</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>CustomColumnsPrinter的PrintObj()方法如下，可以看出，调用了jsonpath.New()来解析模板。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">func (s *CustomColumnsPrinter) PrintObj(obj runtime.Object, out io.Writer) error &#123;</div><div class="line">	w := tabwriter.NewWriter(out, columnwidth, tabwidth, padding, padding_character, flags)</div><div class="line"></div><div class="line">	if !s.NoHeaders &#123;</div><div class="line">		headers := make([]string, len(s.Columns))</div><div class="line">		for ix := range s.Columns &#123;</div><div class="line">			headers[ix] = s.Columns[ix].Header</div><div class="line">		&#125;</div><div class="line">		fmt.Fprintln(w, strings.Join(headers, &quot;\t&quot;))</div><div class="line">	&#125;</div><div class="line">	parsers := make([]*jsonpath.JSONPath, len(s.Columns))</div><div class="line">	for ix := range s.Columns &#123;</div><div class="line">		parsers[ix] = jsonpath.New(fmt.Sprintf(&quot;column%d&quot;, ix))</div><div class="line">		if err := parsers[ix].Parse(s.Columns[ix].FieldSpec); err != nil &#123;</div><div class="line">			return err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if meta.IsListType(obj) &#123;</div><div class="line">		objs, err := meta.ExtractList(obj)</div><div class="line">		if err != nil &#123;</div><div class="line">			return err</div><div class="line">		&#125;</div><div class="line">		for ix := range objs &#123;</div><div class="line">			if err := s.printOneObject(objs[ix], parsers, w); err != nil &#123;</div><div class="line">				return err</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; else &#123;</div><div class="line">		if err := s.printOneObject(obj, parsers, w); err != nil &#123;</div><div class="line">			return err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	return w.Flush()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用例子：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> kubectl get pods -o custom-columns=Type:&#123;.kind&#125;,Name:&#123;.metadata.name&#125;</div><div class="line">Type      Name</div><div class="line">Pod       nginx-1487191267-0t8x3</div><div class="line">Pod       ubuntu-ssh-589933015-2lhgb</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> kubectl get pods -o custom-columns-file=template</div><div class="line">Type      Name</div><div class="line">Pod       nginx-1487191267-0t8x3</div><div class="line">Pod       ubuntu-ssh-589933015-2lhgb</div></pre></td></tr></table></figure></p>
<p>其中<code>custom-columns-file=template</code>的template为文件，内容为:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Type              Name</div><div class="line">&#123;.kind&#125;           &#123;.metadata.name&#125;</div></pre></td></tr></table></figure></p>
<h2 id="VersionedPrinter"><a href="#VersionedPrinter" class="headerlink" title="VersionedPrinter"></a>VersionedPrinter</h2><p>VersionedPrinter是对其他Printer的封装，先把Object转换成对应版本的Object，然后再封装的Printer进行打印。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">// VersionedPrinter takes runtime objects and ensures they are converted to a given API version</div><div class="line">// prior to being passed to a nested printer.</div><div class="line">type VersionedPrinter struct &#123;</div><div class="line">	printer   ResourcePrinter</div><div class="line">	converter runtime.ObjectConvertor</div><div class="line">	versions  []unversioned.GroupVersion</div><div class="line">&#125;</div><div class="line"></div><div class="line">// NewVersionedPrinter wraps a printer to convert objects to a known API version prior to printing.</div><div class="line">func NewVersionedPrinter(printer ResourcePrinter, converter runtime.ObjectConvertor, versions ...unversioned.GroupVersion) ResourcePrinter &#123;</div><div class="line">	return &amp;VersionedPrinter&#123;</div><div class="line">		printer:   printer,</div><div class="line">		converter: converter,</div><div class="line">		versions:  versions,</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func (p *VersionedPrinter) AfterPrint(w io.Writer, res string) error &#123;</div><div class="line">	return nil</div><div class="line">&#125;</div><div class="line"></div><div class="line">// PrintObj implements ResourcePrinter</div><div class="line">func (p *VersionedPrinter) PrintObj(obj runtime.Object, w io.Writer) error &#123;</div><div class="line">	if len(p.versions) == 0 &#123;</div><div class="line">		return fmt.Errorf(&quot;no version specified, object cannot be converted&quot;)</div><div class="line">	&#125;</div><div class="line">	converted, err := p.converter.ConvertToVersion(obj, unversioned.GroupVersions(p.versions))</div><div class="line">	if err != nil &#123;</div><div class="line">		return err</div><div class="line">	&#125;</div><div class="line">	return p.printer.PrintObj(converted, w)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>version由<code>kubectl get pods --output-version=&#39;v1&#39; -o yaml -w</code>的–output-version指定，但没什么作用，而且kubectl get代码中只有Watch会使用VersionedPrinter，所以还待更深入的研究。</p>
<h2 id="HumanReadablePrinter"><a href="#HumanReadablePrinter" class="headerlink" title="HumanReadablePrinter"></a>HumanReadablePrinter</h2><p>HumanReadablePrinter可以”人性化”地输出内容。HumanReadablePrinter中有handlerMap，handlerMap记录了待打印的对象到处理函数的映射关系。系统中每种资源都有对应的打印函数。</p>
<p>其中<code>kubectl -o wide</code>调用的也是HumanReadablePrinter。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div></pre></td><td class="code"><pre><div class="line">type HumanReadablePrinter struct &#123;</div><div class="line">	handlerMap   map[reflect.Type]*handlerEntry</div><div class="line">	options      PrintOptions</div><div class="line">	lastType     reflect.Type</div><div class="line">	hiddenObjNum int</div><div class="line">&#125;</div><div class="line"></div><div class="line">// NewHumanReadablePrinter creates a HumanReadablePrinter.</div><div class="line">//***创建HumanReadablePrinter***//</div><div class="line">func NewHumanReadablePrinter(options PrintOptions) *HumanReadablePrinter &#123;</div><div class="line">	printer := &amp;HumanReadablePrinter&#123;</div><div class="line">		handlerMap: make(map[reflect.Type]*handlerEntry),</div><div class="line">		options:    options,</div><div class="line">	&#125;</div><div class="line">	printer.addDefaultHandlers()</div><div class="line">	return printer</div><div class="line">&#125;</div><div class="line"></div><div class="line">//***打印第一行标题***//</div><div class="line">func (h *HumanReadablePrinter) printHeader(columnNames []string, w io.Writer) error &#123;</div><div class="line">	if _, err := fmt.Fprintf(w, &quot;%s\n&quot;, strings.Join(columnNames, &quot;\t&quot;)); err != nil &#123;</div><div class="line">		return err</div><div class="line">	&#125;</div><div class="line">	return nil</div><div class="line">&#125;</div><div class="line"></div><div class="line">//***打印Pod***//</div><div class="line">func (h *HumanReadablePrinter) printPod(pod *api.Pod, w io.Writer, options PrintOptions) error &#123;</div><div class="line">	if err := printPodBase(pod, w, options); err != nil &#123;</div><div class="line">		return err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	return nil</div><div class="line">&#125;</div><div class="line"></div><div class="line">func printPodBase(pod *api.Pod, w io.Writer, options PrintOptions) error &#123;</div><div class="line">	name := formatResourceName(options.Kind, pod.Name, options.WithKind)</div><div class="line">	namespace := pod.Namespace</div><div class="line"></div><div class="line">	restarts := 0</div><div class="line">	totalContainers := len(pod.Spec.Containers)</div><div class="line">	readyContainers := 0</div><div class="line"></div><div class="line">	reason := string(pod.Status.Phase)</div><div class="line">	if pod.Status.Reason != &quot;&quot; &#123;</div><div class="line">		reason = pod.Status.Reason</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	initializing := false</div><div class="line">	for i := range pod.Status.InitContainerStatuses &#123;</div><div class="line">		container := pod.Status.InitContainerStatuses[i]</div><div class="line">		restarts += int(container.RestartCount)</div><div class="line">		switch &#123;</div><div class="line">		case container.State.Terminated != nil &amp;&amp; container.State.Terminated.ExitCode == 0:</div><div class="line">			continue</div><div class="line">		case container.State.Terminated != nil:</div><div class="line">			// initialization is failed</div><div class="line">			if len(container.State.Terminated.Reason) == 0 &#123;</div><div class="line">				if container.State.Terminated.Signal != 0 &#123;</div><div class="line">					reason = fmt.Sprintf(&quot;Init:Signal:%d&quot;, container.State.Terminated.Signal)</div><div class="line">				&#125; else &#123;</div><div class="line">					reason = fmt.Sprintf(&quot;Init:ExitCode:%d&quot;, container.State.Terminated.ExitCode)</div><div class="line">				&#125;</div><div class="line">			&#125; else &#123;</div><div class="line">				reason = &quot;Init:&quot; + container.State.Terminated.Reason</div><div class="line">			&#125;</div><div class="line">			initializing = true</div><div class="line">		case container.State.Waiting != nil &amp;&amp; len(container.State.Waiting.Reason) &gt; 0 &amp;&amp; container.State.Waiting.Reason != &quot;PodInitializing&quot;:</div><div class="line">			reason = &quot;Init:&quot; + container.State.Waiting.Reason</div><div class="line">			initializing = true</div><div class="line">		default:</div><div class="line">			reason = fmt.Sprintf(&quot;Init:%d/%d&quot;, i, len(pod.Spec.InitContainers))</div><div class="line">			initializing = true</div><div class="line">		&#125;</div><div class="line">		break</div><div class="line">	&#125;</div><div class="line">	if !initializing &#123;</div><div class="line">		restarts = 0</div><div class="line">		for i := len(pod.Status.ContainerStatuses) - 1; i &gt;= 0; i-- &#123;</div><div class="line">			container := pod.Status.ContainerStatuses[i]</div><div class="line"></div><div class="line">			restarts += int(container.RestartCount)</div><div class="line">			if container.State.Waiting != nil &amp;&amp; container.State.Waiting.Reason != &quot;&quot; &#123;</div><div class="line">				reason = container.State.Waiting.Reason</div><div class="line">			&#125; else if container.State.Terminated != nil &amp;&amp; container.State.Terminated.Reason != &quot;&quot; &#123;</div><div class="line">				reason = container.State.Terminated.Reason</div><div class="line">			&#125; else if container.State.Terminated != nil &amp;&amp; container.State.Terminated.Reason == &quot;&quot; &#123;</div><div class="line">				if container.State.Terminated.Signal != 0 &#123;</div><div class="line">					reason = fmt.Sprintf(&quot;Signal:%d&quot;, container.State.Terminated.Signal)</div><div class="line">				&#125; else &#123;</div><div class="line">					reason = fmt.Sprintf(&quot;ExitCode:%d&quot;, container.State.Terminated.ExitCode)</div><div class="line">				&#125;</div><div class="line">			&#125; else if container.Ready &amp;&amp; container.State.Running != nil &#123;</div><div class="line">				readyContainers++</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if pod.DeletionTimestamp != nil &amp;&amp; pod.Status.Reason == node.NodeUnreachablePodReason &#123;</div><div class="line">		reason = &quot;Unknown&quot;</div><div class="line">	&#125; else if pod.DeletionTimestamp != nil &#123;</div><div class="line">		reason = &quot;Terminating&quot;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if options.WithNamespace &#123;</div><div class="line">		if _, err := fmt.Fprintf(w, &quot;%s\t&quot;, namespace); err != nil &#123;</div><div class="line">			return err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	if _, err := fmt.Fprintf(w, &quot;%s\t%d/%d\t%s\t%d\t%s&quot;,</div><div class="line">		name,</div><div class="line">		readyContainers,</div><div class="line">		totalContainers,</div><div class="line">		reason,</div><div class="line">		restarts,</div><div class="line">		translateTimestamp(pod.CreationTimestamp),</div><div class="line">	); err != nil &#123;</div><div class="line">		return err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	//***-o wide则写入IP和NODE***//</div><div class="line">	if options.Wide &#123;</div><div class="line">		nodeName := pod.Spec.NodeName</div><div class="line">		podIP := pod.Status.PodIP</div><div class="line">		if podIP == &quot;&quot; &#123;</div><div class="line">			podIP = &quot;&lt;none&gt;&quot;</div><div class="line">		&#125;</div><div class="line">		if _, err := fmt.Fprintf(w, &quot;\t%s\t%s&quot;,</div><div class="line">			podIP,</div><div class="line">			nodeName,</div><div class="line">		); err != nil &#123;</div><div class="line">			return err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if _, err := fmt.Fprint(w, AppendLabels(pod.Labels, options.ColumnLabels)); err != nil &#123;</div><div class="line">		return err</div><div class="line">	&#125;</div><div class="line">	if _, err := fmt.Fprint(w, AppendAllLabels(options.ShowLabels, pod.Labels)); err != nil &#123;</div><div class="line">		return err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	return nil</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用例子：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> kubectl get pods</div><div class="line">NAME                         READY     STATUS    RESTARTS   AGE</div><div class="line">nginx-1487191267-0t8x3       1/1       Running   2          1d</div><div class="line">ubuntu-ssh-589933015-2lhgb   1/1       Running   21         19d</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> kubectl get pods -o wide</div><div class="line">NAME                         READY     STATUS    RESTARTS   AGE       IP           NODE</div><div class="line">nginx-1487191267-0t8x3       1/1       Running   2          1d        172.17.0.4   fankang</div><div class="line">ubuntu-ssh-589933015-2lhgb   1/1       Running   21         19d       172.17.0.5   fankang</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/19/Kubectl概念解读(五)-Printer-v1-5-2/" data-id="cj5ule847000aecqsixgm73lk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Kubectl概念解读(四)-Mapper-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/15/Kubectl概念解读(四)-Mapper-v1-5-2/" class="article-date">
  <time datetime="2017-07-15T12:51:16.000Z" itemprop="datePublished">2017-07-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/15/Kubectl概念解读(四)-Mapper-v1-5-2/">Kubectl概念解读(四)-Mapper-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是Mapper"><a href="#什么是Mapper" class="headerlink" title="什么是Mapper"></a>什么是Mapper</h2><p>这里的Mapper是指kubectl中的Mapper，是对ObjectTyper, RESTMapper, ClientMapper和Decoder的封装。Mapper定义在/pkg/kubectl/resource/mapper.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Mapper <span class="keyword">struct</span> &#123;</div><div class="line">	runtime.ObjectTyper</div><div class="line">	meta.RESTMapper</div><div class="line">	<span class="comment">//***定义在/pkg/kubectl/resource/interfaces.go中***//</span></div><div class="line">	<span class="comment">//***ClientMapper可以根据config和mapping通过调用ClientForMapping()生成RESTClient***//</span></div><div class="line">	ClientMapper</div><div class="line">	runtime.Decoder</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由于Mapper嵌入了很多涉及其他模块的结构体，所以我们这次的分析仅分析到这些对象是如何生成的，细节将放到其他模块的分析中。</p>
<h2 id="生成Mapper"><a href="#生成Mapper" class="headerlink" title="生成Mapper"></a>生成Mapper</h2><p>一切得从/pkg/kubectl/cmd/util/factory.go的NewBuilder()方法说起。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *factory)</span> <span class="title">NewBuilder</span><span class="params">()</span> *<span class="title">resource</span>.<span class="title">Builder</span></span> &#123;</div><div class="line">	mapper, typer := f.Object()</div><div class="line">	<span class="comment">//***此处有kubectl mapper的各项参数的定义***//</span></div><div class="line">	<span class="comment">//***其中Decoder为f.Decoder(true)***//</span></div><div class="line">	<span class="keyword">return</span> resource.NewBuilder(mapper, typer, resource.ClientMapperFunc(f.ClientForMapping), f.Decoder(<span class="literal">true</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再来看/pkg/kubectl/ressourcce/builder.go中的NewBuilder():<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewBuilder creates a builder that operates on generic objects.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBuilder</span><span class="params">(mapper meta.RESTMapper, typer runtime.ObjectTyper, clientMapper ClientMapper, decoder runtime.Decoder)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;Builder&#123;</div><div class="line">		<span class="comment">//***把RESTMapper, ObjectTyper, ClientMapper, Decoder封装成kubectl的Mapper***//</span></div><div class="line">		mapper:        &amp;Mapper&#123;typer, mapper, clientMapper, decoder&#125;,</div><div class="line">		requireObject: <span class="literal">true</span>,</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，Mapper的创建在builder.go中，但真正准备创建Mapper的其他结构体的地方还是在factory.go中。</p>
<ul>
<li>runtime.ObjectTyper: 由f.Object()生成；</li>
<li>meta.RESTMapper: 由f.Object()生成；</li>
<li>ClientMapper: resource.ClientMapperFunc(f.ClientForMapping)</li>
<li>runtime.Decoder: f.Decoder(true)</li>
</ul>
<h3 id="f-Object"><a href="#f-Object" class="headerlink" title="f.Object()"></a>f.Object()</h3><p>Object()返回一个RESTMapper及api.Scheme。这里api.Scheme将传递给Typer。关于RESTMapper，现在只需知道存储了GVK和GVR的关系，可以通过RESTMapping()返回一个mapping表示GVK和Resource的关系。可以用mapping生成一个config，再生成Client。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *factory)</span> <span class="title">Object</span><span class="params">()</span> <span class="params">(meta.RESTMapper, runtime.ObjectTyper)</span></span> &#123;</div><div class="line">	<span class="comment">//***registered.RESTMapper()定义在/pkg/apimachinery/registerd/registered.go中***//</span></div><div class="line">	mapper := registered.RESTMapper()</div><div class="line">	<span class="comment">//***生成discoveryClient***//</span></div><div class="line">	discoveryClient, err := f.DiscoveryClient()</div><div class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">//***discoveryClient生成成功的情况下，mapper为一个FistHitRESTMapper***//</span></div><div class="line">		mapper = meta.FirstHitRESTMapper&#123;</div><div class="line">			MultiRESTMapper: meta.MultiRESTMapper&#123;</div><div class="line">				discovery.NewDeferredDiscoveryRESTMapper(discoveryClient, registered.InterfacesFor),</div><div class="line">				registered.RESTMapper(), <span class="comment">// hardcoded fall back</span></div><div class="line">			&#125;,</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// wrap with shortcuts</span></div><div class="line">	mapper = NewShortcutExpander(mapper, discoveryClient)</div><div class="line"></div><div class="line">	<span class="comment">// wrap with output preferences</span></div><div class="line">	cfg, err := f.clients.ClientConfigForVersion(<span class="literal">nil</span>)</div><div class="line">	checkErrWithPrefix(<span class="string">"failed to get client config: "</span>, err)</div><div class="line">	cmdApiVersion := unversioned.GroupVersion&#123;&#125;</div><div class="line">	<span class="keyword">if</span> cfg.GroupVersion != <span class="literal">nil</span> &#123;</div><div class="line">		cmdApiVersion = *cfg.GroupVersion</div><div class="line">	&#125;</div><div class="line">	mapper = kubectl.OutputVersionMapper&#123;RESTMapper: mapper, OutputVersions: []unversioned.GroupVersion&#123;cmdApiVersion&#125;&#125;</div><div class="line">	<span class="keyword">return</span> mapper, api.Scheme</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="f-ClientForMapping"><a href="#f-ClientForMapping" class="headerlink" title="f.ClientForMapping()"></a>f.ClientForMapping()</h3><p>CLientForMapping()可以依据mapping中的信息生成一个config，然后再生成RESTClient。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***依据mapping生成RESTClient***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *factory)</span> <span class="title">ClientForMapping</span><span class="params">(mapping *meta.RESTMapping)</span> <span class="params">(resource.RESTClient, error)</span></span> &#123;</div><div class="line">	cfg, err := f.clientConfig.ClientConfig()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := client.SetKubernetesDefaults(cfg); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	gvk := mapping.GroupVersionKind</div><div class="line">	<span class="keyword">switch</span> gvk.Group &#123;</div><div class="line">	<span class="keyword">case</span> federation.GroupName:</div><div class="line">		mappingVersion := mapping.GroupVersionKind.GroupVersion()</div><div class="line">		<span class="keyword">return</span> f.clients.FederationClientForVersion(&amp;mappingVersion)</div><div class="line">	<span class="keyword">case</span> api.GroupName:</div><div class="line">		cfg.APIPath = <span class="string">"/api"</span></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		cfg.APIPath = <span class="string">"/apis"</span></div><div class="line">	&#125;</div><div class="line">	gv := gvk.GroupVersion()</div><div class="line">	cfg.GroupVersion = &amp;gv</div><div class="line">	<span class="keyword">if</span> registered.IsThirdPartyAPIGroupVersion(gvk.GroupVersion()) &#123;</div><div class="line">		cfg.NegotiatedSerializer = thirdpartyresourcedata.NewNegotiatedSerializer(api.Codecs, gvk.Kind, gv, gv)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***定义在/pkg/client/restclient/config.go***//</span></div><div class="line">	<span class="keyword">return</span> restclient.RESTClientFor(cfg)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而resource.ClientMapperFunc定义在/pkg/kubectl/resource/interfaces.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ClientMapperFunc <span class="function"><span class="keyword">func</span><span class="params">(mapping *meta.RESTMapping)</span> <span class="params">(RESTClient, error)</span></span></div><div class="line"></div><div class="line">// <span class="title">ClientForMapping</span> <span class="title">implements</span> <span class="title">ClientMapper</span></div><div class="line"><span class="title">func</span> <span class="params">(f ClientMapperFunc)</span> <span class="title">ClientForMapping</span><span class="params">(mapping *meta.RESTMapping)</span> <span class="params">(RESTClient, error)</span> &#123;</div><div class="line">	<span class="keyword">return</span> f(mapping)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以，调用ClientMapper的ClientForMapping()方法就相关于调用factory的ClientForMapping()方法。</p>
<h3 id="f-Decoder"><a href="#f-Decoder" class="headerlink" title="f.Decoder()"></a>f.Decoder()</h3><p>Decoder()定义在/pkg/kubectl/cmd/util/factory.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *factory)</span> <span class="title">Decoder</span><span class="params">(toInternal <span class="keyword">bool</span>)</span> <span class="title">runtime</span>.<span class="title">Decoder</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> decoder runtime.Decoder</div><div class="line">	<span class="keyword">if</span> toInternal &#123;</div><div class="line">		<span class="comment">//***api.Codecs定义在pkg/api/register.go中***//</span></div><div class="line">		decoder = api.Codecs.UniversalDecoder()</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		decoder = api.Codecs.UniversalDeserializer()</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> thirdpartyresourcedata.NewDecoder(decoder, <span class="string">""</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>因为传入的toInternal为true，所以Decoder为api.Codecs.UniversalDecoder()。这里不再向下分析，只需知道该Decoder可以把相关版本的对象转换成内部版本的对象。</p>
<h2 id="RESTMapping"><a href="#RESTMapping" class="headerlink" title="RESTMapping()"></a>RESTMapping()</h2><p>调用的RESTMapper的RESTMapping()。RESTMapper的RESTMapping()前面已经介绍过。</p>
<h2 id="ClientForMapping"><a href="#ClientForMapping" class="headerlink" title="ClientForMapping()"></a>ClientForMapping()</h2><p>调用的就是f.ClientForMapping()，前面已经介绍过。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/15/Kubectl概念解读(四)-Mapper-v1-5-2/" data-id="cj5ule84i000cecqshvhk1593" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Kubectl概念解读(三)-Info,Result,Helper-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/15/Kubectl概念解读(三)-Info,Result,Helper-v1-5-2/" class="article-date">
  <time datetime="2017-07-15T11:25:01.000Z" itemprop="datePublished">2017-07-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/15/Kubectl概念解读(三)-Info,Result,Helper-v1-5-2/">Kubectl概念解读(三)-Info,Result,Helper-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h1><h2 id="什么是Info"><a href="#什么是Info" class="headerlink" title="什么是Info"></a>什么是Info</h2><p>之前我们说过，Visitor可以生成Info或处理Info。那么到底什么是Info呢？Info定义在/pkg/kubectl/resource/visitor.go中，与Visitor定义在一个文件中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Info contains temporary info to execute a REST call, or show the results</span></div><div class="line"><span class="comment">// of an already completed REST call.</span></div><div class="line"><span class="comment">//***Info用来存储REST的返回结果***//</span></div><div class="line"><span class="keyword">type</span> Info <span class="keyword">struct</span> &#123;</div><div class="line">	Client    RESTClient</div><div class="line">	Mapping   *meta.RESTMapping</div><div class="line">	Namespace <span class="keyword">string</span></div><div class="line">	Name      <span class="keyword">string</span></div><div class="line"></div><div class="line">	<span class="comment">// Optional, Source is the filename or URL to template file (.json or .yaml),</span></div><div class="line">	<span class="comment">// or stdin to use to handle the resource</span></div><div class="line">	Source <span class="keyword">string</span></div><div class="line">	<span class="comment">// Optional, this is the provided object in a versioned type before defaulting</span></div><div class="line">	<span class="comment">// and conversions into its corresponding internal type. This is useful for</span></div><div class="line">	<span class="comment">// reflecting on user intent which may be lost after defaulting and conversions.</span></div><div class="line">	VersionedObject <span class="keyword">interface</span>&#123;&#125;</div><div class="line">	<span class="comment">// Optional, this is the most recent value returned by the server if available</span></div><div class="line">	runtime.Object</div><div class="line">	<span class="comment">// Optional, this is the most recent resource version the server knows about for</span></div><div class="line">	<span class="comment">// this type of resource. It may not match the resource version of the object,</span></div><div class="line">	<span class="comment">// but if set it should be equal to or newer than the resource version of the</span></div><div class="line">	<span class="comment">// object (however the server defines resource version).</span></div><div class="line">	ResourceVersion <span class="keyword">string</span></div><div class="line">	<span class="comment">// Optional, should this resource be exported, stripped of cluster-specific and instance specific fields</span></div><div class="line">	Export <span class="keyword">bool</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，Info包含了REST请求需要的信息及REST的返回结果runtime.Object。</p>
<h2 id="Visit"><a href="#Visit" class="headerlink" title="Visit()"></a>Visit()</h2><p>由于Info也实现了Visit()，所以Info也可以称得上是一个Visitor。Info的Visit()方法比较简单，仅仅调用VisitorFunc，参数为自身及nil。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i *Info)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> fn(i, <span class="literal">nil</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Get"><a href="#Get" class="headerlink" title="Get()"></a>Get()</h2><p>Get()调用Helper依据Info中的信息获取obj，并更新到Info的Object字段。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Get retrieves the object from the Namespace and Name fields</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i *Info)</span> <span class="title">Get</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</div><div class="line">	<span class="comment">//***NewHelper的用法***//</span></div><div class="line">	obj, err := NewHelper(i.Client, i.Mapping).Get(i.Namespace, i.Name, i.Export)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> errors.IsNotFound(err) &amp;&amp; <span class="built_in">len</span>(i.Namespace) &gt; <span class="number">0</span> &amp;&amp; i.Namespace != api.NamespaceDefault &amp;&amp; i.Namespace != api.NamespaceAll &#123;</div><div class="line">			err2 := i.Client.Get().AbsPath(<span class="string">"api"</span>, <span class="string">"v1"</span>, <span class="string">"namespaces"</span>, i.Namespace).Do().Error()</div><div class="line">			<span class="keyword">if</span> err2 != <span class="literal">nil</span> &amp;&amp; errors.IsNotFound(err2) &#123;</div><div class="line">				<span class="keyword">return</span> err2</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***更新i.Object和i.ResourceVersion***//</span></div><div class="line">	i.Object = obj</div><div class="line">	i.ResourceVersion, _ = i.Mapping.MetadataAccessor.ResourceVersion(obj)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Refresh"><a href="#Refresh" class="headerlink" title="Refresh()"></a>Refresh()</h2><p>Refresh()把已经存在的obj更新到Info的Object。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***把一个object更新到info中***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i *Info)</span> <span class="title">Refresh</span><span class="params">(obj runtime.Object, ignoreError <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	name, err := i.Mapping.MetadataAccessor.Name(obj)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> !ignoreError &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		i.Name = name</div><div class="line">	&#125;</div><div class="line">	namespace, err := i.Mapping.MetadataAccessor.Namespace(obj)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> !ignoreError &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		i.Namespace = namespace</div><div class="line">	&#125;</div><div class="line">	version, err := i.Mapping.MetadataAccessor.ResourceVersion(obj)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> !ignoreError &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		i.ResourceVersion = version</div><div class="line">	&#125;</div><div class="line">	i.Object = obj</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h1><h2 id="什么是Result"><a href="#什么是Result" class="headerlink" title="什么是Result"></a>什么是Result</h2><p>之前我们提过，Builder的Do()可以返回Result。现在让我们来看看Result的定义，Result定义在/pkg/kubectl/resource/result.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Result contains helper methods for dealing with the outcome of a Builder.</span></div><div class="line"><span class="keyword">type</span> Result <span class="keyword">struct</span> &#123;</div><div class="line">	err     error</div><div class="line">	visitor Visitor</div><div class="line"></div><div class="line">	sources  []Visitor</div><div class="line">	singular <span class="keyword">bool</span></div><div class="line"></div><div class="line">	ignoreErrors []utilerrors.Matcher</div><div class="line"></div><div class="line">	<span class="comment">// populated by a call to Infos</span></div><div class="line">	info []*Info</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，Result也包含一个visitor，及一个info表示[]*Info，所以Result提供了Infos()方法来获取Visitor的结果Info数组及Object()方法来获取Visitor的结果Obj(可能为List)。</p>
<h2 id="Infos"><a href="#Infos" class="headerlink" title="Infos()"></a>Infos()</h2><p>Info()调用层层封装的visitor，然后收集所有info并返回。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Result)</span> <span class="title">Infos</span><span class="params">()</span> <span class="params">([]*Info, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, r.err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> r.info != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r.info, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	infos := []*Info&#123;&#125;</div><div class="line">	<span class="comment">//***此处可以领略匿名函数的魅力***//</span></div><div class="line">	err := r.visitor.Visit(<span class="function"><span class="keyword">func</span><span class="params">(info *Info, err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		infos = <span class="built_in">append</span>(infos, info)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;)</div><div class="line">	err = utilerrors.FilterOut(err, r.ignoreErrors...)</div><div class="line"></div><div class="line">	r.info, r.err = infos, err</div><div class="line">	<span class="keyword">return</span> infos, err</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Object"><a href="#Object" class="headerlink" title="Object()"></a>Object()</h2><p>Object()先调用Infos()来获取infos，然后从每个info中提取出Object组成ObjectList返回。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Result)</span> <span class="title">Object</span><span class="params">()</span> <span class="params">(runtime.Object, error)</span></span> &#123;</div><div class="line">	infos, err := r.Infos()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	versions := sets.String&#123;&#125;</div><div class="line">	objects := []runtime.Object&#123;&#125;</div><div class="line">	<span class="keyword">for</span> _, info := <span class="keyword">range</span> infos &#123;</div><div class="line">		<span class="keyword">if</span> info.Object != <span class="literal">nil</span> &#123;</div><div class="line">			objects = <span class="built_in">append</span>(objects, info.Object)</div><div class="line">			versions.Insert(info.ResourceVersion)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(objects) == <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">if</span> r.singular &#123;</div><div class="line">			<span class="keyword">return</span> objects[<span class="number">0</span>], <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">// if the item is a list already, don't create another list</span></div><div class="line">		<span class="keyword">if</span> meta.IsListType(objects[<span class="number">0</span>]) &#123;</div><div class="line">			<span class="keyword">return</span> objects[<span class="number">0</span>], <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	version := <span class="string">""</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(versions) == <span class="number">1</span> &#123;</div><div class="line">		version = versions.List()[<span class="number">0</span>]</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;api.List&#123;</div><div class="line">		ListMeta: unversioned.ListMeta&#123;</div><div class="line">			ResourceVersion: version,</div><div class="line">		&#125;,</div><div class="line">		Items: objects,</div><div class="line">	&#125;, err</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Helper"><a href="#Helper" class="headerlink" title="Helper"></a>Helper</h1><h2 id="什么是Helper"><a href="#什么是Helper" class="headerlink" title="什么是Helper"></a>什么是Helper</h2><p>在Kubernetes中，Helper一般都提供类似驱动的功能。Kubectl的helper就是用来访问Client的驱动。一般来说，某个visitFunc函数中会调用Helper的相关成员函数来完成具体请求。</p>
<p>Helper定义在/pkg/kubectl/resource/helper.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Helper provides methods for retrieving or mutating a RESTful</span></div><div class="line"><span class="comment">// resource.</span></div><div class="line"><span class="keyword">type</span> Helper <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// The name of this resource as the server would recognize it</span></div><div class="line">	Resource <span class="keyword">string</span></div><div class="line">	<span class="comment">// A RESTClient capable of mutating this resource.</span></div><div class="line">	RESTClient RESTClient</div><div class="line">	<span class="comment">// An interface for reading or writing the resource version of this</span></div><div class="line">	<span class="comment">// type.</span></div><div class="line">	Versioner runtime.ResourceVersioner</div><div class="line">	<span class="comment">// True if the resource type is scoped to namespaces</span></div><div class="line">	NamespaceScoped <span class="keyword">bool</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Helper实现了Get(), List(), Watch(), WatchSingle(), Delete(), Create(), Patch(), Replace()等方法，这些方法是对RESTClient的封装，所以待以后分析了RESTClient之后，这些方法的实现就很容易明白，这里就不展开了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/15/Kubectl概念解读(三)-Info,Result,Helper-v1-5-2/" data-id="cj5ule83w0006ecqs90w4jv2r" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Kubectl概念解读(二)-Visitor-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/15/Kubectl概念解读(二)-Visitor-v1-5-2/" class="article-date">
  <time datetime="2017-07-15T05:44:23.000Z" itemprop="datePublished">2017-07-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/15/Kubectl概念解读(二)-Visitor-v1-5-2/">Kubectl概念解读(二)-Visitor-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是Visitor"><a href="#什么是Visitor" class="headerlink" title="什么是Visitor"></a>什么是Visitor</h2><p>Visitor定义在/pkg/kubectl/resource/visitor.go中。我们先来看visitor的定义：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Visitor <span class="keyword">interface</span> &#123;</div><div class="line">	Visit(VisitorFunc) error</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> VisitorFunc <span class="function"><span class="keyword">func</span><span class="params">(*Info, error)</span> <span class="title">error</span></span></div></pre></td></tr></table></figure></p>
<p>可以看出，只要实现了Visit(VisitorFunc) error方法的结构体都可以称为Visitor，相当简洁。</p>
<p>其中VisitorFunc的参数为*Info及error，所以可以推断，VisitorFunc()可以对Info及Error进行处理。</p>
<p>Visitor最大的特性就是每个Visitor实现了一个特性，然后可以嵌套使用。Visitor可以分为两类，第一类是生成info，第二类是处理info。我们现在先记着info是用来存储REST请求的返回结果的。</p>
<p>产生info的visitor有：FileVisitor, StreamVisitor, URLVisitor, Selector。</p>
<p>处理info的visitor有：VisitorList, EagerVisitorList, DecoratedVisitor, ContinueOnErrorVisitor, FlattenListVisitor, FlattenListVisitor等。此处需要说明下，有些Visitor只处理了Error，但我们仍把它归为处理info的Visitor。</p>
<p>一般来说，如果info已经生成，那么Visitor嵌套中的Visitor只要info处理Visitor即可；如果没有info，则最里面的Visitor要在fn()调用之前生成info，以供其他Visitor处理。</p>
<h2 id="Visitor嵌套原理"><a href="#Visitor嵌套原理" class="headerlink" title="Visitor嵌套原理"></a>Visitor嵌套原理</h2><p>先来看一个Visitor的定义：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***修饰作用***//</span></div><div class="line"><span class="keyword">type</span> DecoratedVisitor <span class="keyword">struct</span> &#123;</div><div class="line">	visitor    Visitor</div><div class="line">	decorators []VisitorFunc</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Visit implements Visitor</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v DecoratedVisitor)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> v.visitor.Visit(<span class="function"><span class="keyword">func</span><span class="params">(info *Info, err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***使用decorator对info进行处理***//</span></div><div class="line">		<span class="keyword">for</span> i := <span class="keyword">range</span> v.decorators &#123;</div><div class="line">			<span class="keyword">if</span> err := v.decorators[i](info, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> fn(info, <span class="literal">nil</span>)</div><div class="line">	&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>一般来说，一个Visitor(父Visitor)结构体中包含另一个Visitor(子Visitor)。父Visitor中的Visit()方法会调用子Visitor的Visit()方法，并传入一个匿名的visitorFunc，这个匿名的visitorFunc在子Visitor看来就是fn。</p>
<p>再来看下Visitor如何嵌套使用，下面代码摘自/pkg/kubectl/resource/builder.go中的Do()函数：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">	<span class="keyword">if</span> b.continueOnError &#123;</div><div class="line">		r.visitor = ContinueOnErrorVisitor&#123;r.visitor&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>嵌套也很简单，就是用一个Visitor去封装另一个Visitor。</p>
<p>所以可以仿照代码写个Demo:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Visitor <span class="keyword">interface</span> &#123;</div><div class="line">	Visit(VisitorFunc) error</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> VisitorFunc <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span></div><div class="line"></div><div class="line"><span class="title">type</span> <span class="title">Visitor1</span> <span class="title">struct</span> &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l Visitor1)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"In Visitor1 before fn"</span>)</div><div class="line">	fn()</div><div class="line">	fmt.Println(<span class="string">"In Visitor1 after fn"</span>)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Visitor2 <span class="keyword">struct</span> &#123;</div><div class="line">	visitor Visitor</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l Visitor2)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> l.visitor.Visit(<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">		fmt.Println(<span class="string">"In Visitor2 before fn"</span>)</div><div class="line">		fn()</div><div class="line">		fmt.Println(<span class="string">"In Visitor2 after fn"</span>)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Visitor3 <span class="keyword">struct</span> &#123;</div><div class="line">	visitor Visitor</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l Visitor3)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> l.visitor.Visit(<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">		fmt.Println(<span class="string">"In Visitor3 before fn"</span>)</div><div class="line">		fn()</div><div class="line">		fmt.Println(<span class="string">"In Visitor3 after fn"</span>)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> visitor Visitor = <span class="built_in">new</span>(Visitor1)</div><div class="line">	visitor = Visitor2&#123;visitor&#125;</div><div class="line">	visitor = Visitor3&#123;visitor&#125;</div><div class="line">	visitor.Visit(<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">		fmt.Println(<span class="string">"In visitFunc"</span>)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Demo中把Visitor定义的visitFunc代码分为”before fn”和”after fn”。来看执行结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">In Visitor1 before fn</div><div class="line">In Visitor2 before fn</div><div class="line">In Visitor3 before fn</div><div class="line">In visitFunc</div><div class="line">In Visitor3 after fn</div><div class="line">In Visitor2 after fn</div><div class="line">In Visitor1 after fn</div></pre></td></tr></table></figure></p>
<p>所以可以看出，virsitor3{visitor2{visitor1}}顺序下，最先执行的是Visitor1中visitFunc的fn()之前的代码，然后是Visitor2和VIsitor3中fn()之前的代码。接着执行visitor3中的visitFunc。最后又按visitor3，visitor2，visitor1的顺序执行fn()后的代码。通俗地讲，外边的Visitor的visitorFunc会嵌入到里边Visitor的fn处。</p>
<p>在Kubectl中，还有类VisitorList的Visitor。我们再来看个更复杂的Demo:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Visitor <span class="keyword">interface</span> &#123;</div><div class="line">	Visit(VisitorFunc) error</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> VisitorFunc <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span></div><div class="line"></div><div class="line"><span class="title">type</span> <span class="title">VisitorList</span> []<span class="title">Visitor</span></div><div class="line"></div><div class="line"><span class="title">func</span> <span class="params">(l VisitorList)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> l &#123;</div><div class="line">		<span class="keyword">if</span> err := l[i].Visit(<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">			fmt.Println(<span class="string">"In VisitorList before fn"</span>)</div><div class="line">			fn()</div><div class="line">			fmt.Println(<span class="string">"In VisitorList after fn"</span>)</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Visitor1 <span class="keyword">struct</span> &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l Visitor1)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"In Visitor1 before fn"</span>)</div><div class="line">	fn()</div><div class="line">	fmt.Println(<span class="string">"In Visitor1 after fn"</span>)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Visitor2 <span class="keyword">struct</span> &#123;</div><div class="line">	visitor Visitor</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l Visitor2)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"In Visitor2 before Visit"</span>)</div><div class="line">	l.visitor.Visit(<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">		fmt.Println(<span class="string">"In Visitor2 before fn"</span>)</div><div class="line">		fn()</div><div class="line">		fmt.Println(<span class="string">"In Visitor2 after fn"</span>)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;)</div><div class="line">	fmt.Println(<span class="string">"In Visitor2 before Visit"</span>)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Visitor3 <span class="keyword">struct</span> &#123;</div><div class="line">	visitor Visitor</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l Visitor3)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"In Visitor3 before Visit"</span>)</div><div class="line">	l.visitor.Visit(<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">		fmt.Println(<span class="string">"In Visitor3 before fn"</span>)</div><div class="line">		fn()</div><div class="line">		fmt.Println(<span class="string">"In Visitor3 after fn"</span>)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;)</div><div class="line">	fmt.Println(<span class="string">"In Visitor3 after Visit"</span>)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> visitor Visitor = <span class="built_in">new</span>(Visitor1)</div><div class="line">	<span class="keyword">var</span> visitors []Visitor</div><div class="line">	visitors = <span class="built_in">append</span>(visitors, visitor)</div><div class="line">	visitors = <span class="built_in">append</span>(visitors, visitor)</div><div class="line">	visitor = Visitor2&#123;VisitorList(visitors)&#125;</div><div class="line">	visitor = Visitor3&#123;visitor&#125;</div><div class="line">	visitor.Visit(<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">		fmt.Println(<span class="string">"In visitFunc"</span>)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>执行结果为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">In Visitor3 before Visit</div><div class="line">In Visitor2 before Visit</div><div class="line">In Visitor1 before fn</div><div class="line">In VisitorList before fn</div><div class="line">In Visitor2 before fn</div><div class="line">In Visitor3 before fn</div><div class="line">In visitFunc</div><div class="line">In Visitor3 after fn</div><div class="line">In Visitor2 after fn</div><div class="line">In VisitorList after fn</div><div class="line">In Visitor1 after fn</div><div class="line">In Visitor1 before fn</div><div class="line">In VisitorList before fn</div><div class="line">In Visitor2 before fn</div><div class="line">In Visitor3 before fn</div><div class="line">In visitFunc</div><div class="line">In Visitor3 after fn</div><div class="line">In Visitor2 after fn</div><div class="line">In VisitorList after fn</div><div class="line">In Visitor1 after fn</div><div class="line">In Visitor2 before Visit</div><div class="line">In Visitor3 after Visit</div></pre></td></tr></table></figure></p>
<p>添加了visitorList后，由于visitorList包含两个visitor1，相当于visitorList外边的Visitor被嵌入到Visitor1中两次，所以，整个打印过程执行了两次，且visitorList中定义的函数内容会在visitor1和visitor2之间执行。</p>
<p>而visitFunc之前的代码的是先执行最外面的Visitor，再执行里面的Visitor；visitFunc之后的代码是先执行最里面的Visitor，再执行外面的Visitor。</p>
<h2 id="VisitorList"><a href="#VisitorList" class="headerlink" title="VisitorList"></a>VisitorList</h2><p>VisitorList包含多个visitor，在迭代包含的visitor时，一遇到错误就返回。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> VisitorList []Visitor</div><div class="line"></div><div class="line"><span class="comment">// Visit implements Visitor</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l VisitorList)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> l &#123;</div><div class="line">		<span class="keyword">if</span> err := l[i].Visit(fn); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="EagerVisitorList"><a href="#EagerVisitorList" class="headerlink" title="EagerVisitorList"></a>EagerVisitorList</h2><p>EagerVisitorList在迭代包含的visitor时，遇到错误会断续迭代，最后一起返回所有错误。</p>
<p>此处可以体会下匿名函数的魅力，所以匿名函数中的err都会被收集到EagerVisitorList的Visit()方法中的errs中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> EagerVisitorList []Visitor</div><div class="line"></div><div class="line"><span class="comment">// Visit implements Visitor, and gathers errors that occur during processing until</span></div><div class="line"><span class="comment">// all sub visitors have been visited.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l EagerVisitorList)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	errs := []error(<span class="literal">nil</span>)</div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> l &#123;</div><div class="line">		<span class="keyword">if</span> err := l[i].Visit(<span class="function"><span class="keyword">func</span><span class="params">(info *Info, err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				errs = <span class="built_in">append</span>(errs, err)</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> err := fn(info, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">				errs = <span class="built_in">append</span>(errs, err)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;); err != <span class="literal">nil</span> &#123;</div><div class="line">			errs = <span class="built_in">append</span>(errs, err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> utilerrors.NewAggregate(errs)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="URLVisitor"><a href="#URLVisitor" class="headerlink" title="URLVisitor"></a>URLVisitor</h2><p>URLVisitor获取指定URL的内容，并对内容进行格式检查，然后把内容转换为info。URL封装了StreamVisitor。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> URLVisitor <span class="keyword">struct</span> &#123;</div><div class="line">	URL *url.URL</div><div class="line">	*StreamVisitor</div><div class="line">	HttpAttemptCount <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *URLVisitor)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	body, err := readHttpWithRetries(httpgetImpl, time.Second, v.URL.String(), v.HttpAttemptCount)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> body.Close()</div><div class="line">	v.StreamVisitor.Reader = body</div><div class="line">	<span class="keyword">return</span> v.StreamVisitor.Visit(fn)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="DecoratedVisitor"><a href="#DecoratedVisitor" class="headerlink" title="DecoratedVisitor"></a>DecoratedVisitor</h2><p>DecoratedVisitor会调用decorators对info和err进行处理。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> DecoratedVisitor <span class="keyword">struct</span> &#123;</div><div class="line">	visitor    Visitor</div><div class="line">	decorators []VisitorFunc</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NewDecoratedVisitor will create a visitor that invokes the provided visitor functions before</span></div><div class="line"><span class="comment">// the user supplied visitor function is invoked, giving them the opportunity to mutate the Info</span></div><div class="line"><span class="comment">// object or terminate early with an error.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDecoratedVisitor</span><span class="params">(v Visitor, fn ...VisitorFunc)</span> <span class="title">Visitor</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(fn) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> v</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> DecoratedVisitor&#123;v, fn&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Visit implements Visitor</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v DecoratedVisitor)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> v.visitor.Visit(<span class="function"><span class="keyword">func</span><span class="params">(info *Info, err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***使用decorator对info进行处理***//</span></div><div class="line">		<span class="keyword">for</span> i := <span class="keyword">range</span> v.decorators &#123;</div><div class="line">			<span class="keyword">if</span> err := v.decorators[i](info, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> fn(info, <span class="literal">nil</span>)</div><div class="line">	&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ContinueOnErrorVisitor"><a href="#ContinueOnErrorVisitor" class="headerlink" title="ContinueOnErrorVisitor"></a>ContinueOnErrorVisitor</h2><p>ContinueOnErrorVisitor会收集子Visitor产生的错误，并返回。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ContinueOnErrorVisitor <span class="keyword">struct</span> &#123;</div><div class="line">	Visitor</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v ContinueOnErrorVisitor)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	errs := []error&#123;&#125;</div><div class="line">	err := v.Visitor.Visit(<span class="function"><span class="keyword">func</span><span class="params">(info *Info, err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			errs = <span class="built_in">append</span>(errs, err)</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***此处传入fn的错误是nil***//</span></div><div class="line">		<span class="keyword">if</span> err := fn(info, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">			errs = <span class="built_in">append</span>(errs, err)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		errs = <span class="built_in">append</span>(errs, err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(errs) == <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">return</span> errs[<span class="number">0</span>]</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> utilerrors.NewAggregate(errs)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="FlattenListVisitor"><a href="#FlattenListVisitor" class="headerlink" title="FlattenListVisitor"></a>FlattenListVisitor</h2><p>FlattenListVisitor可以对列表中的每个元素进行处理。如果有错误发生，则返回。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> FlattenListVisitor <span class="keyword">struct</span> &#123;</div><div class="line">	Visitor</div><div class="line">	*Mapper</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NewFlattenListVisitor creates a visitor that will expand list style runtime.Objects</span></div><div class="line"><span class="comment">// into individual items and then visit them individually.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewFlattenListVisitor</span><span class="params">(v Visitor, mapper *Mapper)</span> <span class="title">Visitor</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> FlattenListVisitor&#123;v, mapper&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v FlattenListVisitor)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> v.Visitor.Visit(<span class="function"><span class="keyword">func</span><span class="params">(info *Info, err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> info.Object == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> fn(info, <span class="literal">nil</span>)</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***提取列表***//</span></div><div class="line">		items, err := meta.ExtractList(info.Object)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> fn(info, <span class="literal">nil</span>)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> errs := runtime.DecodeList(items, <span class="keyword">struct</span> &#123;</div><div class="line">			runtime.ObjectTyper</div><div class="line">			runtime.Decoder</div><div class="line">		&#125;&#123;v.Mapper, v.Mapper.Decoder&#125;); <span class="built_in">len</span>(errs) &gt; <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> utilerrors.NewAggregate(errs)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// If we have a GroupVersionKind on the list, prioritize that when asking for info on the objects contained in the list</span></div><div class="line">		<span class="keyword">var</span> preferredGVKs []unversioned.GroupVersionKind</div><div class="line">		<span class="keyword">if</span> info.Mapping != <span class="literal">nil</span> &amp;&amp; !info.Mapping.GroupVersionKind.Empty() &#123;</div><div class="line">			preferredGVKs = <span class="built_in">append</span>(preferredGVKs, info.Mapping.GroupVersionKind)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//***对列表中每一个元素进行下一步处理***//</span></div><div class="line">		<span class="keyword">for</span> i := <span class="keyword">range</span> items &#123;</div><div class="line">			item, err := v.InfoForObject(items[i], preferredGVKs)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(info.ResourceVersion) != <span class="number">0</span> &#123;</div><div class="line">				item.ResourceVersion = info.ResourceVersion</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> err := fn(item, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="FileVisitor"><a href="#FileVisitor" class="headerlink" title="FileVisitor"></a>FileVisitor</h2><p>FileVisitor用来访问文件，并生成Info。FileVisitor是对StreamVisitor的封装。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> FileVisitor <span class="keyword">struct</span> &#123;</div><div class="line">	Path <span class="keyword">string</span></div><div class="line">	*StreamVisitor</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Visit in a FileVisitor is just taking care of opening/closing files</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *FileVisitor)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> f *os.File</div><div class="line">	<span class="keyword">if</span> v.Path == constSTDINstr &#123;</div><div class="line">		f = os.Stdin</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">var</span> err error</div><div class="line">		<span class="keyword">if</span> f, err = os.Open(v.Path); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> f.Close()</div><div class="line">	v.StreamVisitor.Reader = f</div><div class="line"></div><div class="line">	<span class="keyword">return</span> v.StreamVisitor.Visit(fn)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="StreamVisitor"><a href="#StreamVisitor" class="headerlink" title="StreamVisitor"></a>StreamVisitor</h2><p>StreamVisitor 从io.reader中获取数据流，然后转换成json格式，最后进行schema检查，封装成info对象<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> StreamVisitor <span class="keyword">struct</span> &#123;</div><div class="line">	io.Reader</div><div class="line">	*Mapper</div><div class="line"></div><div class="line">	Source <span class="keyword">string</span></div><div class="line">	Schema validation.Schema</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NewStreamVisitor is a helper function that is useful when we want to change the fields of the struct but keep calls the same.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewStreamVisitor</span><span class="params">(r io.Reader, mapper *Mapper, source <span class="keyword">string</span>, schema validation.Schema)</span> *<span class="title">StreamVisitor</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;StreamVisitor&#123;</div><div class="line">		Reader: r,</div><div class="line">		Mapper: mapper,</div><div class="line">		Source: source,</div><div class="line">		Schema: schema,</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Visit implements Visitor over a stream. StreamVisitor is able to distinct multiple resources in one stream.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *StreamVisitor)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	d := yaml.NewYAMLOrJSONDecoder(v.Reader, <span class="number">4096</span>)</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		ext := runtime.RawExtension&#123;&#125;</div><div class="line">		<span class="comment">//***StreamVisitor使用NewYAMLOrJSONDecoder（定义在/pkg/util/yaml/decoder.go中）对YAML进行解析***//</span></div><div class="line">		<span class="keyword">if</span> err := d.Decode(&amp;ext); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> err == io.EOF &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> This needs to be able to handle object in other encodings and schemas.</span></div><div class="line">		ext.Raw = bytes.TrimSpace(ext.Raw)</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(ext.Raw) == <span class="number">0</span> || bytes.Equal(ext.Raw, []<span class="keyword">byte</span>(<span class="string">"null"</span>)) &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err := ValidateSchema(ext.Raw, v.Schema); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"error validating %q: %v"</span>, v.Source, err)</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***调用InfoForData()（在mapper.go中）生成info信息***//</span></div><div class="line">		<span class="comment">//***在InfoForData中会把json对象转换成对应的struct类型***//</span></div><div class="line">		info, err := v.InfoForData(ext.Raw, v.Source)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> fnErr := fn(info, err); fnErr != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> fnErr</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err := fn(info, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="FilteredVisitor"><a href="#FilteredVisitor" class="headerlink" title="FilteredVisitor"></a>FilteredVisitor</h2><p>FilteredVisitor可以检查info是否满足某些条件。如果满足条件，则往下执行，否则返回err。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> FilteredVisitor <span class="keyword">struct</span> &#123;</div><div class="line">	visitor Visitor</div><div class="line">	filters []FilterFunc</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewFilteredVisitor</span><span class="params">(v Visitor, fn ...FilterFunc)</span> <span class="title">Visitor</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(fn) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> v</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> FilteredVisitor&#123;v, fn&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v FilteredVisitor)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> v.visitor.Visit(<span class="function"><span class="keyword">func</span><span class="params">(info *Info, err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> _, filter := <span class="keyword">range</span> v.filters &#123;</div><div class="line">			ok, err := filter(info, <span class="literal">nil</span>)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> !ok &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> fn(info, <span class="literal">nil</span>)</div><div class="line">	&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/15/Kubectl概念解读(二)-Visitor-v1-5-2/" data-id="cj5ule83z0007ecqs8pvkubg5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Kubectl概念解读(一)-Builder-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/15/Kubectl概念解读(一)-Builder-v1-5-2/" class="article-date">
  <time datetime="2017-07-15T02:14:58.000Z" itemprop="datePublished">2017-07-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/15/Kubectl概念解读(一)-Builder-v1-5-2/">Kubectl概念解读(一)-Builder-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="resource目录下的概念们"><a href="#resource目录下的概念们" class="headerlink" title="resource目录下的概念们"></a>resource目录下的概念们</h2><p>在看Kubectl的源码时，最头痛的是/pkg/kubectl/resource目录下各种概念。什么是builder，什么是info，什么是visitor。。。如果了解了这些概念，再来看Kubectl源码，那么就能起到事半功倍的效果。本次先对Builder进行较深程度的分析，然后分批次介绍其他概念。概念的理解可能带有一些主观的色彩，还请包涵。</p>
<h2 id="什么是Builder"><a href="#什么是Builder" class="headerlink" title="什么是Builder"></a>什么是Builder</h2><p>Builder定义在/pkg/kubectl/resource/builder.go中。Builder是Kubectl命令行信息的内部载体，可以通过Builder生成Result对象(后续介绍)。Builder大多方法支持链式调用，即<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">resource.NewBuilder(mapper, typer, resource.ClientMapperFunc(f.UnstructuredClientForMapping), runtime.UnstructuredJSONScheme).</div><div class="line">		NamespaceParam(cmdNamespace).DefaultNamespace().AllNamespaces(allNamespaces).</div><div class="line">		FilenameParam(enforceNamespace, &amp;options.FilenameOptions).</div><div class="line">		SelectorParam(selector).</div><div class="line">		ExportParam(export).</div><div class="line">		ResourceTypeOrNameArgs(<span class="literal">true</span>, args...).</div><div class="line">		ContinueOnError().</div><div class="line">		Latest().</div><div class="line">		Flatten().</div><div class="line">		Do()</div></pre></td></tr></table></figure></p>
<p>这是因为这些方法返回的对象自身。</p>
<p>先来看下Builder的定义。Builder中有一个mapper(后续介绍)，然后就是一些资源方面的字段，这些资源字段都有方法对其进行设置。其中，resources需要和names或selector配合使用。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Builder provides convenience functions for taking arguments and parameters</span></div><div class="line"><span class="comment">// from the command line and converting them to a list of resources to iterate</span></div><div class="line"><span class="comment">// over using the Visitor interface.</span></div><div class="line"><span class="keyword">type</span> Builder <span class="keyword">struct</span> &#123;</div><div class="line">	mapper *Mapper</div><div class="line"></div><div class="line">	errs []error</div><div class="line"></div><div class="line">	paths  []Visitor</div><div class="line">	stream <span class="keyword">bool</span></div><div class="line">	dir    <span class="keyword">bool</span></div><div class="line"></div><div class="line">	selector  labels.Selector</div><div class="line">	selectAll <span class="keyword">bool</span></div><div class="line"></div><div class="line">	resources []<span class="keyword">string</span></div><div class="line"></div><div class="line">	namespace    <span class="keyword">string</span></div><div class="line">	allNamespace <span class="keyword">bool</span></div><div class="line">	names        []<span class="keyword">string</span></div><div class="line"></div><div class="line">	resourceTuples []resourceTuple</div><div class="line"></div><div class="line">	defaultNamespace <span class="keyword">bool</span></div><div class="line">	requireNamespace <span class="keyword">bool</span></div><div class="line"></div><div class="line">	flatten <span class="keyword">bool</span></div><div class="line">	latest  <span class="keyword">bool</span></div><div class="line"></div><div class="line">	requireObject <span class="keyword">bool</span></div><div class="line"></div><div class="line">	singleResourceType <span class="keyword">bool</span></div><div class="line">	continueOnError    <span class="keyword">bool</span></div><div class="line"></div><div class="line">	singular <span class="keyword">bool</span></div><div class="line"></div><div class="line">	export <span class="keyword">bool</span></div><div class="line"></div><div class="line">	schema validation.Schema</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="NewBuilder"><a href="#NewBuilder" class="headerlink" title="NewBuilder()"></a>NewBuilder()</h2><p>NewBuilder()生成一个Builder，新的Builder只设置了mapper，及标记requireObject为true。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBuilder</span><span class="params">(mapper meta.RESTMapper, typer runtime.ObjectTyper, clientMapper ClientMapper, decoder runtime.Decoder)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;Builder&#123;</div><div class="line">		<span class="comment">//***把RESTMapper, ObjectTyper, ClientMapper, Decoder封装成kubectl的Mapper***//</span></div><div class="line">		mapper:        &amp;Mapper&#123;typer, mapper, clientMapper, decoder&#125;,</div><div class="line">		requireObject: <span class="literal">true</span>,</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Do"><a href="#Do" class="headerlink" title="Do()"></a>Do()</h2><p>Do()先调用visitorResult()生成Result对象，然后设置Result对象中的visitor。现在我们必需牢记，Builder的Do()可以生成Result。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***返回一个*Result，Result可以使Infos()或Object()来获取执行结果***//</span></div><div class="line"><span class="comment">//***关于visitor层层封装，可以理解为每个visitor实现一定的功能，然后按一定的顺序来执行这些功能***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Do</span><span class="params">()</span> *<span class="title">Result</span></span> &#123;</div><div class="line">	r := b.visitorResult()</div><div class="line">	<span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***层层封装visitor***//</span></div><div class="line">	<span class="keyword">if</span> b.flatten &#123;</div><div class="line">		r.visitor = NewFlattenListVisitor(r.visitor, b.mapper)</div><div class="line">	&#125;</div><div class="line">	helpers := []VisitorFunc&#123;&#125;</div><div class="line">	<span class="keyword">if</span> b.defaultNamespace &#123;</div><div class="line">		helpers = <span class="built_in">append</span>(helpers, SetNamespace(b.namespace))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> b.requireNamespace &#123;</div><div class="line">		helpers = <span class="built_in">append</span>(helpers, RequireNamespace(b.namespace))</div><div class="line">	&#125;</div><div class="line">	helpers = <span class="built_in">append</span>(helpers, FilterNamespace)</div><div class="line">	<span class="keyword">if</span> b.requireObject &#123;</div><div class="line">		helpers = <span class="built_in">append</span>(helpers, RetrieveLazy)</div><div class="line">	&#125;</div><div class="line">	r.visitor = NewDecoratedVisitor(r.visitor, helpers...)</div><div class="line">	<span class="keyword">if</span> b.continueOnError &#123;</div><div class="line">		r.visitor = ContinueOnErrorVisitor&#123;r.visitor&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="visitResult"><a href="#visitResult" class="headerlink" title="visitResult()"></a>visitResult()</h2><p>visitResult()会根据Builder中字段的设置情况来生成不同的Result。一般来说b.paths, b.selectors, b.resourceTuples, b.names只需设置一个即可。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***返回一个result对象***//</span></div><div class="line"><span class="comment">//***visitByPaths()等会生成info对象***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">visitorResult</span><span class="params">()</span> *<span class="title">Result</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(b.errs) &gt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> &amp;Result&#123;err: utilerrors.NewAggregate(b.errs)&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***设置selector为labels.Everything()***//</span></div><div class="line">	<span class="keyword">if</span> b.selectAll &#123;</div><div class="line">		b.selector = labels.Everything()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// visit items specified by paths</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(b.paths) != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> b.visitByPaths()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// visit selectors</span></div><div class="line">	<span class="keyword">if</span> b.selector != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> b.visitBySelector()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// visit items specified by resource and name</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(b.resourceTuples) != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> b.visitByResource()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// visit items specified by name</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(b.names) != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> b.visitByName()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(b.resources) != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> &amp;Result&#123;err: fmt.Errorf(<span class="string">"resource(s) were provided, but no name, label selector, or --all flag specified"</span>)&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;Result&#123;err: missingResourceError&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="visitBySelector"><a href="#visitBySelector" class="headerlink" title="visitBySelector()"></a>visitBySelector()</h2><p>visitBySelector()生成一个Selector visitor，然后把该visitor封装成Result并返回。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">//***selector visitor的visitFunc会生成info***//</div><div class="line">func (b *Builder) visitBySelector() *Result &#123;</div><div class="line">	if len(b.names) != 0 &#123;</div><div class="line">		return &amp;Result&#123;err: fmt.Errorf(&quot;name cannot be provided when a selector is specified&quot;)&#125;</div><div class="line">	&#125;</div><div class="line">	if len(b.resourceTuples) != 0 &#123;</div><div class="line">		return &amp;Result&#123;err: fmt.Errorf(&quot;selectors and the all flag cannot be used when passing resource/name arguments&quot;)&#125;</div><div class="line">	&#125;</div><div class="line">	if len(b.resources) == 0 &#123;</div><div class="line">		return &amp;Result&#123;err: fmt.Errorf(&quot;at least one resource must be specified to use a selector&quot;)&#125;</div><div class="line">	&#125;</div><div class="line">	mappings, err := b.resourceMappings()</div><div class="line">	if err != nil &#123;</div><div class="line">		return &amp;Result&#123;err: err&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	visitors := []Visitor&#123;&#125;</div><div class="line">	for _, mapping := range mappings &#123;</div><div class="line">		//***生成client***//</div><div class="line">		client, err := b.mapper.ClientForMapping(mapping)</div><div class="line">		if err != nil &#123;</div><div class="line">			return &amp;Result&#123;err: err&#125;</div><div class="line">		&#125;</div><div class="line">		selectorNamespace := b.namespace</div><div class="line">		if mapping.Scope.Name() != meta.RESTScopeNameNamespace &#123;</div><div class="line">			selectorNamespace = &quot;&quot;</div><div class="line">		&#125;</div><div class="line">		visitors = append(visitors, NewSelector(client, mapping, selectorNamespace, b.selector, b.export))</div><div class="line">	&#125;</div><div class="line">	if b.continueOnError &#123;</div><div class="line">		return &amp;Result&#123;visitor: EagerVisitorList(visitors), sources: visitors&#125;</div><div class="line">	&#125;</div><div class="line">	return &amp;Result&#123;visitor: VisitorList(visitors), sources: visitors&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="visitByResource"><a href="#visitByResource" class="headerlink" title="visitByResource()"></a>visitByResource()</h2><p>visitByResource()使用resourceTuples生成Info(后续介绍)，Info本身也是个visitor，所以把Info打包成Result并返回。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">//***通过resource生成info***//</div><div class="line">func (b *Builder) visitByResource() *Result &#123;</div><div class="line">	// if b.singular is false, this could be by default, so double-check length</div><div class="line">	// of resourceTuples to determine if in fact it is singular or not</div><div class="line">	isSingular := b.singular</div><div class="line">	if !isSingular &#123;</div><div class="line">		isSingular = len(b.resourceTuples) == 1</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if len(b.resources) != 0 &#123;</div><div class="line">		return &amp;Result&#123;singular: isSingular, err: fmt.Errorf(&quot;you may not specify individual resources and bulk resources in the same call&quot;)&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	// retrieve one client for each resource</div><div class="line">	mappings, err := b.resourceTupleMappings()</div><div class="line">	if err != nil &#123;</div><div class="line">		return &amp;Result&#123;singular: isSingular, err: err&#125;</div><div class="line">	&#125;</div><div class="line">	clients := make(map[string]RESTClient)</div><div class="line">	for _, mapping := range mappings &#123;</div><div class="line">		s := fmt.Sprintf(&quot;%s/%s&quot;, mapping.GroupVersionKind.GroupVersion().String(), mapping.Resource)</div><div class="line">		if _, ok := clients[s]; ok &#123;</div><div class="line">			continue</div><div class="line">		&#125;</div><div class="line">		client, err := b.mapper.ClientForMapping(mapping)</div><div class="line">		if err != nil &#123;</div><div class="line">			return &amp;Result&#123;err: err&#125;</div><div class="line">		&#125;</div><div class="line">		clients[s] = client</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	items := []Visitor&#123;&#125;</div><div class="line">	for _, tuple := range b.resourceTuples &#123;</div><div class="line">		mapping, ok := mappings[tuple.Resource]</div><div class="line">		if !ok &#123;</div><div class="line">			return &amp;Result&#123;singular: isSingular, err: fmt.Errorf(&quot;resource %q is not recognized: %v&quot;, tuple.Resource, mappings)&#125;</div><div class="line">		&#125;</div><div class="line">		s := fmt.Sprintf(&quot;%s/%s&quot;, mapping.GroupVersionKind.GroupVersion().String(), mapping.Resource)</div><div class="line">		client, ok := clients[s]</div><div class="line">		if !ok &#123;</div><div class="line">			return &amp;Result&#123;singular: isSingular, err: fmt.Errorf(&quot;could not find a client for resource %q&quot;, tuple.Resource)&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		selectorNamespace := b.namespace</div><div class="line">		if mapping.Scope.Name() != meta.RESTScopeNameNamespace &#123;</div><div class="line">			selectorNamespace = &quot;&quot;</div><div class="line">		&#125; else &#123;</div><div class="line">			if len(b.namespace) == 0 &#123;</div><div class="line">				errMsg := &quot;namespace may not be empty when retrieving a resource by name&quot;</div><div class="line">				if b.allNamespace &#123;</div><div class="line">					errMsg = &quot;a resource cannot be retrieved by name across all namespaces&quot;</div><div class="line">				&#125;</div><div class="line">				return &amp;Result&#123;singular: isSingular, err: fmt.Errorf(errMsg)&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		//***生成info***//</div><div class="line">		info := NewInfo(client, mapping, selectorNamespace, tuple.Name, b.export)</div><div class="line">		items = append(items, info)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	var visitors Visitor</div><div class="line">	if b.continueOnError &#123;</div><div class="line">		visitors = EagerVisitorList(items)</div><div class="line">	&#125; else &#123;</div><div class="line">		visitors = VisitorList(items)</div><div class="line">	&#125;</div><div class="line">	return &amp;Result&#123;singular: isSingular, visitor: visitors, sources: items&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="visitByName"><a href="#visitByName" class="headerlink" title="visitByName()"></a>visitByName()</h2><p>visitByName()先通过b.names来生成info，然后封装成Result返回。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***kubectl get pods nginx-1487191267-47z76走此函数***//</span></div><div class="line"><span class="comment">//***通过resource name生成info***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">visitByName</span><span class="params">()</span> *<span class="title">Result</span></span> &#123;</div><div class="line">	isSingular := <span class="built_in">len</span>(b.names) == <span class="number">1</span></div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(b.paths) != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> &amp;Result&#123;singular: isSingular, err: fmt.Errorf(<span class="string">"when paths, URLs, or stdin is provided as input, you may not specify a resource by arguments as well"</span>)&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(b.resources) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> &amp;Result&#123;singular: isSingular, err: fmt.Errorf(<span class="string">"you must provide a resource and a resource name together"</span>)&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(b.resources) &gt; <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">return</span> &amp;Result&#123;singular: isSingular, err: fmt.Errorf(<span class="string">"you must specify only one resource"</span>)&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mappings, err := b.resourceMappings()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> &amp;Result&#123;singular: isSingular, err: err&#125;</div><div class="line">	&#125;</div><div class="line">	mapping := mappings[<span class="number">0</span>]</div><div class="line"></div><div class="line">	client, err := b.mapper.ClientForMapping(mapping)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> &amp;Result&#123;err: err&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	selectorNamespace := b.namespace</div><div class="line">	<span class="keyword">if</span> mapping.Scope.Name() != meta.RESTScopeNameNamespace &#123;</div><div class="line">		selectorNamespace = <span class="string">""</span></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(b.namespace) == <span class="number">0</span> &#123;</div><div class="line">			errMsg := <span class="string">"namespace may not be empty when retrieving a resource by name"</span></div><div class="line">			<span class="keyword">if</span> b.allNamespace &#123;</div><div class="line">				errMsg = <span class="string">"a resource cannot be retrieved by name across all namespaces"</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> &amp;Result&#123;singular: isSingular, err: fmt.Errorf(errMsg)&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	visitors := []Visitor&#123;&#125;</div><div class="line">	<span class="keyword">for</span> _, name := <span class="keyword">range</span> b.names &#123;</div><div class="line">		<span class="comment">//***生成info***//</span></div><div class="line">		info := NewInfo(client, mapping, selectorNamespace, name, b.export)</div><div class="line">		visitors = <span class="built_in">append</span>(visitors, info)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;Result&#123;singular: isSingular, visitor: VisitorList(visitors), sources: visitors&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="visitByPaths"><a href="#visitByPaths" class="headerlink" title="visitByPaths()"></a>visitByPaths()</h2><p>visitByPaths()根据b.Paths生成Results。因为b.Paths本身就是个visitor数组。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***Paths中的visitor会生成info***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">visitByPaths</span><span class="params">()</span> *<span class="title">Result</span></span> &#123;</div><div class="line">	singular := !b.dir &amp;&amp; !b.stream &amp;&amp; <span class="built_in">len</span>(b.paths) == <span class="number">1</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(b.resources) != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> &amp;Result&#123;singular: singular, err: fmt.Errorf(<span class="string">"when paths, URLs, or stdin is provided as input, you may not specify resource arguments as well"</span>)&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(b.names) != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> &amp;Result&#123;err: fmt.Errorf(<span class="string">"name cannot be provided when a path is specified"</span>)&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(b.resourceTuples) != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> &amp;Result&#123;err: fmt.Errorf(<span class="string">"resource/name arguments cannot be provided when a path is specified"</span>)&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> visitors Visitor</div><div class="line">	<span class="keyword">if</span> b.continueOnError &#123;</div><div class="line">		<span class="comment">//***此处path也是visitor***//</span></div><div class="line">		<span class="comment">//***FileVisitor, StreamVisitor会生成info***//</span></div><div class="line">		visitors = EagerVisitorList(b.paths)</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		visitors = VisitorList(b.paths)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// only items from disk can be refetched</span></div><div class="line">	<span class="keyword">if</span> b.latest &#123;</div><div class="line">		<span class="comment">// must flatten lists prior to fetching</span></div><div class="line">		<span class="keyword">if</span> b.flatten &#123;</div><div class="line">			visitors = NewFlattenListVisitor(visitors, b.mapper)</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// must set namespace prior to fetching</span></div><div class="line">		<span class="keyword">if</span> b.defaultNamespace &#123;</div><div class="line">			visitors = NewDecoratedVisitor(visitors, SetNamespace(b.namespace))</div><div class="line">		&#125;</div><div class="line">		visitors = NewDecoratedVisitor(visitors, RetrieveLatest)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> b.selector != <span class="literal">nil</span> &#123;</div><div class="line">		visitors = NewFilteredVisitor(visitors, FilterBySelector(b.selector))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;Result&#123;singular: singular, visitor: visitors, sources: b.paths&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来介绍Builder的字段设置函数。</p>
<h2 id="Schema"><a href="#Schema" class="headerlink" title="Schema()"></a>Schema()</h2><p>Schema()设置Builder的schema字段。schema可以对资源名称进行规范检查。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Schema</span><span class="params">(schema validation.Schema)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	b.schema = schema</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="FilenameParam"><a href="#FilenameParam" class="headerlink" title="FilenameParam()"></a>FilenameParam()</h2><p>FilenameParam()可以处理不同的输入方式，并设置Paths字段。如<code>kubectl create -f abc.yaml</code>，则filenameOptions为&amp;{[/home/abc.yaml] false}。<br>FilenameParam()目前支持标准输入，URL方式，文件方式，对应的支持函数为Stdin(), URL(), Path()。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">FilenameParam</span><span class="params">(enforceNamespace <span class="keyword">bool</span>, filenameOptions *FilenameOptions)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	recursive := filenameOptions.Recursive</div><div class="line">	paths := filenameOptions.Filenames</div><div class="line">	<span class="keyword">for</span> _, s := <span class="keyword">range</span> paths &#123;</div><div class="line">		<span class="keyword">switch</span> &#123;</div><div class="line">		<span class="comment">//***标准输入***//</span></div><div class="line">		<span class="keyword">case</span> s == <span class="string">"-"</span>:</div><div class="line">			b.Stdin()</div><div class="line">		<span class="comment">//***URL***//</span></div><div class="line">		<span class="keyword">case</span> strings.Index(s, <span class="string">"http://"</span>) == <span class="number">0</span> || strings.Index(s, <span class="string">"https://"</span>) == <span class="number">0</span>:</div><div class="line">			url, err := url.Parse(s)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				b.errs = <span class="built_in">append</span>(b.errs, fmt.Errorf(<span class="string">"the URL passed to filename %q is not valid: %v"</span>, s, err))</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">			b.URL(defaultHttpGetAttempts, url)</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			<span class="keyword">if</span> !recursive &#123;</div><div class="line">				b.singular = <span class="literal">true</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">//***文件或目录输入***//</span></div><div class="line">			b.Path(recursive, s)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***如果enforceNamespace为true，则调用RequireNamespace()***//</span></div><div class="line">	<span class="keyword">if</span> enforceNamespace &#123;</div><div class="line">		b.RequireNamespace()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Stdin"><a href="#Stdin" class="headerlink" title="Stdin()"></a>Stdin()</h2><p>Stdin()会调用FileVIsitorForSTDIN()生成一个visitor，然后把该visitor加入到paths中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***在builder的paths中加入stdin Visitor***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Stdin</span><span class="params">()</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	b.stream = <span class="literal">true</span></div><div class="line">	b.paths = <span class="built_in">append</span>(b.paths, FileVisitorForSTDIN(b.mapper, b.schema))</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="URL"><a href="#URL" class="headerlink" title="URL()"></a>URL()</h2><p>URL()先生成一个url visitor，然后把该visitor加入到paths中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***在builder的paths中加入URL Visitor***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">URL</span><span class="params">(httpAttemptCount <span class="keyword">int</span>, urls ...*url.URL)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, u := <span class="keyword">range</span> urls &#123;</div><div class="line">		b.paths = <span class="built_in">append</span>(b.paths, &amp;URLVisitor&#123;</div><div class="line">			URL:              u,</div><div class="line">			StreamVisitor:    NewStreamVisitor(<span class="literal">nil</span>, b.mapper, u.String(), b.schema),</div><div class="line">			HttpAttemptCount: httpAttemptCount,</div><div class="line">		&#125;)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Stream"><a href="#Stream" class="headerlink" title="Stream()"></a>Stream()</h2><p>Stream()先生成一个stream visitor，然后把该visitor加入到paths中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***在builder的paths中加入stream Visitor***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Stream</span><span class="params">(r io.Reader, name <span class="keyword">string</span>)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	b.stream = <span class="literal">true</span></div><div class="line">	b.paths = <span class="built_in">append</span>(b.paths, NewStreamVisitor(r, b.mapper, name, b.schema))</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Path"><a href="#Path" class="headerlink" title="Path()"></a>Path()</h2><p>Path()把路径转换成file visitor,然后加入到paths中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***把path转换成file Visitor，然后加入到paths中***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Path</span><span class="params">(recursive <span class="keyword">bool</span>, paths ...<span class="keyword">string</span>)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, p := <span class="keyword">range</span> paths &#123;</div><div class="line">		_, err := os.Stat(p)</div><div class="line">		<span class="keyword">if</span> os.IsNotExist(err) &#123;</div><div class="line">			b.errs = <span class="built_in">append</span>(b.errs, fmt.Errorf(<span class="string">"the path %q does not exist"</span>, p))</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			b.errs = <span class="built_in">append</span>(b.errs, fmt.Errorf(<span class="string">"the path %q cannot be accessed: %v"</span>, p, err))</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//***把paths转换成file Visitors***//</span></div><div class="line">		visitors, err := ExpandPathsToFileVisitors(b.mapper, p, recursive, FileExtensions, b.schema)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			b.errs = <span class="built_in">append</span>(b.errs, fmt.Errorf(<span class="string">"error reading %q: %v"</span>, p, err))</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(visitors) &gt; <span class="number">1</span> &#123;</div><div class="line">			b.dir = <span class="literal">true</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//***加入到paths中***//</span></div><div class="line">		b.paths = <span class="built_in">append</span>(b.paths, visitors...)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ResourceTypes"><a href="#ResourceTypes" class="headerlink" title="ResourceTypes()"></a>ResourceTypes()</h2><p>ResourceTypes()设置Builder的resources字段，如kubectl get pods abc，则resources为pods<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置resources***//</span></div><div class="line"><span class="comment">//***builder resources中存储的是需要处理的类型***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">ResourceTypes</span><span class="params">(types ...<span class="keyword">string</span>)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	b.resources = <span class="built_in">append</span>(b.resources, types...)</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ResourceNames"><a href="#ResourceNames" class="headerlink" title="ResourceNames()"></a>ResourceNames()</h2><p>ResourceNames()设置resourceTuples字段，表示需要访问的对象。如果kubectl logs nginx，那么ResourceNames()会把”nginx”和Builder中的resource(logs命令中设置为pods)，组成(pods, nginx)加入到resourceTuples中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">ResourceNames</span><span class="params">(resource <span class="keyword">string</span>, names ...<span class="keyword">string</span>)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, name := <span class="keyword">range</span> names &#123;</div><div class="line">		<span class="comment">// See if this input string is of type/name format</span></div><div class="line">		tuple, ok, err := splitResourceTypeName(name)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			b.errs = <span class="built_in">append</span>(b.errs, err)</div><div class="line">			<span class="keyword">return</span> b</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> ok &#123;</div><div class="line">			b.resourceTuples = <span class="built_in">append</span>(b.resourceTuples, tuple)</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(resource) == <span class="number">0</span> &#123;</div><div class="line">			b.errs = <span class="built_in">append</span>(b.errs, fmt.Errorf(<span class="string">"the argument %q must be RESOURCE/NAME"</span>, name))</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Use the given default type to create a resource tuple</span></div><div class="line">		b.resourceTuples = <span class="built_in">append</span>(b.resourceTuples, resourceTuple&#123;Resource: resource, Name: name&#125;)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="SelectorParam"><a href="#SelectorParam" class="headerlink" title="SelectorParam()"></a>SelectorParam()</h2><p>SelectorParam()的参数为string,设置Builder的selector字段。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置selector***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">SelectorParam</span><span class="params">(s <span class="keyword">string</span>)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	selector, err := labels.Parse(s)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		b.errs = <span class="built_in">append</span>(b.errs, fmt.Errorf(<span class="string">"the provided selector %q is not valid: %v"</span>, s, err))</div><div class="line">		<span class="keyword">return</span> b</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> selector.Empty() &#123;</div><div class="line">		<span class="keyword">return</span> b</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> b.selectAll &#123;</div><div class="line">		b.errs = <span class="built_in">append</span>(b.errs, fmt.Errorf(<span class="string">"found non empty selector %q with previously set 'all' parameter. "</span>, s))</div><div class="line">		<span class="keyword">return</span> b</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> b.Selector(selector)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Selector"><a href="#Selector" class="headerlink" title="Selector()"></a>Selector()</h2><p>Selector()的参数为selector，直接设置Builder的selector字段。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Selector</span><span class="params">(selector labels.Selector)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	b.selector = selector</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ExportParam"><a href="#ExportParam" class="headerlink" title="ExportParam()"></a>ExportParam()</h2><p>用途未知。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">ExportParam</span><span class="params">(export <span class="keyword">bool</span>)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	b.export = export</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="NamespaceParam"><a href="#NamespaceParam" class="headerlink" title="NamespaceParam()"></a>NamespaceParam()</h2><p>NamespaceParam()可以设置Builder的namespace字段。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置namespace***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">NamespaceParam</span><span class="params">(namespace <span class="keyword">string</span>)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	b.namespace = namespace</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="DefaultNamespace"><a href="#DefaultNamespace" class="headerlink" title="DefaultNamespace()"></a>DefaultNamespace()</h2><p>DefaultNamespace()可以设置Builder的defaultNamespace字段，表示如果namespace未指定，是否使用default namespace。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置DefaultNamespace***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">DefaultNamespace</span><span class="params">()</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	b.defaultNamespace = <span class="literal">true</span></div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AllNamespaces"><a href="#AllNamespaces" class="headerlink" title="AllNamespaces()"></a>AllNamespaces()</h2><p>AllNamespaces()可以设置Builder的allNamespace和namespace字段，表示访问NamespaceAll。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***把namespace设置为NamespaceAll***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">AllNamespaces</span><span class="params">(allNamespace <span class="keyword">bool</span>)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> allNamespace &#123;</div><div class="line">		b.namespace = api.NamespaceAll</div><div class="line">	&#125;</div><div class="line">	b.allNamespace = allNamespace</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="RequireNamespace"><a href="#RequireNamespace" class="headerlink" title="RequireNamespace()"></a>RequireNamespace()</h2><p>RequireNamespace()可以设置Builder的requireNamespace字段。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">RequireNamespace</span><span class="params">()</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	b.requireNamespace = <span class="literal">true</span></div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="SelectAllParam"><a href="#SelectAllParam" class="headerlink" title="SelectAllParam()"></a>SelectAllParam()</h2><p>SelectAllParam()可以设置Builder的selectAll字段。与selector字段互斥。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">SelectAllParam</span><span class="params">(selectAll <span class="keyword">bool</span>)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> selectAll &amp;&amp; b.selector != <span class="literal">nil</span> &#123;</div><div class="line">		b.errs = <span class="built_in">append</span>(b.errs, fmt.Errorf(<span class="string">"setting 'all' parameter but found a non empty selector. "</span>))</div><div class="line">		<span class="keyword">return</span> b</div><div class="line">	&#125;</div><div class="line">	b.selectAll = selectAll</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ResourceTypeOrNameArgs"><a href="#ResourceTypeOrNameArgs" class="headerlink" title="ResourceTypeOrNameArgs()"></a>ResourceTypeOrNameArgs()</h2><p>ResourceTypeOrNameArgs()可以设置Builder的names和resource字段。如执行<code>kubectl get pods/nginx-1487191267-b4w5j rc/abc</code>，则args为<code>[pods/nginx-1487191267-b4w5j rc/abc]</code>。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">ResourceTypeOrNameArgs</span><span class="params">(allowEmptySelector <span class="keyword">bool</span>, args ...<span class="keyword">string</span>)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	args = normalizeMultipleResourcesArgs(args)</div><div class="line">	<span class="keyword">if</span> ok, err := hasCombinedTypeArgs(args); ok &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			b.errs = <span class="built_in">append</span>(b.errs, err)</div><div class="line">			<span class="keyword">return</span> b</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> _, s := <span class="keyword">range</span> args &#123;</div><div class="line">			tuple, ok, err := splitResourceTypeName(s)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				b.errs = <span class="built_in">append</span>(b.errs, err)</div><div class="line">				<span class="keyword">return</span> b</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> ok &#123;</div><div class="line">				b.resourceTuples = <span class="built_in">append</span>(b.resourceTuples, tuple)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> b</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) &gt; <span class="number">0</span> &#123;</div><div class="line">		<span class="comment">// Try replacing aliases only in types</span></div><div class="line">		args[<span class="number">0</span>] = b.ReplaceAliases(args[<span class="number">0</span>])</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***此处调用ResourceTypes()***//</span></div><div class="line">	<span class="keyword">switch</span> &#123;</div><div class="line">	<span class="keyword">case</span> <span class="built_in">len</span>(args) &gt; <span class="number">2</span>:</div><div class="line">		b.names = <span class="built_in">append</span>(b.names, args[<span class="number">1</span>:]...)</div><div class="line">		b.ResourceTypes(SplitResourceArgument(args[<span class="number">0</span>])...)</div><div class="line">	<span class="keyword">case</span> <span class="built_in">len</span>(args) == <span class="number">2</span>:</div><div class="line">		b.names = <span class="built_in">append</span>(b.names, args[<span class="number">1</span>])</div><div class="line">		b.ResourceTypes(SplitResourceArgument(args[<span class="number">0</span>])...)</div><div class="line">	<span class="keyword">case</span> <span class="built_in">len</span>(args) == <span class="number">1</span>:</div><div class="line">		b.ResourceTypes(SplitResourceArgument(args[<span class="number">0</span>])...)</div><div class="line">		<span class="keyword">if</span> b.selector == <span class="literal">nil</span> &amp;&amp; allowEmptySelector &#123;</div><div class="line">			b.selector = labels.Everything()</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">case</span> <span class="built_in">len</span>(args) == <span class="number">0</span>:</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		b.errs = <span class="built_in">append</span>(b.errs, fmt.Errorf(<span class="string">"arguments must consist of a resource or a resource and name"</span>))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Flatten"><a href="#Flatten" class="headerlink" title="Flatten()"></a>Flatten()</h2><p>Flatten()可以设置Builder的flatten字段。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Flatten</span><span class="params">()</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	b.flatten = <span class="literal">true</span></div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Latest"><a href="#Latest" class="headerlink" title="Latest()"></a>Latest()</h2><p>Latest()可以设置Builder的latest字段，用来标识获取URL或Path中最新的内容。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Latest</span><span class="params">()</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	b.latest = <span class="literal">true</span></div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="RequireObject"><a href="#RequireObject" class="headerlink" title="RequireObject()"></a>RequireObject()</h2><p>RequireObject()可以设置Builder的requireObject字段。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">RequireObject</span><span class="params">(require <span class="keyword">bool</span>)</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	b.requireObject = require</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ContinueOnError"><a href="#ContinueOnError" class="headerlink" title="ContinueOnError()"></a>ContinueOnError()</h2><p>ContinueOnError()可以设置Builder的continueOnError字段为true，在封装visitor时会用到该字段。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">ContinueOnError</span><span class="params">()</span> *<span class="title">Builder</span></span> &#123;</div><div class="line">	b.continueOnError = <span class="literal">true</span></div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="mappingFor"><a href="#mappingFor" class="headerlink" title="mappingFor()"></a>mappingFor()</h2><p>mappingFor()使用参数resource，然后依据mapper字段，构建RESTMapping并返回。RESTMapping表示resource和GVK的对应关系。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***返回RESTMapping***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">mappingFor</span><span class="params">(resourceArg <span class="keyword">string</span>)</span> <span class="params">(*meta.RESTMapping, error)</span></span> &#123;</div><div class="line">	<span class="comment">//***把resource构造成GVR***//</span></div><div class="line">	fullySpecifiedGVR, groupResource := unversioned.ParseResourceArg(resourceArg)</div><div class="line">	gvk := unversioned.GroupVersionKind&#123;&#125;</div><div class="line">	<span class="keyword">if</span> fullySpecifiedGVR != <span class="literal">nil</span> &#123;</div><div class="line">		gvk, _ = b.mapper.KindFor(*fullySpecifiedGVR)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> gvk.Empty() &#123;</div><div class="line">		<span class="keyword">var</span> err error</div><div class="line">		gvk, err = b.mapper.KindFor(groupResource.WithVersion(<span class="string">""</span>))</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***RESTMapping()定义在/pkg/api/meta/restmapper.go中***//</span></div><div class="line">	<span class="keyword">return</span> b.mapper.RESTMapping(gvk.GroupKind(), gvk.Version)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="resourceMappings"><a href="#resourceMappings" class="headerlink" title="resourceMappings()"></a>resourceMappings()</h2><p>resourceMappings()把Builder中的resource传递给上面的mappingFor()生成RESTMapping。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***把builder中resources转换成mapping***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">resourceMappings</span><span class="params">()</span> <span class="params">([]*meta.RESTMapping, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(b.resources) &gt; <span class="number">1</span> &amp;&amp; b.singleResourceType &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"you may only specify a single resource type"</span>)</div><div class="line">	&#125;</div><div class="line">	mappings := []*meta.RESTMapping&#123;&#125;</div><div class="line">	<span class="keyword">for</span> _, r := <span class="keyword">range</span> b.resources &#123;</div><div class="line">		mapping, err := b.mappingFor(r)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		mappings = <span class="built_in">append</span>(mappings, mapping)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> mappings, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="resourceTupleMappings"><a href="#resourceTupleMappings" class="headerlink" title="resourceTupleMappings()"></a>resourceTupleMappings()</h2><p>resourceTupleMappings()把Builder中的resourceTuple转换成RESTMapping。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">resourceTupleMappings</span><span class="params">()</span> <span class="params">(<span class="keyword">map</span>[<span class="keyword">string</span>]*meta.RESTMapping, error)</span></span> &#123;</div><div class="line">	mappings := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*meta.RESTMapping)</div><div class="line">	canonical := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;)</div><div class="line">	<span class="keyword">for</span> _, r := <span class="keyword">range</span> b.resourceTuples &#123;</div><div class="line">		<span class="keyword">if</span> _, ok := mappings[r.Resource]; ok &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		mapping, err := b.mappingFor(r.Resource)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		mappings[mapping.Resource] = mapping</div><div class="line">		mappings[r.Resource] = mapping</div><div class="line">		canonical[mapping.Resource] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(canonical) &gt; <span class="number">1</span> &amp;&amp; b.singleResourceType &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"you may only specify a single resource type"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> mappings, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/15/Kubectl概念解读(一)-Builder-v1-5-2/" data-id="cj5ule83n0005ecqs2wj5aq2b" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-RESTClient-DynamicClient和ClientSet-Demo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/15/RESTClient-DynamicClient和ClientSet-Demo/" class="article-date">
  <time datetime="2017-07-15T01:21:24.000Z" itemprop="datePublished">2017-07-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/15/RESTClient-DynamicClient和ClientSet-Demo/">RESTClient,DynamicClient和ClientSet Demo</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="三个Client"><a href="#三个Client" class="headerlink" title="三个Client"></a>三个Client</h2><p>在Kubernetes上，通常需要Client来访问Kubernetes中的对象，目前最常用的是RESTClient, DynamicClient和ClientSet这三种Client。今天就先介绍下这三个Client基本含义及大概的用法。Demo的编写是参考了<a href="http://blog.csdn.net/column/details/14420.html" target="_blank" rel="external">http://blog.csdn.net/column/details/14420.html</a> ，非常感谢。</p>
<h2 id="RESTClient"><a href="#RESTClient" class="headerlink" title="RESTClient"></a>RESTClient</h2><p>RESTClient是Kubernetes最基础的Client，直接负责与Request(RESTClient中的概念)打交道。下面的Demo就描述如何生成一个RESTClient，并用该RESTClient获取某具体Pod的详细信息。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"flag"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"k8s.io/client-go/pkg/runtime"</span></div><div class="line">	<span class="string">"k8s.io/client-go/pkg/runtime/serializer"</span></div><div class="line">	<span class="string">"k8s.io/client-go/pkg/api"</span></div><div class="line">	v1 <span class="string">"k8s.io/client-go/pkg/api/v1"</span></div><div class="line">	<span class="string">"k8s.io/client-go/pkg/api/unversioned"</span></div><div class="line">	<span class="string">"k8s.io/client-go/rest"</span></div><div class="line">	<span class="string">"k8s.io/client-go/tools/clientcmd"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	kubeconfig := flag.String(<span class="string">"kubeconfig"</span>, <span class="string">"/root/.kube/config"</span>, <span class="string">"Path to a kube config. Only required if out-of-cluster."</span>)</div><div class="line">	flag.Parse()</div><div class="line">	config, err := clientcmd.BuildConfigFromFlags(<span class="string">""</span>, *kubeconfig)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(<span class="string">"BuildConfigFromFlags error"</span>)</div><div class="line">	&#125;</div><div class="line">	groupversion := &amp;unversioned.GroupVersion&#123;<span class="string">""</span>, <span class="string">"v1"</span>&#125;</div><div class="line">	config.GroupVersion = groupversion</div><div class="line">	config.APIPath = <span class="string">"/api"</span></div><div class="line">	config.ContentType = runtime.ContentTypeJSON</div><div class="line">	config.NegotiatedSerializer = serializer.DirectCodecFactory&#123;CodecFactory: api.Codecs&#125;</div><div class="line">	restClient, err := rest.RESTClientFor(config)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(<span class="string">"RESTClientFor error"</span>)</div><div class="line">	&#125;</div><div class="line">	pod := v1.Pod&#123;&#125;</div><div class="line">	err = restClient.Get().Resource(<span class="string">"pods"</span>).Namespace(<span class="string">"default"</span>).Name(<span class="string">"nginx-1487191267-b4w5j"</span>).Do().Into(&amp;pod)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(<span class="string">"error"</span>)</div><div class="line">	&#125;</div><div class="line">	fmt.Println(pod)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果内容过多，略。</p>
<h2 id="DynamicClient"><a href="#DynamicClient" class="headerlink" title="DynamicClient"></a>DynamicClient</h2><p>RESTClient需要自己设置请求各属性，用起来很不方便。DynamicClient是对RESTClient的封装，支持动态设置访问类型。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"flag"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"reflect"</span></div><div class="line">	<span class="string">"encoding/json"</span></div><div class="line">	<span class="string">"k8s.io/client-go/pkg/api/v1"</span></div><div class="line">	<span class="string">"k8s.io/client-go/pkg/api/unversioned"</span></div><div class="line">	<span class="string">"k8s.io/client-go/dynamic"</span></div><div class="line">	<span class="string">"k8s.io/client-go/tools/clientcmd"</span></div><div class="line">	<span class="string">"k8s.io/client-go/rest"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	kubeconfig := flag.String(<span class="string">"kubeconfig"</span>, <span class="string">"/root/.kube/config"</span>, <span class="string">"Path to a kube config. Only required if out-of-cluster."</span>)</div><div class="line">	fmt.Println(kubeconfig)</div><div class="line">	flag.Parse()</div><div class="line">	config, err := clientcmd.BuildConfigFromFlags(<span class="string">""</span>, *kubeconfig)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(<span class="string">"error1"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 生成dynamicClient</span></div><div class="line">	gv := &amp;unversioned.GroupVersion&#123;<span class="string">""</span>, <span class="string">"v1"</span>&#125;</div><div class="line">	resource := &amp;unversioned.APIResource&#123;Name: <span class="string">"pods"</span>, Namespaced: <span class="literal">true</span>&#125;</div><div class="line">	config.ContentConfig = rest.ContentConfig&#123;GroupVersion: gv&#125;</div><div class="line">	config.APIPath = <span class="string">"/api"</span></div><div class="line"></div><div class="line">	dynamicClient, err := dynamic.NewClient(config)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(<span class="string">"dynamic NewCLient error"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 获取所有namespace的pod列表</span></div><div class="line">	obj, err := dynamicClient.Resource(resource, <span class="string">""</span>).List(&amp;v1.ListOptions&#123;&#125;)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(<span class="string">"dynamicClient Resource error"</span>)</div><div class="line">	&#125;</div><div class="line">	js, err := json.Marshal(reflect.ValueOf(obj).Elem().Interface())</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(<span class="string">"error"</span>)</div><div class="line">	&#125;</div><div class="line">	podlist := v1.PodList&#123;&#125;</div><div class="line">	json.Unmarshal(js, &amp;podlist)</div><div class="line">	fmt.Println(podlist)</div><div class="line">	fmt.Println(<span class="string">"------------------------"</span>)</div><div class="line">	<span class="comment">// 获取具体具体pod</span></div><div class="line">	obj, err = dynamicClient.Resource(resource, <span class="string">"default"</span>).Get(<span class="string">"nginx-1487191267-b4w5j"</span>)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">                fmt.Println(<span class="string">"dynamicClient Resource error"</span>)</div><div class="line">        &#125;</div><div class="line">        js, err = json.Marshal(obj)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">                fmt.Println(<span class="string">"error"</span>)</div><div class="line">        &#125;</div><div class="line">        pod := v1.Pod&#123;&#125;</div><div class="line">        json.Unmarshal(js, &amp;pod)</div><div class="line">        fmt.Println(pod)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果内容过多，略。</p>
<h2 id="ClientSet"><a href="#ClientSet" class="headerlink" title="ClientSet"></a>ClientSet</h2><p>ClientSet也是对RESTClient的一种封装，与DynamicClient不同的是，ClientSet支持衍生出具体资源的Client，如PodClient等。ClientSet是Kubernetes用的最多的Client类型 。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"flag"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	apiv1 <span class="string">"k8s.io/client-go/pkg/api/v1"</span></div><div class="line">	<span class="string">"k8s.io/client-go/kubernetes"</span></div><div class="line">	<span class="string">"k8s.io/client-go/tools/clientcmd"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	kubeconfig := flag.String(<span class="string">"kubeconfig"</span>, <span class="string">"/root/.kube/config"</span>, <span class="string">"Path to a kube config. Only required if out-of-cluster."</span>)</div><div class="line">	fmt.Println(kubeconfig)</div><div class="line">	flag.Parse()</div><div class="line">	config, err := clientcmd.BuildConfigFromFlags(<span class="string">""</span>, *kubeconfig)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(<span class="string">"error"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 生成clientset</span></div><div class="line">	clientset, err := kubernetes.NewForConfig(config)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(<span class="string">"error"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 生成podCLient</span></div><div class="line">	podClient := clientset.Core().Pods(<span class="string">""</span>)</div><div class="line">	pods, err := podClient.List(apiv1.ListOptions&#123;&#125;)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(<span class="string">"error"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> _, pod := <span class="keyword">range</span> pods.Items &#123;</div><div class="line">		fmt.Println(pod)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果内容过多，略。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/15/RESTClient-DynamicClient和ClientSet-Demo/" data-id="cj5ule84q000hecqsh6cr61bw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Event机制源码分析-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/11/Event机制源码分析-v1-5-2/" class="article-date">
  <time datetime="2017-07-11T07:31:50.000Z" itemprop="datePublished">2017-07-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/11/Event机制源码分析-v1-5-2/">Event机制源码分析-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是Event机制"><a href="#什么是Event机制" class="headerlink" title="什么是Event机制"></a>什么是Event机制</h2><p>Event机制是Kubernetes用来记录系统发生的事件的一种机制，可以把Event发送给相关函数进行处理，其本质是一个单生产者，生产出的Event供多个消费者消费的模型。</p>
<h2 id="Event生产者"><a href="#Event生产者" class="headerlink" title="Event生产者"></a>Event生产者</h2><p>Event生产者就是可以产生Event的对象。在Kubernetes中，Event生产者称为EventRecorder，EventRecorder为interface，具体由recorderImpl struct实现，定义在/pkg/client/record/event.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// EventRecorder knows how to record events on behalf of an EventSource.</span></div><div class="line"><span class="keyword">type</span> EventRecorder <span class="keyword">interface</span> &#123;</div><div class="line">	<span class="comment">// The resulting event will be created in the same namespace as the reference object.</span></div><div class="line">	Event(object runtime.Object, eventtype, reason, message <span class="keyword">string</span>)</div><div class="line">	<span class="comment">// Eventf is just like Event, but with Sprintf for the message field.</span></div><div class="line">	Eventf(object runtime.Object, eventtype, reason, messageFmt <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</div><div class="line">	<span class="comment">// PastEventf is just like Eventf, but with an option to specify the event's 'timestamp' field.</span></div><div class="line">	PastEventf(object runtime.Object, timestamp unversioned.Time, eventtype, reason, messageFmt <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>recorderImpl的定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> recorderImpl <span class="keyword">struct</span> &#123;</div><div class="line">	source api.EventSource</div><div class="line">	*watch.Broadcaster</div><div class="line">	clock clock.Clock</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在需要记着的是recorderImpl中嵌入了watch.Broadcaster结构体。<br>再来看recorderImpl对EventRecorder接口中定义的函数的实现：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***recorder入口1***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(recorder *recorderImpl)</span> <span class="title">Event</span><span class="params">(object runtime.Object, eventtype, reason, message <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	recorder.generateEvent(object, unversioned.Now(), eventtype, reason, message)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***recorder入口2***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(recorder *recorderImpl)</span> <span class="title">Eventf</span><span class="params">(object runtime.Object, eventtype, reason, messageFmt <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	recorder.Event(object, eventtype, reason, fmt.Sprintf(messageFmt, args...))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***recorder入口3***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(recorder *recorderImpl)</span> <span class="title">PastEventf</span><span class="params">(object runtime.Object, timestamp unversioned.Time, eventtype, reason, messageFmt <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	recorder.generateEvent(object, timestamp, eventtype, reason, fmt.Sprintf(messageFmt, args...))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Event()是对刚发生的消息进行记录；<br>Eventf()可以使用fmt.Sprintf()来格式化消息；<br>PastEventf()允许自定义消息发生的时间，来用记录已经发生过的消息。</p>
<p>这三个函数最后都调用了generateEvent()函数：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***产生event，并把event广播***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(recorder *recorderImpl)</span> <span class="title">generateEvent</span><span class="params">(object runtime.Object, timestamp unversioned.Time, eventtype, reason, message <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	ref, err := api.GetReference(object)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.Errorf(<span class="string">"Could not construct reference to: '%#v' due to: '%v'. Will not report event: '%v' '%v' '%v'"</span>, object, err, eventtype, reason, message)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> !validateEventType(eventtype) &#123;</div><div class="line">		glog.Errorf(<span class="string">"Unsupported event type: '%v'"</span>, eventtype)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***生成event***//</span></div><div class="line">	event := recorder.makeEvent(ref, eventtype, reason, message)</div><div class="line">	event.Source = recorder.source</div><div class="line"></div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="comment">// <span class="doctag">NOTE:</span> events should be a non-blocking operation</span></div><div class="line">		<span class="keyword">defer</span> utilruntime.HandleCrash()</div><div class="line">		<span class="comment">//***把event传播到所有watcher中***//</span></div><div class="line">		recorder.Action(watch.Added, event)</div><div class="line">	&#125;()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>generateEvent()先生成一个event，然后调用Action()对event进行处理。Action()是watch.Broadcaster结构体的成员函数，所以具体怎么处理，稍后章节分析。</p>
<p>所以，recorder（按代码中来称呼）可以生成event，并把event传递给Action()处理函数。</p>
<h2 id="Event消费者"><a href="#Event消费者" class="headerlink" title="Event消费者"></a>Event消费者</h2><p>recorder产生的event，需要有程序来消费，这个消费程序就是EventBroadcaster，EventBroadcaster是一个interface，定义在/pkg/client/record/event.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// EventBroadcaster knows how to receive events and send them to any EventSink, watcher, or log.</span></div><div class="line"><span class="keyword">type</span> EventBroadcaster <span class="keyword">interface</span> &#123;</div><div class="line">	<span class="comment">// StartEventWatcher starts sending events received from this EventBroadcaster to the given</span></div><div class="line">	<span class="comment">// event handler function. The return value can be ignored or used to stop recording, if</span></div><div class="line">	<span class="comment">// desired.</span></div><div class="line">	StartEventWatcher(eventHandler <span class="function"><span class="keyword">func</span><span class="params">(*api.Event)</span>) <span class="title">watch</span>.<span class="title">Interface</span></span></div><div class="line"></div><div class="line">	// <span class="title">StartRecordingToSink</span> <span class="title">starts</span> <span class="title">sending</span> <span class="title">events</span> <span class="title">received</span> <span class="title">from</span> <span class="title">this</span> <span class="title">EventBroadcaster</span> <span class="title">to</span> <span class="title">the</span> <span class="title">given</span></div><div class="line">	// <span class="title">sink</span>. <span class="title">The</span> <span class="title">return</span> <span class="title">value</span> <span class="title">can</span> <span class="title">be</span> <span class="title">ignored</span> <span class="title">or</span> <span class="title">used</span> <span class="title">to</span> <span class="title">stop</span> <span class="title">recording</span>, <span class="title">if</span> <span class="title">desired</span>.</div><div class="line">	<span class="title">StartRecordingToSink</span><span class="params">(sink EventSink)</span> <span class="title">watch</span>.<span class="title">Interface</span></div><div class="line"></div><div class="line">	// <span class="title">StartLogging</span> <span class="title">starts</span> <span class="title">sending</span> <span class="title">events</span> <span class="title">received</span> <span class="title">from</span> <span class="title">this</span> <span class="title">EventBroadcaster</span> <span class="title">to</span> <span class="title">the</span> <span class="title">given</span> <span class="title">logging</span></div><div class="line">	// <span class="title">function</span>. <span class="title">The</span> <span class="title">return</span> <span class="title">value</span> <span class="title">can</span> <span class="title">be</span> <span class="title">ignored</span> <span class="title">or</span> <span class="title">used</span> <span class="title">to</span> <span class="title">stop</span> <span class="title">recording</span>, <span class="title">if</span> <span class="title">desired</span>.</div><div class="line">	<span class="title">StartLogging</span><span class="params">(logf <span class="keyword">func</span>(format <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span>) <span class="title">watch</span>.<span class="title">Interface</span></div><div class="line"></div><div class="line">	// <span class="title">NewRecorder</span> <span class="title">returns</span> <span class="title">an</span> <span class="title">EventRecorder</span> <span class="title">that</span> <span class="title">can</span> <span class="title">be</span> <span class="title">used</span> <span class="title">to</span> <span class="title">send</span> <span class="title">events</span> <span class="title">to</span> <span class="title">this</span> <span class="title">EventBroadcaster</span></div><div class="line">	// <span class="title">with</span> <span class="title">the</span> <span class="title">event</span> <span class="title">source</span> <span class="title">set</span> <span class="title">to</span> <span class="title">the</span> <span class="title">given</span> <span class="title">event</span> <span class="title">source</span>.</div><div class="line">	<span class="title">NewRecorder</span><span class="params">(source api.EventSource)</span> <span class="title">EventRecorder</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>EventBroadcaster具体由eventBroadcasterImpl结构体实现：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> eventBroadcasterImpl <span class="keyword">struct</span> &#123;</div><div class="line">	*watch.Broadcaster</div><div class="line">	sleepDuration time.Duration</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>和recorderImpl一样，eventBroadcasterImpl（成员函数中称为eventBroadcaster）也嵌入了一个watch.Broadcaster结构体。</p>
<p>先来看eventBroadcaster的成员函数StartRecordingToSink()和StartLogging()：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***eventBroadcaster入口1***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(eventBroadcaster *eventBroadcasterImpl)</span> <span class="title">StartRecordingToSink</span><span class="params">(sink EventSink)</span> <span class="title">watch</span>.<span class="title">Interface</span></span> &#123;</div><div class="line">	<span class="comment">// The default math/rand package functions aren't thread safe, so create a</span></div><div class="line">	<span class="comment">// new Rand object for each StartRecording call.</span></div><div class="line">	randGen := rand.New(rand.NewSource(time.Now().UnixNano()))</div><div class="line">	eventCorrelator := NewEventCorrelator(clock.RealClock&#123;&#125;)</div><div class="line">	<span class="keyword">return</span> eventBroadcaster.StartEventWatcher(</div><div class="line">		<span class="function"><span class="keyword">func</span><span class="params">(event *api.Event)</span></span> &#123;</div><div class="line">			recordToSink(sink, event, eventCorrelator, randGen, eventBroadcaster.sleepDuration)</div><div class="line">		&#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***eventBroadcaster入口2***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(eventBroadcaster *eventBroadcasterImpl)</span> <span class="title">StartLogging</span><span class="params">(logf <span class="keyword">func</span>(format <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span>) <span class="title">watch</span>.<span class="title">Interface</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> eventBroadcaster.StartEventWatcher(</div><div class="line">		<span class="function"><span class="keyword">func</span><span class="params">(e *api.Event)</span></span> &#123;</div><div class="line">			logf(<span class="string">"Event(%#v): type: '%v' reason: '%v' %v"</span>, e.InvolvedObject, e.Type, e.Reason, e.Message)</div><div class="line">		&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这两个函数自定义了event处理函数（一个记录到数据库中，一个记录到日志中），然后把处理函数作为参数传递给StartEventWatcher()：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// StartEventWatcher starts sending events received from this EventBroadcaster to the given event handler function.</span></div><div class="line"><span class="comment">// The return value can be ignored or used to stop recording, if desired.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(eventBroadcaster *eventBroadcasterImpl)</span> <span class="title">StartEventWatcher</span><span class="params">(eventHandler <span class="keyword">func</span>(*api.Event)</span>) <span class="title">watch</span>.<span class="title">Interface</span></span> &#123;</div><div class="line">	<span class="comment">//***调用Watch()，生成一个新的watcher***//</span></div><div class="line">	watcher := eventBroadcaster.Watch()</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">defer</span> utilruntime.HandleCrash()</div><div class="line">		<span class="keyword">for</span> &#123;</div><div class="line">			<span class="comment">//***监听watcher.ResultChan()，并对event使用eventHandler进行处理***//</span></div><div class="line">			watchEvent, open := &lt;-watcher.ResultChan()</div><div class="line">			<span class="keyword">if</span> !open &#123;</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">//***可以使用watchEvent.Object.(*api.Event)的方法把一个interface转换成具体的类型***//</span></div><div class="line">			event, ok := watchEvent.Object.(*api.Event)</div><div class="line">			<span class="keyword">if</span> !ok &#123;</div><div class="line">				<span class="comment">// This is all local, so there's no reason this should</span></div><div class="line">				<span class="comment">// ever happen.</span></div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">//***处理事件***//</span></div><div class="line">			eventHandler(event)</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">	<span class="keyword">return</span> watcher</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>StartEventWatcher()先生成一个event watcher，然后起routine监听watcher并处理event。</p>
<p>所以，eventBroadcaster可以生成一个event watcher，然后不断消费watcher中的event，并调用自定义函数对event进行处理。</p>
<p>现在，问题来了，作为event生产者，recorder调用的是Action()来处理event；作为event的消费者，eventBroadcaster通过event watcher获取event，所以必定有地方关联Action()及event watcher。因为recorder和eventBroadcaster都具有嵌入结构体watch.Broadcaster，所以可以猜测watch.Broadcaster是recorder和eventBroadcaster之间的桥梁。</p>
<h2 id="Broadcaster"><a href="#Broadcaster" class="headerlink" title="Broadcaster"></a>Broadcaster</h2><p>Broadcaster是一个通用模块，作用是把obj发送给多个watcher。所以可以把Broadcaster理解成分发者。Broadcaster定义在/pkg/watch/mux.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Broadcaster distributes event notifications among any number of watchers. Every event</span></div><div class="line"><span class="comment">// is delivered to every watcher.</span></div><div class="line"><span class="keyword">type</span> Broadcaster <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> see if this lock is needed now that new watchers go through</span></div><div class="line">	<span class="comment">// the incoming channel.</span></div><div class="line">	lock sync.Mutex</div><div class="line"></div><div class="line">	watchers     <span class="keyword">map</span>[<span class="keyword">int64</span>]*broadcasterWatcher</div><div class="line">	nextWatcher  <span class="keyword">int64</span></div><div class="line">	distributing sync.WaitGroup</div><div class="line"></div><div class="line">	incoming <span class="keyword">chan</span> Event</div><div class="line"></div><div class="line">	<span class="comment">// How large to make watcher's channel.</span></div><div class="line">	watchQueueLength <span class="keyword">int</span></div><div class="line">	<span class="comment">// If one of the watch channels is full, don't wait for it to become empty.</span></div><div class="line">	<span class="comment">// Instead just deliver it to the watchers that do have space in their</span></div><div class="line">	<span class="comment">// channels and move on to the next event.</span></div><div class="line">	<span class="comment">// It's more fair to do this on a per-watcher basis than to do it on the</span></div><div class="line">	<span class="comment">// "incoming" channel, which would allow one slow watcher to prevent all</span></div><div class="line">	<span class="comment">// other watchers from getting new events.</span></div><div class="line">	fullChannelBehavior FullChannelBehavior</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在Broadcaster中，包含一个incoming channel和一个broadcasterWatcher map（之后提到的watcher就是broadcasterWatcher）。obj会缓存在incoming channel中，然后再分发给各个watcher。</p>
<p>先来看Broadcaster的创建函数：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewBroadcaster creates a new Broadcaster. queueLength is the maximum number of events to queue per watcher.</span></div><div class="line"><span class="comment">// It is guaranteed that events will be distributed in the order in which they occur,</span></div><div class="line"><span class="comment">// but the order in which a single event is distributed among all of the watchers is unspecified.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBroadcaster</span><span class="params">(queueLength <span class="keyword">int</span>, fullChannelBehavior FullChannelBehavior)</span> *<span class="title">Broadcaster</span></span> &#123;</div><div class="line">	m := &amp;Broadcaster&#123;</div><div class="line">		watchers:            <span class="keyword">map</span>[<span class="keyword">int64</span>]*broadcasterWatcher&#123;&#125;,</div><div class="line">		incoming:            <span class="built_in">make</span>(<span class="keyword">chan</span> Event, incomingQueueLength),</div><div class="line">		watchQueueLength:    queueLength,</div><div class="line">		fullChannelBehavior: fullChannelBehavior,</div><div class="line">	&#125;</div><div class="line">	m.distributing.Add(<span class="number">1</span>)</div><div class="line">	<span class="keyword">go</span> m.loop()</div><div class="line">	<span class="keyword">return</span> m</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，NewBroadcaster()函数在生成Broadcaster的同时，还拉起了loop()函数。</p>
<p>loop()函数会消费incoming channel中的obj，然后把obj进行分发。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// loop receives from m.incoming and distributes to all watchers.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Broadcaster)</span> <span class="title">loop</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Deliberately not catching crashes here. Yes, bring down the process if there's a</span></div><div class="line">	<span class="comment">// bug in watch.Broadcaster.</span></div><div class="line">	<span class="comment">//***遍历incoming中的内容***//</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		event, ok := &lt;-m.incoming</div><div class="line">		<span class="keyword">if</span> !ok &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> event.Type == internalRunFunctionMarker &#123;</div><div class="line">			event.Object.(functionFakeRuntimeObject)()</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***把event分发到所有的watcher中***//</span></div><div class="line">		m.distribute(event)</div><div class="line">	&#125;</div><div class="line">	m.closeAll()</div><div class="line">	m.distributing.Done()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再来看distribute()函数：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// distribute sends event to all watchers. Blocking.</span></div><div class="line"><span class="comment">//***把event分发***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Broadcaster)</span> <span class="title">distribute</span><span class="params">(event Event)</span></span> &#123;</div><div class="line">	m.lock.Lock()</div><div class="line">	<span class="keyword">defer</span> m.lock.Unlock()</div><div class="line">	<span class="keyword">if</span> m.fullChannelBehavior == DropIfChannelFull &#123;</div><div class="line">		<span class="keyword">for</span> _, w := <span class="keyword">range</span> m.watchers &#123;</div><div class="line">			<span class="keyword">select</span> &#123;</div><div class="line">			<span class="keyword">case</span> w.result &lt;- event:</div><div class="line">			<span class="keyword">case</span> &lt;-w.stopped:</div><div class="line">			<span class="keyword">default</span>: <span class="comment">// Don't block if the event can't be queued.</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">for</span> _, w := <span class="keyword">range</span> m.watchers &#123;</div><div class="line">			<span class="keyword">select</span> &#123;</div><div class="line">			<span class="keyword">case</span> w.result &lt;- event:</div><div class="line">			<span class="keyword">case</span> &lt;-w.stopped:</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>distribute就是把event放到Broadcaster中注册的各watcher中。关于watcher，内容生产者把内容写到watcher的result channel中，消费者通过watcher.Channel()来获取result channel，并读出内容。</p>
<p>那么，event是什么时候放到incoming channel中呢？答案就是之前提过的Action()：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Action distributes the given event among all watchers.</span></div><div class="line"><span class="comment">//***把event放入到incoming channel中***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Broadcaster)</span> <span class="title">Action</span><span class="params">(action EventType, obj runtime.Object)</span></span> &#123;</div><div class="line">	m.incoming &lt;- Event&#123;action, obj&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在我们来看来Broadcaster是如何管理watcher的。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Watch adds a new watcher to the list and returns an Interface for it.</span></div><div class="line"><span class="comment">// Note: new watchers will only receive new events. They won't get an entire history</span></div><div class="line"><span class="comment">// of previous events.</span></div><div class="line"><span class="comment">//***生成一个新的watcher***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Broadcaster)</span> <span class="title">Watch</span><span class="params">()</span> <span class="title">Interface</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> w *broadcasterWatcher</div><div class="line">	m.blockQueue(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		m.lock.Lock()</div><div class="line">		<span class="keyword">defer</span> m.lock.Unlock()</div><div class="line">		id := m.nextWatcher</div><div class="line">		m.nextWatcher++</div><div class="line">		w = &amp;broadcasterWatcher&#123;</div><div class="line">			result:  <span class="built_in">make</span>(<span class="keyword">chan</span> Event, m.watchQueueLength),</div><div class="line">			stopped: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</div><div class="line">			id:      id,</div><div class="line">			m:       m,</div><div class="line">		&#125;</div><div class="line">		m.watchers[id] = w</div><div class="line">	&#125;)</div><div class="line">	<span class="keyword">return</span> w</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Watch()函数会生成一个新的broadcasterWatcher，然后把watcher加入到Broadcaster的watchers map中。其中，broadcasterWatcher中的id和watcher map中的key id值一样。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Stop stops watching and removes mw from its list.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mw *broadcasterWatcher)</span> <span class="title">Stop</span><span class="params">()</span></span> &#123;</div><div class="line">	mw.stop.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="built_in">close</span>(mw.stopped)</div><div class="line">		mw.m.stopWatching(mw.id)</div><div class="line">	&#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Broadcaster)</span> <span class="title">stopWatching</span><span class="params">(id <span class="keyword">int64</span>)</span></span> &#123;</div><div class="line">	m.lock.Lock()</div><div class="line">	<span class="keyword">defer</span> m.lock.Unlock()</div><div class="line">	w, ok := m.watchers[id]</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="comment">// No need to do anything, it's already been removed from the list.</span></div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="built_in">delete</span>(m.watchers, id)</div><div class="line">	<span class="built_in">close</span>(w.result)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用broadcasterWatcher的Stop()可以把broadcasterWatcher从Broadcaster中移除并停止broadcasterWatcher。</p>
<p>给Broadcaster做个总结，Action()函数把obj放到incoming channel中，然后有一个循环loop()消费incoming channel中的obj，然后把obj分发到多个broadcasterWatcher中。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>下面Demo是依据/pkg/client/record/event_test.go写的，可以说明如何使用Kubernetes的Event机制：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line"></div><div class="line">	<span class="string">"k8s.io/kubernetes/pkg/api"</span></div><div class="line">	<span class="string">"k8s.io/kubernetes/pkg/api/unversioned"</span></div><div class="line">	<span class="string">"k8s.io/kubernetes/pkg/client/record"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> testEventSink <span class="keyword">struct</span> &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CreateEvent records the event for testing.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *testEventSink)</span> <span class="title">Create</span><span class="params">(e *api.Event)</span> <span class="params">(*api.Event, error)</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"Create"</span>)</div><div class="line">	<span class="keyword">return</span> e, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// UpdateEvent records the event for testing.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *testEventSink)</span> <span class="title">Update</span><span class="params">(e *api.Event)</span> <span class="params">(*api.Event, error)</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"Update"</span>)</div><div class="line">	<span class="keyword">return</span> e, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// PatchEvent records the event for testing.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *testEventSink)</span> <span class="title">Patch</span><span class="params">(e *api.Event, p []<span class="keyword">byte</span>)</span> <span class="params">(*api.Event, error)</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"Patch"</span>)</div><div class="line">	<span class="keyword">return</span> e, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">//	ref := &amp;api.ObjectReference&#123;</span></div><div class="line">	<span class="comment">//		Kind:       "Pod",</span></div><div class="line">	<span class="comment">//		Name:       "foo",</span></div><div class="line">	<span class="comment">//		Namespace:  "baz",</span></div><div class="line">	<span class="comment">//		UID:        "bar",</span></div><div class="line">	<span class="comment">//		APIVersion: "version",</span></div><div class="line">	<span class="comment">//	&#125;</span></div><div class="line">	testPod := &amp;api.Pod&#123;</div><div class="line">		TypeMeta: unversioned.TypeMeta&#123;</div><div class="line">			Kind:       <span class="string">"Pod"</span>,</div><div class="line">			APIVersion: <span class="string">"v1"</span>,</div><div class="line">		&#125;,</div><div class="line">		ObjectMeta: api.ObjectMeta&#123;</div><div class="line">			Name:      <span class="string">"foo"</span>,</div><div class="line">			Namespace: <span class="string">"baz"</span>,</div><div class="line">		&#125;,</div><div class="line">	&#125;</div><div class="line">	eventBroadcaster := record.NewBroadcaster()</div><div class="line">	<span class="comment">//直接输出</span></div><div class="line">	eventBroadcaster.StartLogging(<span class="function"><span class="keyword">func</span><span class="params">(formatter <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">		fmt.Printf(formatter, args...)</div><div class="line">	&#125;)</div><div class="line">	<span class="comment">//交给testEventSink处理</span></div><div class="line">	eventBroadcaster.StartRecordingToSink(&amp;testEventSink&#123;&#125;)</div><div class="line">	recorder := eventBroadcaster.NewRecorder(api.EventSource&#123;Component: <span class="string">"testComponent"</span>&#125;)</div><div class="line">	<span class="comment">//记录事件</span></div><div class="line">	recorder.Event(testPod, api.EventTypeNormal, <span class="string">"Get"</span>, <span class="string">"Get a pod"</span>)</div><div class="line">	<span class="keyword">select</span> &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Create</div><div class="line">Event(api.ObjectReference&#123;Kind:&quot;Pod&quot;, Namespace:&quot;baz&quot;, Name:&quot;foo&quot;, UID:&quot;&quot;, APIVersion:&quot;v1&quot;, ResourceVersion:&quot;&quot;, FieldPath:&quot;&quot;&#125;): type: &apos;Normal&apos; reason: &apos;Get&apos; Get a pod</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/11/Event机制源码分析-v1-5-2/" data-id="cj5ule83a0002ecqszulqcrgm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Config机制使用-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/09/Config机制使用-v1-5-2/" class="article-date">
  <time datetime="2017-07-09T01:43:39.000Z" itemprop="datePublished">2017-07-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/09/Config机制使用-v1-5-2/">Config机制使用-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是Config机制"><a href="#什么是Config机制" class="headerlink" title="什么是Config机制"></a>什么是Config机制</h2><p>在部署Kubernetes https通信环境时，最困难的是各组件的参数的配置，而Kubernetes的Config机制就是为了方便https通信环境搭建的一种手段。组件可以通过读取Config中的内容自动完成密钥参数的配置。</p>
<h2 id="生成认证密钥"><a href="#生成认证密钥" class="headerlink" title="生成认证密钥"></a>生成认证密钥</h2><p>要使用https进行通信，首先得需要生成密钥。我的环境是一台虚拟机设备，我把密钥放在/etc/kubernetes/security/serverkey目录下。在生成证书的时候，还使用了多域名机制，方便环境的使用。</p>
<h3 id="修改openssl-cnf"><a href="#修改openssl-cnf" class="headerlink" title="修改openssl.cnf"></a>修改openssl.cnf</h3><p>首先拷贝openssl.cnf到/etc/kubernetes/security/serverkey目录下。<br><code>cp /etc/ssl/openssl.cnf ./</code></p>
<p>对openssl.cnf作如下修改，其中[ alt_names ]自己添加。alt_names中表明生成的密钥针对访问kubernetes, k8s, 10.100.0.1(为了能直接使用ServiceAccount，具体IP请根据自己的service网段来配置)的请求有效，alt_names之外的域名都无效。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">req_extensions = v3_req</div><div class="line"></div><div class="line">[ v3_req ]</div><div class="line"></div><div class="line"># Extensions to add to a certificate request</div><div class="line"></div><div class="line">basicConstraints = CA:FALSE</div><div class="line">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</div><div class="line">subjectAltName = @alt_names</div><div class="line"></div><div class="line">[ alt_names ]</div><div class="line">DNS.1 = kubernetes</div><div class="line">DNS.2 = k8s</div><div class="line">IP.1 = 10.100.0.1</div></pre></td></tr></table></figure>
<h3 id="生成密钥"><a href="#生成密钥" class="headerlink" title="生成密钥"></a>生成密钥</h3><p>首先，在/etc/kubernetes/security/serverkey目录下完成如下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir -p demoCA/&#123;certs,crl,newcerts,private&#125;</div><div class="line">touch demoCA/index.txt</div><div class="line">echo 00 &gt; demoCA/serial</div></pre></td></tr></table></figure></p>
<p>在下面步骤中需要输入PEM，要记住此密码。其他信息按照自己的具体情况赶写：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">root@fankang:/etc/kubernetes/security/serverkey# openssl req -new -x509 -days 3650 -keyout ca.key -out ca.crt -config openssl.cnf</div><div class="line">Generating a 2048 bit RSA private key</div><div class="line">.......................................................................................+++</div><div class="line">.......+++</div><div class="line">writing new private key to &apos;ca.key&apos;</div><div class="line">Enter PEM pass phrase:</div><div class="line">Verifying - Enter PEM pass phrase:</div><div class="line">-----</div><div class="line">You are about to be asked to enter information that will be incorporated</div><div class="line">into your certificate request.</div><div class="line">What you are about to enter is what is called a Distinguished Name or a DN.</div><div class="line">There are quite a few fields but you can leave some blank</div><div class="line">For some fields there will be a default value,</div><div class="line">If you enter &apos;.&apos;, the field will be left blank.</div><div class="line">-----</div><div class="line">Country Name (2 letter code) [AU]:CN</div><div class="line">State or Province Name (full name) [Some-State]:Zhejiang</div><div class="line">Locality Name (eg, city) []:Hangzhou</div><div class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:abc</div><div class="line">Organizational Unit Name (eg, section) []:abc</div><div class="line">Common Name (e.g. server FQDN or YOUR name) []:abc</div><div class="line">Email Address []:fankangbest@139.com</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">root@fankang:/etc/kubernetes/security/serverkey# openssl genrsa -out server.key 2048</div><div class="line">Generating RSA private key, 2048 bit long modulus</div><div class="line">..................+++</div><div class="line">................................+++</div><div class="line">e is 65537 (0x10001)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">root@fankang:/etc/kubernetes/security/serverkey# openssl genrsa -out server.key 2048</div><div class="line">Generating RSA private key, 2048 bit long modulus</div><div class="line">..................+++</div><div class="line">................................+++</div><div class="line">e is 65537 (0x10001)</div><div class="line">root@fankang:/etc/kubernetes/security/serverkey# openssl req -new -key server.key -out server.csr -config openssl.cnf</div><div class="line">You are about to be asked to enter information that will be incorporated</div><div class="line">into your certificate request.</div><div class="line">What you are about to enter is what is called a Distinguished Name or a DN.</div><div class="line">There are quite a few fields but you can leave some blank</div><div class="line">For some fields there will be a default value,</div><div class="line">If you enter &apos;.&apos;, the field will be left blank.</div><div class="line">-----</div><div class="line">Country Name (2 letter code) [AU]:CN</div><div class="line">State or Province Name (full name) [Some-State]:Zhejiang</div><div class="line">Locality Name (eg, city) []:Hangzhou</div><div class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:abc</div><div class="line">Organizational Unit Name (eg, section) []:abc</div><div class="line">Common Name (e.g. server FQDN or YOUR name) []:abc</div><div class="line">Email Address []:fankangbest@139.com</div><div class="line"></div><div class="line">Please enter the following &apos;extra&apos; attributes</div><div class="line">to be sent with your certificate request</div><div class="line">A challenge password []:123456</div><div class="line">An optional company name []:123456</div></pre></td></tr></table></figure>
<p>在Enter pass phrase for ca.key中输入的是之前我们设置的PEM密码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">root@fankang:/etc/kubernetes/security/serverkey# openssl ca -in server.csr -out server.crt -cert ca.crt -keyfile ca.key -extensions v3_req -config openssl.cnf</div><div class="line">Using configuration from openssl.cnf</div><div class="line">Enter pass phrase for ca.key:</div><div class="line">Check that the request matches the signature</div><div class="line">Signature ok</div><div class="line">Certificate Details:</div><div class="line">        Serial Number: 0 (0x0)</div><div class="line">        Validity</div><div class="line">            Not Before: Jul  9 01:06:49 2017 GMT</div><div class="line">            Not After : Jul  9 01:06:49 2018 GMT</div><div class="line">        Subject:</div><div class="line">            countryName               = CN</div><div class="line">            stateOrProvinceName       = Zhejiang</div><div class="line">            organizationName          = abc</div><div class="line">            organizationalUnitName    = abc</div><div class="line">            commonName                = abc</div><div class="line">            emailAddress              = fankangbest@139.com</div><div class="line">        X509v3 extensions:</div><div class="line">            X509v3 Basic Constraints: </div><div class="line">                CA:FALSE</div><div class="line">            X509v3 Key Usage: </div><div class="line">                Digital Signature, Non Repudiation, Key Encipherment</div><div class="line">            X509v3 Subject Alternative Name: </div><div class="line">                DNS:kubernetes, DNS:k8s, IP Address:10.100.0.1</div><div class="line">Certificate is to be certified until Jul  9 01:06:49 2018 GMT (365 days)</div><div class="line">Sign the certificate? [y/n]:y</div><div class="line"></div><div class="line"></div><div class="line">1 out of 1 certificate requests certified, commit? [y/n]y</div><div class="line">Write out database with 1 new entries</div><div class="line">Data Base Updated</div></pre></td></tr></table></figure></p>
<p>现在，在/etc/kubernetes/security/serverkey中有如下文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@fankang:/etc/kubernetes/security/serverkey# ls</div><div class="line">ca.crt  ca.key  demoCA  openssl.cnf  server.crt  server.csr  server.key</div></pre></td></tr></table></figure></p>
<p>密钥生成完毕，支持的域名有kubernetes, k8s, 10.100.0.1。</p>
<h2 id="配置config"><a href="#配置config" class="headerlink" title="配置config"></a>配置config</h2><p>在Kubernetes中，默认的config文件为/root/.kube/config。在config中写入下面信息即完成config的创建：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: Config</div><div class="line">users:</div><div class="line">- name: node</div><div class="line">  user:</div><div class="line">    client-certificate: /etc/kubernetes/security/serverkey/server.crt</div><div class="line">    client-key: /etc/kubernetes/security/serverkey/server.key</div><div class="line">clusters:</div><div class="line">- name: local</div><div class="line">  cluster:</div><div class="line">    certificate-authority: /etc/kubernetes/security/serverkey/ca.crt</div><div class="line">    server: https://kubernets:6443</div><div class="line">contexts:</div><div class="line">- context:</div><div class="line">    cluster: local</div><div class="line">    user: node</div><div class="line">  name: my-context</div><div class="line">current-context: my-context</div></pre></td></tr></table></figure></p>
<p>在config文件中，先定义了名为node的user，里面包含了生成好的密钥，然后定义了一个名为local的cluster，接着定义了my-context，最后，我们置my-context生效。</p>
<p>因为我们在config文件中使用了kubernetes作为访问apiserver的入口，但kubernetes域名是不存在的，所以我们需要在主机的/etc/hosts中添加域名kubernetes所对应的IP：<br><code>127.0.0.1 kubernetes</code></p>
<h2 id="起Kubernetes进程"><a href="#起Kubernetes进程" class="headerlink" title="起Kubernetes进程"></a>起Kubernetes进程</h2><p>为了方便调试，我都是直接从二进制文件拉起所有服务的:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(dockerd -H 0.0.0.0:4243 -H unix:///var/run/docker.sock &amp;&gt;&gt; /var/log/docker.log &amp;)</div><div class="line">(etcd --data-dir=/home/fankang/data/etcd150/ --listen-client-urls http://0.0.0.0:4001 --advertise-client-urls http://0.0.0.0:4001 &amp;&gt;&gt; /var/log/etcd.log &amp;)</div><div class="line">(等待20秒再启Kubernetes进程，否则apiserver会因连不上etcd而退出)</div><div class="line">(kube-apiserver --logtostderr=true --v=0 --etcd-servers=http://localhost:4001 --insecure-bind-address=0.0.0.0 --allow-privileged=false --service-cluster-ip-range=10.100.0.0/16 --admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota --client-ca-file=/etc/kubernetes/security/serverkey/ca.crt --tls-private-key-file=/etc/kubernetes/security/serverkey/server.key --tls-cert-file=/etc/kubernetes/security/serverkey/server.crt &amp;&gt;&gt; /var/log/kube-apiserver.log &amp;)</div><div class="line">(kube-controller-manager --logtostderr=true --v=0 --kubeconfig=/root/.kube/config &amp;&gt;&gt; /var/log/kube-controller-manager.log &amp;)</div><div class="line">(kube-scheduler --logtostderr=true --v=0 --kubeconfig=/root/.kube/config &amp;&gt;&gt; /var/log/kube-scheduler.log &amp;)</div><div class="line">(kube-proxy --logtostderr=true --v=0 --kubeconfig=/root/.kube/config &amp;&gt;&gt; /var/log/kube-proxy.log &amp;)</div><div class="line">(kubelet --logtostderr=true --v=0 --address=0.0.0.0 --allow-privileged=false --pod-infra-container-image=pause:0.8.0 --cpu-cfs-quota=true --kubeconfig=/root/.kube/config --require-kubeconfig=True &amp;&gt;&gt; /var/log/kubelet.log &amp;)</div></pre></td></tr></table></figure></p>
<h2 id="kubectl使用Config"><a href="#kubectl使用Config" class="headerlink" title="kubectl使用Config"></a>kubectl使用Config</h2><p>Kubectl会直接读取/root/.kube/config中的配置信息和kube-apiserver通信。如果把config中的server改为10.100.0.1:443，那么kubectl就是通过10.100.0.1获取内容的。下面就是更改后kubectl在–v=9时打印出来的日志，kubectl访问的是10.100.0.1：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">I0709 10:21:41.636415   21126 round_trippers.go:299] curl -k -v -XGET  -H &quot;Accept: application/json&quot; -H &quot;User-Agent: kubectl/v1.5.2+08e0995 (linux/amd64) kubernetes/08e0995&quot; https://10.100.0.1:443/api/v1/namespaces/default/pods</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>感觉Config机制就是把复杂的配置放到Config中，通过node, cluster, context的概念来构造目前环境的配置，这样在使用时就可以屏蔽复杂的细节。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/09/Config机制使用-v1-5-2/" data-id="cj5ule82w0000ecqsayezrbf8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ServiceAccount使用-v1-5-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/08/ServiceAccount使用-v1-5-2/" class="article-date">
  <time datetime="2017-07-08T11:36:48.000Z" itemprop="datePublished">2017-07-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器虚拟化/">容器虚拟化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/08/ServiceAccount使用-v1-5-2/">ServiceAccount使用-v1.5.2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是ServiceAccount"><a href="#什么是ServiceAccount" class="headerlink" title="什么是ServiceAccount"></a>什么是ServiceAccount</h2><p>ServiceAccount是Kubernetes中容器用来访问default空间下kubernetes服务的认证机制。我们可以通过kubectl get svc来查看kubernetes服务：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@fankang:/home/fankang# kubectl get svc kubernetes</div><div class="line">NAME         CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</div><div class="line">kubernetes   10.100.0.1   &lt;none&gt;        443/TCP   189d</div></pre></td></tr></table></figure></p>
<p>访问kubernetes等同于kube-apiserver的认证端口。当把ServiceAcount的信息传递给容器后，容器中的进程便可以使用ServiceAccount包含的Secret访问kubernetes服务，即10.100.0.1地址。</p>
<p>那么哪些服务需要访问kubernetes服务呢，比如heapster，ingress-controller等，这些都需要从kube-apiserver获取系统资源。</p>
<h2 id="生成ServiceAccount"><a href="#生成ServiceAccount" class="headerlink" title="生成ServiceAccount"></a>生成ServiceAccount</h2><p> 先来看下如何搭建带ServiceAccount的Kubernetes环境。我的实验环境是虚拟机单机环境，为了方便测试，所有进程都是直接从二进制文件拉起，所以读者需要依据自己的环境修改启动参数。关于key和config机制，请参考另外的相关文章。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">(dockerd -H 0.0.0.0:4243 -H unix:///var/run/docker.sock &amp;&gt;&gt; /var/log/docker.log &amp;)</div><div class="line"></div><div class="line">(etcd --data-dir=/home/fankang/data/etcd150/ --listen-client-urls http://0.0.0.0:4001 --advertise-client-urls http://0.0.0.0:4001 &amp;&gt;&gt; /var/log/etcd.log &amp;)</div><div class="line">(启动etcd后稍后启动kubenetes进程)</div><div class="line"></div><div class="line">(kube-apiserver --logtostderr=true --v=0 --etcd-servers=http://localhost:4001 --insecure-bind-address=0.0.0.0 --allow-privileged=false --service-cluster-ip-range=10.100.0.0/16 --admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota,ServiceAccount --client-ca-file=/etc/kubernetes/security/serverkey/ca.crt --tls-private-key-file=/etc/kubernetes/security/serverkey/server.key --tls-cert-file=/etc/kubernetes/security/serverkey/server.crt &amp;&gt;&gt; /var/log/kube-apiserver.log &amp;)</div><div class="line"></div><div class="line">(kube-controller-manager --logtostderr=true --v=0 --kubeconfig=/root/.kube/config --service_account_private_key_file=/etc/kubernetes/security/serverkey/server.key --root-ca-file=/etc/kubernetes/security/serverkey/ca.crt &amp;&gt;&gt; /var/log/kube-controller-manager.log &amp;)</div><div class="line"></div><div class="line">(kube-scheduler --logtostderr=true --v=0 --kubeconfig=/root/.kube/config &amp;&gt;&gt; /var/log/kube-scheduler.log &amp;)</div><div class="line"></div><div class="line">(kube-proxy --logtostderr=true --v=0 --kubeconfig=/root/.kube/config &amp;&gt;&gt; /var/log/kube-proxy.log &amp;)</div><div class="line"></div><div class="line">(kubelet --logtostderr=true --v=0 --address=0.0.0.0 --allow-privileged=false --pod-infra-container-image=pause:0.8.0 --cpu-cfs-quota=true --kubeconfig=/root/.kube/config --require-kubeconfig=True &amp;&gt;&gt; /var/log/kubelet.log &amp;)</div></pre></td></tr></table></figure></p>
<p>下面我们以default空间为例来查看ServiceAccount。</p>
<p>进程启动完成后，可以通过kubectl get secret查看在default空间(其他空间下类似)下是否有default-token:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@fankang:/home/fankang# kubectl get secret</div><div class="line">NAME                  TYPE                                  DATA      AGE</div><div class="line">default-token-zg893   kubernetes.io/service-account-token   3         8d</div></pre></td></tr></table></figure></p>
<p>default-token中包含有ca.crt, namespace, token三个字段信息，且都是base64编码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">root@fankang:/home/fankang# kubectl get secret default-token-zg893 -o yaml</div><div class="line">apiVersion: v1</div><div class="line">data:</div><div class="line">  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQ5VENDQXQyZ0F3SUJBZ0lKQUpQbWJ1cm4xNXAzTUEwR0NTcUdTSWIzRFFFQkN3VUFNSUdRTVFzd0NRWUQKVlFRR0V3SkRUakVSTUE4R0ExVUVDQXdJV21obGFtbGhibWN4RVRBUEJnTlZCQWNNQ0VoaGJtZDZhRzkxTVJBdwpEZ1lEVlFRS0RBZG9hV3RrWVhSaE1SQXdEZ1lEVlFRTERBZG9hV3RrWVhSaE1STXdFUVlEVlFRRERBcHJkV0psCmNtNWxkR1Z6TVNJd0lBWUpLb1pJaHZjTkFRa0JGaE5tWVc1cllXNW5RR2hwYTJSaGRHRXVZMjl0TUI0WERURTMKTURZeU9URXlNamt5TUZvWERUSTNNRFl5TnpFeU1qa3lNRm93Z1pBeEN6QUpCZ05WQkFZVEFrTk9NUkV3RHdZRApWUVFJREFoYWFHVnFhV0Z1WnpFUk1BOEdBMVVFQnd3SVNHRnVaM3BvYjNVeEVEQU9CZ05WQkFvTUIyaHBhMlJoCmRHRXhFREFPQmdOVkJBc01CMmhwYTJSaGRHRXhFekFSQmdOVkJBTU1DbXQxWW1WeWJtVjBaWE14SWpBZ0Jna3EKaGtpRzl3MEJDUUVXRTJaaGJtdGhibWRBYUdsclpHRjBZUzVqYjIwd2dnRWlNQTBHQ1NxR1NJYjNEUUVCQVFVQQpBNElCRHdBd2dnRUtBb0lCQVFDNzFrQmxaelp6Q1RhdDVIcm1FaUR5bTdLS1BoRm5nRkx5YzZmSmI0bTVVU0g0CkJWaitiTmYrYzkyd3hRZnNHTy9XNTlXaXV0T1N3YXgvSVZuWlBBRmd4NnEvNGdnR0l0VDdwVFFUbDR2SWpkc1IKMW1ZZmdqd0h5dThIOWxRYlRJOElFT3poMUozUzAvTVUwWUozdTFLOW9YT3JDa2Zha3NRWXVtVVdSbWVGTCtpTgp6azM5UGRPenE4SnFKajNqOWgxK3hIaEQzZC9MYkRqY0xDMWhjbHM4VldCWk9CR1QrVlR0elIwTHZzWEhKOVlhCkJ6YTlKYVJIVEpTeEU2NE1JNHRDR3B2TytOZjZOdjZnTUdkN2pJNnB0TDhabS8yYWs2R2tRRnRUVnNnam5lSFoKdXpOY0hkTnFTVEIycTZDNEZVWWZybzFDUkhaWUVrZWFWVSswSUNSMUFnTUJBQUdqVURCT01CMEdBMVVkRGdRVwpCQlNEMHBjeUMxNkpCSTA4TTNwWlI2WjlZMDNHVFRBZkJnTlZIU01FR0RBV2dCU0QwcGN5QzE2SkJJMDhNM3BaClI2WjlZMDNHVFRBTUJnTlZIUk1FQlRBREFRSC9NQTBHQ1NxR1NJYjNEUUVCQ3dVQUE0SUJBUUFZeXFtRm92ZDkKby9Ka1dzSlY5VXgzdWc4c0VWSHNSNXJTdXpSakJuWUQzakw1MkFFTDdKTjB0YTdwT0h3N3BaQWgyZXpobTJKSwprYnNGbjRpbzRiZ21TN2FLdHgxeGRVbnIvbXovMUhBbVFHS1dMQnFSMDdLUm9zY0JvdkpwMEpyYjlrQVk3Tm9SCnhONGRTNzBDM0ZvNlZHSTBrL3lwL1hnZkZnZU80R24yTnJiT0dDODRiNjBhYS9JWTM2T09uNFpUdFJSS0pZOUMKMDQwNyt1SmV6TThvakdkakRaMGpIN3hoMDJ3dFBWZTlnRk4yblpEVW5YYUF1SGtvbVJmWGFKS0pFbDNhcjZoRgplYjlHLzZVMURBTlkvK3JTRmZ5dFU1WCt6S3RqbjRudGRmMGRJckdtZ2s5d3plUFg3RWZZYWdvbW1MVUd0S1B4CmY4aTQ2VWJ6YUhGeAotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</div><div class="line">  namespace: ZGVmYXVsdA==</div><div class="line">  token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbVJsWm1GMWJIUXRkRzlyWlc0dGVtYzRPVE1pTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWkdWbVlYVnNkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJbVptWW1OaE1qazVMVFZqWXprdE1URmxOeTA1TnpZd0xUQTRNREF5TnpjeFpUTTVNeUlzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwa1pXWmhkV3gwT21SbFptRjFiSFFpZlEuRlN1TF9KMzQzdVl3eUJtSVVjMG02cXZKc2NITUM4YU1MNFJ1eVV4ZmtRcmk1amVlZXhuQzdCT0dqWnJmNURzWWFYa051ajZWb0d6RHk1M0FFdkIxdm5Hb0lhQkNLZXdFY1JyWW9nWmcxTk9pLUNqelFtYS02dE9ySkU2STZkUnJ4Q3dJb2ZsaWlRaTFRdDEwTlRYdVRwaG9IYnZ0X1JXLTBDeV9sdWg1amJQLTZ3RURUTzNEc24xSldfdGZSSktaejEzLWtTQ2RDVV9VS0gzektiaERvLTdTR1R5ZnJOTktDbldGSmd1R3VPWFFJMW15VHVxY0ZDSy1pQjlKNTdCeS1rMzQ1MmtrSTlsVlNRQmZIY3JPbXJaX1JvSWx0RXZxMnBudUFNcExtbWM4OG95RkwzLTFKdXBaV1FMRzQxazJFb0VHVmhYS1ZNOU11bXlubzJweTVn</div><div class="line">kind: Secret</div><div class="line">metadata:</div><div class="line">  annotations:</div><div class="line">    kubernetes.io/service-account.name: default</div><div class="line">    kubernetes.io/service-account.uid: ffbca299-5cc9-11e7-9760-08002771e393</div><div class="line">  creationTimestamp: 2017-06-29T12:55:57Z</div><div class="line">  name: default-token-zg893</div><div class="line">  namespace: default</div></pre></td></tr></table></figure></p>
<p>其中:</p>
<ul>
<li>ca.crt可以通过<code>cat ca.crt | base64</code>生成; </li>
<li>Namespace可以通过<code>echo -n &quot;kube-system&quot; | base64</code>生成; </li>
<li>Token随机生成。</li>
</ul>
<p>然后查看default空间下是否有default ServiceAccount：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@fankang:/home/fankang# kubectl get sa</div><div class="line">NAME      SECRETS   AGE</div><div class="line">default   1         8d</div></pre></td></tr></table></figure></p>
<p>此时的default ServiceAccount包含1个Secret，Secret名字就是上面提到的default-token:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">root@fankang:/home/fankang# kubectl get sa default -o yaml</div><div class="line">apiVersion: v1</div><div class="line">kind: ServiceAccount</div><div class="line">metadata:</div><div class="line">  creationTimestamp: 2017-06-29T12:53:50Z</div><div class="line">  name: default</div><div class="line">  namespace: default</div><div class="line">  resourceVersion: &quot;1243200&quot;</div><div class="line">  selfLink: /api/v1/namespaces/default/serviceaccounts/default</div><div class="line">  uid: ffbca299-5cc9-11e7-9760-08002771e393</div><div class="line">secrets:</div><div class="line">- name: default-token-zg893</div></pre></td></tr></table></figure></p>
<p>如果default ServiceAccount中不包含Secret，那么很可能是default-token不存在，请检查kube-controller-manager的–service_accoujnt_private_key_file和–root-ca-file两个参数是否正确，并重新启动kube-controller-manager。</p>
<h2 id="ServiceAccount使用"><a href="#ServiceAccount使用" class="headerlink" title="ServiceAccount使用"></a>ServiceAccount使用</h2><p>因为我们在kube-apiserver中的–admision-control中已经开启了ServiceAccount，那么我们就可以直接起容器来使用ServiceAccont。</p>
<p>我们来启动一个ubuntu-ssh的Deployment。Deployment代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: Deployment</div><div class="line">metadata: </div><div class="line">  name: ubuntu-ssh</div><div class="line">  namespace: default</div><div class="line">spec:</div><div class="line">  replicas: 1</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        app: ubuntu-ssh</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: ubuntu-ssh</div><div class="line">        image: ubuntu-ssh:v1</div><div class="line">        env:</div><div class="line">        - name: ROOT_PASSWORD</div><div class="line">          value: &quot;123456&quot;</div><div class="line">        ports:</div><div class="line">        - containerPort: 22</div><div class="line">          name: ssh</div><div class="line">        resources:</div><div class="line">          limits:</div><div class="line">            cpu: 100m</div><div class="line">            memory: 100Mi</div><div class="line">          requests:</div><div class="line">            cpu: 100m</div><div class="line">            memory: 100Mi</div></pre></td></tr></table></figure></p>
<p>待Pod启动完成后，可以看到容器中已经把default-token挂载到容器的/var/run/secrets/kubernetes.io/servicesaccount目录:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">root@fankang:/home/fankang# kubectl describe pods ubuntu-ssh-589933015-2lhgb</div><div class="line">Name:       ubuntu-ssh-589933015-2lhgb</div><div class="line">Namespace:  default</div><div class="line">Node:       fankang/10.0.2.15</div><div class="line">Start Time: Fri, 30 Jun 2017 14:32:40 +0800</div><div class="line">Labels:     app=ubuntu-ssh</div><div class="line">        pod-template-hash=589933015</div><div class="line">Status:     Running</div><div class="line">IP:     172.17.0.7</div><div class="line">Controllers:    ReplicaSet/ubuntu-ssh-589933015</div><div class="line">Containers:</div><div class="line">  ubuntu-ssh:</div><div class="line">    Container ID:   docker://5eb46b23c2d2237c98c6d6c0b47bdf37db9ede2ba2170a62aae8b3ecdc178574</div><div class="line">    Image:      ubuntu-ssh:v1</div><div class="line">    Image ID:       docker://sha256:27312dad4272a61739c317b90bfab5bc129e38696df5c606b1041199caf03ea4</div><div class="line">    Port:       22/TCP</div><div class="line">    Limits:</div><div class="line">      cpu:  100m</div><div class="line">      memory:   100Mi</div><div class="line">    Requests:</div><div class="line">      cpu:      100m</div><div class="line">      memory:       100Mi</div><div class="line">    State:      Running</div><div class="line">      Started:      Sat, 08 Jul 2017 18:35:40 +0800</div><div class="line">    Last State:     Terminated</div><div class="line">      Reason:       Completed</div><div class="line">      Exit Code:    0</div><div class="line">      Started:      Fri, 07 Jul 2017 14:13:58 +0800</div><div class="line">      Finished:     Fri, 07 Jul 2017 15:33:17 +0800</div><div class="line">    Ready:      True</div><div class="line">    Restart Count:  2</div><div class="line">    Volume Mounts:</div><div class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token (ro)</div><div class="line">    Environment Variables:</div><div class="line">      ROOT_PASSWORD:    123456</div><div class="line">Conditions:</div><div class="line">  Type      Status</div><div class="line">  Initialized   True </div><div class="line">  Ready     True </div><div class="line">  PodScheduled  True </div><div class="line">Volumes:</div><div class="line">  default-token:</div><div class="line">    Type:   Secret (a volume populated by a Secret)</div><div class="line">    SecretName: default-token-zg893</div><div class="line">QoS Class:  Guaranteed</div><div class="line">Tolerations:    &lt;none&gt;</div><div class="line">Events:</div><div class="line">  FirstSeen LastSeen    Count   From            SubObjectPath           Type        Reason          Message</div><div class="line">  --------- --------    -----   ----            -------------           --------    ------          -------</div><div class="line">  36m       36m     2   &#123;kubelet fankang&#125;                   Warning     MissingClusterDNS   kubelet does not have ClusterDNS IP configured and cannot create Pod using &quot;ClusterFirst&quot; policy. Falling back to DNSDefault policy.</div><div class="line">  36m       36m     1   &#123;kubelet fankang&#125;   spec.containers&#123;ubuntu-ssh&#125; Normal      Pulled          Container image &quot;ubuntu-ssh:v1&quot; already present on machine</div><div class="line">  36m       36m     1   &#123;kubelet fankang&#125;   spec.containers&#123;ubuntu-ssh&#125; Normal      Created         Created container with docker id 5eb46b23c2d2; Security:[seccomp=unconfined]</div><div class="line">  36m       36m     1   &#123;kubelet fankang&#125;   spec.containers&#123;ubuntu-ssh&#125; Normal      Started         Started container with docker id 5eb46b23c2d2</div></pre></td></tr></table></figure></p>
<p>在容器/var/run/secrets/kubernetes.io/servicesaccount目录下有ca.crt, namespace, token三个文件，这和default-token中的内容是对应的。然后到/var/run/secrets/kubernetes.io/serviceaccount目录下，执行下面语句访问kubernetes服务。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -H &quot;Authorization: Bearer `cat token`&quot; --cacert ca.crt -XGET https://10.100.0.1:443/api/v1/namespaces/default/pods -v</div></pre></td></tr></table></figure></p>
<h2 id="自挂载使用ServiceAccount"><a href="#自挂载使用ServiceAccount" class="headerlink" title="自挂载使用ServiceAccount"></a>自挂载使用ServiceAccount</h2><p>上节介绍了kube-apiserver开启ServiceAccount admission-controller情况下如何使用ServiceAccount。在该情况下，所有创建的Pod都会使用ServiceAccount，从而拥有访问kubernetes服务的能力。这当然不是我们希望看到的，我们希望部分容器可以访问kubernetes服务。</p>
<p>我们可以直接通过挂载ServiceAccount对应的secret来使用ServiceAccount。如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: Deployment</div><div class="line">metadata: </div><div class="line">  name: ubuntu-ssh</div><div class="line">  namespace: default</div><div class="line">spec:</div><div class="line">  replicas: 1</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        app: ubuntu-ssh</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: ubuntu-ssh</div><div class="line">        image: ubuntu-ssh:v1</div><div class="line">        env:</div><div class="line">        - name: ROOT_PASSWORD</div><div class="line">          value: &quot;123456&quot;</div><div class="line">        ports:</div><div class="line">        - containerPort: 22</div><div class="line">          name: ssh</div><div class="line">        resources:</div><div class="line">          limits:</div><div class="line">            cpu: 100m</div><div class="line">            memory: 100Mi</div><div class="line">          requests:</div><div class="line">            cpu: 100m</div><div class="line">            memory: 100Mi</div><div class="line">        volumeMounts:</div><div class="line">        - mountPath: /var/run/secrets/kubernetes.io/serviceaccount</div><div class="line">          name: default-token</div><div class="line">          readOnly: true</div><div class="line">      volumes:</div><div class="line">      - name: default-token</div><div class="line">        secret:</div><div class="line">          defaultMode: 420</div><div class="line">          secretName: default-token-zg893</div></pre></td></tr></table></figure></p>
<h2 id="使用自定义ServiceAccount"><a href="#使用自定义ServiceAccount" class="headerlink" title="使用自定义ServiceAccount"></a>使用自定义ServiceAccount</h2><p>一般来说，只要创建完ServiceAccount，kube-controller-manager会自动创建对应的secret，刚创建的ServiceAccount就有访问kubernetes的服务的权限。创建ServiceAccount的YAML文件如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: ServiceAccount</div><div class="line">metadata:</div><div class="line">  name: test-sa</div><div class="line">  namespace: default</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fankangbest.coding.me/2017/07/08/ServiceAccount使用-v1-5-2/" data-id="cj5ule8620015ecqsu1n55xiv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/kubernetes/" style="font-size: 10px;">kubernetes</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 10px;">kubernetes-v1.5.2</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/08/02/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2017/08/01/apimachinery机制解读(二)-GroupMetaFactory-v1-5-2/">apimachinery机制解读(二)-GroupMetaFactory-v1.5.2</a>
          </li>
        
          <li>
            <a href="/2017/07/31/apimachinery机制解读(一)-APIRegistrationManager-v1-5-2/">apimachinery机制解读(一)-APIRegistrationManager-v1.5.2</a>
          </li>
        
          <li>
            <a href="/2017/07/30/Scheme机制解读(三)-Cloner-v1-5-2/">Scheme机制解读(三)-Cloner-v1.5.2</a>
          </li>
        
          <li>
            <a href="/2017/07/29/Scheme机制解读(二)-Converter-v1-5-2/">Scheme机制解读(二)-Converter-v1.5.2</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 KangFAN<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>