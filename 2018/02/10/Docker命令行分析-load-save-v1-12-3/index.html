<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Docker命令行分析-load-save-v1.12.3 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Docker命令行分析-load-save-v1.12.3</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Docker命令行分析-load-save-v1.12.3</h1><div class="post-meta">Feb 10, 2018<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="tar包"><a href="#tar包" class="headerlink" title="tar包"></a>tar包</h2><p>docker load/save命令可以从tar包导入镜像或把镜像压缩成tar包(一般使用tar格式即可)，其中tar包中可以包含多个镜像。我们以命令行<code>docker save nginx:v1 golint:v1 &gt; test.tar</code>生成test.tar包，然后分析test.tar包中的内容。</p>
<h3 id="repositories"><a href="#repositories" class="headerlink" title="repositories"></a>repositories</h3><p>repositories文件中记录了该tar包包含的镜像及镜像最上层的layerID。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"golint"</span>: &#123;</div><div class="line">    <span class="attr">"v1"</span>: <span class="string">"47483a1b2c5e1cb2381d9ed73358753264063e70f329d3f8fffb51b4c861ab5e"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"nginx"</span>: &#123;</div><div class="line">    <span class="attr">"v1"</span>: <span class="string">"77b9c04c054e859ffc5d0bb6d89084dd543ffc2386ffbe17da7bc43147c10d49"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="manifest-json"><a href="#manifest-json" class="headerlink" title="manifest.json"></a>manifest.json</h3><p>manifest.json中记录了镜像的信息，包括：</p>
<ol>
<li>Config: 镜像的基本信息；</li>
<li>RepoTags: 镜像的tag名称；</li>
<li>Layers: 镜像中包含的层，为layerID/layer.tar。</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"Config"</span>: <span class="string">"3034d86f1f0b0379092bb99565d72c1dd4a94b41c1e83bb2d0714bb98720ac16.json"</span>,</div><div class="line">    <span class="attr">"RepoTags"</span>: [</div><div class="line">      <span class="string">"nginx:v1"</span></div><div class="line">    ],</div><div class="line">    <span class="attr">"Layers"</span>: [</div><div class="line">      <span class="string">"707f1f25f845bd495c21c368a57666f6c4e1b0358868e43e0376fd55512f8734/layer.tar"</span>,</div><div class="line">      <span class="string">"3fbeaf15931df30802b43e1147f6c40d3cbe2839bb91e49cf068e58dadb3ec90/layer.tar"</span>,</div><div class="line">      <span class="string">"a599739916ea730466ba3a21e5493faf34808cbddc8c3570933048d604cde37d/layer.tar"</span>,</div><div class="line">      <span class="string">"0cfdb29ee5612340e908c304954decd7a2c001405abeb475d8e773f66071211b/layer.tar"</span>,</div><div class="line">      <span class="string">"aa1b48ac3dd21b33515f37763a1f4cafce662496c6ed3c13326a818d8669f06a/layer.tar"</span>,</div><div class="line">      <span class="string">"90627bd0fa0408d7488e79525d6b2810987c5ed579f7f649993ca29a1d819a69/layer.tar"</span>,</div><div class="line">      <span class="string">"2a9bb8e69f5a34ead65daecf9ff156975e13c5a29bb27b0c93de879c2787d616/layer.tar"</span>,</div><div class="line">      <span class="string">"01a90859e4ca4e3138adbadb3a76be9014b0ea5b89b6ef24988e70e7d7bfe12b/layer.tar"</span>,</div><div class="line">      <span class="string">"e27a3a829a7d9d07bec30f000c722c47e428f9c4cc975dbe2b0dbffda189a8f7/layer.tar"</span>,</div><div class="line">      <span class="string">"77b9c04c054e859ffc5d0bb6d89084dd543ffc2386ffbe17da7bc43147c10d49/layer.tar"</span></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"Config"</span>: <span class="string">"8b3c2dabe960cf6ed115d1fbf4b93cc46e4e9823f3cfc1f430c96944024c7fa1.json"</span>,</div><div class="line">    <span class="attr">"RepoTags"</span>: [</div><div class="line">      <span class="string">"golint:v1"</span></div><div class="line">    ],</div><div class="line">    <span class="attr">"Layers"</span>: [</div><div class="line">      <span class="string">"707f1f25f845bd495c21c368a57666f6c4e1b0358868e43e0376fd55512f8734/layer.tar"</span>,</div><div class="line">      <span class="string">"3fbeaf15931df30802b43e1147f6c40d3cbe2839bb91e49cf068e58dadb3ec90/layer.tar"</span>,</div><div class="line">      <span class="string">"a599739916ea730466ba3a21e5493faf34808cbddc8c3570933048d604cde37d/layer.tar"</span>,</div><div class="line">      <span class="string">"0cfdb29ee5612340e908c304954decd7a2c001405abeb475d8e773f66071211b/layer.tar"</span>,</div><div class="line">      <span class="string">"aa1b48ac3dd21b33515f37763a1f4cafce662496c6ed3c13326a818d8669f06a/layer.tar"</span>,</div><div class="line">      <span class="string">"90627bd0fa0408d7488e79525d6b2810987c5ed579f7f649993ca29a1d819a69/layer.tar"</span>,</div><div class="line">      <span class="string">"2f96598b6febc88b8aa7fb649d8fef1ad08c3bc08e32866b0ca882ecd54608e3/layer.tar"</span>,</div><div class="line">      <span class="string">"8a4a76326100661bebca4c18a8465d2ab1c19f31083175345ccac623fd8e5810/layer.tar"</span>,</div><div class="line">      <span class="string">"9f10635765dbd0d56823ff9b303472a341e163af102f71c5f9abd9ee219a34d9/layer.tar"</span>,</div><div class="line">      <span class="string">"47483a1b2c5e1cb2381d9ed73358753264063e70f329d3f8fffb51b4c861ab5e/layer.tar"</span></div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<h3 id="image-id-json"><a href="#image-id-json" class="headerlink" title="image-id.json"></a>image-id.json</h3><p>image-id.json中记录了镜像相关的信息，包括，镜像的config信息，history信息，diffID信息等。</p>
<h2 id="Load流程"><a href="#Load流程" class="headerlink" title="Load流程"></a>Load流程</h2><p>接下来来看docker load的流程。</p>
<h3 id="client端"><a href="#client端" class="headerlink" title="client端"></a>client端</h3><p>先来看docker load命令的定义，在/api/client/image/load.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewLoadCommand creates a new `docker load` command</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLoadCommand</span><span class="params">(dockerCli *client.DockerCli)</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> opts loadOptions</div><div class="line"></div><div class="line">	cmd := &amp;cobra.Command&#123;</div><div class="line">		Use:   <span class="string">"load [OPTIONS]"</span>,</div><div class="line">		Short: <span class="string">"Load an image from a tar archive or STDIN"</span>,</div><div class="line">		Args:  cli.NoArgs,</div><div class="line">		RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">			<span class="keyword">return</span> runLoad(dockerCli, opts)</div><div class="line">		&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	flags := cmd.Flags()</div><div class="line"></div><div class="line">	flags.StringVarP(&amp;opts.input, <span class="string">"input"</span>, <span class="string">"i"</span>, <span class="string">""</span>, <span class="string">"Read from tar archive file, instead of STDIN"</span>)</div><div class="line">	flags.BoolVarP(&amp;opts.quiet, <span class="string">"quiet"</span>, <span class="string">"q"</span>, <span class="literal">false</span>, <span class="string">"Suppress the load output"</span>)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> cmd</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>runLoad()定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">runLoad</span><span class="params">(dockerCli *client.DockerCli, opts loadOptions)</span> <span class="title">error</span></span> &#123;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> input io.Reader = dockerCli.In()</div><div class="line">	<span class="keyword">if</span> opts.input != <span class="string">""</span> &#123;</div><div class="line">		file, err := os.Open(opts.input)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">defer</span> file.Close()</div><div class="line">		input = file</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> !dockerCli.IsTerminalOut() &#123;</div><div class="line">		opts.quiet = <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line">	response, err := dockerCli.Client().ImageLoad(context.Background(), input, opts.quiet)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> response.Body.Close()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> response.Body != <span class="literal">nil</span> &amp;&amp; response.JSON &#123;</div><div class="line">		<span class="keyword">return</span> jsonmessage.DisplayJSONMessagesStream(response.Body, dockerCli.Out(), dockerCli.OutFd(), dockerCli.IsTerminalOut(), <span class="literal">nil</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	_, err = io.Copy(dockerCli.Out(), response.Body)</div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，runLoad()主要调用client的ImageLoad()方法。</p>
<p>client的ImageLoad()方法定义在第三方库/engine-api/client/image_load.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli *Client)</span> <span class="title">ImageLoad</span><span class="params">(ctx context.Context, input io.Reader, quiet <span class="keyword">bool</span>)</span> <span class="params">(types.ImageLoadResponse, error)</span></span> &#123;</div><div class="line">	v := url.Values&#123;&#125;</div><div class="line">	v.Set(<span class="string">"quiet"</span>, <span class="string">"0"</span>)</div><div class="line">	<span class="keyword">if</span> quiet &#123;</div><div class="line">		v.Set(<span class="string">"quiet"</span>, <span class="string">"1"</span>)</div><div class="line">	&#125;</div><div class="line">	headers := <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>&#123;<span class="string">"Content-Type"</span>: &#123;<span class="string">"application/x-tar"</span>&#125;&#125;</div><div class="line">	resp, err := cli.postRaw(ctx, <span class="string">"/images/load"</span>, v, input, headers)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> types.ImageLoadResponse&#123;&#125;, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> types.ImageLoadResponse&#123;</div><div class="line">		Body: resp.body,</div><div class="line">		JSON: resp.header.Get(<span class="string">"Content-Type"</span>) == <span class="string">"application/json"</span>,</div><div class="line">	&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以，client的ImageLoad()方法是使用post方法请求/images/load。</p>
<h2 id="server端"><a href="#server端" class="headerlink" title="server端"></a>server端</h2><p>server端使用postImagesLoad()方法处理/images/load的post请求，定义在/api/server/router/image/image_routes.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *imageRouter)</span> <span class="title">postImagesLoad</span><span class="params">(ctx context.Context, w http.ResponseWriter, r *http.Request, vars <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err := httputils.ParseForm(r); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	quiet := httputils.BoolValueOrDefault(r, <span class="string">"quiet"</span>, <span class="literal">true</span>)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> !quiet &#123;</div><div class="line">		w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</div><div class="line"></div><div class="line">		output := ioutils.NewWriteFlusher(w)</div><div class="line">		<span class="keyword">defer</span> output.Close()</div><div class="line">		<span class="keyword">if</span> err := s.backend.LoadImage(r.Body, output, quiet); err != <span class="literal">nil</span> &#123;</div><div class="line">			output.Write(streamformatter.NewJSONStreamFormatter().FormatError(err))</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> s.backend.LoadImage(r.Body, w, quiet)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到postImagesLoad()方法调用了daemon的LoadImage()方法。</p>
<p>Daemon的LoadImage()方法定义在/daemon/image_exporter.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(daemon *Daemon)</span> <span class="title">LoadImage</span><span class="params">(inTar io.ReadCloser, outStream io.Writer, quiet <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	imageExporter := tarexport.NewTarExporter(daemon.imageStore, daemon.layerStore, daemon.referenceStore, daemon)</div><div class="line">	<span class="keyword">return</span> imageExporter.Load(inTar, outStream, quiet)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>LoadImage()先生成一个imageExporter，然后调用imageExporter.Load()完成</p>
<h3 id="imageExporter"><a href="#imageExporter" class="headerlink" title="imageExporter"></a>imageExporter</h3><p>我们来看imageExporter的Load()方法，定义在/image/tarexport/load.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *tarexporter)</span> <span class="title">Load</span><span class="params">(inTar io.ReadCloser, outStream io.Writer, quiet <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> (</div><div class="line">		sf             = streamformatter.NewJSONStreamFormatter()</div><div class="line">		progressOutput progress.Output</div><div class="line">	)</div><div class="line">	<span class="keyword">if</span> !quiet &#123;</div><div class="line">		progressOutput = sf.NewProgressOutput(outStream, <span class="literal">false</span>)</div><div class="line">		outStream = &amp;streamformatter.StdoutFormatter&#123;Writer: outStream, StreamFormatter: streamformatter.NewJSONStreamFormatter()&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***新建tmpdir，如/tmp/docker-import-583867624***//</span></div><div class="line">	tmpDir, err := ioutil.TempDir(<span class="string">""</span>, <span class="string">"docker-import-"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> os.RemoveAll(tmpDir)</div><div class="line"></div><div class="line">	<span class="comment">//***把inTar解压到tmpDir中***//</span></div><div class="line">	<span class="keyword">if</span> err := chrootarchive.Untar(inTar, tmpDir, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// read manifest, if no file then load in legacy mode</span></div><div class="line">	<span class="comment">//***tarexport.go: manifestFileName = "manifest.json"***//</span></div><div class="line">	manifestPath, err := safePath(tmpDir, manifestFileName)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***读取manifest.json***//</span></div><div class="line">	manifestFile, err := os.Open(manifestPath)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> os.IsNotExist(err) &#123;</div><div class="line">			<span class="keyword">return</span> l.legacyLoad(tmpDir, outStream, progressOutput)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> manifestFile.Close()</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> manifestFile.Close()</div><div class="line"></div><div class="line">	<span class="keyword">var</span> manifest []manifestItem</div><div class="line">	<span class="keyword">if</span> err := json.NewDecoder(manifestFile).Decode(&amp;manifest); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> parentLinks []parentLink</div><div class="line">	<span class="keyword">var</span> imageIDsStr <span class="keyword">string</span></div><div class="line">	<span class="keyword">var</span> imageRefCount <span class="keyword">int</span></div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, m := <span class="keyword">range</span> manifest &#123;</div><div class="line">		<span class="comment">//***"Config": "2765df43aea203fa44f069a44b984a27cb942551493e58b0d02b04ae22e5d644.json"***//</span></div><div class="line">		configPath, err := safePath(tmpDir, m.Config)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***读取config文件***//</span></div><div class="line">		config, err := ioutil.ReadFile(configPath)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***从config生成image***//</span></div><div class="line">		img, err := image.NewFromJSON(config)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">var</span> rootFS image.RootFS</div><div class="line">		rootFS = *img.RootFS</div><div class="line">		rootFS.DiffIDs = <span class="literal">nil</span></div><div class="line"></div><div class="line">		<span class="keyword">if</span> expected, actual := <span class="built_in">len</span>(m.Layers), <span class="built_in">len</span>(img.RootFS.DiffIDs); expected != actual &#123;</div><div class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"invalid manifest, layers length mismatch: expected %q, got %q"</span>, expected, actual)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//***处理每一镜像层***//</span></div><div class="line">		<span class="comment">//***diffID由镜像层的tar包hash得到***//</span></div><div class="line">		<span class="keyword">for</span> i, diffID := <span class="keyword">range</span> img.RootFS.DiffIDs &#123;</div><div class="line">			<span class="comment">//***Fankang***//</span></div><div class="line">			<span class="comment">//***Layers和img.RootFS.DiffIDs是一一对应的***//</span></div><div class="line">			layerPath, err := safePath(tmpDir, m.Layers[i])</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">			r := rootFS</div><div class="line">			r.Append(diffID)</div><div class="line">			<span class="comment">//***此处Get()操作仅仅为了在不存在的时候调用loadLayer()而已***//</span></div><div class="line">			newLayer, err := l.ls.Get(r.ChainID())</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="comment">//***调用loadLayer()***//</span></div><div class="line">				newLayer, err = l.loadLayer(layerPath, rootFS, diffID.String(), m.LayerSources[diffID], progressOutput)</div><div class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">					<span class="keyword">return</span> err</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">defer</span> layer.ReleaseAndLog(l.ls, newLayer)</div><div class="line">			<span class="keyword">if</span> expected, actual := diffID, newLayer.DiffID(); expected != actual &#123;</div><div class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">"invalid diffID for layer %d: expected %q, got %q"</span>, i, expected, actual)</div><div class="line">			&#125;</div><div class="line">			rootFS.Append(diffID)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//***在imagedb中存储config***//</span></div><div class="line">		imgID, err := l.is.Create(config)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		imageIDsStr += fmt.Sprintf(<span class="string">"Loaded image ID: %s\n"</span>, imgID)</div><div class="line"></div><div class="line">		imageRefCount = <span class="number">0</span></div><div class="line">		<span class="comment">//***处理manifest.json中的RepoTags***//</span></div><div class="line">		<span class="keyword">for</span> _, repoTag := <span class="keyword">range</span> m.RepoTags &#123;</div><div class="line">			named, err := reference.ParseNamed(repoTag)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">			ref, ok := named.(reference.NamedTagged)</div><div class="line">			<span class="keyword">if</span> !ok &#123;</div><div class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">"invalid tag %q"</span>, repoTag)</div><div class="line">			&#125;</div><div class="line">			l.setLoadedTag(ref, imgID, outStream)</div><div class="line">			outStream.Write([]<span class="keyword">byte</span>(fmt.Sprintf(<span class="string">"Loaded image: %s\n"</span>, ref)))</div><div class="line">			imageRefCount++</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		parentLinks = <span class="built_in">append</span>(parentLinks, parentLink&#123;imgID, m.Parent&#125;)</div><div class="line">		l.loggerImgEvent.LogImageEvent(imgID.String(), imgID.String(), <span class="string">"load"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***处理parent关系***//</span></div><div class="line">	<span class="keyword">for</span> _, p := <span class="keyword">range</span> validatedParentLinks(parentLinks) &#123;</div><div class="line">		<span class="keyword">if</span> p.parentID != <span class="string">""</span> &#123;</div><div class="line">			<span class="comment">//***调用setParentID***//</span></div><div class="line">			<span class="keyword">if</span> err := l.setParentID(p.id, p.parentID); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> imageRefCount == <span class="number">0</span> &#123;</div><div class="line">		outStream.Write([]<span class="keyword">byte</span>(imageIDsStr))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Load()的流程如下：</p>
<ol>
<li>建立tmpDir，把tar包解压到该目录中(通过chrootarchive包完成)；</li>
<li>读取manifest.json，分别按下面流程处理每一个镜像；</li>
<li>读取镜像的config文件，并在生成image对象；</li>
<li>调用LoadLayer()方法处理镜像每一层；</li>
<li>调用imageStore的Create()在imageStore中创建该镜像；</li>
<li>处理manifest.json中的tag名称；</li>
<li>处理parent关系。</li>
</ol>
<p>这里具体每个细节的实现就不再展开分析，基本上调用了iamgeStore, layerStore, referenceStore这些Store中定义的方法。</p>
<h2 id="Save流程"><a href="#Save流程" class="headerlink" title="Save流程"></a>Save流程</h2><p>接下来来看docker save的流程。</p>
<h3 id="client端-1"><a href="#client端-1" class="headerlink" title="client端"></a>client端</h3><p>docker save定义在/api/client/image/save.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewSaveCommand creates a new `docker save` command</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSaveCommand</span><span class="params">(dockerCli *client.DockerCli)</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> opts saveOptions</div><div class="line"></div><div class="line">	cmd := &amp;cobra.Command&#123;</div><div class="line">		Use:   <span class="string">"save [OPTIONS] IMAGE [IMAGE...]"</span>,</div><div class="line">		Short: <span class="string">"Save one or more images to a tar archive (streamed to STDOUT by default)"</span>,</div><div class="line">		Args:  cli.RequiresMinArgs(<span class="number">1</span>),</div><div class="line">		RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">			opts.images = args</div><div class="line">			<span class="keyword">return</span> runSave(dockerCli, opts)</div><div class="line">		&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	flags := cmd.Flags()</div><div class="line"></div><div class="line">	flags.StringVarP(&amp;opts.output, <span class="string">"output"</span>, <span class="string">"o"</span>, <span class="string">""</span>, <span class="string">"Write to a file, instead of STDOUT"</span>)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> cmd</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，NewSaveCommand()会把args赋值给opts.images。<br>runSave()定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">runSave</span><span class="params">(dockerCli *client.DockerCli, opts saveOptions)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> opts.output == <span class="string">""</span> &amp;&amp; dockerCli.IsTerminalOut() &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"Cowardly refusing to save to a terminal. Use the -o flag or redirect."</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	responseBody, err := dockerCli.Client().ImageSave(context.Background(), opts.images)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> responseBody.Close()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> opts.output == <span class="string">""</span> &#123;</div><div class="line">		_, err := io.Copy(dockerCli.Out(), responseBody)</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> client.CopyToFile(opts.output, responseBody)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>runSave()主要调用client的ImageSave()方法。</p>
<p>client的ImageSave()方法定义在第三方库/engine-api/client/image_save.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli *Client)</span> <span class="title">ImageSave</span><span class="params">(ctx context.Context, imageIDs []<span class="keyword">string</span>)</span> <span class="params">(io.ReadCloser, error)</span></span> &#123;</div><div class="line">	query := url.Values&#123;</div><div class="line">		<span class="string">"names"</span>: imageIDs,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	resp, err := cli.get(ctx, <span class="string">"/images/get"</span>, query, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> resp.body, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ImageSave()把images封装在names中，然后使用GET方法请求/images/get路径。</p>
<h3 id="server端-1"><a href="#server端-1" class="headerlink" title="server端"></a>server端</h3><p>server端通过getImageGet()方法处理/images/get的GET请求，定义在/api/server/router/image/image_routes.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *imageRouter)</span> <span class="title">getImagesGet</span><span class="params">(ctx context.Context, w http.ResponseWriter, r *http.Request, vars <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err := httputils.ParseForm(r); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/x-tar"</span>)</div><div class="line"></div><div class="line">	output := ioutils.NewWriteFlusher(w)</div><div class="line">	<span class="keyword">defer</span> output.Close()</div><div class="line">	<span class="keyword">var</span> names []<span class="keyword">string</span></div><div class="line">	<span class="keyword">if</span> name, ok := vars[<span class="string">"name"</span>]; ok &#123;</div><div class="line">		names = []<span class="keyword">string</span>&#123;name&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		names = r.Form[<span class="string">"names"</span>]</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := s.backend.ExportImage(names, output); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> !output.Flushed() &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		sf := streamformatter.NewJSONStreamFormatter()</div><div class="line">		output.Write(sf.FormatError(err))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>getImagesGet()先从请求中解析出names，然后调用daemon的ExportImage()来导出所有镜像。</p>
<p>daemon的ExportImage()定义在/daemon/image_exporter.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(daemon *Daemon)</span> <span class="title">ExportImage</span><span class="params">(names []<span class="keyword">string</span>, outStream io.Writer)</span> <span class="title">error</span></span> &#123;</div><div class="line">	imageExporter := tarexport.NewTarExporter(daemon.imageStore, daemon.layerStore, daemon.referenceStore, daemon)</div><div class="line">	<span class="keyword">return</span> imageExporter.Save(names, outStream)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ExportImage()先生成imageExporter，然后调用imageExporter.Save()完成镜像导出。</p>
<h3 id="imageExporter-1"><a href="#imageExporter-1" class="headerlink" title="imageExporter"></a>imageExporter</h3><p>来看Save()方法，定义在/image/tarexport/save.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *tarexporter)</span> <span class="title">Save</span><span class="params">(names []<span class="keyword">string</span>, outStream io.Writer)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***names:  [nginx:v1]***//</span></div><div class="line">	<span class="comment">//***images:  map[sha256:2765df43aea203fa44f069a44b984a27cb942551493e58b0d02b04ae22e5d644:0xc420a5bcb0]***//</span></div><div class="line">	images, err := l.parseNames(names)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> (&amp;saveSession&#123;tarexporter: l, images: images&#125;).save(outStream)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，最后调用的是saveSession的save()方法，定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *saveSession)</span> <span class="title">save</span><span class="params">(outStream io.Writer)</span> <span class="title">error</span></span> &#123;</div><div class="line">	s.savedLayers = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;)</div><div class="line">	s.diffIDPaths = <span class="built_in">make</span>(<span class="keyword">map</span>[layer.DiffID]<span class="keyword">string</span>)</div><div class="line"></div><div class="line">	<span class="comment">// get image json</span></div><div class="line">	tempDir, err := ioutil.TempDir(<span class="string">""</span>, <span class="string">"docker-export-"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> os.RemoveAll(tempDir)</div><div class="line"></div><div class="line">	s.outDir = tempDir</div><div class="line">	reposLegacy := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</div><div class="line"></div><div class="line">	<span class="keyword">var</span> manifest []manifestItem</div><div class="line">	<span class="keyword">var</span> parentLinks []parentLink</div><div class="line"></div><div class="line">	<span class="keyword">for</span> id, imageDescr := <span class="keyword">range</span> s.images &#123;</div><div class="line">		<span class="comment">//***调用saveImage()***//</span></div><div class="line">		foreignSrcs, err := s.saveImage(id)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">var</span> repoTags []<span class="keyword">string</span></div><div class="line">		<span class="keyword">var</span> layers []<span class="keyword">string</span></div><div class="line"></div><div class="line">		<span class="keyword">for</span> _, ref := <span class="keyword">range</span> imageDescr.refs &#123;</div><div class="line">			<span class="keyword">if</span> _, ok := reposLegacy[ref.Name()]; !ok &#123;</div><div class="line">				reposLegacy[ref.Name()] = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</div><div class="line">			&#125;</div><div class="line">			reposLegacy[ref.Name()][ref.Tag()] = imageDescr.layers[<span class="built_in">len</span>(imageDescr.layers)<span class="number">-1</span>]</div><div class="line">			repoTags = <span class="built_in">append</span>(repoTags, ref.String())</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">for</span> _, l := <span class="keyword">range</span> imageDescr.layers &#123;</div><div class="line">			layers = <span class="built_in">append</span>(layers, filepath.Join(l, legacyLayerFileName))</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***构造manifest文件***//</span></div><div class="line">		manifest = <span class="built_in">append</span>(manifest, manifestItem&#123;</div><div class="line">			Config:       digest.Digest(id).Hex() + <span class="string">".json"</span>,</div><div class="line">			RepoTags:     repoTags,</div><div class="line">			Layers:       layers,</div><div class="line">			LayerSources: foreignSrcs,</div><div class="line">		&#125;)</div><div class="line"></div><div class="line">		parentID, _ := s.is.GetParent(id)</div><div class="line">		parentLinks = <span class="built_in">append</span>(parentLinks, parentLink&#123;id, parentID&#125;)</div><div class="line">		s.tarexporter.loggerImgEvent.LogImageEvent(id.String(), id.String(), <span class="string">"save"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i, p := <span class="keyword">range</span> validatedParentLinks(parentLinks) &#123;</div><div class="line">		<span class="keyword">if</span> p.parentID != <span class="string">""</span> &#123;</div><div class="line">			manifest[i].Parent = p.parentID</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(reposLegacy) &gt; <span class="number">0</span> &#123;</div><div class="line">		reposFile := filepath.Join(tempDir, legacyRepositoriesFileName)</div><div class="line">		f, err := os.OpenFile(reposFile, os.O_RDWR|os.O_CREATE|os.O_TRUNC, <span class="number">0644</span>)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			f.Close()</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err := json.NewEncoder(f).Encode(reposLegacy); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err := f.Close(); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err := system.Chtimes(reposFile, time.Unix(<span class="number">0</span>, <span class="number">0</span>), time.Unix(<span class="number">0</span>, <span class="number">0</span>)); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	manifestFileName := filepath.Join(tempDir, manifestFileName)</div><div class="line">	<span class="comment">//***创建manifest.json文件***//</span></div><div class="line">	<span class="comment">//***O_RDWR: 读写模式；O_CREATE: 文件不存在就创建；O_TRUNC: 打开并清空文件***//</span></div><div class="line">	f, err := os.OpenFile(manifestFileName, os.O_RDWR|os.O_CREATE|os.O_TRUNC, <span class="number">0644</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		f.Close()</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***写入manifest***//</span></div><div class="line">	<span class="keyword">if</span> err := json.NewEncoder(f).Encode(manifest); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := f.Close(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := system.Chtimes(manifestFileName, time.Unix(<span class="number">0</span>, <span class="number">0</span>), time.Unix(<span class="number">0</span>, <span class="number">0</span>)); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***对临时文件进行压缩***//</span></div><div class="line">	fs, err := archive.Tar(tempDir, archive.Uncompressed)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> fs.Close()</div><div class="line"></div><div class="line">	<span class="comment">//***把tar包拷贝到当前目录***//</span></div><div class="line">	<span class="keyword">if</span> _, err := io.Copy(outStream, fs); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>save()方法调用saveImage()把镜像进行导出，然后处理manifest.json文件，这些，都在一个临时文件中，最后把临时文件中的数据打包到输出。</p>
<p>saveImage()定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *saveSession)</span> <span class="title">saveImage</span><span class="params">(id image.ID)</span> <span class="params">(<span class="keyword">map</span>[layer.DiffID]distribution.Descriptor, error)</span></span> &#123;</div><div class="line">	<span class="comment">//***获取image***//</span></div><div class="line">	img, err := s.is.Get(id)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(img.RootFS.DiffIDs) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"empty export - not implemented"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> parent digest.Digest</div><div class="line">	<span class="keyword">var</span> layers []<span class="keyword">string</span></div><div class="line">	<span class="keyword">var</span> foreignSrcs <span class="keyword">map</span>[layer.DiffID]distribution.Descriptor</div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> img.RootFS.DiffIDs &#123;</div><div class="line">		v1Img := image.V1Image&#123;&#125;</div><div class="line">		<span class="keyword">if</span> i == <span class="built_in">len</span>(img.RootFS.DiffIDs)<span class="number">-1</span> &#123;</div><div class="line">			v1Img = img.V1Image</div><div class="line">		&#125;</div><div class="line">		rootFS := *img.RootFS</div><div class="line">		rootFS.DiffIDs = rootFS.DiffIDs[:i+<span class="number">1</span>]</div><div class="line">		<span class="comment">//***rootFS.ChainID():  sha256:ea9f151abb7e06353e73172dad421235611d4f6d0560ec95db26e0dc240642c1***//</span></div><div class="line">		<span class="comment">//***CreateID可以获取镜像存储时的ID***//</span></div><div class="line">		v1ID, err := v1.CreateID(v1Img, rootFS.ChainID(), parent)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//***v1Img.ID:  2b8a5cc36c07cfb2a5bd6e40f9d5dd52fb300ab1a7afb6e22b3d977e3cfcb885***//</span></div><div class="line">		v1Img.ID = v1ID.Hex()</div><div class="line">		<span class="keyword">if</span> parent != <span class="string">""</span> &#123;</div><div class="line">			v1Img.Parent = parent.Hex()</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//***调用saveLayer()***//</span></div><div class="line">		src, err := s.saveLayer(rootFS.ChainID(), v1Img, img.Created)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">		layers = <span class="built_in">append</span>(layers, v1Img.ID)</div><div class="line">		<span class="comment">//***parent就是V1ID，供下次循环使用***//</span></div><div class="line">		parent = v1ID</div><div class="line">		<span class="keyword">if</span> src.Digest != <span class="string">""</span> &#123;</div><div class="line">			<span class="keyword">if</span> foreignSrcs == <span class="literal">nil</span> &#123;</div><div class="line">				foreignSrcs = <span class="built_in">make</span>(<span class="keyword">map</span>[layer.DiffID]distribution.Descriptor)</div><div class="line">			&#125;</div><div class="line">			foreignSrcs[img.RootFS.DiffIDs[i]] = src</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***把config写入xxxxxxxx.json文件***//</span></div><div class="line">	configFile := filepath.Join(s.outDir, digest.Digest(id).Hex()+<span class="string">".json"</span>)</div><div class="line">	<span class="keyword">if</span> err := ioutil.WriteFile(configFile, img.RawJSON(), <span class="number">0644</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := system.Chtimes(configFile, img.Created, img.Created); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	s.images[id].layers = layers</div><div class="line">	<span class="keyword">return</span> foreignSrcs, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>saveImage()会调用saveLayer()方法导出layer，最后生成镜像的config文件。</p>
<p>saveLayer()定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *saveSession)</span> <span class="title">saveLayer</span><span class="params">(id layer.ChainID, legacyImg image.V1Image, createdTime time.Time)</span> <span class="params">(distribution.Descriptor, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> _, exists := s.savedLayers[legacyImg.ID]; exists &#123;</div><div class="line">		<span class="keyword">return</span> distribution.Descriptor&#123;&#125;, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***创建镜像层的存储目录***//</span></div><div class="line">	outDir := filepath.Join(s.outDir, legacyImg.ID)</div><div class="line">	<span class="keyword">if</span> err := os.Mkdir(outDir, <span class="number">0755</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> distribution.Descriptor&#123;&#125;, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// todo: why is this version file here?</span></div><div class="line">	<span class="comment">//***生成VERSION文件，内容为1.0***//</span></div><div class="line">	<span class="keyword">if</span> err := ioutil.WriteFile(filepath.Join(outDir, legacyVersionFileName), []<span class="keyword">byte</span>(<span class="string">"1.0"</span>), <span class="number">0644</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> distribution.Descriptor&#123;&#125;, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***写入config文件***//</span></div><div class="line">	imageConfig, err := json.Marshal(legacyImg)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> distribution.Descriptor&#123;&#125;, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := ioutil.WriteFile(filepath.Join(outDir, legacyConfigFileName), imageConfig, <span class="number">0644</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> distribution.Descriptor&#123;&#125;, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// serialize filesystem</span></div><div class="line">	layerPath := filepath.Join(outDir, legacyLayerFileName)</div><div class="line">	l, err := s.ls.Get(id)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> distribution.Descriptor&#123;&#125;, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> layer.ReleaseAndLog(s.ls, l)</div><div class="line"></div><div class="line">	<span class="comment">//***生成tar文件***//</span></div><div class="line">	<span class="keyword">if</span> oldPath, exists := s.diffIDPaths[l.DiffID()]; exists &#123;</div><div class="line">		relPath, err := filepath.Rel(outDir, oldPath)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> distribution.Descriptor&#123;&#125;, err</div><div class="line">		&#125;</div><div class="line">		os.Symlink(relPath, layerPath)</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">		tarFile, err := os.Create(layerPath)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> distribution.Descriptor&#123;&#125;, err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">defer</span> tarFile.Close()</div><div class="line"></div><div class="line">		arch, err := l.TarStream()</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> distribution.Descriptor&#123;&#125;, err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">defer</span> arch.Close()</div><div class="line"></div><div class="line">		<span class="keyword">if</span> _, err := io.Copy(tarFile, arch); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> distribution.Descriptor&#123;&#125;, err</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">for</span> _, fname := <span class="keyword">range</span> []<span class="keyword">string</span>&#123;<span class="string">""</span>, legacyVersionFileName, legacyConfigFileName, legacyLayerFileName&#125; &#123;</div><div class="line">			<span class="comment">// todo: maybe save layer created timestamp?</span></div><div class="line">			<span class="keyword">if</span> err := system.Chtimes(filepath.Join(outDir, fname), createdTime, createdTime); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> distribution.Descriptor&#123;&#125;, err</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		s.diffIDPaths[l.DiffID()] = layerPath</div><div class="line">	&#125;</div><div class="line">	s.savedLayers[legacyImg.ID] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> src distribution.Descriptor</div><div class="line">	<span class="keyword">if</span> fs, ok := l.(distribution.Describable); ok &#123;</div><div class="line">		src = fs.Descriptor()</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> src, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>saveLayer()主要是生成layer中的tar文件，version文件，config文件，具体就不再展开分析。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>docker load和docker save命令都会使用临时目录做为中间过渡，其本质是把tar包中的内容写到Docker镜像库中，或从Docker镜像库中提取信息生成tar包中的内容。至于打包或解包操作，已在之前”Docker工具包分析-archive-v1.12.3”中分析过。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2018/02/10/Docker命令行分析-load-save-v1-12-3/" data-id="cje7r6e7x000cb4qsnaz3jzag" class="article-share-link">分享</a><div class="tags"><a href="/tags/docker/">docker</a><a href="/tags/docker-v1-12-3/">docker-v1.12.3</a></div><div class="post-nav"><a href="/2018/02/26/Kubernetes-cni网络调用分析-v1-5-2/" class="pre">Kubernetes-cni网络调用分析-v1.5.2</a><a href="/2018/02/03/Dockerd的server启动流程分析-v1-12-3/" class="next">Dockerd的server启动流程分析-v1.12.3</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/02/26/Kubernetes-cni网络调用分析-v1-5-2/">Kubernetes-cni网络调用分析-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/10/Docker命令行分析-load-save-v1-12-3/">Docker命令行分析-load-save-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/03/Dockerd的server启动流程分析-v1-12-3/">Dockerd的server启动流程分析-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/21/GO语言-切片原理/">GO语言-切片原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/16/Kubernetes-resourceVersion机制分析/">Kubernetes-resourceVersion机制分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/04/Kubernetes-Ingress使用-v1-5-2/">Kubernetes-Ingress使用-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/02/kube-controller分析(五)-QuotaController-v1-5-2/">kube-controller分析(五)-QuotaController-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/01/runc源码分析(二)-namespace设置流程-v1-0-0-rc2/">runc源码分析(二)-namespace设置流程-v1.0.0-rc2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/30/Docker创建spec文件分析-v1-12-3/">Docker创建spec文件分析-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/28/Docker工具包分析-archive-v1-12-3/">Docker工具包分析-archive-v1.12.3</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>