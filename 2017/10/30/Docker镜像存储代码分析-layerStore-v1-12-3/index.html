<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Docker镜像存储代码分析-layerStore-v1.12.3 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Docker镜像存储代码分析-layerStore-v1.12.3</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Docker镜像存储代码分析-layerStore-v1.12.3</h1><div class="post-meta">Oct 30, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>layStore负责Docker的layer的管理，具体有镜像层的管理，容器init层的管理，容器读写层的管理。layerStore的管理目录为/var/lib/docker/image/aufs/layerdb，主要有以下目录：</p>
<ol>
<li>mounts: 存储容器挂载信息，有init-id, mount-id, parent文件。</li>
<li>sha256: 存储镜像层的信息，有cache-id(aufs的存储位置), diff, size和tar-split.json.gz。</li>
</ol>
<p>本次分析将介绍layStore是如何管理这些文件目录的。</p>
<p>首先，要先介绍直接与文件打交道的filestore。</p>
<h2 id="filestore相关"><a href="#filestore相关" class="headerlink" title="filestore相关"></a>filestore相关</h2><h3 id="fileMetadataStore"><a href="#fileMetadataStore" class="headerlink" title="fileMetadataStore"></a>fileMetadataStore</h3><p>先来介绍fileMetadataStore，fileMetadataStore用来读取layerdb目录下的文件，定义在/layer/filestore.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置mounts目录下的内容***//</span></div><div class="line"><span class="keyword">type</span> fileMetadataStore <span class="keyword">struct</span> &#123;</div><div class="line">	root <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="NewFSMetadataStore"><a href="#NewFSMetadataStore" class="headerlink" title="NewFSMetadataStore()"></a>NewFSMetadataStore()</h4><p>NewFSMetadataStore()可以创建layerdb的根目录，并生成一个新的fileMetadataStore。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewFSMetadataStore returns an instance of a metadata store</span></div><div class="line"><span class="comment">// which is backed by files on disk using the provided root</span></div><div class="line"><span class="comment">// as the root of metadata files.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewFSMetadataStore</span><span class="params">(root <span class="keyword">string</span>)</span> <span class="params">(MetadataStore, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err := os.MkdirAll(root, <span class="number">0700</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;fileMetadataStore&#123;</div><div class="line">		root: root,</div><div class="line">	&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="getLayerDirectory"><a href="#getLayerDirectory" class="headerlink" title="getLayerDirectory()"></a>getLayerDirectory()</h4><p>getLayerDirectory()返回/var/lib/docker/image/aufs/layerdb/sha256/xxxxxxxxxxxxxxxx目录。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***dgst.Algorithm()返回"sha256"***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">getLayerDirectory</span><span class="params">(layer ChainID)</span> <span class="title">string</span></span> &#123;</div><div class="line">	dgst := digest.Digest(layer)</div><div class="line">	<span class="keyword">return</span> filepath.Join(fms.root, <span class="keyword">string</span>(dgst.Algorithm()), dgst.Hex())</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="getLayerFilename"><a href="#getLayerFilename" class="headerlink" title="getLayerFilename()"></a>getLayerFilename()</h4><p>getLayerFilename()用来获取sha256目录具体层目录下的具体文件。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***filename为size等***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">getLayerFilename</span><span class="params">(layer ChainID, filename <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> filepath.Join(fms.getLayerDirectory(layer), filename)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="getMountDirectory"><a href="#getMountDirectory" class="headerlink" title="getMountDirectory()"></a>getMountDirectory()</h4><p>getMountDirectory()返回/var/lib/docker/image/aufs/layerdb/mounts/xxxxxxxxxx目录。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***返回/var/lib/docker/image/aufs/layerdb/mounts/xxxxxxxxxx***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">getMountDirectory</span><span class="params">(mount <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> filepath.Join(fms.root, <span class="string">"mounts"</span>, mount)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="getMountFilename"><a href="#getMountFilename" class="headerlink" title="getMountFilename()"></a>getMountFilename()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取mounts目录下的具体文件***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">getMountFilename</span><span class="params">(mount, filename <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> filepath.Join(fms.getMountDirectory(mount), filename)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="StartTransaction"><a href="#StartTransaction" class="headerlink" title="StartTransaction()"></a>StartTransaction()</h4><p>设置临时目录。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置临时目录***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">StartTransaction</span><span class="params">()</span> <span class="params">(MetadataTransaction, error)</span></span> &#123;</div><div class="line">	tmpDir := filepath.Join(fms.root, <span class="string">"tmp"</span>)</div><div class="line">	<span class="keyword">if</span> err := os.MkdirAll(tmpDir, <span class="number">0755</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	td, err := ioutil.TempDir(tmpDir, <span class="string">"layer-"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Create a new tempdir</span></div><div class="line">	<span class="keyword">return</span> &amp;fileMetadataTransaction&#123;</div><div class="line">		store: fms,</div><div class="line">		root:  td,</div><div class="line">	&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="GetSize"><a href="#GetSize" class="headerlink" title="GetSize()"></a>GetSize()</h4><p>GetSize()用于获取size文件。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取size***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">GetSize</span><span class="params">(layer ChainID)</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</div><div class="line">	content, err := ioutil.ReadFile(fms.getLayerFilename(layer, <span class="string">"size"</span>))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	size, err := strconv.ParseInt(<span class="keyword">string</span>(content), <span class="number">10</span>, <span class="number">64</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> size, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="GetParent"><a href="#GetParent" class="headerlink" title="GetParent()"></a>GetParent()</h4><p>GetParent()用于获取parent文件。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取parent***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">GetParent</span><span class="params">(layer ChainID)</span> <span class="params">(ChainID, error)</span></span> &#123;</div><div class="line">	content, err := ioutil.ReadFile(fms.getLayerFilename(layer, <span class="string">"parent"</span>))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> os.IsNotExist(err) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="string">""</span>, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	dgst, err := digest.ParseDigest(strings.TrimSpace(<span class="keyword">string</span>(content)))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> ChainID(dgst), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="GetDiffID"><a href="#GetDiffID" class="headerlink" title="GetDiffID()"></a>GetDiffID()</h4><p>GetDiffID()用于获取diff文件。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取diff***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">GetDiffID</span><span class="params">(layer ChainID)</span> <span class="params">(DiffID, error)</span></span> &#123;</div><div class="line">	content, err := ioutil.ReadFile(fms.getLayerFilename(layer, <span class="string">"diff"</span>))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	dgst, err := digest.ParseDigest(strings.TrimSpace(<span class="keyword">string</span>(content)))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> DiffID(dgst), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="GetCacheID"><a href="#GetCacheID" class="headerlink" title="GetCacheID()"></a>GetCacheID()</h4><p>GetCacheID()用于获取cache-id<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取cache-id***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">GetCacheID</span><span class="params">(layer ChainID)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	contentBytes, err := ioutil.ReadFile(fms.getLayerFilename(layer, <span class="string">"cache-id"</span>))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line">	content := strings.TrimSpace(<span class="keyword">string</span>(contentBytes))</div><div class="line"></div><div class="line">	<span class="keyword">if</span> !stringIDRegexp.MatchString(content) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, errors.New(<span class="string">"invalid cache id value"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> content, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="GetDescriptor"><a href="#GetDescriptor" class="headerlink" title="GetDescriptor()"></a>GetDescriptor()</h4><p>??????不知道什么用途<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取descriptor.json***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">GetDescriptor</span><span class="params">(layer ChainID)</span> <span class="params">(distribution.Descriptor, error)</span></span> &#123;</div><div class="line">	content, err := ioutil.ReadFile(fms.getLayerFilename(layer, <span class="string">"descriptor.json"</span>))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> os.IsNotExist(err) &#123;</div><div class="line">			<span class="comment">// only return empty descriptor to represent what is stored</span></div><div class="line">			<span class="keyword">return</span> distribution.Descriptor&#123;&#125;, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> distribution.Descriptor&#123;&#125;, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> ref distribution.Descriptor</div><div class="line">	err = json.Unmarshal(content, &amp;ref)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> distribution.Descriptor&#123;&#125;, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ref, err</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="TarSplitReader"><a href="#TarSplitReader" class="headerlink" title="TarSplitReader()"></a>TarSplitReader()</h4><p>TarSplitReader()可以读取tar-split.json.gz，但tar-split.json.gz的作用目录还不清楚。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***处理tar-split.json.gz***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">TarSplitReader</span><span class="params">(layer ChainID)</span> <span class="params">(io.ReadCloser, error)</span></span> &#123;</div><div class="line">	fz, err := os.Open(fms.getLayerFilename(layer, <span class="string">"tar-split.json.gz"</span>))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	f, err := gzip.NewReader(fz)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> ioutils.NewReadCloserWrapper(f, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">		f.Close()</div><div class="line">		<span class="keyword">return</span> fz.Close()</div><div class="line">	&#125;), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="SetMountID"><a href="#SetMountID" class="headerlink" title="SetMountID()"></a>SetMountID()</h4><p>SetMountID()可以在mounts目录下设置mount-id文件。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置mount-id***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">SetMountID</span><span class="params">(mount <span class="keyword">string</span>, mountID <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err := os.MkdirAll(fms.getMountDirectory(mount), <span class="number">0755</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ioutil.WriteFile(fms.getMountFilename(mount, <span class="string">"mount-id"</span>), []<span class="keyword">byte</span>(mountID), <span class="number">0644</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="SetInitID"><a href="#SetInitID" class="headerlink" title="SetInitID()"></a>SetInitID()</h4><p>SetInitID()可以在mounts目录下设置init-id文件。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置init-id***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">SetInitID</span><span class="params">(mount <span class="keyword">string</span>, init <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err := os.MkdirAll(fms.getMountDirectory(mount), <span class="number">0755</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ioutil.WriteFile(fms.getMountFilename(mount, <span class="string">"init-id"</span>), []<span class="keyword">byte</span>(init), <span class="number">0644</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="SetMountParent"><a href="#SetMountParent" class="headerlink" title="SetMountParent()"></a>SetMountParent()</h4><p>SetMountParent()可以在mounts目录下设置parent文件。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置parent***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">SetMountParent</span><span class="params">(mount <span class="keyword">string</span>, parent ChainID)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err := os.MkdirAll(fms.getMountDirectory(mount), <span class="number">0755</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ioutil.WriteFile(fms.getMountFilename(mount, <span class="string">"parent"</span>), []<span class="keyword">byte</span>(digest.Digest(parent).String()), <span class="number">0644</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="GetMountID"><a href="#GetMountID" class="headerlink" title="GetMountID()"></a>GetMountID()</h4><p>GetMountID()用于获取mounts目录下的mount-id文件。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取mount-id***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">GetMountID</span><span class="params">(mount <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	contentBytes, err := ioutil.ReadFile(fms.getMountFilename(mount, <span class="string">"mount-id"</span>))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line">	content := strings.TrimSpace(<span class="keyword">string</span>(contentBytes))</div><div class="line"></div><div class="line">	<span class="keyword">if</span> !stringIDRegexp.MatchString(content) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, errors.New(<span class="string">"invalid mount id value"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> content, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="GetInitID"><a href="#GetInitID" class="headerlink" title="GetInitID()"></a>GetInitID()</h4><p>GetInitID()用于获取mounts目录下的init-id文件。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取init-id***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">GetInitID</span><span class="params">(mount <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	contentBytes, err := ioutil.ReadFile(fms.getMountFilename(mount, <span class="string">"init-id"</span>))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> os.IsNotExist(err) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="string">""</span>, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line">	content := strings.TrimSpace(<span class="keyword">string</span>(contentBytes))</div><div class="line"></div><div class="line">	<span class="keyword">if</span> !stringIDRegexp.MatchString(content) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, errors.New(<span class="string">"invalid init id value"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> content, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="GetMountParent"><a href="#GetMountParent" class="headerlink" title="GetMountParent()"></a>GetMountParent()</h4><p>GetMountParent()用于获取mounts目录下的parent文件。。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取parent***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">GetMountParent</span><span class="params">(mount <span class="keyword">string</span>)</span> <span class="params">(ChainID, error)</span></span> &#123;</div><div class="line">	content, err := ioutil.ReadFile(fms.getMountFilename(mount, <span class="string">"parent"</span>))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> os.IsNotExist(err) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="string">""</span>, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	dgst, err := digest.ParseDigest(strings.TrimSpace(<span class="keyword">string</span>(content)))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> ChainID(dgst), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="List"><a href="#List" class="headerlink" title="List()"></a>List()</h4><p>用于获取ids和mounts。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取ids, mounts***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">List</span><span class="params">()</span> <span class="params">([]ChainID, []<span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> ids []ChainID</div><div class="line">	<span class="keyword">for</span> _, algorithm := <span class="keyword">range</span> supportedAlgorithms &#123;</div><div class="line">		fileInfos, err := ioutil.ReadDir(filepath.Join(fms.root, <span class="keyword">string</span>(algorithm)))</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> os.IsNotExist(err) &#123;</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">for</span> _, fi := <span class="keyword">range</span> fileInfos &#123;</div><div class="line">			<span class="keyword">if</span> fi.IsDir() &amp;&amp; fi.Name() != <span class="string">"mounts"</span> &#123;</div><div class="line">				dgst := digest.NewDigestFromHex(<span class="keyword">string</span>(algorithm), fi.Name())</div><div class="line">				<span class="keyword">if</span> err := dgst.Validate(); err != <span class="literal">nil</span> &#123;</div><div class="line">					logrus.Debugf(<span class="string">"Ignoring invalid digest %s:%s"</span>, algorithm, fi.Name())</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					ids = <span class="built_in">append</span>(ids, ChainID(dgst))</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	fileInfos, err := ioutil.ReadDir(filepath.Join(fms.root, <span class="string">"mounts"</span>))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> os.IsNotExist(err) &#123;</div><div class="line">			<span class="keyword">return</span> ids, []<span class="keyword">string</span>&#123;&#125;, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> mounts []<span class="keyword">string</span></div><div class="line">	<span class="keyword">for</span> _, fi := <span class="keyword">range</span> fileInfos &#123;</div><div class="line">		<span class="keyword">if</span> fi.IsDir() &#123;</div><div class="line">			mounts = <span class="built_in">append</span>(mounts, fi.Name())</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> ids, mounts, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Remove"><a href="#Remove" class="headerlink" title="Remove()"></a>Remove()</h4><p>Remove()移除layerdb中的镜像层<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***删除/var/lib/docker/image/aufs/layerdb/目录下指定layer目录***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">Remove</span><span class="params">(layer ChainID)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> os.RemoveAll(fms.getLayerDirectory(layer))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="RemoveMount"><a href="#RemoveMount" class="headerlink" title="RemoveMount()"></a>RemoveMount()</h4><p>RemoveMount()移除layerdb中mounts目录下的内容。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***删除/var/lib/docker/image/aufs/layerdb/mounts***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fms *fileMetadataStore)</span> <span class="title">RemoveMount</span><span class="params">(mount <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> os.RemoveAll(fms.getMountDirectory(mount))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="fileMetadataTransaction"><a href="#fileMetadataTransaction" class="headerlink" title="fileMetadataTransaction"></a>fileMetadataTransaction</h3><p>再来介绍fileMetadataTransaction。fileMetadataTransaction用来创建一个临时文件夹，再全部的操作完成后，再把临时文件夹重命名成正式文件夹。<br>fileMetadataTransaction定义在/layer/filiestore.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置layerdb/sha256目录下的内容***//</span></div><div class="line"><span class="keyword">type</span> fileMetadataTransaction <span class="keyword">struct</span> &#123;</div><div class="line">	store *fileMetadataStore</div><div class="line">	root  <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>fileMetaDataStore的StartTransaction()方法可以生成一个新的fileMetadataTransaction。</p>
<h4 id="SetSize"><a href="#SetSize" class="headerlink" title="SetSize()"></a>SetSize()</h4><p>往临时文件夹中写入size。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置size***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fm *fileMetadataTransaction)</span> <span class="title">SetSize</span><span class="params">(size <span class="keyword">int64</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	content := fmt.Sprintf(<span class="string">"%d"</span>, size)</div><div class="line">	<span class="keyword">return</span> ioutil.WriteFile(filepath.Join(fm.root, <span class="string">"size"</span>), []<span class="keyword">byte</span>(content), <span class="number">0644</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="SetParent"><a href="#SetParent" class="headerlink" title="SetParent()"></a>SetParent()</h4><p>往临时文件夹中写入parent。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置parent***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fm *fileMetadataTransaction)</span> <span class="title">SetParent</span><span class="params">(parent ChainID)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> ioutil.WriteFile(filepath.Join(fm.root, <span class="string">"parent"</span>), []<span class="keyword">byte</span>(digest.Digest(parent).String()), <span class="number">0644</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="SetDiffID"><a href="#SetDiffID" class="headerlink" title="SetDiffID()"></a>SetDiffID()</h4><p>往临时文件夹中写入diff。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置diff***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fm *fileMetadataTransaction)</span> <span class="title">SetDiffID</span><span class="params">(diff DiffID)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> ioutil.WriteFile(filepath.Join(fm.root, <span class="string">"diff"</span>), []<span class="keyword">byte</span>(digest.Digest(diff).String()), <span class="number">0644</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="SetCacheID"><a href="#SetCacheID" class="headerlink" title="SetCacheID()"></a>SetCacheID()</h4><p>往临时文件夹中写入cache-id。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置cache-id***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fm *fileMetadataTransaction)</span> <span class="title">SetCacheID</span><span class="params">(cacheID <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> ioutil.WriteFile(filepath.Join(fm.root, <span class="string">"cache-id"</span>), []<span class="keyword">byte</span>(cacheID), <span class="number">0644</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="SetDescriptor"><a href="#SetDescriptor" class="headerlink" title="SetDescriptor()"></a>SetDescriptor()</h4><p>往临时文件夹中写入descriptor.json。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fm *fileMetadataTransaction)</span> <span class="title">SetDescriptor</span><span class="params">(ref distribution.Descriptor)</span> <span class="title">error</span></span> &#123;</div><div class="line">	jsonRef, err := json.Marshal(ref)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ioutil.WriteFile(filepath.Join(fm.root, <span class="string">"descriptor.json"</span>), jsonRef, <span class="number">0644</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="TarSplitWriter"><a href="#TarSplitWriter" class="headerlink" title="TarSplitWriter()"></a>TarSplitWriter()</h4><p>往临时文件夹中写入tar-split.json.gz。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置tar-split.json.gz***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fm *fileMetadataTransaction)</span> <span class="title">TarSplitWriter</span><span class="params">(compressInput <span class="keyword">bool</span>)</span> <span class="params">(io.WriteCloser, error)</span></span> &#123;</div><div class="line">	f, err := os.OpenFile(filepath.Join(fm.root, <span class="string">"tar-split.json.gz"</span>), os.O_TRUNC|os.O_CREATE|os.O_WRONLY, <span class="number">0644</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">var</span> wc io.WriteCloser</div><div class="line">	<span class="keyword">if</span> compressInput &#123;</div><div class="line">		wc = gzip.NewWriter(f)</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		wc = f</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> ioutils.NewWriteCloserWrapper(wc, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">		wc.Close()</div><div class="line">		<span class="keyword">return</span> f.Close()</div><div class="line">	&#125;), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Commit"><a href="#Commit" class="headerlink" title="Commit()"></a>Commit()</h4><p>把临时目录重命名成正式目录。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***把临时目录重命名成正式目录***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fm *fileMetadataTransaction)</span> <span class="title">Commit</span><span class="params">(layer ChainID)</span> <span class="title">error</span></span> &#123;</div><div class="line">	finalDir := fm.store.getLayerDirectory(layer)</div><div class="line">	<span class="keyword">if</span> err := os.MkdirAll(filepath.Dir(finalDir), <span class="number">0755</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> os.Rename(fm.root, finalDir)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Cancel"><a href="#Cancel" class="headerlink" title="Cancel()"></a>Cancel()</h4><p>Cancel()用来删除临时文件夹。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***删除该layer信息***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fm *fileMetadataTransaction)</span> <span class="title">Cancel</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> os.RemoveAll(fm.root)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="layerStore"><a href="#layerStore" class="headerlink" title="layerStore"></a>layerStore</h2><p>再来看layerStore。layerStore定义了layerdb真正意义上的操作，定义在/layer/layer_store.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> layerStore <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">//***即fileMetadataStore，定义在/filestore.go中***//</span></div><div class="line">	store  MetadataStore</div><div class="line">	driver graphdriver.Driver</div><div class="line"></div><div class="line">	<span class="comment">//***缓存layer用***//</span></div><div class="line">	layerMap <span class="keyword">map</span>[ChainID]*roLayer</div><div class="line">	layerL   sync.Mutex</div><div class="line"></div><div class="line">	<span class="comment">//***缓存mount用***//</span></div><div class="line">	mounts <span class="keyword">map</span>[<span class="keyword">string</span>]*mountedLayer</div><div class="line">	mountL sync.Mutex</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，layerStore中有一个store，即fileMetadataStore；一个driver，默认为aufs driver；一个layerMap用来缓存layer；一个mounts用来缓存mountedLayer。</p>
<h4 id="NewStoreFromGraphDriver"><a href="#NewStoreFromGraphDriver" class="headerlink" title="NewStoreFromGraphDriver()"></a>NewStoreFromGraphDriver()</h4><p>NewStoreFromGraphDriver()可以创建一个layerStore。流程如下：</p>
<ol>
<li>使用store.List()获取ids和mounts；</li>
<li>通过loadLayer()方法导入所有layer信息；</li>
<li>通过loadMount()方法导入所有mount信息。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewStoreFromGraphDriver creates a new Store instance using the provided</span></div><div class="line"><span class="comment">// metadata store and graph driver. The metadata store will be used to restore</span></div><div class="line"><span class="comment">// the Store.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewStoreFromGraphDriver</span><span class="params">(store MetadataStore, driver graphdriver.Driver)</span> <span class="params">(Store, error)</span></span> &#123;</div><div class="line">	ls := &amp;layerStore&#123;</div><div class="line">		store:    store,</div><div class="line">		driver:   driver,</div><div class="line">		layerMap: <span class="keyword">map</span>[ChainID]*roLayer&#123;&#125;,</div><div class="line">		mounts:   <span class="keyword">map</span>[<span class="keyword">string</span>]*mountedLayer&#123;&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ids, mounts, err := store.List()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, id := <span class="keyword">range</span> ids &#123;</div><div class="line">		l, err := ls.loadLayer(id)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			logrus.Debugf(<span class="string">"Failed to load layer %s: %s"</span>, id, err)</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> l.parent != <span class="literal">nil</span> &#123;</div><div class="line">			l.parent.referenceCount++</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, mount := <span class="keyword">range</span> mounts &#123;</div><div class="line">		<span class="keyword">if</span> err := ls.loadMount(mount); err != <span class="literal">nil</span> &#123;</div><div class="line">			logrus.Debugf(<span class="string">"Failed to load mount %s: %s"</span>, mount, err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> ls, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="loadLayer"><a href="#loadLayer" class="headerlink" title="loadLayer()"></a>loadLayer()</h4><p>loadLayer()用于导入一个layer。主要流程如下：</p>
<ol>
<li>如果layer在layerMap已缓存，则直接返回；</li>
<li>获取layer目录下的diff文件；</li>
<li>获取layer目录下的size文件；</li>
<li>获取layer目录下的cache-id文件；</li>
<li>获取layer目录下的parent文件；</li>
<li>获取layer目录下的descriptor文件；</li>
<li>构造roLayer表示只读层；</li>
<li>把roLayer缓存到layerMap中；</li>
<li>返回roLayer。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***读取某layer信息并缓存***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ls *layerStore)</span> <span class="title">loadLayer</span><span class="params">(layer ChainID)</span> <span class="params">(*roLayer, error)</span></span> &#123;</div><div class="line">	cl, ok := ls.layerMap[layer]</div><div class="line">	<span class="keyword">if</span> ok &#123;</div><div class="line">		<span class="keyword">return</span> cl, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***获取layerdb目录下diff***//</span></div><div class="line">	diff, err := ls.store.GetDiffID(layer)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"failed to get diff id for %s: %s"</span>, layer, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***获取layerdb目录下size***//</span></div><div class="line">	size, err := ls.store.GetSize(layer)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"failed to get size for %s: %s"</span>, layer, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***获取layerdb目录下cache-id***//</span></div><div class="line">	cacheID, err := ls.store.GetCacheID(layer)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"failed to get cache id for %s: %s"</span>, layer, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***获取layerdb目录下parent***//</span></div><div class="line">	parent, err := ls.store.GetParent(layer)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"failed to get parent for %s: %s"</span>, layer, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***获取layerdb目录下descriptor***//</span></div><div class="line">	descriptor, err := ls.store.GetDescriptor(layer)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"failed to get descriptor for %s: %s"</span>, layer, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***生成roLayer***//</span></div><div class="line">	cl = &amp;roLayer&#123;</div><div class="line">		chainID:    layer,</div><div class="line">		diffID:     diff,</div><div class="line">		size:       size,</div><div class="line">		cacheID:    cacheID,</div><div class="line">		layerStore: ls,</div><div class="line">		references: <span class="keyword">map</span>[Layer]<span class="keyword">struct</span>&#123;&#125;&#123;&#125;,</div><div class="line">		descriptor: descriptor,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> parent != <span class="string">""</span> &#123;</div><div class="line">		p, err := ls.loadLayer(parent)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">		cl.parent = p</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***加入到layerStore的layerMap中***//</span></div><div class="line">	ls.layerMap[cl.chainID] = cl</div><div class="line"></div><div class="line">	<span class="keyword">return</span> cl, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="loadMount"><a href="#loadMount" class="headerlink" title="loadMount()"></a>loadMount()</h4><p>loadMount()用于导入一个mount。主要流程如下：</p>
<ol>
<li>如果mouns中已有缓存，则直接返回；</li>
<li>获取mount目录下的mount-id文件；</li>
<li>获取mount目录下的init-id文件；</li>
<li>获取mount目录下的parent文件；</li>
<li>构造mountLayer；</li>
<li>把mountLayer缓存到mounts中。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***读取某mount信息并缓存***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ls *layerStore)</span> <span class="title">loadMount</span><span class="params">(mount <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> _, ok := ls.mounts[mount]; ok &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***获取mount-id***//</span></div><div class="line">	mountID, err := ls.store.GetMountID(mount)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***获取init-id***//</span></div><div class="line">	initID, err := ls.store.GetInitID(mount)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***获取parent***//</span></div><div class="line">	parent, err := ls.store.GetMountParent(mount)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***生成mountedLayer***//</span></div><div class="line">	ml := &amp;mountedLayer&#123;</div><div class="line">		name:       mount,</div><div class="line">		mountID:    mountID,</div><div class="line">		initID:     initID,</div><div class="line">		layerStore: ls,</div><div class="line">		references: <span class="keyword">map</span>[RWLayer]*referencedRWLayer&#123;&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> parent != <span class="string">""</span> &#123;</div><div class="line">		p, err := ls.loadLayer(parent)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		ml.parent = p</div><div class="line"></div><div class="line">		p.referenceCount++</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***加入到layerStore的mounts中***//</span></div><div class="line">	ls.mounts[ml.name] = ml</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="applyTar"><a href="#applyTar" class="headerlink" title="applyTar()"></a>applyTar()</h4><p>applyTar()通过调用driver的ApplyDiff()把镜像层的tar包解压到指定位置。具体解压过程见driver的分析过程。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***处理tar文件***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ls *layerStore)</span> <span class="title">applyTar</span><span class="params">(tx MetadataTransaction, ts io.Reader, parent <span class="keyword">string</span>, layer *roLayer)</span> <span class="title">error</span></span> &#123;</div><div class="line">	digester := digest.Canonical.New()</div><div class="line">	<span class="comment">//***从ts中读取内容写入到digester.Hash()中***//</span></div><div class="line">	tr := io.TeeReader(ts, digester.Hash())</div><div class="line"></div><div class="line">	tsw, err := tx.TarSplitWriter(<span class="literal">true</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	metaPacker := storage.NewJSONPacker(tsw)</div><div class="line">	<span class="keyword">defer</span> tsw.Close()</div><div class="line"></div><div class="line">	<span class="comment">// we're passing nil here for the file putter, because the ApplyDiff will</span></div><div class="line">	<span class="comment">// handle the extraction of the archive</span></div><div class="line">	rdr, err := asm.NewInputTarStream(tr, metaPacker, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***此处调用driver的ApplyDiff()***//</span></div><div class="line">	<span class="comment">//***把镜像层的内容存入diff中***//</span></div><div class="line">	applySize, err := ls.driver.ApplyDiff(layer.cacheID, parent, archive.Reader(rdr))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Discard trailing data but ensure metadata is picked up to reconstruct stream</span></div><div class="line">	io.Copy(ioutil.Discard, rdr) <span class="comment">// ignore error as reader may be closed</span></div><div class="line"></div><div class="line">	<span class="comment">//***回填size和diffID***//</span></div><div class="line">	layer.size = applySize</div><div class="line">	<span class="comment">//***diffID是镜像layer中tar包的hash值***//</span></div><div class="line">	layer.diffID = DiffID(digester.Digest())</div><div class="line"></div><div class="line">	logrus.Debugf(<span class="string">"Applied tar %s to %s, size: %d"</span>, layer.diffID, layer.cacheID, applySize)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Register"><a href="#Register" class="headerlink" title="Register()"></a>Register()</h4><p>Register()是入口。<br>Register()调用了registerWithDescriptor()方法。registerWithDescriptor()主要流程如下：</p>
<ol>
<li>调用driver.Create()在driver中创建对应目录；</li>
<li>调用store.StartTransaction()创建临时目录；</li>
<li>applyTar()把镜像层的tar包解压到driver指定目录中；</li>
<li>调用createChainIDFromParent()计算chainID，即layerID，具体分析见Docker镜像存储分析；</li>
<li>调用storeLayer()把所生成的layer持久化；</li>
<li>调用tx.Commit()提交变更。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***入口***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ls *layerStore)</span> <span class="title">Register</span><span class="params">(ts io.Reader, parent ChainID)</span> <span class="params">(Layer, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> ls.registerWithDescriptor(ts, parent, distribution.Descriptor&#123;&#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ls *layerStore)</span> <span class="title">registerWithDescriptor</span><span class="params">(ts io.Reader, parent ChainID, descriptor distribution.Descriptor)</span> <span class="params">(Layer, error)</span></span> &#123;</div><div class="line">	<span class="comment">// err is used to hold the error which will always trigger</span></div><div class="line">	<span class="comment">// cleanup of creates sources but may not be an error returned</span></div><div class="line">	<span class="comment">// to the caller (already exists).</span></div><div class="line">	<span class="keyword">var</span> err error</div><div class="line">	<span class="keyword">var</span> pid <span class="keyword">string</span></div><div class="line">	<span class="keyword">var</span> p *roLayer</div><div class="line">	<span class="keyword">if</span> <span class="keyword">string</span>(parent) != <span class="string">""</span> &#123;</div><div class="line">		p = ls.get(parent)</div><div class="line">		<span class="keyword">if</span> p == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, ErrLayerDoesNotExist</div><div class="line">		&#125;</div><div class="line">		pid = p.cacheID</div><div class="line">		<span class="comment">// Release parent chain if error</span></div><div class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				ls.layerL.Lock()</div><div class="line">				ls.releaseLayer(p)</div><div class="line">				ls.layerL.Unlock()</div><div class="line">			&#125;</div><div class="line">		&#125;()</div><div class="line">		<span class="keyword">if</span> p.depth() &gt;= maxLayerDepth &#123;</div><div class="line">			err = ErrMaxDepthExceeded</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Create new roLayer</span></div><div class="line">	layer := &amp;roLayer&#123;</div><div class="line">		parent:         p,</div><div class="line">		cacheID:        stringid.GenerateRandomID(),</div><div class="line">		referenceCount: <span class="number">1</span>,</div><div class="line">		layerStore:     ls,</div><div class="line">		references:     <span class="keyword">map</span>[Layer]<span class="keyword">struct</span>&#123;&#125;&#123;&#125;,</div><div class="line">		descriptor:     descriptor,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***在graph中创建对应层***//</span></div><div class="line">	<span class="keyword">if</span> err = ls.driver.Create(layer.cacheID, pid, <span class="string">""</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	tx, err := ls.store.StartTransaction()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			logrus.Debugf(<span class="string">"Cleaning up layer %s: %v"</span>, layer.cacheID, err)</div><div class="line">			<span class="keyword">if</span> err := ls.driver.Remove(layer.cacheID); err != <span class="literal">nil</span> &#123;</div><div class="line">				logrus.Errorf(<span class="string">"Error cleaning up cache layer %s: %v"</span>, layer.cacheID, err)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> err := tx.Cancel(); err != <span class="literal">nil</span> &#123;</div><div class="line">				logrus.Errorf(<span class="string">"Error canceling metadata transaction %q: %s"</span>, tx.String(), err)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="comment">//***调用applyTar()***//</span></div><div class="line">	<span class="comment">//***把tar文件解压至到对应的目录***//</span></div><div class="line">	<span class="keyword">if</span> err = ls.applyTar(tx, ts, pid, layer); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> layer.parent == <span class="literal">nil</span> &#123;</div><div class="line">		layer.chainID = ChainID(layer.diffID)</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">//***生成chainID***//</span></div><div class="line">		<span class="comment">//***就是把parent.chainID和layer.diffID合并，然后进行hash***//</span></div><div class="line">		layer.chainID = createChainIDFromParent(layer.parent.chainID, layer.diffID)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***把信息存入到layerdb中***//</span></div><div class="line">	<span class="keyword">if</span> err = storeLayer(tx, layer); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ls.layerL.Lock()</div><div class="line">	<span class="keyword">defer</span> ls.layerL.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> existingLayer := ls.getWithoutLock(layer.chainID); existingLayer != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// Set error for cleanup, but do not return the error</span></div><div class="line">		err = errors.New(<span class="string">"layer already exists"</span>)</div><div class="line">		<span class="keyword">return</span> existingLayer.getReference(), <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***提交变更***//</span></div><div class="line">	<span class="keyword">if</span> err = tx.Commit(layer.chainID); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ls.layerMap[layer.chainID] = layer</div><div class="line"></div><div class="line">	<span class="keyword">return</span> layer.getReference(), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Get"><a href="#Get" class="headerlink" title="Get()"></a>Get()</h4><p>Get()可以从layerMap中获取一个layer，并在该layer的referenceCount上+1。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从layerMap中直接获取layer***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ls *layerStore)</span> <span class="title">getWithoutLock</span><span class="params">(layer ChainID)</span> *<span class="title">roLayer</span></span> &#123;</div><div class="line">	l, ok := ls.layerMap[layer]</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	l.referenceCount++</div><div class="line"></div><div class="line">	<span class="keyword">return</span> l</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ls *layerStore)</span> <span class="title">get</span><span class="params">(l ChainID)</span> *<span class="title">roLayer</span></span> &#123;</div><div class="line">	ls.layerL.Lock()</div><div class="line">	<span class="keyword">defer</span> ls.layerL.Unlock()</div><div class="line">	<span class="keyword">return</span> ls.getWithoutLock(l)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ls *layerStore)</span> <span class="title">Get</span><span class="params">(l ChainID)</span> <span class="params">(Layer, error)</span></span> &#123;</div><div class="line">	ls.layerL.Lock()</div><div class="line">	<span class="keyword">defer</span> ls.layerL.Unlock()</div><div class="line"></div><div class="line">	layer := ls.getWithoutLock(l)</div><div class="line">	<span class="keyword">if</span> layer == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, ErrLayerDoesNotExist</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> layer.getReference(), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="deleteLayer"><a href="#deleteLayer" class="headerlink" title="deleteLayer()"></a>deleteLayer()</h4><p>在driver中删除layer相关信息；在filestore中删除layer相关信息。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从dirver和store中删除layer相关信息***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ls *layerStore)</span> <span class="title">deleteLayer</span><span class="params">(layer *roLayer, metadata *Metadata)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***调用driver的Remove()方法***//</span></div><div class="line">	err := ls.driver.Remove(layer.cacheID)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***调用filestore的Remove()方法***//</span></div><div class="line">	err = ls.store.Remove(layer.chainID)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	metadata.DiffID = layer.diffID</div><div class="line">	metadata.ChainID = layer.chainID</div><div class="line">	metadata.Size, err = layer.Size()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	metadata.DiffSize = layer.size</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Release"><a href="#Release" class="headerlink" title="Release()"></a>Release()</h4><p>Release()可以层层删除没有被引用的层。由于Docker镜像是树状结构的，Release()相当于删除一条枝代表的laysers。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***Release()入口***//</span></div><div class="line"><span class="comment">//***会释放多层引用为0的layer***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ls *layerStore)</span> <span class="title">Release</span><span class="params">(l Layer)</span> <span class="params">([]Metadata, error)</span></span> &#123;</div><div class="line">	ls.layerL.Lock()</div><div class="line">	<span class="keyword">defer</span> ls.layerL.Unlock()</div><div class="line">	layer, ok := ls.layerMap[l.ChainID()]</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> []Metadata&#123;&#125;, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> !layer.hasReference(l) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, ErrLayerNotRetained</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	layer.deleteReference(l)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> ls.releaseLayer(layer)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ls *layerStore)</span> <span class="title">releaseLayer</span><span class="params">(l *roLayer)</span> <span class="params">([]Metadata, error)</span></span> &#123;</div><div class="line">	depth := <span class="number">0</span></div><div class="line">	removed := []Metadata&#123;&#125;</div><div class="line">	<span class="comment">//***会检查parent***//</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">if</span> l.referenceCount == <span class="number">0</span> &#123;</div><div class="line">			<span class="built_in">panic</span>(<span class="string">"layer not retained"</span>)</div><div class="line">		&#125;</div><div class="line">		l.referenceCount--</div><div class="line">		<span class="comment">//***只有referenceCount为0时才可删除***//</span></div><div class="line">		<span class="comment">//***如果遇到有引用的layer，则中断回收***//</span></div><div class="line">		<span class="keyword">if</span> l.referenceCount != <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> removed, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(removed) == <span class="number">0</span> &amp;&amp; depth &gt; <span class="number">0</span> &#123;</div><div class="line">			<span class="built_in">panic</span>(<span class="string">"cannot remove layer with child"</span>)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> l.hasReferences() &#123;</div><div class="line">			<span class="built_in">panic</span>(<span class="string">"cannot delete referenced layer"</span>)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">var</span> metadata Metadata</div><div class="line">		<span class="comment">//***删除某layer***//</span></div><div class="line">		<span class="keyword">if</span> err := ls.deleteLayer(l, &amp;metadata); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***从layerMap中删除layer***//</span></div><div class="line">		<span class="built_in">delete</span>(ls.layerMap, l.chainID)</div><div class="line">		<span class="comment">//***已经删除的layer***//</span></div><div class="line">		removed = <span class="built_in">append</span>(removed, metadata)</div><div class="line"></div><div class="line">		<span class="keyword">if</span> l.parent == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> removed, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		depth++</div><div class="line">		l = l.parent</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="CreateRWLayer"><a href="#CreateRWLayer" class="headerlink" title="CreateRWLayer()"></a>CreateRWLayer()</h4><p>CreateRWLayer()先在layerdb中创建一个layer，然后调用driver.CreateReadWrite()在driver中创建读写目录。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***创建读写层***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ls *layerStore)</span> <span class="title">CreateRWLayer</span><span class="params">(name <span class="keyword">string</span>, parent ChainID, mountLabel <span class="keyword">string</span>, initFunc MountInit, storageOpt <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span> <span class="params">(RWLayer, error)</span></span> &#123;</div><div class="line">	ls.mountL.Lock()</div><div class="line">	<span class="keyword">defer</span> ls.mountL.Unlock()</div><div class="line">	m, ok := ls.mounts[name]</div><div class="line">	<span class="keyword">if</span> ok &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, ErrMountNameConflict</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> err error</div><div class="line">	<span class="keyword">var</span> pid <span class="keyword">string</span></div><div class="line">	<span class="keyword">var</span> p *roLayer</div><div class="line">	<span class="keyword">if</span> <span class="keyword">string</span>(parent) != <span class="string">""</span> &#123;</div><div class="line">		p = ls.get(parent)</div><div class="line">		<span class="keyword">if</span> p == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, ErrLayerDoesNotExist</div><div class="line">		&#125;</div><div class="line">		pid = p.cacheID</div><div class="line"></div><div class="line">		<span class="comment">// Release parent chain if error</span></div><div class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				ls.layerL.Lock()</div><div class="line">				ls.releaseLayer(p)</div><div class="line">				ls.layerL.Unlock()</div><div class="line">			&#125;</div><div class="line">		&#125;()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***构造mountedLayer***//</span></div><div class="line">	m = &amp;mountedLayer&#123;</div><div class="line">		name:       name,</div><div class="line">		parent:     p,</div><div class="line">		mountID:    ls.mountID(name),</div><div class="line">		layerStore: ls,</div><div class="line">		references: <span class="keyword">map</span>[RWLayer]*referencedRWLayer&#123;&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> initFunc != <span class="literal">nil</span> &#123;</div><div class="line">		pid, err = ls.initMount(m.mountID, pid, mountLabel, initFunc, storageOpt)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">		m.initID = pid</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***创建读写层***//</span></div><div class="line">	<span class="keyword">if</span> err = ls.driver.CreateReadWrite(m.mountID, pid, <span class="string">""</span>, storageOpt); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err = ls.saveMount(m); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> m.getReference(), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="ReleaseRWLayer"><a href="#ReleaseRWLayer" class="headerlink" title="ReleaseRWLayer()"></a>ReleaseRWLayer()</h4><p>ReleaseRWLayer()可以删除一个读写层。主要流程如下：</p>
<ol>
<li>删除driver的容器读写层；</li>
<li>删除driver的容器init层；</li>
<li>从fileStore上删除该层的信息。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ls *layerStore)</span> <span class="title">ReleaseRWLayer</span><span class="params">(l RWLayer)</span> <span class="params">([]Metadata, error)</span></span> &#123;</div><div class="line">	ls.mountL.Lock()</div><div class="line">	<span class="keyword">defer</span> ls.mountL.Unlock()</div><div class="line">	m, ok := ls.mounts[l.Name()]</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> []Metadata&#123;&#125;, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := m.deleteReference(l); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> m.hasReferences() &#123;</div><div class="line">		<span class="keyword">return</span> []Metadata&#123;&#125;, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***删除ef9fb8e1c2790cc6aeb0eaaf6f1abe08bd9949c6e9b53f229f729b3848d28a59***//</span></div><div class="line">	<span class="keyword">if</span> err := ls.driver.Remove(m.mountID); err != <span class="literal">nil</span> &#123;</div><div class="line">		logrus.Errorf(<span class="string">"Error removing mounted layer %s: %s"</span>, m.name, err)</div><div class="line">		m.retakeReference(l)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> m.initID != <span class="string">""</span> &#123;</div><div class="line">		<span class="comment">//***删除ef9fb8e1c2790cc6aeb0eaaf6f1abe08bd9949c6e9b53f229f729b3848d28a59-init***//</span></div><div class="line">		<span class="keyword">if</span> err := ls.driver.Remove(m.initID); err != <span class="literal">nil</span> &#123;</div><div class="line">			logrus.Errorf(<span class="string">"Error removing init layer %s: %s"</span>, m.name, err)</div><div class="line">			m.retakeReference(l)</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := ls.store.RemoveMount(m.name); err != <span class="literal">nil</span> &#123;</div><div class="line">		logrus.Errorf(<span class="string">"Error removing mount metadata: %s: %s"</span>, m.name, err)</div><div class="line">		m.retakeReference(l)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="built_in">delete</span>(ls.mounts, m.Name())</div><div class="line"></div><div class="line">	ls.layerL.Lock()</div><div class="line">	<span class="keyword">defer</span> ls.layerL.Unlock()</div><div class="line">	<span class="keyword">if</span> m.parent != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> ls.releaseLayer(m.parent)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> []Metadata&#123;&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="saveMount"><a href="#saveMount" class="headerlink" title="saveMount()"></a>saveMount()</h4><p>saveMount()可以持久化mount信息。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***持久化mount信息***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ls *layerStore)</span> <span class="title">saveMount</span><span class="params">(mount *mountedLayer)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***存储mount-id***//</span></div><div class="line">	<span class="keyword">if</span> err := ls.store.SetMountID(mount.name, mount.mountID); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***存储init-id***//</span></div><div class="line">	<span class="keyword">if</span> mount.initID != <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">if</span> err := ls.store.SetInitID(mount.name, mount.initID); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***存储parent***//</span></div><div class="line">	<span class="keyword">if</span> mount.parent != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> err := ls.store.SetMountParent(mount.name, mount.parent.chainID); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ls.mounts[mount.name] = mount</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="CreateChainID"><a href="#CreateChainID" class="headerlink" title="CreateChainID()"></a>CreateChainID()</h2><p>最后来看下计算chainID的函数，定义在/layer/layer.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// CreateChainID returns ID for a layerDigest slice</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateChainID</span><span class="params">(dgsts []DiffID)</span> <span class="title">ChainID</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> createChainIDFromParent(<span class="string">""</span>, dgsts...)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">createChainIDFromParent</span><span class="params">(parent ChainID, dgsts ...DiffID)</span> <span class="title">ChainID</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(dgsts) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> parent</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> parent == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">return</span> createChainIDFromParent(ChainID(dgsts[<span class="number">0</span>]), dgsts[<span class="number">1</span>:]...)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// H = "H(n-1) SHA256(n)"</span></div><div class="line">	<span class="comment">//***parent: sha256:ea9f151abb7e06353e73172dad421235611d4f6d0560ec95db26e0dc240642c1***//</span></div><div class="line">	<span class="comment">//***dgsts[0]: sha256:37cd1954e92bbbf23db02215ded6d1da958747dd642b43268a0ad73866592a7b***//</span></div><div class="line">	<span class="comment">//***dgst: sha256:860708544664c614b8ab025d5d01ba8f37694e939fd02ce861538bfd7c64cc43***//</span></div><div class="line">	dgst := digest.FromBytes([]<span class="keyword">byte</span>(<span class="keyword">string</span>(parent) + <span class="string">" "</span> + <span class="keyword">string</span>(dgsts[<span class="number">0</span>])))</div><div class="line">	<span class="keyword">return</span> createChainIDFromParent(ChainID(dgst), dgsts[<span class="number">1</span>:]...)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可见，整个过程是把上一次的哈希结果和下一个diff合并成字符串，接着计算哈希值。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>方法很多，分析中的代码也很长。只要记着以下几点：</p>
<ol>
<li>可以使用Register()向layerdb注册一个layer；</li>
<li>layerStore对应的目录为/var/lib/docker/image/aufs/layerdb；</li>
<li>layerStore中有driver连接镜像存储；</li>
</ol>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/10/30/Docker镜像存储代码分析-layerStore-v1-12-3/" data-id="cjamdueds0009ioqspqomzdcr" class="article-share-link">分享</a><div class="tags"><a href="/tags/docker/">docker</a><a href="/tags/docker-v1-12-3/">docker-v1.12.3</a></div><div class="post-nav"><a href="/2017/10/31/kubernetes-controller分析(四)-garbagecollector-v1-5-2/" class="pre">kubernetes-controller分析(四)-garbagecollector-v1.5.2</a><a href="/2017/10/29/Docker镜像存储代码分析-referenceStore-v1-12-3/" class="next">Docker镜像存储代码分析-referenceStore-v1.12.3</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/30/Docker容器网络初始化源码分析-v1-12-3/">Docker容器网络初始化源码分析-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/26/Docker-reexec机制分析-v1-12-3/">Docker-reexec机制分析-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/24/containerd-containerd-shim和runc的依存关系/">containerd,containerd-shim和runc的依存关系</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/22/runc源码分析(一)-create和start流程-v1-0-0-rc2/">runc源码分析(一)-create和start流程-v1.0.0-rc2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/19/containerd-shim源码分析-v0-2-4/">containerd-shim源码分析-v0.2.4</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/19/containerd-container和process-v0-2-4/">containerd-container和process-v0.2.4</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/16/containerd执行流程分析-v0-2-4/">containerd执行流程分析-v0.2.4</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/13/containerd-crt命令行使用-v0-2-4/">containerd-crt命令行使用-v0.2.4</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/11/gRPC-demo/">gRPC-demo</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/31/kubernetes-controller分析(四)-garbagecollector-v1-5-2/">kubernetes-controller分析(四)-garbagecollector-v1.5.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>