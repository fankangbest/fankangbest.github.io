<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>kubernetes-client分析(一)-kubeconfig-v1.5.2 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">kubernetes-client分析(一)-kubeconfig-v1.5.2</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">kubernetes-client分析(一)-kubeconfig-v1.5.2</h1><div class="post-meta">Oct 12, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>接下来，开始分析kubernetes的client相关代码。之前有篇”RESTClient,DynamicClient和ClientSet Demo”( <a href="https://fankangbest.github.io/2017/07/15/RESTClient-DynamicClient%E5%92%8CClientSet-Demo/" target="_blank" rel="external">https://fankangbest.github.io/2017/07/15/RESTClient-DynamicClient%E5%92%8CClientSet-Demo/</a> )的分析介绍三种client的用法，三种client都使用下面代码生成config:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">kubeconfig := flag.String(<span class="string">"kubeconfig"</span>, <span class="string">"/root/.kube/config"</span>, <span class="string">"Path to a kube config. Only required if out-of-cluster."</span>)</div><div class="line">flag.Parse()</div><div class="line">config, err := clientcmd.BuildConfigFromFlags(<span class="string">""</span>, *kubeconfig)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	fmt.Println(<span class="string">"BuildConfigFromFlags error"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这段代码就是读取/root/.kube/config文件，然后生成config。我们之前分析过kubernetes的kubeconfig机制( <a href="https://fankangbest.github.io/2017/07/09/Config%E6%9C%BA%E5%88%B6%E4%BD%BF%E7%94%A8-v1-5-2/" target="_blank" rel="external">https://fankangbest.github.io/2017/07/09/Config%E6%9C%BA%E5%88%B6%E4%BD%BF%E7%94%A8-v1-5-2/</a> )，里面有介绍如何使用kubeconfig机制。</p>
<h2 id="kubeconfig"><a href="#kubeconfig" class="headerlink" title="kubeconfig"></a>kubeconfig</h2><p>kubeconfig中定义了与apiserver相关的基本信息，可以通过读取kubeconfig生成相应的config，然后进一步生成client。kubeconfig结构如下所示：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Config</span></div><div class="line"><span class="attr">users:</span></div><div class="line"><span class="attr">- name:</span> <span class="string">node</span></div><div class="line"><span class="attr">  user:</span></div><div class="line"><span class="attr">    client-certificate:</span> <span class="string">/etc/kubernetes/security/serverkey/server.crt</span></div><div class="line"><span class="attr">    client-key:</span> <span class="string">/etc/kubernetes/security/serverkey/server.key</span></div><div class="line"><span class="attr">clusters:</span></div><div class="line"><span class="attr">- name:</span> <span class="string">local</span></div><div class="line"><span class="attr">  cluster:</span></div><div class="line"><span class="attr">    certificate-authority:</span> <span class="string">/etc/kubernetes/security/serverkey/ca.crt</span></div><div class="line"><span class="attr">    server:</span> <span class="attr">https://kubernetes:6443</span></div><div class="line"><span class="attr">contexts:</span></div><div class="line"><span class="attr">- context:</span></div><div class="line"><span class="attr">    cluster:</span> <span class="string">local</span></div><div class="line"><span class="attr">    user:</span> <span class="string">node</span></div><div class="line"><span class="attr">  name:</span> <span class="string">my-context</span></div><div class="line"><span class="attr">current-context:</span> <span class="string">my-context</span></div></pre></td></tr></table></figure></p>
<p>那么，kubernetes是如何把kubeconfig转换成client的config的呢？本次将详细分析。</p>
<h2 id="BuildConfigFromFlags"><a href="#BuildConfigFromFlags" class="headerlink" title="BuildConfigFromFlags()"></a>BuildConfigFromFlags()</h2><p>从<code>config, err := clientcmd.BuildConfigFromFlags(&quot;&quot;, *kubeconfig)</code>可以看出，通过BuildCOnfigFromFlags()可以将kubeconfig转换成client的config。来看下BuildCOnfigFromFlags()，定义在/pkg/client/unversioned/clientcmd/client_config.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BuildConfigFromFlags</span><span class="params">(masterUrl, kubeconfigPath <span class="keyword">string</span>)</span> <span class="params">(*restclient.Config, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> kubeconfigPath == <span class="string">""</span> &amp;&amp; masterUrl == <span class="string">""</span> &#123;</div><div class="line">		glog.Warningf(<span class="string">"Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work."</span>)</div><div class="line">		kubeconfig, err := restclient.InClusterConfig()</div><div class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> kubeconfig, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		glog.Warning(<span class="string">"error creating inClusterConfig, falling back to default config: "</span>, err)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***调用DeferredLoadingClientConfig的ClientConfig()生成restclient.Config***//</span></div><div class="line">	<span class="comment">//***DeferredLoadingClientConfig定义在/pkg/client/unversioned/merged_client_builder.go中***//</span></div><div class="line">	<span class="keyword">return</span> NewNonInteractiveDeferredLoadingClientConfig(</div><div class="line">		&amp;ClientConfigLoadingRules&#123;ExplicitPath: kubeconfigPath&#125;,</div><div class="line">		&amp;ConfigOverrides&#123;ClusterInfo: clientcmdapi.Cluster&#123;Server: masterUrl&#125;&#125;).ClientConfig()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，BuildConfigFromFlags()先调用NewNonInteractiveDeferredLoadingClientConfig()生成DirectClientConfig，然后调用DirectClientCOnfig的ClientConfig()方法生成client的config。NewNonInteractiveDeferredLoadingClientConfig()的参数为ClientConfigLoadingRules和ConfigOverrides。<br>下面将对这些概念进行分析。</p>
<h2 id="ClientConfigLoadingRules"><a href="#ClientConfigLoadingRules" class="headerlink" title="ClientConfigLoadingRules"></a>ClientConfigLoadingRules</h2><p>ClientConfigLoadingRules实现了ClientCOnfigLoader，定义在/pkg/client/unversioned/clientcmd/loader.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ClientConfigLoader <span class="keyword">interface</span> &#123;</div><div class="line">	ConfigAccess</div><div class="line">	<span class="comment">// IsDefaultConfig returns true if the returned config matches the defaults.</span></div><div class="line">	IsDefaultConfig(*restclient.Config) <span class="keyword">bool</span></div><div class="line">	<span class="comment">// Load returns the latest config</span></div><div class="line">	Load() (*clientcmdapi.Config, error)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> ClientConfigLoadingRules <span class="keyword">struct</span> &#123;</div><div class="line">	ExplicitPath <span class="keyword">string</span></div><div class="line">	Precedence   []<span class="keyword">string</span></div><div class="line"></div><div class="line">	<span class="comment">// MigrationRules is a map of destination files to source files.  If a destination file is not present, then the source file is checked.</span></div><div class="line">	<span class="comment">// If the source file is present, then it is copied to the destination file BEFORE any further loading happens.</span></div><div class="line">	MigrationRules <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></div><div class="line"></div><div class="line">	<span class="comment">// DoNotResolvePaths indicates whether or not to resolve paths with respect to the originating files.  This is phrased as a negative so</span></div><div class="line">	<span class="comment">// that a default object that doesn't set this will usually get the behavior it wants.</span></div><div class="line">	DoNotResolvePaths <span class="keyword">bool</span></div><div class="line"></div><div class="line">	<span class="comment">// DefaultClientConfig is an optional field indicating what rules to use to calculate a default configuration.</span></div><div class="line">	<span class="comment">// This should match the overrides passed in to ClientConfig loader.</span></div><div class="line">	DefaultClientConfig ClientConfig</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中：</p>
<ul>
<li>ExplicitPath: 表示kubeconfig的路径，优先级低于Precedence；</li>
<li>Precedence: 表示从KUBECONFIG等环境变量中获取到的路径；</li>
<li>MigrationRules: 表示旧路径到新路径的映射关系；</li>
<li>DoNotResolvePaths: 表示是否需要把相对路径转换成绝对路径；</li>
<li>DefaultClientConfig: 表示默认的配置。</li>
</ul>
<p>接下来看下ClientConfigLoadingRules的主要方法。</p>
<h4 id="Load"><a href="#Load" class="headerlink" title="Load()"></a>Load()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从kubeconfig中提取信息，生成config***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rules *ClientConfigLoadingRules)</span> <span class="title">Load</span><span class="params">()</span> <span class="params">(*clientcmdapi.Config, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err := rules.Migrate(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	errlist := []error&#123;&#125;</div><div class="line"></div><div class="line">	kubeConfigFiles := []<span class="keyword">string</span>&#123;&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Make sure a file we were explicitly told to use exists</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(rules.ExplicitPath) &gt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">if</span> _, err := os.Stat(rules.ExplicitPath); os.IsNotExist(err) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">		kubeConfigFiles = <span class="built_in">append</span>(kubeConfigFiles, rules.ExplicitPath)</div><div class="line"></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		kubeConfigFiles = <span class="built_in">append</span>(kubeConfigFiles, rules.Precedence...)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	kubeconfigs := []*clientcmdapi.Config&#123;&#125;</div><div class="line">	<span class="comment">// read and cache the config files so that we only look at them once</span></div><div class="line">	<span class="comment">//***filename: /root/.kube/config***//</span></div><div class="line">	<span class="keyword">for</span> _, filename := <span class="keyword">range</span> kubeConfigFiles &#123;</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(filename) == <span class="number">0</span> &#123;</div><div class="line">			<span class="comment">// no work to do</span></div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		config, err := LoadFromFile(filename)</div><div class="line">		<span class="keyword">if</span> os.IsNotExist(err) &#123;</div><div class="line">			<span class="comment">// skip missing files</span></div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			errlist = <span class="built_in">append</span>(errlist, fmt.Errorf(<span class="string">"Error loading config file \"%s\": %v"</span>, filename, err))</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		kubeconfigs = <span class="built_in">append</span>(kubeconfigs, config)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// first merge all of our maps</span></div><div class="line">	mapConfig := clientcmdapi.NewConfig()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, kubeconfig := <span class="keyword">range</span> kubeconfigs &#123;</div><div class="line">		<span class="comment">//***此处调用的是第三方的包imdario/mergo***//</span></div><div class="line">		<span class="comment">//***把kubeconfig中的内容merge到mapConfig中***//</span></div><div class="line">		mergo.Merge(mapConfig, kubeconfig)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// merge all of the struct values in the reverse order so that priority is given correctly</span></div><div class="line">	<span class="comment">// errors are not added to the list the second time</span></div><div class="line">	nonMapConfig := clientcmdapi.NewConfig()</div><div class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(kubeconfigs) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">		kubeconfig := kubeconfigs[i]</div><div class="line">		mergo.Merge(nonMapConfig, kubeconfig)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// since values are overwritten, but maps values are not, we can merge the non-map config on top of the map config and</span></div><div class="line">	<span class="comment">// get the values we expect.</span></div><div class="line">	config := clientcmdapi.NewConfig()</div><div class="line">	mergo.Merge(config, mapConfig)</div><div class="line">	mergo.Merge(config, nonMapConfig)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> rules.ResolvePaths() &#123;</div><div class="line">		<span class="keyword">if</span> err := ResolveLocalPaths(config); err != <span class="literal">nil</span> &#123;</div><div class="line">			errlist = <span class="built_in">append</span>(errlist, err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> config, utilerrors.NewAggregate(errlist)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Load()流程如下：</p>
<ol>
<li>调用Migrate()把旧kubeconfig文件转换成新kubeconfig文件，这样可以保持兼容性；</li>
<li>把ExplicitPath或Precedence合并成kubeConfigFiles；</li>
<li>调用LoadFromFile()读取kubeconfigFiles中的kubeconfig文件，生成kubeconfigs；</li>
<li>调用第三方包imdario/mergo的Merge()，把kubeconfigs合并成mapConfig；</li>
<li>反序把kubeconfigs合并成nonMapConfig；</li>
<li>把mapConfig和nonMapConfig合并成config；</li>
<li>调用ResolveLocalPaths()解决config中相对路径的问题。</li>
</ol>
<p>其中步骤4, 5, 6过程感觉有些疑惑，还不知道为什么要这么做，待研究完imdario/mergo再回过头来看。</p>
<h4 id="Migrate"><a href="#Migrate" class="headerlink" title="Migrate()"></a>Migrate()</h4><p>把旧的/root/.kube/.kubeconfig内容转移至/root/.kube/config。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rules *ClientConfigLoadingRules)</span> <span class="title">Migrate</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> rules.MigrationRules == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> destination, source := <span class="keyword">range</span> rules.MigrationRules &#123;</div><div class="line">		<span class="keyword">if</span> _, err := os.Stat(destination); err == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="comment">// if the destination already exists, do nothing</span></div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> os.IsPermission(err) &#123;</div><div class="line">			<span class="comment">// if we can't access the file, skip it</span></div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> !os.IsNotExist(err) &#123;</div><div class="line">			<span class="comment">// if we had an error other than non-existence, fail</span></div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> sourceInfo, err := os.Stat(source); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> os.IsNotExist(err) || os.IsPermission(err) &#123;</div><div class="line">				<span class="comment">// if the source file doesn't exist or we can't access it, there's no work to do.</span></div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// if we had an error other than non-existence, fail</span></div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> sourceInfo.IsDir() &#123;</div><div class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"cannot migrate %v to %v because it is a directory"</span>, source, destination)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		in, err := os.Open(source)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">defer</span> in.Close()</div><div class="line">		out, err := os.Create(destination)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">defer</span> out.Close()</div><div class="line"></div><div class="line">		<span class="keyword">if</span> _, err = io.Copy(out, in); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="LoadFromFile"><a href="#LoadFromFile" class="headerlink" title="LoadFromFile()"></a>LoadFromFile()</h4><p>读取kubeconfig，然后生成config。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">LoadFromFile</span><span class="params">(filename <span class="keyword">string</span>)</span> <span class="params">(*clientcmdapi.Config, error)</span></span> &#123;</div><div class="line">	kubeconfigBytes, err := ioutil.ReadFile(filename)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	config, err := Load(kubeconfigBytes)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	glog.V(<span class="number">6</span>).Infoln(<span class="string">"Config loaded from file"</span>, filename)</div><div class="line"></div><div class="line">	<span class="comment">// set LocationOfOrigin on every Cluster, User, and Context</span></div><div class="line">	<span class="keyword">for</span> key, obj := <span class="keyword">range</span> config.AuthInfos &#123;</div><div class="line">		obj.LocationOfOrigin = filename</div><div class="line">		config.AuthInfos[key] = obj</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> key, obj := <span class="keyword">range</span> config.Clusters &#123;</div><div class="line">		obj.LocationOfOrigin = filename</div><div class="line">		config.Clusters[key] = obj</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> key, obj := <span class="keyword">range</span> config.Contexts &#123;</div><div class="line">		obj.LocationOfOrigin = filename</div><div class="line">		config.Contexts[key] = obj</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> config.AuthInfos == <span class="literal">nil</span> &#123;</div><div class="line">		config.AuthInfos = <span class="keyword">map</span>[<span class="keyword">string</span>]*clientcmdapi.AuthInfo&#123;&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> config.Clusters == <span class="literal">nil</span> &#123;</div><div class="line">		config.Clusters = <span class="keyword">map</span>[<span class="keyword">string</span>]*clientcmdapi.Cluster&#123;&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> config.Contexts == <span class="literal">nil</span> &#123;</div><div class="line">		config.Contexts = <span class="keyword">map</span>[<span class="keyword">string</span>]*clientcmdapi.Context&#123;&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> config, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Load-1"><a href="#Load-1" class="headerlink" title="Load()"></a>Load()</h4><p>把data解码到Config结构体中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Load</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="params">(*clientcmdapi.Config, error)</span></span> &#123;</div><div class="line">	<span class="comment">//***生成config***//</span></div><div class="line">	config := clientcmdapi.NewConfig()</div><div class="line">	<span class="comment">// if there's no data in a file, return the default object instead of failing (DecodeInto reject empty input)</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> config, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	decoded, _, err := clientcmdlatest.Codec.Decode(data, &amp;unversioned.GroupVersionKind&#123;Version: clientcmdlatest.Version, Kind: <span class="string">"Config"</span>&#125;, config)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> decoded.(*clientcmdapi.Config), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ConfigOverrides"><a href="#ConfigOverrides" class="headerlink" title="ConfigOverrides"></a>ConfigOverrides</h2><p>ConfigOverrides定义在/pkg/client/unversioned/clientcmd/overrides.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ConfigOverrides holds values that should override whatever information is pulled from the actual Config object.  You can't</span></div><div class="line"><span class="comment">// simply use an actual Config object, because Configs hold maps, but overrides are restricted to "at most one"</span></div><div class="line"><span class="keyword">type</span> ConfigOverrides <span class="keyword">struct</span> &#123;</div><div class="line">	AuthInfo clientcmdapi.AuthInfo</div><div class="line">	<span class="comment">// ClusterDefaults are applied before the configured cluster info is loaded.</span></div><div class="line">	ClusterDefaults clientcmdapi.Cluster</div><div class="line">	ClusterInfo     clientcmdapi.Cluster</div><div class="line">	Context         clientcmdapi.Context</div><div class="line">	CurrentContext  <span class="keyword">string</span></div><div class="line">	Timeout         <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ConfigOverrides很简单，就是携带了config的某些信息，这些信息的优先级最高。</p>
<h2 id="DeferredLoadingClientConfig"><a href="#DeferredLoadingClientConfig" class="headerlink" title="DeferredLoadingClientConfig"></a>DeferredLoadingClientConfig</h2><p>使用NewNonInteractiveDeferredLoadingClientConfig()可以生成一个DeferredLoadingClientConfig，DeferredLoadingClientConfig定义在/pkg/client/unversioned/clientcmd/merged_client_builder.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> DeferredLoadingClientConfig <span class="keyword">struct</span> &#123;</div><div class="line">	loader         ClientConfigLoader</div><div class="line">	overrides      *ConfigOverrides</div><div class="line">	fallbackReader io.Reader</div><div class="line"></div><div class="line">	clientConfig ClientConfig</div><div class="line">	loadingLock  sync.Mutex</div><div class="line"></div><div class="line">	<span class="comment">// provided for testing</span></div><div class="line">	icc InClusterConfig</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>DeferredLoadingClientConfig可以把kubeconfig转换成DirectClientConfig，继而DirectClientConfig可以转换成client的config。之所以称为DeferredLoadingClientConfig，是因为DeferredLoadingClientConfig通过DirectClientConfig去生成client的config。</p>
<h4 id="ClientConfig"><a href="#ClientConfig" class="headerlink" title="ClientConfig()"></a>ClientConfig()</h4><p>ClientConfig()先调用createClientConfig()方法生成DirectClientConfig，然后再调用DirectClientConfig的ClientConfig()方法生成client的Config，并返回。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ClientConfig implements ClientConfig</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(config *DeferredLoadingClientConfig)</span> <span class="title">ClientConfig</span><span class="params">()</span> <span class="params">(*restclient.Config, error)</span></span> &#123;</div><div class="line">	<span class="comment">//***调用createClientConfig()，里面有Load()***//</span></div><div class="line">	mergedClientConfig, err := config.createClientConfig()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// load the configuration and return on non-empty errors and if the</span></div><div class="line">	<span class="comment">// content differs from the default config</span></div><div class="line">	mergedConfig, err := mergedClientConfig.ClientConfig()</div><div class="line">	<span class="keyword">switch</span> &#123;</div><div class="line">	<span class="keyword">case</span> err != <span class="literal">nil</span>:</div><div class="line">		<span class="keyword">if</span> !IsEmptyConfig(err) &#123;</div><div class="line">			<span class="comment">// return on any error except empty config</span></div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">case</span> mergedConfig != <span class="literal">nil</span>:</div><div class="line">		<span class="comment">// the configuration is valid, but if this is equal to the defaults we should try</span></div><div class="line">		<span class="comment">// in-cluster configuration</span></div><div class="line">		<span class="keyword">if</span> !config.loader.IsDefaultConfig(mergedConfig) &#123;</div><div class="line">			<span class="keyword">return</span> mergedConfig, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// check for in-cluster configuration and use it</span></div><div class="line">	<span class="keyword">if</span> config.icc.Possible() &#123;</div><div class="line">		glog.V(<span class="number">4</span>).Infof(<span class="string">"Using in-cluster configuration"</span>)</div><div class="line">		<span class="keyword">return</span> config.icc.ClientConfig()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// return the result of the merged client config</span></div><div class="line">	<span class="keyword">return</span> mergedConfig, err</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="createClientConfig"><a href="#createClientConfig" class="headerlink" title="createClientConfig()"></a>createClientConfig()</h4><p>createClientConfig()先通过loader.Load()把kubeconfig合并成mergedConfig(类型为Config，定义在/pkg/client/unversioned/clientcmd/api/types.go)。然后使用NewNonInteractiveClientConfig()生成DirectClientConfig，并把DirectClientConfig赋值给DeferredLoadingClientConfig的clientConfig，返回。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***生成clientConfig并返回***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(config *DeferredLoadingClientConfig)</span> <span class="title">createClientConfig</span><span class="params">()</span> <span class="params">(ClientConfig, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> config.clientConfig == <span class="literal">nil</span> &#123;</div><div class="line">		config.loadingLock.Lock()</div><div class="line">		<span class="keyword">defer</span> config.loadingLock.Unlock()</div><div class="line"></div><div class="line">		<span class="keyword">if</span> config.clientConfig == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="comment">//***调用loader.Load()***//</span></div><div class="line">			<span class="comment">//***把多个kubeconfig合并成一个***//</span></div><div class="line">			mergedConfig, err := config.loader.Load()</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">var</span> mergedClientConfig ClientConfig</div><div class="line">			<span class="keyword">if</span> config.fallbackReader != <span class="literal">nil</span> &#123;</div><div class="line">				mergedClientConfig = NewInteractiveClientConfig(*mergedConfig, config.overrides.CurrentContext, config.overrides, config.fallbackReader, config.loader)</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">//***此处的mergedClientConfig类型为client_config.go中的DirectClientConfig***//</span></div><div class="line">				mergedClientConfig = NewNonInteractiveClientConfig(*mergedConfig, config.overrides.CurrentContext, config.overrides, config.loader)</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			config.clientConfig = mergedClientConfig</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> config.clientConfig, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="NewNonInteractiveClientConfig"><a href="#NewNonInteractiveClientConfig" class="headerlink" title="NewNonInteractiveClientConfig()"></a>NewNonInteractiveClientConfig()</h2><p>NewNonInteractiveClientConfig()或NewInteractiveClientConfig()可以生成DirectClientConfig，两者的区别是是否传入fallbackReader。fallbackReader是认证信息不足调用的(还未做深入研究)。两个函数定义在/pkg/client/unversioned/clientcmd/client_config.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewDefaultClientConfig creates a DirectClientConfig using the config.CurrentContext as the context name</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDefaultClientConfig</span><span class="params">(config clientcmdapi.Config, overrides *ConfigOverrides)</span> <span class="title">ClientConfig</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;DirectClientConfig&#123;config, config.CurrentContext, overrides, <span class="literal">nil</span>, NewDefaultClientConfigLoadingRules()&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NewNonInteractiveClientConfig creates a DirectClientConfig using the passed context name and does not have a fallback reader for auth information</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewNonInteractiveClientConfig</span><span class="params">(config clientcmdapi.Config, contextName <span class="keyword">string</span>, overrides *ConfigOverrides, configAccess ConfigAccess)</span> <span class="title">ClientConfig</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;DirectClientConfig&#123;config, contextName, overrides, <span class="literal">nil</span>, configAccess&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="DirectClientConfig"><a href="#DirectClientConfig" class="headerlink" title="DirectClientConfig"></a>DirectClientConfig</h2><p>DirectClientConfig可以直接生成client的config，定义在/pkg/client/unversioned/clientcmd/client_config.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DirectClientConfig is a ClientConfig interface that is backed by a clientcmdapi.Config, options overrides, and an optional fallbackReader for auth information</span></div><div class="line"><span class="keyword">type</span> DirectClientConfig <span class="keyword">struct</span> &#123;</div><div class="line">	config         clientcmdapi.Config</div><div class="line">	contextName    <span class="keyword">string</span></div><div class="line">	overrides      *ConfigOverrides</div><div class="line">	fallbackReader io.Reader</div><div class="line">	configAccess   ConfigAccess</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="ClientConfig-1"><a href="#ClientConfig-1" class="headerlink" title="ClientConfig()"></a>ClientConfig()</h4><p>ClientConfig()方法使用<code>clientConfig := &amp;restclient.Config{}</code>，并把DirectClientConfig上的内容填充到clientConfig中，clientConfig就是之前称呼的client的config。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ClientConfig implements ClientConfig</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(config *DirectClientConfig)</span> <span class="title">ClientConfig</span><span class="params">()</span> <span class="params">(*restclient.Config, error)</span></span> &#123;</div><div class="line">	<span class="comment">// check that getAuthInfo, getContext, and getCluster do not return an error.</span></div><div class="line">	<span class="comment">// Do this before checking if the curent config is usable in the event that an</span></div><div class="line">	<span class="comment">// AuthInfo, Context, or Cluster config with user-defined names are not found.</span></div><div class="line">	<span class="comment">// This provides a user with the immediate cause for error if one is found</span></div><div class="line">	configAuthInfo, err := config.getAuthInfo()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	_, err = config.getContext()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	configClusterInfo, err := config.getCluster()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := config.ConfirmUsable(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	clientConfig := &amp;restclient.Config&#123;&#125;</div><div class="line">	clientConfig.Host = configClusterInfo.Server</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(config.overrides.Timeout) &gt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">if</span> i, err := strconv.ParseInt(config.overrides.Timeout, <span class="number">10</span>, <span class="number">64</span>); err == <span class="literal">nil</span> &amp;&amp; i &gt;= <span class="number">0</span> &#123;</div><div class="line">			clientConfig.Timeout = time.Duration(i) * time.Second</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> requestTimeout, err := time.ParseDuration(config.overrides.Timeout); err == <span class="literal">nil</span> &#123;</div><div class="line">			clientConfig.Timeout = requestTimeout</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"Invalid value for option '--request-timeout'. Value must be a single integer, or an integer followed by a corresponding time unit (e.g. 1s | 2m | 3h)"</span>)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> u, err := url.ParseRequestURI(clientConfig.Host); err == <span class="literal">nil</span> &amp;&amp; u.Opaque == <span class="string">""</span> &amp;&amp; <span class="built_in">len</span>(u.Path) &gt; <span class="number">1</span> &#123;</div><div class="line">		u.RawQuery = <span class="string">""</span></div><div class="line">		u.Fragment = <span class="string">""</span></div><div class="line">		clientConfig.Host = u.String()</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(configAuthInfo.Impersonate) &gt; <span class="number">0</span> &#123;</div><div class="line">		clientConfig.Impersonate = configAuthInfo.Impersonate</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// only try to read the auth information if we are secure</span></div><div class="line">	<span class="keyword">if</span> restclient.IsConfigTransportTLS(*clientConfig) &#123;</div><div class="line">		<span class="keyword">var</span> err error</div><div class="line"></div><div class="line">		<span class="comment">// mergo is a first write wins for map value and a last writing wins for interface values</span></div><div class="line">		<span class="comment">// <span class="doctag">NOTE:</span> This behavior changed with https://github.com/imdario/mergo/commit/d304790b2ed594794496464fadd89d2bb266600a.</span></div><div class="line">		<span class="comment">//       Our mergo.Merge version is older than this change.</span></div><div class="line">		<span class="keyword">var</span> persister restclient.AuthProviderConfigPersister</div><div class="line">		<span class="keyword">if</span> config.configAccess != <span class="literal">nil</span> &#123;</div><div class="line">			authInfoName, _ := config.getAuthInfoName()</div><div class="line">			persister = PersisterForUser(config.configAccess, authInfoName)</div><div class="line">		&#125;</div><div class="line">		userAuthPartialConfig, err := getUserIdentificationPartialConfig(configAuthInfo, config.fallbackReader, persister)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">		mergo.Merge(clientConfig, userAuthPartialConfig)</div><div class="line"></div><div class="line">		serverAuthPartialConfig, err := getServerIdentificationPartialConfig(configAuthInfo, configClusterInfo)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">		mergo.Merge(clientConfig, serverAuthPartialConfig)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> clientConfig, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="getCluster"><a href="#getCluster" class="headerlink" title="getCluster()"></a>getCluster()</h4><p>在这些getXXX()方法中，会优先使用overrides中的信息。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// getCluster returns the clientcmdapi.Cluster, or an error if a required cluster is not found.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(config *DirectClientConfig)</span> <span class="title">getCluster</span><span class="params">()</span> <span class="params">(clientcmdapi.Cluster, error)</span></span> &#123;</div><div class="line">	clusterInfos := config.config.Clusters</div><div class="line">	clusterInfoName, required := config.getClusterName()</div><div class="line"></div><div class="line">	<span class="keyword">var</span> mergedClusterInfo clientcmdapi.Cluster</div><div class="line">	mergo.Merge(&amp;mergedClusterInfo, config.overrides.ClusterDefaults)</div><div class="line">	<span class="keyword">if</span> configClusterInfo, exists := clusterInfos[clusterInfoName]; exists &#123;</div><div class="line">		mergo.Merge(&amp;mergedClusterInfo, configClusterInfo)</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> required &#123;</div><div class="line">		<span class="keyword">return</span> clientcmdapi.Cluster&#123;&#125;, fmt.Errorf(<span class="string">"cluster %q does not exist"</span>, clusterInfoName)</div><div class="line">	&#125;</div><div class="line">	mergo.Merge(&amp;mergedClusterInfo, config.overrides.ClusterInfo)</div><div class="line">	<span class="comment">// An override of --insecure-skip-tls-verify=true and no accompanying CA/CA data should clear already-set CA/CA data</span></div><div class="line">	<span class="comment">// otherwise, a kubeconfig containing a CA reference would return an error that "CA and insecure-skip-tls-verify couldn't both be set"</span></div><div class="line">	caLen := <span class="built_in">len</span>(config.overrides.ClusterInfo.CertificateAuthority)</div><div class="line">	caDataLen := <span class="built_in">len</span>(config.overrides.ClusterInfo.CertificateAuthorityData)</div><div class="line">	<span class="keyword">if</span> config.overrides.ClusterInfo.InsecureSkipTLSVerify &amp;&amp; caLen == <span class="number">0</span> &amp;&amp; caDataLen == <span class="number">0</span> &#123;</div><div class="line">		mergedClusterInfo.CertificateAuthority = <span class="string">""</span></div><div class="line">		mergedClusterInfo.CertificateAuthorityData = <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> mergedClusterInfo, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// getClusterName returns a string containing the default, or user-set cluster name, and a boolean</span></div><div class="line"><span class="comment">// indicating whether the default clusterName has been overwritten by a user-set flag, or left as</span></div><div class="line"><span class="comment">// its default value</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(config *DirectClientConfig)</span> <span class="title">getClusterName</span><span class="params">()</span> <span class="params">(<span class="keyword">string</span>, <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(config.overrides.Context.Cluster) != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> config.overrides.Context.Cluster, <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line">	context, _ := config.getContext()</div><div class="line">	<span class="keyword">return</span> context.Cluster, <span class="literal">false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>ClientConfigLoadingRules作为ClientConfigLoader可以把kubeconfig文件(可能多个)转换成clientcmdapi.Config(定义在types.go中);<br>DeferredLoadingClientConfig封装有ClientConfigLoadingRules，在获取到clientcmdapi.Config之后，会转换成DirectClientConfig，然后生成restclient.Config。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/10/12/kubernetes-client分析(一)-kubeconfig-v1-5-2/" data-id="cj9e4gswj003qx8qsr4nlh6m8" class="article-share-link">分享</a><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></div><div class="post-nav"><a href="/2017/10/13/kubernetes-client分析(二)-restclient-v1-5-2/" class="pre">kubernetes-client分析(二)-restclient-v1.5.2</a><a href="/2017/10/09/kubernetes-client-python使用-v1-0-1/" class="next">kubernetes-client-python使用-v1.0.1</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/Go语言/">Go语言</a></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/30/Docker镜像存储代码分析-layerStore-v1-12-3/">Docker镜像存储代码分析-layerStore-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/29/Docker镜像存储代码分析-referenceStore-v1-12-3/">Docker镜像存储代码分析-referenceStore-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/29/Docker镜像存储代码分析-imageStore-v1-12-3/">Docker镜像存储代码分析-imageStore-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/26/kube-controller分析(三)-NamespaceController-v1-5-2/">kube-controller分析(三)-NamespaceController-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/25/kubernetes-watcher-demo/">kubernetes-watcher-demo</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/24/kube-controller分析(二)-finalizer机制-v1-5-2/">kube-controller分析(二)-finalizer机制-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/19/kube-controller分析(一)-sharedInformerFactory解读-v1-5-2/">kube-controller分析(一)-sharedInformerFactory解读-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/18/kubernetes-client分析(四)-ClientSet-v1-5-2/">kubernetes-client分析(四)-ClientSet-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/16/kubernetes-client分析(三)-dynamicClient-v1-5-2/">kubernetes-client分析(三)-dynamicClient-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/13/kubernetes-client分析(二)-restclient-v1-5-2/">kubernetes-client分析(二)-restclient-v1.5.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>