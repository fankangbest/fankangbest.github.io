<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>kube-scheduler分析(一)-init过程-v1.5.2 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">kube-scheduler分析(一)-init过程-v1.5.2</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">kube-scheduler分析(一)-init过程-v1.5.2</h1><div class="post-meta">Oct 3, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>kube-scheduler在Kubernetes中负责Pods的调度，其主要流程是获取未被调度的pod，然后根据pod的信息过滤出符合要求的nodes，接着对这些符合要求的nodes进行打分，最后把得分最高的node作为pod的调度结果。所以，在kube-scheduler中有两类算法，一种是用来过滤nodes的算法，称为predicate类；另一种是来用打分的算法，称为priority类。本次分析，就是介绍kube-scheduler是如何对算法进行管理的。</p>
<h2 id="algorithmprovider"><a href="#algorithmprovider" class="headerlink" title="algorithmprovider"></a>algorithmprovider</h2><p>在kube-scheduler的入口，/plugin/cmd/kube-scheduler/app/server.go中，有如下引入包：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">_ <span class="string">"k8s.io/kubernetes/plugin/pkg/scheduler/algorithmprovider"</span></div></pre></td></tr></table></figure></p>
<p>在引入包时，Go语言会自动执行该包的init()函数。所以我们来看下algorithmprovider的init()函数，定义在/plugin/pkg/scheduler/algorithmprovider/defaults/defaults.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Register functions that extract metadata used by predicates and priorities computations.</span></div><div class="line">	factory.RegisterPredicateMetadataProducerFactory(</div><div class="line">		<span class="function"><span class="keyword">func</span><span class="params">(args factory.PluginFactoryArgs)</span> <span class="title">algorithm</span>.<span class="title">MetadataProducer</span></span> &#123;</div><div class="line">			<span class="keyword">return</span> predicates.NewPredicateMetadataFactory(args.PodLister)</div><div class="line">		&#125;)</div><div class="line">	factory.RegisterPriorityMetadataProducerFactory(</div><div class="line">		<span class="function"><span class="keyword">func</span><span class="params">(args factory.PluginFactoryArgs)</span> <span class="title">algorithm</span>.<span class="title">MetadataProducer</span></span> &#123;</div><div class="line">			<span class="keyword">return</span> priorities.PriorityMetadata</div><div class="line">		&#125;)</div><div class="line"></div><div class="line">	<span class="comment">// Retisters algorithm providers. By default we use 'DefaultProvider', but user can specify one to be used</span></div><div class="line">	<span class="comment">// by specifying flag.</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***注册"DefaultProvider"***//</span></div><div class="line">	factory.RegisterAlgorithmProvider(factory.DefaultProvider, defaultPredicates(), defaultPriorities())</div><div class="line">	<span class="comment">// Cluster autoscaler friendly scheduling algorithm.</span></div><div class="line">	factory.RegisterAlgorithmProvider(ClusterAutoscalerProvider, defaultPredicates(),</div><div class="line">		copyAndReplace(defaultPriorities(), <span class="string">"LeastRequestedPriority"</span>, <span class="string">"MostRequestedPriority"</span>))</div><div class="line"></div><div class="line">	<span class="comment">// Registers predicates and priorities that are not enabled by default, but user can pick when creating his</span></div><div class="line">	<span class="comment">// own set of priorities/predicates.</span></div><div class="line"></div><div class="line">	<span class="comment">// PodFitsPorts has been replaced by PodFitsHostPorts for better user understanding.</span></div><div class="line">	<span class="comment">// For backwards compatibility with 1.0, PodFitsPorts is registered as well.</span></div><div class="line">	factory.RegisterFitPredicate(<span class="string">"PodFitsPorts"</span>, predicates.PodFitsHostPorts)</div><div class="line">	<span class="comment">// Fit is defined based on the absence of port conflicts.</span></div><div class="line">	<span class="comment">// This predicate is actually a default predicate, because it is invoked from</span></div><div class="line">	<span class="comment">// predicates.GeneralPredicates()</span></div><div class="line">	factory.RegisterFitPredicate(<span class="string">"PodFitsHostPorts"</span>, predicates.PodFitsHostPorts)</div><div class="line">	<span class="comment">// Fit is determined by resource availability.</span></div><div class="line">	<span class="comment">// This predicate is actually a default predicate, because it is invoked from</span></div><div class="line">	<span class="comment">// predicates.GeneralPredicates()</span></div><div class="line">	factory.RegisterFitPredicate(<span class="string">"PodFitsResources"</span>, predicates.PodFitsResources)</div><div class="line">	<span class="comment">// Fit is determined by the presence of the Host parameter and a string match</span></div><div class="line">	<span class="comment">// This predicate is actually a default predicate, because it is invoked from</span></div><div class="line">	<span class="comment">// predicates.GeneralPredicates()</span></div><div class="line">	factory.RegisterFitPredicate(<span class="string">"HostName"</span>, predicates.PodFitsHost)</div><div class="line">	<span class="comment">// Fit is determined by node selector query.</span></div><div class="line">	factory.RegisterFitPredicate(<span class="string">"MatchNodeSelector"</span>, predicates.PodSelectorMatches)</div><div class="line"></div><div class="line">	<span class="comment">// Use equivalence class to speed up predicates &amp; priorities</span></div><div class="line">	factory.RegisterGetEquivalencePodFunction(GetEquivalencePod)</div><div class="line"></div><div class="line">	<span class="comment">// ServiceSpreadingPriority is a priority config factory that spreads pods by minimizing</span></div><div class="line">	<span class="comment">// the number of pods (belonging to the same service) on the same node.</span></div><div class="line">	<span class="comment">// Register the factory so that it's available, but do not include it as part of the default priorities</span></div><div class="line">	<span class="comment">// Largely replaced by "SelectorSpreadPriority", but registered for backward compatibility with 1.0</span></div><div class="line">	factory.RegisterPriorityConfigFactory(</div><div class="line">		<span class="string">"ServiceSpreadingPriority"</span>,</div><div class="line">		factory.PriorityConfigFactory&#123;</div><div class="line">			Function: <span class="function"><span class="keyword">func</span><span class="params">(args factory.PluginFactoryArgs)</span> <span class="title">algorithm</span>.<span class="title">PriorityFunction</span></span> &#123;</div><div class="line">				<span class="keyword">return</span> priorities.NewSelectorSpreadPriority(args.ServiceLister, algorithm.EmptyControllerLister&#123;&#125;, algorithm.EmptyReplicaSetLister&#123;&#125;)</div><div class="line">			&#125;,</div><div class="line">			Weight: <span class="number">1</span>,</div><div class="line">		&#125;,</div><div class="line">	)</div><div class="line"></div><div class="line">	<span class="comment">// EqualPriority is a prioritizer function that gives an equal weight of one to all nodes</span></div><div class="line">	<span class="comment">// Register the priority function so that its available</span></div><div class="line">	<span class="comment">// but do not include it as part of the default priorities</span></div><div class="line">	factory.RegisterPriorityFunction2(<span class="string">"EqualPriority"</span>, scheduler.EqualPriorityMap, <span class="literal">nil</span>, <span class="number">1</span>)</div><div class="line">	<span class="comment">// ImageLocalityPriority prioritizes nodes based on locality of images requested by a pod. Nodes with larger size</span></div><div class="line">	<span class="comment">// of already-installed packages required by the pod will be preferred over nodes with no already-installed</span></div><div class="line">	<span class="comment">// packages required by the pod or a small total size of already-installed packages required by the pod.</span></div><div class="line">	factory.RegisterPriorityFunction2(<span class="string">"ImageLocalityPriority"</span>, priorities.ImageLocalityPriorityMap, <span class="literal">nil</span>, <span class="number">1</span>)</div><div class="line">	<span class="comment">// Optional, cluster-autoscaler friendly priority function - give used nodes higher priority.</span></div><div class="line">	factory.RegisterPriorityFunction2(<span class="string">"MostRequestedPriority"</span>, priorities.MostRequestedPriorityMap, <span class="literal">nil</span>, <span class="number">1</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>init()中通过调用RegisterAlgorithmProvider()注册了DefaultProvider；通过RegisterFitredicate()注册predicate类函数；通过RegisterPriorityFunctions2()注册priority类函数。<br>在kube-scheduler中注册了以下算法函数：<br>predicates类：NoVolumeZoneConflict, MaxEBSVolumeCount, MaxGCEPDVolumeCount, MatchInterPodAffinity, NoDiskConflict, GeneralPredicates, PodToleratesNodeTaints, CheckNodeMemoryPressure, CheckNodeDIskPressure, ClusterAutoscalerProvider, PodFitsPorts, PodFitsHostPorts, PodFitsResource, HostName, MatchNodeSelector。<br>priority类：SelectorSpreadPriority, InterPodAffinityPriority, LeastRequestedPriority, BalancedResourceAllocation, NodePreferAvoidPodsPriority, NodeAffinityPriority, TaintTolerationPriority, servicespreadingPriority, EqualPriority, ImageLocalityPriority, MostRequestedPriority。<br>这些算法的功能会在以后逐一介绍。<br>先来看下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">factory.RegisterAlgorithmProvider(factory.DefaultProvider, defaultPredicates(), defaultPriorities())</div></pre></td></tr></table></figure></p>
<p>该代码注册了DefaultProvider，来看defaultPredicates()：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">defaultPredicates</span><span class="params">()</span> <span class="title">sets</span>.<span class="title">String</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> sets.NewString(</div><div class="line">		<span class="comment">// Fit is determined by volume zone requirements.</span></div><div class="line">		<span class="comment">//***注册NoVolumeZoneConflict，并返回字符串"NoVolumeZoneConflict"***//</span></div><div class="line">		factory.RegisterFitPredicateFactory(</div><div class="line">			<span class="string">"NoVolumeZoneConflict"</span>,</div><div class="line">			<span class="function"><span class="keyword">func</span><span class="params">(args factory.PluginFactoryArgs)</span> <span class="title">algorithm</span>.<span class="title">FitPredicate</span></span> &#123;</div><div class="line">				<span class="keyword">return</span> predicates.NewVolumeZonePredicate(args.PVInfo, args.PVCInfo)</div><div class="line">			&#125;,</div><div class="line">		),</div><div class="line">		<span class="comment">// Fit is determined by whether or not there would be too many AWS EBS volumes attached to the node</span></div><div class="line">		<span class="comment">//***注册MaxEBSVolumeCount，并返回字符串"MaxEBSVolumeCount"***//</span></div><div class="line">		factory.RegisterFitPredicateFactory(</div><div class="line">			<span class="string">"MaxEBSVolumeCount"</span>,</div><div class="line">			<span class="function"><span class="keyword">func</span><span class="params">(args factory.PluginFactoryArgs)</span> <span class="title">algorithm</span>.<span class="title">FitPredicate</span></span> &#123;</div><div class="line">				<span class="comment">// <span class="doctag">TODO:</span> allow for generically parameterized scheduler predicates, because this is a bit ugly</span></div><div class="line">				maxVols := getMaxVols(aws.DefaultMaxEBSVolumes)</div><div class="line">				<span class="keyword">return</span> predicates.NewMaxPDVolumeCountPredicate(predicates.EBSVolumeFilter, maxVols, args.PVInfo, args.PVCInfo)</div><div class="line">			&#125;,</div><div class="line">		),</div><div class="line">		<span class="comment">// Fit is determined by whether or not there would be too many GCE PD volumes attached to the node</span></div><div class="line">		<span class="comment">//***注册MaxGCEPDVolumeCount，并返回字符串"MaxGCEPDVolumeCount"***//</span></div><div class="line">		factory.RegisterFitPredicateFactory(</div><div class="line">			<span class="string">"MaxGCEPDVolumeCount"</span>,</div><div class="line">			<span class="function"><span class="keyword">func</span><span class="params">(args factory.PluginFactoryArgs)</span> <span class="title">algorithm</span>.<span class="title">FitPredicate</span></span> &#123;</div><div class="line">				<span class="comment">// <span class="doctag">TODO:</span> allow for generically parameterized scheduler predicates, because this is a bit ugly</span></div><div class="line">				maxVols := getMaxVols(DefaultMaxGCEPDVolumes)</div><div class="line">				<span class="keyword">return</span> predicates.NewMaxPDVolumeCountPredicate(predicates.GCEPDVolumeFilter, maxVols, args.PVInfo, args.PVCInfo)</div><div class="line">			&#125;,</div><div class="line">		),</div><div class="line">		<span class="comment">// Fit is determined by inter-pod affinity.</span></div><div class="line">		<span class="comment">//***注册MatchInterPodAffinity，并返回字符串"MatchInterPodAffinity"***//</span></div><div class="line">		factory.RegisterFitPredicateFactory(</div><div class="line">			<span class="string">"MatchInterPodAffinity"</span>,</div><div class="line">			<span class="function"><span class="keyword">func</span><span class="params">(args factory.PluginFactoryArgs)</span> <span class="title">algorithm</span>.<span class="title">FitPredicate</span></span> &#123;</div><div class="line">				<span class="keyword">return</span> predicates.NewPodAffinityPredicate(args.NodeInfo, args.PodLister, args.FailureDomains)</div><div class="line">			&#125;,</div><div class="line">		),</div><div class="line"></div><div class="line">		<span class="comment">// Fit is determined by non-conflicting disk volumes.</span></div><div class="line">		<span class="comment">//***注册NoDiskConflict，并返回字符串"NoDiskConflict"***//</span></div><div class="line">		factory.RegisterFitPredicate(<span class="string">"NoDiskConflict"</span>, predicates.NoDiskConflict),</div><div class="line"></div><div class="line">		<span class="comment">// GeneralPredicates are the predicates that are enforced by all Kubernetes components</span></div><div class="line">		<span class="comment">// (e.g. kubelet and all schedulers)</span></div><div class="line">		<span class="comment">//***注册GeneralPredicates，并返回字符串"GeneralPredicates"***//</span></div><div class="line">		factory.RegisterFitPredicate(<span class="string">"GeneralPredicates"</span>, predicates.GeneralPredicates),</div><div class="line"></div><div class="line">		<span class="comment">// Fit is determined based on whether a pod can tolerate all of the node's taints</span></div><div class="line">		<span class="comment">//***注册PodToleratesNodeTaints，并返回字符串"PodToleratesNodeTaints"***//</span></div><div class="line">		factory.RegisterFitPredicate(<span class="string">"PodToleratesNodeTaints"</span>, predicates.PodToleratesNodeTaints),</div><div class="line"></div><div class="line">		<span class="comment">// Fit is determined by node memory pressure condition.</span></div><div class="line">		<span class="comment">//***注册CheckNodeMemoryPressure，并返回字符串"CheckNodeMemoryPressure"***//</span></div><div class="line">		factory.RegisterFitPredicate(<span class="string">"CheckNodeMemoryPressure"</span>, predicates.CheckNodeMemoryPressurePredicate),</div><div class="line"></div><div class="line">		<span class="comment">// Fit is determined by node disk pressure condition.</span></div><div class="line">		<span class="comment">//***注册CheckNodeDiskPressure，并返回字符串"CheckNodeDiskPressure"***//</span></div><div class="line">		factory.RegisterFitPredicate(<span class="string">"CheckNodeDiskPressure"</span>, predicates.CheckNodeDiskPressurePredicate),</div><div class="line">	)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，defaultPredicates()通过调用RegisterFitPredicateFactory()或RegisterFitPredicate()来注册predicates相关函数。defaultsPredicates()返回的是注册的函数的名称的集合。</p>
<p>再来看下defaultPriorities()：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">defaultPriorities</span><span class="params">()</span> <span class="title">sets</span>.<span class="title">String</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> sets.NewString(</div><div class="line">		<span class="comment">// spreads pods by minimizing the number of pods (belonging to the same service or replication controller) on the same node.</span></div><div class="line">		<span class="comment">//***注册SelectorSpreadPriority，并返回字符串"SelectorSpreadPriority"***//</span></div><div class="line">		factory.RegisterPriorityConfigFactory(</div><div class="line">			<span class="string">"SelectorSpreadPriority"</span>,</div><div class="line">			factory.PriorityConfigFactory&#123;</div><div class="line">				Function: <span class="function"><span class="keyword">func</span><span class="params">(args factory.PluginFactoryArgs)</span> <span class="title">algorithm</span>.<span class="title">PriorityFunction</span></span> &#123;</div><div class="line">					<span class="keyword">return</span> priorities.NewSelectorSpreadPriority(args.ServiceLister, args.ControllerLister, args.ReplicaSetLister)</div><div class="line">				&#125;,</div><div class="line">				Weight: <span class="number">1</span>,</div><div class="line">			&#125;,</div><div class="line">		),</div><div class="line">		<span class="comment">// pods should be placed in the same topological domain (e.g. same node, same rack, same zone, same power domain, etc.)</span></div><div class="line">		<span class="comment">// as some other pods, or, conversely, should not be placed in the same topological domain as some other pods.</span></div><div class="line">		<span class="comment">//***注册InterPodAffinityPriority，并返回字符串"InterPodAffinityPriority"***//</span></div><div class="line">		factory.RegisterPriorityConfigFactory(</div><div class="line">			<span class="string">"InterPodAffinityPriority"</span>,</div><div class="line">			factory.PriorityConfigFactory&#123;</div><div class="line">				Function: <span class="function"><span class="keyword">func</span><span class="params">(args factory.PluginFactoryArgs)</span> <span class="title">algorithm</span>.<span class="title">PriorityFunction</span></span> &#123;</div><div class="line">					<span class="keyword">return</span> priorities.NewInterPodAffinityPriority(args.NodeInfo, args.NodeLister, args.PodLister, args.HardPodAffinitySymmetricWeight, args.FailureDomains)</div><div class="line">				&#125;,</div><div class="line">				Weight: <span class="number">1</span>,</div><div class="line">			&#125;,</div><div class="line">		),</div><div class="line"></div><div class="line">		<span class="comment">// Prioritize nodes by least requested utilization.</span></div><div class="line">		<span class="comment">//***注册LeastRequestedPriority，并返回字符串"LeastRequestedPriority"***//</span></div><div class="line">		factory.RegisterPriorityFunction2(<span class="string">"LeastRequestedPriority"</span>, priorities.LeastRequestedPriorityMap, <span class="literal">nil</span>, <span class="number">1</span>),</div><div class="line"></div><div class="line">		<span class="comment">// Prioritizes nodes to help achieve balanced resource usage</span></div><div class="line">		<span class="comment">//***注册BalancedResourceAllocation，并返回字符串"BalancedResourceAllocation"***//</span></div><div class="line">		factory.RegisterPriorityFunction2(<span class="string">"BalancedResourceAllocation"</span>, priorities.BalancedResourceAllocationMap, <span class="literal">nil</span>, <span class="number">1</span>),</div><div class="line"></div><div class="line">		<span class="comment">// Set this weight large enough to override all other priority functions.</span></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> Figure out a better way to do this, maybe at same time as fixing #24720.</span></div><div class="line">		<span class="comment">//***注册NodePreferAvoidPodsPriority，并返回字符串"NodePreferAvoidPodsPriority"***//</span></div><div class="line">		factory.RegisterPriorityFunction2(<span class="string">"NodePreferAvoidPodsPriority"</span>, priorities.CalculateNodePreferAvoidPodsPriorityMap, <span class="literal">nil</span>, <span class="number">10000</span>),</div><div class="line"></div><div class="line">		<span class="comment">// Prioritizes nodes that have labels matching NodeAffinity</span></div><div class="line">		<span class="comment">//***注册NodeAffinityPriority，并返回字符串"NodeAffinityPriority"***//</span></div><div class="line">		factory.RegisterPriorityFunction2(<span class="string">"NodeAffinityPriority"</span>, priorities.CalculateNodeAffinityPriorityMap, priorities.CalculateNodeAffinityPriorityReduce, <span class="number">1</span>),</div><div class="line"></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> explain what it does.</span></div><div class="line">		<span class="comment">//***注册TaintTolerationPriority，并返回字符串"TaintTolerationPriority"***//</span></div><div class="line">		factory.RegisterPriorityFunction2(<span class="string">"TaintTolerationPriority"</span>, priorities.ComputeTaintTolerationPriorityMap, priorities.ComputeTaintTolerationPriorityReduce, <span class="number">1</span>),</div><div class="line">	)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>defaultPriorities()通过RegisterPriorityConfigFactory()或RegisterPriorityFunction2()来注册priority相关函数。defaultPriorities()返回的是注册的函数的名称的集合。</p>
<h2 id="注册管理"><a href="#注册管理" class="headerlink" title="注册管理"></a>注册管理</h2><p>算法函数的注册是通过3个公共Map来管理的，定义在/plugin/pkg/scheduler/factory/plugins.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***algorithmProviderMap, fitPredicateMap和priorityFunctionMap三个全局变量***//</span></div><div class="line"><span class="comment">//***可以从algorithmProviderMap中找到对应名称的fit函数名称和priority函数名称***//</span></div><div class="line">fitPredicateMap      = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]FitPredicateFactory)</div><div class="line">priorityFunctionMap  = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]PriorityConfigFactory)</div><div class="line">algorithmProviderMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]AlgorithmProviderConfig)</div></pre></td></tr></table></figure></p>
<p>其中fitPredicateMap记录了算法名称和predicate算法函数的map关系；priorityFunctionMap记录了算法名称和priority算法函数的map关系；algorithmProviderMap记录了名称和AlgorithmProviderConfig的关系。<br>AlgorithmProviderConfig的定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***AlgorithmProviderConfig中有FitPredicateKeys和PriorityFUnctionKeys***//</span></div><div class="line"><span class="keyword">type</span> AlgorithmProviderConfig <span class="keyword">struct</span> &#123;</div><div class="line">	FitPredicateKeys     sets.String</div><div class="line">	PriorityFunctionKeys sets.String</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，AlgorithmProviderConfig包含FitPredicateKeys和PriorityFunctionKeys，用来记录指定providerName对应的算法的名称。这就可以理解这三个全局变量的关系了，algorithmProviderMap可以根据providerName找到算法名称集；根据算法名称又可以在fitPredicateMap或prioritFunctionMap中找到对应的算法函数。<br>我们先来看如何向fitPredicateMap注册，相关函数定义在/plugin/pkg/scheduler/factory/plugins.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RegisterFitPredicate registers a fit predicate with the algorithm</span></div><div class="line"><span class="comment">// registry. Returns the name with which the predicate was registered.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterFitPredicate</span><span class="params">(name <span class="keyword">string</span>, predicate algorithm.FitPredicate)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> RegisterFitPredicateFactory(name, <span class="function"><span class="keyword">func</span><span class="params">(PluginFactoryArgs)</span> <span class="title">algorithm</span>.<span class="title">FitPredicate</span></span> &#123; <span class="keyword">return</span> predicate &#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RegisterFitPredicateFactory registers a fit predicate factory with the</span></div><div class="line"><span class="comment">// algorithm registry. Returns the name with which the predicate was registered.</span></div><div class="line"><span class="comment">//***向fitPredicateMap注册predicateFactory，并返回name***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterFitPredicateFactory</span><span class="params">(name <span class="keyword">string</span>, predicateFactory FitPredicateFactory)</span> <span class="title">string</span></span> &#123;</div><div class="line">	schedulerFactoryMutex.Lock()</div><div class="line">	<span class="keyword">defer</span> schedulerFactoryMutex.Unlock()</div><div class="line">	validateAlgorithmNameOrDie(name)</div><div class="line">	fitPredicateMap[name] = predicateFactory</div><div class="line">	<span class="keyword">return</span> name</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以使用RegisterFitPredicate()或RegiserFitPredicateFactory()向fitPredicateMap中注册predicate算法函数。</p>
<p>再来看下如何向priorityFunctionMap注册，相关函数定义在/plugin/pkg/scheduler/factory/plugins.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Registers a priority function with the algorithm registry. Returns the name,</span></div><div class="line"><span class="comment">// with which the function was registered.</span></div><div class="line"><span class="comment">// <span class="doctag">FIXME:</span> Rename to PriorityFunctionFactory.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterPriorityFunction2</span><span class="params">(</span></span></div><div class="line">	name <span class="keyword">string</span>,</div><div class="line">	mapFunction algorithm.PriorityMapFunction,</div><div class="line">	reduceFunction algorithm.PriorityReduceFunction,</div><div class="line">	weight <span class="keyword">int</span>) <span class="title">string</span> &#123;</div><div class="line">	<span class="keyword">return</span> RegisterPriorityConfigFactory(name, PriorityConfigFactory&#123;</div><div class="line">		MapReduceFunction: <span class="function"><span class="keyword">func</span><span class="params">(PluginFactoryArgs)</span> <span class="params">(algorithm.PriorityMapFunction, algorithm.PriorityReduceFunction)</span></span> &#123;</div><div class="line">			<span class="keyword">return</span> mapFunction, reduceFunction</div><div class="line">		&#125;,</div><div class="line">		Weight: weight,</div><div class="line">	&#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***向priorityFunctionMap注册Priority Function，并返回name***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterPriorityConfigFactory</span><span class="params">(name <span class="keyword">string</span>, pcf PriorityConfigFactory)</span> <span class="title">string</span></span> &#123;</div><div class="line">	schedulerFactoryMutex.Lock()</div><div class="line">	<span class="keyword">defer</span> schedulerFactoryMutex.Unlock()</div><div class="line">	validateAlgorithmNameOrDie(name)</div><div class="line">	priorityFunctionMap[name] = pcf</div><div class="line">	<span class="keyword">return</span> name</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以使用RegisterPriorityFunctions2()或registerPriorityConfigFactory()向priorityFunctionMap中注册priority算法函数。</p>
<p>最后来看下如何向algorithmProviderMap中注册。相关函数定义在/plugin/pkg/scheduler/factory/plugins.go：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***向algorithmProviderMap注册AlgorithmProvider***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterAlgorithmProvider</span><span class="params">(name <span class="keyword">string</span>, predicateKeys, priorityKeys sets.String)</span> <span class="title">string</span></span> &#123;</div><div class="line">	schedulerFactoryMutex.Lock()</div><div class="line">	<span class="keyword">defer</span> schedulerFactoryMutex.Unlock()</div><div class="line">	validateAlgorithmNameOrDie(name)</div><div class="line">	algorithmProviderMap[name] = AlgorithmProviderConfig&#123;</div><div class="line">		FitPredicateKeys:     predicateKeys,</div><div class="line">		PriorityFunctionKeys: priorityKeys,</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> name</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>所以，在kube-scheduler的初始化过程中，使用fitPredicateMap，priorityFunctionMap，algorithmProviderMap三个公共变量来管理算法函数，所有需要的算法函数都会按类别注册到fitPredicateMap或priorityFuncitonMap中。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/10/03/kube-scheduler分析(一)-init过程-v1-5-2/" data-id="cj9cosk60003bd4qst0fyha9i" class="article-share-link">分享</a><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></div><div class="post-nav"><a href="/2017/10/04/kube-scheduler分析(二)-scheduler-v1-5-2/" class="pre">kube-scheduler分析(二)-scheduler-v1.5.2</a><a href="/2017/10/01/kube-proxy分析(二)-proxier-v1-5-2/" class="next">kube-proxy分析(二)-proxier-v1.5.2</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/Go语言/">Go语言</a></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/29/Docker镜像存储代码分析-referenceStore-v1-12-3/">Docker镜像存储代码分析-referenceStore-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/29/Docker镜像存储代码分析-imageStore-v1-12-3/">Docker镜像存储代码分析-imageStore-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/26/kube-controller分析(三)-NamespaceController-v1-5-2/">kube-controller分析(三)-NamespaceController-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/25/kubernetes-watcher-demo/">kubernetes-watcher-demo</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/24/kube-controller分析(二)-finalizer机制-v1-5-2/">kube-controller分析(二)-finalizer机制-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/19/kube-controller分析(一)-sharedInformerFactory解读-v1-5-2/">kube-controller分析(一)-sharedInformerFactory解读-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/18/kubernetes-client分析(四)-ClientSet-v1-5-2/">kubernetes-client分析(四)-ClientSet-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/16/kubernetes-client分析(三)-dynamicClient-v1-5-2/">kubernetes-client分析(三)-dynamicClient-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/13/kubernetes-client分析(二)-restclient-v1-5-2/">kubernetes-client分析(二)-restclient-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/12/kubernetes-client分析(一)-kubeconfig-v1-5-2/">kubernetes-client分析(一)-kubeconfig-v1.5.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>