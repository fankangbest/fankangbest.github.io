<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>kube-scheduler分析(二)-scheduler-v1.5.2 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">kube-scheduler分析(二)-scheduler-v1.5.2</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">kube-scheduler分析(二)-scheduler-v1.5.2</h1><div class="post-meta">Oct 4, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>本次将分析kube-scheduler的核心——scheduler，来看下是如何生成scheduler，及如何对Pod进行调度的。</p>
<h2 id="ConfigFactory"><a href="#ConfigFactory" class="headerlink" title="ConfigFactory"></a>ConfigFactory</h2><p>ConfigFactory可以生成Scheduler Config。先来看如何生成一个ConfigFactory，生成函数字义在/plugin/pkg/scheduler/factory/factory.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***生成ConfigFactory***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewConfigFactory</span><span class="params">(client clientset.Interface, schedulerName <span class="keyword">string</span>, hardPodAffinitySymmetricWeight <span class="keyword">int</span>, failureDomains <span class="keyword">string</span>)</span> *<span class="title">ConfigFactory</span></span> &#123;</div><div class="line">	stopEverything := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</div><div class="line">	schedulerCache := schedulercache.New(<span class="number">30</span>*time.Second, stopEverything)</div><div class="line"></div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> pass this in as an argument...</span></div><div class="line">	informerFactory := informers.NewSharedInformerFactory(client, <span class="number">0</span>)</div><div class="line">	pvcInformer := informerFactory.PersistentVolumeClaims()</div><div class="line"></div><div class="line">	c := &amp;ConfigFactory&#123;</div><div class="line">		Client:             client,</div><div class="line">		PodQueue:           cache.NewFIFO(cache.MetaNamespaceKeyFunc),</div><div class="line">		ScheduledPodLister: &amp;cache.StoreToPodLister&#123;&#125;,</div><div class="line">		informerFactory:    informerFactory,</div><div class="line">		<span class="comment">// Only nodes in the "Ready" condition with status == "True" are schedulable</span></div><div class="line">		NodeLister:                     &amp;cache.StoreToNodeLister&#123;&#125;,</div><div class="line">		PVLister:                       &amp;cache.StoreToPVFetcher&#123;Store: cache.NewStore(cache.MetaNamespaceKeyFunc)&#125;,</div><div class="line">		PVCLister:                      pvcInformer.Lister(),</div><div class="line">		pvcPopulator:                   pvcInformer.Informer().GetController(),</div><div class="line">		ServiceLister:                  &amp;cache.StoreToServiceLister&#123;Indexer: cache.NewIndexer(cache.MetaNamespaceKeyFunc, cache.Indexers&#123;cache.NamespaceIndex: cache.MetaNamespaceIndexFunc&#125;)&#125;,</div><div class="line">		ControllerLister:               &amp;cache.StoreToReplicationControllerLister&#123;Indexer: cache.NewIndexer(cache.MetaNamespaceKeyFunc, cache.Indexers&#123;cache.NamespaceIndex: cache.MetaNamespaceIndexFunc&#125;)&#125;,</div><div class="line">		ReplicaSetLister:               &amp;cache.StoreToReplicaSetLister&#123;Indexer: cache.NewIndexer(cache.MetaNamespaceKeyFunc, cache.Indexers&#123;cache.NamespaceIndex: cache.MetaNamespaceIndexFunc&#125;)&#125;,</div><div class="line">		schedulerCache:                 schedulerCache,</div><div class="line">		StopEverything:                 stopEverything,</div><div class="line">		SchedulerName:                  schedulerName,</div><div class="line">		HardPodAffinitySymmetricWeight: hardPodAffinitySymmetricWeight,</div><div class="line">		FailureDomains:                 failureDomains,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	c.PodLister = schedulerCache</div><div class="line"></div><div class="line">	<span class="comment">// On add/delete to the scheduled pods, remove from the assumed pods.</span></div><div class="line">	<span class="comment">// We construct this here instead of in CreateFromKeys because</span></div><div class="line">	<span class="comment">// ScheduledPodLister is something we provide to plug in functions that</span></div><div class="line">	<span class="comment">// they may need to call.</span></div><div class="line">	<span class="comment">//***生成scheduledPod Indexer Contoller***//</span></div><div class="line">	c.ScheduledPodLister.Indexer, c.scheduledPodPopulator = cache.NewIndexerInformer(</div><div class="line">		c.createAssignedNonTerminatedPodLW(),</div><div class="line">		&amp;api.Pod&#123;&#125;,</div><div class="line">		<span class="number">0</span>,</div><div class="line">		cache.ResourceEventHandlerFuncs&#123;</div><div class="line">			AddFunc:    c.addPodToCache,</div><div class="line">			UpdateFunc: c.updatePodInCache,</div><div class="line">			DeleteFunc: c.deletePodFromCache,</div><div class="line">		&#125;,</div><div class="line">		cache.Indexers&#123;cache.NamespaceIndex: cache.MetaNamespaceIndexFunc&#125;,</div><div class="line">	)</div><div class="line"></div><div class="line">	<span class="comment">//***生成Node Controller***//</span></div><div class="line">	c.NodeLister.Store, c.nodePopulator = cache.NewInformer(</div><div class="line">		c.createNodeLW(),</div><div class="line">		&amp;api.Node&#123;&#125;,</div><div class="line">		<span class="number">0</span>,</div><div class="line">		cache.ResourceEventHandlerFuncs&#123;</div><div class="line">			AddFunc:    c.addNodeToCache,</div><div class="line">			UpdateFunc: c.updateNodeInCache,</div><div class="line">			DeleteFunc: c.deleteNodeFromCache,</div><div class="line">		&#125;,</div><div class="line">	)</div><div class="line"></div><div class="line">	<span class="comment">// TODO(harryz) need to fill all the handlers here and below for equivalence cache</span></div><div class="line">	<span class="comment">//***生成PV Controller***//</span></div><div class="line">	c.PVLister.Store, c.pvPopulator = cache.NewInformer(</div><div class="line">		c.createPersistentVolumeLW(),</div><div class="line">		&amp;api.PersistentVolume&#123;&#125;,</div><div class="line">		<span class="number">0</span>,</div><div class="line">		cache.ResourceEventHandlerFuncs&#123;&#125;,</div><div class="line">	)</div><div class="line"></div><div class="line">	<span class="comment">//***生成Service Controller***//</span></div><div class="line">	c.ServiceLister.Indexer, c.servicePopulator = cache.NewIndexerInformer(</div><div class="line">		c.createServiceLW(),</div><div class="line">		&amp;api.Service&#123;&#125;,</div><div class="line">		<span class="number">0</span>,</div><div class="line">		cache.ResourceEventHandlerFuncs&#123;&#125;,</div><div class="line">		cache.Indexers&#123;cache.NamespaceIndex: cache.MetaNamespaceIndexFunc&#125;,</div><div class="line">	)</div><div class="line"></div><div class="line">	<span class="comment">//***生成RC Controller***//</span></div><div class="line">	c.ControllerLister.Indexer, c.controllerPopulator = cache.NewIndexerInformer(</div><div class="line">		c.createControllerLW(),</div><div class="line">		&amp;api.ReplicationController&#123;&#125;,</div><div class="line">		<span class="number">0</span>,</div><div class="line">		cache.ResourceEventHandlerFuncs&#123;&#125;,</div><div class="line">		cache.Indexers&#123;cache.NamespaceIndex: cache.MetaNamespaceIndexFunc&#125;,</div><div class="line">	)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> c</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>NewConfigFactory就是往ConfigFactory中填充各字段。其中比较重要的是<code>PodQueue: cache.NewFIFO(cache.MetaNamespaceKeyFunc)</code>，PodQueue中缓存着未被调度的Pod。<br>ConfigFactory可以生成Scheduler Config，有两种生成方式：第一种通过CreateFromProvider()，第二种通过CreateFromConfig()，这两个方法都定义在/plugin/pkg/scheduler/factory/factory.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Creates a scheduler from the name of a registered algorithm provider.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *ConfigFactory)</span> <span class="title">CreateFromProvider</span><span class="params">(providerName <span class="keyword">string</span>)</span> <span class="params">(*scheduler.Config, error)</span></span> &#123;</div><div class="line">	glog.V(<span class="number">2</span>).Infof(<span class="string">"Creating scheduler from algorithm provider '%v'"</span>, providerName)</div><div class="line">	<span class="comment">//***从algorithmProviderMap中获取providerName对应的AlgorithmProviderConfig***//</span></div><div class="line">	provider, err := GetAlgorithmProvider(providerName)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***调用CreateFromKeys***//</span></div><div class="line">	<span class="keyword">return</span> f.CreateFromKeys(provider.FitPredicateKeys, provider.PriorityFunctionKeys, []algorithm.SchedulerExtender&#123;&#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Creates a scheduler from the configuration file</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *ConfigFactory)</span> <span class="title">CreateFromConfig</span><span class="params">(policy schedulerapi.Policy)</span> <span class="params">(*scheduler.Config, error)</span></span> &#123;</div><div class="line">	glog.V(<span class="number">2</span>).Infof(<span class="string">"Creating scheduler from configuration: %v"</span>, policy)</div><div class="line"></div><div class="line">	<span class="comment">// validate the policy configuration</span></div><div class="line">	<span class="keyword">if</span> err := validation.ValidatePolicy(policy); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***从policy中获取predicateKeys***//</span></div><div class="line">	predicateKeys := sets.NewString()</div><div class="line">	<span class="keyword">for</span> _, predicate := <span class="keyword">range</span> policy.Predicates &#123;</div><div class="line">		glog.V(<span class="number">2</span>).Infof(<span class="string">"Registering predicate: %s"</span>, predicate.Name)</div><div class="line">		predicateKeys.Insert(RegisterCustomFitPredicate(predicate))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***从policy中获取priorityKeys***//</span></div><div class="line">	priorityKeys := sets.NewString()</div><div class="line">	<span class="keyword">for</span> _, priority := <span class="keyword">range</span> policy.Priorities &#123;</div><div class="line">		glog.V(<span class="number">2</span>).Infof(<span class="string">"Registering priority: %s"</span>, priority.Name)</div><div class="line">		priorityKeys.Insert(RegisterCustomPriorityFunction(priority))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	extenders := <span class="built_in">make</span>([]algorithm.SchedulerExtender, <span class="number">0</span>)</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(policy.ExtenderConfigs) != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">for</span> ii := <span class="keyword">range</span> policy.ExtenderConfigs &#123;</div><div class="line">			glog.V(<span class="number">2</span>).Infof(<span class="string">"Creating extender with config %+v"</span>, policy.ExtenderConfigs[ii])</div><div class="line">			<span class="keyword">if</span> extender, err := scheduler.NewHTTPExtender(&amp;policy.ExtenderConfigs[ii], policy.APIVersion); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				extenders = <span class="built_in">append</span>(extenders, extender)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***调用CreateFromKeys***//</span></div><div class="line">	<span class="keyword">return</span> f.CreateFromKeys(predicateKeys, priorityKeys, extenders)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，CreateFromProvider()直接从algorithmProviderMap中获取对应的predicateKeys和priorityKeys；而CreateFromConfig()从配置文件中获取predicateKeys和priorityKeys，最后两个方法都调用了CreateFromKeys()。CreateFromKeys()同样定义在/plugin/pkg/scheduler/factory/factory.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Creates a scheduler from a set of registered fit predicate keys and priority keys.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *ConfigFactory)</span> <span class="title">CreateFromKeys</span><span class="params">(predicateKeys, priorityKeys sets.String, extenders []algorithm.SchedulerExtender)</span> <span class="params">(*scheduler.Config, error)</span></span> &#123;</div><div class="line">	glog.V(<span class="number">2</span>).Infof(<span class="string">"creating scheduler with fit predicates '%v' and priority functions '%v"</span>, predicateKeys, priorityKeys)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> f.HardPodAffinitySymmetricWeight &lt; <span class="number">0</span> || f.HardPodAffinitySymmetricWeight &gt; <span class="number">100</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"invalid hardPodAffinitySymmetricWeight: %d, must be in the range 0-100"</span>, f.HardPodAffinitySymmetricWeight)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	predicateFuncs, err := f.GetPredicates(predicateKeys)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	priorityConfigs, err := f.GetPriorityFunctionConfigs(priorityKeys)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	priorityMetaProducer, err := f.GetPriorityMetadataProducer()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	predicateMetaProducer, err := f.GetPredicateMetadataProducer()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	f.Run()</div><div class="line">	<span class="comment">//***使用NewGenericScheduler()作为调度器***//</span></div><div class="line">	algo := scheduler.NewGenericScheduler(f.schedulerCache, predicateFuncs, predicateMetaProducer, priorityConfigs, priorityMetaProducer, extenders)</div><div class="line">	podBackoff := podBackoff&#123;</div><div class="line">		perPodBackoff: <span class="keyword">map</span>[types.NamespacedName]*backoffEntry&#123;&#125;,</div><div class="line">		clock:         realClock&#123;&#125;,</div><div class="line"></div><div class="line">		defaultDuration: <span class="number">1</span> * time.Second,</div><div class="line">		maxDuration:     <span class="number">60</span> * time.Second,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;scheduler.Config&#123;</div><div class="line">		SchedulerCache: f.schedulerCache,</div><div class="line">		<span class="comment">// The scheduler only needs to consider schedulable nodes.</span></div><div class="line">		NodeLister:          f.NodeLister.NodeCondition(getNodeConditionPredicate()),</div><div class="line">		Algorithm:           algo,</div><div class="line">		Binder:              &amp;binder&#123;f.Client&#125;,</div><div class="line">		PodConditionUpdater: &amp;podConditionUpdater&#123;f.Client&#125;,</div><div class="line">		NextPod: <span class="function"><span class="keyword">func</span><span class="params">()</span> *<span class="title">api</span>.<span class="title">Pod</span></span> &#123;</div><div class="line">			<span class="keyword">return</span> f.getNextPod()</div><div class="line">		&#125;,</div><div class="line">		Error:          f.makeDefaultErrorFunc(&amp;podBackoff, f.PodQueue),</div><div class="line">		StopEverything: f.StopEverything,</div><div class="line">	&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在生成scheduler.Config的同时，CreateFromKeys()还调用了ConfigFactory的Run()：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *ConfigFactory)</span> <span class="title">Run</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Watch and queue pods that need scheduling.</span></div><div class="line">	<span class="comment">//***PodQueue的生产者***//</span></div><div class="line">	<span class="comment">//***createUnassignedNonTerminatedPodLW()返回内容为未被调度的Pods的ListWatcher***//</span></div><div class="line">	cache.NewReflector(f.createUnassignedNonTerminatedPodLW(), &amp;api.Pod&#123;&#125;, f.PodQueue, <span class="number">0</span>).RunUntil(f.StopEverything)</div><div class="line"></div><div class="line">	<span class="comment">//***以下代码启动各Controller***//</span></div><div class="line">	<span class="comment">// Begin populating scheduled pods.</span></div><div class="line">	<span class="keyword">go</span> f.scheduledPodPopulator.Run(f.StopEverything)</div><div class="line"></div><div class="line">	<span class="comment">// Begin populating nodes.</span></div><div class="line">	<span class="keyword">go</span> f.nodePopulator.Run(f.StopEverything)</div><div class="line"></div><div class="line">	<span class="comment">// Begin populating pv &amp; pvc</span></div><div class="line">	<span class="keyword">go</span> f.pvPopulator.Run(f.StopEverything)</div><div class="line">	<span class="keyword">go</span> f.pvcPopulator.Run(f.StopEverything)</div><div class="line"></div><div class="line">	<span class="comment">// Begin populating services</span></div><div class="line">	<span class="keyword">go</span> f.servicePopulator.Run(f.StopEverything)</div><div class="line"></div><div class="line">	<span class="comment">// Begin populating controllers</span></div><div class="line">	<span class="keyword">go</span> f.controllerPopulator.Run(f.StopEverything)</div><div class="line"></div><div class="line">	<span class="comment">// start informers...</span></div><div class="line">	f.informerFactory.Start(f.StopEverything)</div><div class="line"></div><div class="line">	<span class="comment">// Watch and cache all ReplicaSet objects. Scheduler needs to find all pods</span></div><div class="line">	<span class="comment">// created by the same services or ReplicationControllers/ReplicaSets, so that it can spread them correctly.</span></div><div class="line">	<span class="comment">// Cache this locally.</span></div><div class="line">	cache.NewReflector(f.createReplicaSetLW(), &amp;extensions.ReplicaSet&#123;&#125;, f.ReplicaSetLister.Indexer, <span class="number">0</span>).RunUntil(f.StopEverything)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>来先看下PodQueue的生产者：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cache.NewReflector(f.createUnassignedNonTerminatedPodLW(), &amp;api.Pod&#123;&#125;, f.PodQueue, <span class="number">0</span>).RunUntil(f.StopEverything)</div></pre></td></tr></table></figure></p>
<p>代码使用createUnassignedNonTerminatedpodLW()向PodQueue进行输入。createUnassignedNonTerminatedPodLW()定义在/plugin/pkg/scheduler/factory/factory.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***找到未被调度的Pods***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(factory *ConfigFactory)</span> <span class="title">createUnassignedNonTerminatedPodLW</span><span class="params">()</span> *<span class="title">cache</span>.<span class="title">ListWatch</span></span> &#123;</div><div class="line">	selector := fields.ParseSelectorOrDie(<span class="string">"spec.nodeName=="</span> + <span class="string">""</span> + <span class="string">",status.phase!="</span> + <span class="keyword">string</span>(api.PodSucceeded) + <span class="string">",status.phase!="</span> + <span class="keyword">string</span>(api.PodFailed))</div><div class="line">	<span class="keyword">return</span> cache.NewListWatchFromClient(factory.Client.Core().RESTClient(), <span class="string">"pods"</span>, api.NamespaceAll, selector)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，kube-scheduler会对spec.nodeName=””且status.phase!=”Succeeded”且status.phase!=”Failed”的Pod进行调度。</p>
<p>回到Run()，Run()接着会开启各Controller。</p>
<p>因为ConfigFactory中缓存着未被调度的Pods，那么获取一个未被调度的Pod就是件很容易的事情了：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从PodQueue中Pop()出一个数据***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *ConfigFactory)</span> <span class="title">getNextPod</span><span class="params">()</span> *<span class="title">api</span>.<span class="title">Pod</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		pod := cache.Pop(f.PodQueue).(*api.Pod)</div><div class="line">		<span class="keyword">if</span> f.responsibleForPod(pod) &#123;</div><div class="line">			glog.V(<span class="number">4</span>).Infof(<span class="string">"About to try and schedule pod %v"</span>, pod.Name)</div><div class="line">			<span class="keyword">return</span> pod</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>getNextPod()直接从PodQueue中获取一个Pod。</p>
<h2 id="Scheduler-Config"><a href="#Scheduler-Config" class="headerlink" title="Scheduler Config"></a>Scheduler Config</h2><p>Scheduler的Config定义在/plugin/pkg/scheduler/scheduler.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// It is expected that changes made via SchedulerCache will be observed</span></div><div class="line">	<span class="comment">// by NodeLister and Algorithm.</span></div><div class="line">	SchedulerCache schedulercache.Cache</div><div class="line">	NodeLister     algorithm.NodeLister</div><div class="line">	Algorithm      algorithm.ScheduleAlgorithm</div><div class="line">	Binder         Binder</div><div class="line">	<span class="comment">// PodConditionUpdater is used only in case of scheduling errors. If we succeed</span></div><div class="line">	<span class="comment">// with scheduling, PodScheduled condition will be updated in apiserver in /bind</span></div><div class="line">	<span class="comment">// handler so that binding and setting PodCondition it is atomic.</span></div><div class="line">	PodConditionUpdater PodConditionUpdater</div><div class="line"></div><div class="line">	<span class="comment">// NextPod should be a function that blocks until the next pod</span></div><div class="line">	<span class="comment">// is available. We don't use a channel for this, because scheduling</span></div><div class="line">	<span class="comment">// a pod may take some amount of time and we don't want pods to get</span></div><div class="line">	<span class="comment">// stale while they sit in a channel.</span></div><div class="line">	NextPod <span class="function"><span class="keyword">func</span><span class="params">()</span> *<span class="title">api</span>.<span class="title">Pod</span></span></div><div class="line"></div><div class="line">	// <span class="title">Error</span> <span class="title">is</span> <span class="title">called</span> <span class="title">if</span> <span class="title">there</span> <span class="title">is</span> <span class="title">an</span> <span class="title">error</span>. <span class="title">It</span> <span class="title">is</span> <span class="title">passed</span> <span class="title">the</span> <span class="title">pod</span> <span class="title">in</span></div><div class="line">	// <span class="title">question</span>, <span class="title">and</span> <span class="title">the</span> <span class="title">error</span></div><div class="line">	<span class="title">Error</span> <span class="title">func</span><span class="params">(*api.Pod, error)</span></div><div class="line"></div><div class="line">	// <span class="title">Recorder</span> <span class="title">is</span> <span class="title">the</span> <span class="title">EventRecorder</span> <span class="title">to</span> <span class="title">use</span></div><div class="line">	<span class="title">Recorder</span> <span class="title">record</span>.<span class="title">EventRecorder</span></div><div class="line"></div><div class="line">	// <span class="title">Close</span> <span class="title">this</span> <span class="title">to</span> <span class="title">shut</span> <span class="title">down</span> <span class="title">the</span> <span class="title">scheduler</span>.</div><div class="line">	<span class="title">StopEverything</span> <span class="title">chan</span> <span class="title">struct</span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以从Scheduler Config生成一个scheduler：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// New returns a new scheduler.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(c *Config)</span> *<span class="title">Scheduler</span></span> &#123;</div><div class="line">	s := &amp;Scheduler&#123;</div><div class="line">		config: c,</div><div class="line">	&#125;</div><div class="line">	metrics.Register()</div><div class="line">	<span class="keyword">return</span> s</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h2><p>Scheduler定义在/plugin/pkg/scheduler/scheduler.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Scheduler watches for new unscheduled pods. It attempts to find</span></div><div class="line"><span class="comment">// nodes that they fit on and writes bindings back to the api server.</span></div><div class="line"><span class="keyword">type</span> Scheduler <span class="keyword">struct</span> &#123;</div><div class="line">	config *Config</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Scheduler本质就是一个Config。Scheduler定义了Run()方法用于启动scheduler，定义在/plugin/pkg/scheduler/scheduler.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheduler)</span> <span class="title">Run</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">go</span> wait.Until(s.scheduleOne, <span class="number">0</span>, s.config.StopEverything)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，Run()以goroutine的形式启动schedulerOne()。schedulerOne()定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取一个未被调度的pod，然后进行调度***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheduler)</span> <span class="title">scheduleOne</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">//***获取一个未被调度的pod***//</span></div><div class="line">	pod := s.config.NextPod()</div><div class="line"></div><div class="line">	glog.V(<span class="number">3</span>).Infof(<span class="string">"Attempting to schedule pod: %v/%v"</span>, pod.Namespace, pod.Name)</div><div class="line">	start := time.Now()</div><div class="line">	<span class="comment">//***实际调度调用的是generic_scheduler的Schedule()***//</span></div><div class="line">	dest, err := s.config.Algorithm.Schedule(pod, s.config.NodeLister)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.V(<span class="number">1</span>).Infof(<span class="string">"Failed to schedule pod: %v/%v"</span>, pod.Namespace, pod.Name)</div><div class="line">		s.config.Error(pod, err)</div><div class="line">		s.config.Recorder.Eventf(pod, api.EventTypeWarning, <span class="string">"FailedScheduling"</span>, <span class="string">"%v"</span>, err)</div><div class="line">		s.config.PodConditionUpdater.Update(pod, &amp;api.PodCondition&#123;</div><div class="line">			Type:   api.PodScheduled,</div><div class="line">			Status: api.ConditionFalse,</div><div class="line">			Reason: api.PodReasonUnschedulable,</div><div class="line">		&#125;)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	metrics.SchedulingAlgorithmLatency.Observe(metrics.SinceInMicroseconds(start))</div><div class="line"></div><div class="line">	<span class="comment">// Optimistically assume that the binding will succeed and send it to apiserver</span></div><div class="line">	<span class="comment">// in the background.</span></div><div class="line">	<span class="comment">// If the binding fails, scheduler will release resources allocated to assumed pod</span></div><div class="line">	<span class="comment">// immediately.</span></div><div class="line">	assumed := *pod</div><div class="line">	assumed.Spec.NodeName = dest</div><div class="line">	<span class="keyword">if</span> err := s.config.SchedulerCache.AssumePod(&amp;assumed); err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.Errorf(<span class="string">"scheduler cache AssumePod failed: %v"</span>, err)</div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> This means that a given pod is already in cache (which means it</span></div><div class="line">		<span class="comment">// is either assumed or already added). This is most probably result of a</span></div><div class="line">		<span class="comment">// BUG in retrying logic. As a temporary workaround (which doesn't fully</span></div><div class="line">		<span class="comment">// fix the problem, but should reduce its impact), we simply return here,</span></div><div class="line">		<span class="comment">// as binding doesn't make sense anyway.</span></div><div class="line">		<span class="comment">// This should be fixed properly though.</span></div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">defer</span> metrics.E2eSchedulingLatency.Observe(metrics.SinceInMicroseconds(start))</div><div class="line"></div><div class="line">		b := &amp;api.Binding&#123;</div><div class="line">			ObjectMeta: api.ObjectMeta&#123;Namespace: pod.Namespace, Name: pod.Name&#125;,</div><div class="line">			Target: api.ObjectReference&#123;</div><div class="line">				Kind: <span class="string">"Node"</span>,</div><div class="line">				Name: dest,</div><div class="line">			&#125;,</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		bindingStart := time.Now()</div><div class="line">		<span class="comment">// If binding succeeded then PodScheduled condition will be updated in apiserver so that</span></div><div class="line">		<span class="comment">// it's atomic with setting host.</span></div><div class="line">		err := s.config.Binder.Bind(b)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			glog.V(<span class="number">1</span>).Infof(<span class="string">"Failed to bind pod: %v/%v"</span>, pod.Namespace, pod.Name)</div><div class="line">			<span class="keyword">if</span> err := s.config.SchedulerCache.ForgetPod(&amp;assumed); err != <span class="literal">nil</span> &#123;</div><div class="line">				glog.Errorf(<span class="string">"scheduler cache ForgetPod failed: %v"</span>, err)</div><div class="line">			&#125;</div><div class="line">			s.config.Error(pod, err)</div><div class="line">			s.config.Recorder.Eventf(pod, api.EventTypeNormal, <span class="string">"FailedScheduling"</span>, <span class="string">"Binding rejected: %v"</span>, err)</div><div class="line">			s.config.PodConditionUpdater.Update(pod, &amp;api.PodCondition&#123;</div><div class="line">				Type:   api.PodScheduled,</div><div class="line">				Status: api.ConditionFalse,</div><div class="line">				Reason: <span class="string">"BindingRejected"</span>,</div><div class="line">			&#125;)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		metrics.BindingLatency.Observe(metrics.SinceInMicroseconds(bindingStart))</div><div class="line">		s.config.Recorder.Eventf(pod, api.EventTypeNormal, <span class="string">"Scheduled"</span>, <span class="string">"Successfully assigned %v to %v"</span>, pod.Name, dest)</div><div class="line">	&#125;()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>scheduleOne()先获取一个未被调用的Pod，然后GenericScheduler的Schedule()来获取一个合适的节点，最后生成Binding，并写入Apiserver。</p>
<h2 id="GenericScheduler"><a href="#GenericScheduler" class="headerlink" title="GenericScheduler"></a>GenericScheduler</h2><p>一般情况，Scheduler中的Algorithm为GenericScheduler。GenericScheduler定义有Schedule()方法选择合适的节点：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Schedule tries to schedule the given pod to one of node in the node list.</span></div><div class="line"><span class="comment">// If it succeeds, it will return the name of the node.</span></div><div class="line"><span class="comment">// If it fails, it will return a Fiterror error with reasons.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *genericScheduler)</span> <span class="title">Schedule</span><span class="params">(pod *api.Pod, nodeLister algorithm.NodeLister)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> trace *util.Trace</div><div class="line">	<span class="keyword">if</span> pod != <span class="literal">nil</span> &#123;</div><div class="line">		trace = util.NewTrace(fmt.Sprintf(<span class="string">"Scheduling %s/%s"</span>, pod.Namespace, pod.Name))</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		trace = util.NewTrace(<span class="string">"Scheduling &lt;nil&gt; pod"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> trace.LogIfLong(<span class="number">100</span> * time.Millisecond)</div><div class="line"></div><div class="line">	<span class="comment">//***获取节点列表***//</span></div><div class="line">	nodes, err := nodeLister.List()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(nodes) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, ErrNoNodesAvailable</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Used for all fit and priority funcs.</span></div><div class="line">	err = g.cache.UpdateNodeNameToInfoMap(g.cachedNodeInfoMap)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// TODO(harryz) Check if equivalenceCache is enabled and call scheduleWithEquivalenceClass here</span></div><div class="line"></div><div class="line">	trace.Step(<span class="string">"Computing predicates"</span>)</div><div class="line">	<span class="comment">//***过滤出符合要求的节点***//</span></div><div class="line">	filteredNodes, failedPredicateMap, err := findNodesThatFit(pod, g.cachedNodeInfoMap, nodes, g.predicates, g.extenders, g.predicateMetaProducer)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(filteredNodes) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, &amp;FitError&#123;</div><div class="line">			Pod:              pod,</div><div class="line">			FailedPredicates: failedPredicateMap,</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	trace.Step(<span class="string">"Prioritizing"</span>)</div><div class="line">	metaPrioritiesInterface := g.priorityMetaProducer(pod, g.cachedNodeInfoMap)</div><div class="line">	<span class="comment">//***计算优先级***//</span></div><div class="line">	priorityList, err := PrioritizeNodes(pod, g.cachedNodeInfoMap, metaPrioritiesInterface, g.prioritizers, filteredNodes, g.extenders)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	trace.Step(<span class="string">"Selecting host"</span>)</div><div class="line">	<span class="keyword">return</span> g.selectHost(priorityList)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出Schedule()方法的流程如下：</p>
<ul>
<li>获取节点列表；</li>
<li>通过findNodesThatFit()找到符合条件的节点；</li>
<li>通过PrioritizeNodes()计算节点的分数；</li>
<li>通过selectHost()选择分数最高的节点。</li>
</ul>
<h4 id="findNodesThatFit"><a href="#findNodesThatFit" class="headerlink" title="findNodesThatFit()"></a>findNodesThatFit()</h4><p>先来看findNodesThatFit()：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Filters the nodes to find the ones that fit based on the given predicate functions</span></div><div class="line"><span class="comment">// Each node is passed through the predicate functions to determine if it is a fit</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">findNodesThatFit</span><span class="params">(</span></span></div><div class="line">	pod *api.Pod,</div><div class="line">	nodeNameToInfo <span class="keyword">map</span>[<span class="keyword">string</span>]*schedulercache.NodeInfo,</div><div class="line">	nodes []*api.Node,</div><div class="line">	predicateFuncs <span class="keyword">map</span>[<span class="keyword">string</span>]algorithm.FitPredicate,</div><div class="line">	extenders []algorithm.SchedulerExtender,</div><div class="line">	metadataProducer algorithm.MetadataProducer,</div><div class="line">) <span class="params">([]*api.Node, FailedPredicateMap, error)</span> &#123;</div><div class="line">	<span class="keyword">var</span> filtered []*api.Node</div><div class="line">	failedPredicateMap := FailedPredicateMap&#123;&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(predicateFuncs) == <span class="number">0</span> &#123;</div><div class="line">		filtered = nodes</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// Create filtered list with enough space to avoid growing it</span></div><div class="line">		<span class="comment">// and allow assigning.</span></div><div class="line">		filtered = <span class="built_in">make</span>([]*api.Node, <span class="built_in">len</span>(nodes))</div><div class="line">		errs := []error&#123;&#125;</div><div class="line">		<span class="keyword">var</span> predicateResultLock sync.Mutex</div><div class="line">		<span class="keyword">var</span> filteredLen <span class="keyword">int32</span></div><div class="line"></div><div class="line">		<span class="comment">// We can use the same metadata producer for all nodes.</span></div><div class="line">		meta := metadataProducer(pod, nodeNameToInfo)</div><div class="line">		<span class="comment">//***检查node的函数***//</span></div><div class="line">		checkNode := <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">			nodeName := nodes[i].Name</div><div class="line">			<span class="comment">//***执行predicate检查***//</span></div><div class="line">			fits, failedPredicates, err := podFitsOnNode(pod, meta, nodeNameToInfo[nodeName], predicateFuncs)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				predicateResultLock.Lock()</div><div class="line">				errs = <span class="built_in">append</span>(errs, err)</div><div class="line">				predicateResultLock.Unlock()</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> fits &#123;</div><div class="line">				filtered[atomic.AddInt32(&amp;filteredLen, <span class="number">1</span>)<span class="number">-1</span>] = nodes[i]</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				predicateResultLock.Lock()</div><div class="line">				failedPredicateMap[nodeName] = failedPredicates</div><div class="line">				predicateResultLock.Unlock()</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		workqueue.Parallelize(<span class="number">16</span>, <span class="built_in">len</span>(nodes), checkNode)</div><div class="line">		filtered = filtered[:filteredLen]</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(errs) &gt; <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> []*api.Node&#123;&#125;, FailedPredicateMap&#123;&#125;, errors.NewAggregate(errs)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***使用extenders对nodes进行检查***//</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(filtered) &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(extenders) != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">for</span> _, extender := <span class="keyword">range</span> extenders &#123;</div><div class="line">			filteredList, failedMap, err := extender.Filter(pod, filtered)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> []*api.Node&#123;&#125;, FailedPredicateMap&#123;&#125;, err</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">for</span> failedNodeName, failedMsg := <span class="keyword">range</span> failedMap &#123;</div><div class="line">				<span class="keyword">if</span> _, found := failedPredicateMap[failedNodeName]; !found &#123;</div><div class="line">					failedPredicateMap[failedNodeName] = []algorithm.PredicateFailureReason&#123;&#125;</div><div class="line">				&#125;</div><div class="line">				failedPredicateMap[failedNodeName] = <span class="built_in">append</span>(failedPredicateMap[failedNodeName], predicates.NewFailureReason(failedMsg))</div><div class="line">			&#125;</div><div class="line">			filtered = filteredList</div><div class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(filtered) == <span class="number">0</span> &#123;</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> filtered, failedPredicateMap, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>findNodesThatFit()会启动多个routine调用checkNode()并行对节点进行检查。其中checkNode()主要调用了podFitsOnNode():<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***执行predicate检查***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">podFitsOnNode</span><span class="params">(pod *api.Pod, meta <span class="keyword">interface</span>&#123;&#125;, info *schedulercache.NodeInfo, predicateFuncs <span class="keyword">map</span>[<span class="keyword">string</span>]algorithm.FitPredicate)</span> <span class="params">(<span class="keyword">bool</span>, []algorithm.PredicateFailureReason, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> failedPredicates []algorithm.PredicateFailureReason</div><div class="line">	<span class="keyword">for</span> _, predicate := <span class="keyword">range</span> predicateFuncs &#123;</div><div class="line">		fit, reasons, err := predicate(pod, meta, info)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			err := fmt.Errorf(<span class="string">"SchedulerPredicates failed due to %v, which is unexpected."</span>, err)</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span>, []algorithm.PredicateFailureReason&#123;&#125;, err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> !fit &#123;</div><div class="line">			failedPredicates = <span class="built_in">append</span>(failedPredicates, reasons...)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***如果failedPredicates为0，则表明该node符合要求***//</span></div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(failedPredicates) == <span class="number">0</span>, failedPredicates, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>podFitsOnNode()会调用每个predicateFunc来对node进行检查，如果全部通过，则该node符合要求。</p>
<h4 id="PrioritizeNodes"><a href="#PrioritizeNodes" class="headerlink" title="PrioritizeNodes()"></a>PrioritizeNodes()</h4><p>再来看PrioritizeNodes()：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">PrioritizeNodes</span><span class="params">(</span></span></div><div class="line">	pod *api.Pod,</div><div class="line">	nodeNameToInfo <span class="keyword">map</span>[<span class="keyword">string</span>]*schedulercache.NodeInfo,</div><div class="line">	meta <span class="keyword">interface</span>&#123;&#125;,</div><div class="line">	priorityConfigs []algorithm.PriorityConfig,</div><div class="line">	nodes []*api.Node,</div><div class="line">	extenders []algorithm.SchedulerExtender,</div><div class="line">) <span class="params">(schedulerapi.HostPriorityList, error)</span> &#123;</div><div class="line">	<span class="comment">// If no priority configs are provided, then the EqualPriority function is applied</span></div><div class="line">	<span class="comment">// This is required to generate the priority list in the required format</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(priorityConfigs) == <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(extenders) == <span class="number">0</span> &#123;</div><div class="line">		result := <span class="built_in">make</span>(schedulerapi.HostPriorityList, <span class="number">0</span>, <span class="built_in">len</span>(nodes))</div><div class="line">		<span class="keyword">for</span> i := <span class="keyword">range</span> nodes &#123;</div><div class="line">			hostPriority, err := EqualPriorityMap(pod, meta, nodeNameToInfo[nodes[i].Name])</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125;</div><div class="line">			result = <span class="built_in">append</span>(result, hostPriority)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> result, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> (</div><div class="line">		mu   = sync.Mutex&#123;&#125;</div><div class="line">		wg   = sync.WaitGroup&#123;&#125;</div><div class="line">		errs []error</div><div class="line">	)</div><div class="line">	appendError := <span class="function"><span class="keyword">func</span><span class="params">(err error)</span></span> &#123;</div><div class="line">		mu.Lock()</div><div class="line">		<span class="keyword">defer</span> mu.Unlock()</div><div class="line">		errs = <span class="built_in">append</span>(errs, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	results := <span class="built_in">make</span>([]schedulerapi.HostPriorityList, <span class="number">0</span>, <span class="built_in">len</span>(priorityConfigs))</div><div class="line">	<span class="keyword">for</span> <span class="keyword">range</span> priorityConfigs &#123;</div><div class="line">		results = <span class="built_in">append</span>(results, <span class="literal">nil</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> i, priorityConfig := <span class="keyword">range</span> priorityConfigs &#123;</div><div class="line">		<span class="keyword">if</span> priorityConfig.Function != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="comment">// DEPRECATED</span></div><div class="line">			wg.Add(<span class="number">1</span>)</div><div class="line">			<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(index <span class="keyword">int</span>, config algorithm.PriorityConfig)</span></span> &#123;</div><div class="line">				<span class="keyword">defer</span> wg.Done()</div><div class="line">				<span class="keyword">var</span> err error</div><div class="line">				results[index], err = config.Function(pod, nodeNameToInfo, nodes)</div><div class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">					appendError(err)</div><div class="line">				&#125;</div><div class="line">			&#125;(i, priorityConfig)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			results[i] = <span class="built_in">make</span>(schedulerapi.HostPriorityList, <span class="built_in">len</span>(nodes))</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	processNode := <span class="function"><span class="keyword">func</span><span class="params">(index <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">		nodeInfo := nodeNameToInfo[nodes[index].Name]</div><div class="line">		<span class="keyword">var</span> err error</div><div class="line">		<span class="keyword">for</span> i := <span class="keyword">range</span> priorityConfigs &#123;</div><div class="line">			<span class="keyword">if</span> priorityConfigs[i].Function != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">			results[i][index], err = priorityConfigs[i].Map(pod, meta, nodeInfo)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				appendError(err)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	workqueue.Parallelize(<span class="number">16</span>, <span class="built_in">len</span>(nodes), processNode)</div><div class="line">	<span class="keyword">for</span> i, priorityConfig := <span class="keyword">range</span> priorityConfigs &#123;</div><div class="line">		<span class="keyword">if</span> priorityConfig.Reduce == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		wg.Add(<span class="number">1</span>)</div><div class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(index <span class="keyword">int</span>, config algorithm.PriorityConfig)</span></span> &#123;</div><div class="line">			<span class="keyword">defer</span> wg.Done()</div><div class="line">			<span class="keyword">if</span> err := config.Reduce(pod, meta, nodeNameToInfo, results[index]); err != <span class="literal">nil</span> &#123;</div><div class="line">				appendError(err)</div><div class="line">			&#125;</div><div class="line">		&#125;(i, priorityConfig)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Wait for all computations to be finished.</span></div><div class="line">	wg.Wait()</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(errs) != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> schedulerapi.HostPriorityList&#123;&#125;, errors.NewAggregate(errs)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Summarize all scores.</span></div><div class="line">	result := <span class="built_in">make</span>(schedulerapi.HostPriorityList, <span class="number">0</span>, <span class="built_in">len</span>(nodes))</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Consider parallelizing it.</span></div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> nodes &#123;</div><div class="line">		result = <span class="built_in">append</span>(result, schedulerapi.HostPriority&#123;Host: nodes[i].Name, Score: <span class="number">0</span>&#125;)</div><div class="line">		<span class="keyword">for</span> j := <span class="keyword">range</span> priorityConfigs &#123;</div><div class="line">			result[i].Score += results[j][i].Score * priorityConfigs[j].Weight</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(extenders) != <span class="number">0</span> &amp;&amp; nodes != <span class="literal">nil</span> &#123;</div><div class="line">		combinedScores := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>, <span class="built_in">len</span>(nodeNameToInfo))</div><div class="line">		<span class="keyword">for</span> _, extender := <span class="keyword">range</span> extenders &#123;</div><div class="line">			wg.Add(<span class="number">1</span>)</div><div class="line">			<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(ext algorithm.SchedulerExtender)</span></span> &#123;</div><div class="line">				<span class="keyword">defer</span> wg.Done()</div><div class="line">				prioritizedList, weight, err := ext.Prioritize(pod, nodes)</div><div class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">					<span class="comment">// Prioritization errors from extender can be ignored, let k8s/other extenders determine the priorities</span></div><div class="line">					<span class="keyword">return</span></div><div class="line">				&#125;</div><div class="line">				mu.Lock()</div><div class="line">				<span class="keyword">for</span> i := <span class="keyword">range</span> *prioritizedList &#123;</div><div class="line">					host, score := (*prioritizedList)[i].Host, (*prioritizedList)[i].Score</div><div class="line">					combinedScores[host] += score * weight</div><div class="line">				&#125;</div><div class="line">				mu.Unlock()</div><div class="line">			&#125;(extender)</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// wait for all go routines to finish</span></div><div class="line">		wg.Wait()</div><div class="line">		<span class="keyword">for</span> i := <span class="keyword">range</span> result &#123;</div><div class="line">			result[i].Score += combinedScores[result[i].Host]</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> glog.V(<span class="number">10</span>) &#123;</div><div class="line">		<span class="keyword">for</span> i := <span class="keyword">range</span> result &#123;</div><div class="line">			glog.V(<span class="number">10</span>).Infof(<span class="string">"Host %s =&gt; Score %d"</span>, result[i].Host, result[i].Score)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> result, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>kube-scheduler的先使用PriorityFunction计算节点的分数，在向priorityFunctionMap注册PriorityFunction时，会指定该PriorityFunction对应的weight，然后再累加每个PriorityFunction和weight相乘的积，这就样就得到了这个节点的分数。</p>
<h4 id="selectHost"><a href="#selectHost" class="headerlink" title="selectHost()"></a>selectHost()</h4><p>最后来看下selectHost():<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// selectHost takes a prioritized list of nodes and then picks one</span></div><div class="line"><span class="comment">// in a round-robin manner from the nodes that had the highest score.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *genericScheduler)</span> <span class="title">selectHost</span><span class="params">(priorityList schedulerapi.HostPriorityList)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(priorityList) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"empty priorityList"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***对优先级进行排序***//</span></div><div class="line">	sort.Sort(sort.Reverse(priorityList))</div><div class="line">	<span class="comment">//***获取最高分***//</span></div><div class="line">	maxScore := priorityList[<span class="number">0</span>].Score</div><div class="line">	firstAfterMaxScore := sort.Search(<span class="built_in">len</span>(priorityList), <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> priorityList[i].Score &lt; maxScore &#125;)</div><div class="line"></div><div class="line">	g.lastNodeIndexLock.Lock()</div><div class="line">	ix := <span class="keyword">int</span>(g.lastNodeIndex % <span class="keyword">uint64</span>(firstAfterMaxScore))</div><div class="line">	g.lastNodeIndex++</div><div class="line">	g.lastNodeIndexLock.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">return</span> priorityList[ix].Host, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>selectHost()可以选出分数最高的节点，如果分数最高的节点有多个，则根据最高分节点的个数进行round-robin选择。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/10/04/kube-scheduler分析(二)-scheduler-v1-5-2/" data-id="cjazdcbqi004ehsqs31rxtj8t" class="article-share-link">分享</a><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></div><div class="post-nav"><a href="/2017/10/06/yaml格式转换分析-YAMLOrJSONDecoder/" class="pre">yaml格式转换分析-YAMLOrJSONDecoder</a><a href="/2017/10/03/kube-scheduler分析(一)-init过程-v1-5-2/" class="next">kube-scheduler分析(一)-init过程-v1.5.2</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/kubernetes-添加controller-demo-v1-5-2/">kubernetes-添加controller-demo-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/kubernetes-添加资源-demo-v1-5-2/">kubernetes-添加资源-demo-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/04/libnetwork源码分析(二)-network-v1-12-3/">libnetwork源码分析(二)-network-v1-12-3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/03/libnetwork源码分析(一)-controller(5)-v1-12-3/">libnetwork源码分析(一)-controller(5)-v1-12-3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/03/libnetwork源码分析(一)-controller(4)-v1-12-3/">libnetwork源码分析(一)-controller(4)-v1-12-3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/03/libnetwork源码分析(一)-controller(3)-v1-12-3/">libnetwork源码分析(一)-controller(3)-v1-12-3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/02/libnetwork源码分析(一)-controller(2)-v1-12-3/">libnetwork源码分析(一)-controller(2)-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/02/libnetwork源码分析(一)-controller(1)-v1-12-3/">libnetwork源码分析(一)-controller(1)-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/30/libnetwork基本概念-v1-12-3/">libnetwork基本概念-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/30/Docker容器网络初始化源码分析-v1-12-3/">Docker容器网络初始化源码分析-v1.12.3</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>