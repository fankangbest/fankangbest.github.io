<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>kubernetes-client分析(二)-restclient-v1.5.2 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">kubernetes-client分析(二)-restclient-v1.5.2</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">kubernetes-client分析(二)-restclient-v1.5.2</h1><div class="post-meta">Oct 13, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h2><p>Config中含有apiserver相关的信息，可以生成RESTClient，定义在/pkg/client/restclient/config.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***Config包含apiserver相关的信息***//</span></div><div class="line"><span class="comment">//***config:&amp;&#123;https://kubernetes:6443 /api  &#123;application/json application/json v1 0xc420109240&#125;     &lt;nil&gt; &lt;nil&gt; &#123;/etc/kubernetes/security/serverkey/server.crt /etc/kubernetes/security/serverkey/server.key /etc/kubernetes/security/serverkey/ca.crt [] [] []&#125; false kubectl/v1.5.2+08e0995 (linux/amd64) kubernetes/08e0995 &lt;nil&gt; &lt;nil&gt; 0 0 &lt;nil&gt; 0s&#125;***//</span></div><div class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// Host must be a host string, a host:port pair, or a URL to the base of the apiserver.</span></div><div class="line">	<span class="comment">// If a URL is given then the (optional) Path of that URL represents a prefix that must</span></div><div class="line">	<span class="comment">// be appended to all request URIs used to access the apiserver. This allows a frontend</span></div><div class="line">	<span class="comment">// proxy to easily relocate all of the apiserver endpoints.</span></div><div class="line">	Host <span class="keyword">string</span></div><div class="line">	<span class="comment">// APIPath is a sub-path that points to an API root.</span></div><div class="line">	APIPath <span class="keyword">string</span></div><div class="line">	<span class="comment">// Prefix is the sub path of the server. If not specified, the client will set</span></div><div class="line">	<span class="comment">// a default value.  Use "/" to indicate the server root should be used</span></div><div class="line">	Prefix <span class="keyword">string</span></div><div class="line"></div><div class="line">	<span class="comment">// ContentConfig contains settings that affect how objects are transformed when</span></div><div class="line">	<span class="comment">// sent to the server.</span></div><div class="line">	ContentConfig</div><div class="line"></div><div class="line">	<span class="comment">// Server requires Basic authentication</span></div><div class="line">	Username <span class="keyword">string</span></div><div class="line">	Password <span class="keyword">string</span></div><div class="line"></div><div class="line">	<span class="comment">// Server requires Bearer authentication. This client will not attempt to use</span></div><div class="line">	<span class="comment">// refresh tokens for an OAuth2 flow.</span></div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> demonstrate an OAuth2 compatible client.</span></div><div class="line">	BearerToken <span class="keyword">string</span></div><div class="line"></div><div class="line">	<span class="comment">// Impersonate is the username that this RESTClient will impersonate</span></div><div class="line">	Impersonate <span class="keyword">string</span></div><div class="line"></div><div class="line">	<span class="comment">// Server requires plugin-specified authentication.</span></div><div class="line">	AuthProvider *clientcmdapi.AuthProviderConfig</div><div class="line"></div><div class="line">	<span class="comment">// Callback to persist config for AuthProvider.</span></div><div class="line">	AuthConfigPersister AuthProviderConfigPersister</div><div class="line"></div><div class="line">	<span class="comment">// TLSClientConfig contains settings to enable transport layer security</span></div><div class="line">	TLSClientConfig</div><div class="line"></div><div class="line">	<span class="comment">// Server should be accessed without verifying the TLS</span></div><div class="line">	<span class="comment">// certificate. For testing only.</span></div><div class="line">	Insecure <span class="keyword">bool</span></div><div class="line"></div><div class="line">	<span class="comment">// UserAgent is an optional field that specifies the caller of this request.</span></div><div class="line">	UserAgent <span class="keyword">string</span></div><div class="line"></div><div class="line">	<span class="comment">// Transport may be used for custom HTTP behavior. This attribute may not</span></div><div class="line">	<span class="comment">// be specified with the TLS client certificate options. Use WrapTransport</span></div><div class="line">	<span class="comment">// for most client level operations.</span></div><div class="line">	Transport http.RoundTripper</div><div class="line">	<span class="comment">// WrapTransport will be invoked for custom HTTP behavior after the underlying</span></div><div class="line">	<span class="comment">// transport is initialized (either the transport created from TLSClientConfig,</span></div><div class="line">	<span class="comment">// Transport, or http.DefaultTransport). The config may layer other RoundTrippers</span></div><div class="line">	<span class="comment">// on top of the returned RoundTripper.</span></div><div class="line">	WrapTransport <span class="function"><span class="keyword">func</span><span class="params">(rt http.RoundTripper)</span> <span class="title">http</span>.<span class="title">RoundTripper</span></span></div><div class="line"></div><div class="line">	// <span class="title">QPS</span> <span class="title">indicates</span> <span class="title">the</span> <span class="title">maximum</span> <span class="title">QPS</span> <span class="title">to</span> <span class="title">the</span> <span class="title">master</span> <span class="title">from</span> <span class="title">this</span> <span class="title">client</span>.</div><div class="line">	// <span class="title">If</span> <span class="title">it</span>'<span class="title">s</span> <span class="title">zero</span>, <span class="title">the</span> <span class="title">created</span> <span class="title">RESTClient</span> <span class="title">will</span> <span class="title">use</span> <span class="title">DefaultQPS</span>: 5</div><div class="line">	<span class="title">QPS</span> <span class="title">float32</span></div><div class="line"></div><div class="line">	// <span class="title">Maximum</span> <span class="title">burst</span> <span class="title">for</span> <span class="title">throttle</span>.</div><div class="line">	// <span class="title">If</span> <span class="title">it</span>'<span class="title">s</span> <span class="title">zero</span>, <span class="title">the</span> <span class="title">created</span> <span class="title">RESTClient</span> <span class="title">will</span> <span class="title">use</span> <span class="title">DefaultBurst</span>: 10.</div><div class="line">	<span class="title">Burst</span> <span class="title">int</span></div><div class="line"></div><div class="line">	// <span class="title">Rate</span> <span class="title">limiter</span> <span class="title">for</span> <span class="title">limiting</span> <span class="title">connections</span> <span class="title">to</span> <span class="title">the</span> <span class="title">master</span> <span class="title">from</span> <span class="title">this</span> <span class="title">client</span>. <span class="title">If</span> <span class="title">present</span> <span class="title">overwrites</span> <span class="title">QPS</span>/<span class="title">Burst</span></div><div class="line">	<span class="title">RateLimiter</span> <span class="title">flowcontrol</span>.<span class="title">RateLimiter</span></div><div class="line"></div><div class="line">	// <span class="title">The</span> <span class="title">maximum</span> <span class="title">length</span> <span class="title">of</span> <span class="title">time</span> <span class="title">to</span> <span class="title">wait</span> <span class="title">before</span> <span class="title">giving</span> <span class="title">up</span> <span class="title">on</span> <span class="title">a</span> <span class="title">server</span> <span class="title">request</span>. <span class="title">A</span> <span class="title">value</span> <span class="title">of</span> <span class="title">zero</span> <span class="title">means</span> <span class="title">no</span> <span class="title">timeout</span>.</div><div class="line">	<span class="title">Timeout</span> <span class="title">time</span>.<span class="title">Duration</span></div><div class="line"></div><div class="line">	// <span class="title">Version</span> <span class="title">forces</span> <span class="title">a</span> <span class="title">specific</span> <span class="title">version</span> <span class="title">to</span> <span class="title">be</span> <span class="title">used</span> <span class="params">(<span class="keyword">if</span> registered)</span></div><div class="line">	// <span class="title">Do</span> <span class="title">we</span> <span class="title">need</span> <span class="title">this</span>?</div><div class="line">	// <span class="title">Version</span> <span class="title">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以通过调用RESTClientFor()或UnversionedRESTClientFor()来生成restClient，以RESTClientFor()为例：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从config生成RESTClient***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">RESTClientFor</span><span class="params">(config *Config)</span> <span class="params">(*RESTClient, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> config.GroupVersion == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"GroupVersion is required when initializing a RESTClient"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> config.NegotiatedSerializer == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"NegotiatedSerializer is required when initializing a RESTClient"</span>)</div><div class="line">	&#125;</div><div class="line">	qps := config.QPS</div><div class="line">	<span class="keyword">if</span> config.QPS == <span class="number">0.0</span> &#123;</div><div class="line">		qps = DefaultQPS</div><div class="line">	&#125;</div><div class="line">	burst := config.Burst</div><div class="line">	<span class="keyword">if</span> config.Burst == <span class="number">0</span> &#123;</div><div class="line">		burst = DefaultBurst</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***baseURL, versionedAPIPath:  https://kubernetes:6443 /api/v1***//</span></div><div class="line">	baseURL, versionedAPIPath, err := defaultServerUrlFor(config)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***https相关***//</span></div><div class="line">	transport, err := TransportFor(config)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> httpClient *http.Client</div><div class="line">	<span class="keyword">if</span> transport != http.DefaultTransport &#123;</div><div class="line">		<span class="comment">//***生成http client***//</span></div><div class="line">		httpClient = &amp;http.Client&#123;Transport: transport&#125;</div><div class="line">		<span class="keyword">if</span> config.Timeout &gt; <span class="number">0</span> &#123;</div><div class="line">			httpClient.Timeout = config.Timeout</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***生成RESTClient***//</span></div><div class="line">	<span class="keyword">return</span> NewRESTClient(baseURL, versionedAPIPath, config.ContentConfig, qps, burst, config.RateLimiter, httpClient)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在RESTClientFor()中，会使用<code>httpClient = &amp;http.Client{Transport: transport}</code>生成httpClient，这以后会在Go语言http包分析中会介绍。RestClientFor()最后调用的是NewRESTClient()生成RESTClient。</p>
<h2 id="RestClient"><a href="#RestClient" class="headerlink" title="RestClient"></a>RestClient</h2><p>RESTClient可以生成Request，定义在/pkg/client/restclient/client.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> RESTClient <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// base is the root URL for all invocations of the client</span></div><div class="line">	<span class="comment">//***base: &#123;https  &lt;nil&gt; kubernetes:6443 /  false  &#125;***//</span></div><div class="line">	base *url.URL</div><div class="line">	<span class="comment">// versionedAPIPath is a path segment connecting the base URL to the resource root</span></div><div class="line">	<span class="comment">//***versionedAPIPath: /api/v1***//</span></div><div class="line">	versionedAPIPath <span class="keyword">string</span></div><div class="line"></div><div class="line">	<span class="comment">// contentConfig is the information used to communicate with the server.</span></div><div class="line">	contentConfig ContentConfig</div><div class="line"></div><div class="line">	<span class="comment">// serializers contain all serializers for underlying content type.</span></div><div class="line">	serializers Serializers</div><div class="line"></div><div class="line">	<span class="comment">// creates BackoffManager that is passed to requests.</span></div><div class="line">	createBackoffMgr <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">BackoffManager</span></span></div><div class="line"></div><div class="line">	// <span class="title">TODO</span> <span class="title">extract</span> <span class="title">this</span> <span class="title">into</span> <span class="title">a</span> <span class="title">wrapper</span> <span class="title">interface</span> <span class="title">via</span> <span class="title">the</span> <span class="title">RESTClient</span> <span class="title">interface</span> <span class="title">in</span> <span class="title">kubectl</span>.</div><div class="line">	<span class="title">Throttle</span> <span class="title">flowcontrol</span>.<span class="title">RateLimiter</span></div><div class="line"></div><div class="line">	// <span class="title">Set</span> <span class="title">specific</span> <span class="title">behavior</span> <span class="title">of</span> <span class="title">the</span> <span class="title">client</span>.  <span class="title">If</span> <span class="title">not</span> <span class="title">set</span> <span class="title">http</span>.<span class="title">DefaultClient</span> <span class="title">will</span> <span class="title">be</span> <span class="title">used</span>.</div><div class="line">	<span class="title">Client</span> *<span class="title">http</span>.<span class="title">Client</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>NewRESTClient()定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***生成client***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRESTClient</span><span class="params">(baseURL *url.URL, versionedAPIPath <span class="keyword">string</span>, config ContentConfig, maxQPS <span class="keyword">float32</span>, maxBurst <span class="keyword">int</span>, rateLimiter flowcontrol.RateLimiter, client *http.Client)</span> <span class="params">(*RESTClient, error)</span></span> &#123;</div><div class="line">	base := *baseURL</div><div class="line">	<span class="comment">//***确保以"/"结尾***//</span></div><div class="line">	<span class="keyword">if</span> !strings.HasSuffix(base.Path, <span class="string">"/"</span>) &#123;</div><div class="line">		base.Path += <span class="string">"/"</span></div><div class="line">	&#125;</div><div class="line">	base.RawQuery = <span class="string">""</span></div><div class="line">	base.Fragment = <span class="string">""</span></div><div class="line"></div><div class="line">	<span class="keyword">if</span> config.GroupVersion == <span class="literal">nil</span> &#123;</div><div class="line">		config.GroupVersion = &amp;unversioned.GroupVersion&#123;&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(config.ContentType) == <span class="number">0</span> &#123;</div><div class="line">		config.ContentType = <span class="string">"application/json"</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***序列化器***//</span></div><div class="line">	serializers, err := createSerializers(config)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> throttle flowcontrol.RateLimiter</div><div class="line">	<span class="keyword">if</span> maxQPS &gt; <span class="number">0</span> &amp;&amp; rateLimiter == <span class="literal">nil</span> &#123;</div><div class="line">		throttle = flowcontrol.NewTokenBucketRateLimiter(maxQPS, maxBurst)</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> rateLimiter != <span class="literal">nil</span> &#123;</div><div class="line">		throttle = rateLimiter</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***base, versionedAPIPath:  &#123;https  &lt;nil&gt; kubernetes:6443 /  false  &#125; /api/v1***//</span></div><div class="line">	<span class="keyword">return</span> &amp;RESTClient&#123;</div><div class="line">		base:             &amp;base,</div><div class="line">		versionedAPIPath: versionedAPIPath,</div><div class="line">		contentConfig:    config,</div><div class="line">		serializers:      *serializers,</div><div class="line">		createBackoffMgr: readExpBackoffConfig,</div><div class="line">		Throttle:         throttle,</div><div class="line">		Client:           client,</div><div class="line">	&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>RESTClient可以通过Post(), Put(), Patch(), Get(), Delete()设置请求的动作：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Post begins a POST request. Short for c.Verb("POST").</span></div><div class="line"><span class="comment">//***设置请求动作为POST***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *RESTClient)</span> <span class="title">Post</span><span class="params">()</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> c.Verb(<span class="string">"POST"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Put begins a PUT request. Short for c.Verb("PUT").</span></div><div class="line"><span class="comment">//***设置请求动作为PUT***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *RESTClient)</span> <span class="title">Put</span><span class="params">()</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> c.Verb(<span class="string">"PUT"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Patch begins a PATCH request. Short for c.Verb("Patch").</span></div><div class="line"><span class="comment">//***设置请求动作为PATCH***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *RESTClient)</span> <span class="title">Patch</span><span class="params">(pt api.PatchType)</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> c.Verb(<span class="string">"PATCH"</span>).SetHeader(<span class="string">"Content-Type"</span>, <span class="keyword">string</span>(pt))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Get begins a GET request. Short for c.Verb("GET").</span></div><div class="line"><span class="comment">//***设置请求动作为GET***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *RESTClient)</span> <span class="title">Get</span><span class="params">()</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> c.Verb(<span class="string">"GET"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Delete begins a DELETE request. Short for c.Verb("DELETE").</span></div><div class="line"><span class="comment">//***设置请求动作为DELETE***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *RESTClient)</span> <span class="title">Delete</span><span class="params">()</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> c.Verb(<span class="string">"DELETE"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这些方法都调用了Verb()方法：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置请求中的动作***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *RESTClient)</span> <span class="title">Verb</span><span class="params">(verb <span class="keyword">string</span>)</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	backoff := c.createBackoffMgr()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> c.Client == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> NewRequest(<span class="literal">nil</span>, verb, c.base, c.versionedAPIPath, c.contentConfig, c.serializers, backoff, c.Throttle)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> NewRequest(c.Client, verb, c.base, c.versionedAPIPath, c.contentConfig, c.serializers, backoff, c.Throttle)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在Verb()中，会调用NewRequest()函数生成Request。</p>
<h2 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h2><p>Request可以执行一个具体的请求。Request定义在/pkg/client/restclient/request.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// required</span></div><div class="line">	client HTTPClient</div><div class="line">	verb   <span class="keyword">string</span></div><div class="line"></div><div class="line">	baseURL     *url.URL</div><div class="line">	content     ContentConfig</div><div class="line">	serializers Serializers</div><div class="line"></div><div class="line">	<span class="comment">// generic components accessible via method setters</span></div><div class="line">	pathPrefix <span class="keyword">string</span></div><div class="line">	subpath    <span class="keyword">string</span></div><div class="line">	params     url.Values</div><div class="line">	headers    http.Header</div><div class="line"></div><div class="line">	<span class="comment">// structural elements of the request that are part of the Kubernetes API conventions</span></div><div class="line">	namespace    <span class="keyword">string</span></div><div class="line">	namespaceSet <span class="keyword">bool</span></div><div class="line">	resource     <span class="keyword">string</span></div><div class="line">	resourceName <span class="keyword">string</span></div><div class="line">	subresource  <span class="keyword">string</span></div><div class="line">	selector     labels.Selector</div><div class="line">	timeout      time.Duration</div><div class="line"></div><div class="line">	<span class="comment">// output</span></div><div class="line">	err  error</div><div class="line">	body io.Reader</div><div class="line"></div><div class="line">	<span class="comment">// The constructed request and the response</span></div><div class="line">	req  *http.Request</div><div class="line">	resp *http.Response</div><div class="line"></div><div class="line">	backoffMgr BackoffManager</div><div class="line">	throttle   flowcontrol.RateLimiter</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Request可以通过NewRequest()生成：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***创建Request***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRequest</span><span class="params">(client HTTPClient, verb <span class="keyword">string</span>, baseURL *url.URL, versionedAPIPath <span class="keyword">string</span>, content ContentConfig, serializers Serializers, backoff BackoffManager, throttle flowcontrol.RateLimiter)</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> backoff == <span class="literal">nil</span> &#123;</div><div class="line">		glog.V(<span class="number">2</span>).Infof(<span class="string">"Not implementing request backoff strategy."</span>)</div><div class="line">		backoff = &amp;NoBackoff&#123;&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	pathPrefix := <span class="string">"/"</span></div><div class="line">	<span class="keyword">if</span> baseURL != <span class="literal">nil</span> &#123;</div><div class="line">		pathPrefix = path.Join(pathPrefix, baseURL.Path)</div><div class="line">	&#125;</div><div class="line">	r := &amp;Request&#123;</div><div class="line">		client:      client,</div><div class="line">		verb:        verb,</div><div class="line">		baseURL:     baseURL,</div><div class="line">		pathPrefix:  path.Join(pathPrefix, versionedAPIPath),</div><div class="line">		content:     content,</div><div class="line">		serializers: serializers,</div><div class="line">		backoffMgr:  backoff,</div><div class="line">		throttle:    throttle,</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">switch</span> &#123;</div><div class="line">	<span class="keyword">case</span> <span class="built_in">len</span>(content.AcceptContentTypes) &gt; <span class="number">0</span>:</div><div class="line">		r.SetHeader(<span class="string">"Accept"</span>, content.AcceptContentTypes)</div><div class="line">	<span class="keyword">case</span> <span class="built_in">len</span>(content.ContentType) &gt; <span class="number">0</span>:</div><div class="line">		r.SetHeader(<span class="string">"Accept"</span>, content.ContentType+<span class="string">", */*"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Request的方法可以分成三类：</p>
<ul>
<li>设置Request结构体字段的方法；</li>
<li>生成URL的方法；</li>
<li>执行请求的方法。</li>
</ul>
<p>先来介绍设置字段的方法。</p>
<h4 id="Prefix"><a href="#Prefix" class="headerlink" title="Prefix()"></a>Prefix()</h4><p>Prefix()可以在原始pathPrefix后增加内容。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置pathPrefix***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">Prefix</span><span class="params">(segments ...<span class="keyword">string</span>)</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	r.pathPrefix = path.Join(r.pathPrefix, path.Join(segments...))</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Suffix"><a href="#Suffix" class="headerlink" title="Suffix()"></a>Suffix()</h4><p>Suffix()可以在原始subpath后增加内容。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置subpath***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">Suffix</span><span class="params">(segments ...<span class="keyword">string</span>)</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	r.subpath = path.Join(r.subpath, path.Join(segments...))</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Resource"><a href="#Resource" class="headerlink" title="Resource()"></a>Resource()</h4><p>设置resource字段。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置resource***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">Resource</span><span class="params">(resource <span class="keyword">string</span>)</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(r.resource) != <span class="number">0</span> &#123;</div><div class="line">		r.err = fmt.Errorf(<span class="string">"resource already set to %q, cannot change to %q"</span>, r.resource, resource)</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> msgs := pathvalidation.IsValidPathSegmentName(resource); <span class="built_in">len</span>(msgs) != <span class="number">0</span> &#123;</div><div class="line">		r.err = fmt.Errorf(<span class="string">"invalid resource %q: %v"</span>, resource, msgs)</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	r.resource = resource</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="SubResource"><a href="#SubResource" class="headerlink" title="SubResource()"></a>SubResource()</h4><p>设置subresource字段，subresource，如”/api/v1/namespaces/{namespace}/resourcequotas/{name}/status”，status就是subresource。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置subresource***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">SubResource</span><span class="params">(subresources ...<span class="keyword">string</span>)</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	subresource := path.Join(subresources...)</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(r.subresource) != <span class="number">0</span> &#123;</div><div class="line">		r.err = fmt.Errorf(<span class="string">"subresource already set to %q, cannot change to %q"</span>, r.resource, subresource)</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> _, s := <span class="keyword">range</span> subresources &#123;</div><div class="line">		<span class="keyword">if</span> msgs := pathvalidation.IsValidPathSegmentName(s); <span class="built_in">len</span>(msgs) != <span class="number">0</span> &#123;</div><div class="line">			r.err = fmt.Errorf(<span class="string">"invalid subresource %q: %v"</span>, s, msgs)</div><div class="line">			<span class="keyword">return</span> r</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	r.subresource = subresource</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Name"><a href="#Name" class="headerlink" title="Name()"></a>Name()</h4><p>设置resourceName字段。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Name sets the name of a resource to access (&lt;resource&gt;/[ns/&lt;namespace&gt;/]&lt;name&gt;)</span></div><div class="line"><span class="comment">//***设置resourceName***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">Name</span><span class="params">(resourceName <span class="keyword">string</span>)</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(resourceName) == <span class="number">0</span> &#123;</div><div class="line">		r.err = fmt.Errorf(<span class="string">"resource name may not be empty"</span>)</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(r.resourceName) != <span class="number">0</span> &#123;</div><div class="line">		r.err = fmt.Errorf(<span class="string">"resource name already set to %q, cannot change to %q"</span>, r.resourceName, resourceName)</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> msgs := pathvalidation.IsValidPathSegmentName(resourceName); <span class="built_in">len</span>(msgs) != <span class="number">0</span> &#123;</div><div class="line">		r.err = fmt.Errorf(<span class="string">"invalid resource name %q: %v"</span>, resourceName, msgs)</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	r.resourceName = resourceName</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace()"></a>Namespace()</h4><p>设置namespaceSet和namespace字段。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Namespace applies the namespace scope to a request (&lt;resource&gt;/[ns/&lt;namespace&gt;/]&lt;name&gt;)</span></div><div class="line"><span class="comment">//***设置namespace***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">Namespace</span><span class="params">(namespace <span class="keyword">string</span>)</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> r.namespaceSet &#123;</div><div class="line">		r.err = fmt.Errorf(<span class="string">"namespace already set to %q, cannot change to %q"</span>, r.namespace, namespace)</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> msgs := pathvalidation.IsValidPathSegmentName(namespace); <span class="built_in">len</span>(msgs) != <span class="number">0</span> &#123;</div><div class="line">		r.err = fmt.Errorf(<span class="string">"invalid namespace %q: %v"</span>, namespace, msgs)</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	r.namespaceSet = <span class="literal">true</span></div><div class="line">	r.namespace = namespace</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="FieldsSelectorParam"><a href="#FieldsSelectorParam" class="headerlink" title="FieldsSelectorParam()"></a>FieldsSelectorParam()</h4><p>处理fields selector。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// FieldsSelectorParam adds the given selector as a query parameter with the name paramName.</span></div><div class="line"><span class="comment">//***处理fileds selector***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">FieldsSelectorParam</span><span class="params">(s fields.Selector)</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> s == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> s.Empty() &#123;</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	s2, err := s.Transform(<span class="function"><span class="keyword">func</span><span class="params">(field, value <span class="keyword">string</span>)</span> <span class="params">(newField, newValue <span class="keyword">string</span>, err error)</span></span> &#123;</div><div class="line">		<span class="keyword">return</span> fieldMappings.filterField(r.content.GroupVersion, r.resource, field, value)</div><div class="line">	&#125;)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		r.err = err</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r.setParam(unversioned.FieldSelectorQueryParam(r.content.GroupVersion.String()), s2.String())</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="LabelsSelectorParam"><a href="#LabelsSelectorParam" class="headerlink" title="LabelsSelectorParam()"></a>LabelsSelectorParam()</h4><p>处理label selector。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// LabelsSelectorParam adds the given selector as a query parameter</span></div><div class="line"><span class="comment">//***处理label selector***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">LabelsSelectorParam</span><span class="params">(s labels.Selector)</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> s == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> s.Empty() &#123;</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r.setParam(unversioned.LabelSelectorQueryParam(r.content.GroupVersion.String()), s.String())</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="setParam"><a href="#setParam" class="headerlink" title="setParam()"></a>setParam()</h4><p>设置params字段。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置URL参数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">setParam</span><span class="params">(paramName, value <span class="keyword">string</span>)</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> specialParams.Has(paramName) &#123;</div><div class="line">		r.err = fmt.Errorf(<span class="string">"must set %v through the corresponding function, not directly."</span>, paramName)</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> r.params == <span class="literal">nil</span> &#123;</div><div class="line">		r.params = <span class="built_in">make</span>(url.Values)</div><div class="line">	&#125;</div><div class="line">	r.params[paramName] = <span class="built_in">append</span>(r.params[paramName], value)</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="SetHeader"><a href="#SetHeader" class="headerlink" title="SetHeader()"></a>SetHeader()</h4><p>设置headers字段。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置头文件***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">SetHeader</span><span class="params">(key, value <span class="keyword">string</span>)</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.headers == <span class="literal">nil</span> &#123;</div><div class="line">		r.headers = http.Header&#123;&#125;</div><div class="line">	&#125;</div><div class="line">	r.headers.Set(key, value)</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Timeout"><a href="#Timeout" class="headerlink" title="Timeout()"></a>Timeout()</h4><p>设置timeout字段。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Timeout makes the request use the given duration as a timeout. Sets the "timeout"</span></div><div class="line"><span class="comment">// parameter.</span></div><div class="line"><span class="comment">//***设置超时时间***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">Timeout</span><span class="params">(d time.Duration)</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	r.timeout = d</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Body"><a href="#Body" class="headerlink" title="Body()"></a>Body()</h4><p>设置body字段。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置body***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">Body</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">Request</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">switch</span> t := obj.(<span class="keyword">type</span>) &#123;</div><div class="line">	<span class="keyword">case</span> <span class="keyword">string</span>:</div><div class="line">		data, err := ioutil.ReadFile(t)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			r.err = err</div><div class="line">			<span class="keyword">return</span> r</div><div class="line">		&#125;</div><div class="line">		glog.V(<span class="number">8</span>).Infof(<span class="string">"Request Body: %#v"</span>, <span class="keyword">string</span>(data))</div><div class="line">		r.body = bytes.NewReader(data)</div><div class="line">	<span class="keyword">case</span> []<span class="keyword">byte</span>:</div><div class="line">		glog.V(<span class="number">8</span>).Infof(<span class="string">"Request Body: %#v"</span>, <span class="keyword">string</span>(t))</div><div class="line">		r.body = bytes.NewReader(t)</div><div class="line">	<span class="keyword">case</span> io.Reader:</div><div class="line">		r.body = t</div><div class="line">	<span class="keyword">case</span> runtime.Object:</div><div class="line">		<span class="comment">// callers may pass typed interface pointers, therefore we must check nil with reflection</span></div><div class="line">		<span class="keyword">if</span> reflect.ValueOf(t).IsNil() &#123;</div><div class="line">			<span class="keyword">return</span> r</div><div class="line">		&#125;</div><div class="line">		data, err := runtime.Encode(r.serializers.Encoder, t)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			r.err = err</div><div class="line">			<span class="keyword">return</span> r</div><div class="line">		&#125;</div><div class="line">		glog.V(<span class="number">8</span>).Infof(<span class="string">"Request Body: %#v"</span>, <span class="keyword">string</span>(data))</div><div class="line">		r.body = bytes.NewReader(data)</div><div class="line">		r.SetHeader(<span class="string">"Content-Type"</span>, r.content.ContentType)</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		r.err = fmt.Errorf(<span class="string">"unknown type used for body: %+v"</span>, obj)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再来看如何根据这些参数组装URL。</p>
<h4 id="URL"><a href="#URL" class="headerlink" title="URL()"></a>URL()</h4><p>URL()根据参数返回URL，URL的格式为：/namespaces/namespace/resource/resourceName/subresource/subpath。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// URL returns the current working URL.</span></div><div class="line"><span class="comment">//***Fankang***//</span></div><div class="line"><span class="comment">//***生成URL***//</span></div><div class="line"><span class="comment">//***/namespaces/namespace/resource/resourceName/subresource/subpath***//</span></div><div class="line"><span class="comment">//***subresource: /api/v1/namespaces/&#123;namespace&#125;/pods/&#123;name&#125;/log***//</span></div><div class="line"><span class="comment">//***subpath: /healthz这种***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">URL</span><span class="params">()</span> *<span class="title">url</span>.<span class="title">URL</span></span> &#123;</div><div class="line">	p := r.pathPrefix</div><div class="line">	<span class="keyword">if</span> r.namespaceSet &amp;&amp; <span class="built_in">len</span>(r.namespace) &gt; <span class="number">0</span> &#123;</div><div class="line">		p = path.Join(p, <span class="string">"namespaces"</span>, r.namespace)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(r.resource) != <span class="number">0</span> &#123;</div><div class="line">		p = path.Join(p, strings.ToLower(r.resource))</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Join trims trailing slashes, so preserve r.pathPrefix's trailing slash for backwards compatibility if nothing was changed</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(r.resourceName) != <span class="number">0</span> || <span class="built_in">len</span>(r.subpath) != <span class="number">0</span> || <span class="built_in">len</span>(r.subresource) != <span class="number">0</span> &#123;</div><div class="line">		p = path.Join(p, r.resourceName, r.subresource, r.subpath)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	finalURL := &amp;url.URL&#123;&#125;</div><div class="line">	<span class="keyword">if</span> r.baseURL != <span class="literal">nil</span> &#123;</div><div class="line">		*finalURL = *r.baseURL</div><div class="line">	&#125;</div><div class="line">	finalURL.Path = p</div><div class="line"></div><div class="line">	query := url.Values&#123;&#125;</div><div class="line">	<span class="keyword">for</span> key, values := <span class="keyword">range</span> r.params &#123;</div><div class="line">		<span class="keyword">for</span> _, value := <span class="keyword">range</span> values &#123;</div><div class="line">			query.Add(key, value)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// timeout is handled specially here.</span></div><div class="line">	<span class="keyword">if</span> r.timeout != <span class="number">0</span> &#123;</div><div class="line">		query.Set(<span class="string">"timeout"</span>, r.timeout.String())</div><div class="line">	&#125;</div><div class="line">	finalURL.RawQuery = query.Encode()</div><div class="line">	<span class="keyword">return</span> finalURL</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再来看Request如何完成请求。</p>
<h4 id="Do"><a href="#Do" class="headerlink" title="Do()"></a>Do()</h4><p>Do()为Request执行请求的入口。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***执行请求***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">Do</span><span class="params">()</span> <span class="title">Result</span></span> &#123;</div><div class="line">	r.tryThrottle()</div><div class="line"></div><div class="line">	<span class="keyword">var</span> result Result</div><div class="line">	err := r.request(<span class="function"><span class="keyword">func</span><span class="params">(req *http.Request, resp *http.Response)</span></span> &#123;</div><div class="line">		result = r.transformResponse(resp, req)</div><div class="line">	&#125;)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> Result&#123;err: err&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> result</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Do()通过调用request()方法执行请求。</p>
<h4 id="request"><a href="#request" class="headerlink" title="request()"></a>request()</h4><p>request()调用了Go语言http包执行请求，在请求执行完后，调用resp.Body.Close()关闭连接。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***真正执行请求的函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">request</span><span class="params">(fn <span class="keyword">func</span>(*http.Request, *http.Response)</span>) <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//Metrics for total request latency</span></div><div class="line">	start := time.Now()</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		metrics.RequestLatency.Observe(r.verb, r.finalURLTemplate(), time.Since(start))</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.V(<span class="number">4</span>).Infof(<span class="string">"Error in request: %v"</span>, r.err)</div><div class="line">		<span class="keyword">return</span> r.err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> added to catch programmer errors (invoking operations with an object with an empty namespace)</span></div><div class="line">	<span class="keyword">if</span> (r.verb == <span class="string">"GET"</span> || r.verb == <span class="string">"PUT"</span> || r.verb == <span class="string">"DELETE"</span>) &amp;&amp; r.namespaceSet &amp;&amp; <span class="built_in">len</span>(r.resourceName) &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(r.namespace) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"an empty namespace may not be set when a resource name is provided"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (r.verb == <span class="string">"POST"</span>) &amp;&amp; r.namespaceSet &amp;&amp; <span class="built_in">len</span>(r.namespace) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"an empty namespace may not be set during creation"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	client := r.client</div><div class="line">	<span class="keyword">if</span> client == <span class="literal">nil</span> &#123;</div><div class="line">		client = http.DefaultClient</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Right now we make about ten retry attempts if we get a Retry-After response.</span></div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Change to a timeout based approach.</span></div><div class="line">	maxRetries := <span class="number">10</span></div><div class="line">	retries := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="comment">//***Fankang***//</span></div><div class="line">		<span class="comment">//***组装url***//</span></div><div class="line">		url := r.URL().String()</div><div class="line">		<span class="comment">//***Fankang***//</span></div><div class="line">		<span class="comment">//***构造request***//</span></div><div class="line">		req, err := http.NewRequest(r.verb, url, r.body)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		req.Header = r.headers</div><div class="line"></div><div class="line">		r.backoffMgr.Sleep(r.backoffMgr.CalculateBackoff(r.URL()))</div><div class="line">		<span class="keyword">if</span> retries &gt; <span class="number">0</span> &#123;</div><div class="line">			<span class="comment">// We are retrying the request that we already send to apiserver</span></div><div class="line">			<span class="comment">// at least once before.</span></div><div class="line">			<span class="comment">// This request should also be throttled with the client-internal throttler.</span></div><div class="line">			r.tryThrottle()</div><div class="line">		&#125;</div><div class="line">		resp, err := client.Do(req)</div><div class="line">		updateURLMetrics(r, resp, err)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			r.backoffMgr.UpdateBackoff(r.URL(), err, <span class="number">0</span>)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			r.backoffMgr.UpdateBackoff(r.URL(), err, resp.StatusCode)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		done := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</div><div class="line">			<span class="comment">// Ensure the response body is fully read and closed</span></div><div class="line">			<span class="comment">// before we reconnect, so that we reuse the same TCP</span></div><div class="line">			<span class="comment">// connection.</span></div><div class="line">			<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">				<span class="keyword">const</span> maxBodySlurpSize = <span class="number">2</span> &lt;&lt; <span class="number">10</span></div><div class="line">				<span class="keyword">if</span> resp.ContentLength &lt;= maxBodySlurpSize &#123;</div><div class="line">					io.Copy(ioutil.Discard, &amp;io.LimitedReader&#123;R: resp.Body, N: maxBodySlurpSize&#125;)</div><div class="line">				&#125;</div><div class="line">				resp.Body.Close()</div><div class="line">			&#125;()</div><div class="line"></div><div class="line">			retries++</div><div class="line">			<span class="keyword">if</span> seconds, wait := checkWait(resp); wait &amp;&amp; retries &lt; maxRetries &#123;</div><div class="line">				<span class="keyword">if</span> seeker, ok := r.body.(io.Seeker); ok &amp;&amp; r.body != <span class="literal">nil</span> &#123;</div><div class="line">					_, err := seeker.Seek(<span class="number">0</span>, <span class="number">0</span>)</div><div class="line">					<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">						glog.V(<span class="number">4</span>).Infof(<span class="string">"Could not retry request, can't Seek() back to beginning of body for %T"</span>, r.body)</div><div class="line">						fn(req, resp)</div><div class="line">						<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				glog.V(<span class="number">4</span>).Infof(<span class="string">"Got a Retry-After %s response for attempt %d to %v"</span>, seconds, retries, url)</div><div class="line">				r.backoffMgr.Sleep(time.Duration(seconds) * time.Second)</div><div class="line">				<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">			&#125;</div><div class="line">			fn(req, resp)</div><div class="line">			<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">		&#125;()</div><div class="line">		<span class="keyword">if</span> done &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Watch"><a href="#Watch" class="headerlink" title="Watch()"></a>Watch()</h4><p>Watch入口。Watch()不会主要关闭连接。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Watch attempts to begin watching the requested location.</span></div><div class="line"><span class="comment">// Returns a watch.Interface, or an error.</span></div><div class="line"><span class="comment">//***Watch实现***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">Watch</span><span class="params">()</span> <span class="params">(watch.Interface, error)</span></span> &#123;</div><div class="line">	<span class="comment">// We specifically don't want to rate limit watches, so we</span></div><div class="line">	<span class="comment">// don't use r.throttle here.</span></div><div class="line">	<span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, r.err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> r.serializers.Framer == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"watching resources is not possible with this client (content-type: %s)"</span>, r.content.ContentType)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	url := r.URL().String()</div><div class="line">	req, err := http.NewRequest(r.verb, url, r.body)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	req.Header = r.headers</div><div class="line">	client := r.client</div><div class="line">	<span class="keyword">if</span> client == <span class="literal">nil</span> &#123;</div><div class="line">		client = http.DefaultClient</div><div class="line">	&#125;</div><div class="line">	r.backoffMgr.Sleep(r.backoffMgr.CalculateBackoff(r.URL()))</div><div class="line">	resp, err := client.Do(req)</div><div class="line">	updateURLMetrics(r, resp, err)</div><div class="line">	<span class="keyword">if</span> r.baseURL != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			r.backoffMgr.UpdateBackoff(r.baseURL, err, <span class="number">0</span>)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			r.backoffMgr.UpdateBackoff(r.baseURL, err, resp.StatusCode)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// The watch stream mechanism handles many common partial data errors, so closed</span></div><div class="line">		<span class="comment">// connections can be retried in many cases.</span></div><div class="line">		<span class="keyword">if</span> net.IsProbableEOF(err) &#123;</div><div class="line">			<span class="keyword">return</span> watch.NewEmptyWatch(), <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> resp.StatusCode != http.StatusOK &#123;</div><div class="line">		<span class="keyword">defer</span> resp.Body.Close()</div><div class="line">		<span class="keyword">if</span> result := r.transformResponse(resp, req); result.err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, result.err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"for request '%+v', got status: %v"</span>, url, resp.StatusCode)</div><div class="line">	&#125;</div><div class="line">	framer := r.serializers.Framer.NewFrameReader(resp.Body)</div><div class="line">	decoder := streaming.NewDecoder(framer, r.serializers.StreamingSerializer)</div><div class="line">	<span class="comment">//***返回的是StreamWatcher***//</span></div><div class="line">	<span class="keyword">return</span> watch.NewStreamWatcher(versioned.NewDecoder(decoder, r.serializers.Decoder)), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>关于Watch()，将专门进行讨论。</p>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>http包的简单例子：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">httpDo</span><span class="params">()</span></span> &#123;</div><div class="line">    client := &amp;http.Client&#123;&#125;</div><div class="line"> </div><div class="line">    req, err := http.NewRequest(<span class="string">"POST"</span>, <span class="string">"http://www.baidu.com"</span>, strings.NewReader(<span class="string">"name=cjb"</span>))</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="comment">// handle error</span></div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    req.Header.Set(<span class="string">"Content-Type"</span>, <span class="string">"application/x-www-form-urlencoded"</span>)</div><div class="line">    req.Header.Set(<span class="string">"Cookie"</span>, <span class="string">"name=anny"</span>)</div><div class="line"> </div><div class="line">    resp, err := client.Do(req)</div><div class="line"> </div><div class="line">    <span class="keyword">defer</span> resp.Body.Close()</div><div class="line"> </div><div class="line">    body, err := ioutil.ReadAll(resp.Body)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="comment">// handle error</span></div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    fmt.Println(<span class="keyword">string</span>(body))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，在打开了连接后，需要通过resp.Body.Close()进行关闭。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/10/13/kubernetes-client分析(二)-restclient-v1-5-2/" data-id="cjab2q6wo004ge4qscf791pwi" class="article-share-link">分享</a><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></div><div class="post-nav"><a href="/2017/10/16/kubernetes-client分析(三)-dynamicClient-v1-5-2/" class="pre">kubernetes-client分析(三)-dynamicClient-v1.5.2</a><a href="/2017/10/12/kubernetes-client分析(一)-kubeconfig-v1-5-2/" class="next">kubernetes-client分析(一)-kubeconfig-v1.5.2</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/22/runc源码分析(一)-create和start流程-v1-0-0-rc2/">runc源码分析(一)-create和start流程-v1.0.0-rc2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/19/containerd-shim源码分析-v0-2-4/">containerd-shim源码分析-v0.2.4</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/19/containerd-container和process-v0-2-4/">containerd-container和process-v0.2.4</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/16/containerd执行流程分析-v0-2-4/">containerd执行流程分析-v0.2.4</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/13/containerd-crt命令行使用-v0-2-4/">containerd-crt命令行使用-v0.2.4</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/11/gRPC-demo/">gRPC-demo</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/31/kubernetes-controller分析(四)-garbagecollector-v1-5-2/">kubernetes-controller分析(四)-garbagecollector-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/30/Docker镜像存储代码分析-layerStore-v1-12-3/">Docker镜像存储代码分析-layerStore-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/29/Docker镜像存储代码分析-referenceStore-v1-12-3/">Docker镜像存储代码分析-referenceStore-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/29/Docker镜像存储代码分析-imageStore-v1-12-3/">Docker镜像存储代码分析-imageStore-v1.12.3</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>