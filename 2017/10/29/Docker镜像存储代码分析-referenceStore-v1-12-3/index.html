<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Docker镜像存储代码分析-referenceStore-v1.12.3 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Docker镜像存储代码分析-referenceStore-v1.12.3</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Docker镜像存储代码分析-referenceStore-v1.12.3</h1><div class="post-meta">Oct 29, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>referenceStore用来管理镜像名称和id之前的关系，主要和/var/lib/docker/image/aufs/repositories.json打交道。本次分析将介绍关于referenceStore的代码。</p>
<h2 id="referenceStore"><a href="#referenceStore" class="headerlink" title="referenceStore"></a>referenceStore</h2><p>来看下referenceStore(即store)的定义，在/reference/store.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> store <span class="keyword">struct</span> &#123;</div><div class="line">	mu sync.RWMutex</div><div class="line">	<span class="comment">// jsonPath is the path to the file where the serialized tag data is</span></div><div class="line">	<span class="comment">// stored.</span></div><div class="line">	jsonPath <span class="keyword">string</span></div><div class="line">	<span class="comment">// Repositories is a map of repositories, indexed by name.</span></div><div class="line">	<span class="comment">//***map[dirage:map[dirage:v1:sha256:987fbbdd3e5ded64e38b15f3ee32ed5e59982313dc5331249cb47c07866b9746] etcd-cluster:map[etcd-cluster:v1:sha256:cf6ce5c776de4d51725077009fc473576ae04befed4c73bb049ae2e9376e20df]***//</span></div><div class="line">	Repositories <span class="keyword">map</span>[<span class="keyword">string</span>]repository</div><div class="line">	<span class="comment">// referencesByIDCache is a cache of references indexed by ID, to speed</span></div><div class="line">	<span class="comment">// up References.</span></div><div class="line">	<span class="comment">//***sha256:002883be70c0fb86ee87a97ac9066091adabe370efb9d9bfeb858fb3d69596e4:map[mysql:v1:0xc42047d120]***//</span></div><div class="line">	<span class="comment">//***0xc42047d120为结构体地址，Named就是image名字和tag***//</span></div><div class="line">	referencesByIDCache <span class="keyword">map</span>[image.ID]<span class="keyword">map</span>[<span class="keyword">string</span>]Named</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Repository maps tags to image IDs. The key is a stringified Reference,</span></div><div class="line"><span class="comment">// including the repository name.</span></div><div class="line"><span class="keyword">type</span> repository <span class="keyword">map</span>[<span class="keyword">string</span>]image.ID</div></pre></td></tr></table></figure></p>
<p>可以看出，store维护两个map：从镜像名称到id的map及从id到镜像名称的map。</p>
<h2 id="NewReferenceStore"><a href="#NewReferenceStore" class="headerlink" title="NewReferenceStore()"></a>NewReferenceStore()</h2><p>来看下如何生成ReferenceStore：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewReferenceStore creates a new reference store, tied to a file path where</span></div><div class="line"><span class="comment">// the set of references are serialized in JSON format.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewReferenceStore</span><span class="params">(jsonPath <span class="keyword">string</span>)</span> <span class="params">(Store, error)</span></span> &#123;</div><div class="line">	abspath, err := filepath.Abs(jsonPath)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	store := &amp;store&#123;</div><div class="line">		jsonPath:            abspath,</div><div class="line">		Repositories:        <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]repository),</div><div class="line">		referencesByIDCache: <span class="built_in">make</span>(<span class="keyword">map</span>[image.ID]<span class="keyword">map</span>[<span class="keyword">string</span>]Named),</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Load the json file if it exists, otherwise create it.</span></div><div class="line">	<span class="comment">//***从repositories.json中读取信息***//</span></div><div class="line">	<span class="keyword">if</span> err := store.reload(); os.IsNotExist(err) &#123;</div><div class="line">		<span class="keyword">if</span> err := store.save(); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> store, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>NewReferenceStore()先构造空store，然后调用reload()方法把内容填充到store的两个map中。</p>
<p>来看下reload():<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(store *store)</span> <span class="title">reload</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***store.jsonPath: /var/lib/docker/image/aufs/repositories.json***//</span></div><div class="line">	f, err := os.Open(store.jsonPath)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> f.Close()</div><div class="line">	<span class="keyword">if</span> err := json.NewDecoder(f).Decode(&amp;store); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, repository := <span class="keyword">range</span> store.Repositories &#123;</div><div class="line">		<span class="keyword">for</span> refStr, refID := <span class="keyword">range</span> repository &#123;</div><div class="line">			ref, err := ParseNamed(refStr)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="comment">// Should never happen</span></div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> store.referencesByIDCache[refID] == <span class="literal">nil</span> &#123;</div><div class="line">				store.referencesByIDCache[refID] = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]Named)</div><div class="line">			&#125;</div><div class="line">			<span class="comment">//***refID, refStr, ref:  sha256:b33c1b9f51a1c29432def013531f8c45c5910c5138698d8408742bfa79295fba mpich-worker:v1 mpich-worker:v1***//</span></div><div class="line">			store.referencesByIDCache[refID][refStr] = ref</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>reload()读取/var/lib/docker/image/aufs/repositories.json，然后把内容直接解码到store中，并重新构造referencesByIDCache。</p>
<p>所以来看下repositories.json的内容：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"Repositories"</span>: &#123;</div><div class="line">        <span class="attr">"nginx"</span>: &#123;</div><div class="line">            <span class="attr">"nginx:v1"</span>: <span class="string">"sha256:2765df43aea203fa44f069a44b984a27cb942551493e58b0d02b04ae22e5d644"</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">"ubuntu"</span>: &#123;</div><div class="line">            <span class="attr">"ubuntu:16.04"</span>: <span class="string">"sha256:ac526a356ca46f915e822e2f8051b9cf3404c756b725661c51191564ae4e6ea7"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，repositories.json的格式和referenceStore中的Repositories一样。</p>
<h2 id="添加"><a href="#添加" class="headerlink" title="添加"></a>添加</h2><p>我们可以在referenceStore中加入内容：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AddTag adds a tag reference to the store. If force is set to true, existing</span></div><div class="line"><span class="comment">// references can be overwritten. This only works for tags, not digests.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(store *store)</span> <span class="title">AddTag</span><span class="params">(ref Named, id image.ID, force <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> _, isCanonical := ref.(Canonical); isCanonical &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"refusing to create a tag with a digest reference"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> store.addReference(WithDefaultTag(ref), id, force)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AddDigest adds a digest reference to the store.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(store *store)</span> <span class="title">AddDigest</span><span class="params">(ref Canonical, id image.ID, force <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> store.addReference(ref, id, force)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***添加ref，即name和tag***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(store *store)</span> <span class="title">addReference</span><span class="params">(ref Named, id image.ID, force <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> ref.Name() == <span class="keyword">string</span>(digest.Canonical) &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"refusing to create an ambiguous tag using digest algorithm as name"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	store.mu.Lock()</div><div class="line">	<span class="keyword">defer</span> store.mu.Unlock()</div><div class="line"></div><div class="line">	repository, exists := store.Repositories[ref.Name()]</div><div class="line">	<span class="keyword">if</span> !exists || repository == <span class="literal">nil</span> &#123;</div><div class="line">		repository = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]image.ID)</div><div class="line">		store.Repositories[ref.Name()] = repository</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	refStr := ref.String()</div><div class="line">	oldID, exists := repository[refStr]</div><div class="line"></div><div class="line">	<span class="keyword">if</span> exists &#123;</div><div class="line">		<span class="comment">// force only works for tags</span></div><div class="line">		<span class="keyword">if</span> digested, isDigest := ref.(Canonical); isDigest &#123;</div><div class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"Cannot overwrite digest %s"</span>, digested.Digest().String())</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> !force &#123;</div><div class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"Conflict: Tag %s is already set to image %s, if you want to replace it, please use -f option"</span>, ref.String(), oldID.String())</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> store.referencesByIDCache[oldID] != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="built_in">delete</span>(store.referencesByIDCache[oldID], refStr)</div><div class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(store.referencesByIDCache[oldID]) == <span class="number">0</span> &#123;</div><div class="line">				<span class="built_in">delete</span>(store.referencesByIDCache, oldID)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	repository[refStr] = id</div><div class="line">	<span class="keyword">if</span> store.referencesByIDCache[id] == <span class="literal">nil</span> &#123;</div><div class="line">		store.referencesByIDCache[id] = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]Named)</div><div class="line">	&#125;</div><div class="line">	store.referencesByIDCache[id][refStr] = ref</div><div class="line"></div><div class="line">	<span class="keyword">return</span> store.save()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>添加的过程就是在referenceStore中加入内容，然后把整个referenceStore的内容存储到repositories.json中。</p>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><p>当然，也可以从referenceStore上删除资源。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Delete deletes a reference from the store. It returns true if a deletion</span></div><div class="line"><span class="comment">// happened, or false otherwise.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(store *store)</span> <span class="title">Delete</span><span class="params">(ref Named)</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</div><div class="line">	ref = WithDefaultTag(ref)</div><div class="line"></div><div class="line">	store.mu.Lock()</div><div class="line">	<span class="keyword">defer</span> store.mu.Unlock()</div><div class="line"></div><div class="line">	repoName := ref.Name()</div><div class="line"></div><div class="line">	repository, exists := store.Repositories[repoName]</div><div class="line">	<span class="comment">//***不存在，则直接返回***//</span></div><div class="line">	<span class="keyword">if</span> !exists &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, ErrDoesNotExist</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	refStr := ref.String()</div><div class="line">	<span class="keyword">if</span> id, exists := repository[refStr]; exists &#123;</div><div class="line">		<span class="built_in">delete</span>(repository, refStr)</div><div class="line">		<span class="comment">//***Fankang***//</span></div><div class="line">		<span class="comment">//***如果repository为空，则删除***//</span></div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(repository) == <span class="number">0</span> &#123;</div><div class="line">			<span class="built_in">delete</span>(store.Repositories, repoName)</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***清理referencesByIDCache中的资源***//</span></div><div class="line">		<span class="keyword">if</span> store.referencesByIDCache[id] != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="built_in">delete</span>(store.referencesByIDCache[id], refStr)</div><div class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(store.referencesByIDCache[id]) == <span class="number">0</span> &#123;</div><div class="line">				<span class="built_in">delete</span>(store.referencesByIDCache, id)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span>, store.save()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">false</span>, ErrDoesNotExist</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>删除资源就是从referenceStore的两个map中把资源删除，然后把内容存储到repositories.json中。</p>
<h2 id="获取"><a href="#获取" class="headerlink" title="获取"></a>获取</h2><h4 id="Get"><a href="#Get" class="headerlink" title="Get()"></a>Get()</h4><p>Get可以通过imageName和tag获取镜像id。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***通过imageName和tag获取镜像id***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(store *store)</span> <span class="title">Get</span><span class="params">(ref Named)</span> <span class="params">(image.ID, error)</span></span> &#123;</div><div class="line">	ref = WithDefaultTag(ref)</div><div class="line"></div><div class="line">	store.mu.RLock()</div><div class="line">	<span class="keyword">defer</span> store.mu.RUnlock()</div><div class="line"></div><div class="line">	repository, exists := store.Repositories[ref.Name()]</div><div class="line">	<span class="keyword">if</span> !exists || repository == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, ErrDoesNotExist</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	id, exists := repository[ref.String()]</div><div class="line">	<span class="keyword">if</span> !exists &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, ErrDoesNotExist</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> id, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="References"><a href="#References" class="headerlink" title="References()"></a>References()</h4><p>References()可以返回某镜像id对应的镜像列表，如[nginx:20170820, nginx:v1]。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// References returns a slice of references to the given image ID. The slice</span></div><div class="line"><span class="comment">// will be nil if there are no references to this image ID.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(store *store)</span> <span class="title">References</span><span class="params">(id image.ID)</span> []<span class="title">Named</span></span> &#123;</div><div class="line">	store.mu.RLock()</div><div class="line">	<span class="keyword">defer</span> store.mu.RUnlock()</div><div class="line"></div><div class="line">	<span class="comment">// Convert the internal map to an array for two reasons:</span></div><div class="line">	<span class="comment">// 1) We must not return a mutable</span></div><div class="line">	<span class="comment">// 2) It would be ugly to expose the extraneous map keys to callers.</span></div><div class="line"></div><div class="line">	<span class="keyword">var</span> references []Named</div><div class="line">	<span class="comment">//***只取Named***//</span></div><div class="line">	<span class="keyword">for</span> _, ref := <span class="keyword">range</span> store.referencesByIDCache[id] &#123;</div><div class="line">		references = <span class="built_in">append</span>(references, ref)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sort.Sort(lexicalRefs(references))</div><div class="line"></div><div class="line">	<span class="keyword">return</span> references</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="ReferencesByName"><a href="#ReferencesByName" class="headerlink" title="ReferencesByName()"></a>ReferencesByName()</h4><p>通过镜像名字返回Association。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***查找associaltions，包含image:tag和image-id***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(store *store)</span> <span class="title">ReferencesByName</span><span class="params">(ref Named)</span> []<span class="title">Association</span></span> &#123;</div><div class="line">	store.mu.RLock()</div><div class="line">	<span class="keyword">defer</span> store.mu.RUnlock()</div><div class="line"></div><div class="line">	repository, exists := store.Repositories[ref.Name()]</div><div class="line">	<span class="keyword">if</span> !exists &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> associations []Association</div><div class="line">	<span class="keyword">for</span> refStr, refID := <span class="keyword">range</span> repository &#123;</div><div class="line">		ref, err := ParseNamed(refStr)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="comment">// Should never happen</span></div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		associations = <span class="built_in">append</span>(associations,</div><div class="line">			Association&#123;</div><div class="line">				Ref:     ref,</div><div class="line">				ImageID: refID,</div><div class="line">			&#125;)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sort.Sort(lexicalAssociations(associations))</div><div class="line"></div><div class="line">	<span class="keyword">return</span> associations</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// An Association is a tuple associating a reference with an image ID.</span></div><div class="line"><span class="keyword">type</span> Association <span class="keyword">struct</span> &#123;</div><div class="line">	Ref     Named</div><div class="line">	ImageID image.ID</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><p>save()可以把referenceStore持久化到repositories.json中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***把信息存储到/var/lib/docker/image/aufs/repositories.json***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(store *store)</span> <span class="title">save</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// Store the json</span></div><div class="line">	jsonData, err := json.Marshal(store)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ioutils.AtomicWriteFile(store.jsonPath, jsonData, <span class="number">0600</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>referenceStore就是repositories.json在内存中的对象，用来管理镜像名称和镜像id的关系。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/10/29/Docker镜像存储代码分析-referenceStore-v1-12-3/" data-id="cj9v1yig8000axwqsntyh6rs0" class="article-share-link">分享</a><div class="tags"><a href="/tags/docker/">docker</a><a href="/tags/docker-v1-12-3/">docker-v1.12.3</a></div><div class="post-nav"><a href="/2017/10/30/Docker镜像存储代码分析-layerStore-v1-12-3/" class="pre">Docker镜像存储代码分析-layerStore-v1.12.3</a><a href="/2017/10/29/Docker镜像存储代码分析-imageStore-v1-12-3/" class="next">Docker镜像存储代码分析-imageStore-v1.12.3</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/Python语言/">Python语言</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/GO语言/">GO语言</a></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/Python语言/" style="font-size: 15px;">Python语言</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/11/gRPC-demo/">gRPC-demo</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/31/kubernetes-controller分析(四)-garbagecollector-v1-5-2/">kubernetes-controller分析(四)-garbagecollector-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/30/Docker镜像存储代码分析-layerStore-v1-12-3/">Docker镜像存储代码分析-layerStore-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/29/Docker镜像存储代码分析-referenceStore-v1-12-3/">Docker镜像存储代码分析-referenceStore-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/29/Docker镜像存储代码分析-imageStore-v1-12-3/">Docker镜像存储代码分析-imageStore-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/26/kube-controller分析(三)-NamespaceController-v1-5-2/">kube-controller分析(三)-NamespaceController-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/25/kubernetes-watcher-demo/">kubernetes-watcher-demo</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/24/kube-controller分析(二)-finalizer机制-v1-5-2/">kube-controller分析(二)-finalizer机制-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/19/kube-controller分析(一)-sharedInformerFactory解读-v1-5-2/">kube-controller分析(一)-sharedInformerFactory解读-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/18/kubernetes-client分析(四)-ClientSet-v1-5-2/">kubernetes-client分析(四)-ClientSet-v1.5.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>