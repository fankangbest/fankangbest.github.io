<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Docker镜像存储代码分析-imageStore-v1.12.3 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Docker镜像存储代码分析-imageStore-v1.12.3</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Docker镜像存储代码分析-imageStore-v1.12.3</h1><div class="post-meta">Oct 29, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>之前在”Docker镜像存储分析”中已经介绍过Docker是如何组织镜像存储目录的。在Docker中，主要有三个store来负责对镜像进行管理：</p>
<ol>
<li>imageStore: 负责imagedb目录管理；</li>
<li>layerStore: 负责content目录管理；</li>
<li>referenceStore: 负责repositories.json文件管理。</li>
</ol>
<p>本次分析将介绍imageStore相关的知识。</p>
<h2 id="imagedb"><a href="#imagedb" class="headerlink" title="imagedb"></a>imagedb</h2><p>Docker1.12.3把镜像相关的内容入在/var/lib/docker/image/aufs/imagedb目录下。主要有content和metadata两个目录，content目录存储镜像config文件，metadata目录存储镜像的parent文件。</p>
<h2 id="fs"><a href="#fs" class="headerlink" title="fs"></a>fs</h2><p>先来看fs。fs是直接和imagedb目录打交道的模块。fs定义在/image/fs.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// fs implements StoreBackend using the filesystem.</span></div><div class="line"><span class="keyword">type</span> fs <span class="keyword">struct</span> &#123;</div><div class="line">	sync.RWMutex</div><div class="line">	root <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>fs的root字段表示imagedb目录，即/var/lib/docker/image/aufs/imagedb/。<br>fs实现了StorageBackend接口：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// StoreBackend provides interface for image.Store persistence</span></div><div class="line"><span class="keyword">type</span> StoreBackend <span class="keyword">interface</span> &#123;</div><div class="line">	Walk(f IDWalkFunc) error</div><div class="line">	Get(id ID) ([]<span class="keyword">byte</span>, error)</div><div class="line">	Set(data []<span class="keyword">byte</span>) (ID, error)</div><div class="line">	Delete(id ID) error</div><div class="line">	SetMetadata(id ID, key <span class="keyword">string</span>, data []<span class="keyword">byte</span>) error</div><div class="line">	GetMetadata(id ID, key <span class="keyword">string</span>) ([]<span class="keyword">byte</span>, error)</div><div class="line">	DeleteMetadata(id ID, key <span class="keyword">string</span>) error</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="NewFSStoreBackend"><a href="#NewFSStoreBackend" class="headerlink" title="NewFSStoreBackend()"></a>NewFSStoreBackend()</h4><p>NewFSStoreBackend()可以生成一个新的fs：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***生成新的StoreBackend***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewFSStoreBackend</span><span class="params">(root <span class="keyword">string</span>)</span> <span class="params">(StoreBackend, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> newFSStore(root)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newFSStore</span><span class="params">(root <span class="keyword">string</span>)</span> <span class="params">(*fs, error)</span></span> &#123;</div><div class="line">	s := &amp;fs&#123;</div><div class="line">		root: root,</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***创建image/aufs/imagedb/content***//</span></div><div class="line">	<span class="keyword">if</span> err := os.MkdirAll(filepath.Join(root, contentDirName, <span class="keyword">string</span>(digest.Canonical)), <span class="number">0700</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***创建image/aufs/imagedb/metadata***//</span></div><div class="line">	<span class="keyword">if</span> err := os.MkdirAll(filepath.Join(root, metadataDirName, <span class="keyword">string</span>(digest.Canonical)), <span class="number">0700</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> s, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，NewFSStoreBackend()调用了newFSStore()，newFSStore()也只是创建了content和metadata目录。</p>
<h4 id="路径组装方法"><a href="#路径组装方法" class="headerlink" title="路径组装方法"></a>路径组装方法</h4><p>路径组装有两个方法：contentFile()和metadataDir()，分别可以获取content和metadata目录下的文件。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***/var/lib/docker/image/aufs/imagedb/content/sha256/55552ff902826130b2efb07df7d69a4fe56e5d42abf2577e5c0d1d44154ea8ed***//</span></div><div class="line"><span class="comment">//***记录了镜像层config信息***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *fs)</span> <span class="title">contentFile</span><span class="params">(id ID)</span> <span class="title">string</span></span> &#123;</div><div class="line">	dgst := digest.Digest(id)</div><div class="line">	<span class="keyword">return</span> filepath.Join(s.root, contentDirName, <span class="keyword">string</span>(dgst.Algorithm()), dgst.Hex())</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***/var/lib/docker/image/aufs/imagedb/metadata/sha256/55552ff902826130b2efb07df7d69a4fe56e5d42abf2577e5c0d1d44154ea8ed/***//</span></div><div class="line"><span class="comment">//***里面有parent文件，记录了parent的信息***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *fs)</span> <span class="title">metadataDir</span><span class="params">(id ID)</span> <span class="title">string</span></span> &#123;</div><div class="line">	dgst := digest.Digest(id)</div><div class="line">	<span class="keyword">return</span> filepath.Join(s.root, metadataDirName, <span class="keyword">string</span>(dgst.Algorithm()), dgst.Hex())</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Walk"><a href="#Walk" class="headerlink" title="Walk()"></a>Walk()</h4><p>Walk()该当实现了目录的遍历。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Walk calls the supplied callback for each image ID in the storage backend.</span></div><div class="line"><span class="comment">//***遍历函数实现***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *fs)</span> <span class="title">Walk</span><span class="params">(f IDWalkFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// Only Canonical digest (sha256) is currently supported</span></div><div class="line">	s.RLock()</div><div class="line">	dir, err := ioutil.ReadDir(filepath.Join(s.root, contentDirName, <span class="keyword">string</span>(digest.Canonical)))</div><div class="line">	s.RUnlock()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> dir &#123;</div><div class="line">		<span class="comment">//***计算config的hash值***//</span></div><div class="line">		<span class="comment">//***dgst:  sha256:4e3af817fe2080001e58f7be0b8f2a6c3ac75baa1f5adf878bed4de6d99f141f***//</span></div><div class="line">		dgst := digest.NewDigestFromHex(<span class="keyword">string</span>(digest.Canonical), v.Name())</div><div class="line">		<span class="keyword">if</span> err := dgst.Validate(); err != <span class="literal">nil</span> &#123;</div><div class="line">			logrus.Debugf(<span class="string">"Skipping invalid digest %s: %s"</span>, dgst, err)</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err := f(ID(dgst)); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Get"><a href="#Get" class="headerlink" title="Get()"></a>Get()</h4><p>Get()可以通过id获取镜像的config文件。获取config文件的流程很简单，从content目录下读取对应id的文件即可。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Get returns the content stored under a given ID.</span></div><div class="line"><span class="comment">//***获取镜像的信息***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *fs)</span> <span class="title">Get</span><span class="params">(id ID)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">	s.RLock()</div><div class="line">	<span class="keyword">defer</span> s.RUnlock()</div><div class="line"></div><div class="line">	<span class="keyword">return</span> s.get(id)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***读取镜像层config，并返回***//</span></div><div class="line"><span class="comment">//***/var/lib/docker/image/aufs/imagedb/content/sha256/771c181795500f34c8a1c53b945560dfce8197a2840f839536c52560714a4201***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *fs)</span> <span class="title">get</span><span class="params">(id ID)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">	content, err := ioutil.ReadFile(s.contentFile(id))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// todo: maybe optional</span></div><div class="line">	<span class="comment">//***验证config的hash值***//</span></div><div class="line">	<span class="keyword">if</span> ID(digest.FromBytes(content)) != id &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"failed to verify image: %v"</span>, id)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> content, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Set"><a href="#Set" class="headerlink" title="Set()"></a>Set()</h4><p>Set()可以设置镜像层的config文件。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Set stores content under a given ID.</span></div><div class="line"><span class="comment">//***把镜像层的信息写入到具体ID文件中***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *fs)</span> <span class="title">Set</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="params">(ID, error)</span></span> &#123;</div><div class="line">	s.Lock()</div><div class="line">	<span class="keyword">defer</span> s.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"Invalid empty data"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	id := ID(digest.FromBytes(data))</div><div class="line">	<span class="comment">//***原子写，可以学习下***//</span></div><div class="line">	<span class="keyword">if</span> err := ioutils.AtomicWriteFile(s.contentFile(id), data, <span class="number">0600</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> id, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Delete"><a href="#Delete" class="headerlink" title="Delete()"></a>Delete()</h4><p>Delete()可以依据id删除镜像层对应的文件或目录。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Delete removes content and metadata files associated with the ID.</span></div><div class="line"><span class="comment">//***Fankang***//</span></div><div class="line"><span class="comment">//***删除content目录和metadata目录下对应id的文件***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *fs)</span> <span class="title">Delete</span><span class="params">(id ID)</span> <span class="title">error</span></span> &#123;</div><div class="line">	s.Lock()</div><div class="line">	<span class="keyword">defer</span> s.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := os.RemoveAll(s.metadataDir(id)); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := os.Remove(s.contentFile(id)); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="SetMetadata"><a href="#SetMetadata" class="headerlink" title="SetMetadata()"></a>SetMetadata()</h4><p>SetMetadata()可以把内容写入到metadata目录下。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// SetMetadata sets metadata for a given ID. It fails if there's no base file.</span></div><div class="line"><span class="comment">//***设置镜像层的metadata***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *fs)</span> <span class="title">SetMetadata</span><span class="params">(id ID, key <span class="keyword">string</span>, data []<span class="keyword">byte</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	s.Lock()</div><div class="line">	<span class="keyword">defer</span> s.Unlock()</div><div class="line">	<span class="keyword">if</span> _, err := s.get(id); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	baseDir := filepath.Join(s.metadataDir(id))</div><div class="line">	<span class="keyword">if</span> err := os.MkdirAll(baseDir, <span class="number">0700</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ioutils.AtomicWriteFile(filepath.Join(s.metadataDir(id), key), data, <span class="number">0600</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="GetMetadata"><a href="#GetMetadata" class="headerlink" title="GetMetadata()"></a>GetMetadata()</h4><p>从metadata目录下获取key对应的内容。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">// GetMetadata returns metadata for a given ID.</div><div class="line">//***获取镜像的metadata***//</div><div class="line">func (s *fs) GetMetadata(id ID, key string) ([]byte, error) &#123;</div><div class="line">	s.RLock()</div><div class="line">	defer s.RUnlock()</div><div class="line"></div><div class="line">	if _, err := s.get(id); err != nil &#123;</div><div class="line">		return nil, err</div><div class="line">	&#125;</div><div class="line">	return ioutil.ReadFile(filepath.Join(s.metadataDir(id), key))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="DeleteMetadata"><a href="#DeleteMetadata" class="headerlink" title="DeleteMetadata()"></a>DeleteMetadata()</h4><p>DeleteMetadata()移除某id的metadata内容。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DeleteMetadata removes the metadata associated with an ID.</span></div><div class="line"><span class="comment">//***删除镜像层的metadata***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *fs)</span> <span class="title">DeleteMetadata</span><span class="params">(id ID, key <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	s.Lock()</div><div class="line">	<span class="keyword">defer</span> s.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">return</span> os.RemoveAll(filepath.Join(s.metadataDir(id), key))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="image"><a href="#image" class="headerlink" title="image"></a>image</h2><p>接着来看image，image定义在/image/image.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// V1Image stores the V1 image configuration.</span></div><div class="line"><span class="keyword">type</span> V1Image <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// ID a unique 64 character identifier of the image</span></div><div class="line">	ID <span class="keyword">string</span> <span class="string">`json:"id,omitempty"`</span></div><div class="line">	<span class="comment">// Parent id of the image</span></div><div class="line">	Parent <span class="keyword">string</span> <span class="string">`json:"parent,omitempty"`</span></div><div class="line">	<span class="comment">// Comment user added comment</span></div><div class="line">	Comment <span class="keyword">string</span> <span class="string">`json:"comment,omitempty"`</span></div><div class="line">	<span class="comment">// Created timestamp when image was created</span></div><div class="line">	Created time.Time <span class="string">`json:"created"`</span></div><div class="line">	<span class="comment">// Container is the id of the container used to commit</span></div><div class="line">	Container <span class="keyword">string</span> <span class="string">`json:"container,omitempty"`</span></div><div class="line">	<span class="comment">// ContainerConfig is the configuration of the container that is committed into the image</span></div><div class="line">	ContainerConfig container.Config <span class="string">`json:"container_config,omitempty"`</span></div><div class="line">	<span class="comment">// DockerVersion specifies version on which image is built</span></div><div class="line">	DockerVersion <span class="keyword">string</span> <span class="string">`json:"docker_version,omitempty"`</span></div><div class="line">	<span class="comment">// Author of the image</span></div><div class="line">	Author <span class="keyword">string</span> <span class="string">`json:"author,omitempty"`</span></div><div class="line">	<span class="comment">// Config is the configuration of the container received from the client</span></div><div class="line">	Config *container.Config <span class="string">`json:"config,omitempty"`</span></div><div class="line">	<span class="comment">// Architecture is the hardware that the image is build and runs on</span></div><div class="line">	Architecture <span class="keyword">string</span> <span class="string">`json:"architecture,omitempty"`</span></div><div class="line">	<span class="comment">// OS is the operating system used to build and run the image</span></div><div class="line">	OS <span class="keyword">string</span> <span class="string">`json:"os,omitempty"`</span></div><div class="line">	<span class="comment">// Size is the total size of the image including all layers it is composed of</span></div><div class="line">	Size <span class="keyword">int64</span> <span class="string">`json:",omitempty"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Image stores the image configuration</span></div><div class="line"><span class="keyword">type</span> Image <span class="keyword">struct</span> &#123;</div><div class="line">	V1Image</div><div class="line">	Parent     ID        <span class="string">`json:"parent,omitempty"`</span></div><div class="line">	RootFS     *RootFS   <span class="string">`json:"rootfs,omitempty"`</span></div><div class="line">	History    []History <span class="string">`json:"history,omitempty"`</span></div><div class="line">	OSVersion  <span class="keyword">string</span>    <span class="string">`json:"os.version,omitempty"`</span></div><div class="line">	OSFeatures []<span class="keyword">string</span>  <span class="string">`json:"os.features,omitempty"`</span></div><div class="line"></div><div class="line">	<span class="comment">// rawJSON caches the immutable JSON associated with this image.</span></div><div class="line">	rawJSON []<span class="keyword">byte</span></div><div class="line"></div><div class="line">	<span class="comment">// computedID is the ID computed from the hash of the image config.</span></div><div class="line">	<span class="comment">// Not to be confused with the legacy V1 ID in V1Image.</span></div><div class="line">	computedID ID</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>image的各字段可以和image的config对应起来。</p>
<h4 id="RawJSON"><a href="#RawJSON" class="headerlink" title="RawJSON()"></a>RawJSON()</h4><p>RawJSON()返回rawJSON。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RawJSON returns the immutable JSON associated with the image.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(img *Image)</span> <span class="title">RawJSON</span><span class="params">()</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> img.rawJSON</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="ID"><a href="#ID" class="headerlink" title="ID()"></a>ID()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***返回镜像层config的hash值***//</span></div><div class="line"><span class="comment">//***可以通过sha256sum命令进行计算***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(img *Image)</span> <span class="title">ID</span><span class="params">()</span> <span class="title">ID</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> img.computedID</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ImageID"><a href="#ImageID" class="headerlink" title="ImageID()"></a>ImageID()</h4><p>返回镜像层的ID。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ImageID stringizes ID.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(img *Image)</span> <span class="title">ImageID</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(img.ID())</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="RunConfig"><a href="#RunConfig" class="headerlink" title="RunConfig()"></a>RunConfig()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RunConfig returns the image's container config.</span></div><div class="line"><span class="comment">//***返回config***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(img *Image)</span> <span class="title">RunConfig</span><span class="params">()</span> *<span class="title">container</span>.<span class="title">Config</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> img.Config</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="MarshalJSON"><a href="#MarshalJSON" class="headerlink" title="MarshalJSON()"></a>MarshalJSON()</h4><p>MarshalJSON()把镜像层的config序列化成json。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// MarshalJSON serializes the image to JSON. It sorts the top-level keys so</span></div><div class="line"><span class="comment">// that JSON that's been manipulated by a push/pull cycle with a legacy</span></div><div class="line"><span class="comment">// registry won't end up with a different key order.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(img *Image)</span> <span class="title">MarshalJSON</span><span class="params">()</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">type</span> MarshalImage Image</div><div class="line"></div><div class="line">	pass1, err := json.Marshal(MarshalImage(*img))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> c <span class="keyword">map</span>[<span class="keyword">string</span>]*json.RawMessage</div><div class="line">	<span class="keyword">if</span> err := json.Unmarshal(pass1, &amp;c); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> json.Marshal(c)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="rootfs"><a href="#rootfs" class="headerlink" title="rootfs"></a>rootfs</h2><p>rootfs表明Docker是如何组织镜像的，目前只有”layers”一种。rootfs定义在/image/rootfs_unix.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RootFS describes images root filesystem</span></div><div class="line"><span class="comment">// This is currently a placeholder that only supports layers. In the future</span></div><div class="line"><span class="comment">// this can be made into an interface that supports different implementations.</span></div><div class="line"><span class="keyword">type</span> RootFS <span class="keyword">struct</span> &#123;</div><div class="line">	Type    <span class="keyword">string</span>         <span class="string">`json:"type"`</span></div><div class="line">	DiffIDs []layer.DiffID <span class="string">`json:"diff_ids,omitempty"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ChainID returns the ChainID for the top layer in RootFS.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RootFS)</span> <span class="title">ChainID</span><span class="params">()</span> <span class="title">layer</span>.<span class="title">ChainID</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> layer.CreateChainID(r.DiffIDs)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，RootFS可以依据DiffIDs(由layer.tar哈希计算得出)计算layer的值。具体见镜像存储分析。</p>
<h2 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h2><p>Store可以操作整个imagedb。<br>Store定义在/image/store.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Store is an interface for creating and accessing images</span></div><div class="line"><span class="keyword">type</span> Store <span class="keyword">interface</span> &#123;</div><div class="line">	Create(config []<span class="keyword">byte</span>) (ID, error)</div><div class="line">	Get(id ID) (*Image, error)</div><div class="line">	Delete(id ID) ([]layer.Metadata, error)</div><div class="line">	Search(partialID <span class="keyword">string</span>) (ID, error)</div><div class="line">	SetParent(id ID, parent ID) error</div><div class="line">	GetParent(id ID) (ID, error)</div><div class="line">	Children(id ID) []ID</div><div class="line">	Map() <span class="keyword">map</span>[ID]*Image</div><div class="line">	Heads() <span class="keyword">map</span>[ID]*Image</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> store <span class="keyword">struct</span> &#123;</div><div class="line">	sync.Mutex</div><div class="line">	ls        LayerGetReleaser</div><div class="line">	images    <span class="keyword">map</span>[ID]*imageMeta</div><div class="line">	fs        StoreBackend</div><div class="line">	digestSet *digest.Set</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，store中有images map维护ID和imageMeta的关系。<br>imageMeta定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> imageMeta <span class="keyword">struct</span> &#123;</div><div class="line">	layer layer.Layer</div><div class="line">	<span class="comment">//***children中的key ID用来标识子镜像层***//</span></div><div class="line">	children <span class="keyword">map</span>[ID]<span class="keyword">struct</span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>imageMeta中存有layer信息及该镜像层的children信息。</p>
<h4 id="NewImageStore"><a href="#NewImageStore" class="headerlink" title="NewImageStore()"></a>NewImageStore()</h4><p>来看下store的生成函数NewImageStore()。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewImageStore returns new store object for given layer store</span></div><div class="line"><span class="comment">//***返回一个新的image store***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewImageStore</span><span class="params">(fs StoreBackend, ls LayerGetReleaser)</span> <span class="params">(Store, error)</span></span> &#123;</div><div class="line">	is := &amp;store&#123;</div><div class="line">		ls:        ls,</div><div class="line">		images:    <span class="built_in">make</span>(<span class="keyword">map</span>[ID]*imageMeta),</div><div class="line">		fs:        fs,</div><div class="line">		digestSet: digest.NewSet(),</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// load all current images and retain layers</span></div><div class="line">	<span class="keyword">if</span> err := is.restore(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***在只有nginx:v1的情况下***//</span></div><div class="line">	<span class="comment">//***is:  &amp;&#123;&#123;0 0&#125; 0xc42048c240 map[sha256:4e3af817fe2080001e58f7be0b8f2a6c3ac75baa1f5adf878bed4de6d99f141f:0xc4204b0760] 0xc4204977d0 0xc420497830&#125;***//</span></div><div class="line">	<span class="keyword">return</span> is, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(is *store)</span> <span class="title">restore</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	err := is.fs.Walk(<span class="function"><span class="keyword">func</span><span class="params">(id ID)</span> <span class="title">error</span></span> &#123;</div><div class="line">		<span class="comment">//***根据id获取config，再得到img***//</span></div><div class="line">		img, err := is.Get(id)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			logrus.Errorf(<span class="string">"invalid image %v, %v"</span>, id, err)</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">var</span> l layer.Layer</div><div class="line">		<span class="keyword">if</span> chainID := img.RootFS.ChainID(); chainID != <span class="string">""</span> &#123;</div><div class="line">			l, err = is.ls.Get(chainID)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err := is.digestSet.Add(digest.Digest(id)); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		imageMeta := &amp;imageMeta&#123;</div><div class="line">			layer:    l,</div><div class="line">			children: <span class="built_in">make</span>(<span class="keyword">map</span>[ID]<span class="keyword">struct</span>&#123;&#125;),</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		is.images[ID(id)] = imageMeta</div><div class="line"></div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Second pass to fill in children maps</span></div><div class="line">	<span class="comment">//***处理镜像parent***//</span></div><div class="line">	<span class="keyword">for</span> id := <span class="keyword">range</span> is.images &#123;</div><div class="line">		<span class="keyword">if</span> parent, err := is.GetParent(id); err == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> parentMeta := is.images[parent]; parentMeta != <span class="literal">nil</span> &#123;</div><div class="line">				parentMeta.children[id] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中restore()是直接从imagedb目录构建imageStore。</p>
<h4 id="Create"><a href="#Create" class="headerlink" title="Create()"></a>Create()</h4><p>Create()可以从config生成一个镜像层。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(is *store)</span> <span class="title">Create</span><span class="params">(config []<span class="keyword">byte</span>)</span> <span class="params">(ID, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> img Image</div><div class="line">	<span class="comment">//***把config还原成img***//</span></div><div class="line">	err := json.Unmarshal(config, &amp;img)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Must reject any config that references diffIDs from the history</span></div><div class="line">	<span class="comment">// which aren't among the rootfs layers.</span></div><div class="line">	rootFSLayers := <span class="built_in">make</span>(<span class="keyword">map</span>[layer.DiffID]<span class="keyword">struct</span>&#123;&#125;)</div><div class="line">	<span class="keyword">for</span> _, diffID := <span class="keyword">range</span> img.RootFS.DiffIDs &#123;</div><div class="line">		rootFSLayers[diffID] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	layerCounter := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> _, h := <span class="keyword">range</span> img.History &#123;</div><div class="line">		<span class="keyword">if</span> !h.EmptyLayer &#123;</div><div class="line">			layerCounter++</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> layerCounter &gt; <span class="built_in">len</span>(img.RootFS.DiffIDs) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, errors.New(<span class="string">"too many non-empty layers in History section"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***存储镜像config并计算镜像ID***//</span></div><div class="line">	dgst, err := is.fs.Set(config)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line">	imageID := ID(dgst)</div><div class="line"></div><div class="line">	is.Lock()</div><div class="line">	<span class="keyword">defer</span> is.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> _, exists := is.images[imageID]; exists &#123;</div><div class="line">		<span class="keyword">return</span> imageID, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	layerID := img.RootFS.ChainID()</div><div class="line"></div><div class="line">	<span class="keyword">var</span> l layer.Layer</div><div class="line">	<span class="keyword">if</span> layerID != <span class="string">""</span> &#123;</div><div class="line">		l, err = is.ls.Get(layerID)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	imageMeta := &amp;imageMeta&#123;</div><div class="line">		layer:    l,</div><div class="line">		children: <span class="built_in">make</span>(<span class="keyword">map</span>[ID]<span class="keyword">struct</span>&#123;&#125;),</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	is.images[imageID] = imageMeta</div><div class="line">	<span class="keyword">if</span> err := is.digestSet.Add(digest.Digest(imageID)); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">delete</span>(is.images, imageID)</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> imageID, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Get-1"><a href="#Get-1" class="headerlink" title="Get()"></a>Get()</h4><p>Get()先从fs中获取config，然后调用NewFromJSON(config)创建一个img，再设置img的computedID(就是该image的config的hash值)及Parent。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***依据id获取镜像的config，并依据config返回镜像***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(is *store)</span> <span class="title">Get</span><span class="params">(id ID)</span> <span class="params">(*Image, error)</span></span> &#123;</div><div class="line">	<span class="comment">// todo: Check if image is in images</span></div><div class="line">	<span class="comment">// todo: Detect manual insertions and start using them</span></div><div class="line">	<span class="comment">//***获取id对应的config内容***//</span></div><div class="line">	config, err := is.fs.Get(id)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***把config还原成镜像***//</span></div><div class="line">	img, err := NewFromJSON(config)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***设置image的computedID***//</span></div><div class="line">	img.computedID = id</div><div class="line"></div><div class="line">	<span class="comment">//***设置image的Parent***//</span></div><div class="line">	img.Parent, err = is.GetParent(id)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		img.Parent = <span class="string">""</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> img, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Delete-1"><a href="#Delete-1" class="headerlink" title="Delete()"></a>Delete()</h4><p>Delete()可以删除一个镜像层。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***清理与parent, children的联系，然后删除该镜像层***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(is *store)</span> <span class="title">Delete</span><span class="params">(id ID)</span> <span class="params">([]layer.Metadata, error)</span></span> &#123;</div><div class="line">	is.Lock()</div><div class="line">	<span class="keyword">defer</span> is.Unlock()</div><div class="line"></div><div class="line">	imageMeta := is.images[id]</div><div class="line">	<span class="keyword">if</span> imageMeta == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unrecognized image ID %s"</span>, id.String())</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> id := <span class="keyword">range</span> imageMeta.children &#123;</div><div class="line">		is.fs.DeleteMetadata(id, <span class="string">"parent"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> parent, err := is.GetParent(id); err == <span class="literal">nil</span> &amp;&amp; is.images[parent] != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">delete</span>(is.images[parent].children, id)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := is.digestSet.Remove(digest.Digest(id)); err != <span class="literal">nil</span> &#123;</div><div class="line">		logrus.Errorf(<span class="string">"error removing %s from digest set: %q"</span>, id, err)</div><div class="line">	&#125;</div><div class="line">	<span class="built_in">delete</span>(is.images, id)</div><div class="line">	is.fs.Delete(id)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> imageMeta.layer != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> is.ls.Release(imageMeta.layer)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="SetParent"><a href="#SetParent" class="headerlink" title="SetParent()"></a>SetParent()</h4><p>Setparent()可以建立两个id之前的父子层关系。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***先清理与旧parent的联系，再建立和新parent的联系***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(is *store)</span> <span class="title">SetParent</span><span class="params">(id, parent ID)</span> <span class="title">error</span></span> &#123;</div><div class="line">	is.Lock()</div><div class="line">	<span class="keyword">defer</span> is.Unlock()</div><div class="line">	parentMeta := is.images[parent]</div><div class="line">	<span class="keyword">if</span> parentMeta == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"unknown parent image ID %s"</span>, parent.String())</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> parent, err := is.GetParent(id); err == <span class="literal">nil</span> &amp;&amp; is.images[parent] != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">delete</span>(is.images[parent].children, id)</div><div class="line">	&#125;</div><div class="line">	parentMeta.children[id] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</div><div class="line">	<span class="keyword">return</span> is.fs.SetMetadata(id, <span class="string">"parent"</span>, []<span class="keyword">byte</span>(parent))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="GetParent"><a href="#GetParent" class="headerlink" title="GetParent()"></a>GetParent()</h4><p>GetParent()可以获取镜像层的父层。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取镜像层的parent***//</span></div><div class="line"><span class="comment">//***通过读取imagedb下的parent文件***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(is *store)</span> <span class="title">GetParent</span><span class="params">(id ID)</span> <span class="params">(ID, error)</span></span> &#123;</div><div class="line">	d, err := is.fs.GetMetadata(id, <span class="string">"parent"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ID(d), <span class="literal">nil</span> <span class="comment">// todo: validate?</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Children"><a href="#Children" class="headerlink" title="Children()"></a>Children()</h4><p>Children()可以获取镜像层的所有子层。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***调用children()获取children***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(is *store)</span> <span class="title">Children</span><span class="params">(id ID)</span> []<span class="title">ID</span></span> &#123;</div><div class="line">	is.Lock()</div><div class="line">	<span class="keyword">defer</span> is.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">return</span> is.children(id)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***返回镜像层的children***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(is *store)</span> <span class="title">children</span><span class="params">(id ID)</span> []<span class="title">ID</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> ids []ID</div><div class="line">	<span class="keyword">if</span> is.images[id] != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">for</span> id := <span class="keyword">range</span> is.images[id].children &#123;</div><div class="line">			ids = <span class="built_in">append</span>(ids, id)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ids</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Map"><a href="#Map" class="headerlink" title="Map()"></a>Map()</h4><p>Map()返回所有的镜像层。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取所有镜像层***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(is *store)</span> <span class="title">Map</span><span class="params">()</span> <span class="title">map</span>[<span class="title">ID</span>]*<span class="title">Image</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> is.imagesMap(<span class="literal">true</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(is *store)</span> <span class="title">imagesMap</span><span class="params">(all <span class="keyword">bool</span>)</span> <span class="title">map</span>[<span class="title">ID</span>]*<span class="title">Image</span></span> &#123;</div><div class="line">	is.Lock()</div><div class="line">	<span class="keyword">defer</span> is.Unlock()</div><div class="line"></div><div class="line">	images := <span class="built_in">make</span>(<span class="keyword">map</span>[ID]*Image)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> id := <span class="keyword">range</span> is.images &#123;</div><div class="line">		<span class="keyword">if</span> !all &amp;&amp; <span class="built_in">len</span>(is.children(id)) &gt; <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		img, err := is.Get(id)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			logrus.Errorf(<span class="string">"invalid image access: %q, error: %q"</span>, id, err)</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		images[id] = img</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> images</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/10/29/Docker镜像存储代码分析-imageStore-v1-12-3/" data-id="cjbiwgd3j000558qs9lrx2qn0" class="article-share-link">分享</a><div class="tags"><a href="/tags/docker/">docker</a><a href="/tags/docker-v1-12-3/">docker-v1.12.3</a></div><div class="post-nav"><a href="/2017/10/29/Docker镜像存储代码分析-referenceStore-v1-12-3/" class="pre">Docker镜像存储代码分析-referenceStore-v1.12.3</a><a href="/2017/10/26/kube-controller分析(三)-NamespaceController-v1-5-2/" class="next">kube-controller分析(三)-NamespaceController-v1.5.2</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/23/kubelet分析(七)-dockerManager(1)-v1-5-2/">kubelet分析(七)-dockerManager(1)-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/20/kubelet分析(六)-proberManager-v1-5-2/">kubelet分析(六)-proberManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/18/kubelet分析(五)-podManager-v1-5-2/">kubelet分析(五)-podManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(四)-statusManager-v1-5-2/">kubelet分析(四)-statusManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(三)-volumeManager-v1-5-2/">kubelet分析(三)-volumeManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/kubelet分析(二)-podWorker-v1-5-2/">kubelet分析(二)-podWorker-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/kubelet分析(一)-config-v1-5-2/">kubelet分析(一)-config-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/15/storage解读(六)-strategy-v1-5-2/">storage解读(六)-strategy-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/14/kubernetes-listwatch机制-v1-5-2/">kubernetes-listwatch机制-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/kubernetes-添加controller-demo-v1-5-2/">kubernetes-添加controller-demo-v1.5.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>