<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>kubelet分析(六)-proberManager-v1.5.2 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">kubelet分析(六)-proberManager-v1.5.2</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">kubelet分析(六)-proberManager-v1.5.2</h1><div class="post-meta">Dec 20, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>proberManager用来检测Kubernetes集群中Pod的健康状态。目前Kubernetes支持livenessProber和readinessProber两种：</p>
<ul>
<li>livenessProber: 用来检测容器中的程序是否健康并确定何时重启容器；</li>
<li>readinessProber: 用来检测容器中的程序是否就绪，就绪意味着该容器可以接收处理流量。</li>
</ul>
<p>目前支持HTTP, TCP, EXEC(执行命令或脚本)三种检测方式。</p>
<h4 id="proberManager"><a href="#proberManager" class="headerlink" title="proberManager"></a>proberManager</h4><p>proberManager定义在/pkg/kubelet/prober/prober_manager.go中，即manager结构体：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> manager <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// Map of active workers for probes</span></div><div class="line">	workers <span class="keyword">map</span>[probeKey]*worker</div><div class="line">	<span class="comment">// Lock for accessing &amp; mutating workers</span></div><div class="line">	workerLock sync.RWMutex</div><div class="line"></div><div class="line">	<span class="comment">// The statusManager cache provides pod IP and container IDs for probing.</span></div><div class="line">	statusManager status.Manager</div><div class="line"></div><div class="line">	<span class="comment">// readinessManager manages the results of readiness probes</span></div><div class="line">	readinessManager results.Manager</div><div class="line"></div><div class="line">	<span class="comment">// livenessManager manages the results of liveness probes</span></div><div class="line">	livenessManager results.Manager</div><div class="line"></div><div class="line">	<span class="comment">// prober executes the probe actions.</span></div><div class="line">	prober *prober</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>proberManager的主要字段如下：</p>
<ul>
<li>workers: manager中注册的worker，worker执行具体的检测，一个container对应一个或两个workers；</li>
<li>statusManager: pod的status管理器；</li>
<li>readinessManager：readinessProber探测结果的存储地；</li>
<li>livenessManager: livenessManager探测结果的存储地；</li>
<li>prober：探针，可以执行container中定义的检测。</li>
</ul>
<p>可以使用NewManager()生成proberManager:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewManager</span><span class="params">(</span></span></div><div class="line">	statusManager status.Manager,</div><div class="line">	livenessManager results.Manager,</div><div class="line">	runner kubecontainer.ContainerCommandRunner,</div><div class="line">	refManager *kubecontainer.RefManager,</div><div class="line">	recorder record.EventRecorder) <span class="title">Manager</span> &#123;</div><div class="line"></div><div class="line">	prober := newProber(runner, refManager, recorder)</div><div class="line">	readinessManager := results.NewManager()</div><div class="line">	<span class="keyword">return</span> &amp;manager&#123;</div><div class="line">		statusManager:    statusManager,</div><div class="line">		prober:           prober,</div><div class="line">		readinessManager: readinessManager,</div><div class="line">		livenessManager:  livenessManager,</div><div class="line">		workers:          <span class="built_in">make</span>(<span class="keyword">map</span>[probeKey]*worker),</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="manager-Start"><a href="#manager-Start" class="headerlink" title="manager::Start()"></a>manager::Start()</h4><p>Start()可以启动proberManager。启动后，proberManager可以重复调用updateReadiness()方法。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Start syncing probe status. This should only be called once.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manager)</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Start syncing readiness.</span></div><div class="line">	<span class="keyword">go</span> wait.Forever(m.updateReadiness, <span class="number">0</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="manager-updateReadiness"><a href="#manager-updateReadiness" class="headerlink" title="manager::updateReadiness()"></a>manager::updateReadiness()</h4><p>updateReadiness()会从readinessManager中获取最新的ready信息，然后更新container。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***go routine中的updateReadiness()方法***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manager)</span> <span class="title">updateReadiness</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">//***获取readinessmanager的updates channel***//</span></div><div class="line">	update := &lt;-m.readinessManager.Updates()</div><div class="line"></div><div class="line">	ready := update.Result == results.Success</div><div class="line">	m.statusManager.SetContainerReadiness(update.PodUID, update.ContainerID, ready)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="manager-AddPod"><a href="#manager-AddPod" class="headerlink" title="manager::AddPod()"></a>manager::AddPod()</h4><p>AddPod()会检测容器的定义，如果定义有ReadinessProbe，则生成容器readiness的检测worker；如果定义有LivenessProbe，则生成容器liveness的检测worker。然后把新生成的worker加入到proberManager的workers字段中，并启动worker。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manager)</span> <span class="title">AddPod</span><span class="params">(pod *api.Pod)</span></span> &#123;</div><div class="line">	m.workerLock.Lock()</div><div class="line">	<span class="keyword">defer</span> m.workerLock.Unlock()</div><div class="line"></div><div class="line">	key := probeKey&#123;podUID: pod.UID&#125;</div><div class="line">	<span class="keyword">for</span> _, c := <span class="keyword">range</span> pod.Spec.Containers &#123;</div><div class="line">		key.containerName = c.Name</div><div class="line"></div><div class="line">		<span class="comment">//***处理ReadinessProbe***//</span></div><div class="line">		<span class="keyword">if</span> c.ReadinessProbe != <span class="literal">nil</span> &#123;</div><div class="line">			key.probeType = readiness</div><div class="line">			<span class="keyword">if</span> _, ok := m.workers[key]; ok &#123;</div><div class="line">				glog.Errorf(<span class="string">"Readiness probe already exists! %v - %v"</span>,</div><div class="line">					format.Pod(pod), c.Name)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">//***新创建worker***//</span></div><div class="line">			w := newWorker(m, readiness, pod, c)</div><div class="line">			m.workers[key] = w</div><div class="line">			<span class="comment">//***Fankang***//</span></div><div class="line">			<span class="comment">//***启动worker***//</span></div><div class="line">			<span class="keyword">go</span> w.run()</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//***处理LivenessProbe***//</span></div><div class="line">		<span class="keyword">if</span> c.LivenessProbe != <span class="literal">nil</span> &#123;</div><div class="line">			key.probeType = liveness</div><div class="line">			<span class="keyword">if</span> _, ok := m.workers[key]; ok &#123;</div><div class="line">				glog.Errorf(<span class="string">"Liveness probe already exists! %v - %v"</span>,</div><div class="line">					format.Pod(pod), c.Name)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			w := newWorker(m, liveness, pod, c)</div><div class="line">			m.workers[key] = w</div><div class="line">			<span class="keyword">go</span> w.run()</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="manager-RemovePod"><a href="#manager-RemovePod" class="headerlink" title="manager::RemovePod()"></a>manager::RemovePod()</h4><p>RemovePod()获取pod对应的readiness worker，liveness worker，并停止。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manager)</span> <span class="title">RemovePod</span><span class="params">(pod *api.Pod)</span></span> &#123;</div><div class="line">	m.workerLock.RLock()</div><div class="line">	<span class="keyword">defer</span> m.workerLock.RUnlock()</div><div class="line"></div><div class="line">	key := probeKey&#123;podUID: pod.UID&#125;</div><div class="line">	<span class="keyword">for</span> _, c := <span class="keyword">range</span> pod.Spec.Containers &#123;</div><div class="line">		key.containerName = c.Name</div><div class="line">		<span class="keyword">for</span> _, probeType := <span class="keyword">range</span> [...]probeType&#123;readiness, liveness&#125; &#123;</div><div class="line">			key.probeType = probeType</div><div class="line">			<span class="keyword">if</span> worker, ok := m.workers[key]; ok &#123;</div><div class="line">				<span class="comment">//***停止readiness worker及liveness worker***//</span></div><div class="line">				worker.stop()</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="manager-CleanupPods"><a href="#manager-CleanupPods" class="headerlink" title="manager::CleanupPods()"></a>manager::CleanupPods()</h4><p>CleanupPods()可以停止状态不为active的容器对应的worker。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***如果容器状态不为active，则把对应的的worker停止***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manager)</span> <span class="title">CleanupPods</span><span class="params">(activePods []*api.Pod)</span></span> &#123;</div><div class="line">	desiredPods := <span class="built_in">make</span>(<span class="keyword">map</span>[types.UID]sets.Empty)</div><div class="line">	<span class="keyword">for</span> _, pod := <span class="keyword">range</span> activePods &#123;</div><div class="line">		desiredPods[pod.UID] = sets.Empty&#123;&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	m.workerLock.RLock()</div><div class="line">	<span class="keyword">defer</span> m.workerLock.RUnlock()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> key, worker := <span class="keyword">range</span> m.workers &#123;</div><div class="line">		<span class="keyword">if</span> _, ok := desiredPods[key.podUID]; !ok &#123;</div><div class="line">			worker.stop()</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="manager-UpdatePodStatus"><a href="#manager-UpdatePodStatus" class="headerlink" title="manager::UpdatePodStatus()"></a>manager::UpdatePodStatus()</h4><p>UpdatePodStatus()可以更新pod的status。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***此处有ready的逻辑****//</span></div><div class="line"><span class="comment">//***时时获取pod的ready状态***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manager)</span> <span class="title">UpdatePodStatus</span><span class="params">(podUID types.UID, podStatus *api.PodStatus)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i, c := <span class="keyword">range</span> podStatus.ContainerStatuses &#123;</div><div class="line">		<span class="keyword">var</span> ready <span class="keyword">bool</span></div><div class="line">		<span class="keyword">if</span> c.State.Running == <span class="literal">nil</span> &#123;</div><div class="line">			ready = <span class="literal">false</span></div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> result, ok := m.readinessManager.Get(kubecontainer.ParseContainerID(c.ContainerID)); ok &#123;</div><div class="line">			ready = result == results.Success</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// The check whether there is a probe which hasn't run yet.</span></div><div class="line">			_, exists := m.getWorker(podUID, c.Name, readiness)</div><div class="line">			ready = !exists</div><div class="line">		&#125;</div><div class="line">		podStatus.ContainerStatuses[i].Ready = ready</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// init containers are ready if they have exited with success or if a readiness probe has</span></div><div class="line">	<span class="comment">// succeeded.</span></div><div class="line">	<span class="keyword">for</span> i, c := <span class="keyword">range</span> podStatus.InitContainerStatuses &#123;</div><div class="line">		<span class="keyword">var</span> ready <span class="keyword">bool</span></div><div class="line">		<span class="keyword">if</span> c.State.Terminated != <span class="literal">nil</span> &amp;&amp; c.State.Terminated.ExitCode == <span class="number">0</span> &#123;</div><div class="line">			ready = <span class="literal">true</span></div><div class="line">		&#125;</div><div class="line">		podStatus.InitContainerStatuses[i].Ready = ready</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="manager-getWorker"><a href="#manager-getWorker" class="headerlink" title="manager::getWorker()"></a>manager::getWorker()</h4><p>getWorker()获取具体worker。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取具体worker***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manager)</span> <span class="title">getWorker</span><span class="params">(podUID types.UID, containerName <span class="keyword">string</span>, probeType probeType)</span> <span class="params">(*worker, <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	m.workerLock.RLock()</div><div class="line">	<span class="keyword">defer</span> m.workerLock.RUnlock()</div><div class="line">	worker, ok := m.workers[probeKey&#123;podUID, containerName, probeType&#125;]</div><div class="line">	<span class="keyword">return</span> worker, ok</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="manager-removeWorker"><a href="#manager-removeWorker" class="headerlink" title="manager::removeWorker()"></a>manager::removeWorker()</h4><p>removeWorker()删除某worker。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从workers中删除某一worker***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manager)</span> <span class="title">removeWorker</span><span class="params">(podUID types.UID, containerName <span class="keyword">string</span>, probeType probeType)</span></span> &#123;</div><div class="line">	m.workerLock.Lock()</div><div class="line">	<span class="keyword">defer</span> m.workerLock.Unlock()</div><div class="line">	<span class="built_in">delete</span>(m.workers, probeKey&#123;podUID, containerName, probeType&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="worker"><a href="#worker" class="headerlink" title="worker"></a>worker</h2><p>worker定义在/pkg/kubelet/prober/worker.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> worker <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// Channel for stopping the probe.</span></div><div class="line">	stopCh <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</div><div class="line"></div><div class="line">	<span class="comment">// The pod containing this probe (read-only)</span></div><div class="line">	pod *api.Pod</div><div class="line"></div><div class="line">	<span class="comment">// The container to probe (read-only)</span></div><div class="line">	container api.Container</div><div class="line"></div><div class="line">	<span class="comment">// Describes the probe configuration (read-only)</span></div><div class="line">	spec *api.Probe</div><div class="line"></div><div class="line">	<span class="comment">// The type of the worker.</span></div><div class="line">	probeType probeType</div><div class="line"></div><div class="line">	<span class="comment">// The probe value during the initial delay.</span></div><div class="line">	initialValue results.Result</div><div class="line"></div><div class="line">	<span class="comment">// Where to store this workers results.</span></div><div class="line">	resultsManager results.Manager</div><div class="line">	probeManager   *manager</div><div class="line"></div><div class="line">	<span class="comment">// The last known container ID for this worker.</span></div><div class="line">	containerID kubecontainer.ContainerID</div><div class="line">	<span class="comment">// The last probe result for this worker.</span></div><div class="line">	lastResult results.Result</div><div class="line">	<span class="comment">// How many times in a row the probe has returned the same result.</span></div><div class="line">	resultRun <span class="keyword">int</span></div><div class="line"></div><div class="line">	<span class="comment">// If set, skip probing.</span></div><div class="line">	onHold <span class="keyword">bool</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>worker可以执行检测操作。worker的主要字段如下：</p>
<ul>
<li>probeType: 标识该worker所属的类型，livenessProber或readinessProber；</li>
<li>resultsManager: 检测结果存在地；</li>
<li>probeManager: 包含该worker的probemanager；</li>
</ul>
<p>worker可以通过newWorker()生成：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Creates and starts a new probe worker.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newWorker</span><span class="params">(</span></span></div><div class="line">	m *manager,</div><div class="line">	probeType probeType,</div><div class="line">	pod *api.Pod,</div><div class="line">	container api.Container) *<span class="title">worker</span> &#123;</div><div class="line"></div><div class="line">	w := &amp;worker&#123;</div><div class="line">		stopCh:       <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">1</span>), <span class="comment">// Buffer so stop() can be non-blocking.</span></div><div class="line">		pod:          pod,</div><div class="line">		container:    container,</div><div class="line">		probeType:    probeType,</div><div class="line">		probeManager: m,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">switch</span> probeType &#123;</div><div class="line">	<span class="keyword">case</span> readiness:</div><div class="line">		w.spec = container.ReadinessProbe</div><div class="line">		w.resultsManager = m.readinessManager</div><div class="line">		w.initialValue = results.Failure</div><div class="line">	<span class="keyword">case</span> liveness:</div><div class="line">		w.spec = container.LivenessProbe</div><div class="line">		w.resultsManager = m.livenessManager</div><div class="line">		w.initialValue = results.Success</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> w</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，生成worker的时候，worker的resultsManager依据worker的类型为probeManager的readinessManager或livenessManager。</p>
<p>worker可以启动：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***启动worker***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *worker)</span> <span class="title">run</span><span class="params">()</span></span> &#123;</div><div class="line">	probeTickerPeriod := time.Duration(w.spec.PeriodSeconds) * time.Second</div><div class="line">	probeTicker := time.NewTicker(probeTickerPeriod)</div><div class="line"></div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="comment">// Clean up.</span></div><div class="line">		probeTicker.Stop()</div><div class="line">		<span class="keyword">if</span> !w.containerID.IsEmpty() &#123;</div><div class="line">			w.resultsManager.Remove(w.containerID)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		w.probeManager.removeWorker(w.pod.UID, w.container.Name, w.probeType)</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="comment">// If kubelet restarted the probes could be started in rapid succession.</span></div><div class="line">	<span class="comment">// Let the worker wait for a random portion of tickerPeriod before probing.</span></div><div class="line">	time.Sleep(time.Duration(rand.Float64() * <span class="keyword">float64</span>(probeTickerPeriod)))</div><div class="line"></div><div class="line">probeLoop:</div><div class="line">	<span class="comment">//***重复执行doProbe()***//</span></div><div class="line">	<span class="keyword">for</span> w.doProbe() &#123;</div><div class="line">		<span class="comment">// Wait for next probe tick.</span></div><div class="line">		<span class="keyword">select</span> &#123;</div><div class="line">		<span class="keyword">case</span> &lt;-w.stopCh:</div><div class="line">			<span class="keyword">break</span> probeLoop</div><div class="line">		<span class="comment">//***定时器***//</span></div><div class="line">		<span class="keyword">case</span> &lt;-probeTicker.C:</div><div class="line">			<span class="comment">// continue</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>run()会依据container的spec中设置的PeriodSeconds生成定时器，并依据定时器定时执行doProbe()。</p>
<p>doProbe()即执行检测的函数。容器会设置InitialDelaySeconds表示初始化需要的时间，如果在初始化时间内，那么livenessProber和readinessProber的worker都不会进行检测，而且检测结果的次数要超过阈值都会更新容器的状态，即把结果存储到resultsManager中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***执行检测***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *worker)</span> <span class="title">doProbe</span><span class="params">()</span> <span class="params">(keepGoing <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="built_in">recover</span>() &#125;() <span class="comment">// Actually eat panics (HandleCrash takes care of logging)</span></div><div class="line">	<span class="keyword">defer</span> runtime.HandleCrash(<span class="function"><span class="keyword">func</span><span class="params">(_ <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123; keepGoing = <span class="literal">true</span> &#125;)</div><div class="line"></div><div class="line">	<span class="comment">//***检测podStatus是否存在，如果不存在，则返回true***//</span></div><div class="line">	status, ok := w.probeManager.statusManager.GetPodStatus(w.pod.UID)</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="comment">// Either the pod has not been created yet, or it was already deleted.</span></div><div class="line">		glog.V(<span class="number">3</span>).Infof(<span class="string">"No status for pod: %v"</span>, format.Pod(w.pod))</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Worker should terminate if pod is terminated.</span></div><div class="line">	<span class="comment">//***如果pod的satus.Phase状态为api.PodFailed或apiPodSucceeded，则返回false***//</span></div><div class="line">	<span class="keyword">if</span> status.Phase == api.PodFailed || status.Phase == api.PodSucceeded &#123;</div><div class="line">		glog.V(<span class="number">3</span>).Infof(<span class="string">"Pod %v %v, exiting probe worker"</span>,</div><div class="line">			format.Pod(w.pod), status.Phase)</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	c, ok := api.GetContainerStatus(status.ContainerStatuses, w.container.Name)</div><div class="line">	<span class="keyword">if</span> !ok || <span class="built_in">len</span>(c.ContainerID) == <span class="number">0</span> &#123;</div><div class="line">		<span class="comment">// Either the container has not been created yet, or it was deleted.</span></div><div class="line">		glog.V(<span class="number">3</span>).Infof(<span class="string">"Probe target container not found: %v - %v"</span>,</div><div class="line">			format.Pod(w.pod), w.container.Name)</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span> <span class="comment">// Wait for more information.</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***新容器，重新启动对pod的检测***//</span></div><div class="line">	<span class="keyword">if</span> w.containerID.String() != c.ContainerID &#123;</div><div class="line">		<span class="keyword">if</span> !w.containerID.IsEmpty() &#123;</div><div class="line">			w.resultsManager.Remove(w.containerID)</div><div class="line">		&#125;</div><div class="line">		w.containerID = kubecontainer.ParseContainerID(c.ContainerID)</div><div class="line">		w.resultsManager.Set(w.containerID, w.initialValue, w.pod)</div><div class="line">		<span class="comment">// We've got a new container; resume probing.</span></div><div class="line">		w.onHold = <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***如果被锁住，则返回true，继续检测等待新容器的生成***//</span></div><div class="line">	<span class="keyword">if</span> w.onHold &#123;</div><div class="line">		<span class="comment">// Worker is on hold until there is a new container.</span></div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***容器不在运行状态***//</span></div><div class="line">	<span class="comment">//***如果容器被标记为删除，或重启策略为api.RestartPolicyNever，则返回false***//</span></div><div class="line">	<span class="keyword">if</span> c.State.Running == <span class="literal">nil</span> &#123;</div><div class="line">		glog.V(<span class="number">3</span>).Infof(<span class="string">"Non-running container probed: %v - %v"</span>,</div><div class="line">			format.Pod(w.pod), w.container.Name)</div><div class="line">		<span class="keyword">if</span> !w.containerID.IsEmpty() &#123;</div><div class="line">			w.resultsManager.Set(w.containerID, results.Failure, w.pod)</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// Abort if the container will not be restarted.</span></div><div class="line">		<span class="keyword">return</span> c.State.Terminated == <span class="literal">nil</span> ||</div><div class="line">			w.pod.Spec.RestartPolicy != api.RestartPolicyNever</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***如果启动时间还未超出设定时间，则直接返回true***//</span></div><div class="line">	<span class="comment">//***即pod在初始化阶段，不会进行liveness或readiness的检测***//</span></div><div class="line">	<span class="keyword">if</span> <span class="keyword">int32</span>(time.Since(c.State.Running.StartedAt.Time).Seconds()) &lt; w.spec.InitialDelaySeconds &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***调用probe()***//</span></div><div class="line">	result, err := w.probeManager.prober.probe(w.probeType, w.pod, status, w.container, w.containerID)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// Prober error, throw away the result.</span></div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> w.lastResult == result &#123;</div><div class="line">		w.resultRun++</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		w.lastResult = result</div><div class="line">		w.resultRun = <span class="number">1</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***未到阈值，返回true***//</span></div><div class="line">	<span class="keyword">if</span> (result == results.Failure &amp;&amp; w.resultRun &lt; <span class="keyword">int</span>(w.spec.FailureThreshold)) ||</div><div class="line">		(result == results.Success &amp;&amp; w.resultRun &lt; <span class="keyword">int</span>(w.spec.SuccessThreshold)) &#123;</div><div class="line">		<span class="comment">// Success or failure is below threshold - leave the probe state unchanged.</span></div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***超过阈值，则更新pod ready状态***//</span></div><div class="line">	w.resultsManager.Set(w.containerID, result, w.pod)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> w.probeType == liveness &amp;&amp; result == results.Failure &#123;</div><div class="line">		<span class="comment">// The container fails a liveness check, it will need to be restared.</span></div><div class="line">		<span class="comment">// Stop probing until we see a new container ID. This is to reduce the</span></div><div class="line">		<span class="comment">// chance of hitting #21751, where running `docker exec` when a</span></div><div class="line">		<span class="comment">// container is being stopped may lead to corrupted container state.</span></div><div class="line">		w.onHold = <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="resultManager"><a href="#resultManager" class="headerlink" title="resultManager"></a>resultManager</h2><p>resultManager定义在/pkg/kubelet/prober/results/results_manager.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> manager <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// guards the cache</span></div><div class="line">	sync.RWMutex</div><div class="line">	<span class="comment">// map of container ID -&gt; probe Result</span></div><div class="line">	cache <span class="keyword">map</span>[kubecontainer.ContainerID]Result</div><div class="line">	<span class="comment">// channel of updates</span></div><div class="line">	updates <span class="keyword">chan</span> Update</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> _ Manager = &amp;manager&#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">// NewManager creates ane returns an empty results manager.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewManager</span><span class="params">()</span> <span class="title">Manager</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;manager&#123;</div><div class="line">		cache:   <span class="built_in">make</span>(<span class="keyword">map</span>[kubecontainer.ContainerID]Result),</div><div class="line">		updates: <span class="built_in">make</span>(<span class="keyword">chan</span> Update, <span class="number">20</span>),</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，resultManager中有一个cache用来缓存container的检测结果，还有updates用于存放更新。</p>
<p>resultManager可以通过Get()方法从cache中直接获取result：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manager)</span> <span class="title">Get</span><span class="params">(id kubecontainer.ContainerID)</span> <span class="params">(Result, <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	m.RLock()</div><div class="line">	<span class="keyword">defer</span> m.RUnlock()</div><div class="line">	result, found := m.cache[id]</div><div class="line">	<span class="keyword">return</span> result, found</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过Set()方法可以向resultManager提交更新：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manager)</span> <span class="title">Set</span><span class="params">(id kubecontainer.ContainerID, result Result, pod *api.Pod)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> m.setInternal(id, result) &#123;</div><div class="line">		m.updates &lt;- Update&#123;id, result, pod.UID&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Internal helper for locked portion of set. Returns whether an update should be sent.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manager)</span> <span class="title">setInternal</span><span class="params">(id kubecontainer.ContainerID, result Result)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	m.Lock()</div><div class="line">	<span class="keyword">defer</span> m.Unlock()</div><div class="line">	prev, exists := m.cache[id]</div><div class="line">	<span class="keyword">if</span> !exists || prev != result &#123;</div><div class="line">		m.cache[id] = result</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Set()除了会更新cache外，还把更新放入updates channel中。</p>
<p>可以通过Updates()方法获取updates channel：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manager)</span> <span class="title">Updates</span><span class="params">()</span> &lt;-<span class="title">chan</span> <span class="title">Update</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> m.updates</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="prober"><a href="#prober" class="headerlink" title="prober"></a>prober</h2><p>prober可以执行具体的检测，定义在/pkg/kbuelet/prober/prober.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Prober helps to check the liveness/readiness of a container.</span></div><div class="line"><span class="keyword">type</span> prober <span class="keyword">struct</span> &#123;</div><div class="line">	exec   execprobe.ExecProber</div><div class="line">	http   httprobe.HTTPProber</div><div class="line">	tcp    tcprobe.TCPProber</div><div class="line">	runner kubecontainer.ContainerCommandRunner</div><div class="line"></div><div class="line">	refManager *kubecontainer.RefManager</div><div class="line">	recorder   record.EventRecorder</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>prober中定义了exec, http和tcp来表示三种检测方式。</p>
<p>可以通过newProber()来生成一个prober:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewProber creates a Prober, it takes a command runner and</span></div><div class="line"><span class="comment">// several container info managers.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newProber</span><span class="params">(</span></span></div><div class="line">	runner kubecontainer.ContainerCommandRunner,</div><div class="line">	refManager *kubecontainer.RefManager,</div><div class="line">	recorder record.EventRecorder) *<span class="title">prober</span> &#123;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;prober&#123;</div><div class="line">		exec:       execprobe.New(),</div><div class="line">		http:       httprobe.New(),</div><div class="line">		tcp:        tcprobe.New(),</div><div class="line">		runner:     runner,</div><div class="line">		refManager: refManager,</div><div class="line">		recorder:   recorder,</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以通过probe()方法进行检测：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***执行检测***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pb *prober)</span> <span class="title">probe</span><span class="params">(probeType probeType, pod *api.Pod, status api.PodStatus, container api.Container, containerID kubecontainer.ContainerID)</span> <span class="params">(results.Result, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> probeSpec *api.Probe</div><div class="line">	<span class="keyword">switch</span> probeType &#123;</div><div class="line">	<span class="keyword">case</span> readiness:</div><div class="line">		probeSpec = container.ReadinessProbe</div><div class="line">	<span class="keyword">case</span> liveness:</div><div class="line">		probeSpec = container.LivenessProbe</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> results.Failure, fmt.Errorf(<span class="string">"Unknown probe type: %q"</span>, probeType)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ctrName := fmt.Sprintf(<span class="string">"%s:%s"</span>, format.Pod(pod), container.Name)</div><div class="line">	<span class="keyword">if</span> probeSpec == <span class="literal">nil</span> &#123;</div><div class="line">		glog.Warningf(<span class="string">"%s probe for %s is nil"</span>, probeType, ctrName)</div><div class="line">		<span class="keyword">return</span> results.Success, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***调用runProbeWithRetries()***//</span></div><div class="line">	result, output, err := pb.runProbeWithRetries(probeSpec, pod, status, container, containerID, maxProbeRetries)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> || result != probe.Success &#123;</div><div class="line">		<span class="comment">// Probe failed in one way or another.</span></div><div class="line">		ref, hasRef := pb.refManager.GetRef(containerID)</div><div class="line">		<span class="keyword">if</span> !hasRef &#123;</div><div class="line">			glog.Warningf(<span class="string">"No ref for container %q (%s)"</span>, containerID.String(), ctrName)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			glog.V(<span class="number">1</span>).Infof(<span class="string">"%s probe for %q errored: %v"</span>, probeType, ctrName, err)</div><div class="line">			<span class="keyword">if</span> hasRef &#123;</div><div class="line">				pb.recorder.Eventf(ref, api.EventTypeWarning, events.ContainerUnhealthy, <span class="string">"%s probe errored: %v"</span>, probeType, err)</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123; <span class="comment">// result != probe.Success</span></div><div class="line">			glog.V(<span class="number">1</span>).Infof(<span class="string">"%s probe for %q failed (%v): %s"</span>, probeType, ctrName, result, output)</div><div class="line">			<span class="keyword">if</span> hasRef &#123;</div><div class="line">				pb.recorder.Eventf(ref, api.EventTypeWarning, events.ContainerUnhealthy, <span class="string">"%s probe failed: %s"</span>, probeType, output)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> results.Failure, err</div><div class="line">	&#125;</div><div class="line">	glog.V(<span class="number">3</span>).Infof(<span class="string">"%s probe for %q succeeded"</span>, probeType, ctrName)</div><div class="line">	<span class="keyword">return</span> results.Success, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>probe()主要调用了runProbeWithRetries()：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***对runProbe()的封装，可重复执行retries次***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pb *prober)</span> <span class="title">runProbeWithRetries</span><span class="params">(p *api.Probe, pod *api.Pod, status api.PodStatus, container api.Container, containerID kubecontainer.ContainerID, retries <span class="keyword">int</span>)</span> <span class="params">(probe.Result, <span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> err error</div><div class="line">	<span class="keyword">var</span> result probe.Result</div><div class="line">	<span class="keyword">var</span> output <span class="keyword">string</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; retries; i++ &#123;</div><div class="line">		result, output, err = pb.runProbe(p, pod, status, container, containerID)</div><div class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> result, output, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> result, output, err</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>runProbeWithRetries()可以多次调用runProbe()以确保检测执行成功，runProbe()定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***按照Exec, HTTPGet, TCPSocket的优先级执行检测***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pb *prober)</span> <span class="title">runProbe</span><span class="params">(p *api.Probe, pod *api.Pod, status api.PodStatus, container api.Container, containerID kubecontainer.ContainerID)</span> <span class="params">(probe.Result, <span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	timeout := time.Duration(p.TimeoutSeconds) * time.Second</div><div class="line">	<span class="keyword">if</span> p.Exec != <span class="literal">nil</span> &#123;</div><div class="line">		glog.V(<span class="number">4</span>).Infof(<span class="string">"Exec-Probe Pod: %v, Container: %v, Command: %v"</span>, pod, container, p.Exec.Command)</div><div class="line">		<span class="keyword">return</span> pb.exec.Probe(pb.newExecInContainer(container, containerID, p.Exec.Command, timeout))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> p.HTTPGet != <span class="literal">nil</span> &#123;</div><div class="line">		scheme := strings.ToLower(<span class="keyword">string</span>(p.HTTPGet.Scheme))</div><div class="line">		host := p.HTTPGet.Host</div><div class="line">		<span class="keyword">if</span> host == <span class="string">""</span> &#123;</div><div class="line">			host = status.PodIP</div><div class="line">		&#125;</div><div class="line">		port, err := extractPort(p.HTTPGet.Port, container)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> probe.Unknown, <span class="string">""</span>, err</div><div class="line">		&#125;</div><div class="line">		path := p.HTTPGet.Path</div><div class="line">		glog.V(<span class="number">4</span>).Infof(<span class="string">"HTTP-Probe Host: %v://%v, Port: %v, Path: %v"</span>, scheme, host, port, path)</div><div class="line">		url := formatURL(scheme, host, port, path)</div><div class="line">		headers := buildHeader(p.HTTPGet.HTTPHeaders)</div><div class="line">		glog.V(<span class="number">4</span>).Infof(<span class="string">"HTTP-Probe Headers: %v"</span>, headers)</div><div class="line">		<span class="keyword">return</span> pb.http.Probe(url, headers, timeout)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> p.TCPSocket != <span class="literal">nil</span> &#123;</div><div class="line">		port, err := extractPort(p.TCPSocket.Port, container)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> probe.Unknown, <span class="string">""</span>, err</div><div class="line">		&#125;</div><div class="line">		glog.V(<span class="number">4</span>).Infof(<span class="string">"TCP-Probe PodIP: %v, Port: %v, Timeout: %v"</span>, status.PodIP, port, timeout)</div><div class="line">		<span class="keyword">return</span> pb.tcp.Probe(status.PodIP, port, timeout)</div><div class="line">	&#125;</div><div class="line">	glog.Warningf(<span class="string">"Failed to find probe builder for container: %v"</span>, container)</div><div class="line">	<span class="keyword">return</span> probe.Unknown, <span class="string">""</span>, fmt.Errorf(<span class="string">"Missing probe handler for %s:%s"</span>, format.Pod(pod), container.Name)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>runProbe()按Exec, HTTPGet, TCPSocket的优先级执行检测，并返回结果。</p>
<h2 id="readinessManager"><a href="#readinessManager" class="headerlink" title="readinessManager"></a>readinessManager</h2><p>在proberManager中已经说过：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***go routine中的updateReadiness()方法***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *manager)</span> <span class="title">updateReadiness</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">//***获取readinessmanager的updates channel***//</span></div><div class="line">	update := &lt;-m.readinessManager.Updates()</div><div class="line"></div><div class="line">	ready := update.Result == results.Success</div><div class="line">	m.statusManager.SetContainerReadiness(update.PodUID, update.ContainerID, ready)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>SetContainerReadiness()会设置container的ready及pod的ready。这里不再展开分析。</p>
<h2 id="livenessManager"><a href="#livenessManager" class="headerlink" title="livenessManager"></a>livenessManager</h2><p>livenessManager是健康检测结果存储地。那么kubelet是如何感知到要重启容器的呢？<br>先来看/pkg/kbueelt/kubelet.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">klet.probeManager = prober.NewManager(</div><div class="line">		klet.statusManager,</div><div class="line">		klet.livenessManager,</div><div class="line">		klet.runner,</div><div class="line">		containerRefManager,</div><div class="line">		kubeDeps.Recorder)</div></pre></td></tr></table></figure></p>
<p>可以看到kubelet在生成proberManager时把自己的livenessManager传给了proberManager，所以容器检测结果也就存储在了kubelet的livenessManager中。<br>然后在生成dockerManager时，也把livenessManager传进去。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">"docker"</span>:</div><div class="line">			runtime := dockertools.NewDockerManager(</div><div class="line">				kubeDeps.DockerClient,</div><div class="line">				kubecontainer.FilterEventRecorder(kubeDeps.Recorder),</div><div class="line">				klet.livenessManager,</div><div class="line">				containerRefManager,</div><div class="line">				klet.podManager</div><div class="line">				......</div></pre></td></tr></table></figure></p>
<p>所以在/pkg/kubelet/dockertolls/docker_manager.go中的computePodContainerChanges()中有：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">liveness, found := dm.livenessManager.Get(containerStatus.ID)</div><div class="line"><span class="keyword">if</span> !found || liveness == proberesults.Success &#123;</div><div class="line">	containersToKeep[containerID] = index</div><div class="line">	<span class="keyword">continue</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>即如果不在livenessManager，或状态为Success的，则是需要维持不变的；反过来说，如果在livenessManager中，且状态为Failed的，则需要重启。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/12/20/kubelet分析(六)-proberManager-v1-5-2/" data-id="cjbf1wv4g004wswqs4x5kpzgw" class="article-share-link">分享</a><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></div><div class="post-nav"><a href="/2017/12/18/kubelet分析(五)-podManager-v1-5-2/" class="next">kubelet分析(五)-podManager-v1.5.2</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/20/kubelet分析(六)-proberManager-v1-5-2/">kubelet分析(六)-proberManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/18/kubelet分析(五)-podManager-v1-5-2/">kubelet分析(五)-podManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(四)-statusManager-v1-5-2/">kubelet分析(四)-statusManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(三)-volumeManager-v1-5-2/">kubelet分析(三)-volumeManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/kubelet分析(二)-podWorker-v1-5-2/">kubelet分析(二)-podWorker-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/kubelet分析(一)-config-v1-5-2/">kubelet分析(一)-config-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/15/storage解读(六)-strategy-v1-5-2/">storage解读(六)-strategy-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/14/kubernetes-listwatch机制-v1-5-2/">kubernetes-listwatch机制-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/kubernetes-添加controller-demo-v1-5-2/">kubernetes-添加controller-demo-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/kubernetes-添加资源-demo-v1-5-2/">kubernetes-添加资源-demo-v1.5.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>