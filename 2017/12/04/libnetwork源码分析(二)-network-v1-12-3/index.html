<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>libnetwork源码分析(二)-network-v1-12-3 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">libnetwork源码分析(二)-network-v1-12-3</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">libnetwork源码分析(二)-network-v1-12-3</h1><div class="post-meta">Dec 4, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>之前分析了controller的主要功能，在分析管理network时，并未对network作出详细分析。本次将对network作出分析。</p>
<h2 id="network"><a href="#network" class="headerlink" title="network"></a>network</h2><p>libnetwork代表一个网络，网络中可以放入endpoint。在bridge模式下，可以把network理解成bridge。network定义在/libnetwork/network.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> network <span class="keyword">struct</span> &#123;</div><div class="line">	ctrlr        *controller</div><div class="line">	name         <span class="keyword">string</span></div><div class="line">	networkType  <span class="keyword">string</span></div><div class="line">	id           <span class="keyword">string</span></div><div class="line">	scope        <span class="keyword">string</span></div><div class="line">	labels       <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></div><div class="line">	ipamType     <span class="keyword">string</span></div><div class="line">	ipamOptions  <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></div><div class="line">	addrSpace    <span class="keyword">string</span></div><div class="line">	ipamV4Config []*IpamConf</div><div class="line">	ipamV6Config []*IpamConf</div><div class="line">	ipamV4Info   []*IpamInfo</div><div class="line">	ipamV6Info   []*IpamInfo</div><div class="line">	enableIPv6   <span class="keyword">bool</span></div><div class="line">	postIPv6     <span class="keyword">bool</span></div><div class="line">	epCnt        *endpointCnt</div><div class="line">	generic      options.Generic</div><div class="line">	dbIndex      <span class="keyword">uint64</span></div><div class="line">	dbExists     <span class="keyword">bool</span></div><div class="line">	persist      <span class="keyword">bool</span></div><div class="line">	stopWatchCh  <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</div><div class="line">	drvOnce      *sync.Once</div><div class="line">	internal     <span class="keyword">bool</span></div><div class="line">	inDelete     <span class="keyword">bool</span></div><div class="line">	ingress      <span class="keyword">bool</span></div><div class="line">	driverTables []<span class="keyword">string</span></div><div class="line">	dynamic      <span class="keyword">bool</span></div><div class="line">	sync.Mutex</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们把network的功能分为network本身操作和endpoint管理两部分。</p>
<h3 id="network本身操作"><a href="#network本身操作" class="headerlink" title="network本身操作"></a>network本身操作</h3><h4 id="network-Scope"><a href="#network-Scope" class="headerlink" title="network:Scope()"></a>network:Scope()</h4><p>Scope()返回network的scope。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *network)</span> <span class="title">DataScope</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> n.Scope()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *network)</span> <span class="title">Scope</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	n.Lock()</div><div class="line">	<span class="keyword">defer</span> n.Unlock()</div><div class="line">	<span class="keyword">return</span> n.scope</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="controller-Delete"><a href="#controller-Delete" class="headerlink" title="controller:Delete()"></a>controller:Delete()</h4><p>Delete()可以删除本network。Delete()主要调用了delete()，delete()流程如下：</p>
<ol>
<li>从store中获取最新的network；</li>
<li>调用deleteNetwork()方法删除底层的network；</li>
<li>释放IPAM；</li>
<li>从store中删除endpointCount和network。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***删除network***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *network)</span> <span class="title">Delete</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> n.<span class="built_in">delete</span>(<span class="literal">false</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***删除network的实现***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *network)</span> <span class="title">delete</span><span class="params">(force <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	n.Lock()</div><div class="line">	c := n.ctrlr</div><div class="line">	name := n.name</div><div class="line">	id := n.id</div><div class="line">	n.Unlock()</div><div class="line"></div><div class="line">	<span class="comment">//***从store最新获取network***//</span></div><div class="line">	n, err := c.getNetworkFromStore(id)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> &amp;UnknownNetworkError&#123;name: name, id: id&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> !force &amp;&amp; n.getEpCnt().EndpointCnt() != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> &amp;ActiveEndpointsError&#123;name: n.name, id: n.id&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Mark the network for deletion</span></div><div class="line">	n.inDelete = <span class="literal">true</span></div><div class="line">	<span class="keyword">if</span> err = c.updateToStore(n); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"error marking network %s (%s) for deletion: %v"</span>, n.Name(), n.ID(), err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***调用deleteNetwork()方法***//</span></div><div class="line">	<span class="keyword">if</span> err = n.deleteNetwork(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> !force &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		log.Debugf(<span class="string">"driver failed to delete stale network %s (%s): %v"</span>, n.Name(), n.ID(), err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***释放IPAM***//</span></div><div class="line">	n.ipamRelease()</div><div class="line">	<span class="keyword">if</span> err = c.updateToStore(n); err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Warnf(<span class="string">"Failed to update store after ipam release for network %s (%s): %v"</span>, n.Name(), n.ID(), err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// We are about to delete the network. Leave the gossip</span></div><div class="line">	<span class="comment">// cluster for the network to stop all incoming network</span></div><div class="line">	<span class="comment">// specific gossip updates before cleaning up all the service</span></div><div class="line">	<span class="comment">// bindings for the network. But cleanup service binding</span></div><div class="line">	<span class="comment">// before deleting the network from the store since service</span></div><div class="line">	<span class="comment">// bindings cleanup requires the network in the store.</span></div><div class="line">	n.cancelDriverWatches()</div><div class="line">	<span class="keyword">if</span> err = n.leaveCluster(); err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Errorf(<span class="string">"Failed leaving network %s from the agent cluster: %v"</span>, n.Name(), err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	c.cleanupServiceBindings(n.ID())</div><div class="line"></div><div class="line">	<span class="comment">// deleteFromStore performs an atomic delete operation and the</span></div><div class="line">	<span class="comment">// network.epCnt will help prevent any possible</span></div><div class="line">	<span class="comment">// race between endpoint join and network delete</span></div><div class="line">	<span class="comment">//***从store中删除endpointCount***//</span></div><div class="line">	<span class="keyword">if</span> err = c.deleteFromStore(n.getEpCnt()); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> !force &#123;</div><div class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"error deleting network endpoint count from store: %v"</span>, err)</div><div class="line">		&#125;</div><div class="line">		log.Debugf(<span class="string">"Error deleting endpoint count from store for stale network %s (%s) for deletion: %v"</span>, n.Name(), n.ID(), err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***从store中删除network***//</span></div><div class="line">	<span class="keyword">if</span> err = c.deleteFromStore(n); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"error deleting network from store: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="network-deleteNetwork"><a href="#network-deleteNetwork" class="headerlink" title="network::deleteNetwork()"></a>network::deleteNetwork()</h4><p>deleteNetwork()通过调用driver的Deletenetwork()删除底层的network。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *network)</span> <span class="title">deleteNetwork</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***获取driver***//</span></div><div class="line">	d, err := n.driver(<span class="literal">true</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed deleting network: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***调用driver的DeleteNetwork()方法***//</span></div><div class="line">	<span class="keyword">if</span> err := d.DeleteNetwork(n.ID()); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// Forbidden Errors should be honored</span></div><div class="line">		<span class="keyword">if</span> _, ok := err.(types.ForbiddenError); ok &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> _, ok := err.(types.MaskableError); !ok &#123;</div><div class="line">			log.Warnf(<span class="string">"driver error deleting network %s : %v"</span>, n.name, err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="network-driver"><a href="#network-driver" class="headerlink" title="network::driver()"></a>network::driver()</h4><p>driver()返回network对应的driver。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *network)</span> <span class="title">driver</span><span class="params">(load <span class="keyword">bool</span>)</span> <span class="params">(driverapi.Driver, error)</span></span> &#123;</div><div class="line">	<span class="comment">//***获取driver和capability***//</span></div><div class="line">	d, <span class="built_in">cap</span>, err := n.resolveDriver(n.networkType, load)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	c := n.getController()</div><div class="line">	isAgent := c.isAgent()</div><div class="line">	n.Lock()</div><div class="line">	<span class="comment">// If load is not required, driver, cap and err may all be nil</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">cap</span> != <span class="literal">nil</span> &#123;</div><div class="line">		n.scope = <span class="built_in">cap</span>.DataScope</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> isAgent || n.dynamic &#123;</div><div class="line">		<span class="comment">// If we are running in agent mode then all networks</span></div><div class="line">		<span class="comment">// in libnetwork are local scope regardless of the</span></div><div class="line">		<span class="comment">// backing driver.</span></div><div class="line">		n.scope = datastore.LocalScope</div><div class="line">	&#125;</div><div class="line">	n.Unlock()</div><div class="line">	<span class="keyword">return</span> d, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *network)</span> <span class="title">resolveDriver</span><span class="params">(name <span class="keyword">string</span>, load <span class="keyword">bool</span>)</span> <span class="params">(driverapi.Driver, *driverapi.Capability, error)</span></span> &#123;</div><div class="line">	<span class="comment">//***获取network的controller***//</span></div><div class="line">	c := n.getController()</div><div class="line"></div><div class="line">	<span class="comment">// Check if a driver for the specified network type is available</span></div><div class="line">	<span class="comment">//***从controller的drvRegistry中获取driver***//</span></div><div class="line">	d, <span class="built_in">cap</span> := c.drvRegistry.Driver(name)</div><div class="line">	<span class="keyword">if</span> d == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> load &#123;</div><div class="line">			<span class="keyword">var</span> err error</div><div class="line">			err = c.loadDriver(name)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			d, <span class="built_in">cap</span> = c.drvRegistry.Driver(name)</div><div class="line">			<span class="keyword">if</span> d == <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">"could not resolve driver %s in registry"</span>, name)</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// don't fail if driver loading is not required</span></div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> d, <span class="built_in">cap</span>, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="管理endpoint"><a href="#管理endpoint" class="headerlink" title="管理endpoint"></a>管理endpoint</h3><p>network通过store管理endpoint。</p>
<h4 id="network-EndpointByID"><a href="#network-EndpointByID" class="headerlink" title="network::EndpointByID()"></a>network::EndpointByID()</h4><p>EndpointByID()可以通过id获取endpoint。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *network)</span> <span class="title">EndpointByID</span><span class="params">(id <span class="keyword">string</span>)</span> <span class="params">(Endpoint, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> id == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, ErrInvalidID(id)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ep, err := n.getEndpointFromStore(id)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, ErrNoSuchEndpoint(id)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> ep, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="network-EndpointByName"><a href="#network-EndpointByName" class="headerlink" title="network::EndpointByName()"></a>network::EndpointByName()</h4><p>EndpointByName()依据name获取endpoint。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *network)</span> <span class="title">EndpointByName</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(Endpoint, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> name == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, ErrInvalidName(name)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">var</span> e Endpoint</div><div class="line"></div><div class="line">	s := <span class="function"><span class="keyword">func</span><span class="params">(current Endpoint)</span> <span class="title">bool</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> current.Name() == name &#123;</div><div class="line">			e = current</div><div class="line">			<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	n.WalkEndpoints(s)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> e == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, ErrNoSuchEndpoint(name)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> e, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="network-Endpoints"><a href="#network-Endpoints" class="headerlink" title="network::Endpoints()"></a>network::Endpoints()</h4><p>Endpoints()可以从network中获取endpoint列表。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取endpoint列表***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *network)</span> <span class="title">Endpoints</span><span class="params">()</span> []<span class="title">Endpoint</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> list []Endpoint</div><div class="line"></div><div class="line">	<span class="comment">//***调用getEndpointsFromStore()直接从store中获取endpoints***//</span></div><div class="line">	endpoints, err := n.getEndpointsFromStore()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Error(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, ep := <span class="keyword">range</span> endpoints &#123;</div><div class="line">		list = <span class="built_in">append</span>(list, ep)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> list</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="network-WalkEndpoints"><a href="#network-WalkEndpoints" class="headerlink" title="network::WalkEndpoints()"></a>network::WalkEndpoints()</h4><p>WalkEndpoints()可以轮询所有endpoint，直到walker()返回true。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *network)</span> <span class="title">WalkEndpoints</span><span class="params">(walker EndpointWalker)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, e := <span class="keyword">range</span> n.Endpoints() &#123;</div><div class="line">		<span class="keyword">if</span> walker(e) &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="network-CreateEndpoint"><a href="#network-CreateEndpoint" class="headerlink" title="network::CreateEndpoint()"></a>network::CreateEndpoint()</h4><p>CreateEndpoint()创建一对vethpair，并把vethpair的一端绑定到network中。流程如下：</p>
<ol>
<li>验证endpoint是否存在，如果存在，则直接返回；</li>
<li>生成endpoint结构体值；</li>
<li>设置IP；</li>
<li>调用addEndpoint；</li>
<li>存储endpoint。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***创建endpoint***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *network)</span> <span class="title">CreateEndpoint</span><span class="params">(name <span class="keyword">string</span>, options ...EndpointOption)</span> <span class="params">(Endpoint, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> err error</div><div class="line">	<span class="keyword">if</span> !config.IsValidName(name) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, ErrInvalidName(name)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***验证endpoint是否存在***//</span></div><div class="line">	<span class="keyword">if</span> _, err = n.EndpointByName(name); err == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, types.ForbiddenErrorf(<span class="string">"service endpoint with name %s already exists"</span>, name)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***生成endpoint结构体值***//</span></div><div class="line">	ep := &amp;endpoint&#123;name: name, generic: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;), iface: &amp;endpointInterface&#123;&#125;&#125;</div><div class="line">	ep.id = stringid.GenerateRandomID()</div><div class="line"></div><div class="line">	<span class="comment">// Initialize ep.network with a possibly stale copy of n. We need this to get network from</span></div><div class="line">	<span class="comment">// store. But once we get it from store we will have the most uptodate copy possibly.</span></div><div class="line">	ep.network = n</div><div class="line">	ep.locator = n.getController().clusterHostID()</div><div class="line">	ep.network, err = ep.getNetworkFromStore()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"failed to get network during CreateEndpoint: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line">	n = ep.network</div><div class="line"></div><div class="line">	ep.processOptions(options...)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, llIPNet := <span class="keyword">range</span> ep.Iface().LinkLocalAddresses() &#123;</div><div class="line">		<span class="keyword">if</span> !llIPNet.IP.IsLinkLocalUnicast() &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, types.BadRequestErrorf(<span class="string">"invalid link local IP address: %v"</span>, llIPNet.IP)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> opt, ok := ep.generic[netlabel.MacAddress]; ok &#123;</div><div class="line">		<span class="keyword">if</span> mac, ok := opt.(net.HardwareAddr); ok &#123;</div><div class="line">			ep.iface.mac = mac</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***获取ipam***//</span></div><div class="line">	ipam, <span class="built_in">cap</span>, err := n.getController().getIPAMDriver(n.ipamType)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">cap</span>.RequiresMACAddress &#123;</div><div class="line">		<span class="keyword">if</span> ep.iface.mac == <span class="literal">nil</span> &#123;</div><div class="line">			ep.iface.mac = netutils.GenerateRandomMAC()</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> ep.ipamOptions == <span class="literal">nil</span> &#123;</div><div class="line">			ep.ipamOptions = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</div><div class="line">		&#125;</div><div class="line">		ep.ipamOptions[netlabel.MacAddress] = ep.iface.mac.String()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***生成并设置ipv4的ip***//</span></div><div class="line">	<span class="keyword">if</span> err = ep.assignAddress(ipam, <span class="literal">true</span>, n.enableIPv6 &amp;&amp; !n.postIPv6); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			ep.releaseAddress()</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="comment">//***调用addEndpoint()***//</span></div><div class="line">	<span class="keyword">if</span> err = n.addEndpoint(ep); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> e := ep.deleteEndpoint(<span class="literal">false</span>); e != <span class="literal">nil</span> &#123;</div><div class="line">				log.Warnf(<span class="string">"cleaning up endpoint failed %s : %v"</span>, name, e)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="comment">//***生成并设置ipv6的ip***//</span></div><div class="line">	<span class="keyword">if</span> err = ep.assignAddress(ipam, <span class="literal">false</span>, n.enableIPv6 &amp;&amp; n.postIPv6); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***更新ep***//</span></div><div class="line">	<span class="keyword">if</span> err = n.getController().updateToStore(ep); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> e := n.getController().deleteFromStore(ep); e != <span class="literal">nil</span> &#123;</div><div class="line">				log.Warnf(<span class="string">"error rolling back endpoint %s from store: %v"</span>, name, e)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="comment">// Watch for service records</span></div><div class="line">	n.getController().watchSvcRecord(ep)</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			n.getController().unWatchSvcRecord(ep)</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="comment">// Increment endpoint count to indicate completion of endpoint addition</span></div><div class="line">	<span class="keyword">if</span> err = n.getEpCnt().IncEndpointCnt(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> ep, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="network-addEndpoint"><a href="#network-addEndpoint" class="headerlink" title="network::addEndpoint()"></a>network::addEndpoint()</h4><p>addEndpoint()调用driver的CreateEndpoint()生成endpoint<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *network)</span> <span class="title">addEndpoint</span><span class="params">(ep *endpoint)</span> <span class="title">error</span></span> &#123;</div><div class="line">	d, err := n.driver(<span class="literal">true</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to add endpoint: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***调用driver的CreateEndpoint(***//</span></div><div class="line">	err = d.CreateEndpoint(n.id, ep.id, ep.Interface(), ep.generic)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> types.InternalErrorf(<span class="string">"failed to create endpoint %s on network %s: %v"</span>,</div><div class="line">			ep.Name(), n.Name(), err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以bridge为例，driver的CreateEndpoint()定义在/libnetwork/drivers/bridge/bridge.go中：</p>
<h4 id="driver-CreateEndpoint"><a href="#driver-CreateEndpoint" class="headerlink" title="driver::CreateEndpoint()"></a>driver::CreateEndpoint()</h4><p>CreateEndpoint()的流程如下：</p>
<ol>
<li>获取network；</li>
<li>获取endpoint；</li>
<li>生成hostIfName, containerIfName；</li>
<li>创建vethpair；</li>
<li>把vethpair的host端添加到bridge上；</li>
<li>把vethpair的sandbox端的信息保存在endpoint中；</li>
<li>启用vethpair的host端；</li>
<li>更新endpoint。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***创建endpoint***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *driver)</span> <span class="title">CreateEndpoint</span><span class="params">(nid, eid <span class="keyword">string</span>, ifInfo driverapi.InterfaceInfo, epOptions <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> osl.InitOSContext()()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ifInfo == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"invalid interface info passed"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Get the network handler and make sure it exists</span></div><div class="line">	d.Lock()</div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***获取network***//</span></div><div class="line">	n, ok := d.networks[nid]</div><div class="line">	dconfig := d.config</div><div class="line">	d.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> types.NotFoundErrorf(<span class="string">"network %s does not exist"</span>, nid)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> n == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> driverapi.ErrNoNetwork(nid)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Sanity check</span></div><div class="line">	n.Lock()</div><div class="line">	<span class="keyword">if</span> n.id != nid &#123;</div><div class="line">		n.Unlock()</div><div class="line">		<span class="keyword">return</span> InvalidNetworkIDError(nid)</div><div class="line">	&#125;</div><div class="line">	n.Unlock()</div><div class="line"></div><div class="line">	<span class="comment">// Check if endpoint id is good and retrieve correspondent endpoint</span></div><div class="line">	<span class="comment">//***获取endpoint，如果存在，则报错***//</span></div><div class="line">	ep, err := n.getEndpoint(eid)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Endpoint with that id exists either on desired or other sandbox</span></div><div class="line">	<span class="keyword">if</span> ep != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> driverapi.ErrEndpointExists(eid)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Try to convert the options to endpoint configuration</span></div><div class="line">	epConfig, err := parseEndpointOptions(epOptions)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Create and add the endpoint</span></div><div class="line">	n.Lock()</div><div class="line">	endpoint := &amp;bridgeEndpoint&#123;id: eid, nid: nid, config: epConfig&#125;</div><div class="line">	n.endpoints[eid] = endpoint</div><div class="line">	n.Unlock()</div><div class="line"></div><div class="line">	<span class="comment">// On failure make sure to remove the endpoint</span></div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			n.Lock()</div><div class="line">			<span class="built_in">delete</span>(n.endpoints, eid)</div><div class="line">			n.Unlock()</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="comment">// Generate a name for what will be the host side pipe interface</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***生成hostIfName***//</span></div><div class="line">	hostIfName, err := netutils.GenerateIfaceName(d.nlh, vethPrefix, vethLen)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Generate a name for what will be the sandbox side pipe interface</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***生成containerIfName***//</span></div><div class="line">	containerIfName, err := netutils.GenerateIfaceName(d.nlh, vethPrefix, vethLen)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Generate and add the interface pipe host &lt;-&gt; sandbox</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***创建vethpair***//</span></div><div class="line">	<span class="comment">//***hostIfName:  veth9c84272     containerIfName:  veth50870f7***//</span></div><div class="line">	veth := &amp;netlink.Veth&#123;</div><div class="line">		LinkAttrs: netlink.LinkAttrs&#123;Name: hostIfName, TxQLen: <span class="number">0</span>&#125;,</div><div class="line">		PeerName:  containerIfName&#125;</div><div class="line">	<span class="keyword">if</span> err = d.nlh.LinkAdd(veth); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> types.InternalErrorf(<span class="string">"failed to add the host (%s) &lt;=&gt; sandbox (%s) pair interfaces: %v"</span>, hostIfName, containerIfName, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Get the host side pipe interface handler</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***获取host端的handler***//</span></div><div class="line">	host, err := d.nlh.LinkByName(hostIfName)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> types.InternalErrorf(<span class="string">"failed to find host side interface %s: %v"</span>, hostIfName, err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			d.nlh.LinkDel(host)</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="comment">// Get the sandbox side pipe interface handler</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***获取sandbox端的handler***//</span></div><div class="line">	sbox, err := d.nlh.LinkByName(containerIfName)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> types.InternalErrorf(<span class="string">"failed to find sandbox side interface %s: %v"</span>, containerIfName, err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			d.nlh.LinkDel(sbox)</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	n.Lock()</div><div class="line">	config := n.config</div><div class="line">	n.Unlock()</div><div class="line"></div><div class="line">	<span class="comment">// Add bridge inherited attributes to pipe interfaces</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***设置link端的MTU***//</span></div><div class="line">	<span class="keyword">if</span> config.Mtu != <span class="number">0</span> &#123;</div><div class="line">		err = d.nlh.LinkSetMTU(host, config.Mtu)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> types.InternalErrorf(<span class="string">"failed to set MTU on host interface %s: %v"</span>, hostIfName, err)</div><div class="line">		&#125;</div><div class="line">		err = d.nlh.LinkSetMTU(sbox, config.Mtu)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> types.InternalErrorf(<span class="string">"failed to set MTU on sandbox interface %s: %v"</span>, containerIfName, err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Attach host side pipe interface into the bridge</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***把vethpair的host端添加到bridge上***//</span></div><div class="line">	<span class="comment">//***config.BridgeName:  docker0***//</span></div><div class="line">	<span class="keyword">if</span> err = addToBridge(d.nlh, hostIfName, config.BridgeName); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"adding interface %s to bridge %s failed: %v"</span>, hostIfName, config.BridgeName, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> !dconfig.EnableUserlandProxy &#123;</div><div class="line">		<span class="comment">//***Fankang***//</span></div><div class="line">		<span class="comment">//***设置Hairpin***//</span></div><div class="line">		err = setHairpinMode(d.nlh, host, <span class="literal">true</span>)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Store the sandbox side pipe interface parameters</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***把sandbox端的信息保存在endpoint中***//</span></div><div class="line">	endpoint.srcName = containerIfName</div><div class="line">	endpoint.macAddress = ifInfo.MacAddress()</div><div class="line">	endpoint.addr = ifInfo.Address()</div><div class="line">	endpoint.addrv6 = ifInfo.AddressIPv6()</div><div class="line"></div><div class="line">	<span class="comment">// Set the sbox's MAC if not provided. If specified, use the one configured by user, otherwise generate one based on IP.</span></div><div class="line">	<span class="keyword">if</span> endpoint.macAddress == <span class="literal">nil</span> &#123;</div><div class="line">		endpoint.macAddress = electMacAddress(epConfig, endpoint.addr.IP)</div><div class="line">		<span class="keyword">if</span> err = ifInfo.SetMacAddress(endpoint.macAddress); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Up the host interface after finishing all netlink configuration</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***启用host端***//</span></div><div class="line">	<span class="keyword">if</span> err = d.nlh.LinkSetUp(host); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"could not set link up for host interface %s: %v"</span>, hostIfName, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> endpoint.addrv6 == <span class="literal">nil</span> &amp;&amp; config.EnableIPv6 &#123;</div><div class="line">		<span class="keyword">var</span> ip6 net.IP</div><div class="line">		network := n.bridge.bridgeIPv6</div><div class="line">		<span class="keyword">if</span> config.AddressIPv6 != <span class="literal">nil</span> &#123;</div><div class="line">			network = config.AddressIPv6</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		ones, _ := network.Mask.Size()</div><div class="line">		<span class="keyword">if</span> ones &gt; <span class="number">80</span> &#123;</div><div class="line">			err = types.ForbiddenErrorf(<span class="string">"Cannot self generate an IPv6 address on network %v: At least 48 host bits are needed."</span>, network)</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		ip6 = <span class="built_in">make</span>(net.IP, <span class="built_in">len</span>(network.IP))</div><div class="line">		<span class="built_in">copy</span>(ip6, network.IP)</div><div class="line">		<span class="keyword">for</span> i, h := <span class="keyword">range</span> endpoint.macAddress &#123;</div><div class="line">			ip6[i+<span class="number">10</span>] = h</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		endpoint.addrv6 = &amp;net.IPNet&#123;IP: ip6, Mask: network.Mask&#125;</div><div class="line">		<span class="keyword">if</span> err = ifInfo.SetIPAddress(endpoint.addrv6); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***更新endpoint***//</span></div><div class="line">	<span class="keyword">if</span> err = d.storeUpdate(endpoint); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to save bridge endpoint %s to store: %v"</span>, endpoint.id[<span class="number">0</span>:<span class="number">7</span>], err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="endpoint"><a href="#endpoint" class="headerlink" title="endpoint"></a>endpoint</h3><p>最后一个小节，我们来看下endpoint的Delete()和Join()实现。</p>
<h4 id="endpiont-Delete"><a href="#endpiont-Delete" class="headerlink" title="endpiont::Delete()"></a>endpiont::Delete()</h4><p>Delete()可以删除本endpoint。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ep *endpoint)</span> <span class="title">Delete</span><span class="params">(force <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> err error</div><div class="line">	n, err := ep.getNetworkFromStore()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to get network during Delete: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ep, err = n.getEndpointFromStore(ep.ID())</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to get endpoint from store during Delete: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ep.Lock()</div><div class="line">	epid := ep.id</div><div class="line">	name := ep.name</div><div class="line">	sbid := ep.sandboxID</div><div class="line">	ep.Unlock()</div><div class="line"></div><div class="line">	sb, _ := n.getController().SandboxByID(sbid)</div><div class="line">	<span class="keyword">if</span> sb != <span class="literal">nil</span> &amp;&amp; !force &#123;</div><div class="line">		<span class="keyword">return</span> &amp;ActiveContainerError&#123;name: name, id: epid&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> sb != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> e := ep.sbLeave(sb.(*sandbox), force); e != <span class="literal">nil</span> &#123;</div><div class="line">			log.Warnf(<span class="string">"failed to leave sandbox for endpoint %s : %v"</span>, name, e)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***从store中删除endpoint***//</span></div><div class="line">	<span class="keyword">if</span> err = n.getController().deleteFromStore(ep); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; !force &#123;</div><div class="line">			ep.dbExists = <span class="literal">false</span></div><div class="line">			<span class="keyword">if</span> e := n.getController().updateToStore(ep); e != <span class="literal">nil</span> &#123;</div><div class="line">				log.Warnf(<span class="string">"failed to recreate endpoint in store %s : %v"</span>, name, e)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="comment">// unwatch for service records</span></div><div class="line">	n.getController().unWatchSvcRecord(ep)</div><div class="line"></div><div class="line">	<span class="comment">//***调用deleteEndpoint()***//</span></div><div class="line">	<span class="keyword">if</span> err = ep.deleteEndpoint(force); err != <span class="literal">nil</span> &amp;&amp; !force &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ep.releaseAddress()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := n.getEpCnt().DecEndpointCnt(); err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Warnf(<span class="string">"failed to decrement endpoint coint for ep %s: %v"</span>, ep.ID(), err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ep *endpoint)</span> <span class="title">deleteEndpoint</span><span class="params">(force <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	ep.Lock()</div><div class="line">	n := ep.network</div><div class="line">	name := ep.name</div><div class="line">	epid := ep.id</div><div class="line">	ep.Unlock()</div><div class="line"></div><div class="line">	driver, err := n.driver(!force)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to delete endpoint: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> driver == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***调用driver的DeleteEndpoint()***//</span></div><div class="line">	<span class="keyword">if</span> err := driver.DeleteEndpoint(n.id, epid); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> _, ok := err.(types.ForbiddenError); ok &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> _, ok := err.(types.MaskableError); !ok &#123;</div><div class="line">			log.Warnf(<span class="string">"driver error deleting endpoint %s : %v"</span>, name, err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以bridge为例，driver的DeleteEndpoint()定义在/libnetwork/drivers/bridge/bridge.go中：</p>
<h4 id="driver-DeleteEndpoint"><a href="#driver-DeleteEndpoint" class="headerlink" title="driver::DeleteEndpoint()"></a>driver::DeleteEndpoint()</h4><p>DeleteEndpoint()完成vethpair的删除。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***删除endpoint***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *driver)</span> <span class="title">DeleteEndpoint</span><span class="params">(nid, eid <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> err error</div><div class="line"></div><div class="line">	<span class="keyword">defer</span> osl.InitOSContext()()</div><div class="line"></div><div class="line">	<span class="comment">// Get the network handler and make sure it exists</span></div><div class="line">	d.Lock()</div><div class="line">	n, ok := d.networks[nid]</div><div class="line">	d.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> types.InternalMaskableErrorf(<span class="string">"network %s does not exist"</span>, nid)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> n == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> driverapi.ErrNoNetwork(nid)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Sanity Check</span></div><div class="line">	n.Lock()</div><div class="line">	<span class="keyword">if</span> n.id != nid &#123;</div><div class="line">		n.Unlock()</div><div class="line">		<span class="keyword">return</span> InvalidNetworkIDError(nid)</div><div class="line">	&#125;</div><div class="line">	n.Unlock()</div><div class="line"></div><div class="line">	<span class="comment">// Check endpoint id and if an endpoint is actually there</span></div><div class="line">	ep, err := n.getEndpoint(eid)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> ep == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> EndpointNotFoundError(eid)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Remove it</span></div><div class="line">	n.Lock()</div><div class="line">	<span class="built_in">delete</span>(n.endpoints, eid)</div><div class="line">	n.Unlock()</div><div class="line"></div><div class="line">	<span class="comment">// On failure make sure to set back ep in n.endpoints, but only</span></div><div class="line">	<span class="comment">// if it hasn't been taken over already by some other thread.</span></div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			n.Lock()</div><div class="line">			<span class="keyword">if</span> _, ok := n.endpoints[eid]; !ok &#123;</div><div class="line">				n.endpoints[eid] = ep</div><div class="line">			&#125;</div><div class="line">			n.Unlock()</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="comment">// Try removal of link. Discard error: it is a best effort.</span></div><div class="line">	<span class="comment">// Also make sure defer does not see this error either.</span></div><div class="line">	<span class="comment">//***删除vethpair***//</span></div><div class="line">	<span class="keyword">if</span> link, err := d.nlh.LinkByName(ep.srcName); err == <span class="literal">nil</span> &#123;</div><div class="line">		d.nlh.LinkDel(link)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := d.storeDelete(ep); err != <span class="literal">nil</span> &#123;</div><div class="line">		logrus.Warnf(<span class="string">"Failed to remove bridge endpoint %s from store: %v"</span>, ep.id[<span class="number">0</span>:<span class="number">7</span>], err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="endpoint-Join"><a href="#endpoint-Join" class="headerlink" title="endpoint::Join()"></a>endpoint::Join()</h4><p>Join()主要调用了sbJoin()，sbJoin()的流程如下：</p>
<ol>
<li>获取最新的network和endpoint；</li>
<li>获取driver，并调用driver的Join()；</li>
<li>获取ip，并赋给address，并把address更新到sandbox中；</li>
<li>更新endpoint。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***把endpoint加入到sbox***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ep *endpoint)</span> <span class="title">Join</span><span class="params">(sbox Sandbox, options ...EndpointOption)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> sbox == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> types.BadRequestErrorf(<span class="string">"endpoint cannot be joined by nil container"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sb, ok := sbox.(*sandbox)</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> types.BadRequestErrorf(<span class="string">"not a valid Sandbox interface"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sb.joinLeaveStart()</div><div class="line">	<span class="keyword">defer</span> sb.joinLeaveEnd()</div><div class="line"></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***调用sbJoin()***//</span></div><div class="line">	<span class="keyword">return</span> ep.sbJoin(sb, options...)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ep *endpoint)</span> <span class="title">sbJoin</span><span class="params">(sb *sandbox, options ...EndpointOption)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***获取network***//</span></div><div class="line">	n, err := ep.getNetworkFromStore()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to get network from store during join: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***获取endpoint***//</span></div><div class="line">	ep, err = n.getEndpointFromStore(ep.ID())</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to get endpoint from store during join: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ep.Lock()</div><div class="line">	<span class="keyword">if</span> ep.sandboxID != <span class="string">""</span> &#123;</div><div class="line">		ep.Unlock()</div><div class="line">		<span class="keyword">return</span> types.ForbiddenErrorf(<span class="string">"another container is attached to the same network endpoint"</span>)</div><div class="line">	&#125;</div><div class="line">	ep.network = n</div><div class="line">	ep.sandboxID = sb.ID()</div><div class="line">	ep.joinInfo = &amp;endpointJoinInfo&#123;&#125;</div><div class="line">	epid := ep.id</div><div class="line">	ep.Unlock()</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			ep.Lock()</div><div class="line">			ep.sandboxID = <span class="string">""</span></div><div class="line">			ep.Unlock()</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	nid := n.ID()</div><div class="line"></div><div class="line">	ep.processOptions(options...)</div><div class="line"></div><div class="line">	<span class="comment">//***获取driver***//</span></div><div class="line">	d, err := n.driver(<span class="literal">true</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to join endpoint: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***调用driver的Join()***//</span></div><div class="line">	err = d.Join(nid, epid, sb.Key(), ep, sb.Labels())</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> err := d.Leave(nid, epid); err != <span class="literal">nil</span> &#123;</div><div class="line">				log.Warnf(<span class="string">"driver leave failed while rolling back join: %v"</span>, err)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="comment">// Watch for service records</span></div><div class="line">	<span class="keyword">if</span> !n.getController().isAgent() &#123;</div><div class="line">		n.getController().watchSvcRecord(ep)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	address := <span class="string">""</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***获取ip，并赋给address***//</span></div><div class="line">	<span class="keyword">if</span> ip := ep.getFirstInterfaceAddress(); ip != <span class="literal">nil</span> &#123;</div><div class="line">		address = ip.String()</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***更新sandbox***//</span></div><div class="line">	<span class="keyword">if</span> err = sb.updateHostsFile(address); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err = sb.updateDNS(n.enableIPv6); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***更新endpoint***//</span></div><div class="line">	<span class="keyword">if</span> err = n.getController().updateToStore(ep); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Current endpoint providing external connectivity for the sandbox</span></div><div class="line">	extEp := sb.getGatewayEndpoint()</div><div class="line"></div><div class="line">	sb.Lock()</div><div class="line">	heap.Push(&amp;sb.endpoints, ep)</div><div class="line">	sb.Unlock()</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			sb.removeEndpoint(ep)</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="comment">//***调用populateNetworkResources激活endpoint***//</span></div><div class="line">	<span class="keyword">if</span> err = sb.populateNetworkResources(ep); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> e := ep.addToCluster(); e != <span class="literal">nil</span> &#123;</div><div class="line">		log.Errorf(<span class="string">"Could not update state for endpoint %s into cluster: %v"</span>, ep.Name(), e)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> sb.needDefaultGW() &amp;&amp; sb.getEndpointInGWNetwork() == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> sb.setupDefaultGW()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	moveExtConn := sb.getGatewayEndpoint() != extEp</div><div class="line"></div><div class="line">    ......</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以bridge为例，driver的Join()定义在/libnetwork/drivers/bridge/bridge.go：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***把network的endpoint加入到sandbox中***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *driver)</span> <span class="title">Join</span><span class="params">(nid, eid <span class="keyword">string</span>, sboxKey <span class="keyword">string</span>, jinfo driverapi.JoinInfo, options <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> osl.InitOSContext()()</div><div class="line"></div><div class="line">	<span class="comment">//***获取network***//</span></div><div class="line">	network, err := d.getNetwork(nid)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***获取endpoint***//</span></div><div class="line">	<span class="comment">//***endpoint保存着sandbox端的信息***//</span></div><div class="line">	endpoint, err := network.getEndpoint(eid)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> endpoint == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> EndpointNotFoundError(eid)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	endpoint.containerConfig, err = parseContainerOptions(options)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	iNames := jinfo.InterfaceName()</div><div class="line">	err = iNames.SetNames(endpoint.srcName, containerVethPrefix)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	err = jinfo.SetGateway(network.bridge.gatewayIPv4)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	err = jinfo.SetGatewayIPv6(network.bridge.gatewayIPv6)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当然，driver的Join()只需要对endpoint做进一步的设置。<br>那么endpint是何时加入到sandbox中的呢？答案是populateNetworkResources()，在设置完endpoint后，endpoint的Join()会调用populateNetworkResources()。<br>populateNetworkResources()定义在/libnetwork/sandbox.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sb *sandbox)</span> <span class="title">populateNetworkResources</span><span class="params">(ep *endpoint)</span> <span class="title">error</span></span> &#123;</div><div class="line">	sb.Lock()</div><div class="line">	<span class="keyword">if</span> sb.osSbox == <span class="literal">nil</span> &#123;</div><div class="line">		sb.Unlock()</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	inDelete := sb.inDelete</div><div class="line">	sb.Unlock()</div><div class="line"></div><div class="line">	ep.Lock()</div><div class="line">	joinInfo := ep.joinInfo</div><div class="line">	i := ep.iface</div><div class="line">	ep.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ep.needResolver() &#123;</div><div class="line">		sb.startResolver(<span class="literal">false</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> i != <span class="literal">nil</span> &amp;&amp; i.srcName != <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">var</span> ifaceOptions []osl.IfaceOption</div><div class="line"></div><div class="line">		ifaceOptions = <span class="built_in">append</span>(ifaceOptions, sb.osSbox.InterfaceOptions().Address(i.addr), sb.osSbox.InterfaceOptions().Routes(i.routes))</div><div class="line">		<span class="keyword">if</span> i.addrv6 != <span class="literal">nil</span> &amp;&amp; i.addrv6.IP.To16() != <span class="literal">nil</span> &#123;</div><div class="line">			ifaceOptions = <span class="built_in">append</span>(ifaceOptions, sb.osSbox.InterfaceOptions().AddressIPv6(i.addrv6))</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(i.llAddrs) != <span class="number">0</span> &#123;</div><div class="line">			ifaceOptions = <span class="built_in">append</span>(ifaceOptions, sb.osSbox.InterfaceOptions().LinkLocalAddresses(i.llAddrs))</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(ep.virtualIP) != <span class="number">0</span> &#123;</div><div class="line">			vipAlias := &amp;net.IPNet&#123;IP: ep.virtualIP, Mask: net.CIDRMask(<span class="number">32</span>, <span class="number">32</span>)&#125;</div><div class="line">			ifaceOptions = <span class="built_in">append</span>(ifaceOptions, sb.osSbox.InterfaceOptions().IPAliases([]*net.IPNet&#123;vipAlias&#125;))</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> i.mac != <span class="literal">nil</span> &#123;</div><div class="line">			ifaceOptions = <span class="built_in">append</span>(ifaceOptions, sb.osSbox.InterfaceOptions().MacAddress(i.mac))</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//***Fankang***//</span></div><div class="line">		<span class="comment">//***调用AddInterface()***//</span></div><div class="line">		<span class="keyword">if</span> err := sb.osSbox.AddInterface(i.srcName, i.dstPrefix, ifaceOptions...); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to add interface %s to sandbox: %v"</span>, i.srcName, err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> joinInfo != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// Set up non-interface routes.</span></div><div class="line">		<span class="keyword">for</span> _, r := <span class="keyword">range</span> joinInfo.StaticRoutes &#123;</div><div class="line">			<span class="keyword">if</span> err := sb.osSbox.AddStaticRoute(r); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to add static route %s: %v"</span>, r.Destination.String(), err)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ep == sb.getGatewayEndpoint() &#123;</div><div class="line">		<span class="keyword">if</span> err := sb.updateGateway(ep); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Make sure to add the endpoint to the populated endpoint set</span></div><div class="line">	<span class="comment">// before populating loadbalancers.</span></div><div class="line">	sb.Lock()</div><div class="line">	sb.populatedEndpoints[ep.ID()] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</div><div class="line">	sb.Unlock()</div><div class="line"></div><div class="line">	<span class="comment">// Populate load balancer only after updating all the other</span></div><div class="line">	<span class="comment">// information including gateway and other routes so that</span></div><div class="line">	<span class="comment">// loadbalancers are populated all the network state is in</span></div><div class="line">	<span class="comment">// place in the sandbox.</span></div><div class="line">	sb.populateLoadbalancers(ep)</div><div class="line"></div><div class="line">	<span class="comment">// Only update the store if we did not come here as part of</span></div><div class="line">	<span class="comment">// sandbox delete. If we came here as part of delete then do</span></div><div class="line">	<span class="comment">// not bother updating the store. The sandbox object will be</span></div><div class="line">	<span class="comment">// deleted anyway</span></div><div class="line">	<span class="keyword">if</span> !inDelete &#123;</div><div class="line">		<span class="keyword">return</span> sb.storeUpdate()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>populateNetworkResources()通过osSbox.AddInterface()把endpoint加入到sandbox中，AddInterface()定义在/libnetwork/osl/interface_linux.go，这里就不再展开分析了。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/12/04/libnetwork源码分析(二)-network-v1-12-3/" data-id="cjbm508uu007e8oqs2ueekt2v" class="article-share-link">分享</a><div class="tags"><a href="/tags/docker/">docker</a><a href="/tags/docker-v1-12-3/">docker-v1.12.3</a></div><div class="post-nav"><a href="/2017/12/09/kubernetes-添加资源-demo-v1-5-2/" class="pre">kubernetes-添加资源-demo-v1.5.2</a><a href="/2017/12/03/libnetwork源码分析(一)-controller(5)-v1-12-3/" class="next">libnetwork源码分析(一)-controller(5)-v1-12-3</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/25/Docker命令分行分析-run-v1-12-3/">Docker命令分行分析-run-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/23/kubelet分析(七)-dockerManager(2)-v1-5-2/">kubelet分析(七)-dockerManager(2)-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/23/kubelet分析(七)-dockerManager(1)-v1-5-2/">kubelet分析(七)-dockerManager(1)-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/20/kubelet分析(六)-proberManager-v1-5-2/">kubelet分析(六)-proberManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/18/kubelet分析(五)-podManager-v1-5-2/">kubelet分析(五)-podManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(四)-statusManager-v1-5-2/">kubelet分析(四)-statusManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(三)-volumeManager-v1-5-2/">kubelet分析(三)-volumeManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/kubelet分析(二)-podWorker-v1-5-2/">kubelet分析(二)-podWorker-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/kubelet分析(一)-config-v1-5-2/">kubelet分析(一)-config-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/15/storage解读(六)-strategy-v1-5-2/">storage解读(六)-strategy-v1.5.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>