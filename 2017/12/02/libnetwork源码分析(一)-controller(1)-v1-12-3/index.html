<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>libnetwork源码分析(一)-controller(1)-v1.12.3 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">libnetwork源码分析(一)-controller(1)-v1.12.3</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">libnetwork源码分析(一)-controller(1)-v1.12.3</h1><div class="post-meta">Dec 2, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h2><p>controller是libnetwork的核心，本次将对controller展开分析。分析将从controller的功能展开：</p>
<ol>
<li>管理driver；</li>
<li>管理network；</li>
<li>管理sandbox；</li>
<li>管理store；</li>
<li>监听unix socket(sandbox_externalkey使用)。</li>
</ol>
<p>先来看controller的定义，在/libnetwork/controller.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> controller <span class="keyword">struct</span> &#123;</div><div class="line">	id                     <span class="keyword">string</span></div><div class="line">	drvRegistry            *drvregistry.DrvRegistry</div><div class="line">	sandboxes              sandboxTable</div><div class="line">	cfg                    *config.Config</div><div class="line">	stores                 []datastore.DataStore</div><div class="line">	discovery              hostdiscovery.HostDiscovery</div><div class="line">	extKeyListener         net.Listener</div><div class="line">	watchCh                <span class="keyword">chan</span> *endpoint</div><div class="line">	unWatchCh              <span class="keyword">chan</span> *endpoint</div><div class="line">	svcRecords             <span class="keyword">map</span>[<span class="keyword">string</span>]svcInfo</div><div class="line">	nmap                   <span class="keyword">map</span>[<span class="keyword">string</span>]*netWatch</div><div class="line">	serviceBindings        <span class="keyword">map</span>[serviceKey]*service</div><div class="line">	defOsSbox              osl.Sandbox</div><div class="line">	ingressSandbox         *sandbox</div><div class="line">	sboxOnce               sync.Once</div><div class="line">	agent                  *agent</div><div class="line">	networkLocker          *locker.Locker</div><div class="line">	agentInitDone          <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</div><div class="line">	keys                   []*types.EncryptionKey</div><div class="line">	clusterConfigAvailable <span class="keyword">bool</span></div><div class="line">	sync.Mutex</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>主要的字段有：</p>
<ul>
<li>id: controller的标识，随机生成；</li>
<li>drvRegistry: 负责管理driver；</li>
<li>sandboxes: 负责管理sandbox；</li>
<li>stores: 负责管理store；</li>
<li>extKeyListener: 负责处理externalkey。</li>
</ul>
<p>注：service, ingress目前还不大了解，本次暂不分析，以后补充。</p>
<p>再来看controller的生成函数：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***生成controller***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(cfgOptions ...config.Option)</span> <span class="params">(NetworkController, error)</span></span> &#123;</div><div class="line">	c := &amp;controller&#123;</div><div class="line">		id:              stringid.GenerateRandomID(),</div><div class="line">		cfg:             config.ParseConfigOptions(cfgOptions...),</div><div class="line">		sandboxes:       sandboxTable&#123;&#125;,</div><div class="line">		svcRecords:      <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]svcInfo),</div><div class="line">		serviceBindings: <span class="built_in">make</span>(<span class="keyword">map</span>[serviceKey]*service),</div><div class="line">		agentInitDone:   <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</div><div class="line">		networkLocker:   locker.New(),</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***初始化stores***//</span></div><div class="line">	<span class="keyword">if</span> err := c.initStores(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***初始化drvRegistry***//</span></div><div class="line">	drvRegistry, err := drvregistry.New(c.getStore(datastore.LocalScope), c.getStore(datastore.GlobalScope), c.RegisterDriver, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, i := <span class="keyword">range</span> getInitializers() &#123;</div><div class="line">		<span class="keyword">var</span> dcfg <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</div><div class="line"></div><div class="line">		<span class="comment">// External plugins don't need config passed through daemon. They can</span></div><div class="line">		<span class="comment">// bootstrap themselves</span></div><div class="line">		<span class="keyword">if</span> i.ntype != <span class="string">"remote"</span> &#123;</div><div class="line">			dcfg = c.makeDriverConfig(i.ntype)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> err := drvRegistry.AddDriver(i.ntype, i.fn, dcfg); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err = initIPAMDrivers(drvRegistry, <span class="literal">nil</span>, c.getStore(datastore.GlobalScope)); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	c.drvRegistry = drvRegistry</div><div class="line"></div><div class="line">	<span class="keyword">if</span> c.cfg != <span class="literal">nil</span> &amp;&amp; c.cfg.Cluster.Watcher != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> err := c.initDiscovery(c.cfg.Cluster.Watcher); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="comment">// Failing to initialize discovery is a bad situation to be in.</span></div><div class="line">			<span class="comment">// But it cannot fail creating the Controller</span></div><div class="line">			log.Errorf(<span class="string">"Failed to Initialize Discovery : %v"</span>, err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	c.WalkNetworks(populateSpecial)</div><div class="line"></div><div class="line">	<span class="comment">// Reserve pools first before doing cleanup. Otherwise the</span></div><div class="line">	<span class="comment">// cleanups of endpoint/network and sandbox below will</span></div><div class="line">	<span class="comment">// generate many unnecessary warnings</span></div><div class="line">	c.reservePools()</div><div class="line"></div><div class="line">	<span class="comment">// Cleanup resources</span></div><div class="line">	c.sandboxCleanup(c.cfg.ActiveSandboxes)</div><div class="line">	c.cleanupLocalEndpoints()</div><div class="line">	c.networkCleanup()</div><div class="line"></div><div class="line">	<span class="comment">//***启动ExternalKeyListener***//</span></div><div class="line">	<span class="keyword">if</span> err := c.startExternalKeyListener(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> c, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>New()的流程如下：</p>
<ol>
<li>生成controller；</li>
<li>调用initStores()初始化stores；</li>
<li>初始化drvRegistry；</li>
<li>清理store中sandbox及newwork资源；</li>
<li>启动ExternalKeyListener监听unix socket请求。</li>
</ol>
<h2 id="一-管理driver"><a href="#一-管理driver" class="headerlink" title="(一) 管理driver"></a>(一) 管理driver</h2><p>controller管理driver是通过DrvRegistry进行的。所以我们就先分析DrvRegistry，然后再看初始化过程所做的工作。还有一点需要注意，libnetwork中的driver就是指network driver。</p>
<h3 id="1-DrvRegistry"><a href="#1-DrvRegistry" class="headerlink" title="(1) DrvRegistry"></a>(1) DrvRegistry</h3><p>DrvRegistry定义在/libnetwork/drvregistry/drvregistry.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> driverTable <span class="keyword">map</span>[<span class="keyword">string</span>]*driverData</div><div class="line"><span class="keyword">type</span> ipamTable <span class="keyword">map</span>[<span class="keyword">string</span>]*ipamData</div><div class="line"></div><div class="line"><span class="comment">// DrvRegistry holds the registry of all network drivers and IPAM drivers that it knows about.</span></div><div class="line"><span class="keyword">type</span> DrvRegistry <span class="keyword">struct</span> &#123;</div><div class="line">	sync.Mutex</div><div class="line">	drivers     driverTable</div><div class="line">	ipamDrivers ipamTable</div><div class="line">	dfn         DriverNotifyFunc</div><div class="line">	ifn         IPAMNotifyFunc</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中，drivers存储了driver，ipamDrivers存储IPAM driver。可以使用DrvRegistry包下的New()生成DrvRegistry：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***生成DrvRegistry***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(lDs, gDs <span class="keyword">interface</span>&#123;&#125;, dfn DriverNotifyFunc, ifn IPAMNotifyFunc)</span> <span class="params">(*DrvRegistry, error)</span></span> &#123;</div><div class="line">	r := &amp;DrvRegistry&#123;</div><div class="line">		drivers:     <span class="built_in">make</span>(driverTable),</div><div class="line">		ipamDrivers: <span class="built_in">make</span>(ipamTable),</div><div class="line">		dfn:         dfn,</div><div class="line">		ifn:         ifn,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> r, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="DrvRegistry-AddDriver"><a href="#DrvRegistry-AddDriver" class="headerlink" title="DrvRegistry::AddDriver()"></a>DrvRegistry::AddDriver()</h4><p>AddDriver()可以向DrvRegistry中添加driver。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***向DrvRegistry添加driver***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *DrvRegistry)</span> <span class="title">AddDriver</span><span class="params">(ntype <span class="keyword">string</span>, fn InitFunc, config <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> fn(r, config)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>添加过程是靠传入的参数fn完成的。</p>
<h4 id="DrvRegistry-WalkIPAMs"><a href="#DrvRegistry-WalkIPAMs" class="headerlink" title="DrvRegistry::WalkIPAMs()"></a>DrvRegistry::WalkIPAMs()</h4><p>WalkIPAMs()可以把函数作用在DrvRegistry中的所有IPAM driver上。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***类似目录的Walk，调用ifn函数作用在每一个IPAM driver上，直到ifn()为true***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *DrvRegistry)</span> <span class="title">WalkIPAMs</span><span class="params">(ifn IPAMWalkFunc)</span></span> &#123;</div><div class="line">	<span class="keyword">type</span> ipamVal <span class="keyword">struct</span> &#123;</div><div class="line">		name <span class="keyword">string</span></div><div class="line">		data *ipamData</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	r.Lock()</div><div class="line">	ivl := <span class="built_in">make</span>([]ipamVal, <span class="number">0</span>, <span class="built_in">len</span>(r.ipamDrivers))</div><div class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> r.ipamDrivers &#123;</div><div class="line">		ivl = <span class="built_in">append</span>(ivl, ipamVal&#123;name: k, data: v&#125;)</div><div class="line">	&#125;</div><div class="line">	r.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, iv := <span class="keyword">range</span> ivl &#123;</div><div class="line">		<span class="keyword">if</span> ifn(iv.name, iv.data.driver, iv.data.capability) &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="DrvRegistry-WalkDrivers"><a href="#DrvRegistry-WalkDrivers" class="headerlink" title="DrvRegistry::WalkDrivers()"></a>DrvRegistry::WalkDrivers()</h4><p>WalkDrivers()可以把函数作用在DrvRegistry中的所有driver上。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***类似目录的Walk，调用dfn函数作用在每一个network driver上，直到dfn()为true***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *DrvRegistry)</span> <span class="title">WalkDrivers</span><span class="params">(dfn DriverWalkFunc)</span></span> &#123;</div><div class="line">	<span class="keyword">type</span> driverVal <span class="keyword">struct</span> &#123;</div><div class="line">		name <span class="keyword">string</span></div><div class="line">		data *driverData</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	r.Lock()</div><div class="line">	dvl := <span class="built_in">make</span>([]driverVal, <span class="number">0</span>, <span class="built_in">len</span>(r.drivers))</div><div class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> r.drivers &#123;</div><div class="line">		dvl = <span class="built_in">append</span>(dvl, driverVal&#123;name: k, data: v&#125;)</div><div class="line">	&#125;</div><div class="line">	r.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, dv := <span class="keyword">range</span> dvl &#123;</div><div class="line">		<span class="keyword">if</span> dfn(dv.name, dv.data.driver, dv.data.capability) &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="DrvRegistry-Driver"><a href="#DrvRegistry-Driver" class="headerlink" title="DrvRegistry::Driver()"></a>DrvRegistry::Driver()</h4><p>Driver()可以依据name获取network driver。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取DrvRegistry中名为name的network driver***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *DrvRegistry)</span> <span class="title">Driver</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(driverapi.Driver, *driverapi.Capability)</span></span> &#123;</div><div class="line">	r.Lock()</div><div class="line">	<span class="keyword">defer</span> r.Unlock()</div><div class="line"></div><div class="line">	d, ok := r.drivers[name]</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> d.driver, &amp;d.capability</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="DrvRegistry-IPAM"><a href="#DrvRegistry-IPAM" class="headerlink" title="DrvRegistry::IPAM()"></a>DrvRegistry::IPAM()</h4><p>IPAM()可以通过name获取IPAM driver。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取DrvRegistry中名为name的IPAM driver***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *DrvRegistry)</span> <span class="title">IPAM</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(ipamapi.Ipam, *ipamapi.Capability)</span></span> &#123;</div><div class="line">	r.Lock()</div><div class="line">	<span class="keyword">defer</span> r.Unlock()</div><div class="line"></div><div class="line">	i, ok := r.ipamDrivers[name]</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> i.driver, i.capability</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="DrvRegistry-RegisterDriver"><a href="#DrvRegistry-RegisterDriver" class="headerlink" title="DrvRegistry::RegisterDriver()"></a>DrvRegistry::RegisterDriver()</h4><p>RegisterDriver()可以注册driver。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***注册network driver***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *DrvRegistry)</span> <span class="title">RegisterDriver</span><span class="params">(ntype <span class="keyword">string</span>, driver driverapi.Driver, capability driverapi.Capability)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> strings.TrimSpace(ntype) == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"network type string cannot be empty"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	r.Lock()</div><div class="line">	_, ok := r.drivers[ntype]</div><div class="line">	r.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ok &#123;</div><div class="line">		<span class="keyword">return</span> driverapi.ErrActiveRegistration(ntype)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> r.dfn != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> err := r.dfn(ntype, driver, capability); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	dData := &amp;driverData&#123;driver, capability&#125;</div><div class="line"></div><div class="line">	r.Lock()</div><div class="line">	r.drivers[ntype] = dData</div><div class="line">	r.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="DrvRegistry-RegisterIpamDriver"><a href="#DrvRegistry-RegisterIpamDriver" class="headerlink" title="DrvRegistry::RegisterIpamDriver()"></a>DrvRegistry::RegisterIpamDriver()</h4><p>RegisterIpamDriver()可以注册IPAM driver。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***注册IPAM driver***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *DrvRegistry)</span> <span class="title">RegisterIpamDriver</span><span class="params">(name <span class="keyword">string</span>, driver ipamapi.Ipam)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> r.registerIpamDriver(name, driver, &amp;ipamapi.Capability&#123;&#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RegisterIpamDriverWithCapabilities registers the IPAM driver discovered with specified capabilities.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *DrvRegistry)</span> <span class="title">RegisterIpamDriverWithCapabilities</span><span class="params">(name <span class="keyword">string</span>, driver ipamapi.Ipam, caps *ipamapi.Capability)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> r.registerIpamDriver(name, driver, caps)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *DrvRegistry)</span> <span class="title">registerIpamDriver</span><span class="params">(name <span class="keyword">string</span>, driver ipamapi.Ipam, caps *ipamapi.Capability)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> strings.TrimSpace(name) == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"ipam driver name string cannot be empty"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	r.Lock()</div><div class="line">	_, ok := r.ipamDrivers[name]</div><div class="line">	r.Unlock()</div><div class="line">	<span class="keyword">if</span> ok &#123;</div><div class="line">		<span class="keyword">return</span> types.ForbiddenErrorf(<span class="string">"ipam driver %q already registered"</span>, name)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	locAS, glbAS, err := driver.GetDefaultAddressSpaces()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> types.InternalErrorf(<span class="string">"ipam driver %q failed to return default address spaces: %v"</span>, name, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> r.ifn != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> err := r.ifn(name, driver, caps); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	r.Lock()</div><div class="line">	r.ipamDrivers[name] = &amp;ipamData&#123;driver: driver, defaultLocalAddressSpace: locAS, defaultGlobalAddressSpace: glbAS, capability: caps&#125;</div><div class="line">	r.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="2-初始化DrvRegistry"><a href="#2-初始化DrvRegistry" class="headerlink" title="(2) 初始化DrvRegistry"></a>(2) 初始化DrvRegistry</h3><p>再来看libnetwork是如何初始化DrvRegistry的。初始化代码在/libnetwork/controller.go的New()中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***初始化drvRegistry***//</span></div><div class="line">drvRegistry, err := drvregistry.New(c.getStore(datastore.LocalScope), c.getStore(datastore.GlobalScope), c.RegisterDriver, <span class="literal">nil</span>)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> _, i := <span class="keyword">range</span> getInitializers() &#123;</div><div class="line">	<span class="keyword">var</span> dcfg <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</div><div class="line"></div><div class="line">	<span class="comment">// External plugins don't need config passed through daemon. They can</span></div><div class="line">	<span class="comment">// bootstrap themselves</span></div><div class="line">	<span class="keyword">if</span> i.ntype != <span class="string">"remote"</span> &#123;</div><div class="line">		dcfg = c.makeDriverConfig(i.ntype)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := drvRegistry.AddDriver(i.ntype, i.fn, dcfg); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> err = initIPAMDrivers(drvRegistry, <span class="literal">nil</span>, c.getStore(datastore.GlobalScope)); err != <span class="literal">nil</span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">&#125;</div><div class="line"></div><div class="line">c.drvRegistry = drvRegistry</div></pre></td></tr></table></figure></p>
<p>这段代码的逻辑如下：</p>
<ol>
<li>生成drvRegistry；</li>
<li>调用getInitializers()获取需要注册的network driver的注册函数；</li>
<li>通过调用drvRegistry.AddDriver()添加network driver；</li>
<li>通过调用initIPAMDrivers()添加IPAM driver。可以使用DrvRegistry包下的New</li>
</ol>
<p>我们先来看driver的初始化，主要涉及两个函数：getInitailizers()和drvRegistry.AddDriver()。其中drvRegistry.AddDriver()我们已经分析过。<br>getInitailizers()定义在/docker/libnetwork/drivers_linux.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getInitializers</span><span class="params">()</span> []<span class="title">initializer</span></span> &#123;</div><div class="line">	in := []initializer&#123;</div><div class="line">		&#123;bridge.Init, <span class="string">"bridge"</span>&#125;,</div><div class="line">		&#123;host.Init, <span class="string">"host"</span>&#125;,</div><div class="line">		&#123;macvlan.Init, <span class="string">"macvlan"</span>&#125;,</div><div class="line">		&#123;null.Init, <span class="string">"null"</span>&#125;,</div><div class="line">		&#123;remote.Init, <span class="string">"remote"</span>&#125;,</div><div class="line">		&#123;overlay.Init, <span class="string">"overlay"</span>&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	in = <span class="built_in">append</span>(in, additionalDrivers()...)</div><div class="line">	<span class="keyword">return</span> in</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到getInitializers()返回了”bridge”, “host”, “macvlan”, “null”, “remote”, “overlay”这些drivers的初始化函数及名称。</p>
<p>以bridge driver为例，看下Init()是如何实现的，bridge的Init()定义在/libnetwork/drivers/bridge/bridge.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Init registers a new instance of bridge driver</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Init</span><span class="params">(dc driverapi.DriverCallback, config <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	d := newDriver()</div><div class="line">	<span class="keyword">if</span> err := d.configure(config); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	c := driverapi.Capability&#123;</div><div class="line">		DataScope: datastore.LocalScope,</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***注册network driver***//</span></div><div class="line">	<span class="keyword">return</span> dc.RegisterDriver(networkType, d, c)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里调用的RegisterDriver()就是DrvRegistry中的RegisterDriver()。</p>
<h3 id="3-docker-plugin"><a href="#3-docker-plugin" class="headerlink" title="(3) docker plugin"></a>(3) docker plugin</h3><p>在controller中，还实现了loadDriver()和loadIPAMDriver()，定义在/libnetwork/controller.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">loadDriver</span><span class="params">(networkType <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// Plugins pkg performs lazy loading of plugins that acts as remote drivers.</span></div><div class="line">	<span class="comment">// As per the design, this Get call will result in remote driver discovery if there is a corresponding plugin available.</span></div><div class="line">	_, err := plugins.Get(networkType, driverapi.NetworkPluginEndpointType)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> err == plugins.ErrNotFound &#123;</div><div class="line">			<span class="keyword">return</span> types.NotFoundErrorf(err.Error())</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">loadIPAMDriver</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> _, err := plugins.Get(name, ipamapi.PluginEndpointType); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> err == plugins.ErrNotFound &#123;</div><div class="line">			<span class="keyword">return</span> types.NotFoundErrorf(err.Error())</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这两个方法是从调用/docker/pkg/plugins包获取对应的driver。<br>所以这里提下Docker的plugins discovery机制。Docker在启动时会去扫描/run/docker/plugins目录下的sock文件，并初始化成driver。这里只是猜测这是一种第三方driver注册的渠道，因为现在还没遇到过类似的driver，所以暂不展开分析。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>管理driver的分析结束，现在可以通过<code>controller.drvRegistry.Driver(name)</code>获取driver，通过<code>controller.drvRegistry.IPAM(name)</code>获取IPAM driver了。下一篇将介绍”管理network”。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/12/02/libnetwork源码分析(一)-controller(1)-v1-12-3/" data-id="cjbf1wv5p0061swqsatrtrzwy" class="article-share-link">分享</a><div class="tags"><a href="/tags/docker/">docker</a><a href="/tags/docker-v1-12-3/">docker-v1.12.3</a></div><div class="post-nav"><a href="/2017/12/02/libnetwork源码分析(一)-controller(2)-v1-12-3/" class="pre">libnetwork源码分析(一)-controller(2)-v1.12.3</a><a href="/2017/11/30/libnetwork基本概念-v1-12-3/" class="next">libnetwork基本概念-v1.12.3</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/20/kubelet分析(六)-proberManager-v1-5-2/">kubelet分析(六)-proberManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/18/kubelet分析(五)-podManager-v1-5-2/">kubelet分析(五)-podManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(四)-statusManager-v1-5-2/">kubelet分析(四)-statusManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(三)-volumeManager-v1-5-2/">kubelet分析(三)-volumeManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/kubelet分析(二)-podWorker-v1-5-2/">kubelet分析(二)-podWorker-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/kubelet分析(一)-config-v1-5-2/">kubelet分析(一)-config-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/15/storage解读(六)-strategy-v1-5-2/">storage解读(六)-strategy-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/14/kubernetes-listwatch机制-v1-5-2/">kubernetes-listwatch机制-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/kubernetes-添加controller-demo-v1-5-2/">kubernetes-添加controller-demo-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/kubernetes-添加资源-demo-v1-5-2/">kubernetes-添加资源-demo-v1.5.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>