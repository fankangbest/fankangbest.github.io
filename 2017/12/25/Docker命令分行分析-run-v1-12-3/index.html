<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Docker命令分行分析-run-v1.12.3 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Docker命令分行分析-run-v1.12.3</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Docker命令分行分析-run-v1.12.3</h1><div class="post-meta">Dec 25, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>Docker的run命令可以运行一个容器，支持的过程分为两步：Create和Start。</p>
<h2 id="client端"><a href="#client端" class="headerlink" title="client端"></a>client端</h2><p>先来看下Docker client端的run实现，实现函数为runRun()，定义在/pkg/client/container/run.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">runRun</span><span class="params">(dockerCli *client.DockerCli, flags *pflag.FlagSet, opts *runOptions, copts *runconfigopts.ContainerOptions)</span> <span class="title">error</span></span> &#123;</div><div class="line">	stdout, stderr, stdin := dockerCli.Out(), dockerCli.Err(), dockerCli.In()</div><div class="line">	client := dockerCli.Client()</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> pass this as an argument</span></div><div class="line">	cmdPath := <span class="string">"run"</span></div><div class="line">	......</div><div class="line"></div><div class="line">	<span class="comment">//***1.8.3中只有config, hostConfig，现在多了一个networkingConfig***//</span></div><div class="line">	<span class="comment">//***config, hostConfig和networkingConfig详见docker inspect的结果***//</span></div><div class="line">	config, hostConfig, networkingConfig, err := runconfigopts.Parse(flags, copts)</div><div class="line"></div><div class="line">	<span class="comment">// just in case the Parse does not exit</span></div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		reportError(stderr, cmdPath, err.Error(), <span class="literal">true</span>)</div><div class="line">		<span class="keyword">return</span> cli.StatusError&#123;StatusCode: <span class="number">125</span>&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> hostConfig.OomKillDisable != <span class="literal">nil</span> &amp;&amp; *hostConfig.OomKillDisable &amp;&amp; hostConfig.Memory == <span class="number">0</span> &#123;</div><div class="line">		fmt.Fprintf(stderr, <span class="string">"WARNING: Disabling the OOM killer on containers without setting a '-m/--memory' limit may be dangerous.\n"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***检测DNS是否合法***//</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(hostConfig.DNS) &gt; <span class="number">0</span> &#123;</div><div class="line">		<span class="comment">// check the DNS settings passed via --dns against</span></div><div class="line">		<span class="comment">// localhost regexp to warn if they are trying to</span></div><div class="line">		<span class="comment">// set a DNS to a localhost address</span></div><div class="line">		<span class="keyword">for</span> _, dnsIP := <span class="keyword">range</span> hostConfig.DNS &#123;</div><div class="line">			<span class="keyword">if</span> dns.IsLocalhost(dnsIP) &#123;</div><div class="line">				fmt.Fprintf(stderr, <span class="string">"WARNING: Localhost DNS setting (--dns=%s) may fail in containers.\n"</span>, dnsIP)</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	......</div><div class="line"></div><div class="line">	<span class="comment">//***WithCancel context***//</span></div><div class="line">	ctx, cancelFun := context.WithCancel(context.Background())</div><div class="line"></div><div class="line">	<span class="comment">//***create container***//</span></div><div class="line">	createResponse, err := createContainer(ctx, dockerCli, config, hostConfig, networkingConfig, hostConfig.ContainerIDFile, opts.name)</div><div class="line">	......</div><div class="line">	<span class="comment">//***处理attach相关的参数***//</span></div><div class="line">	attach := config.AttachStdin || config.AttachStdout || config.AttachStderr</div><div class="line">	<span class="keyword">if</span> attach &#123;</div><div class="line">		......</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***defer这种形式的用法第一次见到，可以学着用下***//</span></div><div class="line">	<span class="comment">//***如需auto remove，在defer中remove container***//</span></div><div class="line">	<span class="keyword">if</span> opts.autoRemove &#123;</div><div class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">			<span class="comment">// Explicitly not sharing the context as it could be "Done" (by calling cancelFun)</span></div><div class="line">			<span class="comment">// and thus the container would not be removed.</span></div><div class="line">			<span class="keyword">if</span> err := removeContainer(dockerCli, context.Background(), createResponse.ID, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">true</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">				fmt.Fprintf(stderr, <span class="string">"%v\n"</span>, err)</div><div class="line">			&#125;</div><div class="line">		&#125;()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//start the container</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***start container***//</span></div><div class="line">	<span class="keyword">if</span> err := client.ContainerStart(ctx, createResponse.ID, types.ContainerStartOptions&#123;&#125;); err != <span class="literal">nil</span> &#123;</div><div class="line">		......</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	......</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>runRun()的流程如下：</p>
<ol>
<li>依据配置文件生成config, hostConfig, networkingConfig；</li>
<li>调用createContainer()创建容器；</li>
<li>调用docker client的ContainerStart()启动容器。</li>
</ol>
<p>再来看createContainer()的实现，定义在/api/client/container/create.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">createContainer</span><span class="params">(ctx context.Context, dockerCli *client.DockerCli, config *container.Config, hostConfig *container.HostConfig, networkingConfig *networktypes.NetworkingConfig, cidfile, name <span class="keyword">string</span>)</span> <span class="params">(*types.ContainerCreateResponse, error)</span></span> &#123;</div><div class="line">	......</div><div class="line"></div><div class="line">	<span class="comment">//create the container</span></div><div class="line">	<span class="comment">//***尝试create container***//</span></div><div class="line">	response, err := dockerCli.Client().ContainerCreate(ctx, config, hostConfig, networkingConfig, name)</div><div class="line"></div><div class="line">	<span class="comment">//if image not found try to pull it</span></div><div class="line">	<span class="comment">//***处理image不存在的情况***//</span></div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> apiclient.IsErrImageNotFound(err) &amp;&amp; ref != <span class="literal">nil</span> &#123;</div><div class="line">			fmt.Fprintf(stderr, <span class="string">"Unable to find image '%s' locally\n"</span>, ref.String())</div><div class="line"></div><div class="line">			<span class="comment">// we don't want to write to stdout anything apart from container.ID</span></div><div class="line">			<span class="comment">//***定义在本文件中，下载镜像用***//</span></div><div class="line">			<span class="keyword">if</span> err = pullImage(ctx, dockerCli, config.Image, stderr); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> ref, ok := ref.(reference.NamedTagged); ok &amp;&amp; trustedRef != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">if</span> err := dockerCli.TagTrusted(ctx, trustedRef, ref); err != <span class="literal">nil</span> &#123;</div><div class="line">					<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// Retry</span></div><div class="line">			<span class="keyword">var</span> retryErr error</div><div class="line">			<span class="comment">//***下载完镜像之后，再重新create container***//</span></div><div class="line">			response, retryErr = dockerCli.Client().ContainerCreate(ctx, config, hostConfig, networkingConfig, name)</div><div class="line">			<span class="keyword">if</span> retryErr != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, retryErr</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	......</div><div class="line">	<span class="keyword">return</span> &amp;response, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>createContainer()的流程如下：</p>
<ol>
<li>调用docker client的ContainerCreate()创建容器；</li>
<li>如果创建过程出错，则尝试下载镜像，然后再调用ContainerCreate()创建容器。</li>
</ol>
<p>所以，容器的创建和运行是调用docker client的ContainerCreate()和ContainerStart()完成的。</p>
<h2 id="server端"><a href="#server端" class="headerlink" title="server端"></a>server端</h2><h4 id="create流程"><a href="#create流程" class="headerlink" title="create流程"></a>create流程</h4><p>再来看server端响应create的流程。postConatinersCreate()处理容器创建的请求，定义在/api/server/router/container/container_routes.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *containerRouter)</span> <span class="title">postContainersCreate</span><span class="params">(ctx context.Context, w http.ResponseWriter, r *http.Request, vars <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err := httputils.ParseForm(r); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := httputils.CheckForJSON(r); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***获取container name***//</span></div><div class="line">	name := r.Form.Get(<span class="string">"name"</span>)</div><div class="line"></div><div class="line">	<span class="comment">//***从Body中解析出config, hostConfig, networkingConfig***//</span></div><div class="line">	config, hostConfig, networkingConfig, err := s.decoder.DecodeConfig(r.Body)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	version := httputils.VersionFromContext(ctx)</div><div class="line">	adjustCPUShares := versions.LessThan(version, <span class="string">"1.19"</span>)</div><div class="line"></div><div class="line">	validateHostname := versions.GreaterThanOrEqualTo(version, <span class="string">"1.24"</span>)</div><div class="line">	<span class="comment">//***调用ContainerCreate()***//</span></div><div class="line">	ccr, err := s.backend.ContainerCreate(types.ContainerCreateConfig&#123;</div><div class="line">		Name:             name,</div><div class="line">		Config:           config,</div><div class="line">		HostConfig:       hostConfig,</div><div class="line">		NetworkingConfig: networkingConfig,</div><div class="line">		AdjustCPUShares:  adjustCPUShares,</div><div class="line">	&#125;, validateHostname)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> httputils.WriteJSON(w, http.StatusCreated, ccr)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>postContainersCreate()的流程如下：</p>
<ol>
<li>从请求表单中解析出config, hostConfig和networkingConfig；</li>
<li>调用backend.ContainerCreate()创建容器，这里的backend即Daemon。</li>
</ol>
<h4 id="start流程"><a href="#start流程" class="headerlink" title="start流程"></a>start流程</h4><p>postContainersStart()处理启动容器的请求，定义在/api/server/router/container/container_routes.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *containerRouter)</span> <span class="title">postContainersStart</span><span class="params">(ctx context.Context, w http.ResponseWriter, r *http.Request, vars <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	version := httputils.VersionFromContext(ctx)</div><div class="line">	<span class="keyword">var</span> hostConfig *container.HostConfig</div><div class="line">	<span class="comment">// A non-nil json object is at least 7 characters.</span></div><div class="line">	<span class="keyword">if</span> r.ContentLength &gt; <span class="number">7</span> || r.ContentLength == <span class="number">-1</span> &#123;</div><div class="line">		<span class="keyword">if</span> versions.GreaterThanOrEqualTo(version, <span class="string">"1.24"</span>) &#123;</div><div class="line">			<span class="keyword">return</span> validationError&#123;fmt.Errorf(<span class="string">"starting container with HostConfig was deprecated since v1.10 and removed in v1.12"</span>)&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> err := httputils.CheckForJSON(r); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		c, err := s.decoder.DecodeHostConfig(r.Body)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		hostConfig = c</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	validateHostname := versions.GreaterThanOrEqualTo(version, <span class="string">"1.24"</span>)</div><div class="line">	<span class="comment">//***调用ContainerStart()***//</span></div><div class="line">	<span class="keyword">if</span> err := s.backend.ContainerStart(vars[<span class="string">"name"</span>], hostConfig, validateHostname); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	w.WriteHeader(http.StatusNoContent)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>postContainersStart()调用backend.ContainerStart()启动容器，这里的backend即Daemon。</p>
<h2 id="Daemon侧"><a href="#Daemon侧" class="headerlink" title="Daemon侧"></a>Daemon侧</h2><h4 id="create流程-1"><a href="#create流程-1" class="headerlink" title="create流程"></a>create流程</h4><p>来看Daemon的ContainerCreate()，定义在/daemon/create.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***ContainerCreate()方法定义***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(daemon *Daemon)</span> <span class="title">ContainerCreate</span><span class="params">(params types.ContainerCreateConfig, validateHostname <span class="keyword">bool</span>)</span> <span class="params">(types.ContainerCreateResponse, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> daemon.containerCreate(params, <span class="literal">false</span>, validateHostname)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ContainerCreate()调用了containerCreate()：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***具体实现containerCreate()的函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(daemon *Daemon)</span> <span class="title">containerCreate</span><span class="params">(params types.ContainerCreateConfig, managed <span class="keyword">bool</span>, validateHostname <span class="keyword">bool</span>)</span> <span class="params">(types.ContainerCreateResponse, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> params.Config == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> types.ContainerCreateResponse&#123;&#125;, fmt.Errorf(<span class="string">"Config cannot be empty in order to create a container"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***检查container的各项参数***//</span></div><div class="line">	warnings, err := daemon.verifyContainerSettings(params.HostConfig, params.Config, <span class="literal">false</span>, validateHostname)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> types.ContainerCreateResponse&#123;Warnings: warnings&#125;, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***检查网络参数***//</span></div><div class="line">	err = daemon.verifyNetworkingConfig(params.NetworkingConfig)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> types.ContainerCreateResponse&#123;&#125;, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> params.HostConfig == <span class="literal">nil</span> &#123;</div><div class="line">		params.HostConfig = &amp;containertypes.HostConfig&#123;&#125;</div><div class="line">	&#125;</div><div class="line">	err = daemon.adaptContainerSettings(params.HostConfig, params.AdjustCPUShares)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> types.ContainerCreateResponse&#123;Warnings: warnings&#125;, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***调用create()函数***//</span></div><div class="line">	container, err := daemon.create(params, managed)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> types.ContainerCreateResponse&#123;Warnings: warnings&#125;, daemon.imageNotExistToErrcode(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> types.ContainerCreateResponse&#123;ID: container.ID, Warnings: warnings&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>containerCreate()的流程如下：</p>
<ol>
<li>检查container的各项参数；</li>
<li>检查网络参数；</li>
<li>调用create()创建容器。</li>
</ol>
<p>create()定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***解析参数，并依据流程create container***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(daemon *Daemon)</span> <span class="title">create</span><span class="params">(params types.ContainerCreateConfig, managed <span class="keyword">bool</span>)</span> <span class="params">(retC *container.Container, retErr error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> (</div><div class="line">		container *container.Container</div><div class="line">		img       *image.Image</div><div class="line">		imgID     image.ID</div><div class="line">		err       error</div><div class="line">	)</div><div class="line"></div><div class="line">	<span class="comment">//***处理image***//</span></div><div class="line">	<span class="keyword">if</span> params.Config.Image != <span class="string">""</span> &#123;</div><div class="line">		img, err = daemon.GetImage(params.Config.Image)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">		imgID = img.ID()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***merge config***//</span></div><div class="line">	<span class="keyword">if</span> err := daemon.mergeAndVerifyConfig(params.Config, img); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***处理log的配置***//</span></div><div class="line">	<span class="keyword">if</span> err := daemon.mergeAndVerifyLogConfig(&amp;params.HostConfig.LogConfig); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***调用newContainer()来生成一个container***//</span></div><div class="line">	<span class="keyword">if</span> container, err = daemon.newContainer(params.Name, params.Config, imgID, managed); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> retErr != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> err := daemon.cleanupContainer(container, <span class="literal">true</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">				logrus.Errorf(<span class="string">"failed to cleanup container on create error: %v"</span>, err)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="comment">//***设置container安全相关的参数***//</span></div><div class="line">	<span class="keyword">if</span> err := daemon.setSecurityOptions(container, params.HostConfig); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	container.HostConfig.StorageOpt = params.HostConfig.StorageOpt</div><div class="line"></div><div class="line">	<span class="comment">// Set RWLayer for container after mount labels have been set</span></div><div class="line">	<span class="comment">//***创建读写层***//</span></div><div class="line">	<span class="keyword">if</span> err := daemon.setRWLayer(container); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	rootUID, rootGID, err := idtools.GetRootUIDGID(daemon.uidMaps, daemon.gidMaps)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***创建容器根目录***//</span></div><div class="line">	<span class="keyword">if</span> err := idtools.MkdirAs(container.Root, <span class="number">0700</span>, rootUID, rootGID); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***把容器相关的hostConfig保存到硬盘上***//</span></div><div class="line">	<span class="comment">//***就是更新container中的HostConfig***//</span></div><div class="line">	<span class="keyword">if</span> err := daemon.setHostConfig(container, params.HostConfig); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> retErr != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> err := daemon.removeMountPoints(container, <span class="literal">true</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">				logrus.Error(err)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="comment">//***createContainerPlatformSpecificSettings()会调用daemon.Mount()和daemon.Unmount()***//</span></div><div class="line">	<span class="keyword">if</span> err := daemon.createContainerPlatformSpecificSettings(container, params.Config, params.HostConfig); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***设置网络模式***//</span></div><div class="line">	<span class="keyword">var</span> endpointsConfigs <span class="keyword">map</span>[<span class="keyword">string</span>]*networktypes.EndpointSettings</div><div class="line">	<span class="keyword">if</span> params.NetworkingConfig != <span class="literal">nil</span> &#123;</div><div class="line">		endpointsConfigs = params.NetworkingConfig.EndpointsConfig</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Make sure NetworkMode has an acceptable value. We do this to ensure</span></div><div class="line">	<span class="comment">// backwards API compatibility.</span></div><div class="line">	container.HostConfig = runconfig.SetDefaultNetModeIfBlank(container.HostConfig)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := daemon.updateContainerNetworkSettings(container, endpointsConfigs); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***把container的json写到容器目录***//</span></div><div class="line">	<span class="keyword">if</span> err := container.ToDisk(); err != <span class="literal">nil</span> &#123;</div><div class="line">		logrus.Errorf(<span class="string">"Error saving new container to disk: %v"</span>, err)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***注册container***//</span></div><div class="line">	<span class="keyword">if</span> err := daemon.Register(container); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	daemon.LogContainerEvent(container, <span class="string">"create"</span>)</div><div class="line">	<span class="keyword">return</span> container, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>获取imageID；</li>
<li>merge config；</li>
<li>处理log的配置；</li>
<li>调用newContainer()通过电脑一个container；</li>
<li>设置container安全相关的参数；</li>
<li>调用setRWLayer()创建读写层；</li>
<li>创建容器根目录；</li>
<li>设置网络模式；</li>
<li>把container的json写到容器目录；</li>
<li>调用Daemon的Register()注册新生成的container；</li>
<li>返回container。</li>
</ol>
<p>newContainer()定义在/daemon/container.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***生成一个新container***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(daemon *Daemon)</span> <span class="title">newContainer</span><span class="params">(name <span class="keyword">string</span>, config *containertypes.Config, imgID image.ID, managed <span class="keyword">bool</span>)</span> <span class="params">(*container.Container, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> (</div><div class="line">		id             <span class="keyword">string</span></div><div class="line">		err            error</div><div class="line">		noExplicitName = name == <span class="string">""</span></div><div class="line">	)</div><div class="line">	<span class="comment">//***生成id和name***//</span></div><div class="line">	id, name, err = daemon.generateIDAndName(name)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***设置hostname字段***//</span></div><div class="line">	daemon.generateHostname(id, config)</div><div class="line">	entrypoint, args := daemon.getEntrypointAndArgs(config.Entrypoint, config.Cmd)</div><div class="line"></div><div class="line">	base := daemon.newBaseContainer(id)</div><div class="line">	base.Created = time.Now().UTC()</div><div class="line">	base.Managed = managed</div><div class="line">	base.Path = entrypoint</div><div class="line">	base.Args = args <span class="comment">//<span class="doctag">FIXME:</span> de-duplicate from config</span></div><div class="line">	base.Config = config</div><div class="line">	base.HostConfig = &amp;containertypes.HostConfig&#123;&#125;</div><div class="line">	base.ImageID = imgID</div><div class="line">	base.NetworkSettings = &amp;network.Settings&#123;IsAnonymousEndpoint: noExplicitName&#125;</div><div class="line">	base.Name = name</div><div class="line">	base.Driver = daemon.GraphDriverName()</div><div class="line"></div><div class="line">	<span class="keyword">return</span> base, err</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="start流程-1"><a href="#start流程-1" class="headerlink" title="start流程"></a>start流程</h4><p>Daemon的ContainerStart()实现定义在/daemon/start.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***ContainerStart()实现，用来启动一个容器***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(daemon *Daemon)</span> <span class="title">ContainerStart</span><span class="params">(name <span class="keyword">string</span>, hostConfig *containertypes.HostConfig, validateHostname <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***获取container***//</span></div><div class="line">	container, err := daemon.GetContainer(name)</div><div class="line">	......</div><div class="line"></div><div class="line">	<span class="comment">// check if hostConfig is in line with the current system settings.</span></div><div class="line">	<span class="comment">// It may happen cgroups are umounted or the like.</span></div><div class="line">	<span class="comment">//****检测HostConfig***//</span></div><div class="line">	<span class="keyword">if</span> _, err = daemon.verifyContainerSettings(container.HostConfig, <span class="literal">nil</span>, <span class="literal">false</span>, validateHostname); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Adapt for old containers in case we have updates in this function and</span></div><div class="line">	<span class="comment">// old containers never have chance to call the new function in create stage.</span></div><div class="line">	<span class="keyword">if</span> err := daemon.adaptContainerSettings(container.HostConfig, <span class="literal">false</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***调用containerStart()***//</span></div><div class="line">	<span class="keyword">return</span> daemon.containerStart(container)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ContainerStart()的流程如下：</p>
<ol>
<li>调用GetContainer()获取name对应的container；</li>
<li>调用containerStart()启动容器。</li>
</ol>
<p>containerStart()定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(daemon *Daemon)</span> <span class="title">containerStart</span><span class="params">(container *container.Container)</span> <span class="params">(err error)</span></span> &#123;</div><div class="line">	......</div><div class="line"></div><div class="line">	<span class="comment">//***定义在/daemon/daemon_unix.go中***//</span></div><div class="line">	<span class="keyword">if</span> err := daemon.conditionalMountOnStart(container); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Make sure NetworkMode has an acceptable value. We do this to ensure</span></div><div class="line">	<span class="comment">// backwards API compatibility.</span></div><div class="line">	<span class="comment">//***确保NetworkMode存在***//</span></div><div class="line">	container.HostConfig = runconfig.SetDefaultNetModeIfBlank(container.HostConfig)</div><div class="line"></div><div class="line">	<span class="comment">//***初始化网络***//</span></div><div class="line">	<span class="comment">//***定义在/daemon/container_operations.go中***/</span></div><div class="line">	<span class="keyword">if</span> err := daemon.initializeNetworking(container); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***创建spec文件***//</span></div><div class="line">	<span class="comment">//***定义在/daemon/oci_linux中***//</span></div><div class="line">	spec, err := daemon.createSpec(container)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***获取createOptions***//</span></div><div class="line">	createOptions := []libcontainerd.CreateOption&#123;libcontainerd.WithRestartManager(container.RestartManager(<span class="literal">true</span>))&#125;</div><div class="line">	copts, err := daemon.getLibcontainerdCreateOptions(container)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> copts != <span class="literal">nil</span> &#123;</div><div class="line">		createOptions = <span class="built_in">append</span>(createOptions, *copts...)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***调用libcontainer的Create()函数创建容器***//</span></div><div class="line">	<span class="comment">//***定义在/libcontainerd/client_linux.go***//</span></div><div class="line">	<span class="keyword">if</span> err := daemon.containerd.Create(container.ID, *spec, createOptions...); err != <span class="literal">nil</span> &#123;</div><div class="line">		errDesc := grpc.ErrorDesc(err)</div><div class="line">		logrus.Errorf(<span class="string">"Create container failed with error: %s"</span>, errDesc)</div><div class="line">		<span class="comment">// if we receive an internal error from the initial start of a container then lets</span></div><div class="line">		<span class="comment">// return it instead of entering the restart loop</span></div><div class="line">		<span class="comment">// set to 127 for container cmd not found/does not exist)</span></div><div class="line">		<span class="keyword">if</span> strings.Contains(errDesc, container.Path) &amp;&amp;</div><div class="line">			(strings.Contains(errDesc, <span class="string">"executable file not found"</span>) ||</div><div class="line">				strings.Contains(errDesc, <span class="string">"no such file or directory"</span>) ||</div><div class="line">				strings.Contains(errDesc, <span class="string">"system cannot find the file specified"</span>)) &#123;</div><div class="line">			container.SetExitCode(<span class="number">127</span>)</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// set to 126 for container cmd can't be invoked errors</span></div><div class="line">		<span class="keyword">if</span> strings.Contains(errDesc, syscall.EACCES.Error()) &#123;</div><div class="line">			container.SetExitCode(<span class="number">126</span>)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		container.Reset(<span class="literal">false</span>)</div><div class="line"></div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"%s"</span>, errDesc)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>containerStart()的流程如下：</p>
<ol>
<li>调用conditionalMountOnStart()执行挂载操作；</li>
<li>调用runconfig.SetDefaultNetModeIfBlank()确保NetworkMode存在;</li>
<li>调用initializeNetworking()初始化网络；</li>
<li>调用createSpec()创建spec文件，即runc启动配置文件，里面有网络信息，volume挂载信息等；</li>
<li>调用containerd client的Create()创建容器。</li>
</ol>
<p>这里只分析conditionalMountOnStart()。conditionalMountOnStart()定义在/daemon/daemon_unix.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***daemon.Mount()定义在/daemon/daemon.go中***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(daemon *Daemon)</span> <span class="title">conditionalMountOnStart</span><span class="params">(container *container.Container)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> daemon.Mount(container)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>conditionalMountOnStart()调用Daemon的Mount()，Mount()定义在/daemon/daemon.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***执行挂载***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(daemon *Daemon)</span> <span class="title">Mount</span><span class="params">(container *container.Container)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***从具体目录启动添加的代码***//</span></div><div class="line">	<span class="comment">//	if baseFSDir, found := container.Config.Labels["baseFSDir"]; found &#123;</span></div><div class="line">	<span class="comment">//		if _, err := os.Lstat(baseFSDir); err != nil &#123;</span></div><div class="line">	<span class="comment">//			return fmt.Errorf("Error: cannot find baseFS dir %s", baseFSDir)</span></div><div class="line">	<span class="comment">//		&#125;</span></div><div class="line">	<span class="comment">//		container.BaseFS = baseFSDir</span></div><div class="line">	<span class="comment">//		return nil</span></div><div class="line">	<span class="comment">//	&#125;</span></div><div class="line"></div><div class="line">	<span class="comment">//***RWLayer.Mount()定义在/layer/mounted_layer.go中***//</span></div><div class="line">	<span class="comment">//***docker run -d nginx:v1命令的container.GetMountLabel()为空***//</span></div><div class="line">	dir, err := container.RWLayer.Mount(container.GetMountLabel())</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	logrus.Debugf(<span class="string">"container mounted via layerStore: %v"</span>, dir)</div><div class="line"></div><div class="line">	<span class="comment">//***create.go中调用：***//</span></div><div class="line">	<span class="comment">//***container.BaseFS为""***//</span></div><div class="line">	<span class="comment">//***dir: /var/lib/docker/aufs/mnt/c9a78db9f0c68201d4ba35720342a8c65751faabb514685fcb14d8b092eaaf09***//</span></div><div class="line">	<span class="comment">//***start.go中调用：***//</span></div><div class="line">	<span class="comment">//***container.BaseFS: /var/lib/docker/aufs/mnt/c9a78db9f0c68201d4ba35720342a8c65751faabb514685fcb14d8b092eaaf09***//</span></div><div class="line">	<span class="comment">//***dir: /var/lib/docker/aufs/mnt/c9a78db9f0c68201d4ba35720342a8c65751faabb514685fcb14d8b092eaaf09***//</span></div><div class="line">	<span class="keyword">if</span> container.BaseFS != dir &#123;</div><div class="line">		<span class="comment">// The mount path reported by the graph driver should always be trusted on Windows, since the</span></div><div class="line">		<span class="comment">// volume path for a given mounted layer may change over time.  This should only be an error</span></div><div class="line">		<span class="comment">// on non-Windows operating systems.</span></div><div class="line">		<span class="keyword">if</span> container.BaseFS != <span class="string">""</span> &amp;&amp; runtime.GOOS != <span class="string">"windows"</span> &#123;</div><div class="line">			daemon.Unmount(container)</div><div class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"Error: driver %s is returning inconsistent paths for container %s ('%s' then '%s')"</span>,</div><div class="line">				daemon.GraphDriverName(), container.ID, container.BaseFS, dir)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***container.BaseFS: /var/lib/docker/aufs/mnt/7471e8f2861af2df8a7906dab8d64409b57ff46164e30ee5e113f74be93e8e23***//</span></div><div class="line">	container.BaseFS = dir <span class="comment">// <span class="doctag">TODO:</span> combine these fields</span></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Mount()的流程如下：</p>
<ol>
<li>执行挂载操作，挂载目录为dir；</li>
<li>如果container.BaseFS和dir不相等，则执行Unmount操作；</li>
<li>设置container.BaseFS=dir。</li>
</ol>
<p>Mount()会执行两次，第一次是container.BaseFS和dir不相等，其作用就是设置container.BaseFS；第二次两者相等，则挂载状态将维持。<br>这里注释掉的内容是介绍如何从一个具体目录直接启动容器的，我们借用Docker label机制传入目录，然后设置container.BaseFS为传入的目录，从而直接从目录启动容器：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从具体目录启动添加的代码***//</span></div><div class="line"><span class="keyword">if</span> baseFSDir, found := container.Config.Labels[<span class="string">"baseFSDir"</span>]; found &#123;</div><div class="line">	<span class="keyword">if</span> _, err := os.Lstat(baseFSDir); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"Error: cannot find baseFS dir %s"</span>, baseFSDir)</div><div class="line">	&#125;</div><div class="line">	container.BaseFS = baseFSDir</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>容器的创建和启动流程涉及到非常多的代码，这里只是做了一个流程上的分析，具体功能的代码实现将分散到Docker的各模块分析中。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/12/25/Docker命令分行分析-run-v1-12-3/" data-id="cjbqbopq200059wqsuflpks51" class="article-share-link">分享</a><div class="tags"><a href="/tags/docker/">docker</a><a href="/tags/docker-v1-12-3/">docker-v1.12.3</a></div><div class="post-nav"><a href="/2017/12/26/tar-stream-demo/" class="pre">tar-stream-demo</a><a href="/2017/12/23/kubelet分析(七)-dockerManager(2)-v1-5-2/" class="next">kubelet分析(七)-dockerManager(2)-v1.5.2</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/28/Docker工具包分析-archive-v1-12-3/">Docker工具包分析-archive-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/27/Docker命令行分析-cp-v1-12-3/">Docker命令行分析-cp-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/26/tar-stream-demo/">tar-stream-demo</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/25/Docker命令分行分析-run-v1-12-3/">Docker命令分行分析-run-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/23/kubelet分析(七)-dockerManager(2)-v1-5-2/">kubelet分析(七)-dockerManager(2)-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/23/kubelet分析(七)-dockerManager(1)-v1-5-2/">kubelet分析(七)-dockerManager(1)-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/20/kubelet分析(六)-proberManager-v1-5-2/">kubelet分析(六)-proberManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/18/kubelet分析(五)-podManager-v1-5-2/">kubelet分析(五)-podManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(四)-statusManager-v1-5-2/">kubelet分析(四)-statusManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(三)-volumeManager-v1-5-2/">kubelet分析(三)-volumeManager-v1.5.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>