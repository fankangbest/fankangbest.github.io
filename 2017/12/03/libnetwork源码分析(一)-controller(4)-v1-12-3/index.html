<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>libnetwork源码分析(一)-controller(4)-v1-12-3 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">libnetwork源码分析(一)-controller(4)-v1-12-3</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">libnetwork源码分析(一)-controller(4)-v1-12-3</h1><div class="post-meta">Dec 3, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>本次文档将接着上次分析，介绍controller对store的管理。</p>
<h2 id="四-管理store"><a href="#四-管理store" class="headerlink" title="(四) 管理store"></a>(四) 管理store</h2><p>controller中有stores字段，所有store都注册在该字段中。当然，这里所说的store是datastore，datastore中包含consul, zookeeper, etcd及boltdb这些底层的store。</p>
<h3 id="初始化store"><a href="#初始化store" class="headerlink" title="初始化store"></a>初始化store</h3><p>在controller的New()函数中，使用下面语句初始化stores：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***初始化stores***//</span></div><div class="line"><span class="keyword">if</span> err := c.initStores(); err != <span class="literal">nil</span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>controller的initStores()方法定义在/libnetwork/store.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***初始化controller的stores***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">initStores</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***注册支持的kv store***//</span></div><div class="line">	registerKVStores()</div><div class="line"></div><div class="line">	c.Lock()</div><div class="line">	<span class="keyword">if</span> c.cfg == <span class="literal">nil</span> &#123;</div><div class="line">		c.Unlock()</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	scopeConfigs := c.cfg.Scopes</div><div class="line">	c.stores = <span class="literal">nil</span></div><div class="line">	c.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> scope, scfg := <span class="keyword">range</span> scopeConfigs &#123;</div><div class="line">		<span class="comment">//***调用initScopedStore()***//</span></div><div class="line">		<span class="keyword">if</span> err := c.initScopedStore(scope, scfg); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	c.startWatch()</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>initStores()主要调用了两个函数：registerKVStores()和initScopedStore()。</p>
<p>先看registerKVStores()，定义在/libnetwork/store.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">registerKVStores</span><span class="params">()</span></span> &#123;</div><div class="line">	consul.Register()</div><div class="line">	zookeeper.Register()</div><div class="line">	etcd.Register()</div><div class="line">	boltdb.Register()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，registerKVStores()调用了各store的Register()方法，我们以boltdb为例，其Register()定义在/libkv/store/boltdb/boltdb.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Register registers boltdb to libkv</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Register</span><span class="params">()</span></span> &#123;</div><div class="line">	libkv.AddStore(store.BOLTDB, New)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其又调用了libkv.AddStore()，定义在/libkv/libkv.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">initializers = <span class="built_in">make</span>(<span class="keyword">map</span>[store.Backend]Initialize)</div><div class="line"></div><div class="line"><span class="comment">// AddStore adds a new store backend to libkv</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">AddStore</span><span class="params">(store store.Backend, init Initialize)</span></span> &#123;</div><div class="line">	initializers[store] = init</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，libkv包中有一个全局变量initializers，而addStore就是把store和init函数加入到initializers map中，对于boltdb，其init函数就是boltdb.New()。</p>
<p>再来看initScopedStore()，定义在/libnetwork/store.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***初始化单个store，并放入stores***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">initScopedStore</span><span class="params">(scope <span class="keyword">string</span>, scfg *datastore.ScopeCfg)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***scope:  local***//</span></div><div class="line">	store, err := datastore.NewDataStore(scope, scfg)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	c.Lock()</div><div class="line">	c.stores = <span class="built_in">append</span>(c.stores, store)</div><div class="line">	c.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>initScopedStore()先调用datastore的NewDataStore()方法生成datastore，再把该datastore放入到controller的stores字段中。</p>
<p>datastore定义在/libnetwork/datastore/datastore.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> datastore <span class="keyword">struct</span> &#123;</div><div class="line">	scope      <span class="keyword">string</span></div><div class="line">	store      store.Store</div><div class="line">	cache      *cache</div><div class="line">	watchCh    <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</div><div class="line">	active     <span class="keyword">bool</span></div><div class="line">	sequential <span class="keyword">bool</span></div><div class="line">	sync.Mutex</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，datastore在store的基础上增加了scope，cache这些概念。scope为local和global，其中boltdb为local，而etcd等为global；cache提供了内存缓存机制。</p>
<p>来看datastore的NewDataStore()，定义在/libnetwork/datastore/datastore.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewDataStore creates a new instance of LibKV data store</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDataStore</span><span class="params">(scope <span class="keyword">string</span>, cfg *ScopeCfg)</span> <span class="params">(DataStore, error)</span></span> &#123;</div><div class="line">	<span class="comment">//***scope:  local***//</span></div><div class="line">	<span class="comment">//***cfg.Client.Provider:  boltdb***//</span></div><div class="line">	<span class="comment">//***cfg.Client.Address:  /var/lib/docker/network/files/local-kv.db***//</span></div><div class="line">	<span class="keyword">if</span> cfg == <span class="literal">nil</span> || cfg.Client.Provider == <span class="string">""</span> || cfg.Client.Address == <span class="string">""</span> &#123;</div><div class="line">		c, ok := defaultScopes[scope]</div><div class="line">		<span class="keyword">if</span> !ok || c.Client.Provider == <span class="string">""</span> || c.Client.Address == <span class="string">""</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unexpected scope %s without configuration passed"</span>, scope)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		cfg = c</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> cached <span class="keyword">bool</span></div><div class="line">	<span class="keyword">if</span> scope == LocalScope &#123;</div><div class="line">		cached = <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> newClient(scope, cfg.Client.Provider, cfg.Client.Address, cfg.Client.Config, cached)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，NewDataStore()主要调用了newClient()：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// newClient used to connect to KV Store</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newClient</span><span class="params">(scope <span class="keyword">string</span>, kv <span class="keyword">string</span>, addr <span class="keyword">string</span>, config *store.Config, cached <span class="keyword">bool</span>)</span> <span class="params">(DataStore, error)</span></span> &#123;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> cached &amp;&amp; scope != LocalScope &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"caching supported only for scope %s"</span>, LocalScope)</div><div class="line">	&#125;</div><div class="line">	sequential := <span class="literal">false</span></div><div class="line">	<span class="keyword">if</span> scope == LocalScope &#123;</div><div class="line">		sequential = <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> config == <span class="literal">nil</span> &#123;</div><div class="line">		config = &amp;store.Config&#123;&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> addrs []<span class="keyword">string</span></div><div class="line"></div><div class="line">	<span class="keyword">if</span> kv == <span class="keyword">string</span>(store.BOLTDB) &#123;</div><div class="line">		<span class="comment">// Parse file path</span></div><div class="line">		addrs = strings.Split(addr, <span class="string">","</span>)</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// Parse URI</span></div><div class="line">		parts := strings.SplitN(addr, <span class="string">"/"</span>, <span class="number">2</span>)</div><div class="line">		addrs = strings.Split(parts[<span class="number">0</span>], <span class="string">","</span>)</div><div class="line"></div><div class="line">		<span class="comment">// Add the custom prefix to the root chain</span></div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(parts) == <span class="number">2</span> &#123;</div><div class="line">			rootChain = <span class="built_in">append</span>([]<span class="keyword">string</span>&#123;parts[<span class="number">1</span>]&#125;, defaultRootChain...)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***创建store***//</span></div><div class="line">	store, err := libkv.NewStore(store.Backend(kv), addrs, config)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***把store封装成datastore***//</span></div><div class="line">	ds := &amp;datastore&#123;scope: scope, store: store, active: <span class="literal">true</span>, watchCh: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;), sequential: sequential&#125;</div><div class="line">	<span class="keyword">if</span> cached &#123;</div><div class="line">		ds.cache = newCache(ds)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> ds, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而newClient()会调用libkv包的NewStore()方法生成store，然后封装成datastore返回。所以回到libkv包看NewStore()，定义在/libkv/libkv.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewStore creates an instance of store</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewStore</span><span class="params">(backend store.Backend, addrs []<span class="keyword">string</span>, options *store.Config)</span> <span class="params">(store.Store, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> init, exists := initializers[backend]; exists &#123;</div><div class="line">		<span class="keyword">return</span> init(addrs, options)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"%s %s"</span>, store.ErrBackendNotSupported.Error(), supportedBackend)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>libkv的NewStore()从initializers获取到某kv存储对应的init函数，并执行。以boltdb为例，其init函数为boltdb.new()，定义在/libkv/store/boltdb/boltdb.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// New opens a new BoltDB connection to the specified path and bucket</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(endpoints []<span class="keyword">string</span>, options *store.Config)</span> <span class="params">(store.Store, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> (</div><div class="line">		db          *bolt.DB</div><div class="line">		err         error</div><div class="line">		boltOptions *bolt.Options</div><div class="line">	)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(endpoints) &gt; <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, ErrMultipleEndpointsUnsupported</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (options == <span class="literal">nil</span>) || (<span class="built_in">len</span>(options.Bucket) == <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, ErrBoltBucketOptionMissing</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	dir, _ := filepath.Split(endpoints[<span class="number">0</span>])</div><div class="line">	<span class="keyword">if</span> err = os.MkdirAll(dir, <span class="number">0750</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> options.PersistConnection &#123;</div><div class="line">		boltOptions = &amp;bolt.Options&#123;Timeout: options.ConnectionTimeout&#125;</div><div class="line">		db, err = bolt.Open(endpoints[<span class="number">0</span>], filePerm, boltOptions)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	b := &amp;BoltDB&#123;</div><div class="line">		client:            db,</div><div class="line">		path:              endpoints[<span class="number">0</span>],</div><div class="line">		boltBucket:        []<span class="keyword">byte</span>(options.Bucket),</div><div class="line">		timeout:           transientTimeout,</div><div class="line">		PersistConnection: options.PersistConnection,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> b, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以，现在store都被封装在dataStore中，然后在注册在controller的stores中。</p>
<h3 id="管理store"><a href="#管理store" class="headerlink" title="管理store"></a>管理store</h3><p>再来看下controller管理store所提供的方法。</p>
<h4 id="controller-closeStores"><a href="#controller-closeStores" class="headerlink" title="controller::closeStores()"></a>controller::closeStores()</h4><p>closeStores()可以关闭controller中所有store。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***关闭controller中所有store***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">closeStores</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, store := <span class="keyword">range</span> c.getStores() &#123;</div><div class="line">		store.Close()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="controller-getStore"><a href="#controller-getStore" class="headerlink" title="controller::getStore()"></a>controller::getStore()</h4><p>getStore()可以获取某scope类别下的store。注意，一般来说，local和global的scope下只各有一个store。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***依据scope获取store***//</span></div><div class="line"><span class="comment">//***scope有local和global两种***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">getStore</span><span class="params">(scope <span class="keyword">string</span>)</span> <span class="title">datastore</span>.<span class="title">DataStore</span></span> &#123;</div><div class="line">	c.Lock()</div><div class="line">	<span class="keyword">defer</span> c.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, store := <span class="keyword">range</span> c.stores &#123;</div><div class="line">		<span class="keyword">if</span> store.Scope() == scope &#123;</div><div class="line">			<span class="keyword">return</span> store</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="controller-getStores"><a href="#controller-getStores" class="headerlink" title="controller::getStores()"></a>controller::getStores()</h4><p>getStores()可以获取controller中所有store。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取store列表***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">getStores</span><span class="params">()</span> []<span class="title">datastore</span>.<span class="title">DataStore</span></span> &#123;</div><div class="line">	c.Lock()</div><div class="line">	<span class="keyword">defer</span> c.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">return</span> c.stores</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="管理store中的内容"><a href="#管理store中的内容" class="headerlink" title="管理store中的内容"></a>管理store中的内容</h3><p>接着来看controller管理store中内容所提供的方法。</p>
<h4 id="controller-getNetworkFromStore"><a href="#controller-getNetworkFromStore" class="headerlink" title="controller::getNetworkFromStore()"></a>controller::getNetworkFromStore()</h4><p>getNetworkFromStore()会轮询controller中所有store，然后获取nid对应的network。其核心调用的是datastore的GetObject()。network的key形式为”docker/network/v1.0/network/808d5fe607329f5e925492c4ae319b89ab021ba463cb59b8e3c93bd35a56d261/“。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***轮循stores，依据nid找到network***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">getNetworkFromStore</span><span class="params">(nid <span class="keyword">string</span>)</span> <span class="params">(*network, error)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, store := <span class="keyword">range</span> c.getStores() &#123;</div><div class="line">		n := &amp;network&#123;id: nid, ctrlr: c&#125;</div><div class="line">		<span class="comment">//***获取network***//</span></div><div class="line">		err := store.GetObject(datastore.Key(n.Key()...), n)</div><div class="line">		<span class="comment">// Continue searching in the next store if the key is not found in this store</span></div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> err != datastore.ErrKeyNotFound &#123;</div><div class="line">				log.Debugf(<span class="string">"could not find network %s: %v"</span>, nid, err)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//***获取endpoint count***//</span></div><div class="line">		ec := &amp;endpointCnt&#123;n: n&#125;</div><div class="line">		err = store.GetObject(datastore.Key(ec.Key()...), ec)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; !n.inDelete &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"could not find endpoint count for network %s: %v"</span>, n.Name(), err)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		n.epCnt = ec</div><div class="line">		n.scope = store.Scope()</div><div class="line">		<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"network %s not found"</span>, nid)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="controller-getNetworksForScope"><a href="#controller-getNetworksForScope" class="headerlink" title="controller::getNetworksForScope()"></a>controller::getNetworksForScope()</h4><p>getNetworksForScope()可以获取scope对应store下所有的network。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取scope对应的store下的network列表***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">getNetworksForScope</span><span class="params">(scope <span class="keyword">string</span>)</span> <span class="params">([]*network, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> nl []*network</div><div class="line"></div><div class="line">	store := c.getStore(scope)</div><div class="line">	<span class="keyword">if</span> store == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***获取network list***//</span></div><div class="line">	kvol, err := store.List(datastore.Key(datastore.NetworkKeyPrefix),</div><div class="line">		&amp;network&#123;ctrlr: c&#125;)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; err != datastore.ErrKeyNotFound &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"failed to get networks for scope %s: %v"</span>,</div><div class="line">			scope, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, kvo := <span class="keyword">range</span> kvol &#123;</div><div class="line">		n := kvo.(*network)</div><div class="line">		n.ctrlr = c</div><div class="line"></div><div class="line">		ec := &amp;endpointCnt&#123;n: n&#125;</div><div class="line">		err = store.GetObject(datastore.Key(ec.Key()...), ec)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; !n.inDelete &#123;</div><div class="line">			log.Warnf(<span class="string">"Could not find endpoint count key %s for network %s while listing: %v"</span>, datastore.Key(ec.Key()...), n.Name(), err)</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		n.epCnt = ec</div><div class="line">		n.scope = scope</div><div class="line">		nl = <span class="built_in">append</span>(nl, n)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> nl, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="controller-getNetworksFromStore"><a href="#controller-getNetworksFromStore" class="headerlink" title="controller::getNetworksFromStore()"></a>controller::getNetworksFromStore()</h4><p>getNetworksFromStore()可以获取所有store中的network。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***轮循stores，获取所有的network***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">getNetworksFromStore</span><span class="params">()</span> <span class="params">([]*network, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> nl []*network</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, store := <span class="keyword">range</span> c.getStores() &#123;</div><div class="line">		kvol, err := store.List(datastore.Key(datastore.NetworkKeyPrefix),</div><div class="line">			&amp;network&#123;ctrlr: c&#125;)</div><div class="line">		<span class="comment">// Continue searching in the next store if no keys found in this store</span></div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> err != datastore.ErrKeyNotFound &#123;</div><div class="line">				log.Debugf(<span class="string">"failed to get networks for scope %s: %v"</span>, store.Scope(), err)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">for</span> _, kvo := <span class="keyword">range</span> kvol &#123;</div><div class="line">			n := kvo.(*network)</div><div class="line">			n.Lock()</div><div class="line">			n.ctrlr = c</div><div class="line">			n.Unlock()</div><div class="line"></div><div class="line">			ec := &amp;endpointCnt&#123;n: n&#125;</div><div class="line">			err = store.GetObject(datastore.Key(ec.Key()...), ec)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; !n.inDelete &#123;</div><div class="line">				log.Warnf(<span class="string">"could not find endpoint count key %s for network %s while listing: %v"</span>, datastore.Key(ec.Key()...), n.Name(), err)</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line"></div><div class="line">			n.Lock()</div><div class="line">			n.epCnt = ec</div><div class="line">			n.scope = store.Scope()</div><div class="line">			n.Unlock()</div><div class="line">			nl = <span class="built_in">append</span>(nl, n)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> nl, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="controller-getEndpointFromStore"><a href="#controller-getEndpointFromStore" class="headerlink" title="controller::getEndpointFromStore()"></a>controller::getEndpointFromStore()</h4><p>getEndpointFromStore()可以依据eid获取endpoint。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***轮循stores，依据eid找到endpoint***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *network)</span> <span class="title">getEndpointFromStore</span><span class="params">(eid <span class="keyword">string</span>)</span> <span class="params">(*endpoint, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> errors []<span class="keyword">string</span></div><div class="line">	<span class="keyword">for</span> _, store := <span class="keyword">range</span> n.ctrlr.getStores() &#123;</div><div class="line">		ep := &amp;endpoint&#123;id: eid, network: n&#125;</div><div class="line">		err := store.GetObject(datastore.Key(ep.Key()...), ep)</div><div class="line">		<span class="comment">// Continue searching in the next store if the key is not found in this store</span></div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> err != datastore.ErrKeyNotFound &#123;</div><div class="line">				errors = <span class="built_in">append</span>(errors, fmt.Sprintf(<span class="string">"&#123;%s:%v&#125;, "</span>, store.Scope(), err))</div><div class="line">				log.Debugf(<span class="string">"could not find endpoint %s in %s: %v"</span>, eid, store.Scope(), err)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> ep, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"could not find endpoint %s: %v"</span>, eid, errors)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="controller-getEndpointsFromStore"><a href="#controller-getEndpointsFromStore" class="headerlink" title="controller::getEndpointsFromStore()"></a>controller::getEndpointsFromStore()</h4><p>getEndpointsFromStore()可以获取所有store中的endpoint。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***轮循stores，获取endpoint列表***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *network)</span> <span class="title">getEndpointsFromStore</span><span class="params">()</span> <span class="params">([]*endpoint, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> epl []*endpoint</div><div class="line"></div><div class="line">	tmp := endpoint&#123;network: n&#125;</div><div class="line">	<span class="keyword">for</span> _, store := <span class="keyword">range</span> n.getController().getStores() &#123;</div><div class="line">		kvol, err := store.List(datastore.Key(tmp.KeyPrefix()...), &amp;endpoint&#123;network: n&#125;)</div><div class="line">		<span class="comment">// Continue searching in the next store if no keys found in this store</span></div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> err != datastore.ErrKeyNotFound &#123;</div><div class="line">				log.Debugf(<span class="string">"failed to get endpoints for network %s scope %s: %v"</span>,</div><div class="line">					n.Name(), store.Scope(), err)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">for</span> _, kvo := <span class="keyword">range</span> kvol &#123;</div><div class="line">			ep := kvo.(*endpoint)</div><div class="line">			epl = <span class="built_in">append</span>(epl, ep)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> epl, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="controller-updateToStore"><a href="#controller-updateToStore" class="headerlink" title="controller::updateToStore()"></a>controller::updateToStore()</h4><p>updateToStore()为更新操作。其核心调用为datastore的PutObjectAtomic()方法。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***更新操作***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">updateToStore</span><span class="params">(kvObject datastore.KVObject)</span> <span class="title">error</span></span> &#123;</div><div class="line">	cs := c.getStore(kvObject.DataScope())</div><div class="line">	<span class="keyword">if</span> cs == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"datastore for scope %q is not initialized "</span>, kvObject.DataScope())</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := cs.PutObjectAtomic(kvObject); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> err == datastore.ErrKeyModified &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to update store for object type %T: %v"</span>, kvObject, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="controller-deleteFromStore"><a href="#controller-deleteFromStore" class="headerlink" title="controller::deleteFromStore()"></a>controller::deleteFromStore()</h4><p>deleteFromStore()可以从store中删除内容。其核心调用为datastore的DeleteObjectAtomic()。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***删除操作***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">deleteFromStore</span><span class="params">(kvObject datastore.KVObject)</span> <span class="title">error</span></span> &#123;</div><div class="line">	cs := c.getStore(kvObject.DataScope())</div><div class="line">	<span class="keyword">if</span> cs == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"datastore for scope %q is not initialized "</span>, kvObject.DataScope())</div><div class="line">	&#125;</div><div class="line"></div><div class="line">retry:</div><div class="line">	<span class="keyword">if</span> err := cs.DeleteObjectAtomic(kvObject); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> err == datastore.ErrKeyModified &#123;</div><div class="line">			<span class="keyword">if</span> err := cs.GetObject(datastore.Key(kvObject.Key()...), kvObject); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">"could not update the kvobject to latest when trying to delete: %v"</span>, err)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">goto</span> retry</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Watch方法"><a href="#Watch方法" class="headerlink" title="Watch方法"></a>Watch方法</h3><p>kv数据库都会提供watch方法，来看下controller的watch方法提供的方法。</p>
<h4 id="controller-startWatch"><a href="#controller-startWatch" class="headerlink" title="controller::startWatch()"></a>controller::startWatch()</h4><p>startWatch()会启动go routine消费controller的watchCh和unWatchCh中的内容。其中watchCh中的内容由processEndpointCreate()处理；unWatchCh中的内容 由processEndpointDelete()处理。watchCh中的内容由watchSvcRecord()方法放入；unWatchCh中的内容由unWatchSvcRecord()放入。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">startWatch</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> c.watchCh != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	c.watchCh = <span class="built_in">make</span>(<span class="keyword">chan</span> *endpoint)</div><div class="line">	c.unWatchCh = <span class="built_in">make</span>(<span class="keyword">chan</span> *endpoint)</div><div class="line">	c.nmap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*netWatch)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> c.watchLoop()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">watchLoop</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">select</span> &#123;</div><div class="line">		<span class="keyword">case</span> ep := &lt;-c.watchCh:</div><div class="line">			c.processEndpointCreate(c.nmap, ep)</div><div class="line">		<span class="keyword">case</span> ep := &lt;-c.unWatchCh:</div><div class="line">			c.processEndpointDelete(c.nmap, ep)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">watchSvcRecord</span><span class="params">(ep *endpoint)</span></span> &#123;</div><div class="line">	c.watchCh &lt;- ep</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">unWatchSvcRecord</span><span class="params">(ep *endpoint)</span></span> &#123;</div><div class="line">	c.unWatchCh &lt;- ep</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>感觉watch操作和docker service有关，现在对service还不熟，留着以后分析。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/12/03/libnetwork源码分析(一)-controller(4)-v1-12-3/" data-id="cjb7l1zkg005ctkqs7i7if8g0" class="article-share-link">分享</a><div class="tags"><a href="/tags/docker/">docker</a><a href="/tags/docker-v1-12-3/">docker-v1.12.3</a></div><div class="post-nav"><a href="/2017/12/03/libnetwork源码分析(一)-controller(5)-v1-12-3/" class="pre">libnetwork源码分析(一)-controller(5)-v1-12-3</a><a href="/2017/12/03/libnetwork源码分析(一)-controller(3)-v1-12-3/" class="next">libnetwork源码分析(一)-controller(3)-v1-12-3</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/15/storage解读(六)-strategy-v1-5-2/">storage解读(六)-strategy-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/14/kubernetes-listwatch机制-v1-5-2/">kubernetes-listwatch机制-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/kubernetes-添加controller-demo-v1-5-2/">kubernetes-添加controller-demo-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/kubernetes-添加资源-demo-v1-5-2/">kubernetes-添加资源-demo-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/04/libnetwork源码分析(二)-network-v1-12-3/">libnetwork源码分析(二)-network-v1-12-3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/03/libnetwork源码分析(一)-controller(5)-v1-12-3/">libnetwork源码分析(一)-controller(5)-v1-12-3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/03/libnetwork源码分析(一)-controller(4)-v1-12-3/">libnetwork源码分析(一)-controller(4)-v1-12-3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/03/libnetwork源码分析(一)-controller(3)-v1-12-3/">libnetwork源码分析(一)-controller(3)-v1-12-3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/02/libnetwork源码分析(一)-controller(2)-v1-12-3/">libnetwork源码分析(一)-controller(2)-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/02/libnetwork源码分析(一)-controller(1)-v1-12-3/">libnetwork源码分析(一)-controller(1)-v1.12.3</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>