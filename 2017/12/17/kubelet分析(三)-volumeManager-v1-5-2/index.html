<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>kubelet分析(三)-volumeManager-v1.5.2 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">kubelet分析(三)-volumeManager-v1.5.2</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">kubelet分析(三)-volumeManager-v1.5.2</h1><div class="post-meta">Dec 17, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>本次分析将介绍kubelet的volumeManager。volumeManager负责维护volume挂载与ETCD中数据的一致性。</p>
<h2 id="actualStateOfWorld"><a href="#actualStateOfWorld" class="headerlink" title="actualStateOfWorld"></a>actualStateOfWorld</h2><p>actualStateOfWorld代表了目前物理主机上volume的挂载状态，定义在/pkg/kubelet/volumemanager/cache/actual_state_of_world.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> actualStateOfWorld <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// nodeName is the name of this node. This value is passed to Attach/Detach</span></div><div class="line">	nodeName types.NodeName</div><div class="line"></div><div class="line">	<span class="comment">// attachedVolumes is a map containing the set of volumes the kubelet volume</span></div><div class="line">	<span class="comment">// manager believes to be successfully attached to this node. Volume types</span></div><div class="line">	<span class="comment">// that do not implement an attacher interface are assumed to be in this</span></div><div class="line">	<span class="comment">// state by default.</span></div><div class="line">	<span class="comment">// The key in this map is the name of the volume and the value is an object</span></div><div class="line">	<span class="comment">// containing more information about the attached volume.</span></div><div class="line">	<span class="comment">//***记录volume被attached***//</span></div><div class="line">	attachedVolumes <span class="keyword">map</span>[api.UniqueVolumeName]attachedVolume</div><div class="line"></div><div class="line">	<span class="comment">// volumePluginMgr is the volume plugin manager used to create volume</span></div><div class="line">	<span class="comment">// plugin objects.</span></div><div class="line">	volumePluginMgr *volume.VolumePluginMgr</div><div class="line">	sync.RWMutex</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>主要字段含义如下：</p>
<ol>
<li>nodeName: 物理主机名称；</li>
<li>attachedVolumes: volume名称到attachedVolume的映射，attachedVolume表示已经挂载好的volume；</li>
<li>volumePluginMgr: volume plugin管理者。</li>
</ol>
<p>再来看下attachedVolume的定义：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> attachedVolume <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// volumeName contains the unique identifier for this volume.</span></div><div class="line">	volumeName api.UniqueVolumeName</div><div class="line"></div><div class="line">	<span class="comment">// mountedPods is a map containing the set of pods that this volume has been</span></div><div class="line">	<span class="comment">// successfully mounted to. The key in this map is the name of the pod and</span></div><div class="line">	<span class="comment">// the value is a mountedPod object containing more information about the</span></div><div class="line">	<span class="comment">// pod.</span></div><div class="line">	<span class="comment">//***volume到pods的映射，即记录volume被mounted到pod***//</span></div><div class="line">	mountedPods <span class="keyword">map</span>[volumetypes.UniquePodName]mountedPod</div><div class="line"></div><div class="line">	<span class="comment">// spec is the volume spec containing the specification for this volume.</span></div><div class="line">	<span class="comment">// Used to generate the volume plugin object, and passed to plugin methods.</span></div><div class="line">	<span class="comment">// In particular, the Unmount method uses spec.Name() as the volumeSpecName</span></div><div class="line">	<span class="comment">// in the mount path:</span></div><div class="line">	<span class="comment">// /var/lib/kubelet/pods/&#123;podUID&#125;/volumes/&#123;escapeQualifiedPluginName&#125;/&#123;volumeSpecName&#125;/</span></div><div class="line">	spec *volume.Spec</div><div class="line"></div><div class="line">	<span class="comment">// pluginName is the Unescaped Qualified name of the volume plugin used to</span></div><div class="line">	<span class="comment">// attach and mount this volume. It is stored separately in case the full</span></div><div class="line">	<span class="comment">// volume spec (everything except the name) can not be reconstructed for a</span></div><div class="line">	<span class="comment">// volume that should be unmounted (which would be the case for a mount path</span></div><div class="line">	<span class="comment">// read from disk without a full volume spec).</span></div><div class="line">	pluginName <span class="keyword">string</span></div><div class="line"></div><div class="line">	<span class="comment">// pluginIsAttachable indicates the volume plugin used to attach and mount</span></div><div class="line">	<span class="comment">// this volume implements the volume.Attacher interface</span></div><div class="line">	pluginIsAttachable <span class="keyword">bool</span></div><div class="line"></div><div class="line">	<span class="comment">// globallyMounted indicates that the volume is mounted to the underlying</span></div><div class="line">	<span class="comment">// device at a global mount point. This global mount point must be unmounted</span></div><div class="line">	<span class="comment">// prior to detach.</span></div><div class="line">	globallyMounted <span class="keyword">bool</span></div><div class="line"></div><div class="line">	<span class="comment">// devicePath contains the path on the node where the volume is attached for</span></div><div class="line">	<span class="comment">// attachable volumes</span></div><div class="line">	devicePath <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>attachedVolume中有mountedPods字段，记录了该volume和使用该volume的pod的映射关系。</p>
<p>现在来看actualStateOfWorld实现的主要方法。</p>
<h4 id="actualStateOfWorld-MarkVolumeAsAttached"><a href="#actualStateOfWorld-MarkVolumeAsAttached" class="headerlink" title="actualStateOfWorld::MarkVolumeAsAttached()"></a>actualStateOfWorld::MarkVolumeAsAttached()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(asw *actualStateOfWorld)</span> <span class="title">MarkVolumeAsAttached</span><span class="params">(</span></span></div><div class="line">	volumeName api.UniqueVolumeName, volumeSpec *volume.Spec, _ types.NodeName, devicePath <span class="keyword">string</span>) <span class="title">error</span> &#123;</div><div class="line">	<span class="keyword">return</span> asw.addVolume(volumeName, volumeSpec, devicePath)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>attach的过程在actualStateOfWorld中的表现就是把volume加入到actualStateOfWorld，通过调用addVolume()方法完成。</p>
<h4 id="actualStateOfWorld-MarkVolumeDetached"><a href="#actualStateOfWorld-MarkVolumeDetached" class="headerlink" title="actualStateOfWorld::MarkVolumeDetached()"></a>actualStateOfWorld::MarkVolumeDetached()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(asw *actualStateOfWorld)</span> <span class="title">MarkVolumeAsDetached</span><span class="params">(</span></span></div><div class="line">	volumeName api.UniqueVolumeName, nodeName types.NodeName) &#123;</div><div class="line">	asw.DeleteVolume(volumeName)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>dettach的过程在actualStateOfWorld中的表现就是把volume从actualStateOfWorld中删除，通过调用DeleteVolume()完成。</p>
<h4 id="actualStateOfWorld-MarkVolumeAsMounted"><a href="#actualStateOfWorld-MarkVolumeAsMounted" class="headerlink" title="actualStateOfWorld::MarkVolumeAsMounted()"></a>actualStateOfWorld::MarkVolumeAsMounted()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***标记volume被mounted***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(asw *actualStateOfWorld)</span> <span class="title">MarkVolumeAsMounted</span><span class="params">(</span></span></div><div class="line">	podName volumetypes.UniquePodName,</div><div class="line">	podUID types.UID,</div><div class="line">	volumeName api.UniqueVolumeName,</div><div class="line">	mounter volume.Mounter,</div><div class="line">	outerVolumeSpecName <span class="keyword">string</span>,</div><div class="line">	volumeGidValue <span class="keyword">string</span>) <span class="title">error</span> &#123;</div><div class="line">	<span class="keyword">return</span> asw.AddPodToVolume(</div><div class="line">		podName,</div><div class="line">		podUID,</div><div class="line">		volumeName,</div><div class="line">		mounter,</div><div class="line">		outerVolumeSpecName,</div><div class="line">		volumeGidValue)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>mount的过程在actualStateOfWorld中的表现就是把pod信息记录到actualStateOfWorld的attachedVolume中，通过调用AddPodToVolume()完成。</p>
<h4 id="actualStateOfWorld-MarkVolumeAsUnmounted"><a href="#actualStateOfWorld-MarkVolumeAsUnmounted" class="headerlink" title="actualStateOfWorld::MarkVolumeAsUnmounted()"></a>actualStateOfWorld::MarkVolumeAsUnmounted()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***把volume从actual world中删除***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(asw *actualStateOfWorld)</span> <span class="title">MarkVolumeAsUnmounted</span><span class="params">(</span></span></div><div class="line">	podName volumetypes.UniquePodName, volumeName api.UniqueVolumeName) <span class="title">error</span> &#123;</div><div class="line">	<span class="keyword">return</span> asw.DeletePodFromVolume(podName, volumeName)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>unmount的过程在actualStateOfWorld中的表现就是把pod和volume的关系从actualStateOfWorld的attachedVolume中删除，通过DeletePodFromVolume()完成。</p>
<h4 id="actualStateOfWorld-addVolume"><a href="#actualStateOfWorld-addVolume" class="headerlink" title="actualStateOfWorld::addVolume()"></a>actualStateOfWorld::addVolume()</h4><p>addVolume()可以把volume加入到actualStateOfWorld上。volume会生成自己的attachedVolume。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// addVolume adds the given volume to the cache indicating the specified</span></div><div class="line"><span class="comment">// volume is attached to this node. If no volume name is supplied, a unique</span></div><div class="line"><span class="comment">// volume name is generated from the volumeSpec and returned on success. If a</span></div><div class="line"><span class="comment">// volume with the same generated name already exists, this is a noop. If no</span></div><div class="line"><span class="comment">// volume plugin can support the given volumeSpec or more than one plugin can</span></div><div class="line"><span class="comment">// support it, an error is returned.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(asw *actualStateOfWorld)</span> <span class="title">addVolume</span><span class="params">(</span></span></div><div class="line">	volumeName api.UniqueVolumeName, volumeSpec *volume.Spec, devicePath <span class="keyword">string</span>) <span class="title">error</span> &#123;</div><div class="line">	asw.Lock()</div><div class="line">	<span class="keyword">defer</span> asw.Unlock()</div><div class="line"></div><div class="line">	<span class="comment">//***通过volume spec找到volume plugin***//</span></div><div class="line">	volumePlugin, err := asw.volumePluginMgr.FindPluginBySpec(volumeSpec)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> || volumePlugin == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(</div><div class="line">			<span class="string">"failed to get Plugin from volumeSpec for volume %q err=%v"</span>,</div><div class="line">			volumeSpec.Name(),</div><div class="line">			err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(volumeName) == <span class="number">0</span> &#123;</div><div class="line">		volumeName, err = volumehelper.GetUniqueVolumeNameFromSpec(volumePlugin, volumeSpec)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> fmt.Errorf(</div><div class="line">				<span class="string">"failed to GetUniqueVolumeNameFromSpec for volumeSpec %q using volume plugin %q err=%v"</span>,</div><div class="line">				volumeSpec.Name(),</div><div class="line">				volumePlugin.GetPluginName(),</div><div class="line">				err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***确认该volume可以被attach***//</span></div><div class="line">	pluginIsAttachable := <span class="literal">false</span></div><div class="line">	<span class="keyword">if</span> _, ok := volumePlugin.(volume.AttachableVolumePlugin); ok &#123;</div><div class="line">		pluginIsAttachable = <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	volumeObj, volumeExists := asw.attachedVolumes[volumeName]</div><div class="line">	<span class="keyword">if</span> !volumeExists &#123;</div><div class="line">		volumeObj = attachedVolume&#123;</div><div class="line">			volumeName:         volumeName,</div><div class="line">			spec:               volumeSpec,</div><div class="line">			mountedPods:        <span class="built_in">make</span>(<span class="keyword">map</span>[volumetypes.UniquePodName]mountedPod),</div><div class="line">			pluginName:         volumePlugin.GetPluginName(),</div><div class="line">			pluginIsAttachable: pluginIsAttachable,</div><div class="line">			globallyMounted:    <span class="literal">false</span>,</div><div class="line">			devicePath:         devicePath,</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// If volume object already exists, update the fields such as device path</span></div><div class="line">		volumeObj.devicePath = devicePath</div><div class="line">		glog.V(<span class="number">2</span>).Infof(<span class="string">"Volume %q is already added to attachedVolume list, update device path %q"</span>,</div><div class="line">			volumeName,</div><div class="line">			devicePath)</div><div class="line">	&#125;</div><div class="line">	asw.attachedVolumes[volumeName] = volumeObj</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="actualStateOfWorld-DeleteVolume"><a href="#actualStateOfWorld-DeleteVolume" class="headerlink" title="actualStateOfWorld::DeleteVolume()"></a>actualStateOfWorld::DeleteVolume()</h4><p>DeleteVolume()可以从actualStateOfWorld中删除volume。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从actual world中删除volume***//</span></div><div class="line"><span class="comment">//***若volume挂载到某pod中，则返回错误***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(asw *actualStateOfWorld)</span> <span class="title">DeleteVolume</span><span class="params">(volumeName api.UniqueVolumeName)</span> <span class="title">error</span></span> &#123;</div><div class="line">	asw.Lock()</div><div class="line">	<span class="keyword">defer</span> asw.Unlock()</div><div class="line"></div><div class="line">	volumeObj, volumeExists := asw.attachedVolumes[volumeName]</div><div class="line">	<span class="keyword">if</span> !volumeExists &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(volumeObj.mountedPods) != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(</div><div class="line">			<span class="string">"failed to DeleteVolume %q, it still has %v mountedPods"</span>,</div><div class="line">			volumeName,</div><div class="line">			<span class="built_in">len</span>(volumeObj.mountedPods))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="built_in">delete</span>(asw.attachedVolumes, volumeName)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="actualStateOfWorld-VolumeExists"><a href="#actualStateOfWorld-VolumeExists" class="headerlink" title="actualStateOfWorld::VolumeExists()"></a>actualStateOfWorld::VolumeExists()</h4><p>VolumeExists()可以返回volume在actualStateOfWorld中是否存在。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***检查volume是否已经存***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(asw *actualStateOfWorld)</span> <span class="title">VolumeExists</span><span class="params">(</span></span></div><div class="line">	volumeName api.UniqueVolumeName) <span class="title">bool</span> &#123;</div><div class="line">	asw.RLock()</div><div class="line">	<span class="keyword">defer</span> asw.RUnlock()</div><div class="line"></div><div class="line">	_, volumeExists := asw.attachedVolumes[volumeName]</div><div class="line">	<span class="keyword">return</span> volumeExists</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="actualStateOfWorld-AddPodToVolume"><a href="#actualStateOfWorld-AddPodToVolume" class="headerlink" title="actualStateOfWorld::AddPodToVolume()"></a>actualStateOfWorld::AddPodToVolume()</h4><p>AddPodToVolume()把pod的信息加入到volume对应的attachedVolume中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***把pod的信息加入到对应的volume的mountedPods中***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(asw *actualStateOfWorld)</span> <span class="title">AddPodToVolume</span><span class="params">(</span></span></div><div class="line">	podName volumetypes.UniquePodName,</div><div class="line">	podUID types.UID,</div><div class="line">	volumeName api.UniqueVolumeName,</div><div class="line">	mounter volume.Mounter,</div><div class="line">	outerVolumeSpecName <span class="keyword">string</span>,</div><div class="line">	volumeGidValue <span class="keyword">string</span>) <span class="title">error</span> &#123;</div><div class="line">	asw.Lock()</div><div class="line">	<span class="keyword">defer</span> asw.Unlock()</div><div class="line"></div><div class="line">	volumeObj, volumeExists := asw.attachedVolumes[volumeName]</div><div class="line">	<span class="keyword">if</span> !volumeExists &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(</div><div class="line">			<span class="string">"no volume with the name %q exists in the list of attached volumes"</span>,</div><div class="line">			volumeName)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	podObj, podExists := volumeObj.mountedPods[podName]</div><div class="line">	<span class="keyword">if</span> !podExists &#123;</div><div class="line">		podObj = mountedPod&#123;</div><div class="line">			podName:             podName,</div><div class="line">			podUID:              podUID,</div><div class="line">			mounter:             mounter,</div><div class="line">			outerVolumeSpecName: outerVolumeSpecName,</div><div class="line">			volumeGidValue:      volumeGidValue,</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// If pod exists, reset remountRequired value</span></div><div class="line">	podObj.remountRequired = <span class="literal">false</span></div><div class="line">	asw.attachedVolumes[volumeName].mountedPods[podName] = podObj</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="actualStateOfWorld-DeletePodFromVolume"><a href="#actualStateOfWorld-DeletePodFromVolume" class="headerlink" title="actualStateOfWorld::DeletePodFromVolume()"></a>actualStateOfWorld::DeletePodFromVolume()</h4><p>DeletePodFromVolume()从actualStateOfWorld中volume对应的attachedVolume中删除pod信息。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***删除volume到pod的map中的pod***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(asw *actualStateOfWorld)</span> <span class="title">DeletePodFromVolume</span><span class="params">(</span></span></div><div class="line">	podName volumetypes.UniquePodName, volumeName api.UniqueVolumeName) <span class="title">error</span> &#123;</div><div class="line">	asw.Lock()</div><div class="line">	<span class="keyword">defer</span> asw.Unlock()</div><div class="line"></div><div class="line">	volumeObj, volumeExists := asw.attachedVolumes[volumeName]</div><div class="line">	<span class="keyword">if</span> !volumeExists &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(</div><div class="line">			<span class="string">"no volume with the name %q exists in the list of attached volumes"</span>,</div><div class="line">			volumeName)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	_, podExists := volumeObj.mountedPods[podName]</div><div class="line">	<span class="keyword">if</span> podExists &#123;</div><div class="line">		<span class="built_in">delete</span>(asw.attachedVolumes[volumeName].mountedPods, podName)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="actualStateOfWorld-PodExistsInVolume"><a href="#actualStateOfWorld-PodExistsInVolume" class="headerlink" title="actualStateOfWorld::PodExistsInVolume()"></a>actualStateOfWorld::PodExistsInVolume()</h4><p>PodExistsInVolume()可以返回pod是否挂载volume。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***检查pod是否已经在volume的map中***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(asw *actualStateOfWorld)</span> <span class="title">PodExistsInVolume</span><span class="params">(</span></span></div><div class="line">	podName volumetypes.UniquePodName,</div><div class="line">	volumeName api.UniqueVolumeName) <span class="params">(<span class="keyword">bool</span>, <span class="keyword">string</span>, error)</span> &#123;</div><div class="line">	asw.RLock()</div><div class="line">	<span class="keyword">defer</span> asw.RUnlock()</div><div class="line"></div><div class="line">	volumeObj, volumeExists := asw.attachedVolumes[volumeName]</div><div class="line">	<span class="keyword">if</span> !volumeExists &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="string">""</span>, newVolumeNotAttachedError(volumeName)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	podObj, podExists := volumeObj.mountedPods[podName]</div><div class="line">	<span class="keyword">if</span> podExists &amp;&amp; podObj.remountRequired &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span>, volumeObj.devicePath, newRemountRequiredError(volumeObj.volumeName, podObj.podName)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> podExists, volumeObj.devicePath, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="desiredStateOfWorld"><a href="#desiredStateOfWorld" class="headerlink" title="desiredStateOfWorld"></a>desiredStateOfWorld</h2><p>接着分析desiredStateOfWorld。disiredStateOfWorld表示系统希望得到的挂载状态，定义在/pkg/kubelet/volumemanager/cache/desired_state_of_world.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> desiredStateOfWorld <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// volumesToMount is a map containing the set of volumes that should be</span></div><div class="line">	<span class="comment">// attached to this node and mounted to the pods referencing it. The key in</span></div><div class="line">	<span class="comment">// the map is the name of the volume and the value is a volume object</span></div><div class="line">	<span class="comment">// containing more information about the volume.</span></div><div class="line">	<span class="comment">//***volumesToMount的key为volume name，value为volumeToMount***//</span></div><div class="line">	volumesToMount <span class="keyword">map</span>[api.UniqueVolumeName]volumeToMount</div><div class="line">	<span class="comment">// volumePluginMgr is the volume plugin manager used to create volume</span></div><div class="line">	<span class="comment">// plugin objects.</span></div><div class="line">	volumePluginMgr *volume.VolumePluginMgr</div><div class="line"></div><div class="line">	sync.RWMutex</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NewDesiredStateOfWorld returns a new instance of DesiredStateOfWorld.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDesiredStateOfWorld</span><span class="params">(volumePluginMgr *volume.VolumePluginMgr)</span> <span class="title">DesiredStateOfWorld</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;desiredStateOfWorld&#123;</div><div class="line">		volumesToMount:  <span class="built_in">make</span>(<span class="keyword">map</span>[api.UniqueVolumeName]volumeToMount),</div><div class="line">		volumePluginMgr: volumePluginMgr,</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到desiredStateOfWorld中有个volumesToMount的字段记录了volume名称和volumeToMount的映射。volumeToMount的定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// The volume object represents a volume that should be attached to this node,</span></div><div class="line"><span class="comment">// and mounted to podsToMount.</span></div><div class="line"><span class="keyword">type</span> volumeToMount <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// volumeName contains the unique identifier for this volume.</span></div><div class="line">	volumeName api.UniqueVolumeName</div><div class="line"></div><div class="line">	<span class="comment">// podsToMount is a map containing the set of pods that reference this</span></div><div class="line">	<span class="comment">// volume and should mount it once it is attached. The key in the map is</span></div><div class="line">	<span class="comment">// the name of the pod and the value is a pod object containing more</span></div><div class="line">	<span class="comment">// information about the pod.</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***podToMount中有pod信息***//</span></div><div class="line">	podsToMount <span class="keyword">map</span>[types.UniquePodName]podToMount</div><div class="line"></div><div class="line">	<span class="comment">// pluginIsAttachable indicates that the plugin for this volume implements</span></div><div class="line">	<span class="comment">// the volume.Attacher interface</span></div><div class="line">	pluginIsAttachable <span class="keyword">bool</span></div><div class="line"></div><div class="line">	<span class="comment">// volumeGidValue contains the value of the GID annotation, if present.</span></div><div class="line">	volumeGidValue <span class="keyword">string</span></div><div class="line"></div><div class="line">	<span class="comment">// reportedInUse indicates that the volume was successfully added to the</span></div><div class="line">	<span class="comment">// VolumesInUse field in the node's status.</span></div><div class="line">	reportedInUse <span class="keyword">bool</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>来看下desiredStateOfWorld实现的方法.</p>
<h4 id="desiredStateOfWorld-AddPodToVolume"><a href="#desiredStateOfWorld-AddPodToVolume" class="headerlink" title="desiredStateOfWorld::AddPodToVolume()"></a>desiredStateOfWorld::AddPodToVolume()</h4><p>AddPodToVolume()把pod信息加入到desiredStateOfWorld的volumeToMount中。其中的参数volumeSpec是最终的volume的信息，如PVC时，会转换到PV的信息，其他则各pod中定义的volume信息相同。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***把pod加入到podsToMount中***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dsw *desiredStateOfWorld)</span> <span class="title">AddPodToVolume</span><span class="params">(</span></span></div><div class="line">	podName types.UniquePodName,</div><div class="line">	pod *api.Pod,</div><div class="line">	volumeSpec *volume.Spec,</div><div class="line">	outerVolumeSpecName <span class="keyword">string</span>,</div><div class="line">	volumeGidValue <span class="keyword">string</span>) <span class="params">(api.UniqueVolumeName, error)</span> &#123;</div><div class="line">	dsw.Lock()</div><div class="line">	<span class="keyword">defer</span> dsw.Unlock()</div><div class="line"></div><div class="line">	volumePlugin, err := dsw.volumePluginMgr.FindPluginBySpec(volumeSpec)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> || volumePlugin == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(</div><div class="line">			<span class="string">"failed to get Plugin from volumeSpec for volume %q err=%v"</span>,</div><div class="line">			volumeSpec.Name(),</div><div class="line">			err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> volumeName api.UniqueVolumeName</div><div class="line"></div><div class="line">	<span class="comment">// The unique volume name used depends on whether the volume is attachable</span></div><div class="line">	<span class="comment">// or not.</span></div><div class="line">	attachable := dsw.isAttachableVolume(volumeSpec)</div><div class="line">	<span class="keyword">if</span> attachable &#123;</div><div class="line">		<span class="comment">// For attachable volumes, use the unique volume name as reported by</span></div><div class="line">		<span class="comment">// the plugin.</span></div><div class="line">		volumeName, err =</div><div class="line">			volumehelper.GetUniqueVolumeNameFromSpec(volumePlugin, volumeSpec)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(</div><div class="line">				<span class="string">"failed to GetUniqueVolumeNameFromSpec for volumeSpec %q using volume plugin %q err=%v"</span>,</div><div class="line">				volumeSpec.Name(),</div><div class="line">				volumePlugin.GetPluginName(),</div><div class="line">				err)</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// For non-attachable volumes, generate a unique name based on the pod</span></div><div class="line">		<span class="comment">// namespace and name and the name of the volume within the pod.</span></div><div class="line">		volumeName = volumehelper.GetUniqueVolumeNameForNonAttachableVolume(podName, volumePlugin, volumeSpec)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	volumeObj, volumeExists := dsw.volumesToMount[volumeName]</div><div class="line">	<span class="keyword">if</span> !volumeExists &#123;</div><div class="line">		volumeObj = volumeToMount&#123;</div><div class="line">			volumeName:         volumeName,</div><div class="line">			podsToMount:        <span class="built_in">make</span>(<span class="keyword">map</span>[types.UniquePodName]podToMount),</div><div class="line">			pluginIsAttachable: attachable,</div><div class="line">			volumeGidValue:     volumeGidValue,</div><div class="line">			reportedInUse:      <span class="literal">false</span>,</div><div class="line">		&#125;</div><div class="line">		dsw.volumesToMount[volumeName] = volumeObj</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Create new podToMount object. If it already exists, it is refreshed with</span></div><div class="line">	<span class="comment">// updated values (this is required for volumes that require remounting on</span></div><div class="line">	<span class="comment">// pod update, like Downward API volumes).</span></div><div class="line">	dsw.volumesToMount[volumeName].podsToMount[podName] = podToMount&#123;</div><div class="line">		podName:             podName,</div><div class="line">		pod:                 pod,</div><div class="line">		spec:                volumeSpec,</div><div class="line">		outerVolumeSpecName: outerVolumeSpecName,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> volumeName, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="desiredStateOfWorld-DeletePodFromVolume"><a href="#desiredStateOfWorld-DeletePodFromVolume" class="headerlink" title="desiredStateOfWorld::DeletePodFromVolume()"></a>desiredStateOfWorld::DeletePodFromVolume()</h4><p>DeletePodFromVolume()把pod从指定volumeName对应的volumeToMount中删除。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***把pod从podsToMount中删除***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dsw *desiredStateOfWorld)</span> <span class="title">DeletePodFromVolume</span><span class="params">(</span></span></div><div class="line">	podName types.UniquePodName, volumeName api.UniqueVolumeName) &#123;</div><div class="line">	dsw.Lock()</div><div class="line">	<span class="keyword">defer</span> dsw.Unlock()</div><div class="line"></div><div class="line">	volumeObj, volumeExists := dsw.volumesToMount[volumeName]</div><div class="line">	<span class="keyword">if</span> !volumeExists &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> _, podExists := volumeObj.podsToMount[podName]; !podExists &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Delete pod if it exists</span></div><div class="line">	<span class="built_in">delete</span>(dsw.volumesToMount[volumeName].podsToMount, podName)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(dsw.volumesToMount[volumeName].podsToMount) == <span class="number">0</span> &#123;</div><div class="line">		<span class="comment">// Delete volume if no child pods left</span></div><div class="line">		<span class="built_in">delete</span>(dsw.volumesToMount, volumeName)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="desiredStateOfWorld-VolumeExists"><a href="#desiredStateOfWorld-VolumeExists" class="headerlink" title="desiredStateOfWorld::VolumeExists()"></a>desiredStateOfWorld::VolumeExists()</h4><p>VolumeExists()可以返回volume就否在desiredStateOfWorld中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***返回volume是否在volumesToMount中***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dsw *desiredStateOfWorld)</span> <span class="title">VolumeExists</span><span class="params">(</span></span></div><div class="line">	volumeName api.UniqueVolumeName) <span class="title">bool</span> &#123;</div><div class="line">	dsw.RLock()</div><div class="line">	<span class="keyword">defer</span> dsw.RUnlock()</div><div class="line"></div><div class="line">	_, volumeExists := dsw.volumesToMount[volumeName]</div><div class="line">	<span class="keyword">return</span> volumeExists</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="desiredStateOfWorld-PodExistsInVolume"><a href="#desiredStateOfWorld-PodExistsInVolume" class="headerlink" title="desiredStateOfWorld::PodExistsInVolume()"></a>desiredStateOfWorld::PodExistsInVolume()</h4><p>PodExistsInVolume()可以返回pod是否需要挂载某volume。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***判断pod是否需要挂载某volume***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dsw *desiredStateOfWorld)</span> <span class="title">PodExistsInVolume</span><span class="params">(</span></span></div><div class="line">	podName types.UniquePodName, volumeName api.UniqueVolumeName) <span class="title">bool</span> &#123;</div><div class="line">	dsw.RLock()</div><div class="line">	<span class="keyword">defer</span> dsw.RUnlock()</div><div class="line"></div><div class="line">	volumeObj, volumeExists := dsw.volumesToMount[volumeName]</div><div class="line">	<span class="keyword">if</span> !volumeExists &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	_, podExists := volumeObj.podsToMount[podName]</div><div class="line">	<span class="keyword">return</span> podExists</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="desiredStateOfWorldPopulator"><a href="#desiredStateOfWorldPopulator" class="headerlink" title="desiredStateOfWorldPopulator"></a>desiredStateOfWorldPopulator</h2><p>有了desiredStateOfWorld后，我们需要一个能维护desiredStateOfWorld中内容为最新内容的机制，这个机制就是desiredStateOfWorldPopulator。desiredStateOfWorldPopulator定义在/pkg/kubelet/volumemanager/populator/desired_state_of_world_populator.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> desiredStateOfWorldPopulator <span class="keyword">struct</span> &#123;</div><div class="line">	kubeClient                internalclientset.Interface</div><div class="line">	loopSleepDuration         time.Duration</div><div class="line">	getPodStatusRetryDuration time.Duration</div><div class="line">	podManager                pod.Manager</div><div class="line">	desiredStateOfWorld       cache.DesiredStateOfWorld</div><div class="line">	pods                      processedPods</div><div class="line">	kubeContainerRuntime      kubecontainer.Runtime</div><div class="line">	timeOfLastGetPodStatus    time.Time</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，desiredStateOfWorldPopulator中有desiredStateOfWorld。<br>desiredStateOfWorldPopulator的启动函数为Run()，定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***启动desiredStateOfWorldPopulator***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dswp *desiredStateOfWorldPopulator)</span> <span class="title">Run</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	<span class="comment">//***周期调用populatorLoopFunc()***//</span></div><div class="line">	wait.Until(dswp.populatorLoopFunc(), dswp.loopSleepDuration, stopCh)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，Run()主要周期地执行populatorLoopFunc()：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dswp *desiredStateOfWorldPopulator)</span> <span class="title">populatorLoopFunc</span><span class="params">()</span> <span class="title">func</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="comment">//***添加新的pod到desiredStateOfWorld***//</span></div><div class="line">		dswp.findAndAddNewPods()</div><div class="line"></div><div class="line">		<span class="comment">// findAndRemoveDeletedPods() calls out to the container runtime to</span></div><div class="line">		<span class="comment">// determine if the containers for a given pod are terminated. This is</span></div><div class="line">		<span class="comment">// an expensive operation, therefore we limit the rate that</span></div><div class="line">		<span class="comment">// findAndRemoveDeletedPods() is called independently of the main</span></div><div class="line">		<span class="comment">// populator loop.</span></div><div class="line">		<span class="keyword">if</span> time.Since(dswp.timeOfLastGetPodStatus) &lt; dswp.getPodStatusRetryDuration &#123;</div><div class="line">			glog.V(<span class="number">5</span>).Infof(</div><div class="line">				<span class="string">"Skipping findAndRemoveDeletedPods(). Not permitted until %v (getPodStatusRetryDuration %v)."</span>,</div><div class="line">				dswp.timeOfLastGetPodStatus.Add(dswp.getPodStatusRetryDuration),</div><div class="line">				dswp.getPodStatusRetryDuration)</div><div class="line"></div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//***从desiredStateOfWorld删除已经删除的pod**//</span></div><div class="line">		dswp.findAndRemoveDeletedPods()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>populatorLoopFunc()的功能由两个：</p>
<ol>
<li>往desiredStateOfWorld中添加新的pod，由findAndAddNewPods()完成；</li>
<li>从desiredStateOfWorld删除已经删除的pod，由findAndRemoveDeletedPods()完成。</li>
</ol>
<p>所以从这只可以看出，我们不能改变一个pod的挂载。</p>
<p>findAndAddNewPods()定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从pod manager获取Pods，并加入到desired world中***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dswp *desiredStateOfWorldPopulator)</span> <span class="title">findAndAddNewPods</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, pod := <span class="keyword">range</span> dswp.podManager.GetPods() &#123;</div><div class="line">		<span class="keyword">if</span> isPodTerminated(pod) &#123;</div><div class="line">			<span class="comment">// Do not (re)add volumes for terminated pods</span></div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		dswp.processPodVolumes(pod)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***把pod的volume加入到desiredStateOfWorldPopulator ***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dswp *desiredStateOfWorldPopulator)</span> <span class="title">processPodVolumes</span><span class="params">(pod *api.Pod)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> pod == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	uniquePodName := volumehelper.GetUniquePodName(pod)</div><div class="line">	<span class="comment">//***检查pod是否已经被处理***//</span></div><div class="line">	<span class="keyword">if</span> dswp.podPreviouslyProcessed(uniquePodName) &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Process volume spec for each volume defined in pod</span></div><div class="line">	<span class="keyword">for</span> _, podVolume := <span class="keyword">range</span> pod.Spec.Volumes &#123;</div><div class="line">		volumeSpec, volumeGidValue, err :=</div><div class="line">			dswp.createVolumeSpec(podVolume, pod.Namespace)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			glog.Errorf(</div><div class="line">				<span class="string">"Error processing volume %q for pod %q: %v"</span>,</div><div class="line">				podVolume.Name,</div><div class="line">				format.Pod(pod),</div><div class="line">				err)</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Add volume to desired state of world</span></div><div class="line">		<span class="comment">//***把volume添加到desired world***//</span></div><div class="line">		_, err = dswp.desiredStateOfWorld.AddPodToVolume(</div><div class="line">			uniquePodName, pod, volumeSpec, podVolume.Name, volumeGidValue)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			glog.Errorf(</div><div class="line">				<span class="string">"Failed to add volume %q (specName: %q) for pod %q to desiredStateOfWorld. err=%v"</span>,</div><div class="line">				podVolume.Name,</div><div class="line">				volumeSpec.Name(),</div><div class="line">				uniquePodName,</div><div class="line">				err)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		glog.V(<span class="number">10</span>).Infof(</div><div class="line">			<span class="string">"Added volume %q (volSpec=%q) for pod %q to desired state."</span>,</div><div class="line">			podVolume.Name,</div><div class="line">			volumeSpec.Name(),</div><div class="line">			uniquePodName)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***标记pod已经被处理***//</span></div><div class="line">	dswp.markPodProcessed(uniquePodName)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>findAndAddNewPods()从podManager处获取pods，然后调用processPodVolumes()处理每个pod。<br>processPodVolumes()对于会调用desiredStateOfWorld的AddPodToVolume()把pod加入到desiredStateOfWorld中。desiredStateOfWorldPopulator会对处理过的pod进行记录，确保每个pod只被处理一次。</p>
<p>再来看findAndRemoveDeletedPods()：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Iterate through all pods in desired state of world, and remove if they no</span></div><div class="line"><span class="comment">// longer exist</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dswp *desiredStateOfWorldPopulator)</span> <span class="title">findAndRemoveDeletedPods</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> runningPods []*kubecontainer.Pod</div><div class="line"></div><div class="line">	runningPodsFetched := <span class="literal">false</span></div><div class="line">	<span class="keyword">for</span> _, volumeToMount := <span class="keyword">range</span> dswp.desiredStateOfWorld.GetVolumesToMount() &#123;</div><div class="line">		pod, podExists := dswp.podManager.GetPodByUID(volumeToMount.Pod.UID)</div><div class="line">		<span class="keyword">if</span> podExists &#123;</div><div class="line">			<span class="comment">// Skip running pods</span></div><div class="line">			<span class="keyword">if</span> !isPodTerminated(pod) &#123;</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">// Skip non-memory backed volumes belonging to terminated pods</span></div><div class="line">			volume := volumeToMount.VolumeSpec.Volume</div><div class="line">			<span class="keyword">if</span> volume == <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (volume.EmptyDir == <span class="literal">nil</span> || volume.EmptyDir.Medium != api.StorageMediumMemory) &amp;&amp;</div><div class="line">				volume.ConfigMap == <span class="literal">nil</span> &amp;&amp; volume.Secret == <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Once a pod has been deleted from kubelet pod manager, do not delete</span></div><div class="line">		<span class="comment">// it immediately from volume manager. Instead, check the kubelet</span></div><div class="line">		<span class="comment">// containerRuntime to verify that all containers in the pod have been</span></div><div class="line">		<span class="comment">// terminated.</span></div><div class="line">		<span class="comment">//***检测是否还有容器在运行***//</span></div><div class="line">		<span class="keyword">if</span> !runningPodsFetched &#123;</div><div class="line">			<span class="keyword">var</span> getPodsErr error</div><div class="line">			runningPods, getPodsErr = dswp.kubeContainerRuntime.GetPods(<span class="literal">false</span>)</div><div class="line">			<span class="keyword">if</span> getPodsErr != <span class="literal">nil</span> &#123;</div><div class="line">				glog.Errorf(</div><div class="line">					<span class="string">"kubeContainerRuntime.findAndRemoveDeletedPods returned error %v."</span>,</div><div class="line">					getPodsErr)</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line"></div><div class="line">			runningPodsFetched = <span class="literal">true</span></div><div class="line">			dswp.timeOfLastGetPodStatus = time.Now()</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		runningContainers := <span class="literal">false</span></div><div class="line">		<span class="keyword">for</span> _, runningPod := <span class="keyword">range</span> runningPods &#123;</div><div class="line">			<span class="keyword">if</span> runningPod.ID == volumeToMount.Pod.UID &#123;</div><div class="line">				<span class="keyword">if</span> <span class="built_in">len</span>(runningPod.Containers) &gt; <span class="number">0</span> &#123;</div><div class="line">					runningContainers = <span class="literal">true</span></div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> runningContainers &#123;</div><div class="line">			glog.V(<span class="number">5</span>).Infof(</div><div class="line">				<span class="string">"Pod %q has been removed from pod manager. However, it still has one or more containers in the non-exited state. Therefore, it will not be removed from volume manager."</span>,</div><div class="line">				format.Pod(volumeToMount.Pod))</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		glog.V(<span class="number">5</span>).Infof(</div><div class="line">			<span class="string">"Removing volume %q (volSpec=%q) for pod %q from desired state."</span>,</div><div class="line">			volumeToMount.VolumeName,</div><div class="line">			volumeToMount.VolumeSpec.Name(),</div><div class="line">			format.Pod(volumeToMount.Pod))</div><div class="line"></div><div class="line">		<span class="comment">//***把volume从desired world中删除***//</span></div><div class="line">		dswp.desiredStateOfWorld.DeletePodFromVolume(</div><div class="line">			volumeToMount.PodName, volumeToMount.VolumeName)</div><div class="line">		<span class="comment">//***标记该pod未被处理过***//</span></div><div class="line">		dswp.deleteProcessedPod(volumeToMount.PodName)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>findAndRemoveDeletedPods()找到desiredStateOfWorld中有，但podManager中没有的pod，然后把该pod从DesiredStateOfWorld中删除，并把pod从记录表中删除。</p>
<p>所以，现在我们已经完成了podManager和desiredStateOfWorld的同步。</p>
<h2 id="reconciler"><a href="#reconciler" class="headerlink" title="reconciler"></a>reconciler</h2><p>现在还差actualStateOfWorld和desiredStateOfWorld的一致性维护和物理机上挂载和actualStateOfWorld一致性的维护。这些都由reconciler完成。<br>reconciler定义在/pkg/kubelet/volumemanager/reconciler/reconciler.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> reconciler <span class="keyword">struct</span> &#123;</div><div class="line">	kubeClient                    internalclientset.Interface</div><div class="line">	controllerAttachDetachEnabled <span class="keyword">bool</span></div><div class="line">	loopSleepDuration             time.Duration</div><div class="line">	syncDuration                  time.Duration</div><div class="line">	waitForAttachTimeout          time.Duration</div><div class="line">	nodeName                      types.NodeName</div><div class="line">	desiredStateOfWorld           cache.DesiredStateOfWorld</div><div class="line">	actualStateOfWorld            cache.ActualStateOfWorld</div><div class="line">	operationExecutor             operationexecutor.OperationExecutor</div><div class="line">	mounter                       mount.Interface</div><div class="line">	volumePluginMgr               *volumepkg.VolumePluginMgr</div><div class="line">	kubeletPodsDir                <span class="keyword">string</span></div><div class="line">	timeOfLastSync                time.Time</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>reconciler有desiredStateOfWorld和actualStateOfWorld，及operationExecutor用来执行具体的挂载操作。<br>reconciler启动方法如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rc *reconciler)</span> <span class="title">Run</span><span class="params">(sourcesReady config.SourcesReady, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	wait.Until(rc.reconciliationLoopFunc(sourcesReady), rc.loopSleepDuration, stopCh)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>reconciliationLoopFunc()定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***reconciler的循环函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rc *reconciler)</span> <span class="title">reconciliationLoopFunc</span><span class="params">(sourcesReady config.SourcesReady)</span> <span class="title">func</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="comment">//***处理actual state of world和desired state of world的一致性***//</span></div><div class="line">		rc.reconcile()</div><div class="line"></div><div class="line">		<span class="comment">// Add all sources ready check so that reconciler's reconstruct process will start after</span></div><div class="line">		<span class="comment">// desired state of world is populated with pod volume information from different sources. Otherwise,</span></div><div class="line">		<span class="comment">// reconciler's reconstruct process may add incomplete volume information and cause confusion.</span></div><div class="line">		<span class="comment">// In addition, if some sources are not ready, the reconstruct process may clean up pods' volumes</span></div><div class="line">		<span class="comment">// that are still in use because desired states could not get a complete list of pods.</span></div><div class="line">		<span class="keyword">if</span> sourcesReady.AllReady() &amp;&amp; time.Since(rc.timeOfLastSync) &gt; rc.syncDuration &#123;</div><div class="line">			glog.V(<span class="number">5</span>).Infof(<span class="string">"Sources are all ready, starting reconstruct state function"</span>)</div><div class="line">			<span class="comment">//***处理磁盘volume和actual state of world，desired state of world的一致性***//</span></div><div class="line">			rc.sync()</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>reconciliationLoopFunc()由两个功能：</p>
<ol>
<li>处理actualStateOfWorld和desiredStateOfWorld的一致性，由reconcile()完成；</li>
<li>处理磁盘volume和actual state of world，desired state of world的一致性，由sync()完成。</li>
</ol>
<p>先来看reconcile()，定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***处理actual state of world和desired state of world的一致性***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rc *reconciler)</span> <span class="title">reconcile</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Unmounts are triggered before mounts so that a volume that was</span></div><div class="line">	<span class="comment">// referenced by a pod that was deleted and is now referenced by another</span></div><div class="line">	<span class="comment">// pod is unmounted from the first pod before being mounted to the new</span></div><div class="line">	<span class="comment">// pod.</span></div><div class="line"></div><div class="line">	<span class="comment">// Ensure volumes that should be unmounted are unmounted.</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***actualStateOfWorld中有，desiredStaeOfWorld中无，则umount***//</span></div><div class="line">	<span class="comment">//***一个volume挂载到一个pod视为一个mountedVolume***//</span></div><div class="line">	<span class="keyword">for</span> _, mountedVolume := <span class="keyword">range</span> rc.actualStateOfWorld.GetMountedVolumes() &#123;</div><div class="line">		<span class="keyword">if</span> !rc.desiredStateOfWorld.PodExistsInVolume(mountedVolume.PodName, mountedVolume.VolumeName) &#123;</div><div class="line">			<span class="comment">// Volume is mounted, unmount it</span></div><div class="line">			glog.V(<span class="number">12</span>).Infof(<span class="string">"Attempting to start UnmountVolume for volume %q (spec.Name: %q) from pod %q (UID: %q)."</span>,</div><div class="line">				mountedVolume.VolumeName,</div><div class="line">				mountedVolume.OuterVolumeSpecName,</div><div class="line">				mountedVolume.PodName,</div><div class="line">				mountedVolume.PodUID)</div><div class="line">			<span class="comment">//***Fankang***//</span></div><div class="line">			<span class="comment">//***把volume unmount，并作适当清理***//</span></div><div class="line">			err := rc.operationExecutor.UnmountVolume(</div><div class="line">				mountedVolume.MountedVolume, rc.actualStateOfWorld)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp;</div><div class="line">				!nestedpendingoperations.IsAlreadyExists(err) &amp;&amp;</div><div class="line">				!exponentialbackoff.IsExponentialBackoff(err) &#123;</div><div class="line">				<span class="comment">// Ignore nestedpendingoperations.IsAlreadyExists and exponentialbackoff.IsExponentialBackoff errors, they are expected.</span></div><div class="line">				<span class="comment">// Log all other errors.</span></div><div class="line">				glog.Errorf(</div><div class="line">					<span class="string">"operationExecutor.UnmountVolume failed for volume %q (spec.Name: %q) pod %q (UID: %q) controllerAttachDetachEnabled: %v with err: %v"</span>,</div><div class="line">					mountedVolume.VolumeName,</div><div class="line">					mountedVolume.OuterVolumeSpecName,</div><div class="line">					mountedVolume.PodName,</div><div class="line">					mountedVolume.PodUID,</div><div class="line">					rc.controllerAttachDetachEnabled,</div><div class="line">					err)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">				glog.Infof(<span class="string">"UnmountVolume operation started for volume %q (spec.Name: %q) from pod %q (UID: %q)."</span>,</div><div class="line">					mountedVolume.VolumeName,</div><div class="line">					mountedVolume.OuterVolumeSpecName,</div><div class="line">					mountedVolume.PodName,</div><div class="line">					mountedVolume.PodUID)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Ensure volumes that should be attached/mounted are attached/mounted.</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***如果desire world中有，而actual world未挂载，则执行挂载***//</span></div><div class="line">	<span class="keyword">for</span> _, volumeToMount := <span class="keyword">range</span> rc.desiredStateOfWorld.GetVolumesToMount() &#123;</div><div class="line">		volMounted, devicePath, err := rc.actualStateOfWorld.PodExistsInVolume(volumeToMount.PodName, volumeToMount.VolumeName)</div><div class="line">		volumeToMount.DevicePath = devicePath</div><div class="line">		<span class="comment">//***Fankang***//</span></div><div class="line">		<span class="comment">//***处理volume not attached的情况***//</span></div><div class="line">		<span class="keyword">if</span> cache.IsVolumeNotAttachedError(err) &#123;</div><div class="line">			<span class="keyword">if</span> rc.controllerAttachDetachEnabled || !volumeToMount.PluginIsAttachable &#123;</div><div class="line">				<span class="comment">// Volume is not attached (or doesn't implement attacher), kubelet attach is disabled, wait</span></div><div class="line">				<span class="comment">// for controller to finish attaching volume.</span></div><div class="line">				glog.V(<span class="number">12</span>).Infof(<span class="string">"Attempting to start VerifyControllerAttachedVolume for volume %q (spec.Name: %q) pod %q (UID: %q)"</span>,</div><div class="line">					volumeToMount.VolumeName,</div><div class="line">					volumeToMount.VolumeSpec.Name(),</div><div class="line">					volumeToMount.PodName,</div><div class="line">					volumeToMount.Pod.UID)</div><div class="line">				err := rc.operationExecutor.VerifyControllerAttachedVolume(</div><div class="line">					volumeToMount.VolumeToMount,</div><div class="line">					rc.nodeName,</div><div class="line">					rc.actualStateOfWorld)</div><div class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp;</div><div class="line">					!nestedpendingoperations.IsAlreadyExists(err) &amp;&amp;</div><div class="line">					!exponentialbackoff.IsExponentialBackoff(err) &#123;</div><div class="line">					<span class="comment">// Ignore nestedpendingoperations.IsAlreadyExists and exponentialbackoff.IsExponentialBackoff errors, they are expected.</span></div><div class="line">					<span class="comment">// Log all other errors.</span></div><div class="line">					glog.Errorf(</div><div class="line">						<span class="string">"operationExecutor.VerifyControllerAttachedVolume failed for volume %q (spec.Name: %q) pod %q (UID: %q) controllerAttachDetachEnabled: %v with err: %v"</span>,</div><div class="line">						volumeToMount.VolumeName,</div><div class="line">						volumeToMount.VolumeSpec.Name(),</div><div class="line">						volumeToMount.PodName,</div><div class="line">						volumeToMount.Pod.UID,</div><div class="line">						rc.controllerAttachDetachEnabled,</div><div class="line">						err)</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">					glog.Infof(<span class="string">"VerifyControllerAttachedVolume operation started for volume %q (spec.Name: %q) pod %q (UID: %q)"</span>,</div><div class="line">						volumeToMount.VolumeName,</div><div class="line">						volumeToMount.VolumeSpec.Name(),</div><div class="line">						volumeToMount.PodName,</div><div class="line">						volumeToMount.Pod.UID)</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// Volume is not attached to node, kubelet attach is enabled, volume implements an attacher,</span></div><div class="line">				<span class="comment">// so attach it</span></div><div class="line">				volumeToAttach := operationexecutor.VolumeToAttach&#123;</div><div class="line">					VolumeName: volumeToMount.VolumeName,</div><div class="line">					VolumeSpec: volumeToMount.VolumeSpec,</div><div class="line">					NodeName:   rc.nodeName,</div><div class="line">				&#125;</div><div class="line">				glog.V(<span class="number">12</span>).Infof(<span class="string">"Attempting to start AttachVolume for volume %q (spec.Name: %q)  pod %q (UID: %q)"</span>,</div><div class="line">					volumeToMount.VolumeName,</div><div class="line">					volumeToMount.VolumeSpec.Name(),</div><div class="line">					volumeToMount.PodName,</div><div class="line">					volumeToMount.Pod.UID)</div><div class="line">				err := rc.operationExecutor.AttachVolume(volumeToAttach, rc.actualStateOfWorld)</div><div class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp;</div><div class="line">					!nestedpendingoperations.IsAlreadyExists(err) &amp;&amp;</div><div class="line">					!exponentialbackoff.IsExponentialBackoff(err) &#123;</div><div class="line">					<span class="comment">// Ignore nestedpendingoperations.IsAlreadyExists and exponentialbackoff.IsExponentialBackoff errors, they are expected.</span></div><div class="line">					<span class="comment">// Log all other errors.</span></div><div class="line">					glog.Errorf(</div><div class="line">						<span class="string">"operationExecutor.AttachVolume failed for volume %q (spec.Name: %q) pod %q (UID: %q) controllerAttachDetachEnabled: %v with err: %v"</span>,</div><div class="line">						volumeToMount.VolumeName,</div><div class="line">						volumeToMount.VolumeSpec.Name(),</div><div class="line">						volumeToMount.PodName,</div><div class="line">						volumeToMount.Pod.UID,</div><div class="line">						rc.controllerAttachDetachEnabled,</div><div class="line">						err)</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">					glog.Infof(<span class="string">"AttachVolume operation started for volume %q (spec.Name: %q) pod %q (UID: %q)"</span>,</div><div class="line">						volumeToMount.VolumeName,</div><div class="line">						volumeToMount.VolumeSpec.Name(),</div><div class="line">						volumeToMount.PodName,</div><div class="line">						volumeToMount.Pod.UID)</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> !volMounted || cache.IsRemountRequiredError(err) &#123;</div><div class="line">			<span class="comment">//***Fankang***//</span></div><div class="line">			<span class="comment">//***处理volume未被挂载，或需要重新挂载的情况***//</span></div><div class="line">			<span class="comment">// Volume is not mounted, or is already mounted, but requires remounting</span></div><div class="line">			remountingLogStr := <span class="string">""</span></div><div class="line">			<span class="keyword">if</span> cache.IsRemountRequiredError(err) &#123;</div><div class="line">				remountingLogStr = <span class="string">"Volume is already mounted to pod, but remount was requested."</span></div><div class="line">			&#125;</div><div class="line">			glog.V(<span class="number">12</span>).Infof(<span class="string">"Attempting to start MountVolume for volume %q (spec.Name: %q) to pod %q (UID: %q). %s"</span>,</div><div class="line">				volumeToMount.VolumeName,</div><div class="line">				volumeToMount.VolumeSpec.Name(),</div><div class="line">				volumeToMount.PodName,</div><div class="line">				volumeToMount.Pod.UID,</div><div class="line">				remountingLogStr)</div><div class="line">			<span class="comment">//***Fankang***//</span></div><div class="line">			<span class="comment">//***执行挂载***//</span></div><div class="line">			err := rc.operationExecutor.MountVolume(</div><div class="line">				rc.waitForAttachTimeout,</div><div class="line">				volumeToMount.VolumeToMount,</div><div class="line">				rc.actualStateOfWorld)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp;</div><div class="line">				!nestedpendingoperations.IsAlreadyExists(err) &amp;&amp;</div><div class="line">				!exponentialbackoff.IsExponentialBackoff(err) &#123;</div><div class="line">				<span class="comment">// Ignore nestedpendingoperations.IsAlreadyExists and exponentialbackoff.IsExponentialBackoff errors, they are expected.</span></div><div class="line">				<span class="comment">// Log all other errors.</span></div><div class="line">				glog.Errorf(</div><div class="line">					<span class="string">"operationExecutor.MountVolume failed for volume %q (spec.Name: %q) pod %q (UID: %q) controllerAttachDetachEnabled: %v with err: %v"</span>,</div><div class="line">					volumeToMount.VolumeName,</div><div class="line">					volumeToMount.VolumeSpec.Name(),</div><div class="line">					volumeToMount.PodName,</div><div class="line">					volumeToMount.Pod.UID,</div><div class="line">					rc.controllerAttachDetachEnabled,</div><div class="line">					err)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">				logMsg := fmt.Sprintf(<span class="string">"MountVolume operation started for volume %q (spec.Name: %q) to pod %q (UID: %q). %s"</span>,</div><div class="line">					volumeToMount.VolumeName,</div><div class="line">					volumeToMount.VolumeSpec.Name(),</div><div class="line">					volumeToMount.PodName,</div><div class="line">					volumeToMount.Pod.UID,</div><div class="line">					remountingLogStr)</div><div class="line">				<span class="keyword">if</span> remountingLogStr == <span class="string">""</span> &#123;</div><div class="line">					glog.V(<span class="number">1</span>).Infof(logMsg)</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					glog.V(<span class="number">5</span>).Infof(logMsg)</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Ensure devices that should be detached/unmounted are detached/unmounted.</span></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***处理actualStateOfWorld中需要unmount或detach的volume***//</span></div><div class="line">	<span class="keyword">for</span> _, attachedVolume := <span class="keyword">range</span> rc.actualStateOfWorld.GetUnmountedVolumes() &#123;</div><div class="line">		<span class="keyword">if</span> !rc.desiredStateOfWorld.VolumeExists(attachedVolume.VolumeName) &#123;</div><div class="line">			<span class="keyword">if</span> attachedVolume.GloballyMounted &#123;</div><div class="line">				<span class="comment">// Volume is globally mounted to device, unmount it</span></div><div class="line">				glog.V(<span class="number">12</span>).Infof(<span class="string">"Attempting to start UnmountDevice for volume %q (spec.Name: %q)"</span>,</div><div class="line">					attachedVolume.VolumeName,</div><div class="line">					attachedVolume.VolumeSpec.Name())</div><div class="line">				err := rc.operationExecutor.UnmountDevice(</div><div class="line">					attachedVolume.AttachedVolume, rc.actualStateOfWorld, rc.mounter)</div><div class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp;</div><div class="line">					!nestedpendingoperations.IsAlreadyExists(err) &amp;&amp;</div><div class="line">					!exponentialbackoff.IsExponentialBackoff(err) &#123;</div><div class="line">					<span class="comment">// Ignore nestedpendingoperations.IsAlreadyExists and exponentialbackoff.IsExponentialBackoff errors, they are expected.</span></div><div class="line">					<span class="comment">// Log all other errors.</span></div><div class="line">					glog.Errorf(</div><div class="line">						<span class="string">"operationExecutor.UnmountDevice failed for volume %q (spec.Name: %q) controllerAttachDetachEnabled: %v with err: %v"</span>,</div><div class="line">						attachedVolume.VolumeName,</div><div class="line">						attachedVolume.VolumeSpec.Name(),</div><div class="line">						rc.controllerAttachDetachEnabled,</div><div class="line">						err)</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">					glog.Infof(<span class="string">"UnmountDevice operation started for volume %q (spec.Name: %q)"</span>,</div><div class="line">						attachedVolume.VolumeName,</div><div class="line">						attachedVolume.VolumeSpec.Name())</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// Volume is attached to node, detach it</span></div><div class="line">				<span class="keyword">if</span> rc.controllerAttachDetachEnabled || !attachedVolume.PluginIsAttachable &#123;</div><div class="line">					<span class="comment">// Kubelet not responsible for detaching or this volume has a non-attachable volume plugin,</span></div><div class="line">					<span class="comment">// so just remove it to actualStateOfWorld without attach.</span></div><div class="line">					rc.actualStateOfWorld.MarkVolumeAsDetached(</div><div class="line">						attachedVolume.VolumeName, rc.nodeName)</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="comment">// Only detach if kubelet detach is enabled</span></div><div class="line">					glog.V(<span class="number">12</span>).Infof(<span class="string">"Attempting to start DetachVolume for volume %q (spec.Name: %q)"</span>,</div><div class="line">						attachedVolume.VolumeName,</div><div class="line">						attachedVolume.VolumeSpec.Name())</div><div class="line">					err := rc.operationExecutor.DetachVolume(</div><div class="line">						attachedVolume.AttachedVolume, <span class="literal">false</span> <span class="comment">/* verifySafeToDetach */</span>, rc.actualStateOfWorld)</div><div class="line">					<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp;</div><div class="line">						!nestedpendingoperations.IsAlreadyExists(err) &amp;&amp;</div><div class="line">						!exponentialbackoff.IsExponentialBackoff(err) &#123;</div><div class="line">						<span class="comment">// Ignore nestedpendingoperations.IsAlreadyExists &amp;&amp; exponentialbackoff.IsExponentialBackoff errors, they are expected.</span></div><div class="line">						<span class="comment">// Log all other errors.</span></div><div class="line">						glog.Errorf(</div><div class="line">							<span class="string">"operationExecutor.DetachVolume failed for volume %q (spec.Name: %q) controllerAttachDetachEnabled: %v with err: %v"</span>,</div><div class="line">							attachedVolume.VolumeName,</div><div class="line">							attachedVolume.VolumeSpec.Name(),</div><div class="line">							rc.controllerAttachDetachEnabled,</div><div class="line">							err)</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">						glog.Infof(<span class="string">"DetachVolume operation started for volume %q (spec.Name: %q)"</span>,</div><div class="line">							attachedVolume.VolumeName,</div><div class="line">							attachedVolume.VolumeSpec.Name())</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>reconcile()主要处理以下三种情况：</p>
<ol>
<li>actualStateOfWorld中有，但desiredStateOfWorld中没有，则调用operationExecutor.UnmountVolume()执行unmount操作；</li>
<li>desiredStateOfWorld中有，但actualStateOfWorld中未挂载，则执行attach操作或mount操作；</li>
<li>对actualStateOfWorld中的unmounted volume进行检查，如果desiredStateOfWorld中没有，则从actualStateOfWorld中删除volume。</li>
</ol>
<p>再来看sync():<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rc *reconciler)</span> <span class="title">sync</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> rc.updateLastSyncTime()</div><div class="line">	rc.syncStates(rc.kubeletPodsDir)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>sync()主要调用了syncStates():<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***维护磁盘上volume与actual,desired state of world的一致性***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rc *reconciler)</span> <span class="title">syncStates</span><span class="params">(podsDir <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	<span class="comment">// Get volumes information by reading the pod's directory</span></div><div class="line">	<span class="comment">//***获取磁盘上的volume***//</span></div><div class="line">	podVolumes, err := getVolumesFromPodDir(podsDir)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.Errorf(<span class="string">"Cannot get volumes from disk %v"</span>, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***获取需要update的volume***//</span></div><div class="line">	volumesNeedUpdate := <span class="built_in">make</span>(<span class="keyword">map</span>[api.UniqueVolumeName]*reconstructedVolume)</div><div class="line">	<span class="keyword">for</span> _, volume := <span class="keyword">range</span> podVolumes &#123;</div><div class="line">		reconstructedVolume, err := rc.reconstructVolume(volume)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			glog.Errorf(<span class="string">"Could not construct volume information: %v"</span>, err)</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">// Check if there is an pending operation for the given pod and volume.</span></div><div class="line">		<span class="comment">// Need to check pending operation before checking the actual and desired</span></div><div class="line">		<span class="comment">// states to avoid race condition during checking. For example, the following</span></div><div class="line">		<span class="comment">// might happen if pending operation is checked after checking actual and desired states.</span></div><div class="line">		<span class="comment">// 1. Checking the pod and it does not exist in either actual or desired state.</span></div><div class="line">		<span class="comment">// 2. An operation for the given pod finishes and the actual state is updated.</span></div><div class="line">		<span class="comment">// 3. Checking and there is no pending operation for the given pod.</span></div><div class="line">		<span class="comment">// During state reconstruction period, no new volume operations could be issued. If the</span></div><div class="line">		<span class="comment">// mounted path is not in either pending operation, or actual or desired states, this</span></div><div class="line">		<span class="comment">// volume needs to be reconstructed back to the states.</span></div><div class="line">		pending := rc.operationExecutor.IsOperationPending(reconstructedVolume.volumeName, reconstructedVolume.podName)</div><div class="line">		dswExist := rc.desiredStateOfWorld.PodExistsInVolume(reconstructedVolume.podName, reconstructedVolume.volumeName)</div><div class="line">		aswExist, _, _ := rc.actualStateOfWorld.PodExistsInVolume(reconstructedVolume.podName, reconstructedVolume.volumeName)</div><div class="line"></div><div class="line">		<span class="comment">//***kubelet第一次启动时执行***//</span></div><div class="line">		<span class="keyword">if</span> !rc.StatesHasBeenSynced() &#123;</div><div class="line">			<span class="comment">// In case this is the first time to reconstruct state after kubelet starts, for a persistant volume, it must have</span></div><div class="line">			<span class="comment">// been mounted before kubelet restarts because no mount operations could be started at this time (node</span></div><div class="line">			<span class="comment">// status has not yet been updated before this very first syncStates finishes, so that VerifyControllerAttachedVolume will fail),</span></div><div class="line">			<span class="comment">// In this case, the volume state should be put back to actual state now no matter desired state has it or not.</span></div><div class="line">			<span class="comment">// This is to prevent node status from being updated to empty for attachable volumes. This might happen because</span></div><div class="line">			<span class="comment">// in the case that a volume is discovered on disk, and it is part of desired state, but is then quickly deleted</span></div><div class="line">			<span class="comment">// from the desired state. If in such situation, the volume is not added to the actual state, the node status updater will</span></div><div class="line">			<span class="comment">// not get this volume from either actual or desired state. In turn, this might cause master controller</span></div><div class="line">			<span class="comment">// detaching while the volume is still mounted.</span></div><div class="line">			<span class="keyword">if</span> aswExist || !reconstructedVolume.pluginIsAttachable &#123;</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// Check pending first since no new operations could be started at this point.</span></div><div class="line">			<span class="comment">// Otherwise there might a race condition in checking actual states and pending operations</span></div><div class="line">			<span class="comment">//***Fankang***//</span></div><div class="line">			<span class="comment">//***在pending状态或desired state of world中存在或actual state of world中存在***//</span></div><div class="line">			<span class="keyword">if</span> pending || dswExist || aswExist &#123;</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		glog.V(<span class="number">2</span>).Infof(</div><div class="line">			<span class="string">"Reconciler sync states: could not find pod information in desired or actual states or pending operation, update it in both states: %+v"</span>,</div><div class="line">			reconstructedVolume)</div><div class="line">		volumesNeedUpdate[reconstructedVolume.volumeName] = reconstructedVolume</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***volume update，此处的volumesNeedUpdate是在desired state of world和actual state of world都不存在的***//</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(volumesNeedUpdate) &gt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">if</span> err = rc.updateStates(volumesNeedUpdate); err != <span class="literal">nil</span> &#123;</div><div class="line">			glog.Errorf(<span class="string">"Error occurred during reconstruct volume from disk: %v"</span>, err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>syncStates()会从磁盘上获取volume信息，然后排除状态为pending，或desiredStateOfWorld中存在，或actualStateOfWorld中存在的volume挂载，然后通过updateStates()方法把缺失的挂载加到desiredStateOfWorld和actualStateOfWorld中，以后的事情就交给populator及reconciler来处理了，如果该volume挂载是多余的，也会被删除的。</p>
<h2 id="volumeManager"><a href="#volumeManager" class="headerlink" title="volumeManager"></a>volumeManager</h2><p>最后来看volumeManager，管理物理节点上的volume挂载。volumeManager定义在/pkg/kubelet/volumemanager/volume_manager.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// volumeManager implements the VolumeManager interface</span></div><div class="line"><span class="keyword">type</span> volumeManager <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// kubeClient is the kube API client used by DesiredStateOfWorldPopulator to</span></div><div class="line">	<span class="comment">// communicate with the API server to fetch PV and PVC objects</span></div><div class="line">	kubeClient internalclientset.Interface</div><div class="line"></div><div class="line">	<span class="comment">// volumePluginMgr is the volume plugin manager used to access volume</span></div><div class="line">	<span class="comment">// plugins. It must be pre-initialized.</span></div><div class="line">	<span class="comment">//***volume plugin manager，管理volume plugin***//</span></div><div class="line">	volumePluginMgr *volume.VolumePluginMgr</div><div class="line"></div><div class="line">	<span class="comment">// desiredStateOfWorld is a data structure containing the desired state of</span></div><div class="line">	<span class="comment">// the world according to the volume manager: i.e. what volumes should be</span></div><div class="line">	<span class="comment">// attached and which pods are referencing the volumes).</span></div><div class="line">	<span class="comment">// The data structure is populated by the desired state of the world</span></div><div class="line">	<span class="comment">// populator using the kubelet pod manager.</span></div><div class="line">	desiredStateOfWorld cache.DesiredStateOfWorld</div><div class="line"></div><div class="line">	<span class="comment">// actualStateOfWorld is a data structure containing the actual state of</span></div><div class="line">	<span class="comment">// the world according to the manager: i.e. which volumes are attached to</span></div><div class="line">	<span class="comment">// this node and what pods the volumes are mounted to.</span></div><div class="line">	<span class="comment">// The data structure is populated upon successful completion of attach,</span></div><div class="line">	<span class="comment">// detach, mount, and unmount actions triggered by the reconciler.</span></div><div class="line">	actualStateOfWorld cache.ActualStateOfWorld</div><div class="line"></div><div class="line">	<span class="comment">// operationExecutor is used to start asynchronous attach, detach, mount,</span></div><div class="line">	<span class="comment">// and unmount operations.</span></div><div class="line">	<span class="comment">//***operationExecutor可以执行挂载等操作***//</span></div><div class="line">	operationExecutor operationexecutor.OperationExecutor</div><div class="line"></div><div class="line">	<span class="comment">// reconciler runs an asynchronous periodic loop to reconcile the</span></div><div class="line">	<span class="comment">// desiredStateOfWorld with the actualStateOfWorld by triggering attach,</span></div><div class="line">	<span class="comment">// detach, mount, and unmount operations using the operationExecutor.</span></div><div class="line">	<span class="comment">//***reconciler通过触发mount, attach等操作使desiredStateOfWorld和actualStateOfWorld保持一致***//</span></div><div class="line">	reconciler reconciler.Reconciler</div><div class="line"></div><div class="line">	<span class="comment">// desiredStateOfWorldPopulator runs an asynchronous periodic loop to</span></div><div class="line">	<span class="comment">// populate the desiredStateOfWorld using the kubelet PodManager.</span></div><div class="line">	desiredStateOfWorldPopulator populator.DesiredStateOfWorldPopulator</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>volumeManager中有desiredStateOfWorld，actualStateOfWorld，operationExecutor，reconciler及desiredStateOfWorldPopulator。</p>
<p>volumeManager的生成方法如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***生成volume manager***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewVolumeManager</span><span class="params">(</span></span></div><div class="line">	controllerAttachDetachEnabled <span class="keyword">bool</span>,</div><div class="line">	nodeName k8stypes.NodeName,</div><div class="line">	podManager pod.Manager,</div><div class="line">	kubeClient internalclientset.Interface,</div><div class="line">	volumePluginMgr *volume.VolumePluginMgr,</div><div class="line">	kubeContainerRuntime kubecontainer.Runtime,</div><div class="line">	mounter mount.Interface,</div><div class="line">	kubeletPodsDir <span class="keyword">string</span>,</div><div class="line">	recorder record.EventRecorder,</div><div class="line">	checkNodeCapabilitiesBeforeMount <span class="keyword">bool</span>) <span class="params">(VolumeManager, error)</span> &#123;</div><div class="line"></div><div class="line">	vm := &amp;volumeManager&#123;</div><div class="line">		kubeClient:          kubeClient,</div><div class="line">		volumePluginMgr:     volumePluginMgr,</div><div class="line">		desiredStateOfWorld: cache.NewDesiredStateOfWorld(volumePluginMgr),</div><div class="line">		actualStateOfWorld:  cache.NewActualStateOfWorld(nodeName, volumePluginMgr),</div><div class="line">		operationExecutor: operationexecutor.NewOperationExecutor(</div><div class="line">			kubeClient,</div><div class="line">			volumePluginMgr,</div><div class="line">			recorder,</div><div class="line">			checkNodeCapabilitiesBeforeMount),</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	vm.reconciler = reconciler.NewReconciler(</div><div class="line">		kubeClient,</div><div class="line">		controllerAttachDetachEnabled,</div><div class="line">		reconcilerLoopSleepPeriod,</div><div class="line">		reconcilerSyncStatesSleepPeriod,</div><div class="line">		waitForAttachTimeout,</div><div class="line">		nodeName,</div><div class="line">		vm.desiredStateOfWorld,</div><div class="line">		vm.actualStateOfWorld,</div><div class="line">		vm.operationExecutor,</div><div class="line">		mounter,</div><div class="line">		volumePluginMgr,</div><div class="line">		kubeletPodsDir)</div><div class="line">	vm.desiredStateOfWorldPopulator = populator.NewDesiredStateOfWorldPopulator(</div><div class="line">		kubeClient,</div><div class="line">		desiredStateOfWorldPopulatorLoopSleepPeriod,</div><div class="line">		desiredStateOfWorldPopulatorGetPodStatusRetryDuration,</div><div class="line">		podManager,</div><div class="line">		vm.desiredStateOfWorld,</div><div class="line">		kubeContainerRuntime)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> vm, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>volumeManager启动方法如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***启动volume manager***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(vm *volumeManager)</span> <span class="title">Run</span><span class="params">(sourcesReady config.SourcesReady, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> runtime.HandleCrash()</div><div class="line"></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***启动desiredStateOfWorldPopulator***//</span></div><div class="line">	<span class="comment">//***desiredStateOfWorldPopulator获取pod的挂载信息，并同步到desired world***//</span></div><div class="line">	<span class="keyword">go</span> vm.desiredStateOfWorldPopulator.Run(stopCh)</div><div class="line">	glog.V(<span class="number">2</span>).Infof(<span class="string">"The desired_state_of_world populator starts"</span>)</div><div class="line"></div><div class="line">	glog.Infof(<span class="string">"Starting Kubelet Volume Manager"</span>)</div><div class="line">	<span class="comment">//***启动reconciler***//</span></div><div class="line">	<span class="comment">//***Reconciler同步desired world和actual world，及actual world和物理挂载***//</span></div><div class="line">	<span class="keyword">go</span> vm.reconciler.Run(sourcesReady, stopCh)</div><div class="line"></div><div class="line">	&lt;-stopCh</div><div class="line">	glog.Infof(<span class="string">"Shutting down Kubelet Volume Manager"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Run()会依次启动desiredStateOfWorldPopulator及reconciler。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>volumeManager通过actualStateOfWorld和desiredStateOfWorld来表明当前的volume挂载状态和期望的volume挂载状态。然后由desiredStateOfWorldPopulator维护desireedStateOfWorld和podManager的一致性；由reconcile维护actualStateOfWorld和desiredStateOfWorld的一致性及磁盘volume挂载和actualStateOfWorld的一致性。通过这些机制，volumeManager完成了volume挂载生命周期的管理。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/12/17/kubelet分析(三)-volumeManager-v1-5-2/" data-id="cjbc49y6g004byoqshkuavryo" class="article-share-link">分享</a><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></div><div class="post-nav"><a href="/2017/12/17/kubelet分析(四)-statusManager-v1-5-2/" class="pre">kubelet分析(四)-statusManager-v1.5.2</a><a href="/2017/12/16/kubelet分析(二)-podWorker-v1-5-2/" class="next">kubelet分析(二)-podWorker-v1.5.2</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/18/kubelet分析(五)-podManager-v1-5-2/">kubelet分析(五)-podManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(四)-statusManager-v1-5-2/">kubelet分析(四)-statusManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(三)-volumeManager-v1-5-2/">kubelet分析(三)-volumeManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/kubelet分析(二)-podWorker-v1-5-2/">kubelet分析(二)-podWorker-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/kubelet分析(一)-config-v1-5-2/">kubelet分析(一)-config-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/15/storage解读(六)-strategy-v1-5-2/">storage解读(六)-strategy-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/14/kubernetes-listwatch机制-v1-5-2/">kubernetes-listwatch机制-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/kubernetes-添加controller-demo-v1-5-2/">kubernetes-添加controller-demo-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/kubernetes-添加资源-demo-v1-5-2/">kubernetes-添加资源-demo-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/04/libnetwork源码分析(二)-network-v1-12-3/">libnetwork源码分析(二)-network-v1-12-3</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>