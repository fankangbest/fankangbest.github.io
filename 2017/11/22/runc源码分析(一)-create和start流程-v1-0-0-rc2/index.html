<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>runc源码分析(一)-create和start流程-v1.0.0-rc2 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">runc源码分析(一)-create和start流程-v1.0.0-rc2</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">runc源码分析(一)-create和start流程-v1.0.0-rc2</h1><div class="post-meta">Nov 22, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="流程简述"><a href="#流程简述" class="headerlink" title="流程简述"></a>流程简述</h2><p>先简要地描述create和start的流程，以方便后面的代码分析。<br>我们使用<code>runc create</code>创建容器，使用<code>runc start</code>启动容器。主要流程如下：</p>
<ol>
<li>运行<code>runc create</code>时，后台生成该命令的进程，我们称该进程为parent；</li>
<li>parent进程中运行<code>runc init</code>，我们称<code>runc init</code>进程为child进程；</li>
<li>child进程开始准备用户进程的运行环境，此时parent和child进程通过pipe进行通信；</li>
<li>child进程准备好用户进程的运行环境后，通知parent退出，自己则被exec.fifo阻塞；</li>
<li>由于parent退出(即<code>runc create</code>退出)，child成孤独进程，进而被1进程接收；</li>
<li>child进程一直被exec.fifo阻塞；</li>
<li>运行<code>runc start</code>时，会打开exec.fifo，使child的阻塞消除，<code>runc start</code>退出；</li>
<li>由于阻塞消除，child进程继续往下执行；</li>
<li>child进程使用用户定义的命令替换<code>runc init</code>，从而child进程成为容器内的主进程；</li>
<li>容器启动完成。</li>
</ol>
<h2 id="runc-create"><a href="#runc-create" class="headerlink" title="runc create"></a>runc create</h2><p>先来看<code>runc create</code>的执行流程，主要的运行流程定义在/create.go中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Action: func(context *cli.Context) error &#123;</div><div class="line">	spec, err := setupSpec(context)</div><div class="line">	if err != nil &#123;</div><div class="line">		return err</div><div class="line">	&#125;</div><div class="line">	status, err := startContainer(context, spec, true)</div><div class="line">	if err != nil &#123;</div><div class="line">		return err</div><div class="line">	&#125;</div><div class="line">	// exit with the container&apos;s exit status so any external supervisor is</div><div class="line">	// notified of the exit with the correct exit status.</div><div class="line">	os.Exit(status)</div><div class="line">	return nil</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，<code>runc create</code>主要调用了startContainer()函数，startContainer()函数定义在/utils_linux.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">startContainer</span><span class="params">(context *cli.Context, spec *specs.Spec, create <span class="keyword">bool</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	id := context.Args().First()</div><div class="line">	<span class="keyword">if</span> id == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>, errEmptyID</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***调用createContainer()创建linuxContainer***//</span></div><div class="line">	container, err := createContainer(context, id, spec)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>, err</div><div class="line">	&#125;</div><div class="line">	detach := context.Bool(<span class="string">"detach"</span>)</div><div class="line">	<span class="comment">// Support on-demand socket activation by passing file descriptors into the container init process.</span></div><div class="line">	listenFDs := []*os.File&#123;&#125;</div><div class="line">	<span class="keyword">if</span> os.Getenv(<span class="string">"LISTEN_FDS"</span>) != <span class="string">""</span> &#123;</div><div class="line">		listenFDs = activation.Files(<span class="literal">false</span>)</div><div class="line">	&#125;</div><div class="line">	r := &amp;runner&#123;</div><div class="line">		enableSubreaper: !context.Bool(<span class="string">"no-subreaper"</span>),</div><div class="line">		shouldDestroy:   <span class="literal">true</span>,</div><div class="line">		container:       container,</div><div class="line">		listenFDs:       listenFDs,</div><div class="line">		console:         context.String(<span class="string">"console"</span>),</div><div class="line">		detach:          detach,</div><div class="line">		pidFile:         context.String(<span class="string">"pid-file"</span>),</div><div class="line">		create:          create,</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r.run(&amp;spec.Process)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>startContainer()先调用createContainer()创建container，然后使用runner.run()。</p>
<p>先来看createContainer()，定义在同文件中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">createContainer</span><span class="params">(context *cli.Context, id <span class="keyword">string</span>, spec *specs.Spec)</span> <span class="params">(libcontainer.Container, error)</span></span> &#123;</div><div class="line">	config, err := specconv.CreateLibcontainerConfig(&amp;specconv.CreateOpts&#123;</div><div class="line">		CgroupName:       id,</div><div class="line">		UseSystemdCgroup: context.GlobalBool(<span class="string">"systemd-cgroup"</span>),</div><div class="line">		NoPivotRoot:      context.Bool(<span class="string">"no-pivot"</span>),</div><div class="line">		NoNewKeyring:     context.Bool(<span class="string">"no-new-keyring"</span>),</div><div class="line">		Spec:             spec,</div><div class="line">	&#125;)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> _, err := os.Stat(config.Rootfs); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> os.IsNotExist(err) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"rootfs (%q) does not exist"</span>, config.Rootfs)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***生成LinuxFactory***//</span></div><div class="line">	factory, err := loadFactory(context)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***调用LinuxFactory的Create()方法***//</span></div><div class="line">	<span class="keyword">return</span> factory.Create(id, config)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>createContainer()先调用loadFactory()生成factory，然后再调用factory.Create()方法生成container。关于factory，后面介绍。</p>
<p>再来看runner.run()：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> runner <span class="keyword">struct</span> &#123;</div><div class="line">	enableSubreaper <span class="keyword">bool</span></div><div class="line">	shouldDestroy   <span class="keyword">bool</span></div><div class="line">	detach          <span class="keyword">bool</span></div><div class="line">	listenFDs       []*os.File</div><div class="line">	pidFile         <span class="keyword">string</span></div><div class="line">	console         <span class="keyword">string</span></div><div class="line">	container       libcontainer.Container</div><div class="line">	create          <span class="keyword">bool</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *runner)</span> <span class="title">run</span><span class="params">(config *specs.Process)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	<span class="comment">//***生成process***//</span></div><div class="line">	process, err := newProcess(*config)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		r.destroy()</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(r.listenFDs) &gt; <span class="number">0</span> &#123;</div><div class="line">		process.Env = <span class="built_in">append</span>(process.Env, fmt.Sprintf(<span class="string">"LISTEN_FDS=%d"</span>, <span class="built_in">len</span>(r.listenFDs)), <span class="string">"LISTEN_PID=1"</span>)</div><div class="line">		process.ExtraFiles = <span class="built_in">append</span>(process.ExtraFiles, r.listenFDs...)</div><div class="line">	&#125;</div><div class="line">	rootuid, err := r.container.Config().HostUID()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		r.destroy()</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>, err</div><div class="line">	&#125;</div><div class="line">	rootgid, err := r.container.Config().HostGID()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		r.destroy()</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>, err</div><div class="line">	&#125;</div><div class="line">	tty, err := setupIO(process, rootuid, rootgid, r.console, config.Terminal, r.detach || r.create)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		r.destroy()</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>, err</div><div class="line">	&#125;</div><div class="line">	handler := newSignalHandler(tty, r.enableSubreaper)</div><div class="line">	<span class="comment">//***如果是create，则startFn为r.container.Start***//</span></div><div class="line">	<span class="comment">//***如果是run，则startFn为r.container.Run***//</span></div><div class="line">	startFn := r.container.Start</div><div class="line">	<span class="keyword">if</span> !r.create &#123;</div><div class="line">		startFn = r.container.Run</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> tty.Close()</div><div class="line">	<span class="keyword">if</span> err := startFn(process); err != <span class="literal">nil</span> &#123;</div><div class="line">		r.destroy()</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := tty.ClosePostStart(); err != <span class="literal">nil</span> &#123;</div><div class="line">		r.terminate(process)</div><div class="line">		r.destroy()</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> r.pidFile != <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">if</span> err := createPidFile(r.pidFile, process); err != <span class="literal">nil</span> &#123;</div><div class="line">			r.terminate(process)</div><div class="line">			r.destroy()</div><div class="line">			<span class="keyword">return</span> <span class="number">-1</span>, err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> r.detach || r.create &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	status, err := handler.forward(process)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		r.terminate(process)</div><div class="line">	&#125;</div><div class="line">	r.destroy()</div><div class="line">	<span class="keyword">return</span> status, err</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>run()先生成process，当命令是<code>runc create</code>时，则使用container.Start()来运行process；当命令是<code>runc run</code>时，则使用container.Run()来运行process，然后创建pid文件并写入pid。</p>
<h2 id="factory-Create"><a href="#factory-Create" class="headerlink" title="factory.Create()"></a>factory.Create()</h2><p>factory是整个libcontainer的入口，而factory又有两个入口：Create()和StartInitialization()。先来看factory的Create()入口，定义在/libcontainer/factory_linux.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***在容器外面执行***//</span></div><div class="line"><span class="comment">//***生成逻辑上的容器***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LinuxFactory)</span> <span class="title">Create</span><span class="params">(id <span class="keyword">string</span>, config *configs.Config)</span> <span class="params">(Container, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> l.Root == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(fmt.Errorf(<span class="string">"invalid root"</span>), ConfigInvalid)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***验证id***//</span></div><div class="line">	<span class="keyword">if</span> err := l.validateID(id); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***验证config***//</span></div><div class="line">	<span class="keyword">if</span> err := l.Validator.Validate(config); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, ConfigInvalid)</div><div class="line">	&#125;</div><div class="line">	uid, err := config.HostUID()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, SystemError)</div><div class="line">	&#125;</div><div class="line">	gid, err := config.HostGID()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, SystemError)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***创建containerRoot目录***//</span></div><div class="line">	<span class="comment">//***containerRoot:  /run/runc/nginx***//</span></div><div class="line">	containerRoot := filepath.Join(l.Root, id)</div><div class="line">	<span class="keyword">if</span> _, err := os.Stat(containerRoot); err == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(fmt.Errorf(<span class="string">"container with id exists: %v"</span>, id), IdInUse)</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> !os.IsNotExist(err) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, SystemError)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***设置containerRoot目录，权限为0700***//</span></div><div class="line">	<span class="keyword">if</span> err := os.MkdirAll(containerRoot, <span class="number">0711</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, SystemError)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := os.Chown(containerRoot, uid, gid); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, SystemError)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***创建exec.fifo，即/run/runc/nginx/exec.fifo***//</span></div><div class="line">	fifoName := filepath.Join(containerRoot, execFifoFilename)</div><div class="line">	oldMask := syscall.Umask(<span class="number">0000</span>)</div><div class="line">	<span class="keyword">if</span> err := syscall.Mkfifo(fifoName, <span class="number">0622</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		syscall.Umask(oldMask)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, SystemError)</div><div class="line">	&#125;</div><div class="line">	syscall.Umask(oldMask)</div><div class="line">	<span class="keyword">if</span> err := os.Chown(fifoName, uid, gid); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, newGenericError(err, SystemError)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***生成linuxContainer***//</span></div><div class="line">	<span class="comment">//***c:  &amp;&#123;nginx /run/runc/nginx 0xc420082800 0xc420015c40 [/proc/self/exe init] &lt;nil&gt;  criu &#123;0 0&#125; 0 &lt;nil&gt; &#123;0 0 &lt;nil&gt;&#125;&#125;***//</span></div><div class="line">	c := &amp;linuxContainer&#123;</div><div class="line">		id:       id,</div><div class="line">		root:     containerRoot,</div><div class="line">		config:   config,</div><div class="line">		initArgs: l.InitArgs,</div><div class="line">		criuPath: l.CriuPath,</div><div class="line">		<span class="comment">//***设置Cgroup***//</span></div><div class="line">		cgroupManager: l.NewCgroupsManager(config.Cgroups, <span class="literal">nil</span>),</div><div class="line">	&#125;</div><div class="line">	c.state = &amp;stoppedState&#123;c: c&#125;</div><div class="line">	<span class="keyword">return</span> c, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>factory的Create()方法流程如下：</p>
<ol>
<li>验证id；</li>
<li>验证config；</li>
<li>创建containerRoot目录，如/run/run/nginx；</li>
<li>创建exec.fifo，exec.fifo是一个管道文件，只有写时会被阻塞，读写都在时才会正常运行；</li>
<li>生成container，其中initArgs为<code>/proc/self/exe init</code>，/proc/self/exec即为程序本身——runc，然后设置为stop状态。</li>
</ol>
<h2 id="linuxContainer-Start"><a href="#linuxContainer-Start" class="headerlink" title="linuxContainer.Start()"></a>linuxContainer.Start()</h2><p>再来看linuxContainer.Start()是如何运行process的。linuxContainer.Start()定义在/libcontainer/container_linux.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***执行一个Process***//</span></div><div class="line"><span class="comment">//***在容器外部执行***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *linuxContainer)</span> <span class="title">Start</span><span class="params">(process *Process)</span> <span class="title">error</span></span> &#123;</div><div class="line">	c.m.Lock()</div><div class="line">	<span class="keyword">defer</span> c.m.Unlock()</div><div class="line">	status, err := c.currentStatus()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> c.start(process, status == Stopped)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，Start()主要调用了start()方法，其中如果容器的状态为Stopped，则start()的isInit为true，即Stopped状态的container需要重新init。start()方法如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *linuxContainer)</span> <span class="title">start</span><span class="params">(process *Process, isInit <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***doInit为true时，parent为initProcess***//</span></div><div class="line">	<span class="comment">//***doInit为false时，parent为setnsProcess***//</span></div><div class="line">	parent, err := c.newParentProcess(process, isInit)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"creating new parent process"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***doInit为true时，调用initProcess的start()***//</span></div><div class="line">	<span class="keyword">if</span> err := parent.start(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// terminate the process to ensure that it properly is reaped.</span></div><div class="line">		<span class="keyword">if</span> err := parent.terminate(); err != <span class="literal">nil</span> &#123;</div><div class="line">			logrus.Warn(err)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"starting container process"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// generate a timestamp indicating when the container was started</span></div><div class="line">	c.created = time.Now().UTC()</div><div class="line">	c.state = &amp;runningState&#123;</div><div class="line">		c: c,</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> isInit &#123;</div><div class="line">		c.state = &amp;createdState&#123;</div><div class="line">			c: c,</div><div class="line">		&#125;</div><div class="line">		state, err := c.updateState(parent)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		c.initProcessStartTime = state.InitProcessStartTime</div><div class="line"></div><div class="line">		<span class="comment">//***调用config中定义的hook***//</span></div><div class="line">		<span class="keyword">if</span> c.config.Hooks != <span class="literal">nil</span> &#123;</div><div class="line">			s := configs.HookState&#123;</div><div class="line">				Version:    c.config.Version,</div><div class="line">				ID:         c.id,</div><div class="line">				Pid:        parent.pid(),</div><div class="line">				Root:       c.config.Rootfs,</div><div class="line">				BundlePath: utils.SearchLabels(c.config.Labels, <span class="string">"bundle"</span>),</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">for</span> i, hook := <span class="keyword">range</span> c.config.Hooks.Poststart &#123;</div><div class="line">				<span class="keyword">if</span> err := hook.Run(s); err != <span class="literal">nil</span> &#123;</div><div class="line">					<span class="keyword">if</span> err := parent.terminate(); err != <span class="literal">nil</span> &#123;</div><div class="line">						logrus.Warn(err)</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">return</span> newSystemErrorWithCausef(err, <span class="string">"running poststart hook %d"</span>, i)</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>create()的执行流程如下：</p>
<ol>
<li>调用newParentProcess()生成parent。newParent会依据容器的状态生成initProcess或setnsProcess，<code>runc create</code>的parent为initProcess，newParentProcess()会把parent中的命令填充成<code>/proc/self/exe init</code>；</li>
<li>调用parent.start()启动parent，即启动initProcess；</li>
<li>设置container的状态为Created；</li>
<li>调用config.json文件中定义的Hookb函数。</li>
</ol>
<h2 id="initProcess-start"><a href="#initProcess-start" class="headerlink" title="initProcess.start()"></a>initProcess.start()</h2><p>initProcess.start()定义在process_linux.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***在容器外部执行,新建容器执行命令***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *initProcess)</span> <span class="title">start</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> p.parentPipe.Close()</div><div class="line">	<span class="comment">//***开始运行进程***//</span></div><div class="line">	<span class="comment">//***p.cmd:  &amp;&#123;/proc/self/exe [native] [_LIBCONTAINER_INITPIPE=3 _LIBCONTAINER_INITTYPE=standard] /var/lib/docker/aufs/mnt/0319df2f45175c937b2e4e0d3bc13f8343dc4fa99a6bada077ce698973dc9edd &lt;nil&gt; 0xc820412610 0xc820412600 [0xc820022568] 0xc8202dc880 &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; false [] [] [] [] &lt;nil&gt;&#125;***//</span></div><div class="line">	<span class="comment">//***由于go中没有clone()这个系统调用，但可以通过设置cmd的SysProcAttr设置flag，通过Start()命令来执行程序***//</span></div><div class="line">	err := p.cmd.Start()</div><div class="line">	p.process.ops = p</div><div class="line">	p.childPipe.Close()</div><div class="line">	p.rootDir.Close()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		p.process.ops = <span class="literal">nil</span></div><div class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"starting init process command"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> _, err := io.Copy(p.parentPipe, p.bootstrapData); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := p.execSetns(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"running exec setns process for init"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Save the standard descriptor names before the container process</span></div><div class="line">	<span class="comment">// can potentially move them (e.g., via dup2()).  If we don't do this now,</span></div><div class="line">	<span class="comment">// we won't know at checkpoint time which file descriptor to look up.</span></div><div class="line">	<span class="comment">//***获取管道***//</span></div><div class="line">	fds, err := getPipeFds(p.pid())</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> newSystemErrorWithCausef(err, <span class="string">"getting pipe fds for pid %d"</span>, p.pid())</div><div class="line">	&#125;</div><div class="line">	p.setExternalDescriptors(fds)</div><div class="line">	<span class="comment">// Do this before syncing with child so that no children</span></div><div class="line">	<span class="comment">// can escape the cgroup</span></div><div class="line">	<span class="comment">//***把进程pid加入到cgroup中管理***//</span></div><div class="line">	<span class="comment">//***调用的是/cgroup/systemd/apply_systemd.go***//</span></div><div class="line">	<span class="keyword">if</span> err := p.manager.Apply(p.pid()); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"applying cgroup configuration for process"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="comment">// <span class="doctag">TODO:</span> should not be the responsibility to call here</span></div><div class="line">			p.manager.Destroy()</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">	<span class="comment">//***初始化容器网络***//</span></div><div class="line">	<span class="keyword">if</span> err := p.createNetworkInterfaces(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"creating nework interfaces"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***通过管道发送配置文件给子进程***//</span></div><div class="line">	<span class="keyword">if</span> err := p.sendConfig(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"sending config to init process"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">var</span> (</div><div class="line">		procSync   syncT</div><div class="line">		sentRun    <span class="keyword">bool</span></div><div class="line">		sentResume <span class="keyword">bool</span></div><div class="line">		ierr       *genericError</div><div class="line">	)</div><div class="line"></div><div class="line">	dec := json.NewDecoder(p.parentPipe)</div><div class="line">loop:</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="comment">//***从parentPipe中获取json对象***//</span></div><div class="line">		<span class="keyword">if</span> err := dec.Decode(&amp;procSync); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> err == io.EOF &#123;</div><div class="line">				<span class="keyword">break</span> loop</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"decoding sync type from init pipe"</span>)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">switch</span> procSync.Type &#123;</div><div class="line">		<span class="keyword">case</span> procReady:</div><div class="line">			<span class="keyword">if</span> err := p.manager.Set(p.config.Config); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"setting cgroup config for ready process"</span>)</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// set oom_score_adj</span></div><div class="line">			<span class="keyword">if</span> err := setOomScoreAdj(p.config.Config.OomScoreAdj, p.pid()); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"setting oom score for ready process"</span>)</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// set rlimits, this has to be done here because we lose permissions</span></div><div class="line">			<span class="comment">// to raise the limits once we enter a user-namespace</span></div><div class="line">			<span class="keyword">if</span> err := setupRlimits(p.config.Rlimits, p.pid()); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"setting rlimits for ready process"</span>)</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// call prestart hooks</span></div><div class="line">			<span class="keyword">if</span> !p.config.Config.Namespaces.Contains(configs.NEWNS) &#123;</div><div class="line">				<span class="keyword">if</span> p.config.Config.Hooks != <span class="literal">nil</span> &#123;</div><div class="line">					s := configs.HookState&#123;</div><div class="line">						Version: p.container.config.Version,</div><div class="line">						ID:      p.container.id,</div><div class="line">						Pid:     p.pid(),</div><div class="line">						Root:    p.config.Config.Rootfs,</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">for</span> i, hook := <span class="keyword">range</span> p.config.Config.Hooks.Prestart &#123;</div><div class="line">						<span class="keyword">if</span> err := hook.Run(s); err != <span class="literal">nil</span> &#123;</div><div class="line">							<span class="keyword">return</span> newSystemErrorWithCausef(err, <span class="string">"running prestart hook %d"</span>, i)</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// Sync with child.</span></div><div class="line">			<span class="comment">//***和子进程进行互动***//</span></div><div class="line">			<span class="keyword">if</span> err := utils.WriteJSON(p.parentPipe, syncT&#123;procRun&#125;); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"reading syncT run type"</span>)</div><div class="line">			&#125;</div><div class="line">			sentRun = <span class="literal">true</span></div><div class="line">		<span class="keyword">case</span> procHooks:</div><div class="line">			<span class="keyword">if</span> p.config.Config.Hooks != <span class="literal">nil</span> &#123;</div><div class="line">				s := configs.HookState&#123;</div><div class="line">					Version:    p.container.config.Version,</div><div class="line">					ID:         p.container.id,</div><div class="line">					Pid:        p.pid(),</div><div class="line">					Root:       p.config.Config.Rootfs,</div><div class="line">					BundlePath: utils.SearchLabels(p.config.Config.Labels, <span class="string">"bundle"</span>),</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">for</span> i, hook := <span class="keyword">range</span> p.config.Config.Hooks.Prestart &#123;</div><div class="line">					<span class="keyword">if</span> err := hook.Run(s); err != <span class="literal">nil</span> &#123;</div><div class="line">						<span class="keyword">return</span> newSystemErrorWithCausef(err, <span class="string">"running prestart hook %d"</span>, i)</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// Sync with child.</span></div><div class="line">			<span class="keyword">if</span> err := utils.WriteJSON(p.parentPipe, syncT&#123;procResume&#125;); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"reading syncT resume type"</span>)</div><div class="line">			&#125;</div><div class="line">			sentResume = <span class="literal">true</span></div><div class="line">		<span class="keyword">case</span> procError:</div><div class="line">			<span class="comment">// wait for the child process to fully complete and receive an error message</span></div><div class="line">			<span class="comment">// if one was encoutered</span></div><div class="line">			<span class="keyword">if</span> err := dec.Decode(&amp;ierr); err != <span class="literal">nil</span> &amp;&amp; err != io.EOF &#123;</div><div class="line">				<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"decoding proc error from init"</span>)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> ierr != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">break</span> loop</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// Programmer error.</span></div><div class="line">			<span class="built_in">panic</span>(<span class="string">"No error following JSON procError payload."</span>)</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			<span class="keyword">return</span> newSystemError(fmt.Errorf(<span class="string">"invalid JSON payload from child"</span>))</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> !sentRun &#123;</div><div class="line">		<span class="keyword">return</span> newSystemErrorWithCause(ierr, <span class="string">"container init"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> p.config.Config.Namespaces.Contains(configs.NEWNS) &amp;&amp; !sentResume &#123;</div><div class="line">		<span class="keyword">return</span> newSystemError(fmt.Errorf(<span class="string">"could not synchronise after executing prestart hooks with container process"</span>))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := syscall.Shutdown(<span class="keyword">int</span>(p.parentPipe.Fd()), syscall.SHUT_WR); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"shutting down init pipe"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Must be done after Shutdown so the child will exit and we can wait for it.</span></div><div class="line">	<span class="keyword">if</span> ierr != <span class="literal">nil</span> &#123;</div><div class="line">		p.wait()</div><div class="line">		<span class="keyword">return</span> ierr</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>start()的主要流程如下：</p>
<ol>
<li>启动initProcess，即parent中的命令——<code>runc init</code>，也就是child进程；</li>
<li>获取parentPipe；</li>
<li>调用Apply()生成cgroup相关文件；</li>
<li>调用createNetworkInterfaces()初始化容器网络；</li>
<li>调用sendConfig()把配置发送给child进程；</li>
<li>通过pipe和child进程进行交互：<br> 6.1 当收到child进程的proReady信号，则调用Set()在cgroup中添加资源限制；<br> 6.2 当收到procHooks时，则执行config.json定义的prestart hooks；<br> 6.3 当child进程把pipe关闭时，则parent退出交互；</li>
<li>返回，也就意味着<code>runc create</code>进程结束。</li>
</ol>
<p>此时child进程运行着<code>/proc/self/exe init</code>还在执行中。</p>
<h2 id="proc-self-exe-init"><a href="#proc-self-exe-init" class="headerlink" title="/proc/self/exe init"></a>/proc/self/exe init</h2><p>所以我们来分析<code>runc init</code>的流程，<code>runc init</code>的流程定义在/main_unix.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Action: <span class="function"><span class="keyword">func</span><span class="params">(context *cli.Context)</span> <span class="title">error</span></span> &#123;</div><div class="line">	factory, _ := libcontainer.New(<span class="string">""</span>)</div><div class="line">	<span class="keyword">if</span> err := factory.StartInitialization(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// as the error is sent back to the parent there is no need to log</span></div><div class="line">		<span class="comment">// or write it to stderr because the parent process will handle this</span></div><div class="line">		os.Exit(<span class="number">1</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="built_in">panic</span>(<span class="string">"libcontainer: container init failed to exec"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，<code>runc init</code>主要调用了factory的第二个入口：factory.StartInitialization()。</p>
<h2 id="factory-StartInitialization"><a href="#factory-StartInitialization" class="headerlink" title="factory.StartInitialization()"></a>factory.StartInitialization()</h2><p>factory.StartInitialization()定义在/libcontainer/factory_linux.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***容器内初始化函数,在容器内部执行的***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LinuxFactory)</span> <span class="title">StartInitialization</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</div><div class="line">	<span class="comment">//***获取管道***//</span></div><div class="line">	<span class="keyword">var</span> pipefd, rootfd <span class="keyword">int</span></div><div class="line">	<span class="keyword">for</span> _, pair := <span class="keyword">range</span> []<span class="keyword">struct</span> &#123;</div><div class="line">		k <span class="keyword">string</span></div><div class="line">		v *<span class="keyword">int</span></div><div class="line">	&#125;&#123;</div><div class="line">		&#123;<span class="string">"_LIBCONTAINER_INITPIPE"</span>, &amp;pipefd&#125;,</div><div class="line">		&#123;<span class="string">"_LIBCONTAINER_STATEDIR"</span>, &amp;rootfd&#125;,</div><div class="line">	&#125; &#123;</div><div class="line"></div><div class="line">		s := os.Getenv(pair.k)</div><div class="line"></div><div class="line">		i, err := strconv.Atoi(s)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"unable to convert %s=%s to int"</span>, pair.k, s)</div><div class="line">		&#125;</div><div class="line">		*pair.v = i</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">var</span> (</div><div class="line">		pipe = os.NewFile(<span class="keyword">uintptr</span>(pipefd), <span class="string">"pipe"</span>)</div><div class="line">		it   = initType(os.Getenv(<span class="string">"_LIBCONTAINER_INITTYPE"</span>))</div><div class="line">	)</div><div class="line">	<span class="comment">// clear the current process's environment to clean any libcontainer</span></div><div class="line">	<span class="comment">// specific env vars.</span></div><div class="line">	os.Clearenv()</div><div class="line"></div><div class="line">	<span class="keyword">var</span> i initer</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="comment">// We have an error during the initialization of the container's init,</span></div><div class="line">		<span class="comment">// send it back to the parent process in the form of an initError.</span></div><div class="line">		<span class="comment">// If container's init successed, syscall.Exec will not return, hence</span></div><div class="line">		<span class="comment">// this defer function will never be called.</span></div><div class="line">		<span class="keyword">if</span> _, ok := i.(*linuxStandardInit); ok &#123;</div><div class="line">			<span class="comment">//  Synchronisation only necessary for standard init.</span></div><div class="line">			<span class="comment">//***把错误信息通知parent***//</span></div><div class="line">			<span class="keyword">if</span> werr := utils.WriteJSON(pipe, syncT&#123;procError&#125;); werr != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="built_in">panic</span>(err)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> werr := utils.WriteJSON(pipe, newSystemError(err)); werr != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="built_in">panic</span>(err)</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// ensure that this pipe is always closed</span></div><div class="line">		pipe.Close()</div><div class="line">	&#125;()</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> e := <span class="built_in">recover</span>(); e != <span class="literal">nil</span> &#123;</div><div class="line">			err = fmt.Errorf(<span class="string">"panic from initialization: %v, %v"</span>, e, <span class="keyword">string</span>(debug.Stack()))</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">	<span class="comment">//***newContainerInit()定义在init_linux.go中***//</span></div><div class="line">	i, err = newContainerInit(it, pipe, rootfd)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***执行Init()***//</span></div><div class="line">	<span class="keyword">return</span> i.Init()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>factory.StartInitialization()的主要流程如下：</p>
<ol>
<li>从环境变量中获取pipe(环境变量在newParentProcess()中设置)及init的类型；</li>
<li>调用newContainerInit()生成init：linuxSetnsInit或initStandardInit；</li>
<li>调用init的Init()方法。</li>
</ol>
<p>newContainerInit()定义在/libcontainer/init_linux.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newContainerInit</span><span class="params">(t initType, pipe *os.File, stateDirFD <span class="keyword">int</span>)</span> <span class="params">(initer, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> config *initConfig</div><div class="line">	<span class="comment">//***通过管道获取配置信息***//</span></div><div class="line">	<span class="keyword">if</span> err := json.NewDecoder(pipe).Decode(&amp;config); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***从配置信息中获取环境变量并设置为容器内环境变量***//</span></div><div class="line">	<span class="keyword">if</span> err := populateProcessEnvironment(config.Env); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">switch</span> t &#123;</div><div class="line">	<span class="keyword">case</span> initSetns:</div><div class="line">		<span class="keyword">return</span> &amp;linuxSetnsInit&#123;</div><div class="line">			config: config,</div><div class="line">		&#125;, <span class="literal">nil</span></div><div class="line">	<span class="keyword">case</span> initStandard:</div><div class="line">		<span class="keyword">return</span> &amp;linuxStandardInit&#123;</div><div class="line">			pipe:       pipe,</div><div class="line">			parentPid:  syscall.Getppid(),</div><div class="line">			config:     config,</div><div class="line">			stateDirFD: stateDirFD,</div><div class="line">		&#125;, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unknown init type %q"</span>, t)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当运行<code>runc create</code>时生成的是linuxStandardInit。</p>
<h2 id="linuxStandardInit"><a href="#linuxStandardInit" class="headerlink" title="linuxStandardInit"></a>linuxStandardInit</h2><p>linuxStandardInit定义在/libcontainer/standard_init_linux.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> linuxStandardInit <span class="keyword">struct</span> &#123;</div><div class="line">	pipe       io.ReadWriteCloser</div><div class="line">	parentPid  <span class="keyword">int</span></div><div class="line">	stateDirFD <span class="keyword">int</span></div><div class="line">	config     *initConfig</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其主要有Init()方法：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *linuxStandardInit)</span> <span class="title">Init</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> !l.config.Config.NoNewKeyring &#123;</div><div class="line">		ringname, keepperms, newperms := l.getSessionRingParams()</div><div class="line"></div><div class="line">		<span class="comment">// do not inherit the parent's session keyring</span></div><div class="line">		sessKeyId, err := keys.JoinSessionKeyring(ringname)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// make session keyring searcheable</span></div><div class="line">		<span class="keyword">if</span> err := keys.ModKeyringPerm(sessKeyId, keepperms, newperms); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> console *linuxConsole</div><div class="line">	<span class="keyword">if</span> l.config.Console != <span class="string">""</span> &#123;</div><div class="line">		console = newConsoleFromPath(l.config.Console)</div><div class="line">		<span class="keyword">if</span> err := console.dupStdio(); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> console != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> err := system.Setctty(); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := setupNetwork(l.config); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := setupRoute(l.config.Config); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	label.Init()</div><div class="line">	<span class="comment">// InitializeMountNamespace() can be executed only for a new mount namespace</span></div><div class="line">	<span class="keyword">if</span> l.config.Config.Namespaces.Contains(configs.NEWNS) &#123;</div><div class="line">		<span class="keyword">if</span> err := setupRootfs(l.config.Config, console, l.pipe); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> hostname := l.config.Config.Hostname; hostname != <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">if</span> err := syscall.Sethostname([]<span class="keyword">byte</span>(hostname)); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := apparmor.ApplyProfile(l.config.AppArmorProfile); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := label.SetProcessLabel(l.config.ProcessLabel); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> key, value := <span class="keyword">range</span> l.config.Config.Sysctl &#123;</div><div class="line">		<span class="keyword">if</span> err := writeSystemProperty(key, value); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> _, path := <span class="keyword">range</span> l.config.Config.ReadonlyPaths &#123;</div><div class="line">		<span class="keyword">if</span> err := remountReadonly(path); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> _, path := <span class="keyword">range</span> l.config.Config.MaskPaths &#123;</div><div class="line">		<span class="keyword">if</span> err := maskPath(path); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	pdeath, err := system.GetParentDeathSignal()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> l.config.NoNewPrivileges &#123;</div><div class="line">		<span class="keyword">if</span> err := system.Prctl(PR_SET_NO_NEW_PRIVS, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Tell our parent that we're ready to Execv. This must be done before the</span></div><div class="line">	<span class="comment">// Seccomp rules have been applied, because we need to be able to read and</span></div><div class="line">	<span class="comment">// write to a socket.</span></div><div class="line">	<span class="keyword">if</span> err := syncParentReady(l.pipe); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Without NoNewPrivileges seccomp is a privileged operation, so we need to</span></div><div class="line">	<span class="comment">// do this before dropping capabilities; otherwise do it as late as possible</span></div><div class="line">	<span class="comment">// just before execve so as few syscalls take place after it as possible.</span></div><div class="line">	<span class="keyword">if</span> l.config.Config.Seccomp != <span class="literal">nil</span> &amp;&amp; !l.config.NoNewPrivileges &#123;</div><div class="line">		<span class="keyword">if</span> err := seccomp.InitSeccomp(l.config.Config.Seccomp); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := finalizeNamespace(l.config); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// finalizeNamespace can change user/group which clears the parent death</span></div><div class="line">	<span class="comment">// signal, so we restore it here.</span></div><div class="line">	<span class="keyword">if</span> err := pdeath.Restore(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// compare the parent from the inital start of the init process and make sure that it did not change.</span></div><div class="line">	<span class="comment">// if the parent changes that means it died and we were reparented to something else so we should</span></div><div class="line">	<span class="comment">// just kill ourself and not cause problems for someone else.</span></div><div class="line">	<span class="keyword">if</span> syscall.Getppid() != l.parentPid &#123;</div><div class="line">		<span class="keyword">return</span> syscall.Kill(syscall.Getpid(), syscall.SIGKILL)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// check for the arg before waiting to make sure it exists and it is returned</span></div><div class="line">	<span class="comment">// as a create time error.</span></div><div class="line">	name, err := exec.LookPath(l.config.Args[<span class="number">0</span>])</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// close the pipe to signal that we have completed our init.</span></div><div class="line">	<span class="comment">//***关闭pipe，此时，parent process和该process的交互完成***//</span></div><div class="line">	l.pipe.Close()</div><div class="line">	<span class="comment">// wait for the fifo to be opened on the other side before</span></div><div class="line">	<span class="comment">// exec'ing the users process.</span></div><div class="line">	<span class="comment">//***此步会阻塞，直到有进程open exec.fifo***//</span></div><div class="line">	fd, err := syscall.Openat(l.stateDirFD, execFifoFilename, os.O_WRONLY|syscall.O_CLOEXEC, <span class="number">0</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"openat exec fifo"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***往exec.fifo中写入0***//</span></div><div class="line">	<span class="keyword">if</span> _, err := syscall.Write(fd, []<span class="keyword">byte</span>(<span class="string">"0"</span>)); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"write 0 exec fifo"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> l.config.Config.Seccomp != <span class="literal">nil</span> &amp;&amp; l.config.NoNewPrivileges &#123;</div><div class="line">		<span class="keyword">if</span> err := seccomp.InitSeccomp(l.config.Config.Seccomp); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"init seccomp"</span>)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***name:  /bin/date***//</span></div><div class="line">	<span class="comment">//***l.config.Args[0:]:  [/bin/date]***//</span></div><div class="line">	<span class="keyword">if</span> err := syscall.Exec(name, l.config.Args[<span class="number">0</span>:], os.Environ()); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"exec user process"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Init()方法会开始准备执行环境，并与parent进程进行交互。之后会主动关闭pipe结束交互。接着在syscall.Openat(exec.fifo)处阻塞。如果阻塞消除，则Init()往exec.fifo写”0” 。最后，神奇的事情发生了，在调用syscall.Exec()后，把用户的命令替换init命令，child进程完成了华丽丽的转变。容器启动完毕。<br>所以，这里关键的是阻塞，阻塞的消除由<code>runc start</code>完成。</p>
<h2 id="runc-start"><a href="#runc-start" class="headerlink" title="runc start"></a>runc start</h2><p><code>runc start</code>的流程定义在/start.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Action: <span class="function"><span class="keyword">func</span><span class="params">(context *cli.Context)</span> <span class="title">error</span></span> &#123;</div><div class="line">	container, err := getContainer(context)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	status, err := container.Status()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">switch</span> status &#123;</div><div class="line">	<span class="keyword">case</span> libcontainer.Created:</div><div class="line">		<span class="keyword">return</span> container.Exec()</div><div class="line">	<span class="keyword">case</span> libcontainer.Stopped:</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"cannot start a container that has run and stopped"</span>)</div><div class="line">	<span class="keyword">case</span> libcontainer.Running:</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"cannot start an already running container"</span>)</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"cannot start a container in the %s state"</span>, status)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，如果容器在Created状态，那么就调用container.Exec()。而容器的状态由parent进程在最后会设置为Created状态。</p>
<h2 id="container-exec"><a href="#container-exec" class="headerlink" title="container.exec()"></a>container.exec()</h2><p>container.exec()定义在/libcontainer/container_linux.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***Exec()调用exec()***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *linuxContainer)</span> <span class="title">Exec</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	c.m.Lock()</div><div class="line">	<span class="keyword">defer</span> c.m.Unlock()</div><div class="line">	<span class="keyword">return</span> c.exec()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *linuxContainer)</span> <span class="title">exec</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***path:  /run/runc/nginx/exec.fifo***//</span></div><div class="line">	path := filepath.Join(c.root, execFifoFilename)</div><div class="line">	f, err := os.OpenFile(path, os.O_RDONLY, <span class="number">0</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> newSystemErrorWithCause(err, <span class="string">"open exec fifo for reading"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> f.Close()</div><div class="line">	<span class="comment">//***data:  0***//</span></div><div class="line">	<span class="comment">//***只要把exec.fifo中的数据取出，则create()中的进程开始执行***//</span></div><div class="line">	data, err := ioutil.ReadAll(f)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(data) &gt; <span class="number">0</span> &#123;</div><div class="line">		os.Remove(path)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> fmt.Errorf(<span class="string">"cannot start an already running container"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Exec()的流程很简单，打开exec.fifo，让child进程住下执行。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本次分析介绍了<code>run create</code>和<code>runc start</code>的流程，其中很多细节并未详细介绍，如namespace的建立，cgroup的处理等，这些将会后续详细分析。<br>create和start流程分析完毕。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/11/22/runc源码分析(一)-create和start流程-v1-0-0-rc2/" data-id="cjbm508u6006r8oqsn5s5j9kd" class="article-share-link">分享</a><div class="tags"><a href="/tags/runc/">runc</a><a href="/tags/runc-v1-0-0-rc2/">runc-v1.0.0-rc2</a></div><div class="post-nav"><a href="/2017/11/24/containerd-containerd-shim和runc的依存关系/" class="pre">containerd,containerd-shim和runc的依存关系</a><a href="/2017/11/19/containerd-shim源码分析-v0-2-4/" class="next">containerd-shim源码分析-v0.2.4</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/25/Docker命令分行分析-run-v1-12-3/">Docker命令分行分析-run-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/23/kubelet分析(七)-dockerManager(2)-v1-5-2/">kubelet分析(七)-dockerManager(2)-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/23/kubelet分析(七)-dockerManager(1)-v1-5-2/">kubelet分析(七)-dockerManager(1)-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/20/kubelet分析(六)-proberManager-v1-5-2/">kubelet分析(六)-proberManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/18/kubelet分析(五)-podManager-v1-5-2/">kubelet分析(五)-podManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(四)-statusManager-v1-5-2/">kubelet分析(四)-statusManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(三)-volumeManager-v1-5-2/">kubelet分析(三)-volumeManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/kubelet分析(二)-podWorker-v1-5-2/">kubelet分析(二)-podWorker-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/kubelet分析(一)-config-v1-5-2/">kubelet分析(一)-config-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/15/storage解读(六)-strategy-v1-5-2/">storage解读(六)-strategy-v1.5.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>