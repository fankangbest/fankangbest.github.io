<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>containerd-container和process-v0.2.4 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">containerd-container和process-v0.2.4</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">containerd-container和process-v0.2.4</h1><div class="post-meta">Nov 19, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>上次介绍了containerd的执行流程，其中容器相关的工作都是调用containerd中的container或process完成的。所以本次分析就介绍containerd的container和process，看这两者是如何和containerd-shim或runc打交道的。</p>
<h2 id="container"><a href="#container" class="headerlink" title="container"></a>container</h2><p>container定义在/runtime/container.go中:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> container <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// path to store runtime state information</span></div><div class="line">	root        <span class="keyword">string</span></div><div class="line">	id          <span class="keyword">string</span></div><div class="line">	bundle      <span class="keyword">string</span></div><div class="line">	runtime     <span class="keyword">string</span></div><div class="line">	runtimeArgs []<span class="keyword">string</span></div><div class="line">	shim        <span class="keyword">string</span></div><div class="line">	processes   <span class="keyword">map</span>[<span class="keyword">string</span>]*process</div><div class="line">	labels      []<span class="keyword">string</span></div><div class="line">	oomFds      []<span class="keyword">int</span></div><div class="line">	noPivotRoot <span class="keyword">bool</span></div><div class="line">	timeout     time.Duration</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中：</p>
<ul>
<li>root: 表示containerd的主目录，如/var/run/docker/libcontainerd/containerd；</li>
<li>id: 表示container的id，如nginx；</li>
<li>bundle: 容器rootfs目录；</li>
<li>runtime: 一般为runc；</li>
<li>runtimeArgs: runtime的一般性参数，runc为空；</li>
<li>shim: containerd-shim二进制文件；</li>
<li>processes: 记录容器内支持的进程，进程是指容器中运行的进程；</li>
<li>labels: 容器的标签；</li>
<li>noPivotRoot: 暂不知道用途，目前一直是false，runc中会有pivot系统调用，到分析runc时再回过头来看；</li>
</ul>
<h3 id="New"><a href="#New" class="headerlink" title="New()"></a>New()</h3><p>New()生成一个container，并把state信息记录在state.json文件中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// New returns a new container</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(opts ContainerOpts)</span> <span class="params">(Container, error)</span></span> &#123;</div><div class="line">	c := &amp;container&#123;</div><div class="line">		root:        opts.Root,</div><div class="line">		id:          opts.ID,</div><div class="line">		bundle:      opts.Bundle,</div><div class="line">		labels:      opts.Labels,</div><div class="line">		processes:   <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*process),</div><div class="line">		runtime:     opts.Runtime,</div><div class="line">		runtimeArgs: opts.RuntimeArgs,</div><div class="line">		shim:        opts.Shim,</div><div class="line">		noPivotRoot: opts.NoPivotRoot,</div><div class="line">		timeout:     opts.Timeout,</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := os.Mkdir(filepath.Join(c.root, c.id), <span class="number">0755</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***创建state.json***//</span></div><div class="line">	<span class="comment">//***StateFile = "state.json"***//</span></div><div class="line">	f, err := os.Create(filepath.Join(c.root, c.id, StateFile))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> f.Close()</div><div class="line">	<span class="comment">//***写入state.json***//</span></div><div class="line">	<span class="keyword">if</span> err := json.NewEncoder(f).Encode(state&#123;</div><div class="line">		Bundle:      c.bundle,</div><div class="line">		Labels:      c.labels,</div><div class="line">		Runtime:     c.runtime,</div><div class="line">		RuntimeArgs: c.runtimeArgs,</div><div class="line">		Shim:        c.shim,</div><div class="line">		NoPivotRoot: opts.NoPivotRoot,</div><div class="line">	&#125;); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> c, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Load"><a href="#Load" class="headerlink" title="Load()"></a>Load()</h3><p>Load()读取container的state.json及各进程的process.json，还原container对象。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Load return a new container from the matchin state file on disk.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Load</span><span class="params">(root, id, shimName <span class="keyword">string</span>, timeout time.Duration)</span> <span class="params">(Container, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> s state</div><div class="line">	<span class="comment">//***StateFile = "state.json"***//</span></div><div class="line">	f, err := os.Open(filepath.Join(root, id, StateFile))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> f.Close()</div><div class="line">	<span class="keyword">if</span> err := json.NewDecoder(f).Decode(&amp;s); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	c := &amp;container&#123;</div><div class="line">		root:        root,</div><div class="line">		id:          id,</div><div class="line">		bundle:      s.Bundle,</div><div class="line">		labels:      s.Labels,</div><div class="line">		runtime:     s.Runtime,</div><div class="line">		runtimeArgs: s.RuntimeArgs,</div><div class="line">		shim:        s.Shim,</div><div class="line">		noPivotRoot: s.NoPivotRoot,</div><div class="line">		processes:   <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*process),</div><div class="line">		timeout:     timeout,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> c.shim == <span class="string">""</span> &#123;</div><div class="line">		c.shim = shimName</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	dirs, err := ioutil.ReadDir(filepath.Join(root, id))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***一个目录代表一个进程***//</span></div><div class="line">	<span class="keyword">for</span> _, d := <span class="keyword">range</span> dirs &#123;</div><div class="line">		<span class="keyword">if</span> !d.IsDir() &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		pid := d.Name()</div><div class="line">		s, err := readProcessState(filepath.Join(root, id, pid))</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">		p, err := loadProcess(filepath.Join(root, id, pid), pid, c, s)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			logrus.WithField(<span class="string">"id"</span>, id).WithField(<span class="string">"pid"</span>, pid).Debug(<span class="string">"containerd: error loading process %s"</span>, err)</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		c.processes[pid] = p</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> c, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="readSpec"><a href="#readSpec" class="headerlink" title="readSpec()"></a>readSpec()</h3><p>readSpec()读取bundle目录下的config.json文件。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***读取bundle目录下的config.json文件***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *container)</span> <span class="title">readSpec</span><span class="params">()</span> <span class="params">(*specs.Spec, error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> spec specs.Spec</div><div class="line">	f, err := os.Open(filepath.Join(c.bundle, <span class="string">"config.json"</span>))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> f.Close()</div><div class="line">	<span class="keyword">if</span> err := json.NewDecoder(f).Decode(&amp;spec); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;spec, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Delete"><a href="#Delete" class="headerlink" title="Delete()"></a>Delete()</h3><p>Delete()先移除containerd目录下的容器目录，然后调用<code>runc delete id</code>删除容器。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *container)</span> <span class="title">Delete</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***删除磁盘上state目录***//</span></div><div class="line">	err := os.RemoveAll(filepath.Join(c.root, c.id))</div><div class="line"></div><div class="line">	<span class="comment">//***调用runc delete id命令删除容器***//</span></div><div class="line">	args := c.runtimeArgs</div><div class="line">	args = <span class="built_in">append</span>(args, <span class="string">"delete"</span>, c.id)</div><div class="line">	<span class="keyword">if</span> b, derr := exec.Command(c.runtime, args...).CombinedOutput(); err != <span class="literal">nil</span> &#123;</div><div class="line">		err = fmt.Errorf(<span class="string">"%s: %q"</span>, derr, <span class="keyword">string</span>(b))</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">len</span>(b) &gt; <span class="number">0</span> &#123;</div><div class="line">		logrus.Debugf(<span class="string">"%v %v: %q"</span>, c.runtime, args, <span class="keyword">string</span>(b))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Processes"><a href="#Processes" class="headerlink" title="Processes()"></a>Processes()</h3><p>Processes()返回container中的processes。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***返回container中的processes***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *container)</span> <span class="title">Processes</span><span class="params">()</span> <span class="params">([]Process, error)</span></span> &#123;</div><div class="line">	out := []Process&#123;&#125;</div><div class="line">	<span class="keyword">for</span> _, p := <span class="keyword">range</span> c.processes &#123;</div><div class="line">		out = <span class="built_in">append</span>(out, p)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> out, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RemoveProcesses"><a href="#RemoveProcesses" class="headerlink" title="RemoveProcesses()"></a>RemoveProcesses()</h3><p>RemoveProcesses()删除指定process的目录。在containerd中，一个process用一个目录表示。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *container)</span> <span class="title">RemoveProcess</span><span class="params">(pid <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="built_in">delete</span>(c.processes, pid)</div><div class="line">	<span class="keyword">return</span> os.RemoveAll(filepath.Join(c.root, c.id, pid))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="State"><a href="#State" class="headerlink" title="State()"></a>State()</h3><p>State()返回init进程的state。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***返回init进程的state***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *container)</span> <span class="title">State</span><span class="params">()</span> <span class="title">State</span></span> &#123;</div><div class="line">	proc := c.processes[<span class="string">"init"</span>]</div><div class="line">	<span class="keyword">if</span> proc == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> Stopped</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> proc.State()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Pause"><a href="#Pause" class="headerlink" title="Pause()"></a>Pause()</h3><p>Pause()挂起某一容器。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***调用runc pause id***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *container)</span> <span class="title">Pause</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	args := c.runtimeArgs</div><div class="line">	args = <span class="built_in">append</span>(args, <span class="string">"pause"</span>, c.id)</div><div class="line">	b, err := exec.Command(c.runtime, args...).CombinedOutput()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"%s: %q"</span>, err.Error(), <span class="keyword">string</span>(b))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Resume"><a href="#Resume" class="headerlink" title="Resume()"></a>Resume()</h3><p>与Pause()相对应，Resume()恢复某一容器。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***调用runc resume id***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *container)</span> <span class="title">Resume</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	args := c.runtimeArgs</div><div class="line">	args = <span class="built_in">append</span>(args, <span class="string">"resume"</span>, c.id)</div><div class="line">	b, err := exec.Command(c.runtime, args...).CombinedOutput()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"%s: %q"</span>, err.Error(), <span class="keyword">string</span>(b))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Start"><a href="#Start" class="headerlink" title="Start()"></a>Start()</h3><p>Start()的流程如下：</p>
<ol>
<li>生成命令：<code>shim id bundle runc</code>，工作目录为process目录；</li>
<li>读取容器config.json文件，生成init process；</li>
<li>调用createCmd()启动<code>shim id bundle runc</code>；</li>
<li>返回init process。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *container)</span> <span class="title">Start</span><span class="params">(checkpointPath <span class="keyword">string</span>, s Stdio)</span> <span class="params">(Process, error)</span></span> &#123;</div><div class="line">	<span class="comment">//***processRoot:  /var/run/docker/libcontainerd/containerd/mynginx/init***//</span></div><div class="line">	processRoot := filepath.Join(c.root, c.id, InitProcessID)</div><div class="line">	<span class="keyword">if</span> err := os.Mkdir(processRoot, <span class="number">0755</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***构建cmd，调用的是containerd-shim***//</span></div><div class="line">	<span class="comment">//***docker-containerd-shim nginx /home/fankang/mycontainer runc***//</span></div><div class="line">	cmd := exec.Command(c.shim,</div><div class="line">		c.id, c.bundle, c.runtime,</div><div class="line">	)</div><div class="line">	cmd.Dir = processRoot</div><div class="line">	cmd.SysProcAttr = &amp;syscall.SysProcAttr&#123;</div><div class="line">		Setpgid: <span class="literal">true</span>,</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***读取bundle目录下的config.json文件***//</span></div><div class="line">	spec, err := c.readSpec()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***InitProcessID = "init"***//</span></div><div class="line">	config := &amp;processConfig&#123;</div><div class="line">		checkpoint:  checkpointPath,</div><div class="line">		root:        processRoot,</div><div class="line">		id:          InitProcessID,</div><div class="line">		c:           c,</div><div class="line">		stdio:       s,</div><div class="line">		spec:        spec,</div><div class="line">		processSpec: specs.ProcessSpec(spec.Process),</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//****生成process**//</span></div><div class="line">	p, err := newProcess(config)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***执行cmd***//</span></div><div class="line">	<span class="keyword">if</span> err := c.createCmd(InitProcessID, cmd, p); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> p, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Exec"><a href="#Exec" class="headerlink" title="Exec()"></a>Exec()</h3><p>Exec()流程和Start()基本一致，只是生成的process不同。<br>由于传shim的工作目录为process目录，所以shim可以根据process.json判断出是Start()还是Exec()，并作出相应的处理。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *container)</span> <span class="title">Exec</span><span class="params">(pid <span class="keyword">string</span>, pspec specs.ProcessSpec, s Stdio)</span> <span class="params">(pp Process, err error)</span></span> &#123;</div><div class="line">	processRoot := filepath.Join(c.root, c.id, pid)</div><div class="line">	<span class="keyword">if</span> err := os.Mkdir(processRoot, <span class="number">0755</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			c.RemoveProcess(pid)</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">	<span class="comment">//***exec也是通过containerd-shim执行***//</span></div><div class="line">	cmd := exec.Command(c.shim,</div><div class="line">		c.id, c.bundle, c.runtime,</div><div class="line">	)</div><div class="line">	cmd.Dir = processRoot</div><div class="line">	cmd.SysProcAttr = &amp;syscall.SysProcAttr&#123;</div><div class="line">		Setpgid: <span class="literal">true</span>,</div><div class="line">	&#125;</div><div class="line">	spec, err := c.readSpec()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***exec的config需标识exec: true***//</span></div><div class="line">	config := &amp;processConfig&#123;</div><div class="line">		exec:        <span class="literal">true</span>,</div><div class="line">		id:          pid,</div><div class="line">		root:        processRoot,</div><div class="line">		c:           c,</div><div class="line">		processSpec: pspec,</div><div class="line">		spec:        spec,</div><div class="line">		stdio:       s,</div><div class="line">	&#125;</div><div class="line">	p, err := newProcess(config)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := c.createCmd(pid, cmd, p); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> p, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="createCmd"><a href="#createCmd" class="headerlink" title="createCmd()"></a>createCmd()</h3><p>createCmd()会执行命令，命令为shim命令，当具体容器内进程pid生成(由runc生成)后，createCmd会启动一个go routine来等待shim命令的结束。shim命令一般不会退出。当shim发生退出时，如果容器内的进程仍在运行，则需要把该进程杀死；如果容器内进程已经不存在，则无需清理工作。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *container)</span> <span class="title">createCmd</span><span class="params">(pid <span class="keyword">string</span>, cmd *exec.Cmd, p *process)</span> <span class="title">error</span></span> &#123;</div><div class="line">	p.cmd = cmd</div><div class="line">	<span class="comment">//***执行cmd***//</span></div><div class="line">	<span class="keyword">if</span> err := cmd.Start(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">close</span>(p.cmdDoneCh)</div><div class="line">		<span class="keyword">if</span> exErr, ok := err.(*exec.Error); ok &#123;</div><div class="line">			<span class="keyword">if</span> exErr.Err == exec.ErrNotFound || exErr.Err == os.ErrNotExist &#123;</div><div class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">"%s not installed on system"</span>, c.shim)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// We need the pid file to have been written to run</span></div><div class="line">	<span class="comment">//***defer中执行***//</span></div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="comment">//***起一个go routine等待shim结束***//</span></div><div class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">			<span class="comment">//***Fankang***//</span></div><div class="line">			<span class="comment">//***等待cmd执行完成***//</span></div><div class="line">			err := p.cmd.Wait()</div><div class="line">			<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">				p.cmdSuccess = <span class="literal">true</span></div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">//***此处在调用ctr kill时都会执行到，表明shim进程退出时所要做的处理***//</span></div><div class="line">			<span class="comment">//***系统中进程的启动时间和内存中记录的时间比较，查看是否为同一process***//</span></div><div class="line">			<span class="comment">//***此处如果是正常退出的话，则linux系统上进程已经不存在，所以linux系统上进程时间为空***//</span></div><div class="line">			<span class="comment">//***如果是异常退出的话，如kill -9 shim进程，则linux系统上进程仍存在，此时same为true***//</span></div><div class="line">			<span class="keyword">if</span> same, err := p.isSameProcess(); same &amp;&amp; p.pid &gt; <span class="number">0</span> &#123;</div><div class="line">				<span class="comment">// The process changed its PR_SET_PDEATHSIG, so force</span></div><div class="line">				<span class="comment">// kill it</span></div><div class="line">				logrus.Infof(<span class="string">"containerd: %s:%s (pid %v) has become an orphan, killing it"</span>, p.container.id, p.id, p.pid)</div><div class="line">				err = unix.Kill(p.pid, syscall.SIGKILL)</div><div class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; err != syscall.ESRCH &#123;</div><div class="line">					logrus.Errorf(<span class="string">"containerd: unable to SIGKILL %s:%s (pid %v): %v"</span>, p.container.id, p.id, p.pid, err)</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="keyword">for</span> &#123;</div><div class="line">						err = unix.Kill(p.pid, <span class="number">0</span>)</div><div class="line">						<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">							<span class="keyword">break</span></div><div class="line">						&#125;</div><div class="line">						time.Sleep(<span class="number">5</span> * time.Millisecond)</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="built_in">close</span>(p.cmdDoneCh)</div><div class="line">		&#125;()</div><div class="line">	&#125;()</div><div class="line">	<span class="comment">//***等待进行创建完成***//</span></div><div class="line">	<span class="keyword">if</span> err := c.waitForCreate(p, cmd); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	c.processes[pid] = p</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Pids"><a href="#Pids" class="headerlink" title="Pids()"></a>Pids()</h3><p>Pids()返回容器中的进程。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***调用runc ps --format=json id获取容器中进程的pid号***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *container)</span> <span class="title">Pids</span><span class="params">()</span> <span class="params">([]<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	args := c.runtimeArgs</div><div class="line">	args = <span class="built_in">append</span>(args, <span class="string">"ps"</span>, <span class="string">"--format=json"</span>, c.id)</div><div class="line">	out, err := exec.Command(c.runtime, args...).CombinedOutput()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"%s: %q"</span>, err.Error(), out)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">var</span> pids []<span class="keyword">int</span></div><div class="line">	<span class="keyword">if</span> err := json.Unmarshal(out, &amp;pids); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> pids, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Stats"><a href="#Stats" class="headerlink" title="Stats()"></a>Stats()</h3><p>Stats()通过调用<code>runc events --stats nginx</code>获取容器的监控信息<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***通过调用runc events --stats nginx获取容器的监控信息***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *container)</span> <span class="title">Stats</span><span class="params">()</span> <span class="params">(*Stat, error)</span></span> &#123;</div><div class="line">	now := time.Now()</div><div class="line">	args := c.runtimeArgs</div><div class="line">	args = <span class="built_in">append</span>(args, <span class="string">"events"</span>, <span class="string">"--stats"</span>, c.id)</div><div class="line">	out, err := exec.Command(c.runtime, args...).CombinedOutput()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"%s: %q"</span>, err.Error(), out)</div><div class="line">	&#125;</div><div class="line">	s := <span class="keyword">struct</span> &#123;</div><div class="line">		Data *Stat <span class="string">`json:"data"`</span></div><div class="line">	&#125;&#123;&#125;</div><div class="line">	<span class="keyword">if</span> err := json.Unmarshal(out, &amp;s); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	s.Data.Timestamp = now</div><div class="line">	<span class="keyword">return</span> s.Data, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Status"><a href="#Status" class="headerlink" title="Status()"></a>Status()</h3><p>Status()通过<code>runc state id</code>获取容器的状态信息。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***通过runc state id获取容器的状态信息***//</span></div><div class="line"><span class="comment">//&#123;</span></div><div class="line"><span class="comment">//  "ociVersion": "1.0.0-rc2-dev",</span></div><div class="line"><span class="comment">//  "id": "nginx",</span></div><div class="line"><span class="comment">//  "pid": 2416,</span></div><div class="line"><span class="comment">//  "status": "running",</span></div><div class="line"><span class="comment">//  "bundle": "/home/fankang/mycontainer",</span></div><div class="line"><span class="comment">//  "rootfs": "/home/fankang/mycontainer/rootfs",</span></div><div class="line"><span class="comment">//  "created": "2017-11-19T07:15:34.567151194Z"</span></div><div class="line"><span class="comment">//&#125;</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *container)</span> <span class="title">Status</span><span class="params">()</span> <span class="params">(State, error)</span></span> &#123;</div><div class="line">	args := c.runtimeArgs</div><div class="line">	args = <span class="built_in">append</span>(args, <span class="string">"state"</span>, c.id)</div><div class="line"></div><div class="line">	out, err := exec.Command(c.runtime, args...).CombinedOutput()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"%s: %q"</span>, err.Error(), out)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// We only require the runtime json output to have a top level Status field.</span></div><div class="line">	<span class="keyword">var</span> s <span class="keyword">struct</span> &#123;</div><div class="line">		Status State <span class="string">`json:"status"`</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := json.Unmarshal(out, &amp;s); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> s.Status, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h2><p>Process定义在/runtime/process.go中，表示容器内部运行的一个进程：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***定义process***//</span></div><div class="line"><span class="keyword">type</span> process <span class="keyword">struct</span> &#123;</div><div class="line">	root        <span class="keyword">string</span></div><div class="line">	id          <span class="keyword">string</span></div><div class="line">	pid         <span class="keyword">int</span></div><div class="line">	exitPipe    *os.File</div><div class="line">	controlPipe *os.File</div><div class="line">	container   *container</div><div class="line">	spec        specs.ProcessSpec</div><div class="line">	stdio       Stdio</div><div class="line">	cmd         *exec.Cmd</div><div class="line">	cmdSuccess  <span class="keyword">bool</span></div><div class="line">	cmdDoneCh   <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</div><div class="line">	state       State</div><div class="line">	stateLock   sync.Mutex</div><div class="line">	startTime   <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="newProcess"><a href="#newProcess" class="headerlink" title="newProcess()"></a>newProcess()</h3><p>newProcess()的流程如下：</p>
<ol>
<li>生成process;</li>
<li>创建process.json</li>
<li>生成ProcessState并写入process.json</li>
<li>创建exit和control以和shim交互；</li>
<li>返回process。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newProcess</span><span class="params">(config *processConfig)</span> <span class="params">(*process, error)</span></span> &#123;</div><div class="line">	<span class="comment">//***p:  &amp;&#123;/var/run/docker/libcontainerd/containerd/nginx/init init 0 &lt;nil&gt; &lt;nil&gt; 0xc4200a71e0 &#123;true &#123;0 0 []&#125; [/usr/bin/supervisord] [PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin TERM=xterm] / [CAP_AUDIT_WRITE CAP_KILL CAP_NET_BIND_SERVICE] [&#123;RLIMIT_NOFILE 1024 1024&#125;] true  &#125; &#123;/tmp/ctr-884111030/stdin /tmp/ctr-884111030/stdout /tmp/ctr-884111030/stderr&#125; &lt;nil&gt; false 0xc420057620 running &#123;0 0&#125; &#125;***//</span></div><div class="line">	p := &amp;process&#123;</div><div class="line">		root:      config.root,</div><div class="line">		id:        config.id,</div><div class="line">		container: config.c,</div><div class="line">		spec:      config.processSpec,</div><div class="line">		stdio:     config.stdio,</div><div class="line">		cmdDoneCh: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</div><div class="line">		state:     Running,</div><div class="line">	&#125;</div><div class="line">	uid, gid, err := getRootIDs(config.spec)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***创建process.json***//</span></div><div class="line">	<span class="comment">//***config.root:  /var/run/docker/libcontainerd/containerd/nginx/init***//</span></div><div class="line">	f, err := os.Create(filepath.Join(config.root, <span class="string">"process.json"</span>))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> f.Close()</div><div class="line"></div><div class="line">	ps := ProcessState&#123;</div><div class="line">		ProcessSpec: config.processSpec,</div><div class="line">		Exec:        config.exec,</div><div class="line">		PlatformProcessState: PlatformProcessState&#123;</div><div class="line">			Checkpoint: config.checkpoint,</div><div class="line">			RootUID:    uid,</div><div class="line">			RootGID:    gid,</div><div class="line">		&#125;,</div><div class="line">		Stdin:       config.stdio.Stdin,</div><div class="line">		Stdout:      config.stdio.Stdout,</div><div class="line">		Stderr:      config.stdio.Stderr,</div><div class="line">		RuntimeArgs: config.c.runtimeArgs,</div><div class="line">		NoPivotRoot: config.c.noPivotRoot,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***写入process.json***//</span></div><div class="line">	<span class="keyword">if</span> err := json.NewEncoder(f).Encode(ps); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***ExitFile = "exit"***//</span></div><div class="line">	exit, err := getExitPipe(filepath.Join(config.root, ExitFile))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***ControlFile = "control"***//</span></div><div class="line">	control, err := getControlPipe(filepath.Join(config.root, ControlFile))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	p.exitPipe = exit</div><div class="line">	p.controlPipe = control</div><div class="line">	<span class="keyword">return</span> p, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="loadProcess"><a href="#loadProcess" class="headerlink" title="loadProcess()"></a>loadProcess()</h3><p>loadProcess()读取process.json，并还原成process。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从process.json中还原process***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadProcess</span><span class="params">(root, id <span class="keyword">string</span>, c *container, s *ProcessState)</span> <span class="params">(*process, error)</span></span> &#123;</div><div class="line">	p := &amp;process&#123;</div><div class="line">		root:      root,</div><div class="line">		id:        id,</div><div class="line">		container: c,</div><div class="line">		spec:      s.ProcessSpec,</div><div class="line">		stdio: Stdio&#123;</div><div class="line">			Stdin:  s.Stdin,</div><div class="line">			Stdout: s.Stdout,</div><div class="line">			Stderr: s.Stderr,</div><div class="line">		&#125;,</div><div class="line">		state: Stopped,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	startTime, err := ioutil.ReadFile(filepath.Join(p.root, StartTimeFile))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; !os.IsNotExist(err) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	p.startTime = <span class="keyword">string</span>(startTime)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> _, err := p.getPidFromFile(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> _, err := p.ExitStatus(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> err == ErrProcessNotExited &#123;</div><div class="line">			exit, err := getExitPipe(filepath.Join(root, ExitFile))</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125;</div><div class="line">			p.exitPipe = exit</div><div class="line"></div><div class="line">			control, err := getControlPipe(filepath.Join(root, ControlFile))</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125;</div><div class="line">			p.controlPipe = control</div><div class="line"></div><div class="line">			p.state = Running</div><div class="line">			<span class="keyword">return</span> p, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> p, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="readProcStatField"><a href="#readProcStatField" class="headerlink" title="readProcStatField()"></a>readProcStatField()</h3><p>readProcStatField()从/proc/pid/stat中读取指定信息。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从/proc/9947/stat中提取指定字段***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">readProcStatField</span><span class="params">(pid <span class="keyword">int</span>, field <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	<span class="comment">//***/proc/9947/stat***//</span></div><div class="line">	data, err := ioutil.ReadFile(filepath.Join(<span class="keyword">string</span>(filepath.Separator), <span class="string">"proc"</span>, strconv.Itoa(pid), <span class="string">"stat"</span>))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> field &gt; <span class="number">2</span> &#123;</div><div class="line">		<span class="comment">// First, split out the name since he could contains spaces.</span></div><div class="line">		parts := strings.Split(<span class="keyword">string</span>(data), <span class="string">") "</span>)</div><div class="line">		<span class="comment">// Now split out the rest, we end up with 2 fields less</span></div><div class="line">		parts = strings.Split(parts[<span class="number">1</span>], <span class="string">" "</span>)</div><div class="line">		<span class="keyword">return</span> parts[field<span class="number">-2</span><span class="number">-1</span>], <span class="literal">nil</span> <span class="comment">// field count start at 1 in manual</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	parts := strings.Split(<span class="keyword">string</span>(data), <span class="string">" ("</span>)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> field == <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">return</span> parts[<span class="number">0</span>], <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	parts = strings.Split(parts[<span class="number">1</span>], <span class="string">") "</span>)</div><div class="line">	<span class="keyword">return</span> parts[<span class="number">0</span>], <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="readStartTime"><a href="#readStartTime" class="headerlink" title="readStartTime()"></a>readStartTime()</h3><p>readStartTime()从系统中读取指定进程的启动时间。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从/proc/9947/stat中读取启动时间***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *process)</span> <span class="title">readStartTime</span><span class="params">()</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> readProcStatField(p.pid, <span class="number">22</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="isSameProcess"><a href="#isSameProcess" class="headerlink" title="isSameProcess()"></a>isSameProcess()</h3><p>isSameProcess()从内存process中读取启动时间，再从系统中获取进程的启动时间(如果系统中的进程不存在，则启动时间为空)，然后比较两个启动时间，如果一致，则说明系统中还有进程在运行。shim退出时可以用isSameProcess()来判断系统中是否进程残留。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***比较启动时间查看process是否为同一个***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *process)</span> <span class="title">isSameProcess</span><span class="params">()</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</div><div class="line">	<span class="comment">// for backward compat assume it's the same if startTime wasn't set</span></div><div class="line">	<span class="keyword">if</span> p.startTime == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> p.pid == <span class="number">0</span> &#123;</div><div class="line">		_, err := p.getPidFromFile()</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span>, err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	startTime, err := p.readStartTime()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> startTime == p.startTime, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Signal"><a href="#Signal" class="headerlink" title="Signal()"></a>Signal()</h3><p>Signal()可以向process发送信号。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***向process发送信号***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *process)</span> <span class="title">Signal</span><span class="params">(s os.Signal)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> syscall.Kill(p.pid, s.(syscall.Signal))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Start-1"><a href="#Start-1" class="headerlink" title="Start()"></a>Start()</h3><p>Start()会调用<code>runc start id</code>来启动一个容器。<br>container的Start()最终调用的是<code>runc create</code>(通过shim调用)。而<code>runc create</code>和<code>runc start</code>两个命令都会完成容器的启动。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *process)</span> <span class="title">Start</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> p.ID() == InitProcessID &#123;</div><div class="line">		<span class="keyword">var</span> (</div><div class="line">			errC = <span class="built_in">make</span>(<span class="keyword">chan</span> error, <span class="number">1</span>)</div><div class="line">			args = <span class="built_in">append</span>(p.container.runtimeArgs, <span class="string">"start"</span>, p.container.id)</div><div class="line">			cmd  = exec.Command(p.container.runtime, args...)</div><div class="line">		)</div><div class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">			out, err := cmd.CombinedOutput()</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				errC &lt;- fmt.Errorf(<span class="string">"%s: %q"</span>, err.Error(), out)</div><div class="line">			&#125;</div><div class="line">			<span class="comment">//***runc start执行成功，向errC发送nil***//</span></div><div class="line">			errC &lt;- <span class="literal">nil</span></div><div class="line">		&#125;()</div><div class="line">		<span class="comment">//***如果errC或cmdDoneCh***//</span></div><div class="line">		<span class="keyword">select</span> &#123;</div><div class="line">		<span class="keyword">case</span> err := &lt;-errC:</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">			<span class="comment">//***如果cmdDoneCh被Close()，则此处可以捕获到***//</span></div><div class="line">		<span class="keyword">case</span> &lt;-p.cmdDoneCh:</div><div class="line">			<span class="keyword">if</span> !p.cmdSuccess &#123;</div><div class="line">				<span class="keyword">if</span> cmd.Process != <span class="literal">nil</span> &#123;</div><div class="line">					cmd.Process.Kill()</div><div class="line">				&#125;</div><div class="line">				cmd.Wait()</div><div class="line">				<span class="keyword">return</span> ErrShimExited</div><div class="line">			&#125;</div><div class="line">			err := &lt;-errC</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Container对应的是容器，Process对应的是容器中的进程。Container的Start()和Exec()会调用containerd-shim，containerd-shim一般是个常驻进程，Container在containerd-shim退出时需要做清理工作。如果containerd-shim已经退出，但process还在执行，那么通过container会关闭cmdDoneCh以通知进程退出。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/11/19/containerd-container和process-v0-2-4/" data-id="cjbadwn8c003cagqsd6tdffgr" class="article-share-link">分享</a><div class="tags"><a href="/tags/containerd/">containerd</a><a href="/tags/containerd-v0-2-4/">containerd-v0.2.4</a></div><div class="post-nav"><a href="/2017/11/19/containerd-shim源码分析-v0-2-4/" class="pre">containerd-shim源码分析-v0.2.4</a><a href="/2017/11/16/containerd执行流程分析-v0-2-4/" class="next">containerd执行流程分析-v0.2.4</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(三)-volumeManager-v1-5-2/">kubelet分析(三)-volumeManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/kubelet分析(二)-podWorker-v1-5-2/">kubelet分析(二)-podWorker-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/kubelet分析(一)-config-v1-5-2/">kubelet分析(一)-config-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/15/storage解读(六)-strategy-v1-5-2/">storage解读(六)-strategy-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/14/kubernetes-listwatch机制-v1-5-2/">kubernetes-listwatch机制-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/kubernetes-添加controller-demo-v1-5-2/">kubernetes-添加controller-demo-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/kubernetes-添加资源-demo-v1-5-2/">kubernetes-添加资源-demo-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/04/libnetwork源码分析(二)-network-v1-12-3/">libnetwork源码分析(二)-network-v1-12-3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/03/libnetwork源码分析(一)-controller(5)-v1-12-3/">libnetwork源码分析(一)-controller(5)-v1-12-3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/03/libnetwork源码分析(一)-controller(4)-v1-12-3/">libnetwork源码分析(一)-controller(4)-v1-12-3</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>