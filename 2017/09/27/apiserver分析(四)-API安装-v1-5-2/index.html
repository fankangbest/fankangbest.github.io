<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>apiserver分析(四)-API安装-v1.5.2 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">apiserver分析(四)-API安装-v1.5.2</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">apiserver分析(四)-API安装-v1.5.2</h1><div class="post-meta">Sep 27, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>我们都知道，在Kubernetes中，Apiserver提供了API访问服务。那么API是什么时候注册到Apiserver中的呢？本次分析，将会介绍这些内容。</p>
<h2 id="emicklei-go-restful"><a href="#emicklei-go-restful" class="headerlink" title="emicklei/go-restful"></a>emicklei/go-restful</h2><p>Kubernetes使用emicklei/go-restful包提供RESTful API服务。所以有必要先来了解下emicklei/go-restful是如何使用的。</p>
<ol>
<li>创建container</li>
<li>创建ws</li>
<li>生成route，即ws.GET(“/hello”).To(hello)</li>
<li>ws.Route(route)</li>
<li>container.Add(ws)</li>
<li>http.Server{}</li>
</ol>
<p>即如下代码形式：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">container := restful.NewContainer()</div><div class="line">ws := <span class="built_in">new</span>(restful.WebService)</div><div class="line">ws.Route(ws.GET(<span class="string">"/hello"</span>).To(hello))</div><div class="line">container.Add(ws)</div><div class="line">server := &amp;http.Server&#123;Addr: <span class="string">":8081"</span>, Handler: container&#125;</div><div class="line">log.Fatal(server.ListenAndServe())</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span><span class="params">(req *restful.Request, resp *restful.Response)</span></span> &#123;</div><div class="line">    io.WriteString(resp, <span class="string">"default world"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="container的生成"><a href="#container的生成" class="headerlink" title="container的生成"></a>container的生成</h2><p>所以，我们第一件事就是寻找在哪生成的container。container的生成函数定义在/pkg/genericapiserver/mux/container.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// APIContainer is a restful container which in addition support registering</span></div><div class="line"><span class="comment">// handlers that do not show up in swagger or in /</span></div><div class="line"><span class="keyword">type</span> APIContainer <span class="keyword">struct</span> &#123;</div><div class="line">	*restful.Container</div><div class="line">	NonSwaggerRoutes PathRecorderMux</div><div class="line">	SecretRoutes     Mux</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NewAPIContainer constructs a new container for APIs</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAPIContainer</span><span class="params">(mux *http.ServeMux, s runtime.NegotiatedSerializer)</span> *<span class="title">APIContainer</span></span> &#123;</div><div class="line">	c := APIContainer&#123;</div><div class="line">		Container: restful.NewContainer(),</div><div class="line">		NonSwaggerRoutes: PathRecorderMux&#123;</div><div class="line">			mux: mux,</div><div class="line">		&#125;,</div><div class="line">		SecretRoutes: mux,</div><div class="line">	&#125;</div><div class="line">	c.Container.ServeMux = mux</div><div class="line">	c.Container.Router(restful.CurlyRouter&#123;&#125;) <span class="comment">// e.g. for proxy/&#123;kind&#125;/&#123;name&#125;/&#123;*&#125;</span></div><div class="line"></div><div class="line">	apiserver.InstallRecoverHandler(s, c.Container)</div><div class="line">	apiserver.InstallServiceErrorHandler(s, c.Container)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;c</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>container.go中的APIContainer内嵌了restful.Container。那么是哪调用了NewAPIContainer呢？是在/pkg/genericapiserver/config.go的completedConfig结构体的New()中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***生成GenericAPIServer***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span> <span class="title">New</span><span class="params">()</span> <span class="params">(*GenericAPIServer, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> c.Serializer == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"Genericapiserver.New() called with config.Serializer == nil"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	s := &amp;GenericAPIServer&#123;</div><div class="line">		discoveryAddresses:     c.DiscoveryAddresses,</div><div class="line">		LoopbackClientConfig:   c.LoopbackClientConfig,</div><div class="line">		legacyAPIGroupPrefixes: c.LegacyAPIGroupPrefixes,</div><div class="line">		admissionControl:       c.AdmissionControl,</div><div class="line">		requestContextMapper:   c.RequestContextMapper,</div><div class="line">		Serializer:             c.Serializer,</div><div class="line"></div><div class="line">		minRequestTimeout:    time.Duration(c.MinRequestTimeout) * time.Second,</div><div class="line">		enableSwaggerSupport: c.EnableSwaggerSupport,</div><div class="line"></div><div class="line">		SecureServingInfo:   c.SecureServingInfo,</div><div class="line">		InsecureServingInfo: c.InsecureServingInfo,</div><div class="line">		ExternalAddress:     c.ExternalAddress,</div><div class="line"></div><div class="line">		apiGroupsForDiscovery: <span class="keyword">map</span>[<span class="keyword">string</span>]unversioned.APIGroup&#123;&#125;,</div><div class="line"></div><div class="line">		enableOpenAPISupport: c.EnableOpenAPISupport,</div><div class="line">		openAPIConfig:        c.OpenAPIConfig,</div><div class="line"></div><div class="line">		postStartHooks: <span class="keyword">map</span>[<span class="keyword">string</span>]postStartHookEntry&#123;&#125;,</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***生成restful的container***//</span></div><div class="line">	s.HandlerContainer = mux.NewAPIContainer(http.NewServeMux(), c.Serializer)</div><div class="line"></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***安装特殊功能的路径***//</span></div><div class="line">	s.installAPI(c.Config)</div><div class="line"></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***调用BuildHandlerChainsFunc()生成Handler***//</span></div><div class="line">	<span class="comment">//***把HandlerContainer进一步封装，以进行认证，授权等动作***//</span></div><div class="line">	s.Handler, s.InsecureHandler = c.BuildHandlerChainsFunc(s.HandlerContainer.ServeMux, c.Config)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> s, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以container对应的就是GenericAPIServer的HandlerContainer字段。</p>
<h2 id="API安装入口"><a href="#API安装入口" class="headerlink" title="API安装入口"></a>API安装入口</h2><p>我们接着往下分析。先来看API安装入口，即/pkg/master/master.go中completedConfig的New()方法：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从config中生成master***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span> <span class="title">New</span><span class="params">()</span> <span class="params">(*Master, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> reflect.DeepEqual(c.KubeletClientConfig, kubeletclient.KubeletClientConfig&#123;&#125;) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"Master.New() called with empty config.KubeletClientConfig"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***通过generic config生成GenericAPIServer***//</span></div><div class="line">	s, err := c.Config.GenericConfig.SkipComplete().New() <span class="comment">// completion is done in Complete, no need for a second time</span></div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***UI redirect功能***//</span></div><div class="line">	<span class="keyword">if</span> c.EnableUISupport &#123;</div><div class="line">		routes.UIRedirect&#123;&#125;.Install(s.HandlerContainer)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***log相关***//</span></div><div class="line">	<span class="keyword">if</span> c.EnableLogsSupport &#123;</div><div class="line">		routes.Logs&#123;&#125;.Install(s.HandlerContainer)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	m := &amp;Master&#123;</div><div class="line">		GenericAPIServer: s,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***生成restOptionsFactory***//</span></div><div class="line">	restOptionsFactory := restOptionsFactory&#123;</div><div class="line">		deleteCollectionWorkers: c.DeleteCollectionWorkers,</div><div class="line">		enableGarbageCollection: c.GenericConfig.EnableGarbageCollection,</div><div class="line">		storageFactory:          c.StorageFactory,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***赋值storageDecorator***//</span></div><div class="line">	<span class="keyword">if</span> c.EnableWatchCache &#123;</div><div class="line">		restOptionsFactory.storageDecorator = registry.StorageWithCacher</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		restOptionsFactory.storageDecorator = generic.UndecoratedStorage</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// install legacy rest storage</span></div><div class="line">	<span class="keyword">if</span> c.GenericConfig.APIResourceConfigSource.AnyResourcesForVersionEnabled(apiv1.SchemeGroupVersion) &#123;</div><div class="line">		legacyRESTStorageProvider := corerest.LegacyRESTStorageProvider&#123;</div><div class="line">			StorageFactory:       c.StorageFactory,</div><div class="line">			ProxyTransport:       c.ProxyTransport,</div><div class="line">			KubeletClientConfig:  c.KubeletClientConfig,</div><div class="line">			EventTTL:             c.EventTTL,</div><div class="line">			ServiceIPRange:       c.ServiceIPRange,</div><div class="line">			ServiceNodePortRange: c.ServiceNodePortRange,</div><div class="line">			LoopbackClientConfig: c.GenericConfig.LoopbackClientConfig,</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***调用InstallLegacyAPI()***//</span></div><div class="line">		m.InstallLegacyAPI(c.Config, restOptionsFactory.NewFor, legacyRESTStorageProvider)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***构造restStorageProvider数组***//</span></div><div class="line">	restStorageProviders := []genericapiserver.RESTStorageProvider&#123;</div><div class="line">		appsrest.RESTStorageProvider&#123;&#125;,</div><div class="line">		authenticationrest.RESTStorageProvider&#123;Authenticator: c.GenericConfig.Authenticator&#125;,</div><div class="line">		authorizationrest.RESTStorageProvider&#123;Authorizer: c.GenericConfig.Authorizer&#125;,</div><div class="line">		autoscalingrest.RESTStorageProvider&#123;&#125;,</div><div class="line">		batchrest.RESTStorageProvider&#123;&#125;,</div><div class="line">		certificatesrest.RESTStorageProvider&#123;&#125;,</div><div class="line">		<span class="comment">//***extension包***//</span></div><div class="line">		extensionsrest.RESTStorageProvider&#123;ResourceInterface: thirdparty.NewThirdPartyResourceServer(s, c.StorageFactory)&#125;,</div><div class="line">		policyrest.RESTStorageProvider&#123;&#125;,</div><div class="line">		rbacrest.RESTStorageProvider&#123;AuthorizerRBACSuperUser: c.GenericConfig.AuthorizerRBACSuperUser&#125;,</div><div class="line">		storagerest.RESTStorageProvider&#123;&#125;,</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***调用InstallAPIs()***//</span></div><div class="line">	m.InstallAPIs(c.Config.GenericConfig.APIResourceConfigSource, restOptionsFactory.NewFor, restStorageProviders...)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> c.Tunneler != <span class="literal">nil</span> &#123;</div><div class="line">		m.installTunneler(c.Tunneler, coreclient.NewForConfigOrDie(c.GenericConfig.LoopbackClientConfig).Nodes())</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> m, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，New()方法调用了InstallLegacyAPI()和InstallAPIs()安装API。</p>
<h2 id="InstallLegacyAPI"><a href="#InstallLegacyAPI" class="headerlink" title="InstallLegacyAPI()"></a>InstallLegacyAPI()</h2><p>InstallLegacyAPI()就是安装Kubernetes一些传统核心的API，定义在/pkg/master/master.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Master)</span> <span class="title">InstallLegacyAPI</span><span class="params">(c *Config, restOptionsGetter genericapiserver.RESTOptionsGetter, legacyRESTStorageProvider corerest.LegacyRESTStorageProvider)</span></span> &#123;</div><div class="line">	<span class="comment">//***调用LegacyRESTStorageProvider()，定义在/pkg/registry/core/rest/storage_core.go中***//</span></div><div class="line">	legacyRESTStorage, apiGroupInfo, err := legacyRESTStorageProvider.NewLegacyRESTStorage(restOptionsGetter)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.Fatalf(<span class="string">"Error building core storage: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> c.EnableCoreControllers &#123;</div><div class="line">		serviceClient := coreclient.NewForConfigOrDie(c.GenericConfig.LoopbackClientConfig)</div><div class="line">		bootstrapController := c.NewBootstrapController(legacyRESTStorage, serviceClient)</div><div class="line">		<span class="keyword">if</span> err := m.GenericAPIServer.AddPostStartHook(<span class="string">"bootstrap-controller"</span>, bootstrapController.PostStartHook); err != <span class="literal">nil</span> &#123;</div><div class="line">			glog.Fatalf(<span class="string">"Error registering PostStartHook %q: %v"</span>, <span class="string">"bootstrap-controller"</span>, err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***安装legacyRESTStorage***//</span></div><div class="line">	<span class="comment">//***DefaultLegacyAPIPrefix = "/api"***//</span></div><div class="line">	<span class="keyword">if</span> err := m.GenericAPIServer.InstallLegacyAPIGroup(genericapiserver.DefaultLegacyAPIPrefix, &amp;apiGroupInfo); err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.Fatalf(<span class="string">"Error in registering group versions: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>InstallLegacyAPI()先通过NewLegacyRESTStorage()生成apiGroupInfo，然后通过GenericAPIServer的InstallLegacyAPIGroup()安装apiGroupInfo。关于apiGroupInfo及InstallLegacyAPIGroup()，稍后介绍。</p>
<p> NewLegacyRESTStorage()定义在/pkg/registry/core/rest/storage_core.go中：<br> <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c LegacyRESTStorageProvider)</span> <span class="title">NewLegacyRESTStorage</span><span class="params">(restOptionsGetter genericapiserver.RESTOptionsGetter)</span> <span class="params">(LegacyRESTStorage, genericapiserver.APIGroupInfo, error)</span></span> &#123;</div><div class="line">	<span class="comment">//***构造APIGroupInfo***//</span></div><div class="line">	apiGroupInfo := genericapiserver.APIGroupInfo&#123;</div><div class="line">		<span class="comment">//***从registered中取出GroupName对应的GroupMeta***//</span></div><div class="line">		GroupMeta:                    *registered.GroupOrDie(api.GroupName),</div><div class="line">		VersionedResourcesStorageMap: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">string</span>]rest.Storage&#123;&#125;,</div><div class="line">		Scheme:                      api.Scheme,</div><div class="line">		ParameterCodec:              api.ParameterCodec,</div><div class="line">		NegotiatedSerializer:        api.Codecs,</div><div class="line">		SubresourceGroupVersionKind: <span class="keyword">map</span>[<span class="keyword">string</span>]unversioned.GroupVersionKind&#123;&#125;,</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> autoscalingGroupVersion := (unversioned.GroupVersion&#123;Group: <span class="string">"autoscaling"</span>, Version: <span class="string">"v1"</span>&#125;); registered.IsEnabledVersion(autoscalingGroupVersion) &#123;</div><div class="line">		apiGroupInfo.SubresourceGroupVersionKind[<span class="string">"replicationcontrollers/scale"</span>] = autoscalingGroupVersion.WithKind(<span class="string">"Scale"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> podDisruptionClient policyclient.PodDisruptionBudgetsGetter</div><div class="line">	<span class="keyword">if</span> policyGroupVersion := (unversioned.GroupVersion&#123;Group: <span class="string">"policy"</span>, Version: <span class="string">"v1beta1"</span>&#125;); registered.IsEnabledVersion(policyGroupVersion) &#123;</div><div class="line">		apiGroupInfo.SubresourceGroupVersionKind[<span class="string">"pods/eviction"</span>] = policyGroupVersion.WithKind(<span class="string">"Eviction"</span>)</div><div class="line"></div><div class="line">		<span class="keyword">var</span> err error</div><div class="line">		podDisruptionClient, err = policyclient.NewForConfig(c.LoopbackClientConfig)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> LegacyRESTStorage&#123;&#125;, genericapiserver.APIGroupInfo&#123;&#125;, err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	restStorage := LegacyRESTStorage&#123;&#125;</div><div class="line"></div><div class="line">	podTemplateStorage := podtemplateetcd.NewREST(restOptionsGetter(api.Resource(<span class="string">"podTemplates"</span>)))</div><div class="line"></div><div class="line">	eventStorage := eventetcd.NewREST(restOptionsGetter(api.Resource(<span class="string">"events"</span>)), <span class="keyword">uint64</span>(c.EventTTL.Seconds()))</div><div class="line">	limitRangeStorage := limitrangeetcd.NewREST(restOptionsGetter(api.Resource(<span class="string">"limitRanges"</span>)))</div><div class="line"></div><div class="line">	resourceQuotaStorage, resourceQuotaStatusStorage := resourcequotaetcd.NewREST(restOptionsGetter(api.Resource(<span class="string">"resourceQuotas"</span>)))</div><div class="line">	secretStorage := secretetcd.NewREST(restOptionsGetter(api.Resource(<span class="string">"secrets"</span>)))</div><div class="line">	serviceAccountStorage := serviceaccountetcd.NewREST(restOptionsGetter(api.Resource(<span class="string">"serviceAccounts"</span>)))</div><div class="line">	persistentVolumeStorage, persistentVolumeStatusStorage := pvetcd.NewREST(restOptionsGetter(api.Resource(<span class="string">"persistentVolumes"</span>)))</div><div class="line">	persistentVolumeClaimStorage, persistentVolumeClaimStatusStorage := pvcetcd.NewREST(restOptionsGetter(api.Resource(<span class="string">"persistentVolumeClaims"</span>)))</div><div class="line">	configMapStorage := configmapetcd.NewREST(restOptionsGetter(api.Resource(<span class="string">"configMaps"</span>)))</div><div class="line"></div><div class="line">	namespaceStorage, namespaceStatusStorage, namespaceFinalizeStorage := namespaceetcd.NewREST(restOptionsGetter(api.Resource(<span class="string">"namespaces"</span>)))</div><div class="line">	restStorage.NamespaceRegistry = namespace.NewRegistry(namespaceStorage)</div><div class="line"></div><div class="line">	endpointsStorage := endpointsetcd.NewREST(restOptionsGetter(api.Resource(<span class="string">"endpoints"</span>)))</div><div class="line">	restStorage.EndpointRegistry = endpoint.NewRegistry(endpointsStorage)</div><div class="line"></div><div class="line">	<span class="comment">//***创建nodeStorage***//</span></div><div class="line">	<span class="comment">//***restOptionsGetter实际为/pkg/master/master.go中的restOptionsFactory类的NewFor()***//</span></div><div class="line">	<span class="comment">//***api.Resource()定义在/pkg/api/registry.go中***//</span></div><div class="line">	nodeStorage, err := nodeetcd.NewStorage(restOptionsGetter(api.Resource(<span class="string">"nodes"</span>)), c.KubeletClientConfig, c.ProxyTransport)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> LegacyRESTStorage&#123;&#125;, genericapiserver.APIGroupInfo&#123;&#125;, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***创建NodeRegistry***//</span></div><div class="line">	<span class="comment">//***从这可知，nodeStorage.Node即NodeRegistry中的storage***//</span></div><div class="line">	restStorage.NodeRegistry = node.NewRegistry(nodeStorage.Node)</div><div class="line"></div><div class="line">	podStorage := podetcd.NewStorage(</div><div class="line">		restOptionsGetter(api.Resource(<span class="string">"pods"</span>)),</div><div class="line">		nodeStorage.KubeletConnectionInfo,</div><div class="line">		c.ProxyTransport,</div><div class="line">		podDisruptionClient,</div><div class="line">	)</div><div class="line"></div><div class="line">	serviceRESTStorage, serviceStatusStorage := serviceetcd.NewREST(restOptionsGetter(api.Resource(<span class="string">"services"</span>)))</div><div class="line">	restStorage.ServiceRegistry = service.NewRegistry(serviceRESTStorage)</div><div class="line"></div><div class="line">	<span class="keyword">var</span> serviceClusterIPRegistry rangeallocation.RangeRegistry</div><div class="line">	serviceClusterIPRange := c.ServiceIPRange</div><div class="line">	<span class="keyword">if</span> serviceClusterIPRange.IP == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> LegacyRESTStorage&#123;&#125;, genericapiserver.APIGroupInfo&#123;&#125;, fmt.Errorf(<span class="string">"service clusterIPRange is missing"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	serviceStorageConfig, err := c.StorageFactory.NewConfig(api.Resource(<span class="string">"services"</span>))</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> LegacyRESTStorage&#123;&#125;, genericapiserver.APIGroupInfo&#123;&#125;, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ServiceClusterIPAllocator := ipallocator.NewAllocatorCIDRRange(&amp;serviceClusterIPRange, <span class="function"><span class="keyword">func</span><span class="params">(max <span class="keyword">int</span>, rangeSpec <span class="keyword">string</span>)</span> <span class="title">allocator</span>.<span class="title">Interface</span></span> &#123;</div><div class="line">		mem := allocator.NewAllocationMap(max, rangeSpec)</div><div class="line">		<span class="comment">// TODO etcdallocator package to return a storage interface via the storageFactory</span></div><div class="line">		etcd := etcdallocator.NewEtcd(mem, <span class="string">"/ranges/serviceips"</span>, api.Resource(<span class="string">"serviceipallocations"</span>), serviceStorageConfig)</div><div class="line">		serviceClusterIPRegistry = etcd</div><div class="line">		<span class="keyword">return</span> etcd</div><div class="line">	&#125;)</div><div class="line">	restStorage.ServiceClusterIPAllocator = serviceClusterIPRegistry</div><div class="line"></div><div class="line">	<span class="keyword">var</span> serviceNodePortRegistry rangeallocation.RangeRegistry</div><div class="line">	ServiceNodePortAllocator := portallocator.NewPortAllocatorCustom(c.ServiceNodePortRange, <span class="function"><span class="keyword">func</span><span class="params">(max <span class="keyword">int</span>, rangeSpec <span class="keyword">string</span>)</span> <span class="title">allocator</span>.<span class="title">Interface</span></span> &#123;</div><div class="line">		mem := allocator.NewAllocationMap(max, rangeSpec)</div><div class="line">		<span class="comment">// TODO etcdallocator package to return a storage interface via the storageFactory</span></div><div class="line">		etcd := etcdallocator.NewEtcd(mem, <span class="string">"/ranges/servicenodeports"</span>, api.Resource(<span class="string">"servicenodeportallocations"</span>), serviceStorageConfig)</div><div class="line">		serviceNodePortRegistry = etcd</div><div class="line">		<span class="keyword">return</span> etcd</div><div class="line">	&#125;)</div><div class="line">	restStorage.ServiceNodePortAllocator = serviceNodePortRegistry</div><div class="line"></div><div class="line">	controllerStorage := controlleretcd.NewStorage(restOptionsGetter(api.Resource(<span class="string">"replicationControllers"</span>)))</div><div class="line"></div><div class="line">	serviceRest := service.NewStorage(restStorage.ServiceRegistry, restStorage.EndpointRegistry, ServiceClusterIPAllocator, ServiceNodePortAllocator, c.ProxyTransport)</div><div class="line"></div><div class="line">	<span class="comment">//***构造restStorageMap***//</span></div><div class="line">	<span class="comment">//***restStorageMap中记录了路径和storage的映射关系***//</span></div><div class="line">	restStorageMap := <span class="keyword">map</span>[<span class="keyword">string</span>]rest.Storage&#123;</div><div class="line">		<span class="string">"pods"</span>:             podStorage.Pod,</div><div class="line">		<span class="string">"pods/attach"</span>:      podStorage.Attach,</div><div class="line">		<span class="string">"pods/status"</span>:      podStorage.Status,</div><div class="line">		<span class="string">"pods/log"</span>:         podStorage.Log,</div><div class="line">		<span class="string">"pods/exec"</span>:        podStorage.Exec,</div><div class="line">		<span class="string">"pods/portforward"</span>: podStorage.PortForward,</div><div class="line">		<span class="string">"pods/proxy"</span>:       podStorage.Proxy,</div><div class="line">		<span class="string">"pods/binding"</span>:     podStorage.Binding,</div><div class="line">		<span class="string">"bindings"</span>:         podStorage.Binding,</div><div class="line"></div><div class="line">		<span class="string">"podTemplates"</span>: podTemplateStorage,</div><div class="line"></div><div class="line">		<span class="string">"replicationControllers"</span>:        controllerStorage.Controller,</div><div class="line">		<span class="string">"replicationControllers/status"</span>: controllerStorage.Status,</div><div class="line"></div><div class="line">		<span class="string">"services"</span>:        serviceRest.Service,</div><div class="line">		<span class="string">"services/proxy"</span>:  serviceRest.Proxy,</div><div class="line">		<span class="string">"services/status"</span>: serviceStatusStorage,</div><div class="line"></div><div class="line">		<span class="string">"endpoints"</span>: endpointsStorage,</div><div class="line"></div><div class="line">		<span class="string">"nodes"</span>:        nodeStorage.Node,</div><div class="line">		<span class="string">"nodes/status"</span>: nodeStorage.Status,</div><div class="line">		<span class="string">"nodes/proxy"</span>:  nodeStorage.Proxy,</div><div class="line"></div><div class="line">		<span class="string">"events"</span>: eventStorage,</div><div class="line"></div><div class="line">		<span class="string">"limitRanges"</span>:                   limitRangeStorage,</div><div class="line">		<span class="string">"resourceQuotas"</span>:                resourceQuotaStorage,</div><div class="line">		<span class="string">"resourceQuotas/status"</span>:         resourceQuotaStatusStorage,</div><div class="line">		<span class="string">"namespaces"</span>:                    namespaceStorage,</div><div class="line">		<span class="string">"namespaces/status"</span>:             namespaceStatusStorage,</div><div class="line">		<span class="string">"namespaces/finalize"</span>:           namespaceFinalizeStorage,</div><div class="line">		<span class="string">"secrets"</span>:                       secretStorage,</div><div class="line">		<span class="string">"serviceAccounts"</span>:               serviceAccountStorage,</div><div class="line">		<span class="string">"persistentVolumes"</span>:             persistentVolumeStorage,</div><div class="line">		<span class="string">"persistentVolumes/status"</span>:      persistentVolumeStatusStorage,</div><div class="line">		<span class="string">"persistentVolumeClaims"</span>:        persistentVolumeClaimStorage,</div><div class="line">		<span class="string">"persistentVolumeClaims/status"</span>: persistentVolumeClaimStatusStorage,</div><div class="line">		<span class="string">"configMaps"</span>:                    configMapStorage,</div><div class="line"></div><div class="line">		<span class="string">"componentStatuses"</span>: componentstatus.NewStorage(componentStatusStorage&#123;c.StorageFactory&#125;.serversToValidate),</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> registered.IsEnabledVersion(unversioned.GroupVersion&#123;Group: <span class="string">"autoscaling"</span>, Version: <span class="string">"v1"</span>&#125;) &#123;</div><div class="line">		restStorageMap[<span class="string">"replicationControllers/scale"</span>] = controllerStorage.Scale</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> registered.IsEnabledVersion(unversioned.GroupVersion&#123;Group: <span class="string">"policy"</span>, Version: <span class="string">"v1beta1"</span>&#125;) &#123;</div><div class="line">		restStorageMap[<span class="string">"pods/eviction"</span>] = podStorage.Eviction</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***生成VersionedResourcesStorageMap***//</span></div><div class="line">	<span class="comment">//***VersionResourcesStorageMap中记录了版本和restStorageMap的映射关系***//</span></div><div class="line">	apiGroupInfo.VersionedResourcesStorageMap[<span class="string">"v1"</span>] = restStorageMap</div><div class="line"></div><div class="line">	<span class="keyword">return</span> restStorage, apiGroupInfo, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="InstallAPIs"><a href="#InstallAPIs" class="headerlink" title="InstallAPIs()"></a>InstallAPIs()</h2><p>InstallAPIs()是用来安装第三方api的。包含：apps/v1beta1, authentication.k8s.io/v1beta1, authorization.k8s.io/v1beta1, autoscaling/v1, batch/v1, certificates.k8s.io/v1alpha1, extensions/v1beta1, policy/v1beta1, rbac.authorization.k8s.io/v1alpha1, storage.k8s.io/v1beta1, apps/v1beta1。<br>InstallAPIs()定义在/pkg/master/master.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// InstallAPIs will install the APIs for the restStorageProviders if they are enabled.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Master)</span> <span class="title">InstallAPIs</span><span class="params">(apiResourceConfigSource genericapiserver.APIResourceConfigSource, restOptionsGetter genericapiserver.RESTOptionsGetter, restStorageProviders ...genericapiserver.RESTStorageProvider)</span></span> &#123;</div><div class="line">	apiGroupsInfo := []genericapiserver.APIGroupInfo&#123;&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, restStorageBuilder := <span class="keyword">range</span> restStorageProviders &#123;</div><div class="line">		groupName := restStorageBuilder.GroupName()</div><div class="line">		<span class="keyword">if</span> !apiResourceConfigSource.AnyResourcesForGroupEnabled(groupName) &#123;</div><div class="line">			glog.V(<span class="number">1</span>).Infof(<span class="string">"Skipping disabled API group %q."</span>, groupName)</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***此处调用NewRESTStorage()生成apiGroupInfo***//</span></div><div class="line">		<span class="comment">//***apiGroupInfo主要包含apps/v1beta1, authentication.k8s.io/v1beta1, authorization.k8s.io/v1beta1***//</span></div><div class="line">		<span class="comment">//***autoscaling/v1, batch/v1, certificates.k8s.io/v1alpha1, extensions/v1beta1, policy/v1beta1***//</span></div><div class="line">		<span class="comment">//***rbac.authorization.k8s.io/v1alpha1, storage.k8s.io/v1beta1, apps/v1beta1***//</span></div><div class="line">		apiGroupInfo, enabled := restStorageBuilder.NewRESTStorage(apiResourceConfigSource, restOptionsGetter)</div><div class="line">		<span class="keyword">if</span> !enabled &#123;</div><div class="line">			glog.Warningf(<span class="string">"Problem initializing API group %q, skipping."</span>, groupName)</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		glog.V(<span class="number">1</span>).Infof(<span class="string">"Enabling API group %q."</span>, groupName)</div><div class="line"></div><div class="line">		<span class="keyword">if</span> postHookProvider, ok := restStorageBuilder.(genericapiserver.PostStartHookProvider); ok &#123;</div><div class="line">			name, hook, err := postHookProvider.PostStartHook()</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				glog.Fatalf(<span class="string">"Error building PostStartHook: %v"</span>, err)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> err := m.GenericAPIServer.AddPostStartHook(name, hook); err != <span class="literal">nil</span> &#123;</div><div class="line">				glog.Fatalf(<span class="string">"Error registering PostStartHook %q: %v"</span>, name, err)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		apiGroupsInfo = <span class="built_in">append</span>(apiGroupsInfo, apiGroupInfo)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> apiGroupsInfo &#123;</div><div class="line">		<span class="comment">//***安装路由入口***//</span></div><div class="line">		<span class="comment">//***&#123;&#123;policy/v1beta1 [policy/v1beta1] &lt;nil&gt; &#123;&#125; DefaultRESTMapper......***//</span></div><div class="line">		<span class="keyword">if</span> err := m.GenericAPIServer.InstallAPIGroup(&amp;apiGroupsInfo[i]); err != <span class="literal">nil</span> &#123;</div><div class="line">			glog.Fatalf(<span class="string">"Error in registering group versions: %v"</span>, err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出InstallAPIs()是通过NewRESTStorage()来生成apiGroupInfo，然后通过GenericAPIServer.InstallAPIGroup()安装apiGroupInfo。来看NewRESTStorage()，以/pkg/registry/rbac/rest/storage_rbac.go为例：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p RESTStorageProvider)</span> <span class="title">NewRESTStorage</span><span class="params">(apiResourceConfigSource genericapiserver.APIResourceConfigSource, restOptionsGetter genericapiserver.RESTOptionsGetter)</span> <span class="params">(genericapiserver.APIGroupInfo, <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	apiGroupInfo := genericapiserver.NewDefaultAPIGroupInfo(rbac.GroupName)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> apiResourceConfigSource.AnyResourcesForVersionEnabled(rbacapiv1alpha1.SchemeGroupVersion) &#123;</div><div class="line">		apiGroupInfo.VersionedResourcesStorageMap[rbacapiv1alpha1.SchemeGroupVersion.Version] = p.v1alpha1Storage(apiResourceConfigSource, restOptionsGetter)</div><div class="line">		apiGroupInfo.GroupMeta.GroupVersion = rbacapiv1alpha1.SchemeGroupVersion</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> apiGroupInfo, <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>NewRESTStorage()一般调用GeneticAPIServer的NewDefaultAPIGroupInfo()来生成apiGroupInfo。</p>
<p>所以来看下NewDefaultAPIGroupInfo()，定义在/pkg/genericapiserver/genericapiserver.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewDefaultAPIGroupInfo returns an APIGroupInfo stubbed with "normal" values</span></div><div class="line"><span class="comment">// exposed for easier composition from other packages</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDefaultAPIGroupInfo</span><span class="params">(group <span class="keyword">string</span>)</span> <span class="title">APIGroupInfo</span></span> &#123;</div><div class="line">	<span class="comment">//***此处使用registered模块***//</span></div><div class="line">	groupMeta := registered.GroupOrDie(group)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> APIGroupInfo&#123;</div><div class="line">		GroupMeta:                    *groupMeta,</div><div class="line">		VersionedResourcesStorageMap: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">string</span>]rest.Storage&#123;&#125;,</div><div class="line">		OptionsExternalVersion:       &amp;registered.GroupOrDie(api.GroupName).GroupVersion,</div><div class="line">		Scheme:                       api.Scheme,</div><div class="line">		ParameterCodec:               api.ParameterCodec,</div><div class="line">		NegotiatedSerializer:         api.Codecs,</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，要构造APIGroupInfo，都会从registered模块中获取到group对应的groupMeta，groupMeta包含mapper等group级别的有用信息。</p>
<h2 id="APIGroupInfo"><a href="#APIGroupInfo" class="headerlink" title="APIGroupInfo"></a>APIGroupInfo</h2><p>APIGroupInfo描述Group的相关信息及该Group下的API。APIGroupInfo定义在/pkg/genericapiserver/genericapiserver.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***网上的例子***//</span></div><div class="line"><span class="comment">//apiGroupInfo := apiserver.NeDefaultAPIGroupInfo(... Scheme)</span></div><div class="line"><span class="comment">//v11alpha1storage := map[string]rest.Storage()</span></div><div class="line"><span class="comment">//v1alpha1storage["testobj"] = NewREST()</span></div><div class="line"><span class="comment">//apiGroupInfo.VersionedResourceStorageMap["v1alpha1"] = v1alpha1storage</span></div><div class="line"><span class="comment">//GenericAPIServer.InstallAPIGroup(&amp;apiGroupInfo).Run()</span></div><div class="line"><span class="keyword">type</span> APIGroupInfo <span class="keyword">struct</span> &#123;</div><div class="line">	GroupMeta apimachinery.GroupMeta</div><div class="line">	<span class="comment">// Info about the resources in this group. Its a map from version to resource to the storage.</span></div><div class="line">	<span class="comment">//***在getAPIGroupVersion()中会把该map转化成APIGroupVersion的storage***//</span></div><div class="line">	<span class="comment">//***在/pkg/registry/core/rest/storage_core.go NewLegacyRESTStorage()中生成***//</span></div><div class="line">	VersionedResourcesStorageMap <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">string</span>]rest.Storage</div><div class="line">	<span class="comment">// OptionsExternalVersion controls the APIVersion used for common objects in the</span></div><div class="line">	<span class="comment">// schema like api.Status, api.DeleteOptions, and api.ListOptions. Other implementors may</span></div><div class="line">	<span class="comment">// define a version "v1beta1" but want to use the Kubernetes "v1" internal objects.</span></div><div class="line">	<span class="comment">// If nil, defaults to groupMeta.GroupVersion.</span></div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Remove this when https://github.com/kubernetes/kubernetes/issues/19018 is fixed.</span></div><div class="line">	OptionsExternalVersion *unversioned.GroupVersion</div><div class="line"></div><div class="line">	<span class="comment">// Scheme includes all of the types used by this group and how to convert between them (or</span></div><div class="line">	<span class="comment">// to convert objects from outside of this group that are accepted in this API).</span></div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> replace with interfaces</span></div><div class="line">	Scheme *runtime.Scheme</div><div class="line">	<span class="comment">// NegotiatedSerializer controls how this group encodes and decodes data</span></div><div class="line">	NegotiatedSerializer runtime.NegotiatedSerializer</div><div class="line">	<span class="comment">// ParameterCodec performs conversions for query parameters passed to API calls</span></div><div class="line">	ParameterCodec runtime.ParameterCodec</div><div class="line"></div><div class="line">	<span class="comment">// SubresourceGroupVersionKind contains the GroupVersionKind overrides for each subresource that is</span></div><div class="line">	<span class="comment">// accessible from this API group version. The GroupVersionKind is that of the external version of</span></div><div class="line">	<span class="comment">// the subresource. The key of this map should be the path of the subresource. The keys here should</span></div><div class="line">	<span class="comment">// match the keys in the Storage map above for subresources.</span></div><div class="line">	SubresourceGroupVersionKind <span class="keyword">map</span>[<span class="keyword">string</span>]unversioned.GroupVersionKind</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>APIGroupInfo中与API最密切的就是VersionedResourcesStorageMap字段，其第一个string表示版本，每二个string表示路径，rest.Storage表示访问对应的存储。</p>
<p>再来看下APIGroupInfo的安装函数InstallAPIGroup()，定义在/pkg/genericapiserver/genericapiserver.go中:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***对installAPIResources()的封装***//</span></div><div class="line"><span class="comment">//***该函数在master.go中有调用***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *GenericAPIServer)</span> <span class="title">InstallAPIGroup</span><span class="params">(apiGroupInfo *APIGroupInfo)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// Do not register empty group or empty version.  Doing so claims /apis/ for the wrong entity to be returned.</span></div><div class="line">	<span class="comment">// Catching these here places the error  much closer to its origin</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(apiGroupInfo.GroupMeta.GroupVersion.Group) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"cannot register handler with an empty group for %#v"</span>, *apiGroupInfo)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(apiGroupInfo.GroupMeta.GroupVersion.Version) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"cannot register handler with an empty version for %#v"</span>, *apiGroupInfo)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***APIGroupPrefix = "/apis***//</span></div><div class="line">	<span class="comment">//***调用installAPIResources()函数***//</span></div><div class="line">	<span class="keyword">if</span> err := s.installAPIResources(APIGroupPrefix, apiGroupInfo); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// setup discovery</span></div><div class="line">	<span class="comment">// Install the version handler.</span></div><div class="line">	<span class="comment">// Add a handler at /apis/&lt;groupName&gt; to enumerate all versions supported by this group.</span></div><div class="line">	apiVersionsForDiscovery := []unversioned.GroupVersionForDiscovery&#123;&#125;</div><div class="line">	<span class="keyword">for</span> _, groupVersion := <span class="keyword">range</span> apiGroupInfo.GroupMeta.GroupVersions &#123;</div><div class="line">		<span class="comment">// Check the config to make sure that we elide versions that don't have any resources</span></div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(apiGroupInfo.VersionedResourcesStorageMap[groupVersion.Version]) == <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		apiVersionsForDiscovery = <span class="built_in">append</span>(apiVersionsForDiscovery, unversioned.GroupVersionForDiscovery&#123;</div><div class="line">			GroupVersion: groupVersion.String(),</div><div class="line">			Version:      groupVersion.Version,</div><div class="line">		&#125;)</div><div class="line">	&#125;</div><div class="line">	preferedVersionForDiscovery := unversioned.GroupVersionForDiscovery&#123;</div><div class="line">		GroupVersion: apiGroupInfo.GroupMeta.GroupVersion.String(),</div><div class="line">		Version:      apiGroupInfo.GroupMeta.GroupVersion.Version,</div><div class="line">	&#125;</div><div class="line">	apiGroup := unversioned.APIGroup&#123;</div><div class="line">		Name:             apiGroupInfo.GroupMeta.GroupVersion.Group,</div><div class="line">		Versions:         apiVersionsForDiscovery,</div><div class="line">		PreferredVersion: preferedVersionForDiscovery,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	s.AddAPIGroupForDiscovery(apiGroup)</div><div class="line">	s.HandlerContainer.Add(apiserver.NewGroupWebService(s.Serializer, APIGroupPrefix+<span class="string">"/"</span>+apiGroup.Name, apiGroup))</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>InstallAPIGroup()主要调用的是installAPIResources()。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// installAPIResources is a private method for installing the REST storage backing each api groupversionresource</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *GenericAPIServer)</span> <span class="title">installAPIResources</span><span class="params">(apiPrefix <span class="keyword">string</span>, apiGroupInfo *APIGroupInfo)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, groupVersion := <span class="keyword">range</span> apiGroupInfo.GroupMeta.GroupVersions &#123;</div><div class="line">		<span class="comment">//***先构造apiGroupVersion***//</span></div><div class="line">		<span class="comment">//***可以通过apiGroupVersion的InstallREST()函数完成路由的注册***//</span></div><div class="line">		apiGroupVersion, err := s.getAPIGroupVersion(apiGroupInfo, groupVersion, apiPrefix)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> apiGroupInfo.OptionsExternalVersion != <span class="literal">nil</span> &#123;</div><div class="line">			apiGroupVersion.OptionsExternalVersion = apiGroupInfo.OptionsExternalVersion</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***APIGroupVersion定义在/pkg/apiserver/apiserver.go中***//</span></div><div class="line">		<span class="comment">//***InstallREST()会生成一个webservice，并注册好路由，最后把webservice加入到container中***//</span></div><div class="line">		<span class="keyword">if</span> err := apiGroupVersion.InstallREST(s.HandlerContainer.Container); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"Unable to setup API %v: %v"</span>, apiGroupInfo, err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，installAPIResources()会轮询GroupMeta下的GroupVersion，然后通过getAPIGroupVersion()把APIGroupInfo, groupVerison等构造成apiGroupVersion，然后使用<code>apiGroupVersion.InstallREST(s.HandlerContainer.Container)</code>注册到HandlerContainer中。</p>
<p>getAPIGroupVersion()定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***构造apiGroupVersion***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *GenericAPIServer)</span> <span class="title">getAPIGroupVersion</span><span class="params">(apiGroupInfo *APIGroupInfo, groupVersion unversioned.GroupVersion, apiPrefix <span class="keyword">string</span>)</span> <span class="params">(*apiserver.APIGroupVersion, error)</span></span> &#123;</div><div class="line">	storage := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]rest.Storage)</div><div class="line">	<span class="comment">//***FanKang***//</span></div><div class="line">	<span class="comment">//***version中的storage来自apiGroupInfo的VersionedResourcesStorageMap***//</span></div><div class="line">	<span class="comment">//***k,v: namespaces &amp;&#123;0xc420814d20 0xc420814e10&#125;***//</span></div><div class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> apiGroupInfo.VersionedResourcesStorageMap[groupVersion.Version] &#123;</div><div class="line">		storage[strings.ToLower(k)] = v</div><div class="line">	&#125;</div><div class="line">	version, err := s.newAPIGroupVersion(apiGroupInfo, groupVersion)</div><div class="line">	version.Root = apiPrefix</div><div class="line">	version.Storage = storage</div><div class="line">	<span class="keyword">return</span> version, err</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以，APIGroupVersion又是什么，接下来分析。</p>
<h2 id="APIGroupVersion"><a href="#APIGroupVersion" class="headerlink" title="APIGroupVersion"></a>APIGroupVersion</h2><p>APIGroupVersion用来构建路由，定义在/pkg/apiserver/apiserver.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***构建webservice路由用***//</span></div><div class="line"><span class="keyword">type</span> APIGroupVersion <span class="keyword">struct</span> &#123;</div><div class="line">	Storage <span class="keyword">map</span>[<span class="keyword">string</span>]rest.Storage</div><div class="line"></div><div class="line">	Root <span class="keyword">string</span></div><div class="line"></div><div class="line">	<span class="comment">// GroupVersion is the external group version</span></div><div class="line">	GroupVersion unversioned.GroupVersion</div><div class="line"></div><div class="line">	<span class="comment">// OptionsExternalVersion controls the Kubernetes APIVersion used for common objects in the apiserver</span></div><div class="line">	<span class="comment">// schema like api.Status, api.DeleteOptions, and api.ListOptions. Other implementors may</span></div><div class="line">	<span class="comment">// define a version "v1beta1" but want to use the Kubernetes "v1" internal objects. If</span></div><div class="line">	<span class="comment">// empty, defaults to GroupVersion.</span></div><div class="line">	OptionsExternalVersion *unversioned.GroupVersion</div><div class="line"></div><div class="line">	Mapper meta.RESTMapper</div><div class="line"></div><div class="line">	<span class="comment">// Serializer is used to determine how to convert responses from API methods into bytes to send over</span></div><div class="line">	<span class="comment">// the wire.</span></div><div class="line">	Serializer     runtime.NegotiatedSerializer</div><div class="line">	ParameterCodec runtime.ParameterCodec</div><div class="line"></div><div class="line">	Typer     runtime.ObjectTyper</div><div class="line">	Creater   runtime.ObjectCreater</div><div class="line">	Convertor runtime.ObjectConvertor</div><div class="line">	Copier    runtime.ObjectCopier</div><div class="line">	Linker    runtime.SelfLinker</div><div class="line"></div><div class="line">	Admit   admission.Interface</div><div class="line">	Context api.RequestContextMapper</div><div class="line"></div><div class="line">	MinRequestTimeout time.Duration</div><div class="line"></div><div class="line">	<span class="comment">// SubresourceGroupVersionKind contains the GroupVersionKind overrides for each subresource that is</span></div><div class="line">	<span class="comment">// accessible from this API group version. The GroupVersionKind is that of the external version of</span></div><div class="line">	<span class="comment">// the subresource. The key of this map should be the path of the subresource. The keys here should</span></div><div class="line">	<span class="comment">// match the keys in the Storage map above for subresources.</span></div><div class="line">	SubresourceGroupVersionKind <span class="keyword">map</span>[<span class="keyword">string</span>]unversioned.GroupVersionKind</div><div class="line"></div><div class="line">	<span class="comment">// ResourceLister is an interface that knows how to list resources</span></div><div class="line">	<span class="comment">// for this API Group.</span></div><div class="line">	ResourceLister APIResourceLister</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>APIGroupVersion结构体的Storage存储了路径和存储的关系；root即apiPrefix，为/api或/apis；GroupVersion字段存储了GV信息。来看下APIGroupVersion的注册函数：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// InstallREST registers the REST handlers (storage, watch, proxy and redirect) into a restful Container.</span></div><div class="line"><span class="comment">// It is expected that the provided path root prefix will serve all operations. Root MUST NOT end</span></div><div class="line"><span class="comment">// in a slash.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *APIGroupVersion)</span> <span class="title">InstallREST</span><span class="params">(container *restful.Container)</span> <span class="title">error</span></span> &#123;</div><div class="line">	installer := g.newInstaller()</div><div class="line">	<span class="comment">//***生成webservice***//</span></div><div class="line">	ws := installer.NewWebService()</div><div class="line">	<span class="comment">//***调用installer的Install()函数***//</span></div><div class="line">	apiResources, registrationErrors := installer.Install(ws)</div><div class="line">	lister := g.ResourceLister</div><div class="line">	<span class="keyword">if</span> lister == <span class="literal">nil</span> &#123;</div><div class="line">		lister = staticLister&#123;apiResources&#125;</div><div class="line">	&#125;</div><div class="line">	AddSupportedResourcesWebService(g.Serializer, ws, g.GroupVersion, lister)</div><div class="line">	<span class="comment">//***把webservice加入到container中***//</span></div><div class="line">	container.Add(ws)</div><div class="line">	<span class="keyword">return</span> utilerrors.NewAggregate(registrationErrors)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>InstallREST()先生成一个webservice，然后通过installer.Install(ws)把API安装到该websevice中，最后把webservice加入到container中。<br>再来看下newInstaller():<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***生成一个新的Installer***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *APIGroupVersion)</span> <span class="title">newInstaller</span><span class="params">()</span> *<span class="title">APIInstaller</span></span> &#123;</div><div class="line">	<span class="comment">//***构建prefix: Root + Group + version***//</span></div><div class="line">	<span class="comment">//In /pkg/apiserver/apiserver.go newInstaller() prefix: /api/v1</span></div><div class="line">	<span class="comment">//In /pkg/apiserver/apiserver.go newInstaller() prefix: /apis/apps/v1beta1</span></div><div class="line">	<span class="comment">//In /pkg/apiserver/apiserver.go newInstaller() prefix: /apis/authentication.k8s.io/v1beta1</span></div><div class="line">	<span class="comment">//In /pkg/apiserver/apiserver.go newInstaller() prefix: /apis/authorization.k8s.io/v1beta1</span></div><div class="line">	<span class="comment">//In /pkg/apiserver/apiserver.go newInstaller() prefix: /apis/autoscaling/v1</span></div><div class="line">	<span class="comment">//In /pkg/apiserver/apiserver.go newInstaller() prefix: /apis/batch/v1</span></div><div class="line">	<span class="comment">//In /pkg/apiserver/apiserver.go newInstaller() prefix: /apis/batch/v2alpha1</span></div><div class="line">	<span class="comment">//In /pkg/apiserver/apiserver.go newInstaller() prefix: /apis/certificates.k8s.io/v1alpha1</span></div><div class="line">	<span class="comment">//In /pkg/apiserver/apiserver.go newInstaller() prefix: /apis/extensions/v1beta1</span></div><div class="line">	<span class="comment">//In /pkg/apiserver/apiserver.go newInstaller() prefix: /apis/policy/v1beta1</span></div><div class="line">	<span class="comment">//In /pkg/apiserver/apiserver.go newInstaller() prefix: /apis/rbac.authorization.k8s.io/v1alpha1</span></div><div class="line">	<span class="comment">//In /pkg/apiserver/apiserver.go newInstaller() prefix: /apis/storage.k8s.io/v1beta1</span></div><div class="line">	prefix := path.Join(g.Root, g.GroupVersion.Group, g.GroupVersion.Version)</div><div class="line">	<span class="comment">//***构建APIInstaller***//</span></div><div class="line">	installer := &amp;APIInstaller&#123;</div><div class="line">		group:             g,</div><div class="line">		prefix:            prefix,</div><div class="line">		minRequestTimeout: g.MinRequestTimeout,</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> installer</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>关于installer的分析，将在下次进行。</p>
<h2 id="Container的启动"><a href="#Container的启动" class="headerlink" title="Container的启动"></a>Container的启动</h2><p>Container即GenericAPIServer中的Handler。GenericAPIServer的Run()方法中会启动监听。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/09/27/apiserver分析(四)-API安装-v1-5-2/" data-id="cjbqdjb9l003240qsz2n474ky" class="article-share-link">分享</a><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></div><div class="post-nav"><a href="/2017/09/28/apiserver分析(五)-APIInstaller-v1-5-2/" class="pre">apiserver分析(五)-APIInstaller-v1.5.2</a><a href="/2017/09/21/apiserver分析(三)-master和genericapiserver-v1-5-2/" class="next">apiserver分析(三)-master和genericapiserver-v1.5.2</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/28/Docker工具包分析-archive-v1-12-3/">Docker工具包分析-archive-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/27/Docker命令行分析-cp-v1-12-3/">Docker命令行分析-cp-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/26/tar-stream-demo/">tar-stream-demo</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/25/Docker命令分行分析-run-v1-12-3/">Docker命令分行分析-run-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/23/kubelet分析(七)-dockerManager(2)-v1-5-2/">kubelet分析(七)-dockerManager(2)-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/23/kubelet分析(七)-dockerManager(1)-v1-5-2/">kubelet分析(七)-dockerManager(1)-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/20/kubelet分析(六)-proberManager-v1-5-2/">kubelet分析(六)-proberManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/18/kubelet分析(五)-podManager-v1-5-2/">kubelet分析(五)-podManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(四)-statusManager-v1-5-2/">kubelet分析(四)-statusManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(三)-volumeManager-v1-5-2/">kubelet分析(三)-volumeManager-v1.5.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>