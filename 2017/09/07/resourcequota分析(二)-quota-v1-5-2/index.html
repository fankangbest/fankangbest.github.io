<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>resourcequota分析(二)-quota-v1.5.2 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">resourcequota分析(二)-quota-v1.5.2</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">resourcequota分析(二)-quota-v1.5.2</h1><div class="post-meta">Sep 7, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>上次分析解读了evaluator是如何计算对象消耗的资源量的，本次分析将介绍Kubernetes如何判断配额是否足够，如何更新配额。</p>
<h2 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h2><p>我们之前说过，admission的plugin都要向admission中的plugins注册。resourcequota的注册代码在/plugin/pkg/admission/resourcequota/admission.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">//***向admission中的plugins中注册resourcequota的创建函数***//</span></div><div class="line">	admission.RegisterPlugin(<span class="string">"ResourceQuota"</span>,</div><div class="line">		<span class="function"><span class="keyword">func</span><span class="params">(client clientset.Interface, config io.Reader)</span> <span class="params">(admission.Interface, error)</span></span> &#123;</div><div class="line">			<span class="comment">// <span class="doctag">NOTE:</span> we do not provide informers to the registry because admission level decisions</span></div><div class="line">			<span class="comment">// does not require us to open watches for all items tracked by quota.</span></div><div class="line">			registry := install.NewRegistry(client, <span class="literal">nil</span>)</div><div class="line">			<span class="keyword">return</span> NewResourceQuota(client, registry, <span class="number">5</span>, <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;))</div><div class="line">		&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>init()函数中，resourcequota的生成方法为先生成registry，再通过调用NewResourceQuota()生成quotaAdmission。</p>
<h2 id="quotaAdmission"><a href="#quotaAdmission" class="headerlink" title="quotaAdmission"></a>quotaAdmission</h2><p>quotaAdmission封装了admission.Handler及Evaluator(此处的Evaluator为quota的Evaluator，与上次分析中的Evaluator不同)。quotaAdmission定义在/plugin/pkg/admission/resourcequota/admission.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// quotaAdmission implements an admission controller that can enforce quota constraints</span></div><div class="line"><span class="keyword">type</span> quotaAdmission <span class="keyword">struct</span> &#123;</div><div class="line">	*admission.Handler</div><div class="line"></div><div class="line">	evaluator Evaluator</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在来看下quotaAdmission的生成函数：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewResourceQuota</span><span class="params">(client clientset.Interface, registry quota.Registry, numEvaluators <span class="keyword">int</span>, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="params">(admission.Interface, error)</span></span> &#123;</div><div class="line">	quotaAccessor, err := newQuotaAccessor(client)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">go</span> quotaAccessor.Run(stopCh)</div><div class="line"></div><div class="line">	<span class="comment">//***生成quotaevaluator***//</span></div><div class="line">	evaluator := NewQuotaEvaluator(quotaAccessor, registry, <span class="literal">nil</span>, numEvaluators, stopCh)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;quotaAdmission&#123;</div><div class="line">		<span class="comment">//***resourcequota只处理Create, Update类型的请求***//</span></div><div class="line">		Handler:   admission.NewHandler(admission.Create, admission.Update),</div><div class="line">		evaluator: evaluator,</div><div class="line">	&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>生成函数先通过NewQuotaEvaluator生成quotaEvaluator，然后再封装成quotaAdmission并返回。</p>
<p>quotaAdmission还提供了配额判断的入口：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***配额判断的入口***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *quotaAdmission)</span> <span class="title">Admit</span><span class="params">(a admission.Attributes)</span> <span class="params">(err error)</span></span> &#123;</div><div class="line">	<span class="comment">// ignore all operations that correspond to sub-resource actions</span></div><div class="line">	<span class="keyword">if</span> a.GetSubresource() != <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> q.evaluator.Evaluate(a)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Admit()可以判断是否接受某请求，其主要调用了quotaEvaluator的Evaluate()函数。</p>
<h2 id="quotaEvaluator"><a href="#quotaEvaluator" class="headerlink" title="quotaEvaluator"></a>quotaEvaluator</h2><p>quotaEvaluator是处理具体请求的结构体，定义在/plugin/pkg/admission/resourcequota/controller.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> quotaEvaluator <span class="keyword">struct</span> &#123;</div><div class="line">	quotaAccessor QuotaAccessor</div><div class="line">	<span class="comment">// lockAquisitionFunc acquires any required locks and returns a cleanup method to defer</span></div><div class="line">	lockAquisitionFunc <span class="function"><span class="keyword">func</span><span class="params">([]api.ResourceQuota)</span> <span class="title">func</span><span class="params">()</span></span></div><div class="line"></div><div class="line">	// <span class="title">registry</span> <span class="title">that</span> <span class="title">knows</span> <span class="title">how</span> <span class="title">to</span> <span class="title">measure</span> <span class="title">usage</span> <span class="title">for</span> <span class="title">objects</span></div><div class="line">	<span class="title">registry</span> <span class="title">quota</span>.<span class="title">Registry</span></div><div class="line"></div><div class="line">	// <span class="title">TODO</span> <span class="title">these</span> <span class="title">are</span> <span class="title">used</span> <span class="title">together</span> <span class="title">to</span> <span class="title">bucket</span> <span class="title">items</span> <span class="title">by</span> <span class="title">namespace</span> <span class="title">and</span> <span class="title">then</span> <span class="title">batch</span> <span class="title">them</span> <span class="title">up</span> <span class="title">for</span> <span class="title">processing</span>.</div><div class="line">	// <span class="title">The</span> <span class="title">technique</span> <span class="title">is</span> <span class="title">valuable</span> <span class="title">for</span> <span class="title">rollup</span> <span class="title">activities</span> <span class="title">to</span> <span class="title">avoid</span> <span class="title">fanout</span> <span class="title">and</span> <span class="title">reduce</span> <span class="title">resource</span> <span class="title">contention</span>.</div><div class="line">	// <span class="title">We</span> <span class="title">could</span> <span class="title">move</span> <span class="title">this</span> <span class="title">into</span> <span class="title">a</span> <span class="title">library</span> <span class="title">if</span> <span class="title">another</span> <span class="title">component</span> <span class="title">needed</span> <span class="title">it</span>.</div><div class="line">	// <span class="title">queue</span> <span class="title">is</span> <span class="title">indexed</span> <span class="title">by</span> <span class="title">namespace</span>, <span class="title">so</span> <span class="title">that</span> <span class="title">we</span> <span class="title">bundle</span> <span class="title">up</span> <span class="title">on</span> <span class="title">a</span> <span class="title">per</span>-<span class="title">namespace</span> <span class="title">basis</span></div><div class="line">	<span class="title">queue</span>      *<span class="title">workqueue</span>.<span class="title">Type</span></div><div class="line">	<span class="title">workLock</span>   <span class="title">sync</span>.<span class="title">Mutex</span></div><div class="line">	<span class="title">work</span>       <span class="title">map</span>[<span class="title">string</span>][]*<span class="title">admissionWaiter</span></div><div class="line">	<span class="title">dirtyWork</span>  <span class="title">map</span>[<span class="title">string</span>][]*<span class="title">admissionWaiter</span></div><div class="line">	<span class="title">inProgress</span> <span class="title">sets</span>.<span class="title">String</span></div><div class="line"></div><div class="line">	// <span class="title">controls</span> <span class="title">the</span> <span class="title">run</span> <span class="title">method</span> <span class="title">so</span> <span class="title">that</span> <span class="title">we</span> <span class="title">can</span> <span class="title">cleanly</span> <span class="title">conform</span> <span class="title">to</span> <span class="title">the</span> <span class="title">Evaluator</span> <span class="title">interface</span></div><div class="line">	<span class="title">workers</span> <span class="title">int</span></div><div class="line">	<span class="title">stopCh</span>  &lt;-<span class="title">chan</span> <span class="title">struct</span>&#123;&#125;</div><div class="line">	<span class="comment">//***sync.Once.Do(f func())保证once只执行一次，无论你是否更换once.Do(xx)这里的方法,这个sync.Once块只会执行一次。***//</span></div><div class="line">	init sync.Once</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中：</p>
<ul>
<li>quotaAccessor: 获取quota的内容；</li>
<li>registry: 管理podEvaluator等资源使用量计算器；</li>
<li>queue: 待处理的命名空间的队列；</li>
<li>work: 待处理的任务；</li>
<li>dirtyWork: 如果某命名空间正在处理，则暂存入dirtyWork中；</li>
<li>inProgress: 标识正在处理的命名空间；</li>
<li>workers：标明处理请求的协程数量。</li>
</ul>
<p>quotaEvaluator中先会定义若干个workers，所有请求都会存储在work或dirtyWork的ns key下（如果正在处理该ns，则存储在ditryWork中）。worker会处理work中某ns下的所有请求，并一次更新resource quota。如果某请求超出配额，则该请求的result为error。worker在处理完某ns时，dirtyWork中该ns下的所有请求转到work的ns下。</p>
<h4 id="NewQuotaEvaluator"><a href="#NewQuotaEvaluator" class="headerlink" title="NewQuotaEvaluator()"></a>NewQuotaEvaluator()</h4><p>NewQuotaEvaluator()函数可以生成一个quotaEvaluator。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewQuotaEvaluator</span><span class="params">(quotaAccessor QuotaAccessor, registry quota.Registry, lockAquisitionFunc <span class="keyword">func</span>([]api.ResourceQuota)</span> <span class="title">func</span><span class="params">()</span>, <span class="title">workers</span> <span class="title">int</span>, <span class="title">stopCh</span> &lt;-<span class="title">chan</span> <span class="title">struct</span></span>&#123;&#125;) Evaluator &#123;</div><div class="line">	<span class="keyword">return</span> &amp;quotaEvaluator&#123;</div><div class="line">		quotaAccessor:      quotaAccessor,</div><div class="line">		lockAquisitionFunc: lockAquisitionFunc,</div><div class="line"></div><div class="line">		registry: registry,</div><div class="line"></div><div class="line">		queue:      workqueue.NewNamed(<span class="string">"admission_quota_controller"</span>),</div><div class="line">		work:       <span class="keyword">map</span>[<span class="keyword">string</span>][]*admissionWaiter&#123;&#125;,</div><div class="line">		dirtyWork:  <span class="keyword">map</span>[<span class="keyword">string</span>][]*admissionWaiter&#123;&#125;,</div><div class="line">		inProgress: sets.String&#123;&#125;,</div><div class="line"></div><div class="line">		workers: workers,</div><div class="line">		stopCh:  stopCh,</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Evaluate"><a href="#Evaluate" class="headerlink" title="Evaluate()"></a>Evaluate()</h4><p>Evaluate()会启动quotaEvaluator的controller，然后把attributes封装成waiter，并调用addWork加入到quotaEvaluator中。需要注意的是，<code>go e.run()</code>只会被执行一次。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***入口***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *quotaEvaluator)</span> <span class="title">Evaluate</span><span class="params">(a admission.Attributes)</span> <span class="title">error</span></span> &#123;</div><div class="line">	e.init.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">go</span> e.run()</div><div class="line">	&#125;)</div><div class="line"></div><div class="line">	<span class="comment">// if we do not know how to evaluate use for this kind, just ignore</span></div><div class="line">	evaluators := e.registry.Evaluators()</div><div class="line">	evaluator, found := evaluators[a.GetKind().GroupKind()]</div><div class="line">	<span class="keyword">if</span> !found &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// for this kind, check if the operation could mutate any quota resources</span></div><div class="line">	<span class="comment">// if no resources tracked by quota are impacted, then just return</span></div><div class="line">	op := a.GetOperation()</div><div class="line">	operationResources := evaluator.OperationResources(op)</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(operationResources) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	waiter := newAdmissionWaiter(a)</div><div class="line"></div><div class="line">	e.addWork(waiter)</div><div class="line"></div><div class="line">	<span class="comment">// wait for completion or timeout</span></div><div class="line">	<span class="comment">//***等待waiter处理完毕，或者超时***//</span></div><div class="line">	<span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> &lt;-waiter.finished:</div><div class="line">	<span class="keyword">case</span> &lt;-time.After(<span class="number">10</span> * time.Second):</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"timeout"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> waiter.result</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="addWork"><a href="#addWork" class="headerlink" title="addWork()"></a>addWork()</h4><p>addWork()可以把admissionWaiter加入到quotaEvaluator。addWork()先获取admissionWaiter的namespace，然后把namespace加入到queue中标明该namespace下配额需要处理；如果该namespace正在处理中，则把admissionWaiter加入到dirtyWork中，否则加入到work中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *quotaEvaluator)</span> <span class="title">addWork</span><span class="params">(a *admissionWaiter)</span></span> &#123;</div><div class="line">	e.workLock.Lock()</div><div class="line">	<span class="keyword">defer</span> e.workLock.Unlock()</div><div class="line"></div><div class="line">	ns := a.attributes.GetNamespace()</div><div class="line">	<span class="comment">// this Add can trigger a Get BEFORE the work is added to a list, but this is ok because the getWork routine</span></div><div class="line">	<span class="comment">// waits the worklock before retrieving the work to do, so the writes in this method will be observed</span></div><div class="line">	e.queue.Add(ns)</div><div class="line"></div><div class="line">	<span class="comment">//***如果该ns下的请求正在被处理，则先把请求加到dirtyWork中***//</span></div><div class="line">	<span class="keyword">if</span> e.inProgress.Has(ns) &#123;</div><div class="line">		e.dirtyWork[ns] = <span class="built_in">append</span>(e.dirtyWork[ns], a)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	e.work[ns] = <span class="built_in">append</span>(e.work[ns], a)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="getWork"><a href="#getWork" class="headerlink" title="getWork()"></a>getWork()</h4><p>getWork()先从queue中获取需要处理的namespace，然后获取该namespace下的请求，并加入到inProgress以标识该namespace正在处理中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***取得一个ns及其下的请求***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *quotaEvaluator)</span> <span class="title">getWork</span><span class="params">()</span> <span class="params">(<span class="keyword">string</span>, []*admissionWaiter, <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	uncastNS, shutdown := e.queue.Get()</div><div class="line">	<span class="keyword">if</span> shutdown &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, []*admissionWaiter&#123;&#125;, shutdown</div><div class="line">	&#125;</div><div class="line">	ns := uncastNS.(<span class="keyword">string</span>)</div><div class="line"></div><div class="line">	e.workLock.Lock()</div><div class="line">	<span class="keyword">defer</span> e.workLock.Unlock()</div><div class="line">	<span class="comment">// at this point, we know we have a coherent view of e.work.  It is entirely possible</span></div><div class="line">	<span class="comment">// that our workqueue has another item requeued to it, but we'll pick it up early.  This ok</span></div><div class="line">	<span class="comment">// because the next time will go into our dirty list</span></div><div class="line"></div><div class="line">	<span class="comment">//***开始处理某namespace，处理的数据已取走，清理work和dirtyWork的数据***//</span></div><div class="line">	work := e.work[ns]</div><div class="line">	<span class="built_in">delete</span>(e.work, ns)</div><div class="line">	<span class="built_in">delete</span>(e.dirtyWork, ns)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(work) != <span class="number">0</span> &#123;</div><div class="line">		e.inProgress.Insert(ns)</div><div class="line">		<span class="keyword">return</span> ns, work, <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	e.queue.Done(ns)</div><div class="line">	e.inProgress.Delete(ns)</div><div class="line">	<span class="keyword">return</span> ns, []*admissionWaiter&#123;&#125;, <span class="literal">false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="completeWork"><a href="#completeWork" class="headerlink" title="completeWork()"></a>completeWork()</h4><p>completeWork()把dirtyWork中的请求转移到work中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***把dirtyWork中ns下的请求转移到work***//</span></div><div class="line"><span class="comment">//***把ns从标记正在处理的inProgress中删除***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *quotaEvaluator)</span> <span class="title">completeWork</span><span class="params">(ns <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	e.workLock.Lock()</div><div class="line">	<span class="keyword">defer</span> e.workLock.Unlock()</div><div class="line"></div><div class="line">	e.queue.Done(ns)</div><div class="line">	e.work[ns] = e.dirtyWork[ns]</div><div class="line">	<span class="built_in">delete</span>(e.dirtyWork, ns)</div><div class="line">	e.inProgress.Delete(ns)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="run"><a href="#run" class="headerlink" title="run()"></a>run()</h4><p>run()会开启workers个goroutine处理请求，每个goroutine都运行doWork loop。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Run begins watching and syncing.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *quotaEvaluator)</span> <span class="title">run</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> utilruntime.HandleCrash()</div><div class="line"></div><div class="line">	<span class="comment">//***开启workers个goroutine进行resource quota admit处理***//</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; e.workers; i++ &#123;</div><div class="line">		<span class="keyword">go</span> wait.Until(e.doWork, time.Second, e.stopCh)</div><div class="line">	&#125;</div><div class="line">	&lt;-e.stopCh</div><div class="line">	glog.Infof(<span class="string">"Shutting down quota evaluator"</span>)</div><div class="line">	e.queue.ShutDown()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="doWork"><a href="#doWork" class="headerlink" title="doWork()"></a>doWork()</h4><p>doWork()先从quotaEvaluator获取一个namespace及该namespace下的请求，然后调用checkAttributes()对这些请求进行quota判定，最后调用compleleWork()完成dirtyWork中的请求向work中转移。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从quotaEvaluator中获取一个work，然后进行配额检查***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *quotaEvaluator)</span> <span class="title">doWork</span><span class="params">()</span></span> &#123;</div><div class="line">	workFunc := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</div><div class="line">		<span class="comment">//***获取namespace及该namespace下的请求***//</span></div><div class="line">		ns, admissionAttributes, quit := e.getWork()</div><div class="line">		<span class="keyword">if</span> quit &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***处理完成worker中的请求之后，会转移dirty worker中的请求到worker map***//</span></div><div class="line">		<span class="keyword">defer</span> e.completeWork(ns)</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(admissionAttributes) == <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***检查配额***//</span></div><div class="line">		e.checkAttributes(ns, admissionAttributes)</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">if</span> quit := workFunc(); quit &#123;</div><div class="line">			glog.Infof(<span class="string">"quota evaluator worker shutdown"</span>)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="checkAttributes"><a href="#checkAttributes" class="headerlink" title="checkAttributes()"></a>checkAttributes()</h4><p>checkAttributes()先获取namespace下的quotas，然后调用checkQuotas()完成请求的配额检查，最后通知waiters已经完成配额检查。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// checkAttributes iterates evaluates all the waiting admissionAttributes.  It will always notify all waiters</span></div><div class="line"><span class="comment">// before returning.  The default is to deny.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *quotaEvaluator)</span> <span class="title">checkAttributes</span><span class="params">(ns <span class="keyword">string</span>, admissionAttributes []*admissionWaiter)</span></span> &#123;</div><div class="line">	<span class="comment">// notify all on exit</span></div><div class="line">	<span class="comment">//***通知所有的waiters***//</span></div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> _, admissionAttribute := <span class="keyword">range</span> admissionAttributes &#123;</div><div class="line">			<span class="built_in">close</span>(admissionAttribute.finished)</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="comment">//***获取某namespace下的quotas***//</span></div><div class="line">	quotas, err := e.quotaAccessor.GetQuotas(ns)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">for</span> _, admissionAttribute := <span class="keyword">range</span> admissionAttributes &#123;</div><div class="line">			admissionAttribute.result = err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(quotas) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">for</span> _, admissionAttribute := <span class="keyword">range</span> admissionAttributes &#123;</div><div class="line">			admissionAttribute.result = <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> e.lockAquisitionFunc != <span class="literal">nil</span> &#123;</div><div class="line">		releaseLocks := e.lockAquisitionFunc(quotas)</div><div class="line">		<span class="keyword">defer</span> releaseLocks()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***检查resource quota，如需更新，则尝试更新***//</span></div><div class="line">	e.checkQuotas(quotas, admissionAttributes, <span class="number">3</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="checkRequest"><a href="#checkRequest" class="headerlink" title="checkRequest()"></a>checkRequest()</h4><p>checkRequest()可以计算请求的所需资源量，并进行配额比较，如果已使用资源+申请资源&lt;配额，则返回新的已使用资源。所以，checkRequest()是把某请求的资源量累加到namespace下的quota(可能是多个)中。具体步骤请看注释。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *quotaEvaluator)</span> <span class="title">checkRequest</span><span class="params">(quotas []api.ResourceQuota, a admission.Attributes)</span> <span class="params">([]api.ResourceQuota, error)</span></span> &#123;</div><div class="line">	namespace := a.GetNamespace()</div><div class="line">	evaluators := e.registry.Evaluators()</div><div class="line">	<span class="comment">//***获取该请求所需要的evaluator***//</span></div><div class="line">	evaluator, found := evaluators[a.GetKind().GroupKind()]</div><div class="line">	<span class="keyword">if</span> !found &#123;</div><div class="line">		<span class="keyword">return</span> quotas, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***获取evaluator下对应op下所支持的配额项***//</span></div><div class="line">	op := a.GetOperation()</div><div class="line">	operationResources := evaluator.OperationResources(op)</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(operationResources) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> quotas, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// find the set of quotas that are pertinent to this request</span></div><div class="line">	<span class="comment">// reject if we match the quota, but usage is not calculated yet</span></div><div class="line">	<span class="comment">// reject if the input object does not satisfy quota constraints</span></div><div class="line">	<span class="comment">// if there are no pertinent quotas, we can just return</span></div><div class="line">	inputObject := a.GetObject()</div><div class="line">	interestingQuotaIndexes := []<span class="keyword">int</span>&#123;&#125;</div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> quotas &#123;</div><div class="line">		resourceQuota := quotas[i]</div><div class="line">		<span class="comment">//***查看evaluator所涉及到的资源是否resourceQuota相关，如果不相关，则continue***//</span></div><div class="line">		match := evaluator.Matches(&amp;resourceQuota, inputObject)</div><div class="line">		<span class="keyword">if</span> !match &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		hardResources := quota.ResourceNames(resourceQuota.Status.Hard)</div><div class="line">		evaluatorResources := evaluator.MatchesResources()</div><div class="line">		requiredResources := quota.Intersection(hardResources, evaluatorResources)</div><div class="line">		<span class="comment">//***检查inputObject中的资源是否符合要求***//</span></div><div class="line">		<span class="keyword">if</span> err := evaluator.Constraints(requiredResources, inputObject); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, admission.NewForbidden(a, fmt.Errorf(<span class="string">"failed quota: %s: %v"</span>, resourceQuota.Name, err))</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> !hasUsageStats(&amp;resourceQuota) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, admission.NewForbidden(a, fmt.Errorf(<span class="string">"status unknown for quota: %s"</span>, resourceQuota.Name))</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***标记所涉及到的quota***//</span></div><div class="line">		interestingQuotaIndexes = <span class="built_in">append</span>(interestingQuotaIndexes, i)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(interestingQuotaIndexes) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> quotas, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Usage of some resources cannot be counted in isolation. For example, when</span></div><div class="line">	<span class="comment">// the resource represents a number of unique references to external</span></div><div class="line">	<span class="comment">// resource. In such a case an evaluator needs to process other objects in</span></div><div class="line">	<span class="comment">// the same namespace which needs to be known.</span></div><div class="line">	<span class="keyword">if</span> accessor, err := meta.Accessor(inputObject); namespace != <span class="string">""</span> &amp;&amp; err == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> accessor.GetNamespace() == <span class="string">""</span> &#123;</div><div class="line">			accessor.SetNamespace(namespace)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// there is at least one quota that definitely matches our object</span></div><div class="line">	<span class="comment">// as a result, we need to measure the usage of this object for quota</span></div><div class="line">	<span class="comment">// on updates, we need to subtract the previous measured usage</span></div><div class="line">	<span class="comment">// if usage shows no change, just return since it has no impact on quota</span></div><div class="line">	<span class="comment">//***计算请求资源***//</span></div><div class="line">	deltaUsage := evaluator.Usage(inputObject)</div><div class="line"></div><div class="line">	<span class="comment">// ensure that usage for input object is never negative (this would mean a resource made a negative resource requirement)</span></div><div class="line">	<span class="comment">//***检测deltaUsage中的项是否为负***//</span></div><div class="line">	<span class="keyword">if</span> negativeUsage := quota.IsNegative(deltaUsage); <span class="built_in">len</span>(negativeUsage) &gt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, admission.NewForbidden(a, fmt.Errorf(<span class="string">"quota usage is negative for resource(s): %s"</span>, prettyPrintResourceNames(negativeUsage)))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***Update的情况的deltaUsage=请求资源-已经拥有资源***//</span></div><div class="line">	<span class="keyword">if</span> admission.Update == op &#123;</div><div class="line">		prevItem := a.GetOldObject()</div><div class="line">		<span class="keyword">if</span> prevItem == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, admission.NewForbidden(a, fmt.Errorf(<span class="string">"unable to get previous usage since prior version of object was not found"</span>))</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// if we can definitively determine that this is not a case of "create on update",</span></div><div class="line">		<span class="comment">// then charge based on the delta.  Otherwise, bill the maximum</span></div><div class="line">		metadata, err := meta.Accessor(prevItem)</div><div class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &amp;&amp; <span class="built_in">len</span>(metadata.GetResourceVersion()) &gt; <span class="number">0</span> &#123;</div><div class="line">			prevUsage := evaluator.Usage(prevItem)</div><div class="line">			deltaUsage = quota.Subtract(deltaUsage, prevUsage)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> quota.IsZero(deltaUsage) &#123;</div><div class="line">		<span class="keyword">return</span> quotas, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	outQuotas, err := copyQuotas(quotas)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, index := <span class="keyword">range</span> interestingQuotaIndexes &#123;</div><div class="line">		resourceQuota := outQuotas[index]</div><div class="line"></div><div class="line">		hardResources := quota.ResourceNames(resourceQuota.Status.Hard)</div><div class="line">		requestedUsage := quota.Mask(deltaUsage, hardResources)</div><div class="line">		<span class="comment">//***请求资源和原来的resource quota相加***//</span></div><div class="line">		newUsage := quota.Add(resourceQuota.Status.Used, requestedUsage)</div><div class="line">		maskedNewUsage := quota.Mask(newUsage, quota.ResourceNames(requestedUsage))</div><div class="line"></div><div class="line">		<span class="comment">//***比较***//</span></div><div class="line">		<span class="keyword">if</span> allowed, exceeded := quota.LessThanOrEqual(maskedNewUsage, resourceQuota.Status.Hard); !allowed &#123;</div><div class="line">			failedRequestedUsage := quota.Mask(requestedUsage, exceeded)</div><div class="line">			failedUsed := quota.Mask(resourceQuota.Status.Used, exceeded)</div><div class="line">			failedHard := quota.Mask(resourceQuota.Status.Hard, exceeded)</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, admission.NewForbidden(a,</div><div class="line">				fmt.Errorf(<span class="string">"exceeded quota: %s, requested: %s, used: %s, limited: %s"</span>,</div><div class="line">					resourceQuota.Name,</div><div class="line">					prettyPrint(failedRequestedUsage),</div><div class="line">					prettyPrint(failedUsed),</div><div class="line">					prettyPrint(failedHard)))</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// update to the new usage number</span></div><div class="line">		outQuotas[index].Status.Used = newUsage</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> outQuotas, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="checkQuotas"><a href="#checkQuotas" class="headerlink" title="checkQuotas()"></a>checkQuotas()</h4><p>checkQuotas()先调用checkRequest()累加每个请求的资源量，并更新发生更新的quota。具体步骤见注释。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *quotaEvaluator)</span> <span class="title">checkQuotas</span><span class="params">(quotas []api.ResourceQuota, admissionAttributes []*admissionWaiter, remainingRetries <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="comment">// yet another copy to compare against originals to see if we actually have deltas</span></div><div class="line">	originalQuotas, err := copyQuotas(quotas)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		utilruntime.HandleError(err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	atLeastOneChanged := <span class="literal">false</span></div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> admissionAttributes &#123;</div><div class="line">		admissionAttribute := admissionAttributes[i]</div><div class="line">		<span class="comment">//***计算resource quota，如果超出配额，则err不为空***//</span></div><div class="line">		newQuotas, err := e.checkRequest(quotas, admissionAttribute.attributes)</div><div class="line">		<span class="comment">//***如果err不为空（如超出配额），则把拒绝该请求，并开始轮询下一个请求***//</span></div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			admissionAttribute.result = err</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// if the new quotas are the same as the old quotas, then this particular one doesn't issue any updates</span></div><div class="line">		<span class="comment">// that means that no quota docs applied, so it can get a pass</span></div><div class="line">		atLeastOneChangeForThisWaiter := <span class="literal">false</span></div><div class="line">		<span class="comment">//***检查是否有quota存在更新***//</span></div><div class="line">		<span class="keyword">for</span> j := <span class="keyword">range</span> newQuotas &#123;</div><div class="line">			<span class="keyword">if</span> !quota.Equals(quotas[j].Status.Used, newQuotas[j].Status.Used) &#123;</div><div class="line">				atLeastOneChanged = <span class="literal">true</span></div><div class="line">				atLeastOneChangeForThisWaiter = <span class="literal">true</span></div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> !atLeastOneChangeForThisWaiter &#123;</div><div class="line">			admissionAttribute.result = <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		quotas = newQuotas</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// if none of the requests changed anything, there's no reason to issue an update, just fail them all now</span></div><div class="line">	<span class="keyword">if</span> !atLeastOneChanged &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// now go through and try to issue updates.  Things get a little weird here:</span></div><div class="line">	<span class="comment">// 1. check to see if the quota changed.  If not, skip.</span></div><div class="line">	<span class="comment">// 2. if the quota changed and the update passes, be happy</span></div><div class="line">	<span class="comment">// 3. if the quota changed and the update fails, add the original to a retry list</span></div><div class="line">	<span class="keyword">var</span> updatedFailedQuotas []api.ResourceQuota</div><div class="line">	<span class="keyword">var</span> lastErr error</div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> quotas &#123;</div><div class="line">		newQuota := quotas[i]</div><div class="line"></div><div class="line">		<span class="comment">// if this quota didn't have its status changed, skip it</span></div><div class="line">		<span class="keyword">if</span> quota.Equals(originalQuotas[i].Status.Used, newQuota.Status.Used) &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//***更新resourceQuota***//</span></div><div class="line">		<span class="keyword">if</span> err := e.quotaAccessor.UpdateQuotaStatus(&amp;newQuota); err != <span class="literal">nil</span> &#123;</div><div class="line">			updatedFailedQuotas = <span class="built_in">append</span>(updatedFailedQuotas, newQuota)</div><div class="line">			lastErr = err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***resource quota更新成功***//</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(updatedFailedQuotas) == <span class="number">0</span> &#123;</div><div class="line">		<span class="comment">// all the updates succeeded.  At this point, anything with the default deny error was just waiting to</span></div><div class="line">		<span class="comment">// get a successful update, so we can mark and notify</span></div><div class="line">		<span class="keyword">for</span> _, admissionAttribute := <span class="keyword">range</span> admissionAttributes &#123;</div><div class="line">			<span class="keyword">if</span> IsDefaultDeny(admissionAttribute.result) &#123;</div><div class="line">				admissionAttribute.result = <span class="literal">nil</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// at this point, errors are fatal.  Update all waiters without status to failed and return</span></div><div class="line">	<span class="comment">//***resource quota更新不成功***//</span></div><div class="line">	<span class="keyword">if</span> remainingRetries &lt;= <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">for</span> _, admissionAttribute := <span class="keyword">range</span> admissionAttributes &#123;</div><div class="line">			<span class="keyword">if</span> IsDefaultDeny(admissionAttribute.result) &#123;</div><div class="line">				admissionAttribute.result = lastErr</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// this retry logic has the same bug that its possible to be checking against quota in a state that never actually exists where</span></div><div class="line">	<span class="comment">// you've added a new documented, then updated an old one, your resource matches both and you're only checking one</span></div><div class="line">	<span class="comment">// updates for these quota names failed.  Get the current quotas in the namespace, compare by name, check to see if the</span></div><div class="line">	<span class="comment">// resource versions have changed.  If not, we're going to fall through an fail everything.  If they all have, then we can try again</span></div><div class="line">	newQuotas, err := e.quotaAccessor.GetQuotas(quotas[<span class="number">0</span>].Namespace)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// this means that updates failed.  Anything with a default deny error has failed and we need to let them know</span></div><div class="line">		<span class="keyword">for</span> _, admissionAttribute := <span class="keyword">range</span> admissionAttributes &#123;</div><div class="line">			<span class="keyword">if</span> IsDefaultDeny(admissionAttribute.result) &#123;</div><div class="line">				admissionAttribute.result = lastErr</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// this logic goes through our cache to find the new version of all quotas that failed update.  If something has been removed</span></div><div class="line">	<span class="comment">// it is skipped on this retry.  After all, you removed it.</span></div><div class="line">	quotasToCheck := []api.ResourceQuota&#123;&#125;</div><div class="line">	<span class="keyword">for</span> _, newQuota := <span class="keyword">range</span> newQuotas &#123;</div><div class="line">		<span class="keyword">for</span> _, oldQuota := <span class="keyword">range</span> updatedFailedQuotas &#123;</div><div class="line">			<span class="keyword">if</span> newQuota.Name == oldQuota.Name &#123;</div><div class="line">				quotasToCheck = <span class="built_in">append</span>(quotasToCheck, newQuota)</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	e.checkQuotas(quotasToCheck, admissionAttributes, remainingRetries<span class="number">-1</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在resourcequota中，有evaluator的概念用来计算某对象的资源，如podEvaluator等。这当中，有一个特殊的evaluator，即quotaEvaluator，quotaEvaluator可以对某namespace下的所有请求进行配额累加处理(累加时如果超出配额，则拒绝该请求)，如果某配额发生了更新，则quotaEvaluator会把对应的配额进行更新。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/09/07/resourcequota分析(二)-quota-v1-5-2/" data-id="cje7ql71w007t0cqso3ljlgt9" class="article-share-link">分享</a><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></div><div class="post-nav"><a href="/2017/09/07/apiserver分析(一)-authenticator-v1-5-2/" class="pre">apiserver分析(一)-authenticator-v1.5.2</a><a href="/2017/09/06/resourcequota分析(一)-evaluator-v1-5-2/" class="next">resourcequota分析(一)-evaluator-v1.5.2</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/02/26/Kubernetes-cni网络调用分析-v1-5-2/">Kubernetes-cni网络调用分析-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/10/Docker命令行分析-load-save-v1-12-3/">Docker命令行分析-load-save-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/03/Dockerd的server启动流程分析-v1-12-3/">Dockerd的server启动流程分析-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/21/GO语言-切片原理/">GO语言-切片原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/16/Kubernetes-resourceVersion机制分析/">Kubernetes-resourceVersion机制分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/04/Kubernetes-Ingress使用-v1-5-2/">Kubernetes-Ingress使用-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/02/kube-controller分析(五)-QuotaController-v1-5-2/">kube-controller分析(五)-QuotaController-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/01/runc源码分析(二)-namespace设置流程-v1-0-0-rc2/">runc源码分析(二)-namespace设置流程-v1.0.0-rc2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/30/Docker创建spec文件分析-v1-12-3/">Docker创建spec文件分析-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/28/Docker工具包分析-archive-v1-12-3/">Docker工具包分析-archive-v1.12.3</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>