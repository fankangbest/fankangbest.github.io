<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>apiserver分析(三)-master和genericapiserver-v1.5.2 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">apiserver分析(三)-master和genericapiserver-v1.5.2</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">apiserver分析(三)-master和genericapiserver-v1.5.2</h1><div class="post-meta">Sep 21, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="GenericAPIServer"><a href="#GenericAPIServer" class="headerlink" title="GenericAPIServer"></a>GenericAPIServer</h2><p>GenericAPIServer可以理解为Kubernetes中提供API服务的结构体。定义在/pkg/genericapiserver/genericapiserver.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GenericAPIServer contains state for a Kubernetes cluster api server.</span></div><div class="line"><span class="keyword">type</span> GenericAPIServer <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// discoveryAddresses is used to build cluster IPs for discovery.</span></div><div class="line">	discoveryAddresses DiscoveryAddresses</div><div class="line"></div><div class="line">	<span class="comment">// LoopbackClientConfig is a config for a privileged loopback connection to the API server</span></div><div class="line">	LoopbackClientConfig *restclient.Config</div><div class="line"></div><div class="line">	<span class="comment">// minRequestTimeout is how short the request timeout can be.  This is used to build the RESTHandler</span></div><div class="line">	minRequestTimeout time.Duration</div><div class="line"></div><div class="line">	<span class="comment">// enableSwaggerSupport indicates that swagger should be served.  This is currently separate because</span></div><div class="line">	<span class="comment">// the API group routes are created *after* initialization and you can't generate the swagger routes until</span></div><div class="line">	<span class="comment">// after those are available.</span></div><div class="line">	<span class="comment">// TODO eventually we should be able to factor this out to take place during initialization.</span></div><div class="line">	enableSwaggerSupport <span class="keyword">bool</span></div><div class="line"></div><div class="line">	<span class="comment">// legacyAPIGroupPrefixes is used to set up URL parsing for authorization and for validating requests</span></div><div class="line">	<span class="comment">// to InstallLegacyAPIGroup</span></div><div class="line">	legacyAPIGroupPrefixes sets.String</div><div class="line"></div><div class="line">	<span class="comment">// admissionControl is used to build the RESTStorage that backs an API Group.</span></div><div class="line">	admissionControl admission.Interface</div><div class="line"></div><div class="line">	<span class="comment">// requestContextMapper provides a way to get the context for a request.  It may be nil.</span></div><div class="line">	requestContextMapper api.RequestContextMapper</div><div class="line"></div><div class="line">	<span class="comment">// The registered APIs</span></div><div class="line">	<span class="comment">//***含有REST中的container***//</span></div><div class="line">	HandlerContainer *genericmux.APIContainer</div><div class="line"></div><div class="line">	SecureServingInfo   *SecureServingInfo</div><div class="line">	InsecureServingInfo *ServingInfo</div><div class="line"></div><div class="line">	<span class="comment">// numerical ports, set after listening</span></div><div class="line">	effectiveSecurePort, effectiveInsecurePort <span class="keyword">int</span></div><div class="line"></div><div class="line">	<span class="comment">// ExternalAddress is the address (hostname or IP and port) that should be used in</span></div><div class="line">	<span class="comment">// external (public internet) URLs for this GenericAPIServer.</span></div><div class="line">	ExternalAddress <span class="keyword">string</span></div><div class="line"></div><div class="line">	<span class="comment">// storage contains the RESTful endpoints exposed by this GenericAPIServer</span></div><div class="line">	storage <span class="keyword">map</span>[<span class="keyword">string</span>]rest.Storage</div><div class="line"></div><div class="line">	<span class="comment">// Serializer controls how common API objects not in a group/version prefix are serialized for this server.</span></div><div class="line">	<span class="comment">// Individual APIGroups may define their own serializers.</span></div><div class="line">	Serializer runtime.NegotiatedSerializer</div><div class="line"></div><div class="line">	<span class="comment">// "Outputs"</span></div><div class="line">	Handler         http.Handler</div><div class="line">	InsecureHandler http.Handler</div><div class="line"></div><div class="line">	<span class="comment">// Map storing information about all groups to be exposed in discovery response.</span></div><div class="line">	<span class="comment">// The map is from name to the group.</span></div><div class="line">	apiGroupsForDiscoveryLock sync.RWMutex</div><div class="line">	apiGroupsForDiscovery     <span class="keyword">map</span>[<span class="keyword">string</span>]unversioned.APIGroup</div><div class="line"></div><div class="line">	<span class="comment">// See Config.$name for documentation of these flags</span></div><div class="line"></div><div class="line">	enableOpenAPISupport <span class="keyword">bool</span></div><div class="line">	openAPIConfig        *common.Config</div><div class="line"></div><div class="line">	<span class="comment">// PostStartHooks are each called after the server has started listening, in a separate go func for each</span></div><div class="line">	<span class="comment">// with no guaranteee of ordering between them.  The map key is a name used for error reporting.</span></div><div class="line">	<span class="comment">// It may kill the process with a panic if it wishes to by returning an error</span></div><div class="line">	postStartHookLock    sync.Mutex</div><div class="line">	postStartHooks       <span class="keyword">map</span>[<span class="keyword">string</span>]postStartHookEntry</div><div class="line">	postStartHooksCalled <span class="keyword">bool</span></div><div class="line"></div><div class="line">	<span class="comment">// healthz checks</span></div><div class="line">	healthzLock    sync.Mutex</div><div class="line">	healthzChecks  []healthz.HealthzChecker</div><div class="line">	healthzCreated <span class="keyword">bool</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在来看下如何生成GenericAPIServer。GenericAPIServer通过Config的New()方法来生成，定义在/pkg/genericapiserver/config.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***生成GenericAPIServer***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span> <span class="title">New</span><span class="params">()</span> <span class="params">(*GenericAPIServer, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> c.Serializer == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"Genericapiserver.New() called with config.Serializer == nil"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	s := &amp;GenericAPIServer&#123;</div><div class="line">		discoveryAddresses:     c.DiscoveryAddresses,</div><div class="line">		LoopbackClientConfig:   c.LoopbackClientConfig,</div><div class="line">		legacyAPIGroupPrefixes: c.LegacyAPIGroupPrefixes,</div><div class="line">		admissionControl:       c.AdmissionControl,</div><div class="line">		requestContextMapper:   c.RequestContextMapper,</div><div class="line">		Serializer:             c.Serializer,</div><div class="line"></div><div class="line">		minRequestTimeout:    time.Duration(c.MinRequestTimeout) * time.Second,</div><div class="line">		enableSwaggerSupport: c.EnableSwaggerSupport,</div><div class="line"></div><div class="line">		SecureServingInfo:   c.SecureServingInfo,</div><div class="line">		InsecureServingInfo: c.InsecureServingInfo,</div><div class="line">		ExternalAddress:     c.ExternalAddress,</div><div class="line"></div><div class="line">		apiGroupsForDiscovery: <span class="keyword">map</span>[<span class="keyword">string</span>]unversioned.APIGroup&#123;&#125;,</div><div class="line"></div><div class="line">		enableOpenAPISupport: c.EnableOpenAPISupport,</div><div class="line">		openAPIConfig:        c.OpenAPIConfig,</div><div class="line"></div><div class="line">		postStartHooks: <span class="keyword">map</span>[<span class="keyword">string</span>]postStartHookEntry&#123;&#125;,</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***生成restful的container***//</span></div><div class="line">	s.HandlerContainer = mux.NewAPIContainer(http.NewServeMux(), c.Serializer)</div><div class="line"></div><div class="line">	<span class="comment">//***安装特殊功能的路径***//</span></div><div class="line">	s.installAPI(c.Config)</div><div class="line"></div><div class="line">	<span class="comment">//***调用BuildHandlerChainsFunc()生成Handler***//</span></div><div class="line">	<span class="comment">//***把HandlerContainer进一步封装，以进行认证，授权等动作***//</span></div><div class="line">	s.Handler, s.InsecureHandler = c.BuildHandlerChainsFunc(s.HandlerContainer.ServeMux, c.Config)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> s, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以现在的问题转变成如何构造Config。在/cmd/kube-apiserver/app/server.go中的Run()函数中有：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">genericConfig := genericapiserver.NewConfig(). <span class="comment">// create the new config</span></div><div class="line">				ApplyOptions(s.GenericServerRunOptions). <span class="comment">// apply the options selected</span></div><div class="line">				Complete()                               <span class="comment">// set default values based on the known values</span></div></pre></td></tr></table></figure></p>
<p>其中Newconfig()，ApplyOptions()和Complete()都定义在/pkg/genericapiserver/config.go中：Newconfig()生成一个Config结构体值；ApplyOption()可以把apiserver的参数填到Config中；Complete()把Config的信息填充完整。</p>
<p>那么options是怎么来的呢？<br>来看/cmd/kube-apiserver/app/options/options.go中的NewServerRunOptions()函数：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***生成apiserver的run option***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServerRunOptions</span><span class="params">()</span> *<span class="title">ServerRunOptions</span></span> &#123;</div><div class="line">	s := ServerRunOptions&#123;</div><div class="line">		<span class="comment">//***生成GenericServerRunOptions***//</span></div><div class="line">		GenericServerRunOptions: genericoptions.NewServerRunOptions().WithEtcdOptions(),</div><div class="line">		EventTTL:                <span class="number">1</span> * time.Hour,</div><div class="line">		KubeletConfig: kubeletclient.KubeletClientConfig&#123;</div><div class="line">			Port: ports.KubeletPort,</div><div class="line">			PreferredAddressTypes: []<span class="keyword">string</span>&#123;</div><div class="line">				<span class="keyword">string</span>(api.NodeHostName),</div><div class="line">				<span class="keyword">string</span>(api.NodeInternalIP),</div><div class="line">				<span class="keyword">string</span>(api.NodeExternalIP),</div><div class="line">				<span class="keyword">string</span>(api.NodeLegacyHostIP),</div><div class="line">			&#125;,</div><div class="line">			EnableHttps: <span class="literal">true</span>,</div><div class="line">			HTTPTimeout: time.Duration(<span class="number">5</span>) * time.Second,</div><div class="line">		&#125;,</div><div class="line">		WebhookTokenAuthnCacheTTL: <span class="number">2</span> * time.Minute,</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;s</div><div class="line">&#125;</div><div class="line"></div><div class="line">可以看出，GenericAPIServer的options使用genericoptions.NewServerRunOptions().WithEtcdOptions()生成的，到/pkg/genericapiserver/options/server_run_options.<span class="keyword">go</span>中看下：</div><div class="line"><span class="string">``</span><span class="string">` Go</span></div><div class="line">func NewServerRunOptions() *ServerRunOptions &#123;</div><div class="line">	return &amp;ServerRunOptions&#123;</div><div class="line">		AdmissionControl: "AlwaysAdmit",</div><div class="line">		AnonymousAuth:    false,</div><div class="line">		//***默认为AlwaysAllow***//</div><div class="line">		AuthorizationMode:                        "AlwaysAllow",</div><div class="line">		AuthorizationWebhookCacheAuthorizedTTL:   5 * time.Minute,</div><div class="line">		AuthorizationWebhookCacheUnauthorizedTTL: 30 * time.Second,</div><div class="line">		BindAddress:                              net.ParseIP("0.0.0.0"),</div><div class="line">		CertDirectory:                            "/var/run/kubernetes",</div><div class="line">		DefaultStorageMediaType:                  "application/json",</div><div class="line">		DefaultStorageVersions:                   registered.AllPreferredGroupVersions(),</div><div class="line">		DeleteCollectionWorkers:                  1,</div><div class="line">		EnableGarbageCollection:                  true,</div><div class="line">		EnableProfiling:                          true,</div><div class="line">		EnableContentionProfiling:                false,</div><div class="line">		EnableWatchCache:                         true,</div><div class="line">		InsecureBindAddress:                      net.ParseIP("127.0.0.1"),</div><div class="line">		InsecurePort:                             8080,</div><div class="line">		LongRunningRequestRE:                     DefaultLongRunningRequestRE,</div><div class="line">		MasterCount:                              1,</div><div class="line">		MasterServiceNamespace:                   api.NamespaceDefault,</div><div class="line">		MaxRequestsInFlight:                      400,</div><div class="line">		MinRequestTimeout:                        1800,</div><div class="line">		RuntimeConfig:                            make(config.ConfigurationMap),</div><div class="line">		SecurePort:                               6443,</div><div class="line">		ServiceNodePortRange:                     DefaultServiceNodePortRange,</div><div class="line">		StorageVersions:                          registered.AllPreferredGroupVersions(),</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//***设置StorageConfig***//</div><div class="line">func (o *ServerRunOptions) WithEtcdOptions() *ServerRunOptions &#123;</div><div class="line">	o.StorageConfig = storagebackend.Config&#123;</div><div class="line">		Prefix: DefaultEtcdPathPrefix,</div><div class="line">		// Default cache size to 0 - if unset, its size will be set based on target</div><div class="line">		// memory usage.</div><div class="line">		DeserializationCacheSize: 0,</div><div class="line">	&#125;</div><div class="line">	return o</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以，经过options, Config然后才生成GenericAPIServer的。</p>
<p>有了GenericAPIServer，那么如何跑起来呢？来看GenericAPIServer的Run()方法，定义在/pkg/genericapiserver/genericapiserver.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Run spawns the http servers (secure and insecure). It only returns if stopCh is closed</span></div><div class="line"><span class="comment">// or one of the ports cannot be listened on initially.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s preparedGenericAPIServer)</span> <span class="title">Run</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	<span class="comment">//***监听安全端口***//</span></div><div class="line">	<span class="keyword">if</span> s.SecureServingInfo != <span class="literal">nil</span> &amp;&amp; s.Handler != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> err := s.serveSecurely(stopCh); err != <span class="literal">nil</span> &#123;</div><div class="line">			glog.Fatal(err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***监听非安全端口***//</span></div><div class="line">	<span class="keyword">if</span> s.InsecureServingInfo != <span class="literal">nil</span> &amp;&amp; s.InsecureHandler != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> err := s.serveInsecurely(stopCh); err != <span class="literal">nil</span> &#123;</div><div class="line">			glog.Fatal(err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	s.RunPostStartHooks()</div><div class="line"></div><div class="line">	<span class="comment">// err == systemd.SdNotifyNoSocket when not running on a systemd system</span></div><div class="line">	<span class="keyword">if</span> err := systemd.SdNotify(<span class="string">"READY=1\n"</span>); err != <span class="literal">nil</span> &amp;&amp; err != systemd.SdNotifyNoSocket &#123;</div><div class="line">		glog.Errorf(<span class="string">"Unable to send systemd daemon successful start message: %v\n"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***监听stpCh channel，如果有信号，则退出***//</span></div><div class="line">	&lt;-stopCh</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>很容易理解，GenericAPIServer的Run()方法就是开始监听安全端口和非安全端口。serveSecurely()和serveInsecurely()定义在/pkg/genericapiserver/serve.go，具体分析略。</p>
<h2 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h2><p>Master的本质就是一个GenericAPIServer，定义在/pkg/master/master.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Master <span class="keyword">struct</span> &#123;</div><div class="line">	GenericAPIServer *genericapiserver.GenericAPIServer</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以Master是对GenericAPIServer的封装。<br>Master也是从Config中来，这个Config定义在/pkg/master/master.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</div><div class="line">	GenericConfig *genericapiserver.Config</div><div class="line"></div><div class="line">	StorageFactory           genericapiserver.StorageFactory</div><div class="line">	EnableWatchCache         <span class="keyword">bool</span></div><div class="line">	EnableCoreControllers    <span class="keyword">bool</span></div><div class="line">	EndpointReconcilerConfig EndpointReconcilerConfig</div><div class="line">	DeleteCollectionWorkers  <span class="keyword">int</span></div><div class="line">	EventTTL                 time.Duration</div><div class="line">	KubeletClientConfig      kubeletclient.KubeletClientConfig</div><div class="line"></div><div class="line">	<span class="comment">// Used to start and monitor tunneling</span></div><div class="line">	Tunneler          genericapiserver.Tunneler</div><div class="line">	EnableUISupport   <span class="keyword">bool</span></div><div class="line">	EnableLogsSupport <span class="keyword">bool</span></div><div class="line">	ProxyTransport    http.RoundTripper</div><div class="line"></div><div class="line">	<span class="comment">// Values to build the IP addresses used by discovery</span></div><div class="line">	<span class="comment">// The range of IPs to be assigned to services with type=ClusterIP or greater</span></div><div class="line">	ServiceIPRange net.IPNet</div><div class="line">	<span class="comment">// The IP address for the GenericAPIServer service (must be inside ServiceIPRange)</span></div><div class="line">	APIServerServiceIP net.IP</div><div class="line">	<span class="comment">// Port for the apiserver service.</span></div><div class="line">	APIServerServicePort <span class="keyword">int</span></div><div class="line"></div><div class="line">	<span class="comment">// TODO, we can probably group service related items into a substruct to make it easier to configure</span></div><div class="line">	<span class="comment">// the API server items and `Extra*` fields likely fit nicely together.</span></div><div class="line"></div><div class="line">	<span class="comment">// The range of ports to be assigned to services with type=NodePort or greater</span></div><div class="line">	ServiceNodePortRange utilnet.PortRange</div><div class="line">	<span class="comment">// Additional ports to be exposed on the GenericAPIServer service</span></div><div class="line">	<span class="comment">// extraServicePorts is injectable in the event that more ports</span></div><div class="line">	<span class="comment">// (other than the default 443/tcp) are exposed on the GenericAPIServer</span></div><div class="line">	<span class="comment">// and those ports need to be load balanced by the GenericAPIServer</span></div><div class="line">	<span class="comment">// service because this pkg is linked by out-of-tree projects</span></div><div class="line">	<span class="comment">// like openshift which want to use the GenericAPIServer but also do</span></div><div class="line">	<span class="comment">// more stuff.</span></div><div class="line">	ExtraServicePorts []api.ServicePort</div><div class="line">	<span class="comment">// Additional ports to be exposed on the GenericAPIServer endpoints</span></div><div class="line">	<span class="comment">// Port names should align with ports defined in ExtraServicePorts</span></div><div class="line">	ExtraEndpointPorts []api.EndpointPort</div><div class="line">	<span class="comment">// If non-zero, the "kubernetes" services uses this port as NodePort.</span></div><div class="line">	<span class="comment">// TODO(sttts): move into master</span></div><div class="line">	KubernetesServiceNodePort <span class="keyword">int</span></div><div class="line"></div><div class="line">	<span class="comment">// Number of masters running; all masters must be started with the</span></div><div class="line">	<span class="comment">// same value for this field. (Numbers &gt; 1 currently untested.)</span></div><div class="line">	MasterCount <span class="keyword">int</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，Master的Config包含GenericConfig。<br>Master的Config可以经过Complete()填充后成为completedConfig。completedConfig和Config一样，就是字段全部都填有值了。再来看下Master的生成函数：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从config中生成master***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span> <span class="title">New</span><span class="params">()</span> <span class="params">(*Master, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> reflect.DeepEqual(c.KubeletClientConfig, kubeletclient.KubeletClientConfig&#123;&#125;) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"Master.New() called with empty config.KubeletClientConfig"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***通过generic config生成GenericAPIServer***//</span></div><div class="line">	s, err := c.Config.GenericConfig.SkipComplete().New() <span class="comment">// completion is done in Complete, no need for a second time</span></div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***UI redirect功能***//</span></div><div class="line">	<span class="keyword">if</span> c.EnableUISupport &#123;</div><div class="line">		routes.UIRedirect&#123;&#125;.Install(s.HandlerContainer)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***log相关***//</span></div><div class="line">	<span class="keyword">if</span> c.EnableLogsSupport &#123;</div><div class="line">		routes.Logs&#123;&#125;.Install(s.HandlerContainer)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	m := &amp;Master&#123;</div><div class="line">		GenericAPIServer: s,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***生成restOptionsFactory***//</span></div><div class="line">	restOptionsFactory := restOptionsFactory&#123;</div><div class="line">		deleteCollectionWorkers: c.DeleteCollectionWorkers,</div><div class="line">		enableGarbageCollection: c.GenericConfig.EnableGarbageCollection,</div><div class="line">		storageFactory:          c.StorageFactory,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***赋值storageDecorator***//</span></div><div class="line">	<span class="keyword">if</span> c.EnableWatchCache &#123;</div><div class="line">		restOptionsFactory.storageDecorator = registry.StorageWithCacher</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		restOptionsFactory.storageDecorator = generic.UndecoratedStorage</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// install legacy rest storage</span></div><div class="line">	<span class="keyword">if</span> c.GenericConfig.APIResourceConfigSource.AnyResourcesForVersionEnabled(apiv1.SchemeGroupVersion) &#123;</div><div class="line">		legacyRESTStorageProvider := corerest.LegacyRESTStorageProvider&#123;</div><div class="line">			StorageFactory:       c.StorageFactory,</div><div class="line">			ProxyTransport:       c.ProxyTransport,</div><div class="line">			KubeletClientConfig:  c.KubeletClientConfig,</div><div class="line">			EventTTL:             c.EventTTL,</div><div class="line">			ServiceIPRange:       c.ServiceIPRange,</div><div class="line">			ServiceNodePortRange: c.ServiceNodePortRange,</div><div class="line">			LoopbackClientConfig: c.GenericConfig.LoopbackClientConfig,</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***Fankang***//</span></div><div class="line">		<span class="comment">//***调用InstallLegacyAPI()***//</span></div><div class="line">		m.InstallLegacyAPI(c.Config, restOptionsFactory.NewFor, legacyRESTStorageProvider)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***构造restStorageProvider数组***//</span></div><div class="line">	restStorageProviders := []genericapiserver.RESTStorageProvider&#123;</div><div class="line">		appsrest.RESTStorageProvider&#123;&#125;,</div><div class="line">		authenticationrest.RESTStorageProvider&#123;Authenticator: c.GenericConfig.Authenticator&#125;,</div><div class="line">		authorizationrest.RESTStorageProvider&#123;Authorizer: c.GenericConfig.Authorizer&#125;,</div><div class="line">		autoscalingrest.RESTStorageProvider&#123;&#125;,</div><div class="line">		batchrest.RESTStorageProvider&#123;&#125;,</div><div class="line">		certificatesrest.RESTStorageProvider&#123;&#125;,</div><div class="line">		<span class="comment">//***Fankang***//</span></div><div class="line">		<span class="comment">//***extension包***//</span></div><div class="line">		extensionsrest.RESTStorageProvider&#123;ResourceInterface: thirdparty.NewThirdPartyResourceServer(s, c.StorageFactory)&#125;,</div><div class="line">		policyrest.RESTStorageProvider&#123;&#125;,</div><div class="line">		rbacrest.RESTStorageProvider&#123;AuthorizerRBACSuperUser: c.GenericConfig.AuthorizerRBACSuperUser&#125;,</div><div class="line">		storagerest.RESTStorageProvider&#123;&#125;,</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***调用InstallAPIs()***//</span></div><div class="line">	m.InstallAPIs(c.Config.GenericConfig.APIResourceConfigSource, restOptionsFactory.NewFor, restStorageProviders...)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> c.Tunneler != <span class="literal">nil</span> &#123;</div><div class="line">		m.installTunneler(c.Tunneler, coreclient.NewForConfigOrDie(c.GenericConfig.LoopbackClientConfig).Nodes())</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> m, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出在生成Master的同时，系统会调用InstallLegacyAPI()及InstallAPIs()来安装各种API，这就是我们下次分析要讲的内容。</p>
<h2 id="kube-apiserver"><a href="#kube-apiserver" class="headerlink" title="kube-apiserver"></a>kube-apiserver</h2><p>之前说过Master是对GenericAPIServer的封装，再来看kube-apiserver是如何生成Master的。<br>先来看kube-apiserver的main()，定义在/cmd/kube-apiserver/apiserver.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	rand.Seed(time.Now().UTC().UnixNano())</div><div class="line"></div><div class="line">	s := options.NewServerRunOptions()</div><div class="line">	s.AddFlags(pflag.CommandLine)</div><div class="line"></div><div class="line">	flag.InitFlags()</div><div class="line">	logs.InitLogs()</div><div class="line">	<span class="keyword">defer</span> logs.FlushLogs()</div><div class="line"></div><div class="line">	verflag.PrintAndExitIfRequested()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := app.Run(s); err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Fprintf(os.Stderr, <span class="string">"%v\n"</span>, err)</div><div class="line">		os.Exit(<span class="number">1</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>main()函数先调用options.NewServerRunOptions()生成options，然后通过调用AddFlags()把参数添加到options中，最后通过app.Run( )</p>
<p>再来看/cmd/kube-apiserver/app/server.go中的Run()函数：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Run runs the specified APIServer.  This should never exit.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Run</span><span class="params">(s *options.ServerRunOptions)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***验证ETCD Server的配置，只是看ETCD列表是否为0而已***//</span></div><div class="line">	genericvalidation.VerifyEtcdServersList(s.GenericServerRunOptions)</div><div class="line">	genericapiserver.DefaultAndValidateRunOptions(s.GenericServerRunOptions)</div><div class="line">	genericConfig := genericapiserver.NewConfig(). <span class="comment">// create the new config</span></div><div class="line">							ApplyOptions(s.GenericServerRunOptions). <span class="comment">// apply the options selected</span></div><div class="line">							Complete()                               <span class="comment">// set default values based on the known values</span></div><div class="line"></div><div class="line">	serviceIPRange, apiServerServiceIP, err := genericapiserver.DefaultServiceIPRange(s.GenericServerRunOptions.ServiceClusterIPRange)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.Fatalf(<span class="string">"Error determining service IP ranges: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := genericConfig.MaybeGenerateServingCerts(apiServerServiceIP); err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.Fatalf(<span class="string">"Failed to generate service certificate: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	capabilities.Initialize(capabilities.Capabilities&#123;</div><div class="line">		AllowPrivileged: s.AllowPrivileged,</div><div class="line">		<span class="comment">// TODO(vmarmol): Implement support for HostNetworkSources.</span></div><div class="line">		PrivilegedSources: capabilities.PrivilegedSources&#123;</div><div class="line">			HostNetworkSources: []<span class="keyword">string</span>&#123;&#125;,</div><div class="line">			HostPIDSources:     []<span class="keyword">string</span>&#123;&#125;,</div><div class="line">			HostIPCSources:     []<span class="keyword">string</span>&#123;&#125;,</div><div class="line">		&#125;,</div><div class="line">		PerConnectionBandwidthLimitBytesPerSec: s.MaxConnectionBytesPerSec,</div><div class="line">	&#125;)</div><div class="line"></div><div class="line">	<span class="comment">// Setup tunneler if needed</span></div><div class="line">	<span class="keyword">var</span> tunneler genericapiserver.Tunneler</div><div class="line">	<span class="keyword">var</span> proxyDialerFn apiserver.ProxyDialerFunc</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s.SSHUser) &gt; <span class="number">0</span> &#123;</div><div class="line">		<span class="comment">// Get ssh key distribution func, if supported</span></div><div class="line">		<span class="keyword">var</span> installSSH genericapiserver.InstallSSHKey</div><div class="line">		cloud, err := cloudprovider.InitCloudProvider(s.GenericServerRunOptions.CloudProvider, s.GenericServerRunOptions.CloudConfigFile)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			glog.Fatalf(<span class="string">"Cloud provider could not be initialized: %v"</span>, err)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> cloud != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> instances, supported := cloud.Instances(); supported &#123;</div><div class="line">				installSSH = instances.AddSSHKeyToAllInstances</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> s.KubeletConfig.Port == <span class="number">0</span> &#123;</div><div class="line">			glog.Fatalf(<span class="string">"Must enable kubelet port if proxy ssh-tunneling is specified."</span>)</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// Set up the tunneler</span></div><div class="line">		<span class="comment">// TODO(cjcullen): If we want this to handle per-kubelet ports or other</span></div><div class="line">		<span class="comment">// kubelet listen-addresses, we need to plumb through options.</span></div><div class="line">		healthCheckPath := &amp;url.URL&#123;</div><div class="line">			Scheme: <span class="string">"https"</span>,</div><div class="line">			Host:   net.JoinHostPort(<span class="string">"127.0.0.1"</span>, strconv.FormatUint(<span class="keyword">uint64</span>(s.KubeletConfig.Port), <span class="number">10</span>)),</div><div class="line">			Path:   <span class="string">"healthz"</span>,</div><div class="line">		&#125;</div><div class="line">		tunneler = genericapiserver.NewSSHTunneler(s.SSHUser, s.SSHKeyfile, healthCheckPath, installSSH)</div><div class="line"></div><div class="line">		<span class="comment">// Use the tunneler's dialer to connect to the kubelet</span></div><div class="line">		s.KubeletConfig.Dial = tunneler.Dial</div><div class="line">		<span class="comment">// Use the tunneler's dialer when proxying to pods, services, and nodes</span></div><div class="line">		proxyDialerFn = tunneler.Dial</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Proxying to pods and services is IP-based... don't expect to be able to verify the hostname</span></div><div class="line">	proxyTLSClientConfig := &amp;tls.Config&#123;InsecureSkipVerify: <span class="literal">true</span>&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> s.GenericServerRunOptions.StorageConfig.DeserializationCacheSize == <span class="number">0</span> &#123;</div><div class="line">		<span class="comment">// When size of cache is not explicitly set, estimate its size based on</span></div><div class="line">		<span class="comment">// target memory usage.</span></div><div class="line">		glog.V(<span class="number">2</span>).Infof(<span class="string">"Initalizing deserialization cache size based on %dMB limit"</span>, s.GenericServerRunOptions.TargetRAMMB)</div><div class="line"></div><div class="line">		<span class="comment">// This is the heuristics that from memory capacity is trying to infer</span></div><div class="line">		<span class="comment">// the maximum number of nodes in the cluster and set cache sizes based</span></div><div class="line">		<span class="comment">// on that value.</span></div><div class="line">		<span class="comment">// From our documentation, we officially recomment 120GB machines for</span></div><div class="line">		<span class="comment">// 2000 nodes, and we scale from that point. Thus we assume ~60MB of</span></div><div class="line">		<span class="comment">// capacity per node.</span></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> We may consider deciding that some percentage of memory will</span></div><div class="line">		<span class="comment">// be used for the deserialization cache and divide it by the max object</span></div><div class="line">		<span class="comment">// size to compute its size. We may even go further and measure</span></div><div class="line">		<span class="comment">// collective sizes of the objects in the cache.</span></div><div class="line">		clusterSize := s.GenericServerRunOptions.TargetRAMMB / <span class="number">60</span></div><div class="line">		s.GenericServerRunOptions.StorageConfig.DeserializationCacheSize = <span class="number">25</span> * clusterSize</div><div class="line">		<span class="keyword">if</span> s.GenericServerRunOptions.StorageConfig.DeserializationCacheSize &lt; <span class="number">1000</span> &#123;</div><div class="line">			s.GenericServerRunOptions.StorageConfig.DeserializationCacheSize = <span class="number">1000</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	storageGroupsToEncodingVersion, err := s.GenericServerRunOptions.StorageGroupsToEncodingVersion()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.Fatalf(<span class="string">"error generating storage version map: %s"</span>, err)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***生成DefaultStorageFactory***//</span></div><div class="line">	storageFactory, err := genericapiserver.BuildDefaultStorageFactory(</div><div class="line">		s.GenericServerRunOptions.StorageConfig, s.GenericServerRunOptions.DefaultStorageMediaType, api.Codecs,</div><div class="line">		genericapiserver.NewDefaultResourceEncodingConfig(), storageGroupsToEncodingVersion,</div><div class="line">		<span class="comment">// <span class="doctag">FIXME:</span> this GroupVersionResource override should be configurable</span></div><div class="line">		[]unversioned.GroupVersionResource&#123;batch.Resource(<span class="string">"cronjobs"</span>).WithVersion(<span class="string">"v2alpha1"</span>)&#125;,</div><div class="line">		master.DefaultAPIResourceConfigSource(), s.GenericServerRunOptions.RuntimeConfig)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.Fatalf(<span class="string">"error in initializing storage factory: %s"</span>, err)</div><div class="line">	&#125;</div><div class="line">	storageFactory.AddCohabitatingResources(batch.Resource(<span class="string">"jobs"</span>), extensions.Resource(<span class="string">"jobs"</span>))</div><div class="line">	storageFactory.AddCohabitatingResources(autoscaling.Resource(<span class="string">"horizontalpodautoscalers"</span>), extensions.Resource(<span class="string">"horizontalpodautoscalers"</span>))</div><div class="line">	<span class="keyword">for</span> _, override := <span class="keyword">range</span> s.GenericServerRunOptions.EtcdServersOverrides &#123;</div><div class="line">		tokens := strings.Split(override, <span class="string">"#"</span>)</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(tokens) != <span class="number">2</span> &#123;</div><div class="line">			glog.Errorf(<span class="string">"invalid value of etcd server overrides: %s"</span>, override)</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		apiresource := strings.Split(tokens[<span class="number">0</span>], <span class="string">"/"</span>)</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(apiresource) != <span class="number">2</span> &#123;</div><div class="line">			glog.Errorf(<span class="string">"invalid resource definition: %s"</span>, tokens[<span class="number">0</span>])</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		group := apiresource[<span class="number">0</span>]</div><div class="line">		resource := apiresource[<span class="number">1</span>]</div><div class="line">		groupResource := unversioned.GroupResource&#123;Group: group, Resource: resource&#125;</div><div class="line"></div><div class="line">		servers := strings.Split(tokens[<span class="number">1</span>], <span class="string">";"</span>)</div><div class="line">		storageFactory.SetEtcdLocation(groupResource, servers)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Default to the private server key for service account token signing</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s.ServiceAccountKeyFiles) == <span class="number">0</span> &amp;&amp; s.GenericServerRunOptions.TLSPrivateKeyFile != <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">if</span> authenticator.IsValidServiceAccountKeyFile(s.GenericServerRunOptions.TLSPrivateKeyFile) &#123;</div><div class="line">			s.ServiceAccountKeyFiles = []<span class="keyword">string</span>&#123;s.GenericServerRunOptions.TLSPrivateKeyFile&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			glog.Warning(<span class="string">"No TLS key provided, service account token authentication disabled"</span>)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> serviceAccountGetter serviceaccount.ServiceAccountTokenGetter</div><div class="line">	<span class="keyword">if</span> s.ServiceAccountLookup &#123;</div><div class="line">		<span class="comment">// If we need to look up service accounts and tokens,</span></div><div class="line">		<span class="comment">// go directly to etcd to avoid recursive auth insanity</span></div><div class="line">		storageConfig, err := storageFactory.NewConfig(api.Resource(<span class="string">"serviceaccounts"</span>))</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			glog.Fatalf(<span class="string">"Unable to get serviceaccounts storage: %v"</span>, err)</div><div class="line">		&#125;</div><div class="line">		serviceAccountGetter = serviceaccountcontroller.NewGetterFromStorageInterface(storageConfig, storageFactory.ResourcePrefix(api.Resource(<span class="string">"serviceaccounts"</span>)), storageFactory.ResourcePrefix(api.Resource(<span class="string">"secrets"</span>)))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***认证器***//</span></div><div class="line">	apiAuthenticator, securityDefinitions, err := authenticator.New(authenticator.AuthenticatorConfig&#123;</div><div class="line">		Anonymous:                   s.GenericServerRunOptions.AnonymousAuth,</div><div class="line">		AnyToken:                    s.GenericServerRunOptions.EnableAnyToken,</div><div class="line">		BasicAuthFile:               s.GenericServerRunOptions.BasicAuthFile,</div><div class="line">		ClientCAFile:                s.GenericServerRunOptions.ClientCAFile,</div><div class="line">		TokenAuthFile:               s.GenericServerRunOptions.TokenAuthFile,</div><div class="line">		OIDCIssuerURL:               s.GenericServerRunOptions.OIDCIssuerURL,</div><div class="line">		OIDCClientID:                s.GenericServerRunOptions.OIDCClientID,</div><div class="line">		OIDCCAFile:                  s.GenericServerRunOptions.OIDCCAFile,</div><div class="line">		OIDCUsernameClaim:           s.GenericServerRunOptions.OIDCUsernameClaim,</div><div class="line">		OIDCGroupsClaim:             s.GenericServerRunOptions.OIDCGroupsClaim,</div><div class="line">		ServiceAccountKeyFiles:      s.ServiceAccountKeyFiles,</div><div class="line">		ServiceAccountLookup:        s.ServiceAccountLookup,</div><div class="line">		ServiceAccountTokenGetter:   serviceAccountGetter,</div><div class="line">		KeystoneURL:                 s.GenericServerRunOptions.KeystoneURL,</div><div class="line">		KeystoneCAFile:              s.GenericServerRunOptions.KeystoneCAFile,</div><div class="line">		WebhookTokenAuthnConfigFile: s.WebhookTokenAuthnConfigFile,</div><div class="line">		WebhookTokenAuthnCacheTTL:   s.WebhookTokenAuthnCacheTTL,</div><div class="line">		RequestHeaderConfig:         s.GenericServerRunOptions.AuthenticationRequestHeaderConfig(),</div><div class="line">	&#125;)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.Fatalf(<span class="string">"Invalid Authentication Config: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	privilegedLoopbackToken := uuid.NewRandom().String()</div><div class="line">	selfClientConfig, err := s.GenericServerRunOptions.NewSelfClientConfig(privilegedLoopbackToken)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.Fatalf(<span class="string">"Failed to create clientset: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line">	client, err := s.GenericServerRunOptions.NewSelfClient(privilegedLoopbackToken)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.Errorf(<span class="string">"Failed to create clientset: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line">	sharedInformers := informers.NewSharedInformerFactory(client, <span class="number">10</span>*time.Minute)</div><div class="line"></div><div class="line">	<span class="comment">//***授权***//</span></div><div class="line">	authorizationConfig := authorizer.AuthorizationConfig&#123;</div><div class="line">		PolicyFile:                  s.GenericServerRunOptions.AuthorizationPolicyFile,</div><div class="line">		WebhookConfigFile:           s.GenericServerRunOptions.AuthorizationWebhookConfigFile,</div><div class="line">		WebhookCacheAuthorizedTTL:   s.GenericServerRunOptions.AuthorizationWebhookCacheAuthorizedTTL,</div><div class="line">		WebhookCacheUnauthorizedTTL: s.GenericServerRunOptions.AuthorizationWebhookCacheUnauthorizedTTL,</div><div class="line">		RBACSuperUser:               s.GenericServerRunOptions.AuthorizationRBACSuperUser,</div><div class="line">		InformerFactory:             sharedInformers,</div><div class="line">	&#125;</div><div class="line">	authorizationModeNames := strings.Split(s.GenericServerRunOptions.AuthorizationMode, <span class="string">","</span>)</div><div class="line">	apiAuthorizer, err := authorizer.NewAuthorizerFromAuthorizationConfig(authorizationModeNames, authorizationConfig)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.Fatalf(<span class="string">"Invalid Authorization Config: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***admission controller***//</span></div><div class="line">	admissionControlPluginNames := strings.Split(s.GenericServerRunOptions.AdmissionControl, <span class="string">","</span>)</div><div class="line"></div><div class="line">	<span class="comment">// TODO(dims): We probably need to add an option "EnableLoopbackToken"</span></div><div class="line">	<span class="keyword">if</span> apiAuthenticator != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">var</span> uid = uuid.NewRandom().String()</div><div class="line">		tokens := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*user.DefaultInfo)</div><div class="line">		tokens[privilegedLoopbackToken] = &amp;user.DefaultInfo&#123;</div><div class="line">			Name:   user.APIServerUser,</div><div class="line">			UID:    uid,</div><div class="line">			Groups: []<span class="keyword">string</span>&#123;user.SystemPrivilegedGroup&#125;,</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		tokenAuthenticator := authenticator.NewAuthenticatorFromTokens(tokens)</div><div class="line">		apiAuthenticator = authenticatorunion.New(tokenAuthenticator, apiAuthenticator)</div><div class="line"></div><div class="line">		tokenAuthorizer := authorizer.NewPrivilegedGroups(user.SystemPrivilegedGroup)</div><div class="line">		apiAuthorizer = authorizerunion.New(tokenAuthorizer, apiAuthorizer)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	pluginInitializer := admission.NewPluginInitializer(sharedInformers, apiAuthorizer)</div><div class="line"></div><div class="line">	admissionController, err := admission.NewFromPlugins(client, admissionControlPluginNames, s.GenericServerRunOptions.AdmissionControlConfigFile, pluginInitializer)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		glog.Fatalf(<span class="string">"Failed to initialize plugins: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	proxyTransport := utilnet.SetTransportDefaults(&amp;http.Transport&#123;</div><div class="line">		Dial:            proxyDialerFn,</div><div class="line">		TLSClientConfig: proxyTLSClientConfig,</div><div class="line">	&#125;)</div><div class="line">	kubeVersion := version.Get()</div><div class="line"></div><div class="line">	genericConfig.Version = &amp;kubeVersion</div><div class="line">	genericConfig.LoopbackClientConfig = selfClientConfig</div><div class="line">	genericConfig.Authenticator = apiAuthenticator</div><div class="line">	genericConfig.Authorizer = apiAuthorizer</div><div class="line">	genericConfig.AdmissionControl = admissionController</div><div class="line">	genericConfig.APIResourceConfigSource = storageFactory.APIResourceConfigSource</div><div class="line">	genericConfig.OpenAPIConfig.Info.Title = <span class="string">"Kubernetes"</span></div><div class="line">	genericConfig.OpenAPIConfig.Definitions = generatedopenapi.OpenAPIDefinitions</div><div class="line">	genericConfig.EnableOpenAPISupport = <span class="literal">true</span></div><div class="line">	genericConfig.EnableMetrics = <span class="literal">true</span></div><div class="line">	genericConfig.OpenAPIConfig.SecurityDefinitions = securityDefinitions</div><div class="line"></div><div class="line">	<span class="comment">//***master的config***//</span></div><div class="line">	config := &amp;master.Config&#123;</div><div class="line">		GenericConfig: genericConfig.Config,</div><div class="line"></div><div class="line">		StorageFactory:          storageFactory,</div><div class="line">		EnableWatchCache:        s.GenericServerRunOptions.EnableWatchCache,</div><div class="line">		EnableCoreControllers:   <span class="literal">true</span>,</div><div class="line">		DeleteCollectionWorkers: s.GenericServerRunOptions.DeleteCollectionWorkers,</div><div class="line">		EventTTL:                s.EventTTL,</div><div class="line">		KubeletClientConfig:     s.KubeletConfig,</div><div class="line">		EnableUISupport:         <span class="literal">true</span>,</div><div class="line">		EnableLogsSupport:       <span class="literal">true</span>,</div><div class="line">		ProxyTransport:          proxyTransport,</div><div class="line"></div><div class="line">		Tunneler: tunneler,</div><div class="line"></div><div class="line">		ServiceIPRange:       serviceIPRange,</div><div class="line">		APIServerServiceIP:   apiServerServiceIP,</div><div class="line">		APIServerServicePort: <span class="number">443</span>,</div><div class="line"></div><div class="line">		ServiceNodePortRange:      s.GenericServerRunOptions.ServiceNodePortRange,</div><div class="line">		KubernetesServiceNodePort: s.GenericServerRunOptions.KubernetesServiceNodePort,</div><div class="line"></div><div class="line">		MasterCount: s.GenericServerRunOptions.MasterCount,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> s.GenericServerRunOptions.EnableWatchCache &#123;</div><div class="line">		glog.V(<span class="number">2</span>).Infof(<span class="string">"Initalizing cache sizes based on %dMB limit"</span>, s.GenericServerRunOptions.TargetRAMMB)</div><div class="line">		cachesize.InitializeWatchCacheSizes(s.GenericServerRunOptions.TargetRAMMB)</div><div class="line">		cachesize.SetWatchCacheSizes(s.GenericServerRunOptions.WatchCacheSizes)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***生成master***//</span></div><div class="line">	m, err := config.Complete().New()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sharedInformers.Start(wait.NeverStop)</div><div class="line">	<span class="comment">//***启动master***//</span></div><div class="line">	m.GenericAPIServer.PrepareRun().Run(wait.NeverStop)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Run()的流程如下：</p>
<ul>
<li><p>生成genericConfig:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">genericConfig := genericapiserver.NewConfig(). <span class="comment">// create the new config</span></div><div class="line">							ApplyOptions(s.GenericServerRunOptions). <span class="comment">// apply the options selected</span></div><div class="line">							Complete()                               <span class="comment">// set default values based on the known values</span></div></pre></td></tr></table></figure>
</li>
<li><p>把apiAuthenticator, apiAuthorizer待回填到genericConfig:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">genericConfig.Authenticator = apiAuthenticator</div><div class="line">genericConfig.Authorizer = apiAuthorizer</div></pre></td></tr></table></figure>
</li>
<li><p>生成master Config:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">config := &amp;master.Config&#123;</div><div class="line">		GenericConfig: genericConfig.Config,</div><div class="line"></div><div class="line">		StorageFactory:          storageFactory,</div><div class="line">		EnableWatchCache:        s.GenericServerRunOptions.EnableWatchCache,</div><div class="line">		EnableCoreControllers:   <span class="literal">true</span>,</div><div class="line">		DeleteCollectionWorkers: s.GenericServerRunOptions.DeleteCollectionWorkers,</div><div class="line">		EventTTL:                s.EventTTL,</div><div class="line">		KubeletClientConfig:     s.KubeletConfig,</div><div class="line">		EnableUISupport:         <span class="literal">true</span>,</div><div class="line">		EnableLogsSupport:       <span class="literal">true</span>,</div><div class="line">		ProxyTransport:          proxyTransport,</div><div class="line"></div><div class="line">		Tunneler: tunneler,</div><div class="line"></div><div class="line">		ServiceIPRange:       serviceIPRange,</div><div class="line">		APIServerServiceIP:   apiServerServiceIP,</div><div class="line">		APIServerServicePort: <span class="number">443</span>,</div><div class="line"></div><div class="line">		ServiceNodePortRange:      s.GenericServerRunOptions.ServiceNodePortRange,</div><div class="line">		KubernetesServiceNodePort: s.GenericServerRunOptions.KubernetesServiceNodePort,</div><div class="line"></div><div class="line">		MasterCount: s.GenericServerRunOptions.MasterCount,</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>生成master:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***生成master***//</span></div><div class="line">m, err := config.Complete().New()</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>启动master</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">m.GenericAPIServer.PrepareRun().Run(wait.NeverStop)</div></pre></td></tr></table></figure></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/09/21/apiserver分析(三)-master和genericapiserver-v1-5-2/" data-id="cjbqd5wra002ohoqsct8kvdg9" class="article-share-link">分享</a><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></div><div class="post-nav"><a href="/2017/09/27/apiserver分析(四)-API安装-v1-5-2/" class="pre">apiserver分析(四)-API安装-v1.5.2</a><a href="/2017/09/19/Docker命令行解析源码分析-v1-12-3/" class="next">Docker命令行解析源码分析-v1.12.3</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/28/Docker工具包分析-archive-v1-12-3/">Docker工具包分析-archive-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/27/Docker命令行分析-cp-v1-12-3/">Docker命令行分析-cp-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/26/tar-stream-demo/">tar-stream-demo</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/25/Docker命令分行分析-run-v1-12-3/">Docker命令分行分析-run-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/23/kubelet分析(七)-dockerManager(2)-v1-5-2/">kubelet分析(七)-dockerManager(2)-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/23/kubelet分析(七)-dockerManager(1)-v1-5-2/">kubelet分析(七)-dockerManager(1)-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/20/kubelet分析(六)-proberManager-v1-5-2/">kubelet分析(六)-proberManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/18/kubelet分析(五)-podManager-v1-5-2/">kubelet分析(五)-podManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(四)-statusManager-v1-5-2/">kubelet分析(四)-statusManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(三)-volumeManager-v1-5-2/">kubelet分析(三)-volumeManager-v1.5.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>