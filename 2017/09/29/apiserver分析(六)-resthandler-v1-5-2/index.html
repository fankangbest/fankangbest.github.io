<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>apiserver分析(六)-resthandler-v1.5.2 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">apiserver分析(六)-resthandler-v1.5.2</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">apiserver分析(六)-resthandler-v1.5.2</h1><div class="post-meta">Sep 29, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="什么是resthandler"><a href="#什么是resthandler" class="headerlink" title="什么是resthandler"></a>什么是resthandler</h2><p>之前已经分析到，Kubernetes是如何注册API的。Kubernetes会把对应路径上的请求交给对应的resthandler处理。所以，resthandler是对请求进行处理并响应的函数。在Kubernetes中，给每一种动作设置了对应的resthandler，如下表格所示(只列出了主要部分)：</p>
<table>
<thead>
<tr>
<th>动作</th>
<th>函数</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>GetResource</td>
</tr>
<tr>
<td>LIST</td>
<td>ListResource</td>
</tr>
<tr>
<td>PUT</td>
<td>UpdateResource</td>
</tr>
<tr>
<td>PATCH</td>
<td>PatchResource</td>
</tr>
<tr>
<td>POST</td>
<td>CreateResource</td>
</tr>
<tr>
<td>DELETE</td>
<td>DeleteResource</td>
</tr>
<tr>
<td>WATCH</td>
<td>ListResource</td>
</tr>
</tbody>
</table>
<h2 id="GetResource"><a href="#GetResource" class="headerlink" title="GetResource()"></a>GetResource()</h2><p>GetResource()定义在/pkg/apiserver/resthandler.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GetResource returns a function that handles retrieving a single resource from a rest.Storage object.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetResource</span><span class="params">(r rest.Getter, e rest.Exporter, scope RequestScope)</span> <span class="title">restful</span>.<span class="title">RouteFunction</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> getResourceHandler(scope,</div><div class="line">		<span class="function"><span class="keyword">func</span><span class="params">(ctx api.Context, name <span class="keyword">string</span>, req *restful.Request)</span> <span class="params">(runtime.Object, error)</span></span> &#123;</div><div class="line">			<span class="comment">// For performance tracking purposes.</span></div><div class="line">			trace := util.NewTrace(<span class="string">"Get "</span> + req.Request.URL.Path)</div><div class="line">			<span class="keyword">defer</span> trace.LogIfLong(<span class="number">500</span> * time.Millisecond)</div><div class="line"></div><div class="line">			<span class="comment">// check for export</span></div><div class="line">			<span class="keyword">if</span> values := req.Request.URL.Query(); <span class="built_in">len</span>(values) &gt; <span class="number">0</span> &#123;</div><div class="line">				<span class="comment">// <span class="doctag">TODO:</span> this is internal version, not unversioned</span></div><div class="line">				exports := unversioned.ExportOptions&#123;&#125;</div><div class="line">				<span class="keyword">if</span> err := scope.ParameterCodec.DecodeParameters(values, unversioned.GroupVersion&#123;Version: <span class="string">"v1"</span>&#125;, &amp;exports); err != <span class="literal">nil</span> &#123;</div><div class="line">					<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> exports.Export &#123;</div><div class="line">					<span class="keyword">if</span> e == <span class="literal">nil</span> &#123;</div><div class="line">						<span class="keyword">return</span> <span class="literal">nil</span>, errors.NewBadRequest(fmt.Sprintf(<span class="string">"export of %q is not supported"</span>, scope.Resource.Resource))</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">return</span> e.Export(ctx, name, exports)</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">return</span> r.Get(ctx, name)</div><div class="line">		&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>GetResource()中定义了获取资源的函数，然后通过getResourceHandler()进行封装。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// getResourceHandler is an HTTP handler function for get requests. It delegates to the</span></div><div class="line"><span class="comment">// passed-in getterFunc to perform the actual get.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getResourceHandler</span><span class="params">(scope RequestScope, getter getterFunc)</span> <span class="title">restful</span>.<span class="title">RouteFunction</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(req *restful.Request, res *restful.Response)</span></span> &#123;</div><div class="line">		w := res.ResponseWriter</div><div class="line">		namespace, name, err := scope.Namer.Name(req)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		ctx := scope.ContextFunc(req)</div><div class="line">		ctx = api.WithNamespace(ctx, namespace)</div><div class="line"></div><div class="line">		<span class="comment">//***调用getterFunc，获取result***//</span></div><div class="line">		result, err := getter(ctx, name, req)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err := setSelfLink(result, req, scope.Namer); err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		write(http.StatusOK, scope.Kind.GroupVersion(), scope.Serializer, result, w, req.Request)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>getResourceHandler()先从Request中获取namespace和name，然后namespace封装到ctx中，最后调用GetResource()中定义的获取资源的函数，获取到资源后，把结果写入请求的应答体。</p>
<h2 id="ListResource"><a href="#ListResource" class="headerlink" title="ListResource()"></a>ListResource()</h2><p>ListResource()用来获取资源列表。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ListResource returns a function that handles retrieving a list of resources from a rest.Storage object.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ListResource</span><span class="params">(r rest.Lister, rw rest.Watcher, scope RequestScope, forceWatch <span class="keyword">bool</span>, minRequestTimeout time.Duration)</span> <span class="title">restful</span>.<span class="title">RouteFunction</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(req *restful.Request, res *restful.Response)</span></span> &#123;</div><div class="line">		<span class="comment">// For performance tracking purposes.</span></div><div class="line">		trace := util.NewTrace(<span class="string">"List "</span> + req.Request.URL.Path)</div><div class="line"></div><div class="line">		w := res.ResponseWriter</div><div class="line"></div><div class="line">		<span class="comment">//***获取namespace***//</span></div><div class="line">		namespace, err := scope.Namer.Namespace(req)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Watches for single objects are routed to this function.</span></div><div class="line">		<span class="comment">// Treat a /name parameter the same as a field selector entry.</span></div><div class="line">		hasName := <span class="literal">true</span></div><div class="line">		_, name, err := scope.Namer.Name(req)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			hasName = <span class="literal">false</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		ctx := scope.ContextFunc(req)</div><div class="line">		<span class="comment">//***设置namespace key***//</span></div><div class="line">		ctx = api.WithNamespace(ctx, namespace)</div><div class="line"></div><div class="line">		opts := api.ListOptions&#123;&#125;</div><div class="line">		<span class="keyword">if</span> err := scope.ParameterCodec.DecodeParameters(req.Request.URL.Query(), scope.Kind.GroupVersion(), &amp;opts); err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// transform fields</span></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> DecodeParametersInto should do this.</span></div><div class="line">		<span class="keyword">if</span> opts.FieldSelector != <span class="literal">nil</span> &#123;</div><div class="line">			fn := <span class="function"><span class="keyword">func</span><span class="params">(label, value <span class="keyword">string</span>)</span> <span class="params">(newLabel, newValue <span class="keyword">string</span>, err error)</span></span> &#123;</div><div class="line">				<span class="keyword">return</span> scope.Convertor.ConvertFieldLabel(scope.Kind.GroupVersion().String(), scope.Kind.Kind, label, value)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> opts.FieldSelector, err = opts.FieldSelector.Transform(fn); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="comment">// <span class="doctag">TODO:</span> allow bad request to set field causes based on query parameters</span></div><div class="line">				err = errors.NewBadRequest(err.Error())</div><div class="line">				scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> hasName &#123;</div><div class="line">			<span class="comment">// metadata.name is the canonical internal name.</span></div><div class="line">			<span class="comment">// SelectionPredicate will notice that this is</span></div><div class="line">			<span class="comment">// a request for a single object and optimize the</span></div><div class="line">			<span class="comment">// storage query accordingly.</span></div><div class="line">			nameSelector := fields.OneTermEqualSelector(<span class="string">"metadata.name"</span>, name)</div><div class="line">			<span class="keyword">if</span> opts.FieldSelector != <span class="literal">nil</span> &amp;&amp; !opts.FieldSelector.Empty() &#123;</div><div class="line">				<span class="comment">// It doesn't make sense to ask for both a name</span></div><div class="line">				<span class="comment">// and a field selector, since just the name is</span></div><div class="line">				<span class="comment">// sufficient to narrow down the request to a</span></div><div class="line">				<span class="comment">// single object.</span></div><div class="line">				scope.err(errors.NewBadRequest(<span class="string">"both a name and a field selector provided; please provide one or the other."</span>), res.ResponseWriter, req.Request)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			opts.FieldSelector = nameSelector</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (opts.Watch || forceWatch) &amp;&amp; rw != <span class="literal">nil</span> &#123;</div><div class="line">			watcher, err := rw.Watch(ctx, &amp;opts)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">// <span class="doctag">TODO:</span> Currently we explicitly ignore ?timeout= and use only ?timeoutSeconds=.</span></div><div class="line">			timeout := time.Duration(<span class="number">0</span>)</div><div class="line">			<span class="keyword">if</span> opts.TimeoutSeconds != <span class="literal">nil</span> &#123;</div><div class="line">				timeout = time.Duration(*opts.TimeoutSeconds) * time.Second</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> timeout == <span class="number">0</span> &amp;&amp; minRequestTimeout &gt; <span class="number">0</span> &#123;</div><div class="line">				timeout = time.Duration(<span class="keyword">float64</span>(minRequestTimeout) * (rand.Float64() + <span class="number">1.0</span>))</div><div class="line">			&#125;</div><div class="line">			serveWatch(watcher, scope, req, res, timeout)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Log only long List requests (ignore Watch).</span></div><div class="line">		<span class="keyword">defer</span> trace.LogIfLong(<span class="number">500</span> * time.Millisecond)</div><div class="line">		trace.Step(<span class="string">"About to List from storage"</span>)</div><div class="line">		<span class="comment">//***获取list result***//</span></div><div class="line">		result, err := r.List(ctx, &amp;opts)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		trace.Step(<span class="string">"Listing from storage done"</span>)</div><div class="line">		numberOfItems, err := setListSelfLink(result, req, scope.Namer)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		trace.Step(<span class="string">"Self-linking done"</span>)</div><div class="line">		write(http.StatusOK, scope.Kind.GroupVersion(), scope.Serializer, result, w, req.Request)</div><div class="line">		trace.Step(fmt.Sprintf(<span class="string">"Writing http response done (%d items)"</span>, numberOfItems))</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果执行的是WATCH动作，则会调用serveWatch()，定义在/pkg/apiserver/watch.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***Watch()实现函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">serveWatch</span><span class="params">(watcher watch.Interface, scope RequestScope, req *restful.Request, res *restful.Response, timeout time.Duration)</span></span> &#123;</div><div class="line">	<span class="comment">// negotiate for the stream serializer</span></div><div class="line">	serializer, err := negotiateOutputStreamSerializer(req.Request, scope.Serializer)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	framer := serializer.StreamSerializer.Framer</div><div class="line">	streamSerializer := serializer.StreamSerializer.Serializer</div><div class="line">	embedded := serializer.Serializer</div><div class="line">	<span class="keyword">if</span> framer == <span class="literal">nil</span> &#123;</div><div class="line">		scope.err(fmt.Errorf(<span class="string">"no framer defined for %q available for embedded encoding"</span>, serializer.MediaType), res.ResponseWriter, req.Request)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	encoder := scope.Serializer.EncoderForVersion(streamSerializer, scope.Kind.GroupVersion())</div><div class="line"></div><div class="line">	useTextFraming := serializer.EncodesAsText</div><div class="line"></div><div class="line">	<span class="comment">// find the embedded serializer matching the media type</span></div><div class="line">	embeddedEncoder := scope.Serializer.EncoderForVersion(embedded, scope.Kind.GroupVersion())</div><div class="line"></div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> next step, get back mediaTypeOptions from negotiate and return the exact value here</span></div><div class="line">	mediaType := serializer.MediaType</div><div class="line">	<span class="keyword">if</span> mediaType != runtime.ContentTypeJSON &#123;</div><div class="line">		mediaType += <span class="string">";stream=watch"</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	server := &amp;WatchServer&#123;</div><div class="line">		watching: watcher,</div><div class="line">		scope:    scope,</div><div class="line"></div><div class="line">		useTextFraming:  useTextFraming,</div><div class="line">		mediaType:       mediaType,</div><div class="line">		framer:          framer,</div><div class="line">		encoder:         encoder,</div><div class="line">		embeddedEncoder: embeddedEncoder,</div><div class="line">		fixup: <span class="function"><span class="keyword">func</span><span class="params">(obj runtime.Object)</span></span> &#123;</div><div class="line">			<span class="keyword">if</span> err := setSelfLink(obj, req, scope.Namer); err != <span class="literal">nil</span> &#123;</div><div class="line">				utilruntime.HandleError(fmt.Errorf(<span class="string">"failed to set link for object %v: %v"</span>, reflect.TypeOf(obj), err))</div><div class="line">			&#125;</div><div class="line">		&#125;,</div><div class="line"></div><div class="line">		t: &amp;realTimeoutFactory&#123;timeout&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	server.ServeHTTP(res.ResponseWriter, req.Request)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>关于List和Watch的操作，以后会在专题进行分析。</p>
<h2 id="UpdateResource"><a href="#UpdateResource" class="headerlink" title="UpdateResource()"></a>UpdateResource()</h2><p>UpdateResource()用于处理更新资源人请求。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// UpdateResource returns a function that will handle a resource update</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">UpdateResource</span><span class="params">(r rest.Updater, scope RequestScope, typer runtime.ObjectTyper, admit admission.Interface)</span> <span class="title">restful</span>.<span class="title">RouteFunction</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(req *restful.Request, res *restful.Response)</span></span> &#123;</div><div class="line">		<span class="comment">// For performance tracking purposes.</span></div><div class="line">		trace := util.NewTrace(<span class="string">"Update "</span> + req.Request.URL.Path)</div><div class="line">		<span class="keyword">defer</span> trace.LogIfLong(<span class="number">500</span> * time.Millisecond)</div><div class="line"></div><div class="line">		w := res.ResponseWriter</div><div class="line"></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> we either want to remove timeout or document it (if we document, move timeout out of this function and declare it in api_installer)</span></div><div class="line">		timeout := parseTimeout(req.Request.URL.Query().Get(<span class="string">"timeout"</span>))</div><div class="line"></div><div class="line">		<span class="comment">//***从Request中获取namespace, name***//</span></div><div class="line">		namespace, name, err := scope.Namer.Name(req)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***创建context，并封装入namespace***//</span></div><div class="line">		ctx := scope.ContextFunc(req)</div><div class="line">		ctx = api.WithNamespace(ctx, namespace)</div><div class="line"></div><div class="line">		body, err := readBody(req.Request)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		s, err := negotiateInputSerializer(req.Request, scope.Serializer)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		defaultGVK := scope.Kind</div><div class="line">		original := r.New()</div><div class="line">		trace.Step(<span class="string">"About to convert to expected version"</span>)</div><div class="line">		obj, gvk, err := scope.Serializer.DecoderToVersion(s.Serializer, defaultGVK.GroupVersion()).Decode(body, &amp;defaultGVK, original)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			err = transformDecodeError(typer, err, original, gvk, body)</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> gvk.GroupVersion() != defaultGVK.GroupVersion() &#123;</div><div class="line">			err = errors.NewBadRequest(fmt.Sprintf(<span class="string">"the API version in the data (%s) does not match the expected API version (%s)"</span>, gvk.GroupVersion(), defaultGVK.GroupVersion()))</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		trace.Step(<span class="string">"Conversion done"</span>)</div><div class="line"></div><div class="line">		<span class="keyword">if</span> err := checkName(obj, name, namespace, scope.Namer); err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">var</span> transformers []rest.TransformFunc</div><div class="line">		<span class="keyword">if</span> admit != <span class="literal">nil</span> &amp;&amp; admit.Handles(admission.Update) &#123;</div><div class="line">			transformers = <span class="built_in">append</span>(transformers, <span class="function"><span class="keyword">func</span><span class="params">(ctx api.Context, newObj, oldObj runtime.Object)</span> <span class="params">(runtime.Object, error)</span></span> &#123;</div><div class="line">				userInfo, _ := api.UserFrom(ctx)</div><div class="line">				<span class="keyword">return</span> newObj, admit.Admit(admission.NewAttributesRecord(newObj, oldObj, scope.Kind, namespace, name, scope.Resource, scope.Subresource, admission.Update, userInfo))</div><div class="line">			&#125;)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		trace.Step(<span class="string">"About to store object in database"</span>)</div><div class="line">		wasCreated := <span class="literal">false</span></div><div class="line">		result, err := finishRequest(timeout, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(runtime.Object, error)</span></span> &#123;</div><div class="line">			<span class="comment">//***更新资源***//</span></div><div class="line">			obj, created, err := r.Update(ctx, name, rest.DefaultUpdatedObjectInfo(obj, scope.Copier, transformers...))</div><div class="line">			wasCreated = created</div><div class="line">			<span class="keyword">return</span> obj, err</div><div class="line">		&#125;)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		trace.Step(<span class="string">"Object stored in database"</span>)</div><div class="line"></div><div class="line">		<span class="keyword">if</span> err := setSelfLink(result, req, scope.Namer); err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		trace.Step(<span class="string">"Self-link added"</span>)</div><div class="line"></div><div class="line">		status := http.StatusOK</div><div class="line">		<span class="keyword">if</span> wasCreated &#123;</div><div class="line">			status = http.StatusCreated</div><div class="line">		&#125;</div><div class="line">		write(status, scope.Kind.GroupVersion(), scope.Serializer, result, w, req.Request)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="PatchResource"><a href="#PatchResource" class="headerlink" title="PatchResource()"></a>PatchResource()</h2><p>用来处理局部更新的请求。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// PatchResource returns a function that will handle a resource patch</span></div><div class="line"><span class="comment">// <span class="doctag">TODO:</span> Eventually PatchResource should just use GuaranteedUpdate and this routine should be a bit cleaner</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">PatchResource</span><span class="params">(r rest.Patcher, scope RequestScope, typer runtime.ObjectTyper, admit admission.Interface, converter runtime.ObjectConvertor)</span> <span class="title">restful</span>.<span class="title">RouteFunction</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(req *restful.Request, res *restful.Response)</span></span> &#123;</div><div class="line">		w := res.ResponseWriter</div><div class="line"></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> we either want to remove timeout or document it (if we</span></div><div class="line">		<span class="comment">// document, move timeout out of this function and declare it in</span></div><div class="line">		<span class="comment">// api_installer)</span></div><div class="line">		timeout := parseTimeout(req.Request.URL.Query().Get(<span class="string">"timeout"</span>))</div><div class="line"></div><div class="line">		namespace, name, err := scope.Namer.Name(req)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		ctx := scope.ContextFunc(req)</div><div class="line">		ctx = api.WithNamespace(ctx, namespace)</div><div class="line"></div><div class="line">		versionedObj, err := converter.ConvertToVersion(r.New(), scope.Kind.GroupVersion())</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> handle this in negotiation</span></div><div class="line">		contentType := req.HeaderParameter(<span class="string">"Content-Type"</span>)</div><div class="line">		<span class="comment">// Remove "; charset=" if included in header.</span></div><div class="line">		<span class="keyword">if</span> idx := strings.Index(contentType, <span class="string">";"</span>); idx &gt; <span class="number">0</span> &#123;</div><div class="line">			contentType = contentType[:idx]</div><div class="line">		&#125;</div><div class="line">		patchType := api.PatchType(contentType)</div><div class="line"></div><div class="line">		patchJS, err := readBody(req.Request)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		s, ok := runtime.SerializerInfoForMediaType(scope.Serializer.SupportedMediaTypes(), runtime.ContentTypeJSON)</div><div class="line">		<span class="keyword">if</span> !ok &#123;</div><div class="line">			scope.err(fmt.Errorf(<span class="string">"no serializer defined for JSON"</span>), res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		gv := scope.Kind.GroupVersion()</div><div class="line">		codec := runtime.NewCodec(</div><div class="line">			scope.Serializer.EncoderForVersion(s.Serializer, gv),</div><div class="line">			scope.Serializer.DecoderToVersion(s.Serializer, unversioned.GroupVersion&#123;Group: gv.Group, Version: runtime.APIVersionInternal&#125;),</div><div class="line">		)</div><div class="line"></div><div class="line">		updateAdmit := <span class="function"><span class="keyword">func</span><span class="params">(updatedObject runtime.Object, currentObject runtime.Object)</span> <span class="title">error</span></span> &#123;</div><div class="line">			<span class="keyword">if</span> admit != <span class="literal">nil</span> &amp;&amp; admit.Handles(admission.Update) &#123;</div><div class="line">				userInfo, _ := api.UserFrom(ctx)</div><div class="line">				<span class="keyword">return</span> admit.Admit(admission.NewAttributesRecord(updatedObject, currentObject, scope.Kind, namespace, name, scope.Resource, scope.Subresource, admission.Update, userInfo))</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		result, err := patchResource(ctx, updateAdmit, timeout, versionedObj, r, name, patchType, patchJS, scope.Namer, scope.Copier, scope.Resource, codec)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> err := setSelfLink(result, req, scope.Namer); err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		write(http.StatusOK, scope.Kind.GroupVersion(), scope.Serializer, result, w, req.Request)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// patchResource divides PatchResource for easier unit testing</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">patchResource</span><span class="params">(</span></span></div><div class="line">	ctx api.Context,</div><div class="line">	admit updateAdmissionFunc,</div><div class="line">	timeout time.Duration,</div><div class="line">	versionedObj runtime.Object,</div><div class="line">	patcher rest.Patcher,</div><div class="line">	name <span class="keyword">string</span>,</div><div class="line">	patchType api.PatchType,</div><div class="line">	patchJS []<span class="keyword">byte</span>,</div><div class="line">	namer ScopeNamer,</div><div class="line">	copier runtime.ObjectCopier,</div><div class="line">	resource unversioned.GroupVersionResource,</div><div class="line">	codec runtime.Codec,</div><div class="line">) <span class="params">(runtime.Object, error)</span> &#123;</div><div class="line"></div><div class="line">	namespace := api.NamespaceValue(ctx)</div><div class="line"></div><div class="line">	<span class="keyword">var</span> (</div><div class="line">		originalObjJS        []<span class="keyword">byte</span></div><div class="line">		originalPatchedObjJS []<span class="keyword">byte</span></div><div class="line">		lastConflictErr      error</div><div class="line">	)</div><div class="line"></div><div class="line">	<span class="comment">// applyPatch is called every time GuaranteedUpdate asks for the updated object,</span></div><div class="line">	<span class="comment">// and is given the currently persisted object as input.</span></div><div class="line">	applyPatch := <span class="function"><span class="keyword">func</span><span class="params">(_ api.Context, _, currentObject runtime.Object)</span> <span class="params">(runtime.Object, error)</span></span> &#123;</div><div class="line">		<span class="comment">// Make sure we actually have a persisted currentObject</span></div><div class="line">		<span class="keyword">if</span> hasUID, err := hasUID(currentObject); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> !hasUID &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, errors.NewNotFound(resource.GroupResource(), name)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">switch</span> &#123;</div><div class="line">		<span class="keyword">case</span> <span class="built_in">len</span>(originalObjJS) == <span class="number">0</span> || <span class="built_in">len</span>(originalPatchedObjJS) == <span class="number">0</span>:</div><div class="line">			<span class="comment">// first time through,</span></div><div class="line">			<span class="comment">// 1. apply the patch</span></div><div class="line">			<span class="comment">// 2. save the originalJS and patchedJS to detect whether there were conflicting changes on retries</span></div><div class="line">			<span class="keyword">if</span> js, err := runtime.Encode(codec, currentObject); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				originalObjJS = js</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> js, err := getPatchedJS(patchType, originalObjJS, patchJS, versionedObj); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				originalPatchedObjJS = js</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			objToUpdate := patcher.New()</div><div class="line">			<span class="keyword">if</span> err := runtime.DecodeInto(codec, originalPatchedObjJS, objToUpdate); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> err := checkName(objToUpdate, name, namespace, namer); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> objToUpdate, <span class="literal">nil</span></div><div class="line"></div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			<span class="comment">// on a conflict,</span></div><div class="line">			<span class="comment">// 1. build a strategic merge patch from originalJS and the patchedJS.  Different patch types can</span></div><div class="line">			<span class="comment">//    be specified, but a strategic merge patch should be expressive enough handle them.  Build the</span></div><div class="line">			<span class="comment">//    patch with this type to handle those cases.</span></div><div class="line">			<span class="comment">// 2. build a strategic merge patch from originalJS and the currentJS</span></div><div class="line">			<span class="comment">// 3. ensure no conflicts between the two patches</span></div><div class="line">			<span class="comment">// 4. apply the #1 patch to the currentJS object</span></div><div class="line">			currentObjectJS, err := runtime.Encode(codec, currentObject)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125;</div><div class="line">			currentPatch, err := strategicpatch.CreateStrategicMergePatch(originalObjJS, currentObjectJS, versionedObj)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125;</div><div class="line">			originalPatch, err := strategicpatch.CreateStrategicMergePatch(originalObjJS, originalPatchedObjJS, versionedObj)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			diff1 := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</div><div class="line">			<span class="keyword">if</span> err := json.Unmarshal(originalPatch, &amp;diff1); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125;</div><div class="line">			diff2 := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</div><div class="line">			<span class="keyword">if</span> err := json.Unmarshal(currentPatch, &amp;diff2); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125;</div><div class="line">			hasConflicts, err := strategicpatch.HasConflicts(diff1, diff2)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> hasConflicts &#123;</div><div class="line">				glog.V(<span class="number">4</span>).Infof(<span class="string">"patchResource failed for resource %s, because there is a meaningful conflict.\n diff1=%v\n, diff2=%v\n"</span>, name, diff1, diff2)</div><div class="line">				<span class="comment">// Return the last conflict error we got if we have one</span></div><div class="line">				<span class="keyword">if</span> lastConflictErr != <span class="literal">nil</span> &#123;</div><div class="line">					<span class="keyword">return</span> <span class="literal">nil</span>, lastConflictErr</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// Otherwise manufacture one of our own</span></div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, errors.NewConflict(resource.GroupResource(), name, <span class="literal">nil</span>)</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			newlyPatchedObjJS, err := getPatchedJS(api.StrategicMergePatchType, currentObjectJS, originalPatch, versionedObj)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125;</div><div class="line">			objToUpdate := patcher.New()</div><div class="line">			<span class="keyword">if</span> err := runtime.DecodeInto(codec, newlyPatchedObjJS, objToUpdate); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> objToUpdate, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// applyAdmission is called every time GuaranteedUpdate asks for the updated object,</span></div><div class="line">	<span class="comment">// and is given the currently persisted object and the patched object as input.</span></div><div class="line">	applyAdmission := <span class="function"><span class="keyword">func</span><span class="params">(ctx api.Context, patchedObject runtime.Object, currentObject runtime.Object)</span> <span class="params">(runtime.Object, error)</span></span> &#123;</div><div class="line">		<span class="keyword">return</span> patchedObject, admit(patchedObject, currentObject)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	updatedObjectInfo := rest.DefaultUpdatedObjectInfo(<span class="literal">nil</span>, copier, applyPatch, applyAdmission)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> finishRequest(timeout, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(runtime.Object, error)</span></span> &#123;</div><div class="line">		updateObject, _, updateErr := patcher.Update(ctx, name, updatedObjectInfo)</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; MaxPatchConflicts &amp;&amp; (errors.IsConflict(updateErr)); i++ &#123;</div><div class="line">			lastConflictErr = updateErr</div><div class="line">			updateObject, _, updateErr = patcher.Update(ctx, name, updatedObjectInfo)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> updateObject, updateErr</div><div class="line">	&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="CreateResource"><a href="#CreateResource" class="headerlink" title="CreateResource()"></a>CreateResource()</h2><p>CreateResource()用来处理创建的请求。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// CreateResource returns a function that will handle a resource creation.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateResource</span><span class="params">(r rest.Creater, scope RequestScope, typer runtime.ObjectTyper, admit admission.Interface)</span> <span class="title">restful</span>.<span class="title">RouteFunction</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> createHandler(&amp;namedCreaterAdapter&#123;r&#125;, scope, typer, admit, <span class="literal">false</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">createHandler</span><span class="params">(r rest.NamedCreater, scope RequestScope, typer runtime.ObjectTyper, admit admission.Interface, includeName <span class="keyword">bool</span>)</span> <span class="title">restful</span>.<span class="title">RouteFunction</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(req *restful.Request, res *restful.Response)</span></span> &#123;</div><div class="line">		<span class="comment">// For performance tracking purposes.</span></div><div class="line">		trace := util.NewTrace(<span class="string">"Create "</span> + req.Request.URL.Path)</div><div class="line">		<span class="keyword">defer</span> trace.LogIfLong(<span class="number">500</span> * time.Millisecond)</div><div class="line"></div><div class="line">		w := res.ResponseWriter</div><div class="line"></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> we either want to remove timeout or document it (if we document, move timeout out of this function and declare it in api_installer)</span></div><div class="line">		timeout := parseTimeout(req.Request.URL.Query().Get(<span class="string">"timeout"</span>))</div><div class="line"></div><div class="line">		<span class="keyword">var</span> (</div><div class="line">			namespace, name <span class="keyword">string</span></div><div class="line">			err             error</div><div class="line">		)</div><div class="line">		<span class="keyword">if</span> includeName &#123;</div><div class="line">			namespace, name, err = scope.Namer.Name(req)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			namespace, err = scope.Namer.Namespace(req)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//***创建context，并封装入namespace变量***//</span></div><div class="line">		ctx := scope.ContextFunc(req)</div><div class="line">		ctx = api.WithNamespace(ctx, namespace)</div><div class="line"></div><div class="line">		gv := scope.Kind.GroupVersion()</div><div class="line">		s, err := negotiateInputSerializer(req.Request, scope.Serializer)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		decoder := scope.Serializer.DecoderToVersion(s.Serializer, unversioned.GroupVersion&#123;Group: gv.Group, Version: runtime.APIVersionInternal&#125;)</div><div class="line"></div><div class="line">		body, err := readBody(req.Request)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		defaultGVK := scope.Kind</div><div class="line">		original := r.New()</div><div class="line">		trace.Step(<span class="string">"About to convert to expected version"</span>)</div><div class="line">		obj, gvk, err := decoder.Decode(body, &amp;defaultGVK, original)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			err = transformDecodeError(typer, err, original, gvk, body)</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> gvk.GroupVersion() != gv &#123;</div><div class="line">			err = errors.NewBadRequest(fmt.Sprintf(<span class="string">"the API version in the data (%s) does not match the expected API version (%v)"</span>, gvk.GroupVersion().String(), gv.String()))</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		trace.Step(<span class="string">"Conversion done"</span>)</div><div class="line"></div><div class="line">		<span class="keyword">if</span> admit != <span class="literal">nil</span> &amp;&amp; admit.Handles(admission.Create) &#123;</div><div class="line">			userInfo, _ := api.UserFrom(ctx)</div><div class="line"></div><div class="line">			err = admit.Admit(admission.NewAttributesRecord(obj, <span class="literal">nil</span>, scope.Kind, namespace, name, scope.Resource, scope.Subresource, admission.Create, userInfo))</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		trace.Step(<span class="string">"About to store object in database"</span>)</div><div class="line">		result, err := finishRequest(timeout, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(runtime.Object, error)</span></span> &#123;</div><div class="line">			<span class="comment">//***处理创建***//</span></div><div class="line">			out, err := r.Create(ctx, name, obj)</div><div class="line">			<span class="keyword">if</span> status, ok := out.(*unversioned.Status); ok &amp;&amp; err == <span class="literal">nil</span> &amp;&amp; status.Code == <span class="number">0</span> &#123;</div><div class="line">				status.Code = http.StatusCreated</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> out, err</div><div class="line">		&#125;)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		trace.Step(<span class="string">"Object stored in database"</span>)</div><div class="line"></div><div class="line">		<span class="keyword">if</span> err := setSelfLink(result, req, scope.Namer); err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		trace.Step(<span class="string">"Self-link added"</span>)</div><div class="line"></div><div class="line">		write(http.StatusCreated, scope.Kind.GroupVersion(), scope.Serializer, result, w, req.Request)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="DeleteResource"><a href="#DeleteResource" class="headerlink" title="DeleteResource()"></a>DeleteResource()</h2><p>DeleteResource()用来处理删除的请求。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DeleteResource returns a function that will handle a resource deletion</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DeleteResource</span><span class="params">(r rest.GracefulDeleter, allowsOptions <span class="keyword">bool</span>, scope RequestScope, admit admission.Interface)</span> <span class="title">restful</span>.<span class="title">RouteFunction</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(req *restful.Request, res *restful.Response)</span></span> &#123;</div><div class="line">		<span class="comment">// For performance tracking purposes.</span></div><div class="line">		trace := util.NewTrace(<span class="string">"Delete "</span> + req.Request.URL.Path)</div><div class="line">		<span class="keyword">defer</span> trace.LogIfLong(<span class="number">500</span> * time.Millisecond)</div><div class="line"></div><div class="line">		w := res.ResponseWriter</div><div class="line"></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> we either want to remove timeout or document it (if we document, move timeout out of this function and declare it in api_installer)</span></div><div class="line">		timeout := parseTimeout(req.Request.URL.Query().Get(<span class="string">"timeout"</span>))</div><div class="line"></div><div class="line">		namespace, name, err := scope.Namer.Name(req)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		ctx := scope.ContextFunc(req)</div><div class="line">		ctx = api.WithNamespace(ctx, namespace)</div><div class="line"></div><div class="line">		options := &amp;api.DeleteOptions&#123;&#125;</div><div class="line">		<span class="comment">//***Fankang***//</span></div><div class="line">		<span class="comment">//***allowsOptions: true***//</span></div><div class="line">		<span class="keyword">if</span> allowsOptions &#123;</div><div class="line">			body, err := readBody(req.Request)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(body) &gt; <span class="number">0</span> &#123;</div><div class="line">				s, err := negotiateInputSerializer(req.Request, scope.Serializer)</div><div class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">					scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">					<span class="keyword">return</span></div><div class="line">				&#125;</div><div class="line">				defaultGVK := scope.Kind.GroupVersion().WithKind(<span class="string">"DeleteOptions"</span>)</div><div class="line">				obj, _, err := scope.Serializer.DecoderToVersion(s.Serializer, defaultGVK.GroupVersion()).Decode(body, &amp;defaultGVK, options)</div><div class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">					scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">					<span class="keyword">return</span></div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> obj != options &#123;</div><div class="line">					scope.err(fmt.Errorf(<span class="string">"decoded object cannot be converted to DeleteOptions"</span>), res.ResponseWriter, req.Request)</div><div class="line">					<span class="keyword">return</span></div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">if</span> values := req.Request.URL.Query(); <span class="built_in">len</span>(values) &gt; <span class="number">0</span> &#123;</div><div class="line">					<span class="keyword">if</span> err := scope.ParameterCodec.DecodeParameters(values, scope.Kind.GroupVersion(), options); err != <span class="literal">nil</span> &#123;</div><div class="line">						scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">						<span class="keyword">return</span></div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> admit != <span class="literal">nil</span> &amp;&amp; admit.Handles(admission.Delete) &#123;</div><div class="line">			userInfo, _ := api.UserFrom(ctx)</div><div class="line"></div><div class="line">			err = admit.Admit(admission.NewAttributesRecord(<span class="literal">nil</span>, <span class="literal">nil</span>, scope.Kind, namespace, name, scope.Resource, scope.Subresource, admission.Delete, userInfo))</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		trace.Step(<span class="string">"About do delete object from database"</span>)</div><div class="line">		result, err := finishRequest(timeout, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(runtime.Object, error)</span></span> &#123;</div><div class="line">			<span class="keyword">return</span> r.Delete(ctx, name, options)</div><div class="line">		&#125;)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		trace.Step(<span class="string">"Object deleted from database"</span>)</div><div class="line"></div><div class="line">		<span class="comment">// if the rest.Deleter returns a nil object, fill out a status. Callers may return a valid</span></div><div class="line">		<span class="comment">// object with the response.</span></div><div class="line">		<span class="keyword">if</span> result == <span class="literal">nil</span> &#123;</div><div class="line">			result = &amp;unversioned.Status&#123;</div><div class="line">				Status: unversioned.StatusSuccess,</div><div class="line">				Code:   http.StatusOK,</div><div class="line">				Details: &amp;unversioned.StatusDetails&#123;</div><div class="line">					Name: name,</div><div class="line">					Kind: scope.Kind.Kind,</div><div class="line">				&#125;,</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// when a non-status response is returned, set the self link</span></div><div class="line">			<span class="keyword">if</span> _, ok := result.(*unversioned.Status); !ok &#123;</div><div class="line">				<span class="keyword">if</span> err := setSelfLink(result, req, scope.Namer); err != <span class="literal">nil</span> &#123;</div><div class="line">					scope.err(err, res.ResponseWriter, req.Request)</div><div class="line">					<span class="keyword">return</span></div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		write(http.StatusOK, scope.Kind.GroupVersion(), scope.Serializer, result, w, req.Request)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/09/29/apiserver分析(六)-resthandler-v1-5-2/" data-id="cj959ubav001s54qsuozyqpv3" class="article-share-link">分享</a><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></div><div class="post-nav"><a href="/2017/09/30/kube-proxy分析(一)-config-v1-5-2/" class="pre">kube-proxy分析(一)-config-v1.5.2</a><a href="/2017/09/28/apiserver分析(五)-APIInstaller-v1-5-2/" class="next">apiserver分析(五)-APIInstaller-v1.5.2</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/24/kube-controller分析(二)-finalizer机制-v1-5-2/">kube-controller分析(二)-finalizer机制-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/19/kube-controller分析(一)-sharedInformerFactory解读-v1-5-2/">kube-controller分析(一)-sharedInformerFactory解读-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/18/kubernetes-client分析(四)-ClientSet-v1-5-2/">kubernetes-client分析(四)-ClientSet-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/16/kubernetes-client分析(三)-dynamicClient-v1-5-2/">kubernetes-client分析(三)-dynamicClient-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/13/kubernetes-client分析(二)-restclient-v1-5-2/">kubernetes-client分析(二)-restclient-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/12/kubernetes-client分析(一)-kubeconfig-v1-5-2/">kubernetes-client分析(一)-kubeconfig-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/09/kubernetes-client-python使用-v1-0-1/">kubernetes-client-python使用-v1.0.1</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/06/GO语言包使用-buffio/">GO语言包使用-buffio</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/06/yaml格式转换分析-YAMLOrJSONDecoder/">yaml格式转换分析-YAMLOrJSONDecoder</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/04/kube-scheduler分析(二)-scheduler-v1-5-2/">kube-scheduler分析(二)-scheduler-v1.5.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>