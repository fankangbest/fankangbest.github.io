<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Docker镜像存储分析-v1.12.3 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Docker镜像存储分析-v1.12.3</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Docker镜像存储分析-v1.12.3</h1><div class="post-meta">Sep 11, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="Docker镜像存储"><a href="#Docker镜像存储" class="headerlink" title="Docker镜像存储"></a>Docker镜像存储</h2><p>本次将分析Docker v1.12.3的AUFS镜像存储目录结构。首先来看镜像的存储录/var/lib/docker/image/aufs，目录下主要有：</p>
<ul>
<li>Distribution: 目前还不知道该目录的用途；</li>
<li>Imagedb: 镜像数据库；</li>
<li>Layerdb: 镜像层数据库；</li>
<li>Repositories.json: 镜像管理入口。</li>
</ul>
<p>为了分析的简便，我们只导入nginx:v1镜像，为了不影响之前的Docker环境，我们从/var/lib/docker1启动Docker，命令如下：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dockerd -H 0.0.0.0:4243 -H unix:///var/run/docker.sock -g /var/lib/docker1</div></pre></td></tr></table></figure></p>
<h2 id="Imagedb"><a href="#Imagedb" class="headerlink" title="Imagedb"></a>Imagedb</h2><p>Imagedb下有两个子目录：</p>
<ul>
<li>Content: 存储镜像的config文件；</li>
<li>Metadata: 里面存有parent信息。</li>
</ul>
<p>所以，进入/var/lib/docker1/image/aufs/imagedb/content/sha256/后，可以看到镜像的config文件:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@fankang:/var/lib/docker1/image/aufs/imagedb/content/sha256# ls</div><div class="line">3034d86f1f0b0379092bb99565d72c1dd4a94b41c1e83bb2d0714bb98720ac16</div></pre></td></tr></table></figure></p>
<p>config文件的名字就是镜像的id号。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@fankang:/var/lib/docker1/image/aufs/imagedb/content/sha256# docker images</div><div class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">nginx               v1                  3034d86f1f0b        2 weeks ago         250.3 MB</div></pre></td></tr></table></figure></p>
<p>那么，该config文件是从来的呢。我们可以把镜像的tar包解压：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">root@fankang:/home/fankang/nginx# ls</div><div class="line">01a90859e4ca4e3138adbadb3a76be9014b0ea5b89b6ef24988e70e7d7bfe12b       90627bd0fa0408d7488e79525d6b2810987c5ed579f7f649993ca29a1d819a69</div><div class="line">0cfdb29ee5612340e908c304954decd7a2c001405abeb475d8e773f66071211b       a599739916ea730466ba3a21e5493faf34808cbddc8c3570933048d604cde37d</div><div class="line">2a9bb8e69f5a34ead65daecf9ff156975e13c5a29bb27b0c93de879c2787d616       aa1b48ac3dd21b33515f37763a1f4cafce662496c6ed3c13326a818d8669f06a</div><div class="line">3034d86f1f0b0379092bb99565d72c1dd4a94b41c1e83bb2d0714bb98720ac16.json  e27a3a829a7d9d07bec30f000c722c47e428f9c4cc975dbe2b0dbffda189a8f7</div><div class="line">3fbeaf15931df30802b43e1147f6c40d3cbe2839bb91e49cf068e58dadb3ec90       manifest.json</div><div class="line">707f1f25f845bd495c21c368a57666f6c4e1b0358868e43e0376fd55512f8734       nginx.tar</div><div class="line">77b9c04c054e859ffc5d0bb6d89084dd543ffc2386ffbe17da7bc43147c10d49       repositories</div></pre></td></tr></table></figure></p>
<p>所以该config文件就是镜像中的<br><code>3034d86f1f0b0379092bb99565d72c1dd4a94b41c1e83bb2d0714bb98720ac16.json</code><br>其中，3034d86f1f0b0379092bb99565d72c1dd4a94b41c1e83bb2d0714bb98720ac16直接可以通过config的内容计算sha256得出。<br>在config文件中，我们关心的是rootfs字段：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="string">"rootfs"</span>: &#123;</div><div class="line">       <span class="string">"diff_ids"</span>: [</div><div class="line">           <span class="string">"sha256:8aa4fcad5eeb286fe9696898d988dc85503c6392d1a2bd9023911fb0d6d27081"</span>,</div><div class="line">           <span class="string">"sha256:25e0901a71b8c6a9df21590604a70517eb7b074071ef6af1033d50037baf3dd5"</span>,</div><div class="line">           <span class="string">"sha256:625c7a2a783b4736cf488efd1fafc41736b9998ec087e20da946c30522ec9ad7"</span>,</div><div class="line">           <span class="string">"sha256:9c42c2077cdea659ac116f148b63ded203d0e83f017accb6d7987377d1363673"</span>,</div><div class="line">           <span class="string">"sha256:a09947e71dc0d591901870f2fd3c18565339b960f6bb32793d14604a85d67393"</span>,</div><div class="line">           <span class="string">"sha256:1f73bd8df68529ff86d8ab3b3455abba4963022300efd4a04d95f1ef3a481dee"</span>,</div><div class="line">           <span class="string">"sha256:fc244f26c293eb5d1356b722a32f71276905297c8786ee1496ce8c903f4025a4"</span>,</div><div class="line">           <span class="string">"sha256:1f6eae413b5cfb474c168aa0e310f5584997f143d2fcea55f20014984c8cd2ca"</span>,</div><div class="line">           <span class="string">"sha256:f17d12637d6ffe31ae5ba3c35efa3ebd672b43ff81767960a65c1982bf7d279d"</span>,</div><div class="line">           <span class="string">"sha256:25d2e7a667f6eadfdc3da7f1f21ab0a6068337a338482f9e587d9bac2d4157ad"</span></div><div class="line">       ],</div><div class="line">       <span class="string">"type"</span>: <span class="string">"layers"</span></div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这些diff_id可以由具体镜像层的tar包哈希得到。<br>在系统中，rootfs的类型为layers，所以我们将进入到layerdb目录的分析。</p>
<h2 id="Layerdb"><a href="#Layerdb" class="headerlink" title="Layerdb"></a>Layerdb</h2><p>Layerdb下有如下目录：</p>
<ul>
<li>Mounts: 记录容器的挂载点，即启动目录；</li>
<li>Sha256: 存储layer信息；</li>
<li>Tmp: 临时目录，存储layer信息用。</li>
</ul>
<p>在Mounts目录中，有：</p>
<ul>
<li>Init-id: 容器的init目录；</li>
<li>Mount-id: 容器的启动目录；</li>
<li>Parent: 容器的最后一层的chain-id。</li>
</ul>
<p>现在以nginx:v1启动一个容器，则在Mounts目录中生成该容器挂载点的信息。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">root@fankang:/var/lib/docker1/image/aufs/layerdb/mounts# docker ps</div><div class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</div><div class="line">9971a7b3da13        nginx:v1            "/usr/bin/supervisord"   56 seconds ago      Up 55 seconds       80/tcp              high_goldberg</div><div class="line"></div><div class="line">root@fankang:/var/lib/docker1/image/aufs/layerdb/mounts# ls</div><div class="line">9971a7b3da13cc592fc86c7da752cc5b88ec7e7e11a89f12b7376040d1416815</div></pre></td></tr></table></figure></p>
<p>在9971a7b3da13cc592fc86c7da752cc5b88ec7e7e11a89f12b7376040d1416815中:<br>Init-id: 017e4953d35ca28c875c4c88373be77ddcc499e7d1252188d68decbd2ae1bd68-init<br>Mount-id: 017e4953d35ca28c875c4c88373be77ddcc499e7d1252188d68decbd2ae1bd68<br>Parent: sha256:238adf0419800e0628fc8b69d0c9087847754e9155f871d2169920995bc987c6<br>显然，init-id和mount-id在aufs存储中都能找到对应的目录；parent在layerdb中也能找到目录。</p>
<p>在sha256中有：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">root@fankang:/<span class="keyword">var</span>/lib/docker1/image/aufs/layerdb/sha256# ls</div><div class="line"><span class="number">238</span>adf0419800e0628fc8b69d0c9087847754e9155f871d2169920995bc987c6  <span class="number">508</span>ceb742ac26b43bdda819674a5f1d33f7b64c1708e123a33e066cb147e2841</div><div class="line"><span class="number">2f</span>72738e9826d32bca9f97513aac63c16d9214e00a18f43b6240bc024910d96e  <span class="number">5270</span>b8fe5160d690ece1e6713d6570c31bd3d2462ffb02046a29e7495d7427cd</div><div class="line"><span class="number">364d</span>c483ed8e64e16064dc1ecf3c4a8de82fe7f8ed757978f8b0f9df125d67b3  <span class="number">8</span>aa4fcad5eeb286fe9696898d988dc85503c6392d1a2bd9023911fb0d6d27081</div><div class="line"><span class="number">476e873d</span>f78db8c0ec59a9759d9a19a66a818d89f5256942da7254bcb211c616  a2982ed568b83721067818425290d6958823ec7bb690b43d412aad6c273dbd23</div><div class="line"><span class="number">4f</span>10a8fd56139304ad81be75a6ac056b526236496f8c06b494566010942d8d32  cb5450c7bb149c39829e9ae4a83540c701196754746e547d9439d9cc59afe798</div></pre></td></tr></table></figure></p>
<p>可以发现，sha256中的目录个数(chain-id)和镜像config rootfs中的layer个数一致。接下来将说明如何从镜像的diff_ids计算出chain-id。<br>先再来看一遍diff_ids:<br>“sha256:8aa4fcad5eeb286fe9696898d988dc85503c6392d1a2bd9023911fb0d6d27081”,<br>“sha256:25e0901a71b8c6a9df21590604a70517eb7b074071ef6af1033d50037baf3dd5”,<br>“sha256:625c7a2a783b4736cf488efd1fafc41736b9998ec087e20da946c30522ec9ad7”,<br>“sha256:9c42c2077cdea659ac116f148b63ded203d0e83f017accb6d7987377d1363673”,<br>“sha256:a09947e71dc0d591901870f2fd3c18565339b960f6bb32793d14604a85d67393”,<br>“sha256:1f73bd8df68529ff86d8ab3b3455abba4963022300efd4a04d95f1ef3a481dee”,<br>“sha256:fc244f26c293eb5d1356b722a32f71276905297c8786ee1496ce8c903f4025a4”,<br>“sha256:1f6eae413b5cfb474c168aa0e310f5584997f143d2fcea55f20014984c8cd2ca”,<br>“sha256:f17d12637d6ffe31ae5ba3c35efa3ebd672b43ff81767960a65c1982bf7d279d”,<br>“sha256:25d2e7a667f6eadfdc3da7f1f21ab0a6068337a338482f9e587d9bac2d4157ad”<br>第一个diff_id为”sha256:8aa4fcad5eeb286fe9696898d988dc85503c6392d1a2bd9023911fb0d6d27081”，<br>则其对应的chain_id为”8aa4fcad5eeb286fe9696898d988dc85503c6392d1a2bd9023911fb0d6d27081”；<br>第二个diff_id为”sha256:25e0901a71b8c6a9df21590604a70517eb7b074071ef6af1033d50037baf3dd5”，先把该diff_id与前面的chain_id合并：<br>“sha256:8aa4fcad5eeb286fe9696898d988dc85503c6392d1a2bd9023911fb0d6d27081 sha256:25e0901a71b8c6a9df21590604a70517eb7b074071ef6af1033d50037baf3dd5”<br>然后哈希得到对应的chain_id: 508ceb742ac26b43bdda819674a5f1d33f7b64c1708e123a33e066cb147e2841。<br>第三个diff_id为”sha256:625c7a2a783b4736cf488efd1fafc41736b9998ec087e20da946c30522ec9ad7”，先合并：<br>“sha256:508ceb742ac26b43bdda819674a5f1d33f7b64c1708e123a33e066cb147e2841 sha256:625c7a2a783b4736cf488efd1fafc41736b9998ec087e20da946c30522ec9ad7”<br>再哈希得：4f10a8fd56139304ad81be75a6ac056b526236496f8c06b494566010942d8d32。<br>依此类推。<br>具体如何进行hash见附录。<br>其计算代码如下，核心是一个递归：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// CreateChainID returns ID for a layerDigest slice</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateChainID</span><span class="params">(dgsts []DiffID)</span> <span class="title">ChainID</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> createChainIDFromParent(<span class="string">""</span>, dgsts...)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">createChainIDFromParent</span><span class="params">(parent ChainID, dgsts ...DiffID)</span> <span class="title">ChainID</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(dgsts) == <span class="number">0</span> &#123;</div><div class="line">        <span class="keyword">return</span> parent</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> parent == <span class="string">""</span> &#123;</div><div class="line">        <span class="keyword">return</span> createChainIDFromParent(ChainID(dgsts[<span class="number">0</span>]), dgsts[<span class="number">1</span>:]...)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// H = "H(n-1) SHA256(n)"</span></div><div class="line">    dgst := digest.FromBytes([]<span class="keyword">byte</span>(<span class="keyword">string</span>(parent) + <span class="string">" "</span> + <span class="keyword">string</span>(dgsts[<span class="number">0</span>])))</div><div class="line">    <span class="keyword">return</span> createChainIDFromParent(ChainID(dgst), dgsts[<span class="number">1</span>:]...)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>知道了如何计算chain-id之后，我们来看下layerdb中具体的文件，以8aa4fcad5eeb286fe9696898d988dc85503c6392d1a2bd9023911fb0d6d27081目录为例：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@fankang:/var/lib/docker1/image/aufs/layerdb/sha256/8aa4fcad5eeb286fe9696898d988dc85503c6392d1a2bd9023911fb0d6d27081# ls</div><div class="line">cache-id  diff  size  tar-split.json.gz</div></pre></td></tr></table></figure></p>
<p>其中：</p>
<ul>
<li>Cache-id: 记录该层在AUFS存储中对应的目录；</li>
<li>Diff: 记录该层的tar包的hash值；</li>
<li>Size: 该层的大小；</li>
<li>Tar.split.json.gz: 存储了镜像层tar包，具体原理详见<a href="https://github.com/vbatts/tar-split/blob/master/cmd/tar-split/README.md。" target="_blank" rel="external">https://github.com/vbatts/tar-split/blob/master/cmd/tar-split/README.md。</a></li>
</ul>
<p>Cache-id是一个随机生成的值，是layer和AUFS存储的纽带。</p>
<p>再来看来如何计算Diff值，Diff的值即之前提到过的diff_ids的值。<br>在解压开的镜像中，有manifest.json文件：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">    &#123;</div><div class="line">        "Config": "3034d86f1f0b0379092bb99565d72c1dd4a94b41c1e83bb2d0714bb98720ac16.json",</div><div class="line">        "Layers": [</div><div class="line">            "707f1f25f845bd495c21c368a57666f6c4e1b0358868e43e0376fd55512f8734/layer.tar",</div><div class="line">            "3fbeaf15931df30802b43e1147f6c40d3cbe2839bb91e49cf068e58dadb3ec90/layer.tar",</div><div class="line">            "a599739916ea730466ba3a21e5493faf34808cbddc8c3570933048d604cde37d/layer.tar",</div><div class="line">            "0cfdb29ee5612340e908c304954decd7a2c001405abeb475d8e773f66071211b/layer.tar",</div><div class="line">            "aa1b48ac3dd21b33515f37763a1f4cafce662496c6ed3c13326a818d8669f06a/layer.tar",</div><div class="line">            "90627bd0fa0408d7488e79525d6b2810987c5ed579f7f649993ca29a1d819a69/layer.tar",</div><div class="line">            "2a9bb8e69f5a34ead65daecf9ff156975e13c5a29bb27b0c93de879c2787d616/layer.tar",</div><div class="line">            "01a90859e4ca4e3138adbadb3a76be9014b0ea5b89b6ef24988e70e7d7bfe12b/layer.tar",</div><div class="line">            "e27a3a829a7d9d07bec30f000c722c47e428f9c4cc975dbe2b0dbffda189a8f7/layer.tar",</div><div class="line">            "77b9c04c054e859ffc5d0bb6d89084dd543ffc2386ffbe17da7bc43147c10d49/layer.tar"</div><div class="line">        ],</div><div class="line">        "RepoTags": [</div><div class="line">            "nginx:v1"</div><div class="line">        ]</div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure></p>
<p>其中config字段为config的文件名，RepoTags标明镜像名，Layers为镜像tar包中的存储位置。Layers的个数与rootfs中的diff_ids一致，所以第一个layer对应的目录就是707f1f25f845bd495c21c368a57666f6c4e1b0358868e43e0376fd55512f8734/(该id计算方法见附录，hash的内容由代码生成)，该目录下有layer.tar文件，计算哈希值得：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@fankang:/home/fankang/nginx/707f1f25f845bd495c21c368a57666f6c4e1b0358868e43e0376fd55512f8734# sha256sum layer.tar </div><div class="line">8aa4fcad5eeb286fe9696898d988dc85503c6392d1a2bd9023911fb0d6d27081  layer.tar</div></pre></td></tr></table></figure></p>
<p>这与8aa4fcad5eeb286fe9696898d988dc85503c6392d1a2bd9023911fb0d6d27081目录下的diff文件中的值一样。<br>其他层也是如此。</p>
<p>Size就是layer的大小的字节表示，与ll命令查看的有些误差，但相差很小。</p>
<h2 id="repositories-json"><a href="#repositories-json" class="headerlink" title="repositories.json"></a>repositories.json</h2><p>repositories.json标明了系统中的镜像：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">root@fankang:/var/lib/docker1/image/aufs# cat repositories.json | python -mjson.tool</div><div class="line">&#123;</div><div class="line">    "Repositories": &#123;</div><div class="line">        "nginx": &#123;</div><div class="line">            "nginx:v1": "sha256:3034d86f1f0b0379092bb99565d72c1dd4a94b41c1e83bb2d0714bb98720ac16"</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如上图所示，该文件说明系统中有nginx:v1镜像，镜像的id为3034d86f1f0b0379092bb99565d72c1dd4a94b41c1e83bb2d0714bb98720ac16。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>系统的Image存储相当于实现了一个Image数据库。其中从的索引为repositories.json，里面可以获取到镜像的config文件。从镜像的config文件，可以计算出镜像每层的chain-id，这样就可以从layerdb中找到该层在AUFS中的存储目录。其中镜像的挂载点也存储在layerdb中。</p>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="GO语言如何求hash"><a href="#GO语言如何求hash" class="headerlink" title="GO语言如何求hash"></a>GO语言如何求hash</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    sha256 <span class="string">"crypto/sha256"</span></div><div class="line">    <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    s := <span class="string">"sha256:860708544664c614b8ab025d5d01ba8f37694e939fd02ce861538bfd7c64cc43 sha256:f370efdef91872f8e309b38636aec6fc3a51cae8ee8d44c59f6328a6c5d16def"</span></div><div class="line">    h := sha256.New()</div><div class="line">    h.Write([]<span class="keyword">byte</span>(s))</div><div class="line">    bs := h.Sum(<span class="literal">nil</span>)</div><div class="line">    fmt.Printf(<span class="string">"%x"</span>, bs)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>用sha256sum求与GO语言求得到的结果不一样，因为cat或echo会在字符串后加’\n’。可以通过echo -n来解决。</p>
<h3 id="镜像tar包中manifest-json中的layer值计算"><a href="#镜像tar包中manifest-json中的layer值计算" class="headerlink" title="镜像tar包中manifest.json中的layer值计算"></a>镜像tar包中manifest.json中的layer值计算</h3><p>Layer值依据镜像层的config生成。如sha256:ea9f151abb7e06353e73172dad421235611d4f6d0560ec95db26e0dc240642c1对应的configJSON为：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"container_config"</span>:&#123;<span class="attr">"Hostname"</span>:<span class="string">""</span>,<span class="attr">"Domainname"</span>:<span class="string">""</span>,<span class="attr">"User"</span>:<span class="string">""</span>,<span class="attr">"AttachStdin"</span>:<span class="literal">false</span>,<span class="attr">"AttachStdout"</span>:<span class="literal">false</span>,<span class="attr">"AttachStderr"</span>:<span class="literal">false</span>,<span class="attr">"Tty"</span>:<span class="literal">false</span>,<span class="attr">"OpenStdin"</span>:<span class="literal">false</span>,<span class="attr">"StdinOnce"</span>:<span class="literal">false</span>,<span class="attr">"Env"</span>:<span class="literal">null</span>,<span class="attr">"Cmd"</span>:<span class="literal">null</span>,<span class="attr">"Image"</span>:<span class="string">""</span>,<span class="attr">"Volumes"</span>:<span class="literal">null</span>,<span class="attr">"WorkingDir"</span>:<span class="string">""</span>,<span class="attr">"Entrypoint"</span>:<span class="literal">null</span>,<span class="attr">"OnBuild"</span>:<span class="literal">null</span>,<span class="attr">"Labels"</span>:<span class="literal">null</span>&#125;,<span class="attr">"created"</span>:<span class="string">"0001-01-01T00:00:00Z"</span>,<span class="attr">"layer_id"</span>:<span class="string">"sha256:ea9f151abb7e06353e73172dad421235611d4f6d0560ec95db26e0dc240642c1"</span>&#125;</div></pre></td></tr></table></figure></p>
<p>该configJSON值从Docker源码中得到，对该configJSON求Hash(注意，此例子和nginx:v1无关系)：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> ( </div><div class="line">    sha256 <span class="string">"crypto/sha256"</span></div><div class="line">    <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    s := <span class="string">"&#123;\"container_config\":&#123;\"Hostname\":\"\",\"Domainname\":\"\",\"User\":\"\",\"AttachStdin\":false,\"AttachStdout\":false,\"AttachStderr\":false,\"Tty\":false,\"OpenStdin\":false,\"StdinOnce\":false,\"Env\":null,\"Cmd\":null,\"Image\":\"\",\"Volumes\":null,\"WorkingDir\":\"\",\"Entrypoint\":null,\"OnBuild\":null,\"Labels\":null&#125;,\"created\":\"0001-01-01T00:00:00Z\",\"layer_id\":\"sha256:ea9f151abb7e06353e73172dad421235611d4f6d0560ec95db26e0dc240642c1\"&#125;"</span></div><div class="line">    h := sha256.New()</div><div class="line">    h.Write([]<span class="keyword">byte</span>(s))</div><div class="line">    bs := h.Sum(<span class="literal">nil</span>)</div><div class="line">    fmt.Printf(<span class="string">"%x"</span>, bs)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>得到该层对应的值为：2b8a5cc36c07cfb2a5bd6e40f9d5dd52fb300ab1a7afb6e22b3d977e3cfcb885，与manifest.json中的值保持一致。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/09/11/Docker镜像存储分析-v1-12-3/" data-id="cjbnggi7z000i5sqsv5pqaw7p" class="article-share-link">分享</a><div class="tags"><a href="/tags/docker/">docker</a><a href="/tags/docker-v1-12-3/">docker-v1.12.3</a></div><div class="post-nav"><a href="/2017/09/18/apiserver分析(二)-authorizer-v1-5-2/" class="pre">apiserver分析(二)-authorizer-v1.5.2</a><a href="/2017/09/07/resourcequota分析(二)-quota-v1-5-2/" class="next">resourcequota分析(二)-quota-v1.5.2</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/26/tar-stream-demo/">tar-stream-demo</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/25/Docker命令分行分析-run-v1-12-3/">Docker命令分行分析-run-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/23/kubelet分析(七)-dockerManager(2)-v1-5-2/">kubelet分析(七)-dockerManager(2)-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/23/kubelet分析(七)-dockerManager(1)-v1-5-2/">kubelet分析(七)-dockerManager(1)-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/20/kubelet分析(六)-proberManager-v1-5-2/">kubelet分析(六)-proberManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/18/kubelet分析(五)-podManager-v1-5-2/">kubelet分析(五)-podManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(四)-statusManager-v1-5-2/">kubelet分析(四)-statusManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/kubelet分析(三)-volumeManager-v1-5-2/">kubelet分析(三)-volumeManager-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/kubelet分析(二)-podWorker-v1-5-2/">kubelet分析(二)-podWorker-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/kubelet分析(一)-config-v1-5-2/">kubelet分析(一)-config-v1.5.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>