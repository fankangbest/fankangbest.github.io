<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Scheme机制解读(一)-Scheme-v1.5.2 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Scheme机制解读(一)-Scheme-v1.5.2</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Scheme机制解读(一)-Scheme-v1.5.2</h1><div class="post-meta">Jul 27, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="什么是Scheme"><a href="#什么是Scheme" class="headerlink" title="什么是Scheme"></a>什么是Scheme</h2><p>如果说RESTMapper管理的是GVR和GVK的关系，那么Scheme管理的就是GVK和Type的关系。系统中所有的Type都要注册到Scheme中，当然目前系统只有一个Scheme，即api.Scheme，定义在/pkg/api/register.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***定义Scheme***//</span></div><div class="line"><span class="keyword">var</span> Scheme = runtime.NewScheme()</div></pre></td></tr></table></figure></p>
<p>我们先来看下Scheme结构体的定义，Scheme结构体定义在/pkg/runtime/scheme.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Scheme <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// versionMap allows one to figure out the go type of an object with</span></div><div class="line">	<span class="comment">// the given version and name.</span></div><div class="line">	gvkToType <span class="keyword">map</span>[unversioned.GroupVersionKind]reflect.Type</div><div class="line"></div><div class="line">	<span class="comment">// typeToGroupVersion allows one to find metadata for a given go object.</span></div><div class="line">	<span class="comment">// The reflect.Type we index by should *not* be a pointer.</span></div><div class="line">	<span class="comment">//***kind, gvk:  v1.ListOptions authorization.k8s.io/v1beta1, Kind=ListOptions***//</span></div><div class="line">	<span class="comment">//***kind, gvk:  v1.ListOptions apps/v1beta1, Kind=ListOptions***//</span></div><div class="line">	typeToGVK <span class="keyword">map</span>[reflect.Type][]unversioned.GroupVersionKind</div><div class="line"></div><div class="line">	<span class="comment">// unversionedTypes are transformed without conversion in ConvertToVersion.</span></div><div class="line">	unversionedTypes <span class="keyword">map</span>[reflect.Type]unversioned.GroupVersionKind</div><div class="line"></div><div class="line">	<span class="comment">// unversionedKinds are the names of kinds that can be created in the context of any group</span></div><div class="line">	<span class="comment">// or version</span></div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> resolve the status of unversioned types.</span></div><div class="line">	unversionedKinds <span class="keyword">map</span>[<span class="keyword">string</span>]reflect.Type</div><div class="line"></div><div class="line">	<span class="comment">// Map from version and resource to the corresponding func to convert</span></div><div class="line">	<span class="comment">// resource field labels in that version to internal version.</span></div><div class="line">	<span class="comment">//***field selector转换函数***//</span></div><div class="line">	fieldLabelConversionFuncs <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">string</span>]FieldLabelConversionFunc</div><div class="line"></div><div class="line">	<span class="comment">// defaulterFuncs is an array of interfaces to be called with an object to provide defaulting</span></div><div class="line">	<span class="comment">// the provided object must be a pointer.</span></div><div class="line">	<span class="comment">//***默认值设置函数***//</span></div><div class="line">	defaulterFuncs <span class="keyword">map</span>[reflect.Type]<span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span></span></div><div class="line"></div><div class="line">	// <span class="title">converter</span> <span class="title">stores</span> <span class="title">all</span> <span class="title">registered</span> <span class="title">conversion</span> <span class="title">functions</span>. <span class="title">It</span> <span class="title">also</span> <span class="title">has</span></div><div class="line">	// <span class="title">default</span> <span class="title">coverting</span> <span class="title">behavior</span>.</div><div class="line">	//***聚合<span class="title">converter</span>结构体***//</div><div class="line">	<span class="title">converter</span> *<span class="title">conversion</span>.<span class="title">Converter</span></div><div class="line"></div><div class="line">	// <span class="title">cloner</span> <span class="title">stores</span> <span class="title">all</span> <span class="title">registered</span> <span class="title">copy</span> <span class="title">functions</span>. <span class="title">It</span> <span class="title">also</span> <span class="title">has</span> <span class="title">default</span></div><div class="line">	// <span class="title">deep</span> <span class="title">copy</span> <span class="title">behavior</span>.</div><div class="line">	//***<span class="title">Fankang</span>***//</div><div class="line">	//***聚合<span class="title">cloner</span>结构体***//</div><div class="line">	<span class="title">cloner</span> *<span class="title">conversion</span>.<span class="title">Cloner</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，Scheme除了管理GVK和Type的关系，还管理有默认设置函数，并聚合了converter及cloner。我们来详细看下每个字段的含义：</p>
<ul>
<li>gvkToType: 存储gvk和Type的关系，一个gvk只能对应一个Type；</li>
<li>typeToGVK：存储Type和gvk的关系，一个type可能对应多个GVK；</li>
<li>unversionedTypes：记录unversioned的Type和GVK的关系，unversioned无需版本转换；</li>
<li>unversionedKinds：记录unversioned的GVK和Type的关系；</li>
<li>fieldLabelConversionFuncs：管理field selector的转换，如旧版本v1的spec.host需要转换成spec.nodeName(详见在/pkg/api/v1/conversion.go中的addConversionFuncs()函数)；</li>
<li>defaulterFuncs：存储Type及其对应的默认值设置函数；</li>
<li>converter：用来转换不同版本的结构体值；</li>
<li>cloner：用来获取结构体值的拷贝。</li>
</ul>
<p>Kubernetes内部组件的流通的结构体值使用的是内部版本，所有的外部版本都要向内部版本进行转换；内部版本必须转换成外部版本才能进行输出。外部版本之间不能直接转换。</p>
<p>从Scheme的定义可以看出，Scheme是个converter，也是个cloner，关于converter和cloner，后续分析。</p>
<h2 id="NewScheme"><a href="#NewScheme" class="headerlink" title="NewScheme()"></a>NewScheme()</h2><p>NewScheme()可以生成一个新的Scheme，其中cloner调用conversion.NewCloner()初始化，conversion.NewConverter()初始化。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewScheme creates a new Scheme. This scheme is pluggable by default.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewScheme</span><span class="params">()</span> *<span class="title">Scheme</span></span> &#123;</div><div class="line">	s := &amp;Scheme&#123;</div><div class="line">		gvkToType:        <span class="keyword">map</span>[unversioned.GroupVersionKind]reflect.Type&#123;&#125;,</div><div class="line">		typeToGVK:        <span class="keyword">map</span>[reflect.Type][]unversioned.GroupVersionKind&#123;&#125;,</div><div class="line">		unversionedTypes: <span class="keyword">map</span>[reflect.Type]unversioned.GroupVersionKind&#123;&#125;,</div><div class="line">		unversionedKinds: <span class="keyword">map</span>[<span class="keyword">string</span>]reflect.Type&#123;&#125;,</div><div class="line">		cloner:           conversion.NewCloner(),</div><div class="line">		fieldLabelConversionFuncs: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">string</span>]FieldLabelConversionFunc&#123;&#125;,</div><div class="line">		defaulterFuncs:            <span class="keyword">map</span>[reflect.Type]<span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span></span>&#123;&#125;,</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***converter使用的是nameFunc***//</span></div><div class="line">	s.converter = conversion.NewConverter(s.nameFunc)</div><div class="line"></div><div class="line">	s.AddConversionFuncs(DefaultEmbeddedConversions()...)</div><div class="line"></div><div class="line">	<span class="comment">// Enable map[string][]string conversions by default</span></div><div class="line">	<span class="keyword">if</span> err := s.AddConversionFuncs(DefaultStringConversions...); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := s.RegisterInputDefaults(&amp;<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>&#123;&#125;, JSONKeyMapper, conversion.AllowDifferentFieldTypeNames|conversion.IgnoreMissingFields); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> err := s.RegisterInputDefaults(&amp;url.Values&#123;&#125;, JSONKeyMapper, conversion.AllowDifferentFieldTypeNames|conversion.IgnoreMissingFields); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> s</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddUnversionedTypes"><a href="#AddUnversionedTypes" class="headerlink" title="AddUnversionedTypes()"></a>AddUnversionedTypes()</h2><p>AddUnversionedTypes()方法可以向Scheme注册unvertioned type，方法先调用AddKnownTypes()，然后填充unversionedTypes和unversionedKinds两个map，在/api/register.go中有调用。Unversioned type不需要进行转换。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddUnversionedTypes</span><span class="params">(version unversioned.GroupVersion, types ...Object)</span></span> &#123;</div><div class="line">	s.AddKnownTypes(version, types...)</div><div class="line">	<span class="keyword">for</span> _, obj := <span class="keyword">range</span> types &#123;</div><div class="line">		t := reflect.TypeOf(obj).Elem()</div><div class="line">		gvk := version.WithKind(t.Name())</div><div class="line">		s.unversionedTypes[t] = gvk</div><div class="line">		<span class="keyword">if</span> _, ok := s.unversionedKinds[gvk.Kind]; ok &#123;</div><div class="line">			<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"%v has already been registered as unversioned kind %q - kind name must be unique"</span>, reflect.TypeOf(t), gvk.Kind))</div><div class="line">		&#125;</div><div class="line">		s.unversionedKinds[gvk.Kind] = t</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddKnownTypes"><a href="#AddKnownTypes" class="headerlink" title="AddKnownTypes()"></a>AddKnownTypes()</h2><p>AddKnownTypes()为Scheme的type注册函数，参数为GV及types，其中types和GV先组成GVK，然后向gvkToType和typeToGVK填充Type和GVK的关系。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***把types在Scheme中注册***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddKnownTypes</span><span class="params">(gv unversioned.GroupVersion, types ...Object)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(gv.Version) == <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"version is required on all types: %s %v"</span>, gv, types[<span class="number">0</span>]))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> _, obj := <span class="keyword">range</span> types &#123;</div><div class="line">		t := reflect.TypeOf(obj)</div><div class="line">		<span class="keyword">if</span> t.Kind() != reflect.Ptr &#123;</div><div class="line">			<span class="built_in">panic</span>(<span class="string">"All types must be pointers to structs."</span>)</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***Elem()能对指针进行解引用***//</span></div><div class="line">		t = t.Elem()</div><div class="line">		<span class="keyword">if</span> t.Kind() != reflect.Struct &#123;</div><div class="line">			<span class="built_in">panic</span>(<span class="string">"All types must be pointers to structs."</span>)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		gvk := gv.WithKind(t.Name())</div><div class="line">		<span class="comment">//***一个GVK只能对应一个type***//</span></div><div class="line">		s.gvkToType[gvk] = t</div><div class="line">		<span class="comment">//***t, gvk:  v1.Event /v1, Kind=Event***//</span></div><div class="line">		<span class="comment">//***同一个type，可能对应多个gvk***//</span></div><div class="line">		s.typeToGVK[t] = <span class="built_in">append</span>(s.typeToGVK[t], gvk)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddKnownTypeWithName"><a href="#AddKnownTypeWithName" class="headerlink" title="AddKnownTypeWithName()"></a>AddKnownTypeWithName()</h2><p>AddKnownTypeWithName()可以指定object对应的gvk。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***可以指定obj的kind，而不用像AddKnownTypes()去反射获取type的name作为kind***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddKnownTypeWithName</span><span class="params">(gvk unversioned.GroupVersionKind, obj Object)</span></span> &#123;</div><div class="line">	t := reflect.TypeOf(obj)</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(gvk.Version) == <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"version is required on all types: %s %v"</span>, gvk, t))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> t.Kind() != reflect.Ptr &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"All types must be pointers to structs."</span>)</div><div class="line">	&#125;</div><div class="line">	t = t.Elem()</div><div class="line">	<span class="keyword">if</span> t.Kind() != reflect.Struct &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"All types must be pointers to structs."</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	s.gvkToType[gvk] = t</div><div class="line">	s.typeToGVK[t] = <span class="built_in">append</span>(s.typeToGVK[t], gvk)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="KnownTypes"><a href="#KnownTypes" class="headerlink" title="KnownTypes()"></a>KnownTypes()</h2><p>KnownTypes()返回Scheme中具体版本下的gvk和type的map关系。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***通过gv在scheme中找到所有合适的types***//</span></div><div class="line"><span class="comment">//***具体gv下的kind唯一***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">KnownTypes</span><span class="params">(gv unversioned.GroupVersion)</span> <span class="title">map</span>[<span class="title">string</span>]<span class="title">reflect</span>.<span class="title">Type</span></span> &#123;</div><div class="line">	types := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]reflect.Type)</div><div class="line">	<span class="keyword">for</span> gvk, t := <span class="keyword">range</span> s.gvkToType &#123;</div><div class="line">		<span class="keyword">if</span> gv != gvk.GroupVersion() &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		types[gvk.Kind] = t</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> types</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AllKnownTypes"><a href="#AllKnownTypes" class="headerlink" title="AllKnownTypes()"></a>AllKnownTypes()</h2><p>AllKnownTypes()返回Scheme中所有版本的gvk和type的map关系。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***返回gvkToType***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AllKnownTypes</span><span class="params">()</span> <span class="title">map</span>[<span class="title">unversioned</span>.<span class="title">GroupVersionKind</span>]<span class="title">reflect</span>.<span class="title">Type</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> s.gvkToType</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ObjectKind-ObjectKinds"><a href="#ObjectKind-ObjectKinds" class="headerlink" title="ObjectKind() ObjectKinds()"></a>ObjectKind() ObjectKinds()</h2><p>ObjectKinds()通过obj的type获取对应的GVK(可能存在多个GVK)；ObjectKind()则在ObjectKinds()的基础上返回第一个GVk。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取obj的gvk***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">ObjectKind</span><span class="params">(obj Object)</span> <span class="params">(unversioned.GroupVersionKind, <span class="keyword">bool</span>, error)</span></span> &#123;</div><div class="line">	gvks, unversionedType, err := s.ObjectKinds(obj)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> unversioned.GroupVersionKind&#123;&#125;, <span class="literal">false</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> gvks[<span class="number">0</span>], unversionedType, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***通过obj的类型获取所有的gvk***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">ObjectKinds</span><span class="params">(obj Object)</span> <span class="params">([]unversioned.GroupVersionKind, <span class="keyword">bool</span>, error)</span></span> &#123;</div><div class="line">	v, err := conversion.EnforcePtr(obj)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, err</div><div class="line">	&#125;</div><div class="line">	t := v.Type()</div><div class="line"></div><div class="line">	<span class="comment">//***从typeToGVK中获取gvks***//</span></div><div class="line">	gvks, ok := s.typeToGVK[t]</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, NewNotRegisteredErr(unversioned.GroupVersionKind&#123;&#125;, t)</div><div class="line">	&#125;</div><div class="line">	_, unversionedType := s.unversionedTypes[t]</div><div class="line"></div><div class="line">	<span class="keyword">return</span> gvks, unversionedType, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Recognizes"><a href="#Recognizes" class="headerlink" title="Recognizes()"></a>Recognizes()</h2><p>Recognizes()判断GVK在Scheme中是否有注册。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">Recognizes</span><span class="params">(gvk unversioned.GroupVersionKind)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	_, exists := s.gvkToType[gvk]</div><div class="line">	<span class="keyword">return</span> exists</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="IsUnversioned"><a href="#IsUnversioned" class="headerlink" title="IsUnversioned()"></a>IsUnversioned()</h2><p>IsUnversioned()判断obj是否属于unversioned。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***判断obj是否是属于unversioned***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">IsUnversioned</span><span class="params">(obj Object)</span> <span class="params">(<span class="keyword">bool</span>, <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	v, err := conversion.EnforcePtr(obj)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line">	t := v.Type()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> _, ok := s.typeToGVK[t]; !ok &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line">	_, ok := s.unversionedTypes[t]</div><div class="line">	<span class="keyword">return</span> ok, <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="New"><a href="#New" class="headerlink" title="New()"></a>New()</h2><p>New()可以创建一个gvk类型的结构体值。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***新建一个符合gvk的具体object***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">New</span><span class="params">(kind unversioned.GroupVersionKind)</span> <span class="params">(Object, error)</span></span> &#123;</div><div class="line">	<span class="comment">//***versioned的情况***//</span></div><div class="line">	<span class="keyword">if</span> t, exists := s.gvkToType[kind]; exists &#123;</div><div class="line">		<span class="comment">//***通过reflect.New(t).Interface().(Object)来生成新的object***//</span></div><div class="line">		<span class="keyword">return</span> reflect.New(t).Interface().(Object), <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***unversioned的情况***//</span></div><div class="line">	<span class="keyword">if</span> t, exists := s.unversionedKinds[kind.Kind]; exists &#123;</div><div class="line">		<span class="keyword">return</span> reflect.New(t).Interface().(Object), <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, NewNotRegisteredErr(kind, <span class="literal">nil</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddGenericConversionFunc"><a href="#AddGenericConversionFunc" class="headerlink" title="AddGenericConversionFunc()"></a>AddGenericConversionFunc()</h2><p>AddGenericConversionFunc()是对converter的AddGenericConversionFunc()方法的封装，关于converter将在以后分析。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***GenericConversionFunc可以理解为转换的快速通道***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddGenericConversionFunc</span><span class="params">(fn conversion.GenericConversionFunc)</span></span> &#123;</div><div class="line">	<span class="comment">//***调用converter的addGenericConversionFunc()***//</span></div><div class="line">	s.converter.AddGenericConversionFunc(fn)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddIgnoredConversionType"><a href="#AddIgnoredConversionType" class="headerlink" title="AddIgnoredConversionType()"></a>AddIgnoredConversionType()</h2><p>AddIgnoredConversionType()是对converter的RegisterIgnoredConversion()方法的封闭，关于converter将在以后分析。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddIgnoredConversionType</span><span class="params">(from, to <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***需要忽略的类型转换***//</span></div><div class="line">	<span class="keyword">return</span> s.converter.RegisterIgnoredConversion(from, to)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddConversionFuncs"><a href="#AddConversionFuncs" class="headerlink" title="AddConversionFuncs()"></a>AddConversionFuncs()</h2><p>AddConversionFuncs()可以向converter注册转换函数，关于converter将在以后分析。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***向converter注册conversion函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddConversionFuncs</span><span class="params">(conversionFuncs ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, f := <span class="keyword">range</span> conversionFuncs &#123;</div><div class="line">		<span class="comment">//***调用converter的RegisterConversionFunc()函数***//</span></div><div class="line">		<span class="keyword">if</span> err := s.converter.RegisterConversionFunc(f); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddGeneratedConversionFuncs"><a href="#AddGeneratedConversionFuncs" class="headerlink" title="AddGeneratedConversionFuncs()"></a>AddGeneratedConversionFuncs()</h2><p>AddGeneratedConversionFuncs()可以向converter注册GeneratedConversionFuncs，其中GeneratedConversionFuncs为自动生成的转换函数，关于converter将在以后分析。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***向converter注册generatedConversion函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddGeneratedConversionFuncs</span><span class="params">(conversionFuncs ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, f := <span class="keyword">range</span> conversionFuncs &#123;</div><div class="line">		<span class="keyword">if</span> err := s.converter.RegisterGeneratedConversionFunc(f); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddDeepCopyFuncs"><a href="#AddDeepCopyFuncs" class="headerlink" title="AddDeepCopyFuncs()"></a>AddDeepCopyFuncs()</h2><p>AddDeepCopyFuncs()可以向cloner注册克隆函数，关于cloner将在以后分析。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***向cloner注册deepCopy函数***//</span></div><div class="line"><span class="comment">//***系统中未找到调用***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddDeepCopyFuncs</span><span class="params">(deepCopyFuncs ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, f := <span class="keyword">range</span> deepCopyFuncs &#123;</div><div class="line">		<span class="keyword">if</span> err := s.cloner.RegisterDeepCopyFunc(f); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddGeneratedDeepCopyFuncs"><a href="#AddGeneratedDeepCopyFuncs" class="headerlink" title="AddGeneratedDeepCopyFuncs()"></a>AddGeneratedDeepCopyFuncs()</h2><p>AddGeneratedDeepCopyFuncs()可以向cloner注册GeneratedDeepCopyFuncs，其中GeneratedDeepCopyFuncs为自动生成的克隆函数，关于cloner将在以后分析。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***向cloner注册generatedDeepCopy函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddGeneratedDeepCopyFuncs</span><span class="params">(deepCopyFuncs ...conversion.GeneratedDeepCopyFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, fn := <span class="keyword">range</span> deepCopyFuncs &#123;</div><div class="line">		<span class="keyword">if</span> err := s.cloner.RegisterGeneratedDeepCopyFunc(fn); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddFieldLabelConversionFunc"><a href="#AddFieldLabelConversionFunc" class="headerlink" title="AddFieldLabelConversionFunc()"></a>AddFieldLabelConversionFunc()</h2><p>AddFieldLabelConversionFunc()可以向Scheme注册field selector转换函数。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***字段转换函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddFieldLabelConversionFunc</span><span class="params">(version, kind <span class="keyword">string</span>, conversionFunc FieldLabelConversionFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> s.fieldLabelConversionFuncs[version] == <span class="literal">nil</span> &#123;</div><div class="line">		s.fieldLabelConversionFuncs[version] = <span class="keyword">map</span>[<span class="keyword">string</span>]FieldLabelConversionFunc&#123;&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	s.fieldLabelConversionFuncs[version][kind] = conversionFunc</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddStructFieldConversion"><a href="#AddStructFieldConversion" class="headerlink" title="AddStructFieldConversion()"></a>AddStructFieldConversion()</h2><p>AddStructFieldConversion()可以向converter注册struct字段转换函数，关于cloner将在以后分析。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***struct成员转换函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddStructFieldConversion</span><span class="params">(srcFieldType <span class="keyword">interface</span>&#123;&#125;, srcFieldName <span class="keyword">string</span>, destFieldType <span class="keyword">interface</span>&#123;&#125;, destFieldName <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> s.converter.SetStructFieldCopy(srcFieldType, srcFieldName, destFieldType, destFieldName)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="RegisterInputDefaults"><a href="#RegisterInputDefaults" class="headerlink" title="RegisterInputDefaults()"></a>RegisterInputDefaults()</h2><p>RegisterInputDefaults()可以向convertor注册转换发生缺省时默认的处理方式函数。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">RegisterInputDefaults</span><span class="params">(in <span class="keyword">interface</span>&#123;&#125;, fn conversion.FieldMappingFunc, defaultFlags conversion.FieldMatchingFlags)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> s.converter.RegisterInputDefaults(in, fn, defaultFlags)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="AddDefaultingFuncs"><a href="#AddDefaultingFuncs" class="headerlink" title="AddDefaultingFuncs()"></a>AddDefaultingFuncs()</h2><p>AddDefaultingFuncs()可以向converter注册DefaultingFunc函数，DefaultingFunc函数可以设置相关结构体值的默认值。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***添加设置默认值函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddDefaultingFuncs</span><span class="params">(defaultingFuncs ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, f := <span class="keyword">range</span> defaultingFuncs &#123;</div><div class="line">		err := s.converter.RegisterDefaultingFunc(f)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Default"><a href="#Default" class="headerlink" title="Default()"></a>Default()</h2><p>Default()可以对object设置默认值。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***设置src默认值***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">Default</span><span class="params">(src Object)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> fn, ok := s.defaulterFuncs[reflect.TypeOf(src)]; ok &#123;</div><div class="line">		fn(src)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Copy"><a href="#Copy" class="headerlink" title="Copy()"></a>Copy()</h2><p>Copy()是对cloner.DeepCopy()的封装，可以拷贝一个object。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***深度拷贝src***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">Copy</span><span class="params">(src Object)</span> <span class="params">(Object, error)</span></span> &#123;</div><div class="line">	dst, err := s.DeepCopy(src)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> dst.(Object), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Performs a deep copy of the given object.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">DeepCopy</span><span class="params">(src <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> s.cloner.DeepCopy(src)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Convert"><a href="#Convert" class="headerlink" title="Convert()"></a>Convert()</h2><p>Convert()是对converter.Convert()的封装。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***转换函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">Convert</span><span class="params">(in, out <span class="keyword">interface</span>&#123;&#125;, context <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	flags, meta := s.generateConvertMeta(in)</div><div class="line">	meta.Context = context</div><div class="line">	<span class="keyword">if</span> flags == <span class="number">0</span> &#123;</div><div class="line">		flags = conversion.AllowDifferentFieldTypeNames</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> s.converter.Convert(in, out, flags, meta)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ConvertFieldLabel"><a href="#ConvertFieldLabel" class="headerlink" title="ConvertFieldLabel()"></a>ConvertFieldLabel()</h2><p>ConvertFieldLabel()可以对field selector进行转换。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***转换field selector标签***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">ConvertFieldLabel</span><span class="params">(version, kind, label, value <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, <span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> s.fieldLabelConversionFuncs[version] == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, <span class="string">""</span>, fmt.Errorf(<span class="string">"No field label conversion function found for version: %s"</span>, version)</div><div class="line">	&#125;</div><div class="line">	conversionFunc, ok := s.fieldLabelConversionFuncs[version][kind]</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, <span class="string">""</span>, fmt.Errorf(<span class="string">"No field label conversion function found for version %s and kind %s"</span>, version, kind)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> conversionFunc(label, value)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ConvertToVersion"><a href="#ConvertToVersion" class="headerlink" title="ConvertToVersion()"></a>ConvertToVersion()</h2><p>ConvertToVersion()可以把in转换成合适的版本。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">ConvertToVersion</span><span class="params">(in Object, target GroupVersioner)</span> <span class="params">(Object, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> s.convertToVersion(<span class="literal">true</span>, in, target)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">convertToVersion</span><span class="params">(<span class="built_in">copy</span> <span class="keyword">bool</span>, in Object, target GroupVersioner)</span> <span class="params">(Object, error)</span></span> &#123;</div><div class="line">	<span class="comment">// determine the incoming kinds with as few allocations as possible.</span></div><div class="line">	t := reflect.TypeOf(in)</div><div class="line">	<span class="keyword">if</span> t.Kind() != reflect.Ptr &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"only pointer types may be converted: %v"</span>, t)</div><div class="line">	&#125;</div><div class="line">	t = t.Elem()</div><div class="line">	<span class="keyword">if</span> t.Kind() != reflect.Struct &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"only pointers to struct types may be converted: %v"</span>, t)</div><div class="line">	&#125;</div><div class="line">	kinds, ok := s.typeToGVK[t]</div><div class="line">	<span class="keyword">if</span> !ok || <span class="built_in">len</span>(kinds) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, NewNotRegisteredErr(unversioned.GroupVersionKind&#123;&#125;, t)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***从多个gvk中选择出符合target的要求的gvk***//</span></div><div class="line">	gvk, ok := target.KindForGroupVersionKinds(kinds)</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="comment">// try to see if this type is listed as unversioned (for legacy support)</span></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> when we move to server API versions, we should completely remove the unversioned concept</span></div><div class="line">		<span class="keyword">if</span> unversionedKind, ok := s.unversionedTypes[t]; ok &#123;</div><div class="line">			<span class="keyword">if</span> gvk, ok := target.KindForGroupVersionKinds([]unversioned.GroupVersionKind&#123;unversionedKind&#125;); ok &#123;</div><div class="line">				<span class="keyword">return</span> copyAndSetTargetKind(<span class="built_in">copy</span>, s, in, gvk)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> copyAndSetTargetKind(<span class="built_in">copy</span>, s, in, unversionedKind)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> should this be a typed error?</span></div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"%v is not suitable for converting to %q"</span>, t, target)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// target wants to use the existing type, set kind and return (no conversion necessary)</span></div><div class="line">	<span class="keyword">for</span> _, kind := <span class="keyword">range</span> kinds &#123;</div><div class="line">		<span class="keyword">if</span> gvk == kind &#123;</div><div class="line">			<span class="keyword">return</span> copyAndSetTargetKind(<span class="built_in">copy</span>, s, in, gvk)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// type is unversioned, no conversion necessary</span></div><div class="line">	<span class="keyword">if</span> unversionedKind, ok := s.unversionedTypes[t]; ok &#123;</div><div class="line">		<span class="keyword">if</span> gvk, ok := target.KindForGroupVersionKinds([]unversioned.GroupVersionKind&#123;unversionedKind&#125;); ok &#123;</div><div class="line">			<span class="keyword">return</span> copyAndSetTargetKind(<span class="built_in">copy</span>, s, in, gvk)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> copyAndSetTargetKind(<span class="built_in">copy</span>, s, in, unversionedKind)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	out, err := s.New(gvk)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">copy</span> &#123;</div><div class="line">		copied, err := s.Copy(in)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">		&#125;</div><div class="line">		in = copied</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	flags, meta := s.generateConvertMeta(in)</div><div class="line">	meta.Context = target</div><div class="line">	<span class="keyword">if</span> err := s.converter.Convert(in, out, flags, meta); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	setTargetKind(out, gvk)</div><div class="line">	<span class="keyword">return</span> out, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/07/27/Scheme机制解读(一)-Scheme-v1-5-2/" data-id="cj8wo21oj001hloqset3ditn5" class="article-share-link">分享</a><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></div><div class="post-nav"><a href="/2017/07/29/Scheme机制解读(二)-Converter-v1-5-2/" class="pre">Scheme机制解读(二)-Converter-v1.5.2</a><a href="/2017/07/24/RESTMapper解读(三)-其他RESTMapper-v1-5-2/" class="next">RESTMapper解读(三)-其他RESTMapper-v1.5.2</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/18/kubernetes-client分析(四)-ClientSet-v1-5-2/">kubernetes-client分析(四)-ClientSet-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/16/kubernetes-client分析(三)-dynamicClient-v1-5-2/">kubernetes-client分析(三)-dynamicClient-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/13/kubernetes-client分析(二)-restclient-v1-5-2/">kubernetes-client分析(二)-restclient-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/12/kubernetes-client分析(一)-kubeconfig-v1-5-2/">kubernetes-client分析(一)-kubeconfig-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/09/kubernetes-client-python使用-v1-0-1/">kubernetes-client-python使用-v1.0.1</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/06/GO语言包使用-buffio/">GO语言包使用-buffio</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/06/yaml格式转换分析-YAMLOrJSONDecoder/">yaml格式转换分析-YAMLOrJSONDecoder</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/04/kube-scheduler分析(二)-scheduler-v1-5-2/">kube-scheduler分析(二)-scheduler-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/03/kube-scheduler分析(一)-init过程-v1-5-2/">kube-scheduler分析(一)-init过程-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/01/kube-proxy分析(二)-proxier-v1-5-2/">kube-proxy分析(二)-proxier-v1.5.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>