<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>RESTMapper解读(一)-DefaultRESTMapper-v1.5.2 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">RESTMapper解读(一)-DefaultRESTMapper-v1.5.2</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">RESTMapper解读(一)-DefaultRESTMapper-v1.5.2</h1><div class="post-meta">Jul 22, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="什么是RESTMapper"><a href="#什么是RESTMapper" class="headerlink" title="什么是RESTMapper"></a>什么是RESTMapper</h2><p>先来看来什么是RESTMapper。RESTMapper是一个interface，定义在/pkg/meta/interfaces.go中:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RESTMapper allows clients to map resources to kind, and map kind and version</span></div><div class="line"><span class="comment">// to interfaces for manipulating those objects. It is primarily intended for</span></div><div class="line"><span class="comment">// consumers of Kubernetes compatible REST APIs as defined in docs/devel/api-conventions.md.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// The Kubernetes API provides versioned resources and object kinds which are scoped</span></div><div class="line"><span class="comment">// to API groups. In other words, kinds and resources should not be assumed to be</span></div><div class="line"><span class="comment">// unique across groups.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// <span class="doctag">TODO:</span> split into sub-interfaces</span></div><div class="line"><span class="keyword">type</span> RESTMapper <span class="keyword">interface</span> &#123;</div><div class="line">	<span class="comment">// KindFor takes a partial resource and returns the single match.  Returns an error if there are multiple matches</span></div><div class="line">	KindFor(resource unversioned.GroupVersionResource) (unversioned.GroupVersionKind, error)</div><div class="line"></div><div class="line">	<span class="comment">// KindsFor takes a partial resource and returns the list of potential kinds in priority order</span></div><div class="line">	KindsFor(resource unversioned.GroupVersionResource) ([]unversioned.GroupVersionKind, error)</div><div class="line"></div><div class="line">	<span class="comment">// ResourceFor takes a partial resource and returns the single match.  Returns an error if there are multiple matches</span></div><div class="line">	ResourceFor(input unversioned.GroupVersionResource) (unversioned.GroupVersionResource, error)</div><div class="line"></div><div class="line">	<span class="comment">// ResourcesFor takes a partial resource and returns the list of potential resource in priority order</span></div><div class="line">	ResourcesFor(input unversioned.GroupVersionResource) ([]unversioned.GroupVersionResource, error)</div><div class="line"></div><div class="line">	<span class="comment">// RESTMapping identifies a preferred resource mapping for the provided group kind.</span></div><div class="line">	RESTMapping(gk unversioned.GroupKind, versions ...<span class="keyword">string</span>) (*RESTMapping, error)</div><div class="line">	<span class="comment">// RESTMappings returns all resource mappings for the provided group kind.</span></div><div class="line">	RESTMappings(gk unversioned.GroupKind) ([]*RESTMapping, error)</div><div class="line"></div><div class="line">	AliasesForResource(resource <span class="keyword">string</span>) ([]<span class="keyword">string</span>, <span class="keyword">bool</span>)</div><div class="line">	ResourceSingularizer(resource <span class="keyword">string</span>) (singular <span class="keyword">string</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>关于RESTMapper的注释非常重要，“RESTMapper allows clients to map resources to kind, and map kind and version to interfaces for manipulating those objects”。也就是说，RESTMapper映射是指GVR(GroupVersionResource)和GVK(GroupVersionKind)的关系，可以通过GVR找到合适的GVK，并可以通过GVK生成一个RESTMapping。</p>
<h2 id="什么是RESTMapping"><a href="#什么是RESTMapping" class="headerlink" title="什么是RESTMapping"></a>什么是RESTMapping</h2><p>再来看来RESTMapping，同样定义在/pkg/api/meta/interfaces.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RESTMapping contains the information needed to deal with objects of a specific</span></div><div class="line"><span class="comment">// resource and kind in a RESTful manner.</span></div><div class="line"><span class="keyword">type</span> RESTMapping <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// Resource is a string representing the name of this resource as a REST client would see it</span></div><div class="line">	<span class="comment">//***此处为string，而非GVR***//</span></div><div class="line">	Resource <span class="keyword">string</span></div><div class="line"></div><div class="line">	GroupVersionKind unversioned.GroupVersionKind</div><div class="line"></div><div class="line">	<span class="comment">// Scope contains the information needed to deal with REST Resources that are in a resource hierarchy</span></div><div class="line">	Scope RESTScope</div><div class="line"></div><div class="line">	runtime.ObjectConvertor</div><div class="line">	MetadataAccessor</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>RESTMapping包含Resource名称，及其对应的GVK，还有一个Scope(标明资源是否为root或者namespaced)，还有一个Convertor用来转换该GVK对应的Object和一个MetadataAccessor用来提取Object的meta信息。</p>
<p>那么RESTMapping怎么用呢？</p>
<p>比如/pkg/apiserver/api_installer.go中就有使用到RESTMapping中的Scope用来生成合适的URL(RESTScopeNameRoot和RESTScopeNameNamespace处理不同，详见以后对Apiserver的分析)。</p>
<p>再比如/pkg/kubectl/resource_printer.go中的VersionedPrinter中的converter也是来自RESTMapping中的Convertor(以后和Scheme一起分析)。</p>
<h2 id="什么是RESTScope"><a href="#什么是RESTScope" class="headerlink" title="什么是RESTScope"></a>什么是RESTScope</h2><p>这里一并把RESTScope介绍掉，因为RESTScope接口也定义在/pkg/api/meta/interfaces.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RESTScope contains the information needed to deal with REST resources that are in a resource hierarchy</span></div><div class="line"><span class="keyword">type</span> RESTScope <span class="keyword">interface</span> &#123;</div><div class="line">	<span class="comment">// Name of the scope</span></div><div class="line">	Name() RESTScopeName</div><div class="line">	<span class="comment">// ParamName is the optional name of the parameter that should be inserted in the resource url</span></div><div class="line">	<span class="comment">// If empty, no param will be inserted</span></div><div class="line">	ParamName() <span class="keyword">string</span></div><div class="line">	<span class="comment">// ArgumentName is the optional name that should be used for the variable holding the value.</span></div><div class="line">	ArgumentName() <span class="keyword">string</span></div><div class="line">	<span class="comment">// ParamDescription is the optional description to use to document the parameter in api documentation</span></div><div class="line">	ParamDescription() <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>RESTScope具体由restScope之实现。restScope定义在/pkg/api/meta/restmapper.go中，比较简单，这里就不在详细分析。目前有两种RESTScope：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> RESTScopeNamespace = &amp;restScope&#123;</div><div class="line">	name:             RESTScopeNameNamespace,</div><div class="line">	paramName:        <span class="string">"namespaces"</span>,</div><div class="line">	argumentName:     <span class="string">"namespace"</span>,</div><div class="line">	paramDescription: <span class="string">"object name and auth scope, such as for teams and projects"</span>,</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> RESTScopeRoot = &amp;restScope&#123;</div><div class="line">	name: RESTScopeNameRoot,</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里的RESTScopeNameNamespace和RESTScopeNameRoot定义在/pkg/api/meta/interfaces.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> (</div><div class="line">	RESTScopeNameNamespace RESTScopeName = <span class="string">"namespace"</span></div><div class="line">	RESTScopeNameRoot      RESTScopeName = <span class="string">"root"</span></div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>这里只要记住，RESTScopeNamespace表明该资源是在Namespace下的，如pods，rc等；RESTScopeRoot标明资源是全局的，如nodes, pv等。</p>
<h2 id="DefaultRESTMapper"><a href="#DefaultRESTMapper" class="headerlink" title="DefaultRESTMapper"></a>DefaultRESTMapper</h2><p>DefaultRESTMapper实现了RESTMapper interface。为什么称为DefaultRESTMapper呢，因为DefaultRESTMapper定义了defaultGroupVersions。DefaultRESTMapper定义在/pkg/api/metamapper.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***DefaultRESTMapper中的resource是指GVR，kind是指GVK***//</span></div><div class="line"><span class="comment">//***singular和Plural都是GVR***//</span></div><div class="line"><span class="keyword">type</span> DefaultRESTMapper <span class="keyword">struct</span> &#123;</div><div class="line">	defaultGroupVersions []unversioned.GroupVersion</div><div class="line"></div><div class="line">	resourceToKind       <span class="keyword">map</span>[unversioned.GroupVersionResource]unversioned.GroupVersionKind</div><div class="line">	kindToPluralResource <span class="keyword">map</span>[unversioned.GroupVersionKind]unversioned.GroupVersionResource</div><div class="line">	kindToScope          <span class="keyword">map</span>[unversioned.GroupVersionKind]RESTScope</div><div class="line">	singularToPlural     <span class="keyword">map</span>[unversioned.GroupVersionResource]unversioned.GroupVersionResource</div><div class="line">	pluralToSingular     <span class="keyword">map</span>[unversioned.GroupVersionResource]unversioned.GroupVersionResource</div><div class="line"></div><div class="line">	interfacesFunc VersionInterfacesFunc</div><div class="line"></div><div class="line">	<span class="comment">// aliasToResource is used for mapping aliases to resources</span></div><div class="line">	aliasToResource <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在来详细分析DefaultRESTMapper的字段的涵义。</p>
<ul>
<li>defaultGroupVersions: 默认的GroupVersion，如v1，apps/v1beta1等，一般一个DefaultRESTMapper只设一个默认的GroupVersion；</li>
<li>resourceToKind：GVR(单数,复数)到GVK的map；</li>
<li>kindToPluralResource：GVK到GVR(复数)的map；</li>
<li>kindToScope：GVK到Scope的map；</li>
<li>singularToPlural：GVR(单数)到GVR(复数)的map；</li>
<li>interfacesFunc：用来产生Convertor和MetadataAccessor，具体实现为/pkg/api/install/install.go中的interfacesFor()函数。</li>
<li>aliasToResource：管理别名，但貌似系统中没怎么用这功能。<br>这里要说明白的是，DefaultRESTMapper中的Resource有单数和复数的区别。但为什么要有单复数的区别，现在还不知道。</li>
</ul>
<p>下面来分析DefaultRESTMapper的重要方法的实现。</p>
<h3 id="NewDefaultRESTMapper"><a href="#NewDefaultRESTMapper" class="headerlink" title="NewDefaultRESTMapper()"></a>NewDefaultRESTMapper()</h3><p>NewDefaultRESTMapper()生成一个新的DefaultRESTMapper。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDefaultRESTMapper</span><span class="params">(defaultGroupVersions []unversioned.GroupVersion, f VersionInterfacesFunc)</span> *<span class="title">DefaultRESTMapper</span></span> &#123;</div><div class="line">	resourceToKind := <span class="built_in">make</span>(<span class="keyword">map</span>[unversioned.GroupVersionResource]unversioned.GroupVersionKind)</div><div class="line">	kindToPluralResource := <span class="built_in">make</span>(<span class="keyword">map</span>[unversioned.GroupVersionKind]unversioned.GroupVersionResource)</div><div class="line">	kindToScope := <span class="built_in">make</span>(<span class="keyword">map</span>[unversioned.GroupVersionKind]RESTScope)</div><div class="line">	singularToPlural := <span class="built_in">make</span>(<span class="keyword">map</span>[unversioned.GroupVersionResource]unversioned.GroupVersionResource)</div><div class="line">	pluralToSingular := <span class="built_in">make</span>(<span class="keyword">map</span>[unversioned.GroupVersionResource]unversioned.GroupVersionResource)</div><div class="line">	aliasToResource := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>)</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> verify name mappings work correctly when versions differ</span></div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;DefaultRESTMapper&#123;</div><div class="line">		resourceToKind:       resourceToKind,</div><div class="line">		kindToPluralResource: kindToPluralResource,</div><div class="line">		kindToScope:          kindToScope,</div><div class="line">		defaultGroupVersions: defaultGroupVersions,</div><div class="line">		singularToPlural:     singularToPlural,</div><div class="line">		pluralToSingular:     pluralToSingular,</div><div class="line">		aliasToResource:      aliasToResource,</div><div class="line">		interfacesFunc:       f,</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>NewDefaultRESTMapper()会被/pkg/api/mapper.go的NewDefaultRESTMapperFromScheme()函数调用。NewDefaultRESTMapperFromScheme()是生成DefaultRESTMapper的入口。这就很方便我们看系统中有多少个DefaultRESTMapper了：<br>[v1], [apps/v1beta1], [authentication.k8s.io/v1beta1], [authorization.k8s.io/v1beta1], [autoscaling/v1], [batch/v1 batch/v2alpha1], [certificates.k8s.io/v1alpha1], [componentconfig/v1alpha1], [extensions/v1beta1], [policy/v1beta1], [rbac.authorization.k8s.io/v1alpha1], [storage.k8s.io/v1beta1], [imagepolicy.k8s.io/v1alpha1]</p>
<h3 id="Add"><a href="#Add" class="headerlink" title="Add()"></a>Add()</h3><p>Add()方法主要是把GVK和GVK对应的scope加入到DefaultRESTMapper对应的字段中。其中KindToResource()返回GVK对应的GVR(复数)和GVR(单数)。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***添加GVK***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *DefaultRESTMapper)</span> <span class="title">Add</span><span class="params">(kind unversioned.GroupVersionKind, scope RESTScope)</span></span> &#123;</div><div class="line">	plural, singular := KindToResource(kind)</div><div class="line"></div><div class="line">	m.singularToPlural[singular] = plural</div><div class="line">	m.pluralToSingular[plural] = singular</div><div class="line"></div><div class="line">	m.resourceToKind[singular] = kind</div><div class="line">	m.resourceToKind[plural] = kind</div><div class="line"></div><div class="line">	m.kindToPluralResource[kind] = plural</div><div class="line">	m.kindToScope[kind] = scope</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="ResourceFor"><a href="#ResourceFor" class="headerlink" title="ResourceFor()"></a>ResourceFor()</h3><p>ResourceFor()通过GVR(信息不一定要全)找到一个最合适的注册的GVR。规则如下：</p>
<ul>
<li>如果参数GVR没有有Resource，则返回错误。</li>
<li>如果参数GVR限定Group，Version和Resource，则匹配Group，Version和Resource；</li>
<li>如果参数GVR限定Group和Resource，则匹配Group和Resource；</li>
<li>如果参数GVR限定Version和Resource，则匹配Version和Resource；</li>
<li>如果参数GVR只有Resource，则匹配Resource。</li>
<li>如果系统中存在多个匹配，则返回错误(系统现在还不支持在不同的Group中定义相同的type)。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***找到最匹配的注册GVR***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *DefaultRESTMapper)</span> <span class="title">ResourceFor</span><span class="params">(resource unversioned.GroupVersionResource)</span> <span class="params">(unversioned.GroupVersionResource, error)</span></span> &#123;</div><div class="line">	resources, err := m.ResourcesFor(resource)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> unversioned.GroupVersionResource&#123;&#125;, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(resources) == <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">return</span> resources[<span class="number">0</span>], <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> unversioned.GroupVersionResource&#123;&#125;, &amp;AmbiguousResourceError&#123;PartialResource: resource, MatchingResources: resources&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***寻找匹配input GVR的注册GVR***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *DefaultRESTMapper)</span> <span class="title">ResourcesFor</span><span class="params">(input unversioned.GroupVersionResource)</span> <span class="params">([]unversioned.GroupVersionResource, error)</span></span> &#123;</div><div class="line">	<span class="comment">//***获取GVR***//</span></div><div class="line">	resource := coerceResourceForMatching(input)</div><div class="line"></div><div class="line">	hasResource := <span class="built_in">len</span>(resource.Resource) &gt; <span class="number">0</span></div><div class="line">	hasGroup := <span class="built_in">len</span>(resource.Group) &gt; <span class="number">0</span></div><div class="line">	hasVersion := <span class="built_in">len</span>(resource.Version) &gt; <span class="number">0</span></div><div class="line"></div><div class="line">	<span class="keyword">if</span> !hasResource &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"a resource must be present, got: %v"</span>, resource)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ret := []unversioned.GroupVersionResource&#123;&#125;</div><div class="line">	<span class="keyword">switch</span> &#123;</div><div class="line">	<span class="comment">//***限定group和version，则比较GVR***//</span></div><div class="line">	<span class="keyword">case</span> hasGroup &amp;&amp; hasVersion:</div><div class="line">		<span class="comment">// fully qualified.  Find the exact match</span></div><div class="line">		<span class="keyword">for</span> plural, singular := <span class="keyword">range</span> m.pluralToSingular &#123;</div><div class="line">			<span class="keyword">if</span> singular == resource &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> plural == resource &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***只限定group，则比较GR***//</span></div><div class="line">	<span class="keyword">case</span> hasGroup:</div><div class="line">		<span class="comment">// given a group, prefer an exact match.  If you don't find one, resort to a prefix match on group</span></div><div class="line">		foundExactMatch := <span class="literal">false</span></div><div class="line">		requestedGroupResource := resource.GroupResource()</div><div class="line">		<span class="keyword">for</span> plural, singular := <span class="keyword">range</span> m.pluralToSingular &#123;</div><div class="line">			<span class="keyword">if</span> singular.GroupResource() == requestedGroupResource &#123;</div><div class="line">				foundExactMatch = <span class="literal">true</span></div><div class="line">				ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> plural.GroupResource() == requestedGroupResource &#123;</div><div class="line">				foundExactMatch = <span class="literal">true</span></div><div class="line">				ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// if you didn't find an exact match, match on group prefixing. This allows storageclass.storage to match</span></div><div class="line">		<span class="comment">// storageclass.storage.k8s.io</span></div><div class="line">		<span class="keyword">if</span> !foundExactMatch &#123;</div><div class="line">			<span class="keyword">for</span> plural, singular := <span class="keyword">range</span> m.pluralToSingular &#123;</div><div class="line">				<span class="keyword">if</span> !strings.HasPrefix(plural.Group, requestedGroupResource.Group) &#123;</div><div class="line">					<span class="keyword">continue</span></div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> singular.Resource == requestedGroupResource.Resource &#123;</div><div class="line">					ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> plural.Resource == requestedGroupResource.Resource &#123;</div><div class="line">					ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***限定version，则比较version和resource***//</span></div><div class="line">	<span class="keyword">case</span> hasVersion:</div><div class="line">		<span class="keyword">for</span> plural, singular := <span class="keyword">range</span> m.pluralToSingular &#123;</div><div class="line">			<span class="keyword">if</span> singular.Version == resource.Version &amp;&amp; singular.Resource == resource.Resource &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> plural.Version == resource.Version &amp;&amp; plural.Resource == resource.Resource &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***只比较Resource***//</span></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">for</span> plural, singular := <span class="keyword">range</span> m.pluralToSingular &#123;</div><div class="line">			<span class="keyword">if</span> singular.Resource == resource.Resource &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> plural.Resource == resource.Resource &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, plural)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ret) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, &amp;NoResourceMatchError&#123;PartialResource: resource&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sort.Sort(resourceByPreferredGroupVersion&#123;ret, m.defaultGroupVersions&#125;)</div><div class="line">	<span class="keyword">return</span> ret, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="KindFor"><a href="#KindFor" class="headerlink" title="KindFor()"></a>KindFor()</h3><p>KindFor()通过GVR(信息不一定要全)找到一个最合适的注册的GVK。规则和ResourceFor()一样：</p>
<ul>
<li>如果参数GVR没有有Resource，则返回错误。</li>
<li>如果参数GVR限定Group，Version和Resource，则匹配Group，Version和Resource；</li>
<li>如果参数GVR限定Group和Resource，则匹配Group和Resource；</li>
<li>如果参数GVR限定Version和Resource，则匹配Version和Resource；</li>
<li>如果参数GVR只有Resource，则匹配Resource。</li>
<li>如果系统中存在多个匹配，则返回错误(系统现在还不支持在不同的Group中定义相同的type)。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取与GVR最匹配的GVK***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *DefaultRESTMapper)</span> <span class="title">KindFor</span><span class="params">(resource unversioned.GroupVersionResource)</span> <span class="params">(unversioned.GroupVersionKind, error)</span></span> &#123;</div><div class="line">	kinds, err := m.KindsFor(resource)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> unversioned.GroupVersionKind&#123;&#125;, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(kinds) == <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">return</span> kinds[<span class="number">0</span>], <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> unversioned.GroupVersionKind&#123;&#125;, &amp;AmbiguousResourceError&#123;PartialResource: resource, MatchingKinds: kinds&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//***通过GVR获取GVK***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *DefaultRESTMapper)</span> <span class="title">KindsFor</span><span class="params">(input unversioned.GroupVersionResource)</span> <span class="params">([]unversioned.GroupVersionKind, error)</span></span> &#123;</div><div class="line">	resource := coerceResourceForMatching(input)</div><div class="line"></div><div class="line">	hasResource := <span class="built_in">len</span>(resource.Resource) &gt; <span class="number">0</span></div><div class="line">	hasGroup := <span class="built_in">len</span>(resource.Group) &gt; <span class="number">0</span></div><div class="line">	hasVersion := <span class="built_in">len</span>(resource.Version) &gt; <span class="number">0</span></div><div class="line"></div><div class="line">	<span class="keyword">if</span> !hasResource &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"a resource must be present, got: %v"</span>, resource)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ret := []unversioned.GroupVersionKind&#123;&#125;</div><div class="line">	<span class="keyword">switch</span> &#123;</div><div class="line">	<span class="comment">// fully qualified.  Find the exact match</span></div><div class="line">	<span class="keyword">case</span> hasGroup &amp;&amp; hasVersion:</div><div class="line">		kind, exists := m.resourceToKind[resource]</div><div class="line">		<span class="keyword">if</span> exists &#123;</div><div class="line">			ret = <span class="built_in">append</span>(ret, kind)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	<span class="keyword">case</span> hasGroup:</div><div class="line">		foundExactMatch := <span class="literal">false</span></div><div class="line">		requestedGroupResource := resource.GroupResource()</div><div class="line">		<span class="keyword">for</span> currResource, currKind := <span class="keyword">range</span> m.resourceToKind &#123;</div><div class="line">			<span class="keyword">if</span> currResource.GroupResource() == requestedGroupResource &#123;</div><div class="line">				foundExactMatch = <span class="literal">true</span></div><div class="line">				ret = <span class="built_in">append</span>(ret, currKind)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// if you didn't find an exact match, match on group prefixing. This allows storageclass.storage to match</span></div><div class="line">		<span class="comment">// storageclass.storage.k8s.io</span></div><div class="line">		<span class="keyword">if</span> !foundExactMatch &#123;</div><div class="line">			<span class="keyword">for</span> currResource, currKind := <span class="keyword">range</span> m.resourceToKind &#123;</div><div class="line">				<span class="keyword">if</span> !strings.HasPrefix(currResource.Group, requestedGroupResource.Group) &#123;</div><div class="line">					<span class="keyword">continue</span></div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> currResource.Resource == requestedGroupResource.Resource &#123;</div><div class="line">					ret = <span class="built_in">append</span>(ret, currKind)</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125;</div><div class="line"></div><div class="line">	<span class="keyword">case</span> hasVersion:</div><div class="line">		<span class="keyword">for</span> currResource, currKind := <span class="keyword">range</span> m.resourceToKind &#123;</div><div class="line">			<span class="keyword">if</span> currResource.Version == resource.Version &amp;&amp; currResource.Resource == resource.Resource &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, currKind)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">for</span> currResource, currKind := <span class="keyword">range</span> m.resourceToKind &#123;</div><div class="line">			<span class="keyword">if</span> currResource.Resource == resource.Resource &#123;</div><div class="line">				ret = <span class="built_in">append</span>(ret, currKind)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ret) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, &amp;NoResourceMatchError&#123;PartialResource: input&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sort.Sort(kindByPreferredGroupVersion&#123;ret, m.defaultGroupVersions&#125;)</div><div class="line">	<span class="keyword">return</span> ret, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="RESTMapping"><a href="#RESTMapping" class="headerlink" title="RESTMapping()"></a>RESTMapping()</h3><p>RESTMapping()的参数是GK和versions，通常的做法是把一个GVK直接拆成GK和Version，然后获取mapping。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RESTMapping returns a struct representing the resource path and conversion interfaces a</span></div><div class="line"><span class="comment">// RESTClient should use to operate on the provided group/kind in order of versions. If a version search</span></div><div class="line"><span class="comment">// order is not provided, the search order provided to DefaultRESTMapper will be used to resolve which</span></div><div class="line"><span class="comment">// version should be used to access the named group/kind.</span></div><div class="line"><span class="comment">// <span class="doctag">TODO:</span> consider refactoring to use RESTMappings in a way that preserves version ordering and preference</span></div><div class="line"><span class="comment">//***返回RESTMapping***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *DefaultRESTMapper)</span> <span class="title">RESTMapping</span><span class="params">(gk unversioned.GroupKind, versions ...<span class="keyword">string</span>)</span> <span class="params">(*RESTMapping, error)</span></span> &#123;</div><div class="line">	<span class="comment">// Pick an appropriate version</span></div><div class="line">	<span class="keyword">var</span> gvk *unversioned.GroupVersionKind</div><div class="line">	hadVersion := <span class="literal">false</span></div><div class="line">	<span class="comment">//***构造GVK***//</span></div><div class="line">	<span class="keyword">for</span> _, version := <span class="keyword">range</span> versions &#123;</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(version) == <span class="number">0</span> || version == runtime.APIVersionInternal &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		currGVK := gk.WithVersion(version)</div><div class="line">		hadVersion = <span class="literal">true</span></div><div class="line">		<span class="comment">//***一旦找到合适的version，则break***//</span></div><div class="line">		<span class="keyword">if</span> _, ok := m.kindToPluralResource[currGVK]; ok &#123;</div><div class="line">			gvk = &amp;currGVK</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Use the default preferred versions</span></div><div class="line">	<span class="keyword">if</span> !hadVersion &amp;&amp; (gvk == <span class="literal">nil</span>) &#123;</div><div class="line">		<span class="keyword">for</span> _, gv := <span class="keyword">range</span> m.defaultGroupVersions &#123;</div><div class="line">			<span class="keyword">if</span> gv.Group != gk.Group &#123;</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line"></div><div class="line">			currGVK := gk.WithVersion(gv.Version)</div><div class="line">			<span class="keyword">if</span> _, ok := m.kindToPluralResource[currGVK]; ok &#123;</div><div class="line">				gvk = &amp;currGVK</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> gvk == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, &amp;NoKindMatchError&#123;PartialKind: gk.WithVersion(<span class="string">""</span>)&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Ensure we have a REST mapping</span></div><div class="line">	<span class="comment">//***按照GVK获取resource***//</span></div><div class="line">	<span class="comment">//***从原注释看，GVK和GVR的关系叫做REST mapping***//</span></div><div class="line">	resource, ok := m.kindToPluralResource[*gvk]</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		found := []unversioned.GroupVersion&#123;&#125;</div><div class="line">		<span class="keyword">for</span> _, gv := <span class="keyword">range</span> m.defaultGroupVersions &#123;</div><div class="line">			<span class="keyword">if</span> _, ok := m.kindToPluralResource[*gvk]; ok &#123;</div><div class="line">				found = <span class="built_in">append</span>(found, gv)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(found) &gt; <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"object with kind %q exists in versions %v, not %v"</span>, gvk.Kind, found, gvk.GroupVersion().String())</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"the provided version %q and kind %q cannot be mapped to a supported object"</span>, gvk.GroupVersion().String(), gvk.Kind)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Ensure we have a REST scope</span></div><div class="line">	<span class="comment">//***获取scope***//</span></div><div class="line">	scope, ok := m.kindToScope[*gvk]</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"the provided version %q and kind %q cannot be mapped to a supported scope"</span>, gvk.GroupVersion().String(), gvk.Kind)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	interfaces, err := m.interfacesFunc(gvk.GroupVersion())</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"the provided version %q has no relevant versions: %v"</span>, gvk.GroupVersion().String(), err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***构造RESTMapping***//</span></div><div class="line">	<span class="comment">//***RESTMapping中有resource(名称), GVK, scope, convertor, accessor***//</span></div><div class="line">	retVal := &amp;RESTMapping&#123;</div><div class="line">		Resource:         resource.Resource,</div><div class="line">		GroupVersionKind: *gvk,</div><div class="line">		Scope:            scope,</div><div class="line"></div><div class="line">		ObjectConvertor:  interfaces.ObjectConvertor,</div><div class="line">		MetadataAccessor: interfaces.MetadataAccessor,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> retVal, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>RESTMapping()的流程如下：</p>
<ul>
<li>构造GVK：使用GK和Versions，或GK和DefaultGroupVersions，构造GVK；</li>
<li>获取GVR：从kindToPluralResource中获取GVR；</li>
<li>获取scope：从kindToScope中获取scope；</li>
<li>使用interfacesFunc()获取Convertor和MetadataAccessor；</li>
<li>组装成RESTMapping并返回。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>RESTMapper可以从GVR获取GVK，并生成一个RESTMapping来处理该GVR。RESTMapping中有Resource名称，GVK，Scope，Convertor，Accessor等和GVR有关的信息。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/07/22/RESTMapper解读(一)-DefaultRESTMapper-v1-5-2/" data-id="cjadhap6q001f9kqsyxlewtpt" class="article-share-link">分享</a><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></div><div class="post-nav"><a href="/2017/07/23/RESTMapper解读(二)-管理DefaultRESTMapper-v1-5-2/" class="pre">RESTMapper解读(二)-管理DefaultRESTMapper-v1.5.2</a><a href="/2017/07/20/Kubectl概念解读(六)-Describer-v1-5-2/" class="next">Kubectl概念解读(六)-Describer-v1.5.2</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/containerd-v0-2-4/" style="font-size: 15px;">containerd-v0.2.4</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/containerd/" style="font-size: 15px;">containerd</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a> <a href="/tags/runc/" style="font-size: 15px;">runc</a> <a href="/tags/runc-v1-0-0-rc2/" style="font-size: 15px;">runc-v1.0.0-rc2</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/24/containerd-containerd-shim和runc的依存关系/">containerd,containerd-shim和runc的依存关系</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/22/runc源码分析(一)-create和start流程-v1-0-0-rc2/">runc源码分析(一)-create和start流程-v1.0.0-rc2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/19/containerd-shim源码分析-v0-2-4/">containerd-shim源码分析-v0.2.4</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/19/containerd-container和process-v0-2-4/">containerd-container和process-v0.2.4</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/16/containerd执行流程分析-v0-2-4/">containerd执行流程分析-v0.2.4</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/13/containerd-crt命令行使用-v0-2-4/">containerd-crt命令行使用-v0.2.4</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/11/gRPC-demo/">gRPC-demo</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/31/kubernetes-controller分析(四)-garbagecollector-v1-5-2/">kubernetes-controller分析(四)-garbagecollector-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/30/Docker镜像存储代码分析-layerStore-v1-12-3/">Docker镜像存储代码分析-layerStore-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/29/Docker镜像存储代码分析-referenceStore-v1-12-3/">Docker镜像存储代码分析-referenceStore-v1.12.3</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>