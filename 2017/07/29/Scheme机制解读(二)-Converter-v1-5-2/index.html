<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Scheme机制解读(二)-Converter-v1.5.2 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Scheme机制解读(二)-Converter-v1.5.2</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Scheme机制解读(二)-Converter-v1.5.2</h1><div class="post-meta">Jul 29, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="什么是Converter"><a href="#什么是Converter" class="headerlink" title="什么是Converter"></a>什么是Converter</h2><p>Converter可以完成不同结构体之间的转换。在Kubernetes中，Converter用来把一个版本的object转换成其他版本的object，转换函数需要通过注册的方式添加到Converter中。</p>
<p>先来看下Converter的定义，Converter定义在/pkg/conversion/converter.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Converter knows how to convert one type to another.</span></div><div class="line"><span class="keyword">type</span> Converter <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// Map from the conversion pair to a function which can</span></div><div class="line">	<span class="comment">// do the conversion.</span></div><div class="line">	<span class="comment">//***普通转换函数***//</span></div><div class="line">	conversionFuncs ConversionFuncs</div><div class="line">	<span class="comment">//***自动生成的转换函数***//</span></div><div class="line">	generatedConversionFuncs ConversionFuncs</div><div class="line"></div><div class="line">	<span class="comment">// genericConversions are called during normal conversion to offer a "fast-path"</span></div><div class="line">	<span class="comment">// that avoids all reflection. These methods are not called outside of the .Convert()</span></div><div class="line">	<span class="comment">// method.</span></div><div class="line">	<span class="comment">//***优先级最高***//</span></div><div class="line">	genericConversions []GenericConversionFunc</div><div class="line"></div><div class="line">	<span class="comment">// Set of conversions that should be treated as a no-op</span></div><div class="line">	<span class="comment">//***需要忽略的转换***//</span></div><div class="line">	ignoredConversions <span class="keyword">map</span>[typePair]<span class="keyword">struct</span>&#123;&#125;</div><div class="line"></div><div class="line">	<span class="comment">// This is a map from a source field type and name, to a list of destination</span></div><div class="line">	<span class="comment">// field type and name.</span></div><div class="line">	structFieldDests <span class="keyword">map</span>[typeNamePair][]typeNamePair</div><div class="line"></div><div class="line">	<span class="comment">// Allows for the opposite lookup of structFieldDests. So that SourceFromDest</span></div><div class="line">	<span class="comment">// copy flag also works. So this is a map of destination field name, to potential</span></div><div class="line">	<span class="comment">// source field name and type to look for.</span></div><div class="line">	structFieldSources <span class="keyword">map</span>[typeNamePair][]typeNamePair</div><div class="line"></div><div class="line">	<span class="comment">// Map from a type to a function which applies defaults.</span></div><div class="line">	<span class="comment">//***设置默认值函数***//</span></div><div class="line">	defaultingFuncs <span class="keyword">map</span>[reflect.Type]reflect.Value</div><div class="line"></div><div class="line">	<span class="comment">// Similar to above, but function is stored as interface&#123;&#125;.</span></div><div class="line">	defaultingInterfaces <span class="keyword">map</span>[reflect.Type]<span class="keyword">interface</span>&#123;&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Map from an input type to a function which can apply a key name mapping</span></div><div class="line">	inputFieldMappingFuncs <span class="keyword">map</span>[reflect.Type]FieldMappingFunc</div><div class="line"></div><div class="line">	<span class="comment">// Map from an input type to a set of default conversion flags.</span></div><div class="line">	inputDefaultFlags <span class="keyword">map</span>[reflect.Type]FieldMatchingFlags</div><div class="line"></div><div class="line">	<span class="comment">// If non-nil, will be called to print helpful debugging info. Quite verbose.</span></div><div class="line">	Debug DebugLogger</div><div class="line"></div><div class="line">	<span class="comment">// nameFunc is called to retrieve the name of a type; this name is used for the</span></div><div class="line">	<span class="comment">// purpose of deciding whether two types match or not (i.e., will we attempt to</span></div><div class="line">	<span class="comment">// do a conversion). The default returns the go type name.</span></div><div class="line">	nameFunc <span class="function"><span class="keyword">func</span><span class="params">(t reflect.Type)</span> <span class="title">string</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Converter结构体的字段涵义如下：</p>
<ul>
<li>conversionFuncs: 普通转换函数，通过RegisterConversionFunc()方法进行注册；</li>
<li>generatedConversionFuncs: 自动生成的转换函数，通过RegisterGeneratedConversionFunc()方法进行注册；</li>
<li>genericConversions：通用转换函数，优化级最高的转换函数，可以理解为转换的快速通道，通过AddGenericConversionFunc()方法进行注册；</li>
<li>ignoredConversions：需要忽略的转换，如果两个结构体之间不允许转换，则通过RegisterIgnoredConversion()方法进行注册；</li>
<li>structFieldDests：源结构体中字段到目标结构体中的字段的映射关系，通过SetStructFieldCopy()方法进行注册；</li>
<li>structFieldSources：与structFieldDests相反，是目的结构体中字段到源结构体中的字段的映射关系，通过SetStructFieldCopy()方法进行注册；</li>
<li>defaultingFuncs：设置结构体值的默认值，通过RegisterDefaultingFunc()方法进行注册；</li>
<li>inputFieldMappingFuncs：暂不知道用途；</li>
<li>inputDefaultFlags：暂不知道用途；</li>
<li>nameFunc：获取结构体名称的函数。</li>
</ul>
<p>Converter的生成方法如下，只要传入NameFunc即可：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewConverter creates a new Converter object.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewConverter</span><span class="params">(nameFn NameFunc)</span> *<span class="title">Converter</span></span> &#123;</div><div class="line">	c := &amp;Converter&#123;</div><div class="line">		conversionFuncs:          NewConversionFuncs(),</div><div class="line">		generatedConversionFuncs: NewConversionFuncs(),</div><div class="line">		ignoredConversions:       <span class="built_in">make</span>(<span class="keyword">map</span>[typePair]<span class="keyword">struct</span>&#123;&#125;),</div><div class="line">		defaultingFuncs:          <span class="built_in">make</span>(<span class="keyword">map</span>[reflect.Type]reflect.Value),</div><div class="line">		defaultingInterfaces:     <span class="built_in">make</span>(<span class="keyword">map</span>[reflect.Type]<span class="keyword">interface</span>&#123;&#125;),</div><div class="line">		nameFunc:                 nameFn,</div><div class="line">		structFieldDests:         <span class="built_in">make</span>(<span class="keyword">map</span>[typeNamePair][]typeNamePair),</div><div class="line">		structFieldSources:       <span class="built_in">make</span>(<span class="keyword">map</span>[typeNamePair][]typeNamePair),</div><div class="line"></div><div class="line">		inputFieldMappingFuncs: <span class="built_in">make</span>(<span class="keyword">map</span>[reflect.Type]FieldMappingFunc),</div><div class="line">		inputDefaultFlags:      <span class="built_in">make</span>(<span class="keyword">map</span>[reflect.Type]FieldMatchingFlags),</div><div class="line">	&#125;</div><div class="line">	c.RegisterConversionFunc(Convert_Slice_byte_To_Slice_byte)</div><div class="line">	<span class="keyword">return</span> c</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>关于NameFunc，只要实现返回一个结构体的“名字”就行，如：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> DefaultNameFunc = <span class="function"><span class="keyword">func</span><span class="params">(t reflect.Type)</span> <span class="title">string</span></span> &#123; <span class="keyword">return</span> t.Name() &#125;</div></pre></td></tr></table></figure></p>
<p>在介绍Converter的方法之前，先介绍ConversionFuncs和scope两个概念。</p>
<h2 id="ConversionFuncs"><a href="#ConversionFuncs" class="headerlink" title="ConversionFuncs"></a>ConversionFuncs</h2><p>在Converter的字段中，不管是conversionFuncs，还是generatedConversionFuncs，都是结构体ConversionFuncs。结构体ConversionFuncs用来管理转换函数，定义在/pkg/conversin/converter.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> typePair <span class="keyword">struct</span> &#123;</div><div class="line">	source reflect.Type</div><div class="line">	dest   reflect.Type</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> ConversionFuncs <span class="keyword">struct</span> &#123;</div><div class="line">	fns <span class="keyword">map</span>[typePair]reflect.Value</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在ConversionFuncs结构体中，只有一个字段<code>fns map[typePair]reflect.Value</code>，即{source, dest}到转换函数的映射表。</p>
<p>再来看ConversionFuncs支持的方法。</p>
<h3 id="Add"><a href="#Add" class="headerlink" title="Add()"></a>Add()</h3><p>ConversionFuncs的Add()方法的参数是转换函数(<code>func(type1, type2, Scope) error</code>)，然后提取转换函数第一个参数的类型作为source，提取第二个参数的类型作为dest，然后把{source, dest}作为key，转换函数作为value，一起存储到fns字段中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c ConversionFuncs)</span> <span class="title">Add</span><span class="params">(fns ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, fn := <span class="keyword">range</span> fns &#123;</div><div class="line">		fv := reflect.ValueOf(fn)</div><div class="line">		ft := fv.Type()</div><div class="line">		<span class="keyword">if</span> err := verifyConversionFunctionSignature(ft); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		c.fns[typePair&#123;ft.In(<span class="number">0</span>).Elem(), ft.In(<span class="number">1</span>).Elem()&#125;] = fv</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Merge"><a href="#Merge" class="headerlink" title="Merge()"></a>Merge()</h3><p>ConversionFuncs的Merge()方法可以把两个ConversionFuncs中的转换函数融合成一个ConversionFuncs。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c ConversionFuncs)</span> <span class="title">Merge</span><span class="params">(other ConversionFuncs)</span> <span class="title">ConversionFuncs</span></span> &#123;</div><div class="line">	merged := NewConversionFuncs()</div><div class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> c.fns &#123;</div><div class="line">		merged.fns[k] = v</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> other.fns &#123;</div><div class="line">		merged.fns[k] = v</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> merged</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Scope"><a href="#Scope" class="headerlink" title="Scope"></a>Scope</h2><p>Scope是一个interface，所以我们来分析其实现者scope。</p>
<p>scope包含了递归转换中需要的一些内容。先来看下scope的定义，同样在/pkg/conversion/converter.go中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// scope contains information about an ongoing conversion.</span></div><div class="line"><span class="keyword">type</span> scope <span class="keyword">struct</span> &#123;</div><div class="line">	converter *Converter</div><div class="line">	meta      *Meta</div><div class="line">	flags     FieldMatchingFlags</div><div class="line"></div><div class="line">	<span class="comment">// srcStack &amp; destStack are separate because they may not have a 1:1</span></div><div class="line">	<span class="comment">// relationship.</span></div><div class="line">	srcStack  scopeStack</div><div class="line">	destStack scopeStack</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>来看scope的字段：</p>
<ul>
<li>converter：scope包含一个converter，以方便递归转换；</li>
<li>meta：暂不知道用途；</li>
<li><p>flags：转换时字段的策略，定义如下，可以使用IsSet()方法判断对应的flag是否被设置。<br>其中：<br>DestFromSource表示循环目标结构体字段，寻找合适的源结构体字段；<br>SourceToDest表示循环源结构体字段，寻找合适的目标结构体字段；<br>IgnoreMissingFields表示如果未找到合适的目标不报错；<br>AllowDifferentFieldTypeNames表示允许源结构体和目标结构体不同的类型相匹配。<br>具体定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> FieldMatchingFlags <span class="keyword">int</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	<span class="comment">// Loop through destination fields, search for matching source</span></div><div class="line">	<span class="comment">// field to copy it from. Source fields with no corresponding</span></div><div class="line">	<span class="comment">// destination field will be ignored. If SourceToDest is</span></div><div class="line">	<span class="comment">// specified, this flag is ignored. If neither is specified,</span></div><div class="line">	<span class="comment">// or no flags are passed, this flag is the default.</span></div><div class="line">	DestFromSource FieldMatchingFlags = <span class="number">0</span></div><div class="line">	<span class="comment">// Loop through source fields, search for matching dest field</span></div><div class="line">	<span class="comment">// to copy it into. Destination fields with no corresponding</span></div><div class="line">	<span class="comment">// source field will be ignored.</span></div><div class="line">	SourceToDest FieldMatchingFlags = <span class="number">1</span> &lt;&lt; <span class="literal">iota</span></div><div class="line">	<span class="comment">// Don't treat it as an error if the corresponding source or</span></div><div class="line">	<span class="comment">// dest field can't be found.</span></div><div class="line">	IgnoreMissingFields</div><div class="line">	<span class="comment">// Don't require type names to match.</span></div><div class="line">	AllowDifferentFieldTypeNames</div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">//***此处的DestFromSource 0作特殊处理，其他的用&amp;操作来判断是否设置***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f FieldMatchingFlags)</span> <span class="title">IsSet</span><span class="params">(flag FieldMatchingFlags)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> flag == DestFromSource &#123;</div><div class="line">		<span class="comment">// The bit logic doesn't work on the default value.</span></div><div class="line">		<span class="keyword">return</span> f&amp;SourceToDest != SourceToDest</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> f&amp;flag == flag</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>srcStack, destStack：字段信息栈。scopeStack定义如下，其中scopeStackElem表示字段，包含了key, value, tag三部分信息；scopeStack实现了scopeStackElem栈，以配合递归转换:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> scopeStackElem <span class="keyword">struct</span> &#123;</div><div class="line">	tag   reflect.StructTag</div><div class="line">	value reflect.Value</div><div class="line">	key   <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> scopeStack []scopeStackElem</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *scopeStack)</span> <span class="title">pop</span><span class="params">()</span></span> &#123;</div><div class="line">	n := <span class="built_in">len</span>(*s)</div><div class="line">	*s = (*s)[:n<span class="number">-1</span>]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *scopeStack)</span> <span class="title">push</span><span class="params">(e scopeStackElem)</span></span> &#123;</div><div class="line">	*s = <span class="built_in">append</span>(*s, e)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *scopeStack)</span> <span class="title">top</span><span class="params">()</span> *<span class="title">scopeStackElem</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;(*s)[<span class="built_in">len</span>(*s)<span class="number">-1</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>可以看出，scope包含了converter。之前说过，转换函数一般为<code>func(type1, type2, Scope) error</code>，如果转换函数中有转换的需要，则可以使用scope的converter进行进一步转换。</p>
<h3 id="Convert"><a href="#Convert" class="headerlink" title="Convert()"></a>Convert()</h3><p>scope封装了converter.Convert()方法。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Convert continues a conversion.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *scope)</span> <span class="title">Convert</span><span class="params">(src, dest <span class="keyword">interface</span>&#123;&#125;, flags FieldMatchingFlags)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> s.converter.Convert(src, dest, flags, s.meta)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="注册方法"><a href="#注册方法" class="headerlink" title="注册方法"></a>注册方法</h2><p>Converter注册类有方法是供注册时调用的方法。主要有：</p>
<h3 id="RegisterConversionFunc"><a href="#RegisterConversionFunc" class="headerlink" title="RegisterConversionFunc()"></a>RegisterConversionFunc()</h3><p>RegisterConversionFunc()可以把conversionFunc注册到Converter的conversionFuncs中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">RegisterConversionFunc</span><span class="params">(conversionFunc <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> c.conversionFuncs.Add(conversionFunc)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RegisterGeneratedConversionFunc"><a href="#RegisterGeneratedConversionFunc" class="headerlink" title="RegisterGeneratedConversionFunc()"></a>RegisterGeneratedConversionFunc()</h3><p>RegisterGeneratedConversionFunc()可以把conversionFunc注册到Converter的generatedConversionFuncs中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***从字面上可以理解，这些转换函数是某些机制自动生成的***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">RegisterGeneratedConversionFunc</span><span class="params">(conversionFunc <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> c.generatedConversionFuncs.Add(conversionFunc)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RegisterIgnoredConversion"><a href="#RegisterIgnoredConversion" class="headerlink" title="RegisterIgnoredConversion()"></a>RegisterIgnoredConversion()</h3><p>RegisterIgnoredConversion()可以把需要忽略的{from, to}注册到Converter的ignoredConversions中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">RegisterIgnoredConversion</span><span class="params">(from, to <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	typeFrom := reflect.TypeOf(from)</div><div class="line">	typeTo := reflect.TypeOf(to)</div><div class="line">	<span class="keyword">if</span> reflect.TypeOf(from).Kind() != reflect.Ptr &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"expected pointer arg for 'from' param 0, got: %v"</span>, typeFrom)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> typeTo.Kind() != reflect.Ptr &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"expected pointer arg for 'to' param 1, got: %v"</span>, typeTo)</div><div class="line">	&#125;</div><div class="line">	c.ignoredConversions[typePair&#123;typeFrom.Elem(), typeTo.Elem()&#125;] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RegisterDefaultingFunc"><a href="#RegisterDefaultingFunc" class="headerlink" title="RegisterDefaultingFunc()"></a>RegisterDefaultingFunc()</h3><p>RegisterDefaultingFunc()可以把defaultingFunc注册到Converter的defaultingFuncs和defaultingInterfaces中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***注册DefaultingFunc入口***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">RegisterDefaultingFunc</span><span class="params">(defaultingFunc <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	fv := reflect.ValueOf(defaultingFunc)</div><div class="line">	ft := fv.Type()</div><div class="line">	<span class="keyword">if</span> ft.Kind() != reflect.Func &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"expected func, got: %v"</span>, ft)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> ft.NumIn() != <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"expected one 'in' param, got: %v"</span>, ft)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> ft.NumOut() != <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"expected zero 'out' params, got: %v"</span>, ft)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> ft.In(<span class="number">0</span>).Kind() != reflect.Ptr &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"expected pointer arg for 'in' param 0, got: %v"</span>, ft)</div><div class="line">	&#125;</div><div class="line">	inType := ft.In(<span class="number">0</span>).Elem()</div><div class="line">	c.defaultingFuncs[inType] = fv</div><div class="line">	c.defaultingInterfaces[inType] = defaultingFunc</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RegisterInputDefaults"><a href="#RegisterInputDefaults" class="headerlink" title="RegisterInputDefaults()"></a>RegisterInputDefaults()</h3><p>RegisterInputDefaults()可以把相关内容注册到Converter的inputFieldMappingFuncs和inputDefaultFlags中。但inputFieldMappingFuncs和inputDefaultFlags的具体用途目前还不清楚。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">RegisterInputDefaults</span><span class="params">(in <span class="keyword">interface</span>&#123;&#125;, fn FieldMappingFunc, defaultFlags FieldMatchingFlags)</span> <span class="title">error</span></span> &#123;</div><div class="line">	fv := reflect.ValueOf(in)</div><div class="line">	ft := fv.Type()</div><div class="line">	<span class="keyword">if</span> ft.Kind() != reflect.Ptr &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"expected pointer 'in' argument, got: %v"</span>, ft)</div><div class="line">	&#125;</div><div class="line">	c.inputFieldMappingFuncs[ft] = fn</div><div class="line">	c.inputDefaultFlags[ft] = defaultFlags</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="SetStructFieldCopy"><a href="#SetStructFieldCopy" class="headerlink" title="SetStructFieldCopy()"></a>SetStructFieldCopy()</h3><p>SetStructFieldCopy()把结构体间字段关系注册到Converter的structFieldDests和structFieldSources中。结构体间字段关系转换优先级高于同名字段转换。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">SetStructFieldCopy</span><span class="params">(srcFieldType <span class="keyword">interface</span>&#123;&#125;, srcFieldName <span class="keyword">string</span>, destFieldType <span class="keyword">interface</span>&#123;&#125;, destFieldName <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	st := reflect.TypeOf(srcFieldType)</div><div class="line">	dt := reflect.TypeOf(destFieldType)</div><div class="line">	srcKey := typeNamePair&#123;st, srcFieldName&#125;</div><div class="line">	destKey := typeNamePair&#123;dt, destFieldName&#125;</div><div class="line">	c.structFieldDests[srcKey] = <span class="built_in">append</span>(c.structFieldDests[srcKey], destKey)</div><div class="line">	c.structFieldSources[destKey] = <span class="built_in">append</span>(c.structFieldSources[destKey], srcKey)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="转换方法"><a href="#转换方法" class="headerlink" title="转换方法"></a>转换方法</h2><p>Converter的转换函数优先级为：</p>
<ol>
<li>使用genericConversions中的转换函数；</li>
<li>检查是否在ignoredConversions中，如果是则直接返回；</li>
<li>使用conversionFuncs中的转换函数；</li>
<li>使用generatedConversionFuncs中的转换函数；</li>
<li>使用defaultConvert()方法转换，defaultConvert()方法会递归式地对字段进行转换。</li>
</ol>
<h3 id="Convert-1"><a href="#Convert-1" class="headerlink" title="Convert()"></a>Convert()</h3><p>Convert()是Converter的转换的入口。Convert()先尝试使用genericcConversions中的转换函数去完成转换，如果成功，则返回；否则，调用doConversion()，传入的conversionFunc为convert()方法。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***转换函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">Convert</span><span class="params">(src, dest <span class="keyword">interface</span>&#123;&#125;, flags FieldMatchingFlags, meta *Meta)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(c.genericConversions) &gt; <span class="number">0</span> &#123;</div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> avoid scope allocation</span></div><div class="line">		s := &amp;scope&#123;converter: c, flags: flags, meta: meta&#125;</div><div class="line">		<span class="comment">//***逐个尝试genericConversions中的转换函数***//</span></div><div class="line">		<span class="keyword">for</span> _, fn := <span class="keyword">range</span> c.genericConversions &#123;</div><div class="line">			<span class="keyword">if</span> ok, err := fn(src, dest, s); ok &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***调用doConversion()***//</span></div><div class="line">	<span class="keyword">return</span> c.doConversion(src, dest, flags, meta, c.convert)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="DefaultConvert"><a href="#DefaultConvert" class="headerlink" title="DefaultConvert()"></a>DefaultConvert()</h3><p>DefaultConvert()直接调用doConversion()方法进行转换。传入的conversionFunc为defaultConvert()方法。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">DefaultConvert</span><span class="params">(src, dest <span class="keyword">interface</span>&#123;&#125;, flags FieldMatchingFlags, meta *Meta)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> c.doConversion(src, dest, flags, meta, c.defaultConvert)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="doConversion"><a href="#doConversion" class="headerlink" title="doConversion()"></a>doConversion()</h3><p>doConversion()在进行一系列的检查后，调用参数f，即convert()或defaultConvert()方法。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***转换函数***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">doConversion</span><span class="params">(src, dest <span class="keyword">interface</span>&#123;&#125;, flags FieldMatchingFlags, meta *Meta, f conversionFunc)</span> <span class="title">error</span></span> &#123;</div><div class="line">	dv, err := EnforcePtr(dest)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***dest必须是可写的***//</span></div><div class="line">	<span class="keyword">if</span> !dv.CanAddr() &amp;&amp; !dv.CanSet() &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"can't write to dest"</span>)</div><div class="line">	&#125;</div><div class="line">	sv, err := EnforcePtr(src)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	s := &amp;scope&#123;</div><div class="line">		converter: c,</div><div class="line">		flags:     flags,</div><div class="line">		meta:      meta,</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Leave something on the stack, so that calls to struct tag getters never fail.</span></div><div class="line">	s.srcStack.push(scopeStackElem&#123;&#125;)</div><div class="line">	s.destStack.push(scopeStackElem&#123;&#125;)</div><div class="line">	<span class="keyword">return</span> f(sv, dv, s)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="convert"><a href="#convert" class="headerlink" title="convert()"></a>convert()</h3><p>convert()的流程如下：</p>
<ol>
<li>获取源和目标的类型；</li>
<li>设置源的默认值；</li>
<li>判断是否在ignoredConversions中；</li>
<li>尝试从conversionFuncs中获取转换函数进行转换；</li>
<li>尝试从generatedConversionFuncs中获取转换函数进行转换；</li>
<li>尝试默认的转换函数，即defaultConvert()。<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">convert</span><span class="params">(sv, dv reflect.Value, scope *scope)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">//***获取源和目标的类型***//</span></div><div class="line">	dt, st := dv.Type(), sv.Type()</div><div class="line">	<span class="comment">// Apply default values.</span></div><div class="line">	<span class="comment">//***设置默认值***//</span></div><div class="line">	<span class="keyword">if</span> fv, ok := c.defaultingFuncs[st]; ok &#123;</div><div class="line">		<span class="keyword">if</span> c.Debug != <span class="literal">nil</span> &#123;</div><div class="line">			c.Debug.Logf(<span class="string">"Applying defaults for '%v'"</span>, st)</div><div class="line">		&#125;</div><div class="line">		args := []reflect.Value&#123;sv.Addr()&#125;</div><div class="line">		fv.Call(args)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	pair := typePair&#123;st, dt&#125;</div><div class="line"></div><div class="line">	<span class="comment">// ignore conversions of this type</span></div><div class="line">	<span class="comment">//***判断是否在ignoredConversions中***//</span></div><div class="line">	<span class="keyword">if</span> _, ok := c.ignoredConversions[pair]; ok &#123;</div><div class="line">		<span class="keyword">if</span> c.Debug != <span class="literal">nil</span> &#123;</div><div class="line">			c.Debug.Logf(<span class="string">"Ignoring conversion of '%v' to '%v'"</span>, st, dt)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Convert sv to dv.</span></div><div class="line">	<span class="comment">//***获取转换函数，并执行***//</span></div><div class="line">	<span class="keyword">if</span> fv, ok := c.conversionFuncs.fns[pair]; ok &#123;</div><div class="line">		<span class="keyword">if</span> c.Debug != <span class="literal">nil</span> &#123;</div><div class="line">			c.Debug.Logf(<span class="string">"Calling custom conversion of '%v' to '%v'"</span>, st, dt)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> c.callCustom(sv, dv, fv, scope)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***尝试generatedConversionFuncs***//</span></div><div class="line">	<span class="keyword">if</span> fv, ok := c.generatedConversionFuncs.fns[pair]; ok &#123;</div><div class="line">		<span class="keyword">if</span> c.Debug != <span class="literal">nil</span> &#123;</div><div class="line">			c.Debug.Logf(<span class="string">"Calling generated conversion of '%v' to '%v'"</span>, st, dt)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> c.callCustom(sv, dv, fv, scope)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***Fankang***//</span></div><div class="line">	<span class="comment">//***尝试默认的转换函数***//</span></div><div class="line">	<span class="keyword">return</span> c.defaultConvert(sv, dv, scope)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="defaultConvert"><a href="#defaultConvert" class="headerlink" title="defaultConvert()"></a>defaultConvert()</h3><p>defaultConvert()在转换时，如果源字段是基础类型，则调用reflect.Value的Set()方法直接对目标字段设置；否则按照目标字段的类型(此处按目标字段类型是可以先对源类型进行处理，然后再转换)进行不同处理，这里可能使用的就是递归转换。</p>
<p>因为defaultConvert()中定义有对基础类型的转换函数，所以递归迟早会结束。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">defaultConvert</span><span class="params">(sv, dv reflect.Value, scope *scope)</span> <span class="title">error</span></span> &#123;</div><div class="line">	dt, st := dv.Type(), sv.Type()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> !dv.CanSet() &#123;</div><div class="line">		<span class="keyword">return</span> scope.errorf(<span class="string">"Cannot set dest. (Tried to deep copy something with unexported fields?)"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> !scope.flags.IsSet(AllowDifferentFieldTypeNames) &amp;&amp; c.nameFunc(dt) != c.nameFunc(st) &#123;</div><div class="line">		<span class="keyword">return</span> scope.errorf(</div><div class="line">			<span class="string">"type names don't match (%v, %v), and no conversion 'func (%v, %v) error' registered."</span>,</div><div class="line">			c.nameFunc(st), c.nameFunc(dt), st, dt)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">switch</span> st.Kind() &#123;</div><div class="line">	<span class="keyword">case</span> reflect.Map, reflect.Ptr, reflect.Slice, reflect.Interface, reflect.Struct:</div><div class="line">		<span class="comment">// Don't copy these via assignment/conversion!</span></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="comment">// This should handle all simple types.</span></div><div class="line">		<span class="keyword">if</span> st.AssignableTo(dt) &#123;</div><div class="line">			dv.Set(sv)</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> st.ConvertibleTo(dt) &#123;</div><div class="line">			dv.Set(sv.Convert(dt))</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> c.Debug != <span class="literal">nil</span> &#123;</div><div class="line">		c.Debug.Logf(<span class="string">"Trying to convert '%v' to '%v'"</span>, st, dt)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***把“字段”压入栈***//</span></div><div class="line">	scope.srcStack.push(scopeStackElem&#123;value: sv&#125;)</div><div class="line">	scope.destStack.push(scopeStackElem&#123;value: dv&#125;)</div><div class="line">	<span class="keyword">defer</span> scope.srcStack.pop()</div><div class="line">	<span class="keyword">defer</span> scope.destStack.pop()</div><div class="line"></div><div class="line">	<span class="keyword">switch</span> dv.Kind() &#123;</div><div class="line">	<span class="keyword">case</span> reflect.Struct:</div><div class="line">		<span class="comment">//***如果是struct，则调用convertKV()***//</span></div><div class="line">		<span class="keyword">return</span> c.convertKV(toKVValue(sv), toKVValue(dv), scope)</div><div class="line">	<span class="keyword">case</span> reflect.Slice:</div><div class="line">		<span class="keyword">if</span> sv.IsNil() &#123;</div><div class="line">			<span class="comment">// Don't make a zero-length slice.</span></div><div class="line">			dv.Set(reflect.Zero(dt))</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		dv.Set(reflect.MakeSlice(dt, sv.Len(), sv.Cap()))</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; sv.Len(); i++ &#123;</div><div class="line">			scope.setIndices(i, i)</div><div class="line">			<span class="keyword">if</span> err := c.convert(sv.Index(i), dv.Index(i), scope); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">case</span> reflect.Ptr:</div><div class="line">		<span class="keyword">if</span> sv.IsNil() &#123;</div><div class="line">			<span class="comment">// Don't copy a nil ptr!</span></div><div class="line">			dv.Set(reflect.Zero(dt))</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		dv.Set(reflect.New(dt.Elem()))</div><div class="line">		<span class="keyword">switch</span> st.Kind() &#123;</div><div class="line">		<span class="keyword">case</span> reflect.Ptr, reflect.Interface:</div><div class="line">			<span class="keyword">return</span> c.convert(sv.Elem(), dv.Elem(), scope)</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			<span class="keyword">return</span> c.convert(sv, dv.Elem(), scope)</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">case</span> reflect.Map:</div><div class="line">		<span class="keyword">if</span> sv.IsNil() &#123;</div><div class="line">			<span class="comment">// Don't copy a nil ptr!</span></div><div class="line">			dv.Set(reflect.Zero(dt))</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		dv.Set(reflect.MakeMap(dt))</div><div class="line">		<span class="keyword">for</span> _, sk := <span class="keyword">range</span> sv.MapKeys() &#123;</div><div class="line">			dk := reflect.New(dt.Key()).Elem()</div><div class="line">			<span class="keyword">if</span> err := c.convert(sk, dk, scope); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">			dkv := reflect.New(dt.Elem()).Elem()</div><div class="line">			scope.setKeys(sk.Interface(), dk.Interface())</div><div class="line">			<span class="comment">// <span class="doctag">TODO:</span>  sv.MapIndex(sk) may return a value with CanAddr() == false,</span></div><div class="line">			<span class="comment">// because a map[string]struct&#123;&#125; does not allow a pointer reference.</span></div><div class="line">			<span class="comment">// Calling a custom conversion function defined for the map value</span></div><div class="line">			<span class="comment">// will panic. Example is PodInfo map[string]ContainerStatus.</span></div><div class="line">			<span class="keyword">if</span> err := c.convert(sv.MapIndex(sk), dkv, scope); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">			dv.SetMapIndex(dk, dkv)</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">case</span> reflect.Interface:</div><div class="line">		<span class="keyword">if</span> sv.IsNil() &#123;</div><div class="line">			<span class="comment">// Don't copy a nil interface!</span></div><div class="line">			dv.Set(reflect.Zero(dt))</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		tmpdv := reflect.New(sv.Elem().Type()).Elem()</div><div class="line">		<span class="keyword">if</span> err := c.convert(sv.Elem(), tmpdv, scope); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		dv.Set(reflect.ValueOf(tmpdv.Interface()))</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> scope.errorf(<span class="string">"couldn't copy '%v' into '%v'; didn't understand types"</span>, st, dt)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="convertKV"><a href="#convertKV" class="headerlink" title="convertKV()"></a>convertKV()</h3><p>convertKV()可以完成struct之间的转换。当然，struct之间的转换函数是未被定义的，不然流程不会走到defaultConvert()。</p>
<p>convertKV()的流程如下：</p>
<ol>
<li>先根据scope中的flag来确定使用源，还是目标结构体的字段作为标准；</li>
<li>对字段进行checkField()检查，即使用Converter的structFieldDests和structFieldSources来获取对应关系，然后完成转换，具体见checkField()方法分析。</li>
<li>接着使用同名字段转换策略，调用convert()转换字段。<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">convertKV</span><span class="params">(skv, dkv kvValue, scope *scope)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> skv == <span class="literal">nil</span> || dkv == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> add keys to stack to support really understandable error messages.</span></div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"Unable to convert %#v to %#v"</span>, skv, dkv)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	lister := dkv</div><div class="line">	<span class="keyword">if</span> scope.flags.IsSet(SourceToDest) &#123;</div><div class="line">		lister = skv</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> mapping FieldMappingFunc</div><div class="line">	<span class="keyword">if</span> scope.meta != <span class="literal">nil</span> &amp;&amp; scope.meta.KeyNameMapping != <span class="literal">nil</span> &#123;</div><div class="line">		mapping = scope.meta.KeyNameMapping</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, key := <span class="keyword">range</span> lister.keys() &#123;</div><div class="line">		<span class="comment">//***key: A***//</span></div><div class="line">		<span class="keyword">if</span> found, err := c.checkField(key, skv, dkv, scope); found &#123;</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> err</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		stag := skv.tagOf(key)</div><div class="line">		dtag := dkv.tagOf(key)</div><div class="line">		skey := key</div><div class="line">		dkey := key</div><div class="line">		<span class="keyword">if</span> mapping != <span class="literal">nil</span> &#123;</div><div class="line">			skey, dkey = scope.meta.KeyNameMapping(key, stag, dtag)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		df := dkv.value(dkey)</div><div class="line">		sf := skv.value(skey)</div><div class="line">		<span class="keyword">if</span> !df.IsValid() || !sf.IsValid() &#123;</div><div class="line">			<span class="keyword">switch</span> &#123;</div><div class="line">			<span class="keyword">case</span> scope.flags.IsSet(IgnoreMissingFields):</div><div class="line">				<span class="comment">// No error.</span></div><div class="line">			<span class="keyword">case</span> scope.flags.IsSet(SourceToDest):</div><div class="line">				<span class="keyword">return</span> scope.errorf(<span class="string">"%v not present in dest"</span>, dkey)</div><div class="line">			<span class="keyword">default</span>:</div><div class="line">				<span class="keyword">return</span> scope.errorf(<span class="string">"%v not present in src"</span>, skey)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">//		type Foo struct &#123;</span></div><div class="line">		<span class="comment">//			A string `test:"foo"`</span></div><div class="line">		<span class="comment">//		&#125;</span></div><div class="line">		<span class="comment">//		type Bar struct &#123;</span></div><div class="line">		<span class="comment">//			A string `test:"bar"`</span></div><div class="line">		<span class="comment">//		&#125;</span></div><div class="line">		<span class="comment">//***skey: A  stag: test:"foo"  dkey: A  dtag: test:"bar"***//</span></div><div class="line">		<span class="comment">//***sf.Type(): string  df.Type(): string***//</span></div><div class="line">		scope.srcStack.top().key = skey</div><div class="line">		scope.srcStack.top().tag = stag</div><div class="line">		scope.destStack.top().key = dkey</div><div class="line">		scope.destStack.top().tag = dtag</div><div class="line">		<span class="keyword">if</span> err := c.convert(sf, df, scope); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="checkField"><a href="#checkField" class="headerlink" title="checkField()"></a>checkField()</h3><p>checkField()如果设置了DestFromSource flag，则使用先根据目标字段找到源字段的策略找到源字段，然后调用convert()进行转换。如果未设置DestFromSource flag，则使用根据源字段找到目标字段的策略进行转换。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Converter)</span> <span class="title">checkField</span><span class="params">(fieldName <span class="keyword">string</span>, skv, dkv kvValue, scope *scope)</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</div><div class="line">	replacementMade := <span class="literal">false</span></div><div class="line">	<span class="keyword">if</span> scope.flags.IsSet(DestFromSource) &#123;</div><div class="line">		df := dkv.value(fieldName)</div><div class="line">		<span class="keyword">if</span> !df.IsValid() &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		destKey := typeNamePair&#123;df.Type(), fieldName&#125;</div><div class="line">		<span class="comment">// Check each of the potential source (type, name) pairs to see if they're</span></div><div class="line">		<span class="comment">// present in sv.</span></div><div class="line">		<span class="keyword">for</span> _, potentialSourceKey := <span class="keyword">range</span> c.structFieldSources[destKey] &#123;</div><div class="line">			sf := skv.value(potentialSourceKey.fieldName)</div><div class="line">			<span class="keyword">if</span> !sf.IsValid() &#123;</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">//***找到df对应的sf***//</span></div><div class="line">			<span class="keyword">if</span> sf.Type() == potentialSourceKey.fieldType &#123;</div><div class="line">				<span class="comment">// Both the source's name and type matched, so copy.</span></div><div class="line">				scope.srcStack.top().key = potentialSourceKey.fieldName</div><div class="line">				scope.destStack.top().key = fieldName</div><div class="line">				<span class="comment">//***此处调用convert()***//</span></div><div class="line">				<span class="keyword">if</span> err := c.convert(sf, df, scope); err != <span class="literal">nil</span> &#123;</div><div class="line">					<span class="keyword">return</span> <span class="literal">true</span>, err</div><div class="line">				&#125;</div><div class="line">				dkv.confirmSet(fieldName, df)</div><div class="line">				replacementMade = <span class="literal">true</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> replacementMade, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sf := skv.value(fieldName)</div><div class="line">	<span class="keyword">if</span> !sf.IsValid() &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	srcKey := typeNamePair&#123;sf.Type(), fieldName&#125;</div><div class="line">	<span class="comment">// Check each of the potential dest (type, name) pairs to see if they're</span></div><div class="line">	<span class="comment">// present in dv.</span></div><div class="line">	<span class="keyword">for</span> _, potentialDestKey := <span class="keyword">range</span> c.structFieldDests[srcKey] &#123;</div><div class="line">		df := dkv.value(potentialDestKey.fieldName)</div><div class="line">		<span class="keyword">if</span> !df.IsValid() &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> df.Type() == potentialDestKey.fieldType &#123;</div><div class="line">			<span class="comment">// Both the dest's name and type matched, so copy.</span></div><div class="line">			scope.srcStack.top().key = fieldName</div><div class="line">			scope.destStack.top().key = potentialDestKey.fieldName</div><div class="line">			<span class="keyword">if</span> err := c.convert(sf, df, scope); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">true</span>, err</div><div class="line">			&#125;</div><div class="line">			dkv.confirmSet(potentialDestKey.fieldName, df)</div><div class="line">			replacementMade = <span class="literal">true</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> replacementMade, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>最后介绍两个Demo来说明Converter的用法。这两个Demo都取自源码的test文件。调用之前，请确保kubernetes及其依赖都在go的指定目录下。为了更清楚地描述转换过程，在源代码里添加了些打印信息。</p>
<h3 id="Demo1"><a href="#Demo1" class="headerlink" title="Demo1"></a>Demo1</h3><p>Demo1完成了两个复杂类之间的转换，还包含了struct tag的使用(字段信息存储在scope的srcStack和destStack中)。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"reflect"</span></div><div class="line"></div><div class="line">	<span class="string">"k8s.io/kubernetes/pkg/conversion"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> DefaultNameFunc = <span class="function"><span class="keyword">func</span><span class="params">(t reflect.Type)</span> <span class="title">string</span></span> &#123; <span class="keyword">return</span> t.Name() &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">type</span> T1 <span class="keyword">struct</span> &#123;</div><div class="line">		A <span class="keyword">string</span> <span class="string">`test:"foo"`</span></div><div class="line">		B <span class="keyword">string</span> <span class="string">`test1:"foo1"`</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">type</span> T2 <span class="keyword">struct</span> &#123;</div><div class="line">		A <span class="keyword">string</span> <span class="string">`test:"bar"`</span></div><div class="line">		B <span class="keyword">string</span> <span class="string">`test1:"bar1"`</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">type</span> A <span class="keyword">struct</span> &#123;</div><div class="line">		Foo <span class="keyword">string</span></div><div class="line">		Baz <span class="keyword">int</span></div><div class="line">		A   T1</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">type</span> B <span class="keyword">struct</span> &#123;</div><div class="line">		Bar <span class="keyword">string</span></div><div class="line">		Baz <span class="keyword">int</span></div><div class="line">		A   T2</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	c := conversion.NewConverter(DefaultNameFunc)</div><div class="line">	err := c.RegisterConversionFunc(</div><div class="line">		<span class="function"><span class="keyword">func</span><span class="params">(in *A, out *B, s conversion.Scope)</span> <span class="title">error</span></span> &#123;</div><div class="line">			out.Bar = in.Foo</div><div class="line">			s.Convert(&amp;in.Baz, &amp;out.Baz, <span class="number">0</span>)</div><div class="line">			s.Convert(&amp;in.A, &amp;out.A, conversion.AllowDifferentFieldTypeNames)</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Printf(<span class="string">"unexpected error %v"</span>, err)</div><div class="line">	&#125;</div><div class="line">	err = c.RegisterConversionFunc(</div><div class="line">		<span class="function"><span class="keyword">func</span><span class="params">(in *<span class="keyword">string</span>, out *<span class="keyword">string</span>, s conversion.Scope)</span> <span class="title">error</span></span> &#123;</div><div class="line">			<span class="comment">//***此处能获取struct tag***//</span></div><div class="line">			fmt.Println(<span class="string">"Get tag"</span>, s.SrcTag())</div><div class="line">			*out = *in</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">		&#125;,</div><div class="line">	)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Printf(<span class="string">"Unexpected error: %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	x := A&#123;<span class="string">"I am "</span>, <span class="number">3</span>, T1&#123;<span class="string">"years"</span>, <span class="string">"old"</span>&#125;&#125;</div><div class="line">	y := B&#123;&#125;</div><div class="line">	fmt.Println(x)</div><div class="line">	err = c.Convert(&amp;x, &amp;y, <span class="number">0</span>, <span class="literal">nil</span>)</div><div class="line">	fmt.Println(y)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;I am  <span class="number">3</span> &#123;years old&#125;&#125;    <span class="comment">//打印出x，类型为A</span></div><div class="line">Convert from *main.A to *main.B  <span class="comment">//打算从*main.A转换到*main.B</span></div><div class="line">use conversionFuncs main.A main.B    <span class="comment">//因为注册有func(in *A, out *B, s conversion.Scope) error，所以使用conversionFuncs进行转换</span></div><div class="line">Convert from *<span class="keyword">int</span> to *<span class="keyword">int</span>    <span class="comment">//执行s.Convert(&amp;in.Baz, &amp;out.Baz, 0)，准备从*int转换到*int</span></div><div class="line">In defaultConvert() <span class="keyword">int</span> <span class="keyword">int</span>   <span class="comment">//&#123;*int, *int&#125;转换使用defaultConvert()完成转换。</span></div><div class="line">Convert from *main.T1 to *main.T2  <span class="comment">//执行s.Convert(&amp;in.A, &amp;out.A, conversion.AllowDifferentFieldTypeNames)， 准备*main.T1转换到*main.T2</span></div><div class="line">In defaultConvert() main.T1 main.T2  <span class="comment">//在进行&#123;*main.T1, main.T2&#125;转换，未定义转换函数，所以使用defaultConvert()，因为是struct，所以defaultConvert()中使用convertKV()进行转换</span></div><div class="line">In convertKV() <span class="keyword">string</span> <span class="keyword">string</span>   <span class="comment">//转换T1和T2的第一个字段</span></div><div class="line">use conversionFuncs <span class="keyword">string</span> <span class="keyword">string</span>    <span class="comment">//&#123;string, string&#125;的转换函数已经注册，所以使用conversionFuncs进行转换</span></div><div class="line">Get tag test:<span class="string">"foo"</span></div><div class="line">In convertKV() <span class="keyword">string</span> <span class="keyword">string</span> <span class="comment">//转换T1和T2的第二个字段，&#123;string, string&#125;的转换函数已经注册，所以使用conversionFuncs进行转换</span></div><div class="line">use conversionFuncs <span class="keyword">string</span> <span class="keyword">string</span>    <span class="comment">//&#123;string, string&#125;的转换函数已经注册，所以使用conversionFuncs进行转换 </span></div><div class="line">Get tag test1:<span class="string">"foo1"</span></div><div class="line">&#123;I am  <span class="number">3</span> &#123;years old&#125;&#125; <span class="comment">//转换完成，打印y</span></div></pre></td></tr></table></figure></p>
<h3 id="Demo2"><a href="#Demo2" class="headerlink" title="Demo2"></a>Demo2</h3><p>Demo2说明了预定义字段映射关系的用法。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"reflect"</span></div><div class="line"></div><div class="line">	<span class="string">"k8s.io/kubernetes/pkg/conversion"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> DefaultNameFunc = <span class="function"><span class="keyword">func</span><span class="params">(t reflect.Type)</span> <span class="title">string</span></span> &#123; <span class="keyword">return</span> t.Name() &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">type</span> WeirdMeta <span class="keyword">struct</span> &#123;</div><div class="line">		Name <span class="keyword">string</span></div><div class="line">		Type <span class="keyword">string</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">type</span> NameMeta <span class="keyword">struct</span> &#123;</div><div class="line">		Name <span class="keyword">string</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">type</span> TypeMeta <span class="keyword">struct</span> &#123;</div><div class="line">		Type <span class="keyword">string</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">type</span> A <span class="keyword">struct</span> &#123;</div><div class="line">		WeirdMeta</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">type</span> B <span class="keyword">struct</span> &#123;</div><div class="line">		TypeMeta</div><div class="line">		NameMeta</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	c := conversion.NewConverter(DefaultNameFunc)</div><div class="line">	err := c.SetStructFieldCopy(WeirdMeta&#123;&#125;, <span class="string">"WeirdMeta"</span>, TypeMeta&#123;&#125;, <span class="string">"TypeMeta"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Printf(<span class="string">"unexpected error %v"</span>, err)</div><div class="line">	&#125;</div><div class="line">	err = c.SetStructFieldCopy(WeirdMeta&#123;&#125;, <span class="string">"WeirdMeta"</span>, NameMeta&#123;&#125;, <span class="string">"NameMeta"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Printf(<span class="string">"unexpected error %v"</span>, err)</div><div class="line">	&#125;</div><div class="line">	err = c.SetStructFieldCopy(TypeMeta&#123;&#125;, <span class="string">"TypeMeta"</span>, WeirdMeta&#123;&#125;, <span class="string">"WeirdMeta"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Printf(<span class="string">"unexpected error %v"</span>, err)</div><div class="line">	&#125;</div><div class="line">	err = c.SetStructFieldCopy(NameMeta&#123;&#125;, <span class="string">"NameMeta"</span>, WeirdMeta&#123;&#125;, <span class="string">"WeirdMeta"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Printf(<span class="string">"unexpected error %v"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	aVal := &amp;A&#123;</div><div class="line">		WeirdMeta: WeirdMeta&#123;</div><div class="line">			Name: <span class="string">"Foo"</span>,</div><div class="line">			Type: <span class="string">"Bar"</span>,</div><div class="line">		&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	bVal := &amp;B&#123;</div><div class="line">		TypeMeta: TypeMeta&#123;<span class="string">"Bar"</span>&#125;,</div><div class="line">		NameMeta: NameMeta&#123;<span class="string">"Foo"</span>&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	fmt.Println(aVal)</div><div class="line">	err = c.Convert(aVal, bVal, conversion.AllowDifferentFieldTypeNames, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(err)</div><div class="line">	&#125;</div><div class="line">	fmt.Println(bVal)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&amp;&#123;&#123;Foo Bar&#125;&#125;             //打印aVal     </div><div class="line">Convert from *main.A to *main.B   //准备从*main.A转换到*main.B</div><div class="line">In defaultConvert() main.A main.B    //因为没有注册&#123;*main.A, *main.B&#125;的转换函数，所以默认使用defaultConvert()</div><div class="line">In checkField() convert from main.WeirdMeta to main.TypeMeta   //因为注册有字段对应关系，所以使用checkField()，默认使用是的从目标字段查找源字段。准备从*main.WeirdMeta转换到*main.TypeMeta。</div><div class="line">In defaultConvert() main.WeirdMeta main.TypeMeta  //因为没有注册&#123;*main.WeirdMeta, *main.TypeMeta&#125;的转换函数，所以使用defaultConvert()</div><div class="line">In convertKV() string string //因为是结构体，所以将调用convertKV()，找到同名的字段，开始转换</div><div class="line">In defaultConvert() string string  //因为没有注册&#123;*string, *string&#125;的转换函数，所以使用defaultConvert()完成转换</div><div class="line">In checkField() convert from main.WeirdMeta to main.NameMeta //目标结构体的第二个字段，准备从*main.WeirdMeta转换到*main.NameMeta</div><div class="line">In defaultConvert() main.WeirdMeta main.NameMeta //因为没有注册&#123;*main.WeirdMeta, *main.NameMeta&#125;的转换函数，所以使用defaultConvert()</div><div class="line">In convertKV() string string    //因为是结构体，所以将调用convertKV()，找到同名的字段，开始转换</div><div class="line">In defaultConvert() string string  //因为没有注册&#123;*string, *string&#125;的转换函数，所以使用defaultConvert()完成转换</div><div class="line">&amp;&#123;&#123;Bar&#125; &#123;Foo&#125;&#125; //转换完成，打印bVal</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Converter先使用genericConversionFunc进行转换，如果不成功，再使用conversionFunc进行转换，如果不成功，再按generatedConversionFunc进行转换，如果不成功，最后交由DefaultConvert()转换。</p>
<p>DefaultConvert()中如果转换类型是简单类型，则直接转换；如果是结构体，则先看是否有字段关系定义，如果有，则按map定义的来，否则按同名转换原则进行转换；其他的类型也有相应的方法进行转换。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/07/29/Scheme机制解读(二)-Converter-v1-5-2/" data-id="cj9c3hsm1001858qsidoooly7" class="article-share-link">分享</a><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></div><div class="post-nav"><a href="/2017/07/30/Scheme机制解读(三)-Cloner-v1-5-2/" class="pre">Scheme机制解读(三)-Cloner-v1.5.2</a><a href="/2017/07/27/Scheme机制解读(一)-Scheme-v1-5-2/" class="next">Scheme机制解读(一)-Scheme-v1.5.2</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/Go语言/">Go语言</a></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/29/Docker镜像存储代码分析-v1-12-3/">Docker镜像存储代码分析-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/26/kube-controller分析(三)-NamespaceController-v1-5-2/">kube-controller分析(三)-NamespaceController-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/25/kubernetes-watcher-demo/">kubernetes-watcher-demo</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/24/kube-controller分析(二)-finalizer机制-v1-5-2/">kube-controller分析(二)-finalizer机制-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/19/kube-controller分析(一)-sharedInformerFactory解读-v1-5-2/">kube-controller分析(一)-sharedInformerFactory解读-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/18/kubernetes-client分析(四)-ClientSet-v1-5-2/">kubernetes-client分析(四)-ClientSet-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/16/kubernetes-client分析(三)-dynamicClient-v1-5-2/">kubernetes-client分析(三)-dynamicClient-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/13/kubernetes-client分析(二)-restclient-v1-5-2/">kubernetes-client分析(二)-restclient-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/12/kubernetes-client分析(一)-kubeconfig-v1-5-2/">kubernetes-client分析(一)-kubeconfig-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/09/kubernetes-client-python使用-v1-0-1/">kubernetes-client-python使用-v1.0.1</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>