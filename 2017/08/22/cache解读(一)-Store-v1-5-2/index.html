<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>cache解读(一)-Store-v1.5.2 | fankangbest</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">cache解读(一)-Store-v1.5.2</h1><a id="logo" href="/.">fankangbest</a><p class="description">多听，少说，接受每一个人的责难，但是保留自己的最后裁决。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">cache解读(一)-Store-v1.5.2</h1><div class="post-meta">Aug 22, 2017<span> | </span><span class="category"><a href="/categories/容器虚拟化/">容器虚拟化</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="Store和Indexer"><a href="#Store和Indexer" class="headerlink" title="Store和Indexer"></a>Store和Indexer</h2><p>Store和Indexer 是Kubernetes用来存储obj的结构体，与reflector机制配合使用，可以把ETCD中的变化同步到Store和Indexer中，在代码中却可以直接从Store和Indexer获取相应的对象。所以说，Store和Indexer是ETCD中内容在内存中的一个缓存。</p>
<p>先来看下什么是Store。只要定义了Add(), Delete(), Update(), Get()等方法的结构体都可以称为Store。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Store is a generic object storage interface. Reflector knows how to watch a server</span></div><div class="line"><span class="comment">// and update a store. A generic store is provided, which allows Reflector to be used</span></div><div class="line"><span class="comment">// as a local caching system, and an LRU store, which allows Reflector to work like a</span></div><div class="line"><span class="comment">// queue of items yet to be processed.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// Store makes no assumptions about stored object identity; it is the responsibility</span></div><div class="line"><span class="comment">// of a Store implementation to provide a mechanism to correctly key objects and to</span></div><div class="line"><span class="comment">// define the contract for obtaining objects by some arbitrary key type.</span></div><div class="line"><span class="keyword">type</span> Store <span class="keyword">interface</span> &#123;</div><div class="line">	Add(obj <span class="keyword">interface</span>&#123;&#125;) error</div><div class="line">	Update(obj <span class="keyword">interface</span>&#123;&#125;) error</div><div class="line">	Delete(obj <span class="keyword">interface</span>&#123;&#125;) error</div><div class="line">	List() []<span class="keyword">interface</span>&#123;&#125;</div><div class="line">	ListKeys() []<span class="keyword">string</span></div><div class="line">	Get(obj <span class="keyword">interface</span>&#123;&#125;) (item <span class="keyword">interface</span>&#123;&#125;, exists <span class="keyword">bool</span>, err error)</div><div class="line">	GetByKey(key <span class="keyword">string</span>) (item <span class="keyword">interface</span>&#123;&#125;, exists <span class="keyword">bool</span>, err error)</div><div class="line"></div><div class="line">	<span class="comment">// Replace will delete the contents of the store, using instead the</span></div><div class="line">	<span class="comment">// given list. Store takes ownership of the list, you should not reference</span></div><div class="line">	<span class="comment">// it after calling this function.</span></div><div class="line">	Replace([]<span class="keyword">interface</span>&#123;&#125;, <span class="keyword">string</span>) error</div><div class="line">	Resync() error</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Indexer是在Store的基础上增加了index func管理的功能。具体稍后分析。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Indexer is a storage interface that lets you list objects using multiple indexing functions</span></div><div class="line"><span class="keyword">type</span> Indexer <span class="keyword">interface</span> &#123;</div><div class="line">	Store</div><div class="line">	<span class="comment">// Retrieve list of objects that match on the named indexing function</span></div><div class="line">	Index(indexName <span class="keyword">string</span>, obj <span class="keyword">interface</span>&#123;&#125;) ([]<span class="keyword">interface</span>&#123;&#125;, error)</div><div class="line">	<span class="comment">// ListIndexFuncValues returns the list of generated values of an Index func</span></div><div class="line">	ListIndexFuncValues(indexName <span class="keyword">string</span>) []<span class="keyword">string</span></div><div class="line">	<span class="comment">// ByIndex lists object that match on the named indexing function with the exact key</span></div><div class="line">	ByIndex(indexName, indexKey <span class="keyword">string</span>) ([]<span class="keyword">interface</span>&#123;&#125;, error)</div><div class="line">	<span class="comment">// GetIndexer return the indexers</span></div><div class="line">	GetIndexers() Indexers</div><div class="line"></div><div class="line">	<span class="comment">// AddIndexers adds more indexers to this store.  If you call this after you already have data</span></div><div class="line">	<span class="comment">// in the store, the results are undefined.</span></div><div class="line">	AddIndexers(newIndexers Indexers) error</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Store和Indexer的生成函数定义在/pkg/client/cache/store.go中。可以看出，Store和Indexer都是一个cache，其本质都是一个threadSafeStore。不同的是Store的Indexers参数为空，而Indexer的Indexers参数有值。    </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewStore returns a Store implemented simply with a map and a lock.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewStore</span><span class="params">(keyFunc KeyFunc)</span> <span class="title">Store</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;cache&#123;</div><div class="line">		cacheStorage: NewThreadSafeStore(Indexers&#123;&#125;, Indices&#123;&#125;),</div><div class="line">		keyFunc:      keyFunc,</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NewIndexer returns an Indexer implemented simply with a map and a lock.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewIndexer</span><span class="params">(keyFunc KeyFunc, indexers Indexers)</span> <span class="title">Indexer</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;cache&#123;</div><div class="line">		cacheStorage: NewThreadSafeStore(indexers, Indices&#123;&#125;),</div><div class="line">		keyFunc:      keyFunc,</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Index-Indexers和Indices"><a href="#Index-Indexers和Indices" class="headerlink" title="Index, Indexers和Indices"></a>Index, Indexers和Indices</h2><p>在分析threadSafeStore之前，需要介绍Index, Indexers和Indices三个重量级的概念。</p>
<ul>
<li>Index: 为key到obj set的map。可以通过key查找到对应的obj。Key使用keyFunc对obj计算得来。</li>
<li>Indexers: 为name到keyFunc的map。可以通过某名字，找到keyFunc。</li>
<li>Indices：为name到Index的map。可以通过某名字，找到Index。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Index maps the indexed value to a set of keys in the store that match on that value</span></div><div class="line"><span class="comment">//***Index可以从indexValue找到keys***//</span></div><div class="line"><span class="keyword">type</span> Index <span class="keyword">map</span>[<span class="keyword">string</span>]sets.String</div><div class="line"></div><div class="line"><span class="comment">// Indexers maps a name to a IndexFunc</span></div><div class="line"><span class="comment">//***Indexers可以从name找到IndexFunc，并使用IndexFunc计算出indexValues***//</span></div><div class="line"><span class="keyword">type</span> Indexers <span class="keyword">map</span>[<span class="keyword">string</span>]IndexFunc</div><div class="line"></div><div class="line"><span class="comment">// Indices maps a name to an Index</span></div><div class="line"><span class="comment">//***Indices可以从name找到Index***//</span></div><div class="line"><span class="keyword">type</span> Indices <span class="keyword">map</span>[<span class="keyword">string</span>]Index</div></pre></td></tr></table></figure>
<p>所以，可以通过一个比较人性化的名字，找到一个keyFunc及一个Index，通过keyFunc计算出obj的key，然后在Index中通过key找到obj。当然，不同的obj通过keyFunc可能计算出同一个key，这时候，这些obj都放在Index的同一key下。</p>
<p>现在有些明了这三个结构体的作用了，用keyFunc对很多obj进行分类存储，以方便存取。如keyFunc返回的是obj的namespace，那么我们就可以获取某namespace下的资源了。 所以keyFunc在系统中也称IndexFunc。 </p>
<p>以上的很多命名是为了方便理解，现在为了和cache中的keyFunc进行区分，以后我们统一约定称为IndexFunc，其计算出来的值为indexValue。</p>
<h2 id="ThreadSafeStore"><a href="#ThreadSafeStore" class="headerlink" title="ThreadSafeStore"></a>ThreadSafeStore</h2><p>ThreadSafeStore是一个interface, 定义在/pkg/client/cache/thread_safe_store.go中，是底层具体负责对象存储的结构体，其具体由threadSafeMap实现。先看来threadSafeMap的定义，如右边代码所示，threadSafeMap包含一个indexers及一个Indices，还有一个items。在ThreadSafeStore中，Index存放的并不是obj，而是obj的key。而items中存入的就是key和obj。所以说，在ThreadSafeStore中的Index只负责obj的key的管理。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// threadSafeMap implements ThreadSafeStore</span></div><div class="line"><span class="keyword">type</span> threadSafeMap <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">//***在threadSafemap中，首先通过indexers[name]获取IndexFunc，然后使用IndexFunc计算obj的indexkey。***//</span></div><div class="line">	<span class="comment">//***然后通过Indices[name]获取具体的Index；结合indexkey，就可以获取到具体obj的key，然后在items[key]获取obj的具体值。***//</span></div><div class="line">	<span class="comment">//***IndexFunc是threadSafemap用***//</span></div><div class="line">	<span class="comment">//***keyFunc是在cache中用，算出来的是存储在items中的key***//</span></div><div class="line">	lock sync.RWMutex</div><div class="line">	<span class="comment">//***key和obj的map***//</span></div><div class="line">	items <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</div><div class="line"></div><div class="line">	<span class="comment">// indexers maps a name to an IndexFunc</span></div><div class="line">	<span class="comment">//***type Indexers map[string]IndexFunc***//</span></div><div class="line">	<span class="comment">//***可以从indexers中找到对应的indexFunc***//</span></div><div class="line">	indexers Indexers</div><div class="line">	<span class="comment">// indices maps a name to an Index</span></div><div class="line">	<span class="comment">//***type Index map[string]sets.String***//</span></div><div class="line">	indices Indices</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Add"><a href="#Add" class="headerlink" title="Add()"></a>Add()</h4><p>Add()先更新items map中的值，然后调用updateIndices()更新index。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *threadSafeMap)</span> <span class="title">Add</span><span class="params">(key <span class="keyword">string</span>, obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	<span class="comment">//***先把oldObject找到（有的话）；然后更新该key对应的值。最后处理索引。***//</span></div><div class="line">	c.lock.Lock()</div><div class="line">	<span class="keyword">defer</span> c.lock.Unlock()</div><div class="line">	oldObject := c.items[key]</div><div class="line">	c.items[key] = obj</div><div class="line">	c.updateIndices(oldObject, obj, key)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Update"><a href="#Update" class="headerlink" title="Update()"></a>Update()</h4><p>同Add()。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *threadSafeMap)</span> <span class="title">Update</span><span class="params">(key <span class="keyword">string</span>, obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	c.lock.Lock()</div><div class="line">	<span class="keyword">defer</span> c.lock.Unlock()</div><div class="line">	oldObject := c.items[key]</div><div class="line">	c.items[key] = obj</div><div class="line">	c.updateIndices(oldObject, obj, key)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Delete"><a href="#Delete" class="headerlink" title="Delete()"></a>Delete()</h4><p>Delete()先把key从index中删除，然后再把key从items中删除。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *threadSafeMap)</span> <span class="title">Delete</span><span class="params">(key <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	c.lock.Lock()</div><div class="line">	<span class="keyword">defer</span> c.lock.Unlock()</div><div class="line">	<span class="keyword">if</span> obj, exists := c.items[key]; exists &#123;</div><div class="line">		c.deleteFromIndices(obj, key)</div><div class="line">		<span class="built_in">delete</span>(c.items, key)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Get"><a href="#Get" class="headerlink" title="Get()"></a>Get()</h4><p>Get()依据key从items中获取item，然后返回。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *threadSafeMap)</span> <span class="title">Get</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="params">(item <span class="keyword">interface</span>&#123;&#125;, exists <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	c.lock.RLock()</div><div class="line">	<span class="keyword">defer</span> c.lock.RUnlock()</div><div class="line">	item, exists = c.items[key]</div><div class="line">	<span class="keyword">return</span> item, exists</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="List"><a href="#List" class="headerlink" title="List()"></a>List()</h4><p>List()返回items map中的所有value。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *threadSafeMap)</span> <span class="title">List</span><span class="params">()</span> []<span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">	c.lock.RLock()</div><div class="line">	<span class="keyword">defer</span> c.lock.RUnlock()</div><div class="line">	list := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, <span class="built_in">len</span>(c.items))</div><div class="line">	<span class="keyword">for</span> _, item := <span class="keyword">range</span> c.items &#123;</div><div class="line">		list = <span class="built_in">append</span>(list, item)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> list</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="ListKeys"><a href="#ListKeys" class="headerlink" title="ListKeys()"></a>ListKeys()</h4><p>ListKeys()返回items map中的所有key。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ListKeys returns a list of all the keys of the objects currently</span></div><div class="line"><span class="comment">// in the threadSafeMap.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *threadSafeMap)</span> <span class="title">ListKeys</span><span class="params">()</span> []<span class="title">string</span></span> &#123;</div><div class="line">	c.lock.RLock()</div><div class="line">	<span class="keyword">defer</span> c.lock.RUnlock()</div><div class="line">	list := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>, <span class="built_in">len</span>(c.items))</div><div class="line">	<span class="keyword">for</span> key := <span class="keyword">range</span> c.items &#123;</div><div class="line">		list = <span class="built_in">append</span>(list, key)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> list</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Replace"><a href="#Replace" class="headerlink" title="Replace()"></a>Replace()</h4><p>Replace()重新构建items和index。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *threadSafeMap)</span> <span class="title">Replace</span><span class="params">(items <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;, resourceVersion <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	c.lock.Lock()</div><div class="line">	<span class="keyword">defer</span> c.lock.Unlock()</div><div class="line">	c.items = items</div><div class="line"></div><div class="line">	<span class="comment">// rebuild any index</span></div><div class="line">	c.indices = Indices&#123;&#125;</div><div class="line">	<span class="keyword">for</span> key, item := <span class="keyword">range</span> c.items &#123;</div><div class="line">		c.updateIndices(<span class="literal">nil</span>, item, key)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Index"><a href="#Index" class="headerlink" title="Index()"></a>Index()</h4><p>Index()返回先使用indexName获取indexFunc，然后计算出obj的indexValue，再取出indexValue对应的keys，最后依据keys从items中获取对应的obj并返回。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Index returns a list of items that match on the index function</span></div><div class="line"><span class="comment">// Index is thread-safe so long as you treat all items as immutable</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *threadSafeMap)</span> <span class="title">Index</span><span class="params">(indexName <span class="keyword">string</span>, obj <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">([]<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</div><div class="line">	c.lock.RLock()</div><div class="line">	<span class="keyword">defer</span> c.lock.RUnlock()</div><div class="line"></div><div class="line">	<span class="comment">//***从indexers找到indexFunc***//</span></div><div class="line">	indexFunc := c.indexers[indexName]</div><div class="line">	<span class="keyword">if</span> indexFunc == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"Index with name %s does not exist"</span>, indexName)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//***使用indexFunc计算obj的indexKey***//</span></div><div class="line">	indexKeys, err := indexFunc(obj)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	index := c.indices[indexName]</div><div class="line"></div><div class="line">	<span class="comment">// need to de-dupe the return list.  Since multiple keys are allowed, this can happen.</span></div><div class="line">	returnKeySet := sets.String&#123;&#125;</div><div class="line">	<span class="keyword">for</span> _, indexKey := <span class="keyword">range</span> indexKeys &#123;</div><div class="line">		<span class="comment">//***通过indexKey从index中获取具体的key***//</span></div><div class="line">		set := index[indexKey]</div><div class="line">		<span class="keyword">for</span> _, key := <span class="keyword">range</span> set.List() &#123;</div><div class="line">			returnKeySet.Insert(key)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	list := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, returnKeySet.Len())</div><div class="line">	<span class="keyword">for</span> absoluteKey := <span class="keyword">range</span> returnKeySet &#123;</div><div class="line">		list = <span class="built_in">append</span>(list, c.items[absoluteKey])</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> list, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="ByIndex"><a href="#ByIndex" class="headerlink" title="ByIndex()"></a>ByIndex()</h4><p>ByIndex()和Index()类似，不同的是其传入的是indexKey，无需计算。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ByIndex returns a list of items that match an exact value on the index function</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *threadSafeMap)</span> <span class="title">ByIndex</span><span class="params">(indexName, indexKey <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</div><div class="line">	c.lock.RLock()</div><div class="line">	<span class="keyword">defer</span> c.lock.RUnlock()</div><div class="line"></div><div class="line">	indexFunc := c.indexers[indexName]</div><div class="line">	<span class="keyword">if</span> indexFunc == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"Index with name %s does not exist"</span>, indexName)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	index := c.indices[indexName]</div><div class="line"></div><div class="line">	set := index[indexKey]</div><div class="line">	list := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, set.Len())</div><div class="line">	<span class="keyword">for</span> _, key := <span class="keyword">range</span> set.List() &#123;</div><div class="line">		list = <span class="built_in">append</span>(list, c.items[key])</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> list, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="ListIndexFuncValues"><a href="#ListIndexFuncValues" class="headerlink" title="ListIndexFuncValues()"></a>ListIndexFuncValues()</h4><p>ListIndexFuncValues()返回indexName对应的index map中的keys。可以理解为indexName分类函数对objs划分的类别。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *threadSafeMap)</span> <span class="title">ListIndexFuncValues</span><span class="params">(indexName <span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123;</div><div class="line">	index := c.indices[indexName]</div><div class="line">	names := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>, <span class="built_in">len</span>(index))</div><div class="line">	<span class="keyword">for</span> key := <span class="keyword">range</span> index &#123;</div><div class="line">		names = <span class="built_in">append</span>(names, key)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> names</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="GetIndexers"><a href="#GetIndexers" class="headerlink" title="GetIndexers()"></a>GetIndexers()</h4><p>GetIndexers()返回indexers。indexers保存indexName和indexFunc的关系。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***获取cache中所有indexers***//</span></div><div class="line"><span class="comment">//***Indexers的类型为map[string]IndexFunc***//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *threadSafeMap)</span> <span class="title">GetIndexers</span><span class="params">()</span> <span class="title">Indexers</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> c.indexers</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="AddIndexers"><a href="#AddIndexers" class="headerlink" title="AddIndexers()"></a>AddIndexers()</h4><p>AddIndexers()把indexFunc添加到threadSafeMap中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *threadSafeMap)</span> <span class="title">AddIndexers</span><span class="params">(newIndexers Indexers)</span> <span class="title">error</span></span> &#123;</div><div class="line">	c.lock.Lock()</div><div class="line">	<span class="keyword">defer</span> c.lock.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(c.items) &gt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"cannot add indexers to running index"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	oldKeys := sets.StringKeySet(c.indexers)</div><div class="line">	newKeys := sets.StringKeySet(newIndexers)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> oldKeys.HasAny(newKeys.List()...) &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"indexer conflict: %v"</span>, oldKeys.Intersection(newKeys))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> newIndexers &#123;</div><div class="line">		c.indexers[k] = v</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="updateIndices"><a href="#updateIndices" class="headerlink" title="updateIndices()"></a>updateIndices()</h4><p>updateIndices()先把oldObj从索引中删除，然后把newObj的key添加到索引中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// updateIndices modifies the objects location in the managed indexes, if this is an update, you must provide an oldObj</span></div><div class="line"><span class="comment">// updateIndices must be called from a function that already has a lock on the cache</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *threadSafeMap)</span> <span class="title">updateIndices</span><span class="params">(oldObj <span class="keyword">interface</span>&#123;&#125;, newObj <span class="keyword">interface</span>&#123;&#125;, key <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// if we got an old object, we need to remove it before we add it again</span></div><div class="line">	<span class="comment">//***函数要先把oldObj先删除，然后再把newObj添加，因为每个obj都会依据indexFunc()计算出索引，每个obj的索引都不一样***//</span></div><div class="line">	<span class="keyword">if</span> oldObj != <span class="literal">nil</span> &#123;</div><div class="line">		c.deleteFromIndices(oldObj, key)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//***indexers存储了name和indexFunc的关系***//</span></div><div class="line">	<span class="comment">//***在NewStore()中，NewThreadSafeStore(Indexers&#123;&#125;, Indices&#123;&#125;)，Indexers&#123;&#125;未进行初始化、所以在store相关操作中，并未执行该循环。***//</span></div><div class="line">	<span class="comment">//***因为Store的实现cache，已经包含了KeyFunc***//</span></div><div class="line">	<span class="keyword">for</span> name, indexFunc := <span class="keyword">range</span> c.indexers &#123;</div><div class="line">		indexValues, err := indexFunc(newObj)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//***indices存储了name和index的关系***//</span></div><div class="line">		index := c.indices[name]</div><div class="line">		<span class="keyword">if</span> index == <span class="literal">nil</span> &#123;</div><div class="line">			index = Index&#123;&#125;</div><div class="line">			c.indices[name] = index</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//***index存储了indexValue和keys的关系***//</span></div><div class="line">		<span class="keyword">for</span> _, indexValue := <span class="keyword">range</span> indexValues &#123;</div><div class="line">			set := index[indexValue]</div><div class="line">			<span class="keyword">if</span> set == <span class="literal">nil</span> &#123;</div><div class="line">				set = sets.String&#123;&#125;</div><div class="line">				index[indexValue] = set</div><div class="line">			&#125;</div><div class="line">			set.Insert(key)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="deleteFromIndices"><a href="#deleteFromIndices" class="headerlink" title="deleteFromIndices()"></a>deleteFromIndices()</h4><p>deleteFromIndices()把obj对应的key从index中删除。这里感觉有个小问题，index[indexValues]即使为空，indexValues这个key也会存在，当然，这不影响使用。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// deleteFromIndices removes the object from each of the managed indexes</span></div><div class="line"><span class="comment">// it is intended to be called from a function that already has a lock on the cache</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *threadSafeMap)</span> <span class="title">deleteFromIndices</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;, key <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> name, indexFunc := <span class="keyword">range</span> c.indexers &#123;</div><div class="line">		indexValues, err := indexFunc(obj)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		index := c.indices[name]</div><div class="line">		<span class="keyword">for</span> _, indexValue := <span class="keyword">range</span> indexValues &#123;</div><div class="line">			<span class="keyword">if</span> index != <span class="literal">nil</span> &#123;</div><div class="line">				set := index[indexValue]</div><div class="line">				<span class="keyword">if</span> set != <span class="literal">nil</span> &#123;</div><div class="line">					set.Delete(key)</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h2><p>cache定义在/pkg/client/cache/store.go中。Cache是ThreadSafeStore再加上一个keyFunc。所有的obj会先使用keyFunc进行计算得到key，然后把obj和key存入到ThreadSafeStore中。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***cache是的ThreadSafeStore的封装；cache能使用KeyFunc计算obj的key***//</span></div><div class="line"><span class="keyword">type</span> cache <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// cacheStorage bears the burden of thread safety for the cache</span></div><div class="line">	cacheStorage ThreadSafeStore</div><div class="line">	<span class="comment">// keyFunc is used to make the key for objects stored in and retrieved from items, and</span></div><div class="line">	<span class="comment">// should be deterministic.</span></div><div class="line">	keyFunc KeyFunc</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="cache的方法"><a href="#cache的方法" class="headerlink" title="cache的方法"></a>cache的方法</h4><p>cache的方法比较简单，基本上就是对ThreadSafeStore的封装。详见源代码。</p>
<h2 id="再看Store和Indexer"><a href="#再看Store和Indexer" class="headerlink" title="再看Store和Indexer"></a>再看Store和Indexer</h2><p>Store的Indexers为空，所以obj直接存在ThreadSafeStore的items map中，其中key可以使用keyFunc计算。</p>
<p>Indexer的Indexers不为空，所以可以通过Index进行key的分类管理，并进一步地取得具有某一属性的objs。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewStore returns a Store implemented simply with a map and a lock.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewStore</span><span class="params">(keyFunc KeyFunc)</span> <span class="title">Store</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;cache&#123;</div><div class="line">		cacheStorage: NewThreadSafeStore(Indexers&#123;&#125;, Indices&#123;&#125;),</div><div class="line">		keyFunc:      keyFunc,</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NewIndexer returns an Indexer implemented simply with a map and a lock.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewIndexer</span><span class="params">(keyFunc KeyFunc, indexers Indexers)</span> <span class="title">Indexer</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;cache&#123;</div><div class="line">		cacheStorage: NewThreadSafeStore(indexers, Indices&#123;&#125;),</div><div class="line">		keyFunc:      keyFunc,</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h2><p>结尾来看个例子(例子从test文件中摘出)，看下index的具体用法。</p>
<p>testIndexFunc()返回的是pod labels中”foo”对应的值。</p>
<p>在GetIndexFuncValues()中，我们先构造index，其中keyFunc为MetaNamespaceKeyFunc，就是用namespace/name作为key；IndexFunc为testIndexFunc()，名为”testmodes”。然后生成pod1, pod2, pod3。其中pod1和pod2的label “foo”的值为”bar”，pod3的label “foo”的值为”biz”。把pod1, pod2和pod3加入到index中。现在index中”testmodes” indexFunc对应的有”bar”和”biz”两个indexValue，”bar”对应pod1和pod2的key，”biz”对应pod3的key，具体的pod值可以由index的ByIndex()获取。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line"></div><div class="line">	<span class="string">"k8s.io/kubernetes/pkg/api"</span></div><div class="line">	<span class="string">"k8s.io/kubernetes/pkg/client/cache"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">testIndexFunc</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">([]<span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	pod := obj.(*api.Pod)</div><div class="line">	<span class="keyword">return</span> []<span class="keyword">string</span>&#123;pod.Labels[<span class="string">"foo"</span>]&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetIndexFuncValues</span><span class="params">()</span></span> &#123;</div><div class="line">	index := cache.NewIndexer(cache.MetaNamespaceKeyFunc, cache.Indexers&#123;<span class="string">"testmodes"</span>: testIndexFunc&#125;)</div><div class="line"></div><div class="line">	pod1 := &amp;api.Pod&#123;ObjectMeta: api.ObjectMeta&#123;Name: <span class="string">"one"</span>, Labels: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"foo"</span>: <span class="string">"bar"</span>&#125;&#125;&#125;</div><div class="line">	pod2 := &amp;api.Pod&#123;ObjectMeta: api.ObjectMeta&#123;Name: <span class="string">"two"</span>, Labels: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"foo"</span>: <span class="string">"bar"</span>&#125;&#125;&#125;</div><div class="line">	pod3 := &amp;api.Pod&#123;ObjectMeta: api.ObjectMeta&#123;Name: <span class="string">"three"</span>, Labels: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"foo"</span>: <span class="string">"biz"</span>&#125;&#125;&#125;</div><div class="line"></div><div class="line">	index.Add(pod1)</div><div class="line">	index.Add(pod2)</div><div class="line">	index.Add(pod3)</div><div class="line"></div><div class="line">	keys := index.ListIndexFuncValues(<span class="string">"testmodes"</span>)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, key := <span class="keyword">range</span> keys &#123;</div><div class="line">		fmt.Println(<span class="string">"key:"</span>, key)</div><div class="line">		items, _ := index.ByIndex(<span class="string">"testmodes"</span>, key)</div><div class="line">		<span class="keyword">for</span> _, item := <span class="keyword">range</span> items &#123;</div><div class="line">			fmt.Println(<span class="string">"pod"</span>, item.(*api.Pod).ObjectMeta.Name)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	GetIndexFuncValues()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">key: bar</div><div class="line">pod one</div><div class="line">pod two</div><div class="line">key: biz</div><div class="line">pod three</div></pre></td></tr></table></figure></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://fankangbest.github.com/2017/08/22/cache解读(一)-Store-v1-5-2/" data-id="cj856s037002awsqshlsh29sm" class="article-share-link">分享</a><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/kubernetes-v1-5-2/">kubernetes-v1.5.2</a></div><div class="post-nav"><a href="/2017/08/23/cache解读(二)-Queue-v1-5-2/" class="pre">cache解读(二)-Queue-v1.5.2</a><a href="/2017/08/21/reflector机制-v1-5-2/" class="next">reflector机制-v1.5.2</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://fankangbest.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/存储虚拟化/">存储虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器虚拟化/">容器虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/kubernetes-v1-5-2/" style="font-size: 15px;">kubernetes-v1.5.2</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-v1-12-3/" style="font-size: 15px;">docker-v1.12.3</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/29/apiserver分析(六)-resthandler-v1-5-2/">apiserver分析(六)-resthandler-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/28/apiserver分析(五)-APIInstaller-v1-5-2/">apiserver分析(五)-APIInstaller-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/27/apiserver分析(四)-API安装-v1-5-2/">apiserver分析(四)-API安装-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/21/apiserver分析(三)-master和genericapiserver-v1-5-2/">apiserver分析(三)-master和genericapiserver-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/19/Docker命令行解析源码分析-v1-12-3/">Docker命令行解析源码分析-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/18/apiserver分析(二)-authorizer-v1-5-2/">apiserver分析(二)-authorizer-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/11/Docker镜像存储分析-v1-12-3/">Docker镜像存储分析-v1.12.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/07/apiserver分析(一)-authenticator-v1-5-2/">apiserver分析(一)-authenticator-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/07/resourcequota分析(二)-quota-v1-5-2/">resourcequota分析(二)-quota-v1.5.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/06/resourcequota分析(一)-evaluator-v1-5-2/">resourcequota分析(一)-evaluator-v1.5.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/fankangbest" title="myGithub" target="_blank">myGithub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">fankangbest.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>